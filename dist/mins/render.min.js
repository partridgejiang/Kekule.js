!function(){var e=Kekule,t=Kekule.ChemStructureNodeLabels,r=Kekule.CoordMode;ClassEx.extend(Kekule.ChemObject,{getDefCoordPos:function(e){return Kekule.Render.CoordPos.CENTER},getCoordPos:function(e){var t=e===Kekule.CoordMode.COORD3D?this.getPropStoreFieldValue("coordPos3D"):this.getPropStoreFieldValue("coordPos2D");return Kekule.ObjUtils.isUnset(t)&&(t=this.getDefCoordPos(e)),t},getOverrideRenderOptions:function(e){if(e&&e.length){for(var t={},r=0,n=e.length;r<n;++r)t=Object.extend(t,e[r]);return t}return null},_appendOverrideRenderOptionItem:function(e,t){var r=this.getPropStoreFieldValue(t);r||(r=[],this.setPropStoreFieldValue(t,r));var n=r.indexOf(e);return n>=0&&r.splice(n,1),r.push(e),this.notifyPropSet(t,r),this},_deleteOverrideRenderOptionItem:function(e,t){var r=this.getPropStoreFieldValue(t);if(r){var n=r.indexOf(e);return n>=0&&(r.splice(n,1),this.notifyPropSet(t,r)),this}},addOverrideRenderOptionItem:function(e){return this._appendOverrideRenderOptionItem(e,"overrideRenderOptionItems")},addOverrideRender3DOptionItem:function(e){return this._appendOverrideRenderOptionItem(e,"overrideRender3DOptionItems")},removeOverrideRenderOptionItem:function(e){return this._deleteOverrideRenderOptionItem(e,"overrideRenderOptionItems")},removeOverrideRender3DOptionItem:function(e){return this._deleteOverrideRenderOptionItem(e,"overrideRender3DOptionItems")},getOverriddenRenderOptions:function(){var e=this.getRenderOptions()||{},t=this.getOverrideRenderOptions(this.getOverrideRenderOptionItems());return t&&(e=Object.extend(e,t)),e},getOverriddenRender3DOptions:function(){var e=Object.create(this.getRender3DOptions()||null),t=this.getOverrideRenderOptions(this.getOverrideRender3DOptionItems());return t&&(e=Object.extend(e,t)),e},setRenderOption:function(e,t){var r;(r=this.getRenderOptions())||this.setRenderOptions({}),(r=this.getRenderOptions())[e]!==t&&(r[e]=t,this.notifyPropSet("renderOptions",r))},setRender3DOption:function(e,t){var r;(r=this.getRender3DOptions())||this.setRender3DOptions({}),(r=this.getRender3DOptions())[e]!==t&&(r[e]=t,this.notifyPropSet("render3DOptions",r))},getRenderOption:function(e){var t=this.getOverriddenRenderOptions();return t?t[e]:void 0},getRender3DOption:function(e){var t=this.getOverriddenRender3DOptions();return t?t[e]:void 0},getCascadedRenderOption:function(e){var t=this.getOverriddenRenderOptions(),r=t?t[e]:void 0;if(Kekule.ObjUtils.isUnset(r)){var n=this.getParent?this.getParent():null;r=n&&n.getCascadedRenderOption?n.getCascadedRenderOption(e):void 0}return r},getCascadedRender3DOption:function(e){var t=this.getOverriddenRender3DOptions(),r=t?t[e]:void 0;if(Kekule.ObjUtils.isUnset(r)){var n=this.getParent?this.getParent():null;r=n&&n.getCascadedRender3DOption?n.getCascadedRender3DOption(e):void 0}return r},getBaseCoord:function(e,t){var n=this.getCoordPos(e),o=this.getCoordOfMode?this.getCoordOfMode(e,t):null;if(o&&n!==Kekule.Render.CoordPos.CENTER&&n===Kekule.Render.CoordPos.CORNER_TL){var i=this.getExposedContainerBox(e,t),a={x:(i.x2-i.x1)/2,y:(i.y2-i.y1)/2};e===r.COORD3D&&(a.z=(i.z2-i.z1)/2),e===r.COORD3D?o=Kekule.CoordUtils.add(o,a):(o.x+=a.x,o.y-=a.y)}return o},getBaseCoord2D:function(e){return this.getBaseCoord(Kekule.CoordMode.COORD2D,e)},getBaseCoord3D:function(e){return this.getBaseCoord(Kekule.CoordMode.COORD3D,e)},getAbsBaseCoord:function(e,t){var n=this.getCoordPos(e),o=this.getAbsCoordOfMode?this.getAbsCoordOfMode(e,t):null;if(o&&n!==Kekule.Render.CoordPos.CENTER&&n===Kekule.Render.CoordPos.CORNER_TL){var i=this.getExposedContainerBox(e,t),a={x:(i.x2-i.x1)/2,y:(i.y2-i.y1)/2};e===r.COORD3D&&(a.z=(i.z2-i.z1)/2),e===r.COORD3D?o=Kekule.CoordUtils.add(o,a):(o.x+=a.x,o.y-=a.y)}return o},getAbsBaseCoord2D:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD2D,e)},getAbsBaseCoord3D:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD3D,e)},setAbsBaseCoord:function(e,t,n){var o=this.getCoordPos(t),i=Kekule.CoordUtils.clone(e);if(e&&o!==Kekule.Render.CoordPos.CENTER&&o===Kekule.Render.CoordPos.CORNER_TL){var a=this.getExposedContainerBox(t,n),s={x:(a.x2-a.x1)/2,y:(a.y2-a.y1)/2};t===r.COORD3D&&(s.z=(a.z2-a.z1)/2),t===r.COORD3D?i=Kekule.CoordUtils.substract(i,s):(i.x-=s.x,i.y+=s.y)}return this.setAbsCoordOfMode?this.setAbsCoordOfMode(i,t):this.setCoordOfMode&&this.setCoordOfMode(i,t),this},setAbsBaseCoord2D:function(e,t){return this.setAbsCoordOfMode(e,Kekule.CoordMode.COORD2D,t)},setAbsBaseCoord3D:function(e,t){return this.setAbsCoordOfMode(e,Kekule.CoordMode.COORD3D,t)},getExposedAncestor:function(){var e=this.getParent();return e?e.isExpanded()?this:e.getExposedAncestor():this},isExposed:function(){var e=this.getParent();return!e||e.isExpanded()},isExpanded:function(){return!0},setExpanded:function(e){},getLinkedExposedObjs:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t){var n=this.getLinkedConnectorAt(t);if(n.isExposed())for(var o=n.getConnectedExposedObjs(),i=0,a=o.length;i<a;++i)o[i]!==this&&Kekule.ArrayUtils.pushUnique(e,o[i])}return e},getExposedContainerBox:function(e,t){return this.getContainerBox(e,t)},getAllAutoScaleRefLengths:function(e,t){return[]},getAllContainingConnectors:function(){return this.getAllChildConnectors?this.getAllChildConnectors():[]},getConnectorLengthMedian:function(e,t){var r=this.getAllContainingConnectors();return Kekule.ChemStructureUtils.getConnectorLengthMedian(r,e,t)}}),ClassEx.defineProps(Kekule.ChemObject,[{name:"coordPos2D",dataType:DataType.INT,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getCoordPos(Kekule.CoordMode.COORD2D)}},{name:"coordPos3D",dataType:DataType.INT,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getCoordPos(Kekule.CoordMode.COORD3D)}},{name:"renderOptions",dataType:DataType.OBJECT},{name:"render3DOptions",dataType:DataType.OBJECT},{name:"overrideRenderOptionItems",dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1},{name:"overrideRender3DOptionItems",dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1},{name:"hidden",dataType:DataType.BOOL,scope:Class.PropertyScope.PRIVATE},{name:"visible",dataType:DataType.BOOL,serializable:!1,getter:function(){return!this.getHidden()},setter:function(e){e?this.setHidden(void 0):this.setHidden(!0)}}]),ClassEx.extend(Kekule.ChemObjList,{getAllContainingConnectors:function(){for(var e=[],t=0,r=this.getItemCount();t<r;++t){var n=this.getItemAt(t);n.getAllContainingConnectors&&(e=e.concat(n.getAllContainingConnectors()))}return e},getAllAutoScaleRefLengths:function(e,t){for(var r=[],n=0,o=this.getItemCount();n<o;++n){var i=this.getItemAt(n);i.getAllAutoScaleRefLengths&&(r=r.concat(i.getAllAutoScaleRefLengths(e,t)))}return r},getExposedContainerBox:function(e,t){for(var r,n=this.toArray(),o=0,i=n.length;o<i;++o){var a=n[o];if(a.isExposed()){var s=a.getExposedContainerBox?a.getExposedContainerBox(e,t):a.getContainerBox?a.getContainerBox(e,t):null;s&&(r=r?Kekule.BoxUtils.getContainerBox(r,s):Kekule.BoxUtils.clone(s))}}return r}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ChemObjList),ClassEx.extend(Kekule.ChemSpaceElement,{getAllContainingConnectors:function(){return this.getChildren().getAllContainingConnectors()},getAllAutoScaleRefLengths:function(e,t){return this.getChildren().getAllAutoScaleRefLengths(e,t)}}),ClassEx.extend(Kekule.ChemSpace,{getAllContainingConnectors:function(){return this.getRoot().getAllContainingConnectors()},getAllAutoScaleRefLengths:function(e,t){return this.getDefAutoScaleRefLength()?[this.getDefAutoScaleRefLength()]:this.getRoot().getAllAutoScaleRefLengths(e,t)}}),ClassEx.defineProps(Kekule.ChemObject,[{name:"defAutoScaleRefLength",dataType:DataType.NUMBER,scope:Class.PropertyScope.PUBLIC}]),ClassEx.extend(Kekule.BaseStructureConnector,{getBaseCoord:function(e,t){for(var r=null,n=0,o=e===Kekule.CoordMode.COORD2D?{x:0,y:0}:{x:0,y:0,z:0},i=0,a=this.getConnectedObjCount();i<a;++i){var s=this.getConnectedObjAt(i),l=s.getBaseCoord?s.getBaseCoord(e,t):null;l&&(o=Kekule.CoordUtils.add(o,l),++n)}return n&&(r=Kekule.CoordUtils.divide(o,n)),r},getAbsBaseCoord:function(e,t){for(var r=null,n=0,o=e===Kekule.CoordMode.COORD2D?{x:0,y:0}:{x:0,y:0,z:0},i=0,a=this.getConnectedObjCount();i<a;++i){var s=this.getConnectedObjAt(i),l=s.getAbsBaseCoord?s.getAbsBaseCoord(e,t):null;l&&(o=Kekule.CoordUtils.add(o,l),++n)}return n&&(r=Kekule.CoordUtils.divide(o,n)),r},getAbsCoordOfMode:function(e,t){return this.getAbsBaseCoord(e,t)},getConnectedExposedObjs:function(){for(var e=this.getConnectedObjs(),t=[],r=0,n=e.length;r<n;++r){var o=e[r].getExposedAncestor();t.indexOf(o)<0&&t.push(o)}return t},getLength:function(e,t){var r=this.getConnectedObjs();if(2!==r.length)return null;var n=r[0].getAbsBaseCoord?r[0].getAbsBaseCoord(e,t):null,o=r[1].getAbsBaseCoord?r[1].getAbsBaseCoord(e,t):null;return Kekule.CoordUtils.getDistance(n,o)},getLength2D:function(e){return this.getLength(Kekule.CoordMode.COORD2D,e)},getLength3D:function(e){return this.getLength(Kekule.CoordMode.COORD3D,e)}}),ClassEx.defineProps(Kekule.BaseStructureConnector,[{name:"absCoord2D",dataType:DataType.HASH,serializable:!1,getter:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD2D,e)}},{name:"absCoord3D",dataType:DataType.HASH,serializable:!1,getter:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD3D,e)}}]),ClassEx.extend(Kekule.ChemStructureConnector,{getAllAutoScaleRefLengths:function(e,t){return[this.getLength(e,t)]}}),ClassEx.extend(Kekule.BaseStructureNode,{getBaseCoord:function(e,t){return this.getCoordOfMode(e,t)},getAbsBaseCoord:function(e,t){return this.getAbsCoordOfMode(e,t)},getExposedContainerBox:function(e,t){return this.getContainerBox(e,t)},getExposedContainerBox2D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD2D,e);return t.width=t.x2-t.x1,t.height=t.y2-t.y1,t},getExposedContainerBox3D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD3D,e);return t.deltaX=t.x2-t.x1,t.deltaY=t.y2-t.y1,t.deltaZ=t.z2-t.z1,t}}),ClassEx.extend(Kekule.ChemStructureNode,{getDisplayRichText:function(e,t,r,n,o,i){var a=Kekule.Render;Kekule.ObjUtils.isUnset(t)&&(t=!0);var s,l=a.RichTextUtils.create(),d=this.getRenderOption("customLabel");return(s=d?a.RichTextUtils.strToRichText(d):this.getCoreDisplayRichTextItem(e,t,r,n))&&(t&&(s=this.appendElectronStateDisplayText(s,n,o,i,r.getElectronicBiasMark())),s&&(a.RichTextUtils.append(l,s),l.anchorItem=s)),l},getCoreDisplayRichTextItem:function(e,t,r,n){return null},appendElectronStateDisplayText:function(e,t,r,n,o){var i=Kekule.Render,a=this.getCharge(),s=this.getElectronicBias&&this.getElectronicBias(),l=this.getRadical(),d=i.ChemDisplayTextUtils.createElectronStateDisplayTextSection(a,l,t,r,n,s,o);if(d){var u=i.RichTextUtils.createGroup();return i.RichTextUtils.append(u,e),i.RichTextUtils.append(u,d),u.charDirection=Kekule.Render.TextDirection.LTR,u.anchorItem=e,u}return e}}),ClassEx.extend(Kekule.AbstractAtom,{getDisplayRichText:function(e,t,r,n,o,i){var a=Kekule.Render;Kekule.ObjUtils.isUnset(e)&&(e=a.HydrogenDisplayLevel.DEFAULT);var s=this.tryApplySuper("getDisplayRichText",[e,t,r,n,o,i]),l=0;switch(e){case a.HydrogenDisplayLevel.NONE:l=0;break;case a.HydrogenDisplayLevel.ALL:l=this.getHydrogenCount();break;case a.HydrogenDisplayLevel.EXPLICIT:l=this.getExplicitHydrogenCount();break;case a.HydrogenDisplayLevel.UNMATCHED_EXPLICIT:this.getImplicitHydrogenCount&&this.getImplicitHydrogenCount()!==this.getExplicitHydrogenCount()&&(l=this.getExplicitHydrogenCount())}return l&&(s=this.appendHydrogenDisplayText(s,l)),s},appendHydrogenDisplayText:function(e,t){var r=Kekule.Render;if(t)if(t>1){var n=r.RichTextUtils.createGroup();n.charDirection=Kekule.Render.TextDirection.LTR;var o=r.RichTextUtils.appendText2(n,"H");r.RichTextUtils.appendText(n,t.toString(),{textType:r.RichText.SUB,refItem:o}),r.RichTextUtils.append(e,n)}else r.RichTextUtils.appendText(e,"H");return e}}),ClassEx.extend(Kekule.Atom,{getCoreDisplayRichTextItem:function(r,n,o,i){var a,s=Kekule.Render,l=s.RichTextUtils.createGroup(),d=this.getIsotopeAlias();this.getSymbol();d||this.getSymbol()!==e.Element.UNSET_ELEMENT?d&&Kekule.ChemStructureNodeLabels.ENABLE_ISOTOPE_ALIAS?(a=s.RichTextUtils.createSection(this.getIsotopeAlias(),{charDirection:Kekule.Render.TextDirection.LTR}),(l=s.RichTextUtils.append(l,a)).anchorItem=a):(a=s.RichTextUtils.createSection(this.getSymbol(),{charDirection:Kekule.Render.TextDirection.LTR}),(l=s.RichTextUtils.append(l,a)).anchorItem=a,this.getMassNumber()!==Kekule.Isotope.UNSET_MASSNUMBER&&((l=s.RichTextUtils.insertText(l,0,this.getMassNumber().toString(),{textType:s.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR,refItem:l.anchorItem})).charDirection=Kekule.Render.TextDirection.LTR)):l=s.RichTextUtils.appendText(l,o&&o.getUnsetElement()||t.UNSET_ELEMENT);return l}}),ClassEx.extend(Kekule.Pseudoatom,{getCoreDisplayRichTextItem:function(e,r,n,o){var i,a=Kekule.Render,s=n;return(i=this.getLabel())||(i=s&&s.getUnsetElement()||t.UNSET_ELEMENT),a.RichTextUtils.createSection(i,{charDirection:Kekule.Render.TextDirection.LTR})}});var n=function(e,t,r){var n,o=Kekule.Render,i=Kekule.IsotopesDataUtil.getIsotopeIdDetail(t);i.massNumber&&(n=o.RichTextUtils.appendText2(e,i.massNumber.toString(),{textType:Kekule.Render.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR}));var a=o.RichTextUtils.appendText2(e,i.symbol,{charDirection:Kekule.Render.TextDirection.LTR},r);return n&&(n.refItem=a),e.charDirection=Kekule.Render.TextDirection.LTR,e};ClassEx.extend(Kekule.VariableAtom,{getCoreDisplayRichTextItem:function(e,r,o,i){var a,s=Kekule.Render,l=o;if(this.isListEmpty())return(a=s.RichTextUtils.strToRichText(l&&l.getVariableAtom()||t.VARIABLE_ATOM)).charDirection=Kekule.Render.TextDirection.LTR,a;var d=this.getAllowedIsotopeIds()||this.getDisallowedIsotopeIds(),u=this.isDisallowedList();if((a=s.RichTextUtils.createGroup()).charDirection=Kekule.Render.TextDirection.LTR,u&&(a=s.RichTextUtils.appendText(a,l.getIsoListDisallowPrefix())),a=s.RichTextUtils.appendText(a,l.getIsoListLeadingBracket()),d&&d.length)for(var c=0,h=d.length;c<h;++c){var g=d[c];g&&(0!=c&&(a=s.RichTextUtils.appendText(a,l.getIsoListDelimiter())),a=n(a,g,0==c))}return a=s.RichTextUtils.appendText(a,l.getIsoListTailingBracket())}}),ClassEx.extend(Kekule.StructureConnectionTable,{exposedNodesHasCoord2D:function(e){for(var t=this.getExposedNodes(),r=0,n=t.length;r<n;++r)if(t[r].hasCoord2D(e))return!0;return!1},exposedNodesHasCoord3D:function(e){for(var t=this.getExposedNodes(),r=0,n=t.length;r<n;++r)if(t[r].hasCoord3D(e))return!0;return!1},getExposedNodes:function(){for(var e=[],t=this.getNodes(),r=0,n=t.length;r<n;++r){var o=t[r];if(o.getExposedNodes&&o.isExpanded()){var i=o.getExposedNodes();e=e.concat(i)}else o.isExposed()&&e.push(o)}return e},getExposedConnectors:function(){for(var e=this.getConnectors(),t=this.getNodes(),r=0,n=t.length;r<n;++r){var o=t[r];if(o.getConnectors&&o.isExpanded()){var i=o.getExposedConnectors();e=e.concat(i)}}return e},getExposedContainerBox:function(e,t){var r=this.getExposedNodes();return r.length?this.getNodesContainBox(r,e,t):null},getExposedContainerBox2D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD2D,e);return t.width=t.x2-t.x1,t.height=t.y2-t.y1,t},getExposedContainerBox3D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD3D,e);return t.deltaX=t.x2-t.x1,t.deltaY=t.y2-t.y1,t.deltaZ=t.z2-t.z1,t},getConnectorLengthMedian:function(e,t){var r=this.getAllContainingConnectors();return Kekule.ChemStructureUtils.getConnectorLengthMedian(r,e,t)},getAllAutoScaleRefLengths:function(e,t){for(var r=this.getAllContainingConnectors(),n=[],o=0,i=r.length;o<i;++o){var a=r[o];if(a&&a.getAllAutoScaleRefLengths){var s=a.getAllAutoScaleRefLengths(e,t);s&&(n=n.concat(s))}}return n}}),ClassEx.extend(Kekule.ContentBlock,{getDefCoordPos:function(e){return e!==r.COORD3D?Kekule.Render.CoordPos.CORNER_TL:this.tryApplySuper("getDefCoordPos",[e])}}),ClassEx.extend(Kekule.ChemMarker.ChemPropertyMarker,{getDefCoordPos:function(e){return e!==r.COORD3D?Kekule.Render.CoordPos.CENTER:this.tryApplySuper("getDefCoordPos",[e])}}),ClassEx.extend(Kekule.StructureFragment,{isExpanded:function(){var e=this.getOverriddenRenderOptions();return!!e&&!!e.expanded},setExpanded:function(e){this.setRenderOption("expanded",e)},getExposedNodes:function(){return this.hasCtab()?this.getCtab().getExposedNodes():[]},getExposedConnectors:function(){return this.hasCtab()?this.getCtab().getExposedConnectors():[]},exposedNodesHasCoord2D:function(e){return!!this.hasCtab()&&this.getCtab().exposedNodesHasCoord2D(e)},exposedNodesHasCoord3D:function(e){return!!this.hasCtab()&&this.getCtab().exposedNodesHasCoord3D(e)},getExposedContainerBox:function(e,t){if(this.hasCtab()){var r=this.getCtab().getExposedContainerBox(e,t);return r||(r=this.getContainerBox(e,t)),r}return this.getContainerBox(e,t)},getConnectorLengthMedian:function(e,t){return this.hasCtab()?this.getCtab().getConnectorLengthMedian(e,t):null},getAutoScaleRefLength:function(e,t){return this.getConnectorLengthMedian(e,t)},getAllAutoScaleRefLengths:function(e,t){return this.hasCtab()?this.getCtab().getAllAutoScaleRefLengths(e,t):null}}),ClassEx.extend(Kekule.SubGroup,{getCoreDisplayRichTextItem:function(e,r,n,o){var i,a=Kekule.Render,s=null,l=this.getAbbr();if(l||(s=this.getFormulaText()?Kekule.FormulaUtils.textToFormula(this.getFormulaText()):this.getFormula(!1)||this.calcFormula())&&!s.isEmpty()||(l=n&&n.getRgroup()||t.SUBGROUP),l)if(l.length<=3)(i=a.RichTextUtils.createSection(l)).charDirection=Kekule.Render.TextDirection.LTR;else{var d=this._indexOfFirstUppercaseLetter(l);d<0&&(d=0),(i=a.RichTextUtils.createGroup()).charDirection=Kekule.Render.TextDirection.LTR,d>0&&((u=a.RichTextUtils.createSection(l.substring(0,d))).charDirection=Kekule.Render.TextDirection.INHERIT,i=a.RichTextUtils.append(i,u));var u=a.RichTextUtils.createSection(l.charAt(d));(i=a.RichTextUtils.append(i,u)).anchorItem=u,d<l.length-1&&((u=a.RichTextUtils.createSection(l.substring(d+1))).charDirection=Kekule.Render.TextDirection.INHERIT,i=a.RichTextUtils.append(i,u))}else if(s){i=s.getDisplayRichText(r,n,o),(u=a.RichTextUtils.getFirstNormalTextSection(i))||(u=i.items[0]),i.anchorItem=u}return i},_indexOfFirstUppercaseLetter:function(e){for(var t=0,r=e.length;t<r;++t){var n=e.charAt(t);if(n>="A"&&n<="Z")return t}return-1},_autoSetSelfCoord:function(e,t){if(!this._isAutoSettingSelfCoord&&!(this.getCoordOfMode(e,t)||(a=this.getAnchorNodeCount())<=0)){this.beginUpdate();try{this._isAutoSettingSelfCoord=!0;for(var r={},n=0;n<a;++n){(s=this.getAnchorNodeAt(n))._autoSetSelfCoord&&s._autoSetSelfCoord(e,t),(l=s.getAbsCoordOfMode(e,t))&&(r=Kekule.CoordUtils.add(r,l))}var o=Kekule.CoordUtils.divide(r,a);this.setAbsCoordOfMode(o,e);var i=this.getCoordOfMode(e)||{},a=this.getNodeCount();for(n=0;n<a;++n){var s,l;(l=(s=this.getNodeAt(n)).getCoordOfMode(e,t))&&(l=Kekule.CoordUtils.substract(l,i),s.setCoordOfMode(l,e))}}finally{this._isAutoSettingSelfCoord=!1,this.endUpdate()}}},doGetAbsCoord2D:function(e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD2D,e),this.tryApplySuper("doGetAbsCoord2D",[e])},doGetAbsCoord3D:function(e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD3D,e),this.tryApplySuper("doGetAbsCoord3D",[e])},doSetAbsCoord2D:function(e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD2D),this.tryApplySuper("doSetAbsCoord2D",[e])},doSetAbsCoord3D:function(e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD3D),this.tryApplySuper("doSetAbsCoord3D",[e])}}),ClassEx.extend(Kekule.MolecularFormula,{getDisplayRichText:function(e,t,r,n,o){var i=Kekule.Render;return Kekule.ObjUtils.isUnset(e)&&(e=!0),i.ChemDisplayTextUtils.formulaToRichText(this,e,null,r,t,n,o)},getDisplayText:function(e,t,r){var n=this.getDisplayRichText();return Kekule.Render.RichTextUtils.toText(n)}}),ClassEx.extend(Kekule.Molecule,{afterInitialization:function(){this.setExpanded(!0)}}),ClassEx.extend(Kekule.CompositeMolecule,{getExposedContainerBox:function(e,t){var r=null,n=this.getPropStoreFieldValue("subMolecules");if(n)for(var o=0,i=n.length;o<i;++o){var a=n[o].getExposedContainerBox(e,t);a&&(r=r?Kekule.BoxUtils.getContainerBox(r,a):Kekule.BoxUtils.clone(a))}return r},getAllAutoScaleRefLengths:function(e,t){var r=[],n=this.getPropStoreFieldValue("subMolecules");if(n)for(var o=0,i=n.getItemCount();o<i;++o){var a=n.getObjAt(o).getAllAutoScaleRefLengths(e,t);a&&(r=r.concat(a))}return r}})}(),Kekule.Render={},Kekule.Render.CoordSystem={CHEM:0,CONTEXT:1,SCREEN:2},Kekule.Render.RendererType={R2D:2,R3D:3},Kekule.Render.CoordPos={CENTER:0,CORNER_TL:21,DEFAULT:0},Kekule.Render.DEF_ATOM_ATOMIC_NUM=6,Kekule.Render.MoleculeDisplayType={SKELETAL:1,CONDENSED:2,DEFAULT:1},Kekule.Render.Molecule2DDisplayType=Kekule.Render.MoleculeDisplayType,Kekule.Render.NodeLabelDisplayMode={HIDDEN:-1,SHOWN:1,SMART:0,DEFAULT:0},Kekule.Render.HydrogenDisplayLevel={NONE:0,EXPLICIT:1,UNMATCHED_EXPLICIT:2,ALL:10,LABELED:30,DEFAULT:30},Kekule.Render.TextDirection={DEFAULT:0,LTR:1,RTL:3,TTB:2,BTT:4,INHERIT:10},Kekule.Render.TextAlign={DEFAULT:0,LEFT:1,RIGHT:2,TOP:3,BOTTOM:4,CENTER:5,LEADING:10,TRAILING:11,getAbsAlign:function(e,t){var r=e,n=Kekule.Render.TextAlign,o=Kekule.Render.TextDirection;if(e===n.LEADING||e===n.TRAILING){var i=e==n.LEADING;switch(t){case o.RTL:r=i?n.RIGHT:n.LEFT;break;case o.TTB:r=i?n.TOP:n.BOTTOM;break;case o.BTT:r=i?n.BOTTOM:n.TOP;break;case o.LTR:default:r=i?n.LEFT:n.RIGHT}}return r}},Kekule.Render.BoxXAlignment={LEFT:0,RIGHT:1,CENTER:2},Kekule.Render.BoxYAlignment={TOP:0,BOTTOM:1,CENTER:2},Kekule.Render.TextBoxAlignmentMode={BOX:0,ANCHOR:1},Kekule.Render.BondRenderType={DEFAULT:null,SINGLE:0,DOUBLE:1,TRIPLE:2,QUAD:3,DASHED:4,DASHED_DOUBLE:5,DASHED_TRIPLE:6,SOLID_DASH:7,ARROWED:8,ARROWED_INV:9,HASHED:10,BOLD:11,BOLD_DOUBLE:12,BOLD_TRIPLE:13,BOLD_QUAD:14,BOLD_DASH:16,WEDGED_SOLID:20,WEDGED_SOLID_INV:21,WEDGED_HOLLOW:22,WEDGED_HOLLOW_INV:23,WEDGED_HASHED:24,WEDGED_HASHED_INV:25,WEDGED_SOLID_BOTH:26,WEDGED_HOLLOW_BOTH:27,WAVY:30,SCISSORS_DOUBLE:40},Kekule.Render.ChargeMarkRenderType={NUM_WITH_SYMBOL:1,DEFAULT:1,CIRCLE_AROUND:3},Kekule.Render.Render3DGraphicQuality={EXTREME_LOW:1,LOW:2,MEDIUM:3,HIGH:4,EXTREME_HIGH:5},Kekule.Render.Molecule3DDisplayType={WIRE:31,STICKS:32,BALL_STICK:33,SPACE_FILL:34,DEFAULT:33},Kekule.Render.Bond3DRenderMode={NONE:0,WIRE:1,MULTI_WIRE:2,CYLINDER:3,MULTI_CYLINDER:4,isWireMode:function(e){var t=Kekule.Render.Bond3DRenderMode;return e===t.WIRE||e===t.MULTI_WIRE},isCylinderMode:function(e){var t=Kekule.Render.Bond3DRenderMode;return e===t.CYLINDER||e===t.MULTI_CYLINDER}},Kekule.Render.Bond3DSpliceMode={UNSPLIT:1,MID_SPLIT:2,WEIGHTING_SPLIT:3},Kekule.Render.Bond3DRenderType={SINGLE:1,DOUBLE:2,TRIPLE:3,DASH:-1,SOLID_DASH:-2},Kekule.Render.Node3DRenderMode={NONE:0,BALL:1,SPACE:2},Kekule.Render.MetaShapeType={POINT:0,CIRCLE:1,LINE:2,RECT:3,ARC:5,POLYLINE:11,POLYGON:10,SPHERE:101,CYLINDER:102,COMPOSITE:-1},Kekule.Render.BoundShapeType=Kekule.Render.MetaShapeType,Kekule.Render.ObjectUpdateType={MODIFY:0,ADD:1,REMOVE:2,CLEAR:3},Kekule.Render.AbstractRenderer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.AbstractRenderer",RENDER_CACHE_FIELD:"__$renderCache$__",initialize:function(e,t,r){this.tryApplySuper("initialize"),this.setPropValue("chemObj",e,!0),r&&this.setParent(r),this.setDrawBridge(t),this.setBubbleEvent(!0),this._suspendUpdateStatus=0,this._suspendUpdateInfos=[]},finalize:function(){var e=this.getPropStoreFieldValue("boundInfoRecorder");e&&e.finalize(),this.setPropValue("chemObj",null,!0),this.setDrawBridge(null),this.tryApplySuper("finalize")},initProperties:function(){this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:!1,setter:null}),this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("parent",{dateType:DataType.OBJECT,serializable:!1}),this.defineProp("parentRenderer",{dateType:"Kekule.Render.AbstractRenderer",serializable:!1,getter:function(){var e=this.getParent();return e instanceof Kekule.Render.AbstractRenderer?e:null},setter:function(e){this.setParent(e)}}),this.defineProp("redirectContext",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("canModifyTargetObj",{dataType:DataType.BOOL,serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("canModifyTargetObj");if(Kekule.ObjUtils.isUnset(e)){var t=this.getParent();t&&t.getCanModifyTargetObj&&(e=t.getCanModifyTargetObj())}return e}}),this.defineProp("boundInfoRecorder",{dataType:"Kekule.Render.BoundInfoRecorder",serializable:!1,setter:null,getter:function(e){if(this.isRootRenderer()){var t=this.getPropStoreFieldValue("boundInfoRecorder");return t||e||(t=this._createBoundInfoRecorder()),t}var r=this.getRootRenderer();return r&&r.getBoundInfoRecorder(e)}}),this.defineEvent("clear"),this.defineEvent("updateBasicDrawObject")},_createBoundInfoRecorder:function(){var e=this.getPropStoreFieldValue("boundInfoRecorder");e&&e.finalize();var t=new Kekule.Render.BoundInfoRecorder(this);return this.setPropStoreFieldValue("boundInfoRecorder",t),t},isRootRenderer:function(){return!this.getParentRenderer()},getHigherLevelObj:function(){return this.getParent()},getRootRenderer:function(){if(this.isRootRenderer())return this;var e=this.getParentRenderer();return e?e.getRootRenderer():this},getRendererType:function(){return Kekule.Render.RendererType.R2D},getCoordMode:function(){return this.getRendererType()===Kekule.Render.RendererType.R3D?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D},_getRenderSortIndex:function(){return 0},getRenderCache:function(e){var t=this.getExtraProp(e,this.RENDER_CACHE_FIELD);return t||(t={},this.setExtraProp(e,this.RENDER_CACHE_FIELD,t)),t},beginDraw:function(e,t,r){var n=this.getDrawBridge();n.prepareContext&&n.prepareContext(e)},endDraw:function(e,t,r){var n=this.getDrawBridge();n.renderContext&&n.renderContext(e)},updateDrawInfoInCache:function(e,t,r,n,o){var i=this.getRenderCache(t);t&&(i.context=t),r&&(i.baseCoord=r),e&&(i.chemObj=e),n&&(i.options=n),o&&(i.realDrawOptions=o)},_isCurrChemObjNeedToBeDrawn:function(e,t){for(var r=this.getChemObj(),n=0,o=e.length;n<o;++n){var i=e[n];if(i===r||i.isChildOf(r))return!0}return!1},getAutoBaseCoord:function(e){return this.doGetAutoBaseCoord(e)},doGetAutoBaseCoord:function(e){return null},getCachedDrawOptions:function(e){return this.getRenderCache(e).options},getCachedDrawnElem:function(e){return this.getRenderCache(e).drawnElem},isChemObjNeedToBeDrawn:function(){var e=this.getChemObj();return e&&(!e.getVisible||e.getVisible())},draw:function(e,t,r){if(!this.isChemObjNeedToBeDrawn())return null;try{this.__isDrawing=!0,this.getBoundInfoRecorder();var n={},o=this.getParentRenderer();if(o)var i=o.getRenderCache().options;i?(n=Object.create(i),n=Object.extend(n,r)):n=Object.create(r||null);var a=this.getChemObj(),s=n.partialDrawObjs;if(s&&!this._isCurrChemObjNeedToBeDrawn(s,e))return null;var l=this.getRendererType()===Kekule.Render.RendererType.R3D?"getRender3DOptions":"getRenderOptions",d=a[l]?a[l]():null,u=a[l=this.getRendererType()===Kekule.Render.RendererType.R3D?"getOverriddenRender3DOptions":"getOverriddenRenderOptions"]?a[l]():null;n=Kekule.Render.RenderOptionUtils.mergeRenderOptions(d||{},n),this.getRenderCache().options=n,n=Kekule.Render.RenderOptionUtils.mergeRenderOptions(u||{},n),this.updateDrawInfoInCache(this.getChemObj(),e,t,r,n);var c=this.isRootRenderer();this.doPrepareDraw(e,t,n),this.invokeEvent("prepareDrawing",{context:e,obj:this.getChemObj()}),c&&this.beginDraw(e,t,n);var h=this.doDraw(e,t,n);this.getRenderCache(e).drawnElem=h,c&&this.endDraw(e,t,n),this.invokeEvent("draw",{context:e,obj:this.getChemObj(),renderOptions:n})}finally{this.__isDrawing=!1}return h},doPrepareDraw:function(e,t,r){},doDraw:function(e,t,r){return this.doDrawSelf(e,t,r)},doDrawSelf:function(e,t,r){return null},redraw:function(e){if(!this.isChemObjNeedToBeDrawn())return null;var t=this.isRootRenderer();if(t){var r=this.getRenderCache(e)||{};this.beginDraw(e,r.baseCoord,r.options)}var n=this.doRedraw(e);return this.getRenderCache(e).drawnElem=n,t&&this.endDraw(e,r.baseCoord,r.options),n},doRedraw:function(e){var t=this.getRenderCache(e);return this.draw(e,t.baseCoord,t.options)},canModifyGraphic:function(e){var t=this.getDrawBridge();return!!t.canModifyGraphic&&t.canModifyGraphic(e)},beginUpdateRenderer:function(){++this._suspendUpdateStatus},endUpdateRenderer:function(){--this._suspendUpdateStatus,this._suspendUpdateStatus<=0&&(this._suspendUpdateStatus=0),this.isUpdatingRenderer()||this.doEndUpdateRenderer()},doEndUpdateRenderer:function(){this.updateEx(this._suspendUpdateInfos),this._suspendUpdateInfos=[]},isUpdatingRenderer:function(){return this._suspendUpdateStatus>0},updateEx:function(e){var t=!0;if(this.isUpdatingRenderer())return this._suspendUpdateInfos||(this._suspendUpdateInfos=[]),this._mergeRendererUpdateInfo(this._suspendUpdateInfos,e),!0;if(!this.canModifyGraphic(s)){if(this.isRootRenderer()){var r=[];for(o=0,i=e.length;o<i;++o){s=(a=e[o]).context;Kekule.ArrayUtils.pushUnique(r,s)}for(o=0,i=r.length;o<i;++o){this.getDrawBridge().clearContext(s);var n=this.getRenderCache(s);this.draw(s,n.baseCoord,n.options)}return!0}return this.getParentRenderer().updateEx(e)}for(var o=0,i=e.length;o<i;++o){for(var a,s=(a=e[o]).context,l=0,d=a.items.length;l<d;++l){var u=a.items[l];if(!(t=t&&this.doUpdate(s,u.updatedObjDetails,u.updateType)))break}if(!t)break}return t},_mergeRendererUpdateInfo:function(e,t){for(var r=0,n=t.length;r<n;++r){var o=t[r],i=this._indexOfContextInRendererUpdateInfos(o.context,e);if(i<0)e.push(o);else{var a=e[i];a.items=a.items.concat(o.items)}}return e},_indexOfContextInRendererUpdateInfos:function(e,t){for(var r=0,n=t.length;r<n;++r){if(t[r].context===e)return r}return-1},update:function(e,t,r){for(var n=[],o=0,i=t.length;o<i;++o){var a=t[o].obj;this.isChemObjRenderedBySelf(e,a)&&n.push(t[o])}return!n.length||this.updateEx([{context:e,items:[{updateType:r,updatedObjDetails:n}]}])},doUpdate:function(e,t,r){return this.doUpdateSelf(e,t,r)},doUpdateSelf:function(e,t,r){if(this.canModifyGraphic(e)){for(var n=!1,o=this.getChemObj(),i=0,a=t.length;i<a;++i){if(t[i].obj===o){n=!0;break}}if(n){if(r===Kekule.Render.ObjectUpdateType.CLEAR)return this.doClear(e);this.doClear(e);var s=this.getRenderCache(e);return this.draw(e,s.baseCoord,s.options)}}return!1},_extractObjsOfUpdateObjDetails:function(e){return Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(e)},_createUpdateObjDetailsFromObjs:function(e){return Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(e)},addNew:function(e,t){var r=this._createUpdateObjDetailsFromObjs(t);return this.update(e,r,Kekule.Render.ObjectUpdateType.ADD)},modify:function(e,t){return this.update(e,t,Kekule.Render.ObjectUpdateType.MODIFY)},remove:function(e,t){var r=this._createUpdateObjDetailsFromObjs(t);return this.update(e,r,Kekule.Render.ObjectUpdateType.REMOVE)},clear:function(e){this.doClear(e);this.invokeEvent("clear",{context:e,obj:this.getChemObj()})},doClear:function(e){return!!this.canModifyGraphic()&&this.doClearSelf(e)},doClearSelf:function(e){if(!this.canModifyGraphic())return!1;var t=this.getRenderCache(e).drawnElem;if(t)try{this.getDrawBridge().removeDrawnElem(e,t)}catch(e){}this.getRenderCache(e).drawnElem=null},estimateObjBox:function(e,t,r){var n=this.doEstimateObjBox(e,t,r);return n&&(n=this._fillBoxDefaultValue(n,this.getRendererType())),n},doEstimateObjBox:function(e,t,r){return this.doEstimateSelfObjBox(e,t,r)},doEstimateSelfObjBox:function(e,t,r){return null},estimateRenderBox:function(e,t,r,n){var o=this.doEstimateRenderBox(e,t,r,n);return o&&(o=this._fillBoxDefaultValue(o,this.getRendererType())),o},doEstimateRenderBox:function(e,t,r,n){return null},_fillBoxDefaultValue:function(e,t){e||(e={});var r=t===Kekule.Render.RendererType.R3D,n={x1:e.x1||0,x2:e.x2||0,y1:e.y1||0,y2:e.y2||0};return r&&(n.z1=e.z1||0,n.z2=e.z2||0),n},transformCoordToObj:function(e,t,r){return this.doTransformCoordToObj(e,t,r)},doTransformCoordToObj:function(e,t,r){return r},transformCoordToContext:function(e,t,r){return this.doTransformCoordToContext(e,t,r)},doTransformCoordToContext:function(e,t,r){return r},transformContextCoordToScreen:function(e,t){return this.doTransformContextCoordToScreen(e,t)},doTransformContextCoordToScreen:function(e,t){var r=this.getDrawBridge();return r&&r.transformContextCoordToScreen?r.transformContextCoordToScreen(e,t):t},basicDrawObjectUpdated:function(e,t,r,n,o){this.invokeEvent("updateBasicDrawObject",{context:e,obj:t,parentObj:r,boundInfo:n,updateType:o})},isChemObjRenderedBySelf:function(e,t){return t===this.getRenderCache(e).chemObj},isChemObjRenderedDirectlyBySelf:function(e,t){return!(!t||!this.getRenderCache(e).chemObj)&&t===this.getRenderCache(e).chemObj},getObjRenderBound:function(e,t,r){var n=this.getBoundInfoRecorder(),o=t;return r&&t.getCoordStickTarget&&(o=t.getCoordStickTarget()||o),n&&n.getBound(e,o)},getStickingTargetRenderBound:function(e,t){var r;if(t.getCoordStickTarget&&(r=t.getCoordStickTarget()),r){var n=this.getBoundInfoRecorder();return n&&n.getBound(e,r,!0)}return null},createBoundInfo:function(e,t,r){return Kekule.Render.MetaShapeUtils.createShapeInfo(e,t,r)},createPointBoundInfo:function(e){return this.createBoundInfo(Kekule.Render.BoundShapeType.POINT,[e])},createCircleBoundInfo:function(e,t){return this.createBoundInfo(Kekule.Render.BoundShapeType.CIRCLE,[e],{radius:t})},createArcBoundInfo:function(e,t,r,n,o,i){return this.createBoundInfo(Kekule.Render.BoundShapeType.ARC,[e],{radius:t,startAngle:r,endAngle:n,anticlockwise:o,width:i})},createLineBoundInfo:function(e,t,r){return this.createBoundInfo(Kekule.Render.BoundShapeType.LINE,[e,t],{width:r})},createRectBoundInfo:function(e,t){return this.createBoundInfo(Kekule.Render.BoundShapeType.RECT,[e,t])},createSphereBoundInfo:function(e,t){return this.createBoundInfo(Kekule.Render.BoundShapeType.SPHERE,[e],{radius:t})},createCylinderBoundInfo:function(e,t,r){return this.createBoundInfo(Kekule.Render.BoundShapeType.CYLINDER,[e,t],{radius:r})}}),Kekule.ClassDefineUtils.addExtraObjMapSupport(Kekule.Render.AbstractRenderer),Kekule.Render.DummyRenderer=Class.create(Kekule.Render.AbstractRenderer,{CLASS_NAME:"Kekule.Render.DummyRenderer",draw:function(e,t,r){},redraw:function(e){}}),Kekule.Render.CompositeRenderer=Class.create(Kekule.Render.AbstractRenderer,{CLASS_NAME:"Kekule.Render.CompositeRenderer",initProperties:function(){this.defineProp("targetChildObjs",{dataType:DataType.ARRAY,serializable:!1}),this.defineProp("childRendererMap",{dataType:DataType.OBJECT,serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("childRendererMap");return e||(e=new Kekule.MapEx(!0),this.setPropStoreFieldValue("childRendererMap",e)),e}})},finalize:function(){this.reset(),this.tryApplySuper("finalize")},_getRenderSortIndex:function(){for(var e=this.tryApplySuper("_getRenderSortIndex"),t=this.prepareChildRenderers(),r=0,n=t.length;r<n;++r){var o=t[r]._getRenderSortIndex();o>e&&(e=o)}return e},doEstimateObjBox:function(e,t,r){for(var n=this.tryApplySuper("doEstimateObjBox",[e,t,r]),o=this.prepareChildRenderers(),i=Kekule.BoxUtils,a=0,s=o.length;a<s;++a){var l=o[a];if(l){var d=l.estimateObjBox(e,t,r);d&&(n=n?i.getContainerBox(n,d):i.clone(d))}}return n},isChemObjRenderedBySelf:function(e,t){var r=this.tryApplySuper("isChemObjRenderedBySelf",[e,t]);if(!r)for(var n=this.getChildRenderers(),o=0,i=n.length;o<i;++o){if(n[o].isChemObjRenderedBySelf(e,t))return!0}if(!r){this.refreshChildObjs();var a=this.getTargetChildObjs();r=a&&a.indexOf(t)>=0}return r},isChemObjRenderedDirectlyBySelf:function(e,t){return this.tryApplySuper("isChemObjRenderedDirectlyBySelf",[e,t])},doSetRedirectContext:function(e){this.tryApplySuper("doSetRedirectContext",[e]);var t=this.getChildRenderers();if(t&&t.length)for(var r=0,n=t.length;r<n;++r)t[r].setRedirectContext(e)},getChildObjs:function(){var e=this.getChemObj();return e&&e.getAttachedMarkers?[].concat(e.getAttachedMarkers()||[]):[]},prepareChildObjs:function(){var e=this.getTargetChildObjs();return e||(this.setTargetChildObjs(this.getChildObjs()),this.getTargetChildObjs())},refreshChildObjs:function(){this.setTargetChildObjs(null),this.prepareChildObjs()},getChildRenderers:function(){return this.getChildRendererMap().getValues()},getRendererForChild:function(e,t){var r=this.getRendererType()===Kekule.Render.RendererType.R3D?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass,n=this.getChildRendererMap();if(!(i=n.get(e))&&t){var o=r(e)||Kekule.Render.DummyRenderer,i=o?new o(e,this.getDrawBridge(),this):null;n.set(e,i),i.setRedirectContext(this.getRedirectContext())}return i},prepareChildRenderers:function(){for(var e=this.getChildRendererMap(),t=this.prepareChildObjs()||[],r=e.getKeys(),n=0,o=r.length;n<o;++n){var i=r[n];t.indexOf(i)<0&&e.remove(i)}for(n=0,o=t.length;n<o;++n){var a=t[n];this.getRendererForChild(a,!0)}return e.getValues()},releaseChildRenderers:function(){var e=this.getChildRendererMap(),t=e.getValues();if(t){for(var r=0,n=t.length;r<n;++r)t[r].finalize();e.clear()}},hasChildRenderers:function(){var e=this.getChildRendererMap().getValues();return e&&e.length},getDirectRendererForChildObj:function(e,t){if(this.isChemObjRenderedDirectlyBySelf(e,t))return this;for(var r=this.getChildRenderers(),n=0,o=r.length;n<o;++n){var i=r[n];if(i.isChemObjRenderedBySelf(e,t))return i.isChemObjRenderedDirectlyBySelf(e,t)?i:i.getDirectRendererForChildObj?i.getDirectRendererForChildObj(e,t):null}return null},prepare:function(){this.prepareChildObjs(),this.prepareChildRenderers()},reset:function(){this.setTargetChildObjs(null),this.releaseChildRenderers()},_needWholelyDraw:function(e,t){var r=this.getChemObj();return!e||e.indexOf(r)>=0},doPrepareDraw:function(e,t,r){this.refreshChildObjs(),this.prepareChildRenderers();for(var n=this.getChildRenderers(),o=0,i=n.length;o<i;++o){n[o].doPrepareDraw(e,t,r)}},doDraw:function(e,t,r){var n=Object.create(r);if(r.partialDrawObjs&&this._needWholelyDraw(r.partialDrawObjs,e)&&(n.partialDrawObjs=null),this.getTargetChildObjs().length){var o=this.doDrawSelf(e,t,n),i=this.doDrawChildren(e,t,n);return o&&this.addToDrawGroup(o,i),i}return this.tryApplySuper("doDraw",[e,t,n])},doDrawChildren:function(e,t,r){var n=this.createDrawGroup(e),o=this.getChildRenderers();this._sortChildRenderers(o);var i=Object.create(r);this.getRenderCache(e).childDrawOptions=i;for(var a=0,s=o.length;a<s;++a){var l=o[a].draw(e,null,i);n&&l&&this.addToDrawGroup(l,n)}return n},_sortChildRenderers:function(e){e.sort(function(e,t){return e._getRenderSortIndex()-t._getRenderSortIndex()})},doClear:function(e){return this.tryApplySuper("doClear",[e]),this.hasChildRenderers()&&this.doClearChildren(e),!0},doClearChildren:function(e){for(var t=this.getChildRendererMap().getValues(),r=0,n=t.length;r<n;++r)t[r]&&t[r].clear(e)},doUpdate:function(e,t,r){return this.refreshChildObjs(),this.tryApplySuper("doUpdate",[e,t,r]),this.getTargetChildObjs().length&&this.doUpdateChildren(e,t,r),!0},doUpdateChildren:function(e,t,r){for(var n=Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(t),o=this.getTargetChildObjs()||[],i=this.getChildRendererMap(),a=Kekule.ArrayUtils.toArray(n),s=new Kekule.MapEx(!1),l=[],d=!1,u=0,c=a.length;u<c;++u){var h=a[u];this.isChemObjRenderedDirectlyBySelf(e,h)&&(d=!0)}if(d)return this.doClear(e),this.redraw(e),!0;for(u=0,c=a.length;u<c;++u){h=a[u];if(D=i.get(h))r===Kekule.Render.ObjectUpdateType.REMOVE?(D.clear(),i.remove(h)):(Kekule.ArrayUtils.pushUnique(l,D),m=[h],s.set(D,m));else{var g=this._getRenderersForChildObj(e,h);if(!g.length&&o.indexOf(h)>=0){var p=(O=this.getRendererForChild(h,!0)).draw(e,null,this.getRenderCache(e).childDrawOptions);if(p){var f=this.getCachedDrawnElem(e);f&&this.addToDrawGroup(p,f)}}for(var C=0,R=g.length;C<R;++C){var D=g[C],m=s.get(D);m||(l.push(D),m=[],s.set(D,m)),m.push(h)}}}var y=!0;for(u=0,c=l.length;u<c;++u){D=l[u];var T=s.get(D),x=Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(T),O=D.update(e,x,r);y=y&&O}return y},_getRenderersForChildObj:function(e,t){for(var r=[],n=this.getChildRenderers(),o=0,i=n.length;o<i;++o){var a=n[o];a.isChemObjRenderedBySelf(e,t)&&r.push(a)}return r}}),Kekule.Render.Renderer2DFactory=Kekule.FactoryUtils.createSimpleFactory(Kekule.FactoryUtils.MATCH_BY_CLASS),Kekule.Render.get2DRendererClass=function(e){var t=e instanceof ObjectEx?e.getClass():e;return Kekule.Render.Renderer2DFactory.getClass(t)},Kekule.Render.Renderer3DFactory=Kekule.FactoryUtils.createSimpleFactory(Kekule.FactoryUtils.MATCH_BY_CLASS),Kekule.Render.get3DRendererClass=function(e){var t=e instanceof ObjectEx?e.getClass():e;return Kekule.Render.Renderer3DFactory.getClass(t)},Kekule.Render.DrawBridgeManager=Class.create({CLASS_NAME:"Kekule.Render.DrawBridgeManager",initialize:function(){this._items=[],this._preferredItem=null},_indexOfBridgeClass:function(e){for(var t=0,r=this._items.length;t<r;++t){if(this._items[t].bridgeClass===e)return t}return-1},_sortItems:function(){this._items.sort(function(e,t){return(e.priorityLevel||0)-(t.priorityLevel||0)})},_reselectPreferred:function(){this._sortItems();for(var e=this._items.length-1;e>=0;--e){var t=this._items[e];if(t.isSupported)return this._preferredItem=t,t}return this._preferredItem=null,null},_recheckAvailabilityOfItem:function(e){var t=e.bridgeClass,r=t.getAvailabilityInformation&&t.getAvailabilityInformation();!r&&t.isSupported&&(r={available:t.isSupported(),message:null}),r?(e.isSupported=r.available,e.message=r.message):(e.isSupported=!1,e.message=null)},recheckAvailabilities:function(){for(var e=this._items,t=e.length-1;t>=0;--t){var r=e[t];this._recheckAvailabilityOfItem(r)}},register:function(e,t){t||(t=0);var r,n=this._indexOfBridgeClass(e);return n>=0&&this._items.splice(n,1),r={bridgeClass:e,priorityLevel:t},this._recheckAvailabilityOfItem(r),this._items.push(r),this._sortItems(),(!this._preferredItem||this._preferredItem.priorityLevel<t)&&r.isSupported&&(this._preferredItem=r),r},unregister:function(e){var t=null,r=this._indexOfBridgeClass(e);return r>=0&&(t=this._items[r],this._items.splice(r,1),t===this._preferredItem&&this._reselectPreferred()),t},getPreferredBridgeClass:function(){return this._preferredItem?this._preferredItem.bridgeClass:null},getPreferredBridgeInstance:function(){var e=this.getPreferredBridgeClass();return e?new e:null},getUnavailableMessages:function(){for(var e=[],t=this._items,r=t.length-1;r>=0;--r){var n=t[r];!n.isSupported&&n.message&&e.push(n.message)}return e},getUnavailableMessage:function(){var e=this._preferredItem||this._items[this._items.length-1];return!e.isSupported&&e.message?e.message:""}}),Kekule.Render.DrawBridge2DMananger=new Kekule.Render.DrawBridgeManager,Kekule.Render.DrawBridge3DMananger=new Kekule.Render.DrawBridgeManager,Kekule.Render.registerExternalModule=function(e,t){Kekule.externalResourceManager.register(e,t)},Kekule.Render.getExternalModule=function(e){return Kekule.externalResourceManager.getResource(e)},function(){var e=Kekule.Render;e.atomColorSets={jmol:["#000099","#FFFFFF","#D9FFFF","#CC80FF","#C2FF00","#FFB5B5","#909090","#3050F8","#FF0D0D","#90E050","#B3E3F5","#AB5CF2","#8AFF00","#BFA6A6","#F0C8A0","#FF8000","#FFFF30","#1FF01F","#80D1E3","#8F40D4","#3DFF00","#E6E6E6","#BFC2C7","#A6A6AB","#8A99C7","#9C7AC7","#E06633","#F090A0","#50D050","#C88033","#7D80B0","#C28F8F","#668F8F","#BD80E3","#FFA100","#A62929","#5CB8D1","#702EB0","#00FF00","#94FFFF","#94E0E0","#73C2C9","#54B5B5","#3B9E9E","#248F8F","#0A7D8C","#006985","#C0C0C0","#FFD98F","#A67573","#668080","#9E63B5","#D47A00","#940094","#429EB0","#57178F","#00C900","#70D4FF","#FFFFC7","#D9FFC7","#C7FFC7","#A3FFC7","#8FFFC7","#61FFC7","#45FFC7","#30FFC7","#1FFFC7","#00FF9C","#00E675","#00D452","#00BF38","#00AB24","#4DC2FF","#4DA6FF","#2194D6","#267DAB","#266696","#175487","#D0D0E0","#FFD123","#B8B8D0","#A6544D","#575961","#9E4FB5","#AB5C00","#754F45","#428296","#420066","#007D00","#70ABFA","#00BAFF","#00A1FF","#008FFF","#0080FF","#006BFF","#545CF2","#785CE3","#8A4FE3","#A136D4","#B31FD4","#B31FBA","#B30DA6","#BD0D87","#C70066","#CC0059","#D1004F","#D90045","#E00038","#E6002E","#EB0026","#000000","#000000"],cpk2D:["#000000","#000000","#FFC0CB","#B22222",null,"#00FF00","#000000","#8F8FFF","#F00000","#DAA520",null,"#0000FF","#228B22","#808090","#DAA520","#FFA500","#FFC832","#00FF00",null,"#0000FF","#808090","#808090","#808090","#808090","#808090","#808090","#FFA500","#A52A2A","#A52A2A","#A52A2A","#A52A2A"]};var t=e.atomColorSets.cpk2D,r=e.atomColorSets.jmol;t[35]="#A52A2A",t[47]="#808090",t[53]="#A020F0",t[56]="#FFA500",t[79]="#DAA520",t.SubGroup=r.SubGroup="#0000CC",e.atom3DColors=Kekule.Render.atomColorSets.jmol,e.atom2DColors=Kekule.Render.atomColorSets.cpk2D,e.atomColors=[],e.atomColors[e.RendererType.R2D]=e.atom2DColors,e.atomColors[e.RendererType.R3D]=e.atom3DColors}(),Kekule.Render.RichText={SECTION:"section",GROUP:"group",LINES:"lines",SUP:"superscript",SUB:"subscript",NORMAL:"normal"},Kekule.Render.RichTextUtils={STYLE_PROPS:["fontSize","fontFamily","fontWeight","fontStyle","color","opacity"],create:function(){return Kekule.Render.RichTextUtils.createGroup()},createGroup:function(e,t){var r={role:e||"group",items:[]};if(t)for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);return r},createSection:function(e,t){var r={text:e};if(t)for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);return r},strToRichText:function(e,t){e||(e="");var r=Kekule.Render.RichTextUtils,n=e.split("\n");if(n.length<=1)return Kekule.Render.RichTextUtils.appendText(r.create(),e,t);for(var o=r.createGroup(Kekule.Render.RichText.LINES),i=0,a=n.length;i<a;++i){var s=n[i]||" ";r.appendText(o,s,t)}return o},insertText:function(e,t,r,n,o){var i=Kekule.Render.RichTextUtils.createSection(r,n);return e.items.splice(t,0,i),o&&(e.anchorItem=i),e},appendText:function(e,t,r,n){var o=Kekule.Render.RichTextUtils.createSection(t,r);return e.items.push(o),n&&(e.anchorItem=o),e},appendText2:function(e,t,r,n){var o=Kekule.Render.RichTextUtils.createSection(t,r);return e.items.push(o),n&&(e.anchorItem=o),o},insert:function(e,t,r){return e.items.splice(t,0,r),e},append:function(e,t){return e.items.push(t),e},appendItems:function(e,t){return e.items=e.items.concat(Kekule.ArrayUtils.toArray(t)),e},getItemType:function(e){return e.items?e.role:Kekule.Render.RichText.SECTION},getItemRole:function(e){var t=Kekule.Render.RichText;return Kekule.Render.RichTextUtils.getItemType(e)===t.GROUP?t.GROUP:t.SECTION},getItemTextType:function(e){return e.textType||Kekule.Render.RichText.NORMAL},isSuperscript:function(e){return Kekule.Render.RichTextUtils.getItemTextType(e)==Kekule.Render.RichText.SUP},isSubscript:function(e){return Kekule.Render.RichTextUtils.getItemTextType(e)==Kekule.Render.RichText.SUB},isGroup:function(e){return Kekule.Render.RichTextUtils.getItemType(e)===Kekule.Render.RichText.GROUP},isSection:function(e){return Kekule.Render.RichTextUtils.getItemType(e)===Kekule.Render.RichText.SECTION},getFirstNormalTextSection:function(e){for(var t=0,r=e.items.length;t<r;++t){var n=e.items[t];if(Kekule.Render.RichTextUtils.getItemTextType(n)===Kekule.Render.RichText.NORMAL)return n}return null},getActualRefItem:function(e,t){var r=e.refItem;if(!r&&t.items.length>1){var n=t.items.indexOf(e);r=n>0?t.items[n-1]:0==n?t.items[1]:null}return r},getFinalAnchorItem:function(e){return e.anchorItem?Kekule.Render.RichTextUtils.getFinalAnchorItem(e.anchorItem):e},tidy:function(e){for(var t=Kekule.Render.RichTextUtils.createGroup(e.role),r=-1,n=0,o=e.items.length;n<o;++n){var i=e.items[n];if(i.items){var a=Kekule.Render.RichTextUtils.tidy(i);if(1==a.items.length){var s=Object.extend({},a);delete s.items,delete s.role,i=s=Object.extend(s,a.items[0])}else if(a.items.length>0){++r,t.items.push(a);continue}}var l=!1;if(r>=0){var d=t.items[r];d.items||Kekule.ObjUtils.equal(i,d,["text"])&&(d.text+=i.text,l=!0)}l||(++r,t.items.push(Object.extend({},i)))}return t},clone:function(e){var t={};if(Object.extend(t,e),e.items){t.items=[];for(var r=0,n=e.items.length;r<n;++r){var o={};o=Kekule.Render.RichTextUtils.clone(e.items[r]),t.items.push(o)}}if(t.items){if(e.anchorItem){var i=e.items.indexOf(e.anchorItem);t.anchorItem=i>=0?t.items[i]:null}for(r=0,n=t.items.length;r<n;++r){var a=e.items[r];o=t.items[r];if(a.refItem){i=e.items.indexOf(a.refItem);o.refItem=i>=0?t.items[i]:null}}}return t},toText:function(e){var t="";if(!e.items)return e.text||"";for(var r=0,n=e.items.length;r<n;++r){var o=e.items[r];o.items?t+=Kekule.Render.RichTextUtils.toText(o):o.text&&(t+=o.text)}return t},_toDebugHtml:function(e){if(!e.items)return e.text;for(var t="",r=0,n=e.items.length;r<n;++r){var o=e.items[r];if(o.items)t+=Kekule.Render.RichTextUtils._toDebugHtml(o);else if(o.text)switch(o.textType){case Kekule.Render.RichText.SUB:t+="<sub>"+o.text+"</sub>";break;case Kekule.Render.RichText.SUP:t+="<sup>"+o.text+"</sup>";break;default:t+=o.text}}return t},toSimpleHtmlCode:function(e){return Kekule.Render.RichTextUtils._toDebugHtml(e)},fromSimpleHtmlCode:function(e){for(var t,r=Kekule.Render.RichText,n=new RegExp("</?([a-z]+)/?>","ig"),o=[],i=0,a=r.NORMAL;null!==(t=n.exec(e));){var s=t.index,l=t[0],d=t[1].toLowerCase();i<s&&o.push({textType:a,text:e.substring(i,s)});var u=1===l.indexOf("/");if(!(l.lastIndexOf("/")===l.length-2)){var c="sup"===d?r.SUP:"sub"===d?r.SUB:null;c&&(u?a===c&&(a=r.NORMAL):a=c)}i=s+l.length}e.length>i&&o.push({textType:a,text:e.substring(i)});for(var h=Kekule.Render.RichTextUtils,g=h.createGroup(null,{charDirection:Kekule.Render.TextDirection.LTR}),p=0,f=o.length;p<f;++p){var C=o[p].textType,R=o[p].text;if(R){var D=h.createSection(R,{textType:C});h.append(g,D)}}return g},toHtml:function(e,t,r){var n,o,i=Kekule.Render.RichText;o=t.charDirection?t.charDirection===Kekule.Render.TextDirection.RTL||t.charDirection===Kekule.Render.TextDirection.BTT:r;var a=t.role;if(a===i.SECTION||t.text){var s=t.textType,l=s===i.SUB?"sub":s===i.SUP?"sup":"span";n=e.createElement(l);var d=t.text;o&&(d=d.reverse()),Kekule.DomUtils.setElementText(n,t.text||"")}else{var u,c,h=null;a===i.LINES?(n=e.createElement("div"),h="p",u="margin:0.2em 0;padding:0"):n=e.createElement("span");for(var g=0,p=t.items.length;g<p;++g){var f=t.items[g],C=Kekule.Render.RichTextUtils.toHtml(e,f,o);if(h){var R=e.createElement(h);u&&(R.style.cssText=u),R.appendChild(C),C=R}o&&c?n.insertBefore(C,c):n.appendChild(C),c=C}}var D=n.style,m=Kekule.Render.RichTextUtils.STYLE_PROPS;for(g=0,p=m.length;g<p;++g){var y=m[g];t[y]&&(D[y]=t[y])}return n},fromHtml:function(e){var t=Kekule.Render.RichText,r=Kekule.Render.RichTextUtils,n=Kekule.DomUtils,o=Kekule.StyleUtils;return function e(i,a){if(i.nodeType===Node.TEXT_NODE)return(O=(O=i.nodeValue).replace(/[\r\n]/g,"")).trim()?r.createSection(O):null;if(i.nodeType===Node.ELEMENT_NODE){var s=r.STYLE_PROPS;s.push("direction");for(var l={},d=0,u=s.length;d<u;++d){var c,h=s[d];(c=a?o.getComputedStyle(i,h):i.style[h])&&(l[h]=c)}if(l.direction?(l.charDirection="ltr"===l.direction?Kekule.Render.TextDirection.LTR:"rtl"===l.direction?Kekule.Render.TextDirection.RTL:"inherit"===l.direction?Kekule.Render.TextDirection.INHERIT:null,delete l.direction):l.charDirection=Kekule.Render.TextDirection.DEFAULT,n.getFirstChildElem(i)){var g=t.GROUP,p=n.getChildNodesOfTypes(i,[Node.ELEMENT_NODE,Node.TEXT_NODE]),f=[],C=!1;for(d=0,u=p.length;d<u;++d){var R=p[d],D=e(R,!1);R.nodeType===Node.ELEMENT_NODE&&("br"===R.tagName.toLowerCase()&&(f.push("br"),C=!0),o.isBlockElem(R)&&(C=!0,D._isLine=!0)),D&&f.push(D)}if(C){var m=[],y=[];for(d=0,u=f.length;d<u;++d)if((D=f[d])._isLine||"br"==D){if(y.length){if(y.length>1){var T=r.createGroup();r.appendItems(T,y),m.push(T)}else m.push(y[0]);y=[]}D._isLine&&(delete D._isLine,m.push(D))}else y.push(D);y.length&&(y.length>1?(T=r.createGroup(),r.appendItems(T,y),m.push(T)):m.push(y[0])),f=m}C&&(g=t.LINES);var x=r.createGroup(g,l);for(d=0,u=f.length;d<u;++d)r.append(x,f[d]);return x}var O=n.getElementText(i),S=i.tagName.toLowerCase();return l.textType="sub"===S?t.SUB:"sup"===S?t.SUP:t.NORMAL,O?r.createSection(O,l):null}}(e,!0)}},Kekule.Render.ChemDisplayTextUtils={RADICAL_LABELS:["","••","•","••"],RADICAL_TRIPLET_ALTER_LABEL:"^^",getRadicalDisplayText:function(e,t){return t&&e===Kekule.RadicalOrder.TRIPLET?Kekule.Render.ChemDisplayTextUtils.RADICAL_TRIPLET_ALTER_LABEL:Kekule.Render.ChemDisplayTextUtils.RADICAL_LABELS[e]},getChargeDisplayText:function(e,t,r){var n="";if(!!e&&(!t||Math.abs(e)>Math.pow(10,-t)/2)){var o=e>0?"+":"-",i=Math.abs(e);1!=i?n+=t?Kekule.NumUtils.toDecimals(i,t):i.toString():r===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND&&(o=e>0?"⊕":"⊖"),n+=o}return n},getElectronicBiasDisplayText:function(e,t){var r="";if(e&&t){var n=e>0?"+":e<0?"-":null;if(n){r=t;for(var o=Math.abs(e),i=0;i<o;++i)r+=n}}return r},getChargeExDisplayText:function(e,t,r,n,o){return e?Kekule.Render.ChemDisplayTextUtils.getChargeDisplayText(e,r,o):t?Kekule.Render.ChemDisplayTextUtils.getElectronicBiasDisplayText(t,n):""},createElectronStateDisplayTextSection:function(e,t,r,n,o,i,a){var s=null,l="";return(e||i)&&(l=Kekule.Render.ChemDisplayTextUtils.getChargeExDisplayText(e,i,r,a,n)),t&&(l+=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(t,o)||""),l&&(s=Kekule.Render.RichTextUtils.createSection(l,{textType:Kekule.Render.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR})),s},formulaToRichText:function(e,t,r,n,o,i,a){return Kekule.Render.ChemDisplayTextUtils._convFormulaToRichTextGroup(e,!1,t,r,n,o,i,a)},_convFormulaToRichTextGroup:function(e,t,r,n,o,i,a,s){var l=Kekule.Render.RichTextUtils.createGroup(),d=e.getSections();if(t){var u=e.getMaxNestedLevel()%Kekule.FormulaUtils.FORMULA_BRACKET_TYPE_COUNT,c=Kekule.FormulaUtils.FORMULA_BRACKETS[u][0],h=Kekule.FormulaUtils.FORMULA_BRACKETS[u][1];l=Kekule.Render.RichTextUtils.appendText(l,c)}for(var g=0,p=d.length;g<p;++g){var f=d[g].obj,C=e.getSectionCharge(d[g]),R=null;if(f instanceof Kekule.MolecularFormula)R=Kekule.Render.ChemDisplayTextUtils._convFormulaToRichTextGroup(f,!0,!1,!1,o,i,a);else if(f.getDisplayRichText)R=f.getDisplayRichText(Kekule.Render.HydrogenDisplayLevel.NONE,!1,null,i,o,a);if(R){if(1!=d[g].count&&((R=Kekule.Render.RichTextUtils.appendText(R,d[g].count.toString(),{textType:Kekule.Render.RichText.SUB})).charDirection=Kekule.Render.TextDirection.LTR),r&&C)(D=Kekule.Render.ChemDisplayTextUtils.createElectronStateDisplayTextSection(C,null,o,a,s))&&Kekule.Render.RichTextUtils.append(R,D);l=Kekule.Render.RichTextUtils.append(l,R)}}if(t&&(l=Kekule.Render.RichTextUtils.appendText(l,h)),r||n){C=e.getCharge();var D,m=e.getRadical();(D=Kekule.Render.ChemDisplayTextUtils.createElectronStateDisplayTextSection(C,m,o,a))&&Kekule.Render.RichTextUtils.append(l,D)}return l}},Kekule.Render.TextDrawUtils={isHorizontalLine:function(e){return e==Kekule.Render.TextDirection.LTR||e==Kekule.Render.TextDirection.RTL||null==e},isVerticalLine:function(e){return e==Kekule.Render.TextDirection.TTB||e==Kekule.Render.TextDirection.BTT},getOppositeDirection:function(e){var t=Kekule.Render.TextDirection;switch(e){case t.LTR:return t.RTL;case t.RTL:return t.LTR;case t.TTB:return t.BTT;case t.BTT:return t.TTB}},isOppositeDirection:function(e,t){return Kekule.Render.TextDrawUtils.getOppositeDirection(e)===t},getActualDirection:function(e,t){var r=Kekule.Render.TextDirection;return e===r.LINE_BREAK?t===r.TTB||t===r.BTT?r.LTR:t===r.LTR||t===r.RTL?r.TTB:e:e},getActualAlign:function(e,t){var r=Kekule.Render.TextAlgin,n=Kekule.Render.TextDirection;switch(e){case r.LEFT:case r.RIGHT:case r.TOP:case r.BOTTOM:case r.CENTER:return e;case r.LEADING:switch(t){case n.TTB:return r.TOP;case n.BTT:return r.BOTTOM;case n.RTL:return r.RIGHT;case n.LTR:default:return r.LEFT}case r.TRAILING:switch(t){case n.BTT:return r.TOP;case n.TTB:return r.BOTTOM;case n.RTL:return r.LEFT;case n.LTR:default:return r.RIGHT}}}},Kekule.Render.DrawPathUtils={makePath:function(){for(var e,t=[],r=null,n=[],o=0,i=arguments.length;o<i;++o){var a=arguments[o];DataType.isArrayValue(a)?n=n.concat(a):"number"==typeof a?n.push(a):(r&&(e={method:r,params:n},t.push(e),r=null,n=[]),r=a.toString()),o===i-1&&r&&(e={method:r,params:n},t.push(e))}return t}},Kekule.Render.ConnectorDrawUtils={getPossibleConnectorRenderTypes:function(e){if(e instanceof Kekule.Bond)return Kekule.Render.ConnectorDrawUtils.getPossibleBondRenderTypes(e);var t=Kekule.Render.BondRenderType;return[t.SINGLE,t.DASHED,t.WAVY]},getDefConnectorRenderType:function(e){return Kekule.Render.ConnectorDrawUtils.getPossibleConnectorRenderTypes(e)[0]},getPossibleBondRenderTypes:function(e){var t=Kekule.Render.BondRenderType,r=Kekule.BondType;switch(e.getBondType()){case r.HYDROGEN:case r.TRANSITION:return[t.DASHED,t.ARROWED,t.WAVY];case r.COORDINATE:return[t.ARROWED,t.SINGLE,t.DASHED,t.WAVY];case r.IONIC:case r.METALLIC:case r.UNKNOWN:return[t.SINGLE,t.DASHED,t.WAVY];case r.COVALENT:break;default:return[t.SINGLE,t.DASHED,t.ARROWED,t.WAVY]}if(e.getConnectedObjCount()>2)return[t.DASHED,t.SINGLE];var n=Kekule.BondOrder;switch(e.getBondOrder()){case n.DOUBLE:var o=[t.DOUBLE,t.DASHED_DOUBLE,t.BOLD_DOUBLE,t.WAVY];return e.getStereo&&[Kekule.BondStereo.E_OR_Z,Kekule.BondStereo.CIS_OR_TRANS].indexOf(e.getStereo())>=0&&o.unshift(t.SCISSORS_DOUBLE),o;case n.TRIPLE:return[t.TRIPLE,t.BOLD_TRIPLE,t.WAVY];case n.QUAD:return[t.QUAD,t.BOLD_QUAD,t.WAVY];case n.EXPLICIT_AROMATIC:return[t.SOLID_DASH,t.WAVY];case n.SINGLE:var i=Kekule.BondStereo,a=[t.SINGLE,t.BOLD,t.WAVY];switch(e.getStereo()){case i.UP:a.unshift(t.WEDGED_SOLID,t.WEDGED_HOLLOW);break;case i.UP_INVERTED:a.unshift(t.WEDGED_SOLID_INV,t.WEDGED_HOLLOW_INV);break;case i.DOWN:a.unshift(t.WEDGED_HASHED,t.DASHED);break;case i.DOWN_INVERTED:a.unshift(t.WEDGED_HASHED_INV,t.DASHED);break;case i.UP_OR_DOWN:case i.UP_OR_DOWN_INVERTED:a=[t.WAVY,t.SINGLE];break;case i.CLOSER:a=[t.WEDGED_SOLID_BOTH,t.WEDGED_HOLLOW_BOTH]}return a;default:return[t.SINGLE,t.DASHED,t.ARROWED,t.WAVY]}},getDefBondRenderType:function(e){return Kekule.Render.ConnectorDrawUtils.getPossibleBondRenderTypes(e)[0]},getConnectorRender3DType:function(e,t){var r=Kekule.Render.Bond3DRenderType,n=Kekule.Render.Bond3DRenderMode;return(!t||t!==n.WIRE&&t!==n.CYLINDER)&&e instanceof Kekule.Bond?Kekule.Render.ConnectorDrawUtils.getBondRender3DTypes(e):r.SINGLE},getBondRender3DTypes:function(e){var t=Kekule.Render.Bond3DRenderType,r=Kekule.BondType;switch(e.getBondType()){case r.HYDROGEN:case r.TRANSITION:return t.DASH;case r.COVALENT:break;default:return t.SINGLE}var n=Kekule.BondOrder;switch(e.getBondOrder()){case n.DOUBLE:return t.DOUBLE;case n.TRIPLE:return t.TRIPLE;case n.EXPLICIT_AROMATIC:return t.SOLID_DASH;default:return t.SINGLE}}},Kekule.Render.ObjUtils={getContainerBox:function(e,t,r){var n;t||(t=Kekule.CoordMode.COORD2D);var o=e;if(o.getExposedContainerBox)n=o.getExposedContainerBox(t,r);else if(o.getContainerBox)n=o.getContainerBox(t,r);else{var i=o.getAbsCoordOfMode?o.getAbsCoordOfMode(t):null;n=i?Kekule.BoxUtils.createBox(i,i):null}return n}},Kekule.Render.MetaShapeUtils={createShapeInfo:function(e,t,r){var n={shapeType:e,coords:t};return r&&(n=Object.extend(n,r)),n},isCompositeShape:function(e){return DataType.isArrayValue(e)},inflateShape:function(e,t){if(!e)return null;var r,n=Kekule.Render.MetaShapeType,o=Kekule.Render.MetaShapeUtils;if(o.isCompositeShape(e)){for(var i=[],a=0,s=e.length;a<s;++a){var l=e[a],d=o.inflateShape(l,t);i.push(d)}return i}switch(e.shapeType){case n.POINT:r=o._inflatePointShape(e,t);break;case n.CIRCLE:r=o._inflateCircleShape(e,t);break;case n.LINE:r=o._inflateLineShape(e,t);break;case n.RECT:r=o._inflateRectShape(e,t);break;case n.POLYGON:r=o._inflatePolygonShape(e,t);break;case n.ARC:r=o._inflateArcShape(e,t)}return r},_inflatePointShape:function(e,t){return Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.CIRCLE,[e.coords[0]],{radius:t})},_inflateCircleShape:function(e,t){return Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.CIRCLE,[e.coords[0]],{radius:e.radius+t})},_inflateLineShape:function(e,t){return Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.LINE,[e.coords[0],e.coords[1]],{width:(e.width||0)+2*t})},_inflateArcShape:function(e,t){var r=Object.extend({},e);return r.width=(e.width||0)+2*t,r},_inflateRectShape:function(e,t){var r=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.RECT,[]),n=Kekule.Render.MetaShapeUtils._inflateCoords(e.coords,t);return r.coords=n,r},_inflatePolygonShape:function(e,t){var r=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.POLYGON,[]),n=Kekule.Render.MetaShapeUtils._inflateCoords(e.coords,t);return r.coords=n,r},_inflateCoords:function(e,t){for(var r=Kekule.CoordUtils,n=[],o=r.getCenter(e),i=0,a=e.length;i<a;++i){var s=e[i],l=r.substract(s,o),d=r.getDistance(l),u=r.multiply(l,t/d),c=r.add(s,u);n.push(c)}return n},getDistance:function(e,t,r){if(Kekule.Render.MetaShapeUtils.isCompositeShape(t)){for(var n=null,o=0,i=t.length;o<i;++o){var a=t[o],s=Kekule.Render.MetaShapeUtils.getDistance(e,a,r);(null===n||n>s)&&(n=s)}return n}var l=Kekule.Render.MetaShapeType,d=Kekule.Render.MetaShapeUtils,u=r?d.inflateShape(t,r):t;switch(t.shapeType){case l.POINT:return r?d._getDistanceToCircle(e,u):d._getDistanceToPoint(e,u);case l.CIRCLE:return d._getDistanceToCircle(e,u);case l.LINE:return d._getDistanceToLine(e,u);case l.RECT:return d._getDistanceToRect(e,u);case l.POLYGON:return d._getDistanceToPolygon(e,u);case l.ARC:return d._getDistanceToArc(e,u);default:return!1}},_getDistanceToPoint:function(e,t){return Kekule.CoordUtils.getDistance(e,t.coords[0])},_getDistanceToCircle:function(e,t){return Kekule.CoordUtils.getDistance(e,t.coords[0])-t.radius},_getDistanceToArc:function(e,t){var r=Kekule.CoordUtils,n=r.substract(e,t.coords[0]),o=Math.atan2(n.y,n.x);if(Kekule.Render.MetaShapeUtils.isAngleInArcRange(o,t.startAngle,t.endAngle,t.anticlockwise)){var i=r.getDistance(e,t.coords[0]);i=Math.abs(i-t.radius);return t.width&&t.width>1&&(i-=t.width/2),Math.max(0,i)}var a,s=t.coords[0];a=t.width&&t.width>1?[t.radius-t.width/2,t.radius+t.width/2]:[t.radius];for(var l=[],d=t.startAngle,u=t.endAngle,c=0,h=a.length;c<h;++c){var g=a[c],p=r.add(s,{x:g*Math.cos(d),y:g*Math.sin(d)}),f=r.add(s,{x:g*Math.cos(u),y:g*Math.sin(u)});l.push(p),l.push(f)}var C=null;for(c=0,h=l.length;c<h;++c){i=r.getDistance(l[c],e);(null===C||C>i)&&(C=i)}return C},_getDistanceToLine:function(e,t){var r=Kekule.Render.MetaShapeUtils,n=t.coords,o=Kekule.Render.MetaShapeUtils._calcVerticalLineCrossPoint(e,n[0],n[1]),i=Kekule.NumUtils;if(i.isFloatEqual(n[0].x,n[1].x)&&i.isFloatEqual(n[0].y,n[1].y)){var a={coords:[t.coords[0]],radius:t.width};return r._getDistanceToCircle(e,a)}var s=Kekule.CoordUtils.substract(n[1],n[0]);if(Math.abs(s.y)>Math.abs(s.x)?Math.sign(o.y-n[0].y)*Math.sign(o.y-n[1].y)<=0:Math.sign(o.x-n[0].x)*Math.sign(o.x-n[1].x)<=0)return Kekule.CoordUtils.getDistance(e,o)-(t.width||0)/2;var l={coords:[t.coords[0]],radius:t.width||0},d={coords:[t.coords[1]],radius:t.width||0},u=r._getDistanceToCircle(e,l),c=r._getDistanceToCircle(e,d);return Math.min(u,c)},_getDistanceToRect:function(e,t){var r=t.coords,n=Kekule.Render.MetaShapeUtils,o=Object.extend({},t);return o.shapeType=Kekule.Render.MetaShapeType.POLYGON,o.coords=[{x:r[0].x,y:r[0].y},{x:r[1].x,y:r[0].y},{x:r[1].x,y:r[1].y},{x:r[0].x,y:r[1].y}],n._getDistanceToPolygon(e,o)},_getDistanceToPolygon:function(e,t){Kekule.CoordUtils;for(var r=Kekule.Render.MetaShapeUtils,n=Kekule.Render.MetaShapeType,o=r._isInsidePolygon(e,t),i=t.coords,a=null,s=0,l=i.length;s<l;++s){var d=i[s],u=i[(s+1)%l],c=r.createShapeInfo(n.LINE,[d,u],{width:0}),h=r._getDistanceToLine(e,c);null===a?a=h:a>h&&(a=h)}return o&&(a=-a),a},_getDistanceOfTwoLines:function(e,t){Kekule.Render.MetaShapeUtils;var r=Kekule.GeometryUtils;if(r.getCrossPointOfLines(e[0],e[1],t[0],t[1]))return 0;var n=r.getDistanceFromPointToLine(e[0],t[0],t[1]),o=r.getDistanceFromPointToLine(e[1],t[0],t[1]),i=r.getDistanceFromPointToLine(t[0],e[0],e[1]),a=r.getDistanceFromPointToLine(t[1],e[0],e[1]);return Math.min(n,o,i,a)},isCoordInside:function(e,t,r){if(!e)return!1;if(Kekule.Render.MetaShapeUtils.isCompositeShape(t)){for(var n=0,o=t.length;n<o;++n){var i=t[n];if(Kekule.Render.MetaShapeUtils.isCoordInside(e,i,r))return!0}return!1}var a=Kekule.Render.MetaShapeType,s=Kekule.Render.MetaShapeUtils,l=r?s.inflateShape(t,r):t;if(!l)return!1;switch(t.shapeType){case a.POINT:return r?s._isInsideCircle(e,l):s._isInsidePoint(e,l);case a.CIRCLE:return s._isInsideCircle(e,l);case a.LINE:return s._isInsideLine(e,l);case a.RECT:return s._isInsideRect(e,l);case a.POLYGON:return s._isInsidePolygon(e,l);case a.ARC:return s._isInsideArc(e,l);default:return!1}},_isInsidePoint:function(e,t){return Kekule.CoordUtils.isEqual(e,t.coords[0])},_isInsideCircle:function(e,t){return Kekule.CoordUtils.getDistance(e,t.coords[0])<=t.radius},_isInsideLine:function(e,t){var r=t.coords,n=Kekule.Render.MetaShapeUtils._calcVerticalLineCrossPoint(e,r[0],r[1]),o=Kekule.NumUtils;if(o.isFloatEqual(r[0].x,r[1].x)&&o.isFloatEqual(r[0].y,r[1].y)){var i={coords:[t.coords[0]],radius:t.width};return Kekule.Render.MetaShapeUtils._isInsideCircle(e,i)}var a=Kekule.CoordUtils.substract(r[1],r[0]);return!!(Math.abs(a.y)>Math.abs(a.x)?Math.sign(n.y-r[0].y)*Math.sign(n.y-r[1].y)<=0:Math.sign(n.x-r[0].x)*Math.sign(n.x-r[1].x)<=0)&&Kekule.CoordUtils.getDistance(e,n)<=t.width/2},_isInsideArc:function(e,t){var r=Kekule.CoordUtils,n=Kekule.GeometryUtils,o=r.getDistance(e,t.coords[0]),i=Math.abs(o-t.radius)<t.width/2;if(i){var a=r.substract(e,t.coords[0]),s=n.standardizeAngle(Math.atan2(a.y,a.x),0);i=Kekule.Render.MetaShapeUtils.isAngleInArcRange(s,t.startAngle,t.endAngle,t.anticlockwise)}return i},_isInsideRect:function(e,t){var r=t.coords;return Kekule.CoordUtils.insideRect(e,r[0],r[1])},_isInsidePolygon:function(e,t){for(var r=e.x,n=e.y,o=t.coords,i={x:o[0].x,y:o[0].y},a={x:o[0].x,y:o[0].y},s=1,l=o.length;s<l;++s){var d=o[s];d.x<i.x?i.x=d.x:d.x>a.x&&(a.x=d.x),d.y<i.y?i.y=d.y:d.y>a.y&&(a.y=d.y)}if(!Kekule.CoordUtils.insideRect(e,i,a))return!1;for(var u=!1,c=(s=0,(l=o.length)-1);s<l;++s){var h=o[s],g=o[c];(h.y<n&&g.y>=n||g.y<n&&h.y>=n)&&(h.x<=r||g.x<=r)&&h.x+(n-h.y)/(g.y-h.y)*(g.x-h.x)<r&&(u=!u),c=s}return u},_calcVerticalLineCrossPoint:function(e,t,r){var n={};if(Math.abs(t.x-r.x)<1e-10)n.x=t.x,n.y=e.y;else{var o=(r.y-t.y)/(r.x-t.x);n.x=(o*o*t.x+o*(e.y-t.y)+e.x)/(o*o+1),n.y=o*(n.x-t.x)+t.y}return n},getContainerBox:function(e,t){var r=Kekule.Render.MetaShapeType,n=Kekule.Render.MetaShapeUtils,o=Kekule.BoxUtils;if(!e)return null;var i,a=e.coords;if(t=t||0,n.isCompositeShape(e)){i=null;for(var s=0,l=e.length;s<l;++s){var d=e[s],u=n.getContainerBox(d);i=i?o.getContainerBox(i,u):u}}else switch(e.shapeType){case r.POINT:case r.CIRCLE:var c=e.shapeType===r.POINT?0:e.radius||0,h=a[0];i=o.createBox({x:h.x-c,y:h.y-c},{x:h.x+c,y:h.y+c});break;case r.LINE:i=o.createBox(a[0],a[1]),i=Kekule.BoxUtils.inflateBox(i,(e.width||0)/2);break;case r.ARC:i=Kekule.Render.MetaShapeUtils._getArcContainerBox(e);break;case r.RECT:i=o.createBox(a[0],a[1]);break;case r.POLYGON:i=o.createBox(a[0],a[0]);for(s=1,l=a.length;s<l;++s){h=a[s];i={x1:Math.min(i.x1,h.x),y1:Math.min(i.y1,h.y),x2:Math.max(i.x2,h.x),y2:Math.max(i.y2,h.y)}}}return t&&(i=Kekule.BoxUtils.inflateBox(i,t)),i},_getArcContainerBox:function(e){var t,r=Kekule.Render.MetaShapeUtils,n=Kekule.CoordUtils;t=e.width&&e.width>1?[e.radius+e.width/2,e.radius-e.width/2]:[e.radius];for(var o=e.coords[0],i=Math.PI/2,a=function(e,t){return n.add(o,{x:t*Math.cos(e),y:t*Math.sin(e)})},s=[],l=0,d=t.length;l<d;++l){var u=t[l],c=a(e.startAngle,u),h=a(e.endAngle,u);s=s.concat([c,h]);for(var g=[0,i,2*i,3*i],p=0,f=g.length;p<f;++p)r.isAngleInArcRange(g[p],e.startAngle,e.endAngle,e.anticlockwise)&&s.push(a(g[p],u))}return n.getContainerBox(s)},isAngleInArcRange:function(e,t,r,n){var o=Kekule.GeometryUtils.standardizeAngle,i=o(t),a=o(r),s=o(e),l=Math.sign(s-i)*Math.sign(s-a)*Math.sign(a-i);return n?l>=0:l<=0},isIntersectingLine:function(e,t,r){var n=Kekule.Render.MetaShapeType,o=Kekule.Render.MetaShapeUtils;if(o.isCompositeShape(e)){for(var i=0,a=e.length;i<a;++i){var s=e[i];if(o.isIntersectingLine(s,t,r))return!0}return!1}var l=o.createShapeInfo(n.LINE,t),d=r/2,u=e.coords;switch(e.shapeType){case n.POINT:return(h=o._getDistanceToLine(u[0],l))<=d;case n.CIRCLE:return(h=o._getDistanceToLine(u[0],l))<=d+(l.radius||0);case n.LINE:return(h=o._getDistanceOfTwoLines(u,t))<=d+(l.width||0);case n.RECT:case n.POLYGON:var c=o._getCoordsForShapeInComparingWithPolygon(e),h=null,g=c.length-1;for(i=0,a=c.length;i<a;++i){var p=[c[i],c[g]],f=o._getDistanceOfTwoLines(p,t);(null===h||f<h)&&(h=f),g=i}return h<=d}return!1},isInsideBox:function(e,t){var r=Kekule.Render.MetaShapeUtils.getContainerBox(e);return Kekule.BoxUtils.isInside(r,t)},isIntersectingBox:function(e,t){if(!Kekule.Render.MetaShapeUtils.isCompositeShape(e)){var r=e.coords;for(o=0,i=r.length;o<i;++o){var n=r[o];if(Kekule.CoordUtils.isInsideBox(n,t))return!0}return!1}for(var o=0,i=e.length;o<i;++o){var a=e[o];if(Kekule.Render.MetaShapeUtils.isIntersectingBox(a,t))return!0}},isPointInsidePolygon:function(e,t){for(var r=!1,n=t.length,o=n-1,i=0;i<n;++i)t[i].y>e.y!=t[o].y>e.y&&e.x<(t[o].x-t[i].x)*(e.y-t[i].y)/(t[o].y-t[i].y)+t[i].x&&(r=!r),o=i;return r},isInsidePolygon:function(e,t){var r=Kekule.Render.MetaShapeUtils,n=r._getCoordsForShapeInComparingWithPolygon(e);if(!n)return!1;for(var o=0,i=n.length;o<i;++o){var a=n[o];if(!r.isPointInsidePolygon(a,t))return!1}return!0},isIntersectingPolygon:function(e,t){var r=Kekule.Render.MetaShapeUtils,n=r._getCoordsForShapeInComparingWithPolygon(e);if(!n)return!1;for(var o=0,i=n.length;o<i;++o){var a=n[o];if(r.isPointInsidePolygon(a,t))return!0}return!1},isIntersectingPolyline:function(e,t,r){for(var n=Kekule.Render.MetaShapeUtils,o=0,i=t.length-1;o<i;++o){var a=[t[o],t[o+1]];if(n.isIntersectingLine(e,a,r))return!0}return!1},_getCoordsForShapeInComparingWithPolygon:function(e){var t,r=Kekule.Render.MetaShapeType,n=Kekule.Render.MetaShapeUtils;if(n.isCompositeShape(e)){t=[];for(var o=0,i=e.length;o<i;++o){var a=e[o],s=n._getCoordsForShapeInComparingWithPolygon(a);t=t.concat(s)}return t}var l=e.coords;switch(e.shapeType){case r.POINT:t=[l[0]];break;case r.CIRCLE:var d=e.radius||0;if(d){var u=d,c=u/Math.sqrt(2);t=[{x:u,y:0},{x:c,y:c},{x:0,y:u},{x:-c,y:c},{x:-u,y:0},{x:-c,y:-c},{x:0,y:-u},{x:c,y:-c}]}else t=[l[0]];break;case r.LINE:t=[l[0],l[1]];break;case r.RECT:var h=l[0],g=l[1];t=[h,{x:g.x,y:h.y},g,{x:h.x,y:g.y}];break;case r.POLYGON:t=l}return t},getEdgeVectors:function(e){var t,r=Kekule.Render.MetaShapeType,n=Kekule.Render.MetaShapeUtils,o=Kekule.CoordUtils;if(n.isCompositeShape(e)){t=[];for(var i=0,a=e.length;i<a;++i){var s=e[i],l=n.getEdgeVectors(s);t=t.concat(l)}return t}var d=e.coords;switch(e.shapeType){case r.POINT:t=[[d[0],d[0]]];break;case r.CIRCLE:t=null;break;case r.LINE:var u=e.width;if(u){var c=d[0],h=d[1],g=o.substract(h,c),p=o.getDistance(c,h),f=u/2,C=f*(g.y/p),R=f*(g.x/p),D=[{x:c.x-C,y:c.y+R},{x:c.x+C,y:c.y-R},{x:h.x+C,y:h.y-R},{x:h.x-C,y:h.y+R}];t=[[D[0],D[1]],[D[1],D[2]],[D[2],D[3]],[D[3],D[0]]]}else t=[[d[0],d[1]]];break;case r.RECT:var m=d[0],y=(c={x:(h=d[1]).x,y:m.y},{x:m.x,y:h.y});t=[[m,c],[c,h],[h,y],[y,m]];break;case r.POLYGON:t=[];for(i=0,a=d.length-1;i<a;++i){var T=++i;T>=a&&(T=0),t.push([d[i],d[T]])}}return t},getEdgeBasicElements:function(e){var t=Kekule.Render.MetaShapeType,r=Kekule.Render.MetaShapeUtils,n={vectors:[],circles:[]};if(r.isCompositeShape(e)){for(var o=0,i=e.length;o<i;++o){var a=e[o],s=r.getEdgeBasicElements(a);n.vectors=n.concat(s.vectors),n.circles=n.concat(s.circles)}return n}var l=e.coords;switch(e.shapeType){case t.POINT:n.circles.push({center:l[0],radius:0});break;case t.CIRCLE:n.circles.push({center:l[0],radius:e.radius});break;default:n.vectors=n.vectors.concat(Kekule.Render.MetaShapeUtils.getEdgeVectors(e))}return n},getCrossPointsOfVectorToShapeEdges:function(e,t,r,n){for(var o=Kekule.Render.MetaShapeUtils.getEdgeBasicElements(t),i=o.vectors,a=o.circles,s=[],l=0,d=i.length;l<d;++l){var u=i[l],c=Kekule.GeometryUtils.getCrossPointOfVectors(e,u);if(c&&(s.push(c),r))return s}for(l=0,d=a.length;l<d;++l){var h=a[l],g=Kekule.GeometryUtils.getCrossPointsOfVectorToCircle(e,h.center,h.radius,n);if(g&&g.length&&(s=s.concat(g),r))return s}return s}},Kekule.Render.RenderOptionUtils={getOptionDefinitions:function(){return[{name:"expanded",dataType:DataType.BOOL,targetClass:Kekule.StructureFragment},{name:"unitLength",dataType:DataType.FLOAT,targetClass:Kekule.ChemObject},{name:"moleculeDisplayType",dataType:DataType.INT,enumSource:Kekule.Render.MoleculeDisplayType,targetClass:Kekule.StructureFragment},{name:"renderType",dataType:DataType.INT,enumSource:Kekule.Render.BondRenderType,targetClass:Kekule.ChemStructureConnector},{name:"nodeDisplayMode",dataType:DataType.INT,enumSource:Kekule.Render.NodeLabelDisplayMode,targetClass:Kekule.ChemStructureNode},{name:"hydrogenDisplayLevel",dataType:DataType.INT,enumSource:Kekule.Render.HydrogenDisplayLevel,targetClass:Kekule.ChemStructureNode},{name:"showCharge",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkType",dataType:DataType.INT,enumSource:Kekule.Render.ChargeMarkRenderType,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkFontSize",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"chargeMarkMargin",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"chemMarkerFontSize",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"chemMarkerMargin",dataType:DataType.FLOAT,targetClass:Kekule.ChemStructureNode},{name:"distinguishSingletAndTripletRadical",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"fontSize",dataType:DataType.NUMBER},{name:"fontFamily",dataType:DataType.STRING},{name:"supFontSizeRatio",dataType:DataType.FLOAT},{name:"subFontSizeRatio",dataType:DataType.FLOAT},{name:"superscriptOverhang",dataType:DataType.FLOAT},{name:"subscriptOversink",dataType:DataType.FLOAT},{name:"textBoxXAlignment",dataType:DataType.INT,enumSource:Kekule.Render.BoxXAlignment},{name:"textBoxYAlignment",dataType:DataType.INT,enumSource:Kekule.Render.BoxYAlignment},{name:"horizontalAlign",dataType:DataType.INT,enumSource:Kekule.Render.TextAlign},{name:"verticalAlign",dataType:DataType.INT,enumSource:Kekule.Render.TextAlign},{name:"charDirection",dataType:DataType.INT,enumSource:Kekule.Render.TextDirection},{name:"customLabel",dataType:DataType.STRING,targetClass:Kekule.ChemStructureNode},{name:"bondLineWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"boldBondLineWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"hashSpacing",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"multipleBondSpacingRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"multipleBondSpacingAbs",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"multipleBondMaxAbsSpacing",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondArrowLength",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondArrowWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondWedgeWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondWedgeHashMinWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"bondLengthScaleRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"color",dataType:DataType.STRING},{name:"atomColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureNode},{name:"bondColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureObject},{name:"useAtomSpecifiedColor",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureObject},{name:"opacity",dataType:DataType.FLOAT,targetClass:Kekule.ChemObject},{name:"fillColor",dataType:DataType.STRING},{name:"strokeColor",dataType:DataType.STRING},{name:"strokeWidth",dataType:DataType.NUMBER},{name:"atomRadius",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject}]},mergeObjLocalRenderOptions:function(e,t){var r=e&&e.getOverriddenRenderOptions?e.getOverriddenRenderOptions():null;return Kekule.Render.RenderOptionUtils.mergeRenderOptions(r||{},t)},mergeObjLocalRender3DOptions:function(e,t){var r=e&&e.getOverriddenRender3DOptions?e.getOverriddenRender3DOptions():null;return Kekule.Render.RenderOptionUtils.mergeRenderOptions(r||{},t)},mergeRenderOptions:function(e,t){var r=Object.create(t);return r=Object.extend(r,e,!0,!0)},getColor:function(e){return e?e.color:null},getMoleculeDisplayType:function(e){return e?e.moleculeDisplayType:null},getNodeDisplayMode:function(e){return e?e.nodeDisplayMode:null},getHydrogenDisplayLevel:function(e){return e?e.hydrogenDisplayLevel:null},getShowCharge:function(e){return e?e.showCharge:null},getChargeDrawOptions:function(e){if(e){return Object.copyValues({},e,["showCharge","chargeMarkType","chargeMarkFontSize","chargeMarkMargin","chargeMarkCircleWidth","color","opacity"])}return null},getNodeLabelDrawOptions:function(e){if(e){return Object.copyValues({},e,["fontSize","fontFamily","supFontSizeRatio","subFontSizeRatio","superscriptOverhang","subscriptOversink","textBoxXAlignment","textBoxYAlignment","color","opacity"])}return null},getConnectorRenderType:function(e){return e?e.renderType:null},getConnectorDrawParams:function(e){if(e){return Object.copyValues({},e,["bondLineWidth","boldBondLineWidth","hashSpacing","multipleBondSpacingRatio","multipleBondSpacingAbs","multipleBondMaxAbsSpacing","bondArrowLength","bondArrowWidth","bondWedgeWidth","bondWedgeHashMinWidth","color","opacity"])}return null},getConfigPropNames:function(e){for(var t=[],r=e.getAllPropList(),n=0,o=r.getLength();n<o;++n){var i=r.getPropInfoAt(n);e.isConfigProp(i)&&t.push(i.name)}return t},convertConfigsToPlainHash:function(e){var t=Kekule.Render.RenderOptionUtils;return e instanceof Kekule.Render.Render3DConfigs?t.convert3DConfigsToPlainHash(e):t.convert2DConfigsToPlainHash(e)},convert2DConfigsToPlainHash:function(e){var t=Kekule.ObjUtils,r={};r._configs=e;for(var n=Kekule.Render.RenderOptionUtils.getConfigPropNames(e),o=["generalConfigs","moleculeDisplayConfigs","displayLabelConfigs","lengthConfigs"],i=0,a=n.length;i<a;++i){var s=n[i];if(!(o.indexOf(s)>=0)){var l=e.getPropValue(s);if(l.toHash){var d=l.toHash();r=Object.extend(r,d)}}}var u=e.getGeneralConfigs().toHash();return t.replacePropName(u,"drawOpacity","opacity"),r=Object.extend(r,u),u=e.getMoleculeDisplayConfigs().toHash(),t.replacePropName(u,"defMoleculeDisplayType","moleculeDisplayType"),t.replacePropName(u,"defNodeDisplayMode","nodeDisplayMode"),t.replacePropName(u,"defHydrogenDisplayLevel","hydrogenDisplayLevel"),t.replacePropName(u,"defChargeMarkType","chargeMarkType"),(r=Object.extend(r,u)).displayLabelConfigs=e.getDisplayLabelConfigs(),u=e.getLengthConfigs().toHash(),(r=Object.extend(r,u)).unitLength=r.unitLength||1,r},convert3DConfigsToPlainHash:function(e){var t=Kekule.ObjUtils,r={};r._configs=e;for(var n=Kekule.Render.RenderOptionUtils.getConfigPropNames(e),o=["generalConfigs","moleculeDisplayConfigs","environmentConfigs"],i=0,a=n.length;i<a;++i){var s=n[i];if(!(o.indexOf(s)>=0)){var l=e.getPropValue(s);if(l.toHash){var d=l.toHash();r=Object.extend(r,d)}}}var u=e.getGeneralConfigs().toHash();t.replacePropName(u,"drawOpacity","opacity"),r=Object.extend(r,u);u=e.getEnvironmentConfigs().toHash();r=Object.extend(r,u);u=e.getMoleculeDisplayConfigs().toHash();return t.replacePropName(u,"defMoleculeDisplayType","moleculeDisplayType"),t.replacePropName(u,"defBondSpliceMode","bondSpliceMode"),t.replacePropName(u,"defDisplayMultipleBond","displayMultipleBond"),t.replacePropName(u,"defBondColor","bondColor"),t.replacePropName(u,"defAtomColor","atomColor"),r=Object.extend(r,u)},getCascadeRenderOptionValueOfObjs:function(e,t,r){for(var n,o=!1,i=Kekule.ArrayUtils.toArray(e),a=r?"getCascadedRender3DOption":"getCascadedRenderOption",s=0,l=i.length;s<l;++s){var d=i[s];if(d[a]){var u=d[a](t);if(o){if(n!=u)return null}else n=u,o=!0}}return n},setRenderOptionValueOfObjs:function(e,t,r){for(var n=Kekule.ArrayUtils.toArray(e),o=0,i=n.length;o<i;++o){var a=n[o];if(a.setRenderOption)for(var s=Kekule.ObjUtils.getOwnedFieldNames(t),l=0,d=s.length;l<d;++l)a.setRenderOption(s[l],t[s[l]])}}},Kekule.Render.Render3DOptionUtils={getOptionDefinitions:function(){return[{name:"displayMultipleBond",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"useVdWRadius",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureNode},{name:"nodeRadius",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureNode},{name:"connectorRadius",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"nodeRadiusRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureNode},{name:"connectorRadiusRatio",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"connectorLineWidth",dataType:DataType.NUMBER,targetClass:Kekule.ChemStructureObject},{name:"color",dataType:DataType.STRING},{name:"atomColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureObject},{name:"bondColor",dataType:DataType.STRING,targetClass:Kekule.ChemStructureObject},{name:"useAtomSpecifiedColor",dataType:DataType.BOOL,targetClass:Kekule.ChemStructureObject},{name:"hideHydrogens",dataType:DataType.BOOL,targetClass:Kekule.StructureFragment},{name:"bondSpliceMode",dataType:DataType.INT,enumSource:Kekule.Render.Bond3DSpliceMode,targetClass:Kekule.ChemStructureObject}]},getConnectorRenderType:function(e){return e?e.renderType:null},convertConfigsToPlainHash:function(e){}},Kekule.Render.RenderColorUtils={getActiveAtomColorSet:function(e){return Kekule.Render.atomColors[e]},setActiveAtomColorSet:function(e,t){var r=Kekule.Render.AtomColorSets[e];return r&&(Kekule.Render.atomColorSet[t]=r),r},getColor:function(e,t){var r=Kekule.Render.RenderColorUtils.getActiveAtomColorSet(t),n=r[e];return n||(n=r[0]),n}},Kekule.Render.UpdateObjUtils={_extractObjsOfUpdateObjDetails:function(e){for(var t=[],r=0,n=e.length;r<n;++r){var o=e[r];o.obj&&Kekule.ArrayUtils.pushUnique(t,o.obj)}return t},_createUpdateObjDetailsFromObjs:function(e){for(var t=[],r=0,n=e.length;r<n;++r)t.push({obj:e[r]});return t}},function(){"use strict";var e=Kekule.OBJDEF_TEXTS,t=Class.PropertyScope;Kekule.Render.PredefinedConfigsMap=Class.create(Kekule.ConfigPresetMap,{CLASS_NAME:"Kekule.Render.PredefinedConfigsMap"}),Kekule.Render.GeneralConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.GeneralConfigs",initProperties:function(){this.addBoolConfigProp("allowCoordBorrow",!0,{scope:t.PUBLIC}),this.addFloatConfigProp("drawOpacity",1,{title:e.TITLE_DRAWOPACITY,description:e.DES_DRAWOPACITY})}}),Kekule.Render.Render2DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render2DConfigs",initProperties:function(){this.addConfigProp("generalConfigs","Kekule.Render.GeneralConfigs"),this.addConfigProp("moleculeDisplayConfigs","Kekule.Render.MoleculeDisplayConfigs"),this.addConfigProp("displayLabelConfigs","Kekule.Render.DisplayLabelConfigs"),this.addConfigProp("textFontConfigs","Kekule.Render.TextFontConfigs"),this.addConfigProp("lengthConfigs","Kekule.Render.LengthConfigs"),this.addConfigProp("colorConfigs","Kekule.Render.ColorConfigs")},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setPropStoreFieldValue("generalConfigs",new Kekule.Render.GeneralConfigs),this.setPropStoreFieldValue("moleculeDisplayConfigs",new Kekule.Render.MoleculeDisplayConfigs),this.setPropStoreFieldValue("displayLabelConfigs",new Kekule.Render.DisplayLabelConfigs),this.setPropStoreFieldValue("textFontConfigs",new Kekule.Render.TextFontConfigs),this.setPropStoreFieldValue("lengthConfigs",new Kekule.Render.LengthConfigs),this.setPropStoreFieldValue("colorConfigs",new Kekule.Render.ColorConfigs),this.setPropStoreFieldValue("environmentConfigs",new Kekule.Render.Render2DEnvironmentConfigs)},initInteractStyleMap:function(){}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.Render2DConfigs),Kekule.Render.getRender2DConfigs=function(){return Kekule.Render.Render2DConfigs.getInstance()},Kekule.Render.Render2DEnvironmentConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render2DEnvironmentConfigs",initProperties:function(){}}),Kekule.Render.MoleculeDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.MoleculeDisplayConfigs",initProperties:function(){this.addIntConfigProp("defMoleculeDisplayType",Kekule.Render.MoleculeDisplayType.SKELETAL,{enumSource:Kekule.Render.MoleculeDisplayType}),this.addIntConfigProp("defNodeDisplayMode",Kekule.Render.NodeLabelDisplayMode.SMART,{enumSource:Kekule.Render.NodeLabelDisplayMode}),this.addIntConfigProp("defHydrogenDisplayLevel",Kekule.Render.HydrogenDisplayLevel.DEFAULT,{enumSource:Kekule.Render.HydrogenDisplayLevel}),this.addIntConfigProp("defChargeMarkType",Kekule.Render.ChargeMarkRenderType.DEFAULT,{enumSource:Kekule.Render.ChargeMarkRenderType}),this.addBoolConfigProp("distinguishSingletAndTripletRadical",!1),this.addIntConfigProp("partialChargeDecimalsLength",2),this.addBoolConfigProp("autoCreateChargeAndRadicalMarker",!0,{scope:Class.PropertyScope.PUBLIC}),this.addStrConfigProp("bondLineCap","round"),this.addStrConfigProp("bondLineJoin","miter"),this.addStrConfigProp("glyphLineCap","round"),this.addStrConfigProp("glyphLineJoin","miter")}}),Kekule.Render.DisplayLabelConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.DisplayLabelConfigs",DEF_UNSET_ELEMENT:"?",DEF_DUMMY_ATOM:"Du",DEF_HETERO_ATOM:"Q",DEF_ANY_ATOM:"A",DEF_VARIABLE_ATOM:"L",DEF_RGROUP:"R",DEF_ISO_LIST_LEADING_BRACKET:"[",DEF_ISO_LIST_TAILING_BRACKET:"]",DEF_ISO_LIST_DELIMITER:",",DEF_ISO_LIST_DISALLOW_PREFIX:"NOT",initProperties:function(){var e=Kekule.ChemStructureNodeLabels;this.addBoolConfigProp("enableIsotopeAlias",e.ENABLE_ISOTOPE_ALIAS,{getter:function(){return e.ENABLE_ISOTOPE_ALIAS},setter:function(t){e.ENABLE_ISOTOPE_ALIAS=t}}),this.addStrConfigProp("unsetElement",e.UNSET_ELEMENT,{getter:function(){return e.UNSET_ELEMENT},setter:function(t){t&&(e.UNSET_ELEMENT=t)}}),this.addStrConfigProp("dummyAtom",e.DUMMY_ATOM,{getter:function(){return e.DUMMY_ATOM},setter:function(t){t&&(e.DUMMY_ATOM=t)}}),this.addStrConfigProp("heteroAtom",e.HETERO_ATOM,{getter:function(){return e.HETERO_ATOM},setter:function(t){t&&(e.HETERO_ATOM=t)}}),this.addStrConfigProp("anyAtom",e.ANY_ATOM,{getter:function(){return e.ANY_ATOM},setter:function(t){t&&(e.ANY_ATOM=t)}}),this.addStrConfigProp("variableAtom",e.VARIABLE_ATOM,{getter:function(){return e.VARIABLE_ATOM},setter:function(t){t&&(e.VARIABLE_ATOM=t)}}),this.addStrConfigProp("rgroup",e.SUBGROUP,{getter:function(){return e.SUBGROUP},setter:function(t){t&&(e.SUBGROUP=t)}}),this.addStrConfigProp("isoListLeadingBracket",e.ISO_LIST_LEADING_BRACKET,{getter:function(){return e.ISO_LIST_LEADING_BRACKET},setter:function(t){t&&(e.ISO_LIST_LEADING_BRACKET=t)}}),this.addStrConfigProp("isoListTailingBracket",e.ISO_LIST_TAILING_BRACKET,{getter:function(){return e.ISO_LIST_TAILING_BRACKET},setter:function(t){t&&(e.ISO_LIST_TAILING_BRACKET=t)}}),this.addStrConfigProp("isoListDelimiter",e.ISO_LIST_DELIMITER,{getter:function(){return e.ISO_LIST_DELIMITER},setter:function(t){t&&(e.ISO_LIST_DELIMITER=t)}}),this.addStrConfigProp("isoListDisallowPrefix",e.ISO_LIST_DISALLOW_PREFIX,{getter:function(){return e.ISO_LIST_DISALLOW_PREFIX},setter:function(t){t&&(e.ISO_LIST_DISALLOW_PREFIX=t)}}),this.addStrConfigProp("electronicBiasMark",e.DEF_ELECTRONIC_BIAS_MARK,{getter:function(){return e.DEF_ELECTRONIC_BIAS_MARK},setter:function(t){t&&(e.DEF_ELECTRONIC_BIAS_MARK=t)}})}}),Kekule.Render.TextFontConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.TextFontConfigs",DEF_LABEL_FONT_FAMILY:"",initProperties:function(){this.addStrConfigProp("labelFontFamily","Arial, Helvetica, sans-serif"),this.addStrConfigProp("atomFontFamily","Arial, Helvetica, sans-serif"),this.addFloatConfigProp("supFontSizeRatio",.66),this.addFloatConfigProp("subFontSizeRatio",.66),this.addFloatConfigProp("superscriptOverhang",.2),this.addFloatConfigProp("subscriptOversink",.2),this.addIntConfigProp("textCharDirection",Kekule.Render.TextDirection.LTR,{enumSource:Kekule.Render.TextDirection}),this.addIntConfigProp("textHorizontalAlign",Kekule.Render.TextAlign.LEADING,{enumSource:Kekule.Render.TextAlign}),this.addIntConfigProp("textVerticalAlign",Kekule.Render.TextAlign.LEADING,{enumSource:Kekule.Render.TextAlign}),this.addIntConfigProp("textBoxXAlignment",Kekule.Render.BoxXAlignment.LEFT,{enumSource:Kekule.Render.BoxXAlignment,scope:t.PUBLIC}),this.addIntConfigProp("textBoxYAlignment",Kekule.Render.BoxYAlignment.TOP,{enumSource:Kekule.Render.BoxYAlignment,scope:t.PUBLIC}),this.addIntConfigProp("textBoxAlignmentMode",Kekule.Render.TextBoxAlignmentMode.ANCHOR,{enumSource:Kekule.Render.TextBoxAlignmentMode,scope:t.PUBLIC})}}),Kekule.Render.LengthConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.LengthConfigs",initProperties:function(){this.addFloatConfigProp("unitLength",1,{scope:t.PUBLIC}),this.addFloatConfigProp("labelFontSize",14),this.addFloatConfigProp("atomFontSize",14),this.addFloatConfigProp("atomLabelBoxExpandRatio",1.2,{scope:t.PUBLIC}),this.addFloatConfigProp("chargeMarkFontSize",10),this.addFloatConfigProp("chargeMarkMargin",5),this.addFloatConfigProp("chemMarkerFontSize",10),this.addFloatConfigProp("chemMarkerMargin",5),this.addFloatConfigProp("allenCenterAtomRadius",3),this.addFloatConfigProp("defBondLength",25),this.addFloatConfigProp("bondLineWidth",1),this.addFloatConfigProp("boldBondLineWidthRatio",2,{scope:t.PUBLIC}),this.addFloatConfigProp("hashSpacing",3),this.addFloatConfigProp("multipleBondSpacingRatio",.18),this.addFloatConfigProp("multipleBondSpacingAbs",null,{scope:t.PUBLIC}),this.addFloatConfigProp("multipleBondMaxAbsSpacing",5),this.addFloatConfigProp("bondArrowLength",6),this.addFloatConfigProp("bondArrowWidth",6),this.addFloatConfigProp("bondWedgeWidth",6),this.addFloatConfigProp("bondWedgeHashMinWidth",2),this.addFloatConfigProp("bondWavyRadius",5),this.addFloatConfigProp("glyphStrokeWidth",1),this.addFloatConfigProp("glyphStickOffsetRelLength",.1),this.addFloatConfigProp("rxnMolMargin",10,{scope:t.PUBLIC}),this.addFloatConfigProp("defScaleRefLength",Kekule.globalOptions.structure.defaultBondLength2D||.8),this.addFloatConfigProp("autofitContextPadding",45)},getActualLength:function(e){var t=this.getPropValue(e);return null!=t?t*this.getUnitLength():null}}),Kekule.Render.ColorConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.ColorConfigs",initProperties:function(){this.addBoolConfigProp("useAtomSpecifiedColor",!1),this.addStrConfigProp("labelColor","#000000"),this.addStrConfigProp("atomColor","#000000"),this.addStrConfigProp("bondColor","#000000"),this.addStrConfigProp("glyphStrokeColor","#999999"),this.addStrConfigProp("glyphFillColor","#999999")}}),Kekule.Render.Render3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render3DConfigs",initProperties:function(){this.addConfigProp("generalConfigs","Kekule.Render.GeneralConfigs"),this.addConfigProp("moleculeDisplayConfigs","Kekule.Render.Molecule3DDisplayConfigs"),this.addConfigProp("lengthConfigs","Kekule.Render.Length3DConfigs"),this.addConfigProp("environmentConfigs","Kekule.Render.Render3DEnvironmentConfigs"),this.addConfigProp("modelConfigs","Kekule.Render.Model3DConfigs")},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setPropStoreFieldValue("generalConfigs",new Kekule.Render.GeneralConfigs),this.setPropStoreFieldValue("environmentConfigs",new Kekule.Render.Render3DEnvironmentConfigs),this.setPropStoreFieldValue("moleculeDisplayConfigs",new Kekule.Render.Molecule3DDisplayConfigs),this.setPropStoreFieldValue("modelConfigs",new Kekule.Render.Model3DConfigs),this.setPropStoreFieldValue("lengthConfigs",new Kekule.Render.Length3DConfigs)}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.Render3DConfigs),Kekule.Render.getRender3DConfigs=function(){return Kekule.Render.Render3DConfigs.getInstance()},Kekule.Render.Render3DEnvironmentConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render3DEnvironmentConfigs",initProperties:function(){this.addIntConfigProp("graphicQuality",Kekule.Render.Render3DGraphicQuality.MEDIUM,{enumSource:Kekule.Render.Render3DGraphicQuality}),this.addBoolConfigProp("antialias",!0)}}),Kekule.Render.Molecule3DDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Molecule3DDisplayConfigs",initProperties:function(){this.addIntConfigProp("defMoleculeDisplayType",Kekule.Render.Molecule3DDisplayType.BALL_STICK,{enumSource:Kekule.Render.Molecule3DDisplayType}),this.addIntConfigProp("defBondSpliceMode",Kekule.Render.Bond3DSpliceMode.WEIGHTING_SPLIT,{enumSource:Kekule.Render.Bond3DSpliceMode}),this.addBoolConfigProp("defDisplayMultipleBond",!0),this.addStrConfigProp("defBondColor","#FFFFFF"),this.addStrConfigProp("defAtomColor","#000099"),this.addBoolConfigProp("useAtomSpecifiedColor",!0)}}),Kekule.Render.Model3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Model3DConfigs",initProperties:function(){this.addBoolConfigProp("showNodeLabel",!0,{scope:t.PUBLIC}),this.addBoolConfigProp("hideHydrogens",!1),this.addBoolConfigProp("useVdWRadius",!0),this.addFloatConfigProp("nodeRadiusRatio",.25,{scope:t.PUBLIC}),this.addFloatConfigProp("connectorRadiusRatio",.25,{scope:t.PUBLIC}),this.addFloatConfigProp("multiConnectorRadiusRatio",.5),this.addFloatConfigProp("multiConnectorMarginRatio",1)}}),Kekule.Render.Length3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Length3DConfigs",initProperties:function(){this.addFloatConfigProp("unitLength",1,{scope:t.PUBLIC}),this.addFloatConfigProp("fixedNodeRadius",1.7),this.addFloatConfigProp("connectorRadius",.6),this.addFloatConfigProp("connectorLineWidth",2),this.addFloatConfigProp("defBondLength",100,{scope:t.PUBLIC})},getActualLength:function(e){var t=this.getPropValue(e);return null!=t?t*this.getUnitLength():null}})}(),function(){var e=Kekule.Render.RichText,t=Kekule.Render.RichTextUtils,r=Kekule.Render.TextDirection,n=Kekule.Render.TextDrawUtils,o=Kekule.Render.TextAlign;Kekule.Render.AbstractTextDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.AbstractTextDrawBridge",drawText:function(e,t,r,n){return null},canMeasureText:function(e){return!1},measureText:function(e,t,r){return{}},canMeasureDrawnText:function(e){return!1},measureDrawnText:function(e,t,r){return{}},canModifyText:function(e){return!1},modifyDrawnTextCoord:function(e,t,r){},createGroup:function(e){},addToGroup:function(e,t){},removeFromGroup:function(e,t){}}),Kekule.Render.BaseRichTextDrawer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.BaseRichTextDrawer",ITEM_PARENT_FIELD:"__$parent__",initialize:function(e,t,r){this.tryApplySuper("initialize"),this.options=t||{},e&&this.setDrawBridge(e),r&&this.setDrawConfigs(r)},initProperties:function(){this.defineProp("drawBridge",{dataType:"Kekule.Render.AbstractTextDrawBridge",serializable:!1}),this.defineProp("drawConfigs",{dataType:"Kekule.Render.Render2DConfigs",serializable:!1})},fillOptions:function(e){if(e){var t=e.getTextFontConfigs(),r=this.options;r.supFontSizeRatio=t.getSupFontSizeRatio(),r.subFontSizeRatio=t.getSubFontSizeRatio(),r.superscriptOverhang=t.getSuperscriptOverhang(),r.subscriptOversink=t.getSubscriptOversink(),r.textCharDirection=t.getTextCharDirection(),r.textLineDirection=t.getTextLineDirection(),r.textHorizontalAlign=t.getTextHorizontalAlign(),r.textVerticalAlign=t.getTextVerticalAlign(),r.textBoxXAlignment=t.getTextBoxXAlignment(),r.textBoxYAlignment=t.getTextBoxYAlignment(),r.textBoxAlignmentMode=t.getTextBoxAlignmentMode()}},cloneRichText:function(e){return Kekule.Render.RichTextUtils.clone(e)},_FONT_OPTION_FIELDS:["fontSize","fontFamily","fontWeight","fontStyle","color","overhang","oversink","opacity","zoom","transforms"],_DRAW_OPTIONS_FIELDS:["textType","charDirection","defaultCharDirection","fontSize","fontFamily","fontWeight","fontStyle","color","horizontalAlign","verticalAlign","zoom","transforms"],_fillLocalDrawOptions:function(e,t){for(var n=t||{},o=0,i=this._DRAW_OPTIONS_FIELDS.length;o<i;++o){var a=this._DRAW_OPTIONS_FIELDS[o],s=e[a];Kekule.ObjUtils.notUnset(s)&&(n[a]=s,0)}return Kekule.ObjUtils.isUnset(e.charDirection)?n.charDirection=r.DEFAULT:e.charDirection===r.INHERIT&&(n.charDirection=t.charDirection),n},RECT_INFO_FIELD:"__rectInfo__",ACTUAL_FONT_FIELD:"__drawFont__",RENDER_TEXT_FIELD:"__renderText__",RENDER_ELEM_FIELD:"__renderElem__",LOCAL_DRAW_OPTIONS_FIELD:"__drawOptions__",_setItemRectInfo:function(e,t,r){e[this.RECT_INFO_FIELD]={boundRect:Object.extend({},t),alignRect:Object.extend({},r)}},_getItemRectInfo:function(e){return e[this.RECT_INFO_FIELD]},_setActualFontInfo:function(e,t){e[this.ACTUAL_FONT_FIELD]=t},_getActualFontInfo:function(e){return e[this.ACTUAL_FONT_FIELD]},_setRenderText:function(e,t){e[this.RENDER_TEXT_FIELD]=t},_getRenderText:function(e){return e[this.RENDER_TEXT_FIELD]||e.text},_setRenderElem:function(e,t){e[this.RENDER_ELEM_FIELD]=t},_getRenderElem:function(e){return e[this.RENDER_ELEM_FIELD]},_itemHasNoAlignRect:function(e){return Kekule.ObjUtils.notUnset(e._noAlignRect)?!!e._noAlignRect:t.isSubscript(e)||t.isSuperscript(e)},drawEx:function(e,t,r,n,o){var i=this.doPrepareDrawOptions(e,r,n),a=this.cloneRichText(r),s=this.getDrawBridge(),l={delayDrawing:s.canMeasureText(),adjustDrawing:s.canModifyText()};this.doPrepare(e,t,a,i,l,[]);var d=this.doRenderRichText(e,a,i,l),u=this._getItemRectInfo(a);return{drawnObj:d,boundRect:u.boundRect,alignRect:u.alignRect}},draw:function(e,t,r,n,o){return this.drawEx(e,t,r,n,o).drawnObj},measure:function(e,t,r,n,o){var i=this.doPrepareDrawOptions(e,r,n);t||(t={x:0,y:0});var a=this.cloneRichText(r),s=this.getDrawBridge(),l={delayDrawing:s.canMeasureText(),adjustDrawing:s.canModifyText()},d=[];this.doPrepare(e,t,a,i,l,d);var u=this._getItemRectInfo(a);if(d.length&&s.removeDrawnElem)for(var c=0,h=d.length;c<h;++c){var g=d[c];s.removeDrawnElem(e,g)}return u.boundRect},doPrepareDrawOptions:function(e,t,r){var n;return r?(n=Object.create(this.options||{}),n=Object.extend(n,r)):n=this.options,n.defaultCharDirection||(n.defaultCharDirection=n.charDirection),n},doPrepare:function(e,t,r,n,o,i){var a=this.doPrepareItem(e,r,n,o,i),s=null;n.textBoxAlignmentMode===Kekule.Render.TextBoxAlignmentMode.ANCHOR&&(s=this.doGetRootAnchorItemAbsAlignRect(r));var l,d=this._getItemRectInfo(r);if(s){var u=this.doAlignRectToCoord(t,s,n.textBoxXAlignment,n.textBoxYAlignment);l={x:u.left-s.left,y:u.top-s.top}}else{var c=this.doAlignRectToCoord(t,d.alignRect,n.textBoxXAlignment,n.textBoxYAlignment);l={x:c.left-d.alignRect.left,y:c.top-d.alignRect.top}}var h=Kekule.RectUtils.shiftRect(d.alignRect,l.x,l.y),g=Kekule.RectUtils.shiftRect(d.boundRect,l.x,l.y);return this._setItemRectInfo(r,g,h),a},doAlignRectToCoord:function(e,t,r,n){var o=Kekule.Render.BoxXAlignment,i=Kekule.Render.BoxYAlignment,a=r===o.RIGHT?-1:r===o.CENTER?-.5:0,s=n===i.TOP?0:n===i.CENTER?-.5:-1,l=Object.extend({},t);return l.left=e.x+l.width*a,l.top=e.y+l.height*s,l},doGetRootAnchorItemAbsAlignRect:function(e){var t=e;if(t.anchorItem){for(var r=this._getItemRectInfo(t).alignRect,n={x:r.left,y:r.top};t.anchorItem;)t=t.anchorItem,r=this._getItemRectInfo(t).alignRect,n.x+=r.left,n.y+=r.top;return Kekule.RectUtils.createRect(n.x,n.y,r.width,r.height)}return null},doCalcActualDrawFontInfo:function(e,r){function n(e,t){if("string"==typeof e){var r=Kekule.StyleUtils.analysisUnitsValue(e);return r.value=Math.round(Math.max(r.value*t,1)),""+r.value+r.units}return e*t}for(var o={sizeScale:1},i=0,a=this._FONT_OPTION_FIELDS.length;i<a;++i){var s=this._FONT_OPTION_FIELDS[i];Kekule.ObjUtils.notUnset(r[s])&&(o[s]=r[s])}return Kekule.ObjUtils.notUnset(o.zoom)&&(o.fontSize=n(o.fontSize,o.zoom||1),o.zoom=null),t.isSuperscript(e)?(o.sizeScale=r.supFontSizeRatio,o.fontSize=n(o.fontSize,r.supFontSizeRatio),o.isSup=!0,Kekule.ObjUtils.isUnset(o.overhang)&&(o.overhang=r.superscriptOverhang||0)):t.isSubscript(e)&&(o.sizeScale=r.subFontSizeRatio,o.fontSize=n(o.fontSize,r.subFontSizeRatio),o.isSub=!0,Kekule.ObjUtils.isUnset(o.oversink)&&(o.oversink=r.subscriptOversink||0)),o},doPrepareItem:function(n,o,i,a,s){var l,d=t.getItemType(o),u=Object.create(i);switch(((u=this._fillLocalDrawOptions(o,u)).charDirection===r.DEFAULT||Kekule.ObjUtils.isUnset(u.charDirection))&&(u.charDirection=u.defaultCharDirection),d){case e.SECTION:l=this.doPrepareSection(n,o,u,a,s);break;case e.LINES:l=this.doPrepareLines(n,o,u,a,s);break;default:l=this.doPrepareGroup(n,o,u,a,s)}return l},doPrepareSection:function(e,o,i,a,s){var l=this.getDrawBridge(),d=this.doCalcActualDrawFontInfo(o,i);this._setActualFontInfo(o,d);var u,c=o.text;if(n.isVerticalLine(i.charDirection)&&c.length>1){var h=o;h.role="group",delete h.text,h.charDirection=i.charDirection;var g=Object.create(i);g=Object.extend(g,d),h.items=[];for(var p=0,f=c.length;p<f;++p)t.appendText(h,c.charAt(p));return this.doPrepareItem(e,h,g,a,s)}if(i.charDirection===r.RTL&&(c=c.reverse()),this._setRenderText(o,c),a.delayDrawing)u=l.measureText(e,c,d);else{var C=this.getDrawBridge().drawText(e,{x:-1e4,y:-1e4},c,d);this._setRenderElem(o,C),u=l.measureDrawnText(e,C,d),s.push(C)}var R={left:0,top:0,width:u.width||0,height:u.height||0};this._setItemRectInfo(o,R,R)},doPrepareLines:function(e,t,n,o,i){for(var a=n.charDirection||r.DEFAULT,s=t.items,l=a===r.TTB?r.RTL:a===r.BTT?r.LTR:r.TTB,d=0,u=s.length;d<u;++d){var c=s[d];c.charDirection||(c.charDirection=a)}return t.charDirection=l,n.charDirection=l,n._originCharDirection=a,this.doPrepareGroup(e,t,n,o,i)},doPrepareGroup:function(e,i,a,s,l){for(var d=0,u=(U=i.items).length;d<u;++d){var c=U[d];this.doPrepareItem(e,c,a,s,l)}var h,g=a.charDirection||r.DEFAULT,p=a._originCharDirection||g,f=n.isHorizontalLine(g),C=f?"x":"y",R=f?"y":"x",D=o.getAbsAlign(a.horizontalAlign,p),m=o.getAbsAlign(a.verticalAlign,p);h=f?m==o.TOP?0:m==o.CENTER?-.5:-1:D==o.RIGHT?-1:D==o.CENTER?-.5:0;var y={x:0,y:0},T=g===r.RTL||g===r.BTT?-1:1,x=f?"left":"top",O=f?"top":"left",S=[];for(d=0,u=U.length;d<u;++d){c=U[d];var k=(B=this._getItemRectInfo(c)).boundRect,v=B.alignRect;if(T>0){var A=y[C]-k[x];k[x]=y[C],v[x]+=A}var b={x:k.width,y:k.height};if(y[C]+=b[C]*T,T<0){A=y[C]-k[x];k[x]=y[C],v[x]+=A}b={x:v.width,y:v.height};if(!!(w=this._getActualFontInfo(c))&&(w.isSup||w.isSub)&&t.getActualRefItem(c,i))S.push(c);else{var E=w?w.oversink||-(w.overhang||0):0;f||(E=-E);var _=b[R]*(h+E),L=v[O]-_;v[O]=_,k[O]-=L}}for(d=0,u=S.length;d<u;++d){c=S[d];var K=t.getActualRefItem(c,i),w=this._getActualFontInfo(c),B=this._getItemRectInfo(c),I=this._getItemRectInfo(K).alignRect;k=B.boundRect,v=B.alignRect;if(w.isSup){var M=w.overhang;f?(v.top=I.top,v.height=I.height,k.top=I.top-I.height*M):(v.left=I.left,v.width=I.width,k.left=I.lefy+I.width-k.left+I.width*M)}else{E=w.oversink;f?(v.top=I.top,v.height=I.height,k.top=I.top+I.height-k.height+I.height*E):(v.left=I.left,v.width=I.width,k.left=I.left-I.width*E)}}var U,P=null,j=null;for(d=0,u=(U=i.items).length;d<u;++d){c=U[d];B=this._getItemRectInfo(c),this._itemHasNoAlignRect(c)&&(P||d!=u-1)||(P=P?Kekule.RectUtils.getContainerRect(P,B.alignRect):Object.extend({},B.alignRect)),j=j?Kekule.RectUtils.getContainerRect(j,B.boundRect):Object.extend({},B.boundRect)}if(U.length<=0&&(P=Kekule.RectUtils.createRect(0,0,0,0),j=Kekule.RectUtils.createRect(0,0,0,0)),0!==(L={x:-P.left,y:-P.top}).x||0!==L.y){for(d=0,u=U.length;d<u;++d)(B=this._getItemRectInfo(U[d])).alignRect=Kekule.RectUtils.shiftRect(B.alignRect,L.x,L.y),B.boundRect=Kekule.RectUtils.shiftRect(B.boundRect,L.x,L.y);P.left=0,P.top=0,j.left+=L.x,j.top+=L.y}this._setItemRectInfo(i,j,P)},doRenderRichText:function(e,t,r,n){var o=this.getDrawBridge().createGroup(e);return this.doRenderItem(e,{x:0,y:0},t,n,o),o},doRenderItem:function(r,n,o,i,a){var s;switch(t.getItemType(o)){case e.SECTION:s=this.doRenderSection(r,n,o,i,a);break;default:s=this.doRenderGroup(r,n,o,i,a)}return s},doRenderGroup:function(e,t,r,n,o){var i=r.items;if(i.length<=0)return null;for(var a=this._getItemRectInfo(r),s={x:t.x+a.alignRect.left,y:t.y+a.alignRect.top},l=0,d=i.length;l<d;++l)this.doRenderItem(e,s,i[l],n,o)},doRenderSection:function(e,t,r,n,o){var i=this._getItemRectInfo(r).boundRect,a={x:i.left,y:i.top};a=Kekule.CoordUtils.add(a,t);var s,l=this._getRenderText(r),d=this._getActualFontInfo(r),u=this.getDrawBridge();n.delayDrawing?s=u.drawText(e,a,l,d):n.adjustDrawing&&(s=this._getRenderElem(r),u.modifyDrawnTextCoord(e,s,a)),u.addToGroup(s,o)}})}(),Kekule.Render.BoundInfoRecorder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.BoundInfoRecorder",initialize:function(e){this.tryApplySuper("initialize"),this.setPropStoreFieldValue("boundInfos",new Kekule.TwoTupleMapEx(!0)),this._renderer=e,e&&e.setBoundInfoRecorder&&e.setBoundInfoRecorder(this),this.installEventListener(e)},finalize:function(){this._renderer&&this.uninstallEventListener(this._renderer);var e=this.getPropStoreFieldValue("boundInfos");e&&e.clear(),this.tryApplySuper("finalize")},initProperties:function(){this.defineProp("boundInfos",{dataType:"Kekule.TwoTupleMapEx",serializable:!1,setter:null}),this.defineProp("targetContext",{dataType:DataType.OBJECT,serializable:!1})},needRecordOnContext:function(e){var t=this.getTargetContext();return!t||t===e},installEventListener:function(e){e.addEventListener("updateBasicDrawObject",this._reactRendererUpdateBasicDrawObject,this),e.addEventListener("clear",this._reactRendererClear,this)},uninstallEventListener:function(e){e.removeEventListener("updateBasicDrawObject",this._reactRendererUpdateBasicDrawObject,this),e.removeEventListener("clear",this._reactRendererClear,this)},_reactRendererUpdateBasicDrawObject:function(e){var t=Kekule.Render.ObjectUpdateType;if(this.needRecordOnContext(e.context)){var r=e.updateType;r===t.ADD?this.add(e.context,e.obj,e.parentObj,e.boundInfo,e.target):r===t.MODIFY?this.modify(e.context,e.obj,e.parentObj,e.boundInfo,e.target):r===t.REMOVE?this.remove(e.context,e.obj):r===t.CLEAR&&this.clear(e.context),this.invokeEvent("updateBasicDrawObject",e)}},_reactRendererClear:function(e){this.needRecordOnContext(e.context)&&this.clearOnRenderer(e.context,e.target);this.getAllRecordedInfoOfContext(e.context)},getInfo:function(e,t){return this.getBoundInfos().get(e,t)},getBelongedInfos:function(e,t){if(a=this.getInfo(e,t))return[a];for(var r=[],n=this.getAllRecordedInfoOfContext(e),o=0,i=n.length;o<i;++o){var a,s=(a=n[o]).obj;(s===t||s.isChildOf&&s.isChildOf(t))&&r.push(a)}return r},getBound:function(e,t){var r=(d=this.getInfo(e,t))?d.boundInfo:null;if(!r){for(var n=Kekule.BoxUtils,o=Kekule.Render.MetaShapeUtils,i=this.getBelongedInfos(e,t),a=null,s=0,l=i.length;s<l;++s){var d=i[s],u=o.getContainerBox(d.boundInfo,0);a=a?n.getContainerBox(a,u):u}a&&(r=o.createShapeInfo(Kekule.Render.MetaShapeType.RECT,[{x:a.x1,y:a.y1},{x:a.x2,y:a.y2}]))}return r},clearOnRenderer:function(e,t){var r=(o=this.getBoundInfos()).getSecondLevelMap(e);if(r)for(var n=r.getKeys(),o=r.getValues(),i=n.length-1;i>=0;--i){var a=n[i];o[i].renderer===t&&r.remove(a)}},clear:function(e){var t=this.getBoundInfos().getSecondLevelMap(e);return t&&t.clear(),this},clearAll:function(){return this.getBoundInfos().clear(),this},add:function(e,t,r,n,o){return this.getBoundInfos().set(e,t,{obj:t,parentObj:r,boundInfo:n,renderer:o}),this},modify:function(e,t,r,n,o){var i=this.getBoundInfos().get(e,t);i||(i={},this.getBoundInfos.set(e,t,i));var a=Kekule.ObjUtils.notUnset;return a(r)&&(i.parentObj=r),a(n)&&(i.boundInfo=n),a(o)&&(i.renderer=o),this},remove:function(e,t,r){return this.getBoundInfos().remove(e,t),this},getAllRecordedInfoOfContext:function(e){var t=this.getBoundInfos().getSecondLevelMap(e);return t?t.getValues():[]},getAllBoundInfosOfContext:function(e){for(var t=this.getAllRecordedInfoOfContext(e),r=[],n=0,o=t.length;n<o;++n){var i=t[n].boundInfo;i&&r.push(i)}return r},getContainerBox:function(e){for(var t=Kekule.BoxUtils,r=Kekule.Render.MetaShapeUtils,n=null,o=this.getAllBoundInfosOfContext(e),i=0,a=o.length;i<a;++i){var s=r.getContainerBox(o[i],0);n=t.getContainerBox(n,s)}return n},getIntersectionInfos:function(e,t,r,n,o){for(var i=[],a=this.getAllRecordedInfoOfContext(e),s=0,l=a.length;s<l;++s){var d=a[s].boundInfo;o&&!o(a[s])||d&&Kekule.Render.MetaShapeUtils.isCoordInside(t,d,n)&&i.push(a[s])}return i}}),function(){var e=Kekule.Render.BondRenderType,t=Kekule.Render.TextDirection,r=Kekule.BoxUtils,n=Kekule.BondOrder,o=Kekule.CoordUtils,i=Kekule.oneOf;Kekule.Render.Abstract2DDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.Abstract2DDrawBridge",CONTEXT_PARAMS_FIELD:"__$context_params__",createContext:function(e,t,r,n){return null},releaseContext:function(e){},getContextParam:function(e,t){return(e[this.CONTEXT_PARAMS_FIELD]||{})[t]},setContextParam:function(e,t,r){e[this.CONTEXT_PARAMS_FIELD]||(e[this.CONTEXT_PARAMS_FIELD]={}),e[this.CONTEXT_PARAMS_FIELD][t]=r},_getOverSamplingRatio:function(e){return this.getContextParam(e,"overSamplingRatio")||null},getContextDimension:function(e){var t=this._getContextRawDimension(e),r=this._getOverSamplingRatio(e);return r&&(t.width/=r,t.height/=r),t},_getContextRawDimension:function(e){return{}},setContextDimension:function(e,t,r){var n={width:t,height:r},o=this._getOverSamplingRatio(e);o&&(n.width*=o,n.height*=o),this._setContextRawDimension(e,n.width,n.height)},_setContextRawDimension:function(e,t,r){return null},getContextElem:function(e){},setContextViewBox:function(e,t,r,n,o,i){},prepareContext:function(e){},clearContext:function(e){return null},setClearColor:function(e,t){},setFilter:function(e,t){},clearFilter:function(e){},transformContextCoordToScreen:function(e,t){var r=t,n=this._getOverSamplingRatio(e);return n&&(r=Kekule.CoordUtils.divide(r,n)),r},transformScreenCoordToContext:function(e,t){var r=t,n=this._getOverSamplingRatio(e);return n&&(r=Kekule.CoordUtils.multiply(r,n)),r},transformContextLengthToScreen:function(e,t){var r=t,n=this._getOverSamplingRatio(e);return n&&(r/=n),r},transformScreenLengthToContext:function(e,t){var r=t,n=this._getOverSamplingRatio(e);return n&&(r*=n),r},canModifyGraphic:function(e){return!1},drawPath:function(e,t,r){},drawLine:function(e,t,r,n){},drawTriangle:function(e,t,r,n,o){},drawRect:function(e,t,r,n){},drawRoundRect:function(e,t,r,n,o){},drawCircle:function(e,t,r,n){},drawArc:function(e,t,r,n,o,i,a){},drawImage:function(e,t,r,n,o,i){},drawImageElem:function(e,t,r,n,o){},createGroup:function(e){return null},addToGroup:function(e,t){},removeFromGroup:function(e,t){},removeDrawnElem:function(e,t){},exportToDataUri:function(e,t,r){}}),Kekule.Render.Base2DRenderer=Class.create(Kekule.Render.CompositeRenderer,{CLASS_NAME:"Kekule.Render.Base2DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this.__$redirectContextDebug__=!1,this._richTextDrawer=null},initProperties:function(){this.defineProp("richTextDrawerClass",{dataType:DataType.CLASS,serializable:!1})},getActualTargetContext:function(e){return this.getRedirectContext()||e},getRendererType:function(){return Kekule.Render.RendererType.R2D},canMeasureText:function(e){return this.getDrawBridge().canMeasureText(e)},getAutoScaleRefDrawLength:function(e){return e.defBondLength},getAutoScaleRefObjLength:function(e,t){var r=e||this.getChemObj();if(!r.getAllAutoScaleRefLengths)return null;var n=r.getAllAutoScaleRefLengths(Kekule.CoordMode.COORD2D,t);return n&&n.length?Kekule.ArrayUtils.getMedian(n):void 0},getRichTextDrawer:function(){if(!this._richTextDrawer){var e=this.getRichTextDrawerClass()||Kekule.Render.BaseRichTextDrawer;this._richTextDrawer=new e(this.getDrawBridge())}return this._richTextDrawer},drawPath:function(e,t,r){return this.getDrawBridge().drawPath(this.getActualTargetContext(e),t,r)},drawLine:function(e,t,r,n){if(this.__$redirectContextDebug__){var o=Object.create(n);return this.getRedirectContext()&&(o.color=o.strokeColor="#ff0000"),this.getDrawBridge().drawLine(this.getActualTargetContext(e),t,r,o)}return this.getDrawBridge().drawLine(this.getActualTargetContext(e),t,r,n)},drawArrowLine:function(e,t,r,n,o){var i=this.getActualTargetContext(e);if(n){var a=this.createDrawGroup(i),s=this.drawLine(i,t,r,o);this.addToDrawGroup(s,a);var l=r.x-t.x,d=r.y-t.y,u=Math.atan(d/l),c=Math.sign(l)||1,h=(n.width||6)/2,g=n.length||3,p=Math.atan(h/g),f=Math.sqrt(Math.sqr(h)+Math.sqr(g))*c,C=Math.cos(u-p)*f,R=Math.sin(u-p)*f,D=Math.cos(u+p)*f,m=Math.sin(u+p)*f;return s=this.drawLine(i,r,{x:r.x-C,y:r.y-R},o),this.addToDrawGroup(s,a),s=this.drawLine(i,r,{x:r.x-D,y:r.y-m},o),this.addToDrawGroup(s,a),a}return this.drawLine(i,t,r,o)},drawTriangle:function(e,t,r,n,o){return this.getDrawBridge().drawTriangle(this.getActualTargetContext(e),t,r,n,o)},drawRect:function(e,t,r,n){var o={x:Math.min(t.x,r.x),y:Math.min(t.y,r.y)},i={x:Math.max(t.x,r.x),y:Math.max(t.y,r.y)};return this.getDrawBridge().drawRect(this.getActualTargetContext(e),o,i,n)},drawRoundRect:function(e,t,r,n,o){var i={x:Math.min(t.x,r.x),y:Math.min(t.y,r.y)},a={x:Math.max(t.x,r.x),y:Math.max(t.y,r.y)};return this.getDrawBridge().drawRoundRect(this.getActualTargetContext(e),i,a,n,o)},drawCircle:function(e,t,r,n){return this.getDrawBridge().drawCircle(this.getActualTargetContext(e),t,r,n)},drawArc:function(e,t,r,n,o,i,a){return this.getDrawBridge().drawArc(this.getActualTargetContext(e),t,r,n,o,i,a)},drawText:function(e,t,r,n){var o=this.getRichTextDrawer(),i=Kekule.Render.RichTextUtils.strToRichText(r,n);if(this.__$redirectContextDebug__){var a=Object.create(n||{});return this.getRedirectContext()&&(a.color=a.strokeColor="#ff0000"),o.drawEx(this.getActualTargetContext(e),t,i,a)}return o.drawEx(this.getActualTargetContext(e),t,i,n)},drawRichText:function(e,t,r,n){var o=this.getRichTextDrawer();if(this.__$redirectContextDebug__){var i=Object.create(n||{});return this.getRedirectContext()&&(i.color=i.strokeColor="#ff0000"),o.drawEx(this.getActualTargetContext(e),t,r,i)}return o.drawEx(this.getActualTargetContext(e),t,r,n)},measureRichText:function(e,t,r,n){return this.getRichTextDrawer().measure(e,t,r,n)},drawImage:function(e,t,r,n,o,i){var a=this;return this.getDrawBridge().drawImage(this.getActualTargetContext(e),t,r,n,o,i,function(){return a.getActualTargetContext(e)})},drawImageElem:function(e,t,r,n,o){if(t.complete)return this.getDrawBridge().drawImageElem(this.getActualTargetContext(e),t,r,n,o);var i=Kekule.X.Event;if(i){var a=this,s=function(){i.removeListener(t,"load",l)},l=function(){s(),a.update(a.getActualTargetContext(e),[{obj:a.getChemObj()}],Kekule.Render.ObjectUpdateType.MODIFY)};i.addListener(t,"load",l),i.addListener(t,"error",s)}},createDrawGroup:function(e){return this.getDrawBridge().createGroup(this.getActualTargetContext(e))},addToDrawGroup:function(e,t){return this.getDrawBridge().addToGroup(e,t)},removeFromDrawGroup:function(e,t){return this.getDrawBridge().removeFromGroup(e,t)},removeDrawnElem:function(e,t){return this.getDrawBridge().removeDrawnElem(this.getActualTargetContext(e),t)},transformScreenCoordToContext:function(e,t){return this.doTransformScreenCoordToContext(this.getActualTargetContext(e),t)},doTransformScreenCoordToContext:function(e,t){var r=this.getDrawBridge();return r&&r.transformScreenCoordToContext?r.transformScreenCoordToContext(this.getActualTargetContext(e),t):t}}),Kekule.Render.ChemObj2DRenderer=Class.create(Kekule.Render.Base2DRenderer,{CLASS_NAME:"Kekule.Render.ChemObj2DRenderer",_getRenderSortIndex:function(){var e=this.getChemObj();return e&&e.coordStickTarget&&e.getCoordStickTarget()?1:this.tryApplySuper("_getRenderSortIndex")},doEstimateSelfObjBox:function(e,t,r){return Kekule.Render.ObjUtils.getContainerBox(this.getChemObj(),this.getCoordMode(),r)},doEstimateRenderBox:function(e,t,n,o){var i=this.estimateObjBox(e,n,o);if(i){var a=this.prepareTransformParams(e,t,n,i);return r.transform2D(i,a)}return null},doGetAutoBaseCoord:function(e){var t=e.transformParams;if(t){var r=this.getChemObj(),n=r.getAbsBaseCoord?r.getAbsBaseCoord(Kekule.CoordMode.COORD2D):r.getAbsBaseCoord2D?r.getAbsBaseCoord2D():null;if(n)return Kekule.CoordUtils.transform2D(n,t)}return null},doDraw:function(e,t,r){var n=this.getAutoScaleRefObjLength(this.getChemObj(),r.allowCoordBorrow);return r.medianObjRefLength=n||r.defScaleRefLength,this.prepareTransformParams(e,t,r),this.prepareGeneralOptions(e,r),this.tryApplySuper("doDraw",[e,t,r])},prepareGeneralOptions:function(e,t){},prepareTransformParams:function(e,t,r,n){var o;if(r.transformParams)o=r.transformParams;else{r.unitLength||(r.unitLength=1);var i=this.getDrawBridge()._getOverSamplingRatio(e);i&&1!==i&&(r.unitLength*=i);var a=this.generateTransformParams(e,t,r,n);r.transformParams=a,o=a,r.transformParams.zoom&&(r.zoom=r.transformParams.zoom)}var s=Kekule.CoordUtils.calcTransform2DMatrix(o),l=Kekule.CoordUtils.calcInverseTransform2DMatrix(o);r.transformParams.transformMatrix=s,r.transformParams.invTransformMatrix=l,this.getRenderCache(e).transformParams=o,this.getRenderCache(e).transformMatrix=s,this.getRenderCache(e).invTransformMatrix=l;var d=this.calcContextRefLengthes(e,r,s);return r.contextRefLengthes={x:d.contextRefLengthX,y:d.contextRefLengthY,xy:d.contextRefLengthXY},o},calcContextRefLengthes:function(e,t,r){var n=t.defScaleRefLength,i=o.transform2DByMatrix({x:0,y:0},r),a=o.transform2DByMatrix({x:n,y:0},r),s=o.transform2DByMatrix({x:0,y:n},r),l=o.transform2DByMatrix({x:n,y:n},r);return{contextRefLengthX:o.getDistance(a,i),contextRefLengthY:o.getDistance(s,i),contextRefLengthXY:o.getDistance(l,i)/Math.sqrt(2)}},calcPreferedTransformOptions:function(e,t,r,n){var o={};o.allowCoordBorrow=i(r.allowCoordBorrow,!1),o.unitLength=r.unitLength||1,n||(n=this.estimateObjBox(e,r,o.allowCoordBorrow)),n||(n={x1:0,x2:1,y1:0,y2:1});var a={x:(n.x1+n.x2)/2,y:(n.y1+n.y2)/2},s=Kekule.ObjUtils;if(s.isUnset(r.translateX)&&s.isUnset(r.translateY)?t&&(o.translateX=t.x-a.x,o.translateY=t.y-a.y):(o.translateX=r.translateX||0,o.translateY=r.translateY||0),o.zoom=r.zoom||1,r.scale||r.scaleX||r.scaleY)o.scaleX=i(r.scaleX,r.scale,1),o.scaleY=i(r.scaleY,r.scale,1);else{var l,d=(i(r.refDrawLength,this.getAutoScaleRefDrawLength(r))||1)*o.unitLength,u=r.medianObjRefLength;if(Kekule.ObjUtils.isUnset(u)&&(u=r.defScaleRefLength),l=d/u||1,r.autofit||r.autoShrink){var c=this.getDrawBridge().getContextDimension(e);c.x=c.width,c.y=c.height,(c=this.getDrawBridge().transformScreenCoordToContext(e,c)).width=c.x,c.height=c.y;var h=r.autofitContextPadding;h*=2*o.unitLength,n.width=n.x2-n.x1,n.height=n.y2-n.y1;var g=Math.max(c.width-h,0)/(n.width||1),p=Math.max(c.height-h,0)/(n.height||1),f=Math.min(g,p),C=f/l;s.isUnset(r.retainAspect)||r.retainAspect?(o.scaleX=o.scaleY=l,r.autofit?o.zoom*=C:r.autoShrink&&f<l&&(o.zoom*=C)):r.autofit?(o.scaleX=(g<p?1:g/p)*l,o.scaleY=(p<g?1:p/g)*l,o.zoom*=C):r.autoShrink&&(o.zoom*=C,C<1?o.scaleX=o.scaleY=l:g<p?(o.scaleX=l,o.scaleY=l*p/g):(o.scaleY=l,o.scaleX=l*g/p))}else o.scaleX=o.scaleY=l}return s.notUnset(r.rotateAngle)&&(o.rotateAngle=r.rotateAngle),s.isUnset(r.center)?o.center=a:o.center=r.center,o.drawBaseCoord=t||Kekule.CoordUtils.transform2D(a,o),o},generateTransformParams:function(e,t,r,n){var o=this.calcPreferedTransformOptions(e,t,r,n),i=Object.extend({},o);return(o=this.getFinalTransformParams(e,o)).initialTransformOptions=i,o},getFinalTransformParams:function(e,t){var r=Object.create(t);return r.zoom&&(r.scaleX*=r.zoom,r.scaleY*=r.zoom),r.scaleY=-r.scaleY,r.unitLength,r},getRenderFinalTransformParams:function(e){return this.getRenderCache(e).transformParams},getRenderInitialTransformOptions:function(e){var t=this.getRenderFinalTransformParams(e);return t?t.initialTransformOptions:null},doTransformCoordToObj:function(e,t,r){var n=this.getRenderCache(e).invTransformMatrix;return Kekule.CoordUtils.transform2DByMatrix(r,n)},doTransformCoordToContext:function(e,t,r){var n=this.getRenderCache(e).transformMatrix;return Kekule.CoordUtils.transform2DByMatrix(r,n)}}),Kekule.Render.RichTextBased2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.RichTextBased2DRenderer",DRAWN_OBJ_FIELD:"__$drawnObj__",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this.__$alwaysRecalcSize__=!1,this.__$isRecalculatingSize=!1},getDrawnObj:function(e){return this.getExtraProp(e,this.DRAWN_OBJ_FIELD)},setDrawnObj:function(e,t){this.setExtraProp(e,this.DRAWN_OBJ_FIELD,t)},getRichText:function(e,t){return null},extractRichTextDrawOptions:function(e){var t=Object.create(e||{});return t.horizontalAlign=i(t.horizontalAlign,t.textHorizontalAlign),t.verticalAlign=i(t.verticalAlign,t.textVerticalAlign),t.charDirection=i(t.charDirection,t.textCharDirection),t},getDrawTextCoord:function(e,t){return t},doDrawSelf:function(e,t,r){this.tryApplySuper("doDrawSelf",[e,t,r]);var n=this.getChemObj(),o=(r.transformParams,this.getRichText(this.getChemObj(),r));if(!o)return null;t||(t=this.getAutoBaseCoord(r));var i=this.getDrawTextCoord(e,t),a=this.extractRichTextDrawOptions(r);a.fontSize&&(a.fontSize*=a.unitLength||1);var s=this.drawRichText(e,i,o,a),l=s.boundRect,d=this.createRectBoundInfo({x:l.left,y:l.top},{x:l.left+l.width,y:l.top+l.height});return this.basicDrawObjectUpdated(e,n,n,d,Kekule.Render.ObjectUpdateType.ADD),this.getRenderCache(e).drawnObj=s.drawnObj,this.setDrawnObj(e,s.drawnObj),(this.getCanModifyTargetObj()&&n.getNeedRecalcSize&&n.getNeedRecalcSize()||this.__$alwaysRecalcSize__)&&this._autosetObjSize(e,n,d),s.drawnObj},_autosetObjSize:function(e,t,r){if(!this.__$isRecalculatingSize&&t.hasProperty("size2D")&&t.setNeedRecalcSize){this.__$isRecalculatingSize=!0;try{var n=r.coords,o=this.transformCoordToObj(e,t,n[0]),i=this.transformCoordToObj(e,t,n[1]),a=Kekule.CoordUtils.substract(i,o);t.setPropStoreFieldValue("size2D",{x:Math.abs(a.x),y:Math.abs(a.y)}),t.setNeedRecalcSize(!1)}finally{this.__$isRecalculatingSize=!1}}}}),Kekule.Render.TextBlock2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.TextBlock2DRenderer",getRichText:function(e,t){return Kekule.Render.RichTextUtils.strToRichText(e.getText())},doEstimateSelfObjBox:function(e,t,r){return this.getChemObj().getBox2D(r)},getDrawTextCoord:function(e,t){var r=this.getChemObj(),n=r.getExposedContainerBox(),o={x:n.x1,y:n.y2},i={x:n.x2,y:n.y1},a=this.transformCoordToContext(e,r,o),s=this.transformCoordToContext(e,r,i),l=Kekule.CoordUtils.substract(s,a);return{x:t.x-l.x/2,y:t.y-l.y/2}},extractRichTextDrawOptions:function(e){var t=this.tryApplySuper("extractRichTextDrawOptions",[e]);return t.fontSize=i(t.fontSize,t.labelFontSize),t.fontFamily=i(t.fontFamily,t.labelFontFamily),t.color=i(t.color,t.labelColor),t.textBoxXAlignment=Kekule.Render.BoxXAlignment.LEFT,t.textBoxYAlignment=Kekule.Render.BoxYAlignment.TOP,t}}),Kekule.Render.Formula2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.Formula2DRenderer",basicDrawObjectUpdated:function(e,t,r,n,o){return t===this.getChemObj()?this.tryApplySuper("basicDrawObjectUpdated",[e,t.getParent(),t.getParent(),n,o]):this.tryApplySuper("basicDrawObjectUpdated",[e,t,r,n,o])},getRichText:function(e,t){return e.getDisplayRichText(!0,t.displayLabelConfigs,t.partialChargeDecimalsLength,t.chargeMarkType)},doEstimateSelfObjBox:function(e,t,n){var o=this.getChemObj()?this.getChemObj().getParent():null;if(o){var i=o?o.getAbsBaseCoord2D(n):{x:0,y:0};return r.createBox(i,i)}return null},extractRichTextDrawOptions:function(e){var t=this.tryApplySuper("extractRichTextDrawOptions",[e]);return t.fontSize=i(t.fontSize,t.atomFontSize),t.fontFamily=i(t.fontFamily,t.atomFontFamily),t.color=i(t.color,t.labelColor,t.atomColor),t.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER,t.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER,t}}),Kekule.Render.TextBasedChemMarker2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.TextBasedChemMarker2DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r])},doDrawSelf:function(e,t,r){return this.tryApplySuper("doDrawSelf",[e,t,r])},getRichText:function(e,t){var r,n=this.getChemObj();if(n instanceof Kekule.ChemMarker.Charge){var o=n.getValue();if(r=Kekule.Render.ChemDisplayTextUtils.getChargeExDisplayText(o&&o.charge,o&&o.electronicBias,t.partialChargeDecimalsLength,t.displayLabelConfigs.getElectronicBiasMark(),t.chargeMarkType))return Kekule.Render.RichTextUtils.createSection(r,{charDirection:Kekule.Render.TextDirection.LTR})}else if(n instanceof Kekule.ChemMarker.Radical){var i=n.getValue();if(r=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(i,t.distinguishSingletAndTripletRadical))return Kekule.Render.RichTextUtils.createSection(r,{charDirection:Kekule.Render.TextDirection.LTR})}return null},doEstimateSelfObjBox:function(e,t,r){return this.tryApplySuper("doEstimateSelfObjBox",[e,t,r])},extractRichTextDrawOptions:function(e){var t=this.tryApplySuper("extractRichTextDrawOptions",[e]),r=this.getChemObj();return t.fontSize=i(r.getRenderOption("fontSize"),t.chemMarkerFontSize,t.fontSize,t.atomFontSize),t.fontFamily=i(t.fontFamily,t.atomFontFamily),t.color=i(t.color,t.atomColor,t.labelColor),t.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER,t.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER,t}}),Kekule.Render.ImageBlock2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.ImageBlock2DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r])},doDrawSelf:function(e,t,r){this.tryApplySuper("doDrawSelf",[e,t,r]);var n=this.getChemObj();r.transformParams;if(!n||!n.getSrc||!n.getSrc())return null;t||(t=this.getAutoBaseCoord(r));var o,i=n.getExposedContainerBox(),a={x:i.x1,y:i.y2},s={x:i.x2,y:i.y1},l=this.transformCoordToContext(e,n,a),d=this.transformCoordToContext(e,n,s),u=Kekule.CoordUtils.substract(d,l),c={x:t.x-u.x/2,y:t.y-u.y/2},h=n.getCacheImg();return o=h?this.drawImageElem(e,h,c,u,r):this.drawImage(e,n.getSrc(),c,u,r),this.basicDrawObjectUpdated(e,n,n,this.createRectBoundInfo(c,Kekule.CoordUtils.add(c,u)),Kekule.Render.ObjectUpdateType.ADD),o}}),Kekule.Render.UnbondedElectronSetRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.UnbondedElectronSetRenderer",_extractActualDrawOptions:function(e){var t=Object.create(e),r=this.getChemObj();return t.fontSize=i(r.getRenderOption("fontSize"),t.chargeMarkFontSize,t.fontSize,t.atomFontSize),t.color=i(t.color,t.atomColor,t.labelColor),t.strokeColor=t.color,t.fillColor=t.color,t.electronGap=t.fontSize/3*(t.unitLength||1)*(t.zoom||1),t.electronRadius=t.fontSize/12*(t.unitLength||1)*(t.zoom||1),t},_drawSingleElectron:function(e,t,r,n){return this.drawCircle(e,t,r,n)},_drawElectrons:function(e,t,r,n,i){var a=o.substract(r,n),s=o.getDistance(a);if(0===s)var l=0,d=1;else l=a.x/s,d=a.y/s;for(var u,c,h=i.electronGap,g=i.electronRadius,p={x:h*d,y:-h*l},f=(t-1)/2,C=o.substract(r,o.multiply(p,f)),R=[],D=t>1?this.createDrawGroup(e):null,m=0;m<t;++m)R.push(C),u=this._drawSingleElectron(e,C,g,i),D&&this.addToDrawGroup(u,D),C=o.add(C,p);if(R.length<=1)c=this.createCircleBoundInfo(R[0],g);else{var y=o.multiply(p,2*g/h),T=o.substract(R[0],y),x=o.add(R[t-1],y);c=this.createLineBoundInfo(T,x,g)}return{electronCoords:R,drawnElem:D||u,electronRadius:g,boundInfo:c}},_doGetParentCoord:function(e,t,r){var n=r.transformParams;if(n){var i=t,a=i.getAbsBaseCoord?i.getAbsBaseCoord(Kekule.CoordMode.COORD2D):i.getAbsBaseCoord2D?i.getAbsBaseCoord2D():null;if(a)return o.transform2D(a,n)}return null},doDrawSelf:function(e,t,r){this.tryApplySuper("doDrawSelf",[e,t,r]);var n=this._extractActualDrawOptions(r),o=this.getChemObj(),i=o.getParent();r.transformParams;if(!o||!i||!o.getElectronCount||(o.getElectronCount()||0)<=0)return null;t||(t=this.getAutoBaseCoord(r));var a=this._doGetParentCoord(e,i,r);if(!t||!a)return null;var s=this._drawElectrons(e,o.getElectronCount(),t,a,n);s.electronCoords,s.electronRadius;return this.basicDrawObjectUpdated(e,o,i,s.boundInfo,Kekule.Render.ObjectUpdateType.ADD),s.drawnElem}}),Kekule.Render.Ctab2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.Ctab2DRenderer",DRAW_ELEM_FIELD:"__$drawElem__",TRANSFORM_COORD_FIELD:"__$transCoord2D__",TRANSFORM_MATRIX_FIELD:"__$transMatrix__",RENDERED_OBJS_FIELD:"__$renderedObjs__",INV_TRANSFORM_MATRIX_FIELD:"__$inverseTransMatrix__",CHILD_TRANSFORM_MATRIX_FIELD:"__$childTransMatrix__",_getRenderSortIndex:function(){for(var e=this.getChemObj().getExposedNodes(),t=0,r=e.length;t<r;++t){var n=e[t];if(n&&n.coordStickTarget&&n.getCoordStickTarget())return 1}return this.tryApplySuper("_getRenderSortIndex")},doEstimateSelfObjBox:function(e,t,r){return this.getChemObj().getExposedContainerBox2D(r)},getObjDrawElem:function(e,t){return this.getExtraProp2(e,t,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(e,t,r){this.setExtraProp2(e,t,this.DRAW_ELEM_FIELD,r)},getRenderedObjs:function(e){return this.getExtraProp(e,this.RENDERED_OBJS_FIELD)},addRenderedObj:function(e,t){var r=this.getRenderedObjs(e);r?Kekule.ArrayUtils.pushUnique(r,t):(r=[t],this.setExtraProp(e,this.RENDERED_OBJS_FIELD,r))},removeRenderedObj:function(e,t){var r=this.getRenderedObjs(e);r&&Kekule.ArrayUtils.remove(r,t)},clearRenderedObj:function(e){this.setExtraProp(e,this.RENDERED_OBJS_FIELD,null)},prepareGeneralOptions:function(e,t){return this.tryApplySuper("prepareGeneralOptions",[e,t])},doPrepare:function(e,t,r,n){this.tryApplySuper("doPrepare",[e,t,r,n]),this.doPrepareLayout(e,t,r,n)},doPrepareLayout:function(e,t,r,n){},handleNodeSpecifiedRenderOptions:function(e,t){var r=(e.getOverriddenRenderOptions?e.getOverriddenRenderOptions():null)||{},n=Object.create(t);return n=Object.extend(n,r)},handleConnectorSpecifiedRenderOptions:function(e,t){var r=(e.getOverriddenRenderOptions?e.getOverriddenRenderOptions():null)||{},n=Object.create(t||null);return n=Object.extend(n,r)},isChemObjRenderedBySelf:function(e,t){var r=this.getRenderedObjs(e);return this.tryApplySuper("isChemObjRenderedBySelf",[e,t])||r&&r.indexOf(t)>=0||this.getChemObj().hasChildObj(t)&&(!t.isExposed||t.isExposed())},isChemObjRenderedDirectlyBySelf:function(e,t){var r=this.getRenderedObjs(e);return this.tryApplySuper("isChemObjRenderedDirectlyBySelf",[e,t])||r&&r.indexOf(t)>=0},doDrawSelf:function(e,t,r){this.tryApplySuper("doDrawSelf",[e,t,r]);var n=this.getChemObj();this._ctab=n;var o=r.transformParams;return this.getRenderCache(e).transformOptions=o,this.transformCtabCoords2DToContext(e,n,o),this.doPrepare(e,n,t,r),this.getRenderCache(e).appliedOptions=r,this.doDrawCore(e,n,r,o)},doRedraw:function(e){var t=this.getRenderCache(e);return this.doDrawCore(e,this.getChemObj(),t.appliedOptions,t.transformOptions)},doDrawCore:function(e,t,r,n){this.clearRenderedObj(e);var o=this.createDrawGroup(e);return this.doDrawConnectors(e,o,t,r,n),this.doDrawNodes(e,o,t,r,n),this.setObjDrawElem(e,t,o),o},doUpdateSelf:function(e,t,r){if(this.canModifyGraphic(e)){var n=!1,o=Kekule.Render.ObjectUpdateType;switch(r){case o.ADD:n=this.doAddNew(e,t);break;case o.MODIFY:n=this.doModify(e,t);break;case o.REMOVE:n=this.doRemove(e,Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(t));break;default:return this.tryApplySuper("doUpdateSelf",[e,t,r])}return n}return this.tryApplySuper("doUpdateSelf",[e,t,r])},doAddNew:function(e,t){return!!this.canModifyGraphic()&&this.doModify(e,t)},doModify:function(e,t){if(this.canModifyGraphic()){var r=this._extractObjsOfUpdateObjDetails(t);this.remove(e,r);var n=this.getChemObj(),o=this.getObjDrawElem(e,n),i=this.getRenderCache(e),a=i.appliedOptions;r.indexOf(n)>=0&&this.draw(e,i.baseCoord,a);for(var s=0,l=r.length;s<l;++s){var d=r[s];if(!d.isExposed||d.isExposed())if(n.hasConnector(d)){var u=this.handleConnectorSpecifiedRenderOptions(d,a);this.doDrawConnector(e,o,d,this.getChemObj(),u,i.transformParams||{})}else if(n.hasNode(d)){u=this.handleNodeSpecifiedRenderOptions(d,a);this.doDrawNode(e,o,d,this.getChemObj(),u,i.transformParams)}}return!0}return!1},doRemove:function(e,t){if(this.canModifyGraphic()){for(var r=Kekule.ArrayUtils.toArray(t),n=0,o=r.length;n<o;++n){var i=r[n],a=this.getObjDrawElem(e,i);if(a){var s=this.getObjDrawElem(e,this.getChemObj());this.removeFromDrawGroup(a,s),this.removeDrawnElem(e,a)}this.removeRenderedObj(e,i),this.removeExtraProp2(e,i),this.basicDrawObjectUpdated(e,i,this.getChemObj(),null,Kekule.Render.ObjectUpdateType.REMOVE)}return!0}return!1},getCoordTransformOptions:function(e){return this.getRenderCache(e).transformOptions},transformCtabCoords2DToContext:function(e,t,r){var n=r.allowCoordBorrow,o=Object.extend({},r);o.centerX=0,o.centerY=0;var i=r.transformMatrix;this.setExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD,i);var a=i;this.setExtraProp2(e,t,this.CHILD_TRANSFORM_MATRIX_FIELD,i);var s=r.invTransformMatrix;this.setExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD,s);for(var l=0,d=t.getNodeCount();l<d;++l){var u=t.getNodeAt(l);this.transformObjCoord2DToContext(e,u,i,a,n)}},transformObjCoord2DToContext:function(e,t,r,n,o){var i;if(t&&t.getAbsBaseCoord2D){var a=t.getAbsBaseCoord2D(o);if(a){var s=Kekule.CoordUtils.transform2DByMatrix(a,r);this.setTransformedCoord2D(e,t,s),i=s}if(t.getNodes)for(var l=0,d=t.getNodeCount();l<d;++l)this.transformObjCoord2DToContext(e,t.getNodeAt(l),n,n,o)}return i},getTransformedCoord2D:function(e,t,r){Kekule.ObjUtils.isUnset(r)&&(r=this.getRenderCache(e).options.transformParams.allowCoordBorrow);var n=t instanceof Kekule.BaseStructureNode,o=t.getParent(),i=n&&o&&o instanceof Kekule.BaseStructureConnector,a=n&&!i&&this.getExtraProp2(e,t,this.TRANSFORM_COORD_FIELD);if(!a){var s=this.getChemObj(),l=this.getExtraProp2(e,s,this.TRANSFORM_MATRIX_FIELD),d=this.getExtraProp2(e,s,this.CHILD_TRANSFORM_MATRIX_FIELD);a=s&&(s.hasNode(t,!1)||s.hasConnector(t,!1))?this.transformObjCoord2DToContext(e,t,l,d,r):this.transformObjCoord2DToContext(e,t,d,d,r)}return a},setTransformedCoord2D:function(e,t,r){this.setExtraProp2(e,t,this.TRANSFORM_COORD_FIELD,r)},doTransformCoordToObj:function(e,t,r){var n=this.getExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD);return n?Kekule.CoordUtils.transform2DByMatrix(r,n):this.tryApplySuper("doTransformCoordToObj",[e,t,r])},doTransformCoordToContext:function(e,t,r){var n=this.getExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD);return n?Kekule.CoordUtils.transform2DByMatrix(r,n):this.tryApplySuper("doTransformCoordToContext",[e,t,r])},doDrawNodes:function(e,t,r,n,o){for(var i=r.getExposedNodes(),a=0,s=i.length;a<s;++a){var l=i[a],d=this.handleNodeSpecifiedRenderOptions(l,n);this.doDrawNode(e,t,l,r,d,o)}},doDrawNode:function(e,t,r,n,o,i){},doDrawConnectors:function(e,t,r,n,o){for(var i=r.getExposedConnectors(),a=0,s=i.length;a<s;++a){var l=i[a],d=this.handleConnectorSpecifiedRenderOptions(l,n);this.doDrawConnector(e,t,l,r,d,o)}},doDrawConnector:function(e,t,r,n,o,i){var a,s,l,d,u=r.getConnectedExposedObjs(),c=u.length;if(c<2)return null;for(var h,g=c>2?this.createDrawGroup(e):null,p=c>2?[]:null,f=o,C=0;C<c;++C)if(s=u[C],this.getTransformedCoord2D(e,s,i.allowCoordBorrow))for(var R=C+1;R<c;++R)if(l=u[R],this.getTransformedCoord2D(e,l,i.allowCoordBorrow)&&(h=this.doDrawConnectorShape(e,r,[s,l],f,i))){(d=h.element)&&g&&this.addToDrawGroup(d,g);var D=h.boundInfo;p&&D&&p.push(D)}return(a=g||d)&&t&&this.addToDrawGroup(a,t),a?this.setObjDrawElem(e,r,a):this.setObjDrawElem(e,r,null),this.addRenderedObj(e,r),(D||p)&&this.basicDrawObjectUpdated(e,r,n,p||D,Kekule.Render.ObjectUpdateType.ADD),a},doDrawConnectorShape:function(e,t,r,n,o){}}),Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.Render.Ctab2DRenderer),Kekule.Render.ChemCtab2DRenderer=Class.create(Kekule.Render.Ctab2DRenderer,{CLASS_NAME:"Kekule.Render.ChemCtab2DRenderer",OBJ_NEED_LABEL_FIELD:"__$needDrawLabel__",OBJ_NEED_DOT_FIELD:"__$needDrawDot__",getObjNeedDrawLabel:function(e,t){var r=this.getExtraProp2(e,t,this.OBJ_NEED_LABEL_FIELD);if(Kekule.ObjUtils.isUnset(r)){var n=this.getRenderCache(e).appliedOptions;r=!(t instanceof Kekule.ChemStructureConnector)&&this._needNodeDrawLabel(t,n),this.setObjNeedDrawLabel(e,t,r)}return r},setObjNeedDrawLabel:function(e,t,r){this.setExtraProp2(e,t,this.OBJ_NEED_LABEL_FIELD,r)},getObjNeedDrawDot:function(e,t){var r=this.getRenderCache(e).appliedOptions;return!(t instanceof Kekule.ChemStructureConnector)&&this._needNodeDrawDot(e,t,r)},doPrepare:function(e,t,r,n){n.fontSize||(n.fontSize=n.atomFontSize),n.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER,n.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER,this.tryApplySuper("doPrepare",[e,t,r,n])},doPrepareLayout:function(e,t,r,n){this.tryApplySuper("doPrepareLayout",[e,t,r,n]);for(var o=t.getExposedNodes(),i=0,a=o.length;i<a;++i){var s=o[i],l=this._needNodeDrawLabel(s,n);this.setObjNeedDrawLabel(e,s,l)}},handleNodeSpecifiedRenderOptions:function(e,t){var r=this.tryApplySuper("handleNodeSpecifiedRenderOptions",[e,t]);return!r.color&&r.atomColor&&(r.color=r.atomColor),!r.fontFamily&&r.atomFontFamily&&(r.fontFamily=r.atomFontFamily),!r.fontSize&&r.atomFontSize&&(r.fontSize=r.atomFontSize),r},handleConnectorSpecifiedRenderOptions:function(e,t){var r=this.tryApplySuper("handleConnectorSpecifiedRenderOptions",[e,t]);return!r.color&&r.bondColor&&(r.color=r.bondColor),r},doDrawNode:function(e,t,r,n,o,i){var a,s,l=this.getTransformedCoord2D(e,r,i.allowCoordBorrow),d=o,u=r.getAtomicNumber?r.getAtomicNumber():0,c=r.getOverriddenRenderOptions()||{},h=c.color||c.atomColor;if(h)d.color=h;else if(d.useAtomSpecifiedColor){var g;if(u<=0){var p=r.getClassLocalName();g=Kekule.Render.RenderColorUtils.getColor(p,this.getRendererType())}else g=Kekule.Render.RenderColorUtils.getColor(u,this.getRendererType());d.color=g}r.getCharge()||r.getRadical();var f=r.hasExplicitCharge&&r.hasExplicitCharge()&&!r.fetchChargeMarker(!1),C=r.getRadical()&&!r.fetchRadicalMarker(!1),R=!1;if(this.getObjNeedDrawLabel(e,r)){R=!0;var D=this._getNodeHydrogenDisplayLevel(r,d);D===Kekule.Render.HydrogenDisplayLevel.LABELED&&(D=Kekule.Render.HydrogenDisplayLevel.ALL);var m=!(!f&&!C),y=r.getDisplayRichText(D,m,d.displayLabelConfigs,d.partialChargeDecimalsLength,d.chargeMarkType,d.distinguishSingletAndTripletRadical),T=d.charDirection?d.charDirection:this._decideNodeLabelCharDirection(e,r);d.fontSize*=d.unitLength;var x=Object.create(d);x.charDirection=T;var O=(A=this.drawRichText(e,l,y,x)).drawnObj,S=A.boundRect;s=this.createRectBoundInfo({x:S.left,y:S.top},{x:S.left+S.width,y:S.top+S.height}),a=O}else{var k,v,A;if(this.getObjNeedDrawDot(e,r)&&Kekule.ObjUtils.isUnset(d.atomRadius)&&(d.atomRadius=d.allenCenterAtomRadius),d.atomRadius){var b=d.atomRadius*d.unitLength;d.strokeColor=d.color,d.fillColor=d.color,k=this.drawCircle(e,l,b,d),s=this.createCircleBoundInfo(l,b)}else s=this.createPointBoundInfo(l);if(f||C)(A=this.doDrawElectronStateMark(e,t,r,d.chargeMarkType,d.partialChargeDecimalsLength,d.distinguishSingletAndTripletRadical,d.fontFamily,d.chargeMarkFontSize*d.unitLength,d.chargeMarkMargin*d.unitLength,d.chargeMarkCircleWidth*d.unitLength,d.color,d.opacity,d.zoom||1))&&(v=A.drawnObj);k&&v?(a=this.createDrawGroup(e),this.addToDrawGroup(a,k),this.addToDrawGroup(a,v)):a=k||v}if(r.getUnplacedMarkers(this.getCoordMode()).length>=0){var E,_=d.chemMarkerMargin;if(R){_+=this._getNodeFontSize(e,r)*(i.zoom||1)*d.unitLength*1/2-_/2;var L=Kekule.Render.TextDirection,K=(L.LTR,L.RTL,L.TTB,L.BTT,T===L.LTR?{x:1,y:0}:T===L.RTL?{x:-1,y:0}:T===L.TTB?{x:0,y:1}:T===L.BTT?{x:0,y:-1}:{x:0,y:0}),w={x:K.x*i.scaleX,y:K.y*i.scaleY};E=w.x>0?0:w.x<0?Math.PI:w.y>0?Math.PI/2:w.y<0?3*Math.PI/2:null}var B=_/d.defBondLength*d.medianObjRefLength;this.doAdjustChemPropMarkerPos(r,B,i.allowCoordBorrow,Kekule.ObjUtils.notUnset(E)?[E]:[])}return a?(this.setObjDrawElem(e,r,a),t&&this.addToDrawGroup(a,t)):this.setObjDrawElem(e,r,null),this.addRenderedObj(e,r),this.basicDrawObjectUpdated(e,r,n,s,Kekule.Render.ObjectUpdateType.ADD),a},_getNodeFontSize:function(e,t,r){r||(r=this.getRenderCache(e).appliedOptions||this.getRenderCache(e).options);var n=Kekule.Render.RenderOptionUtils.getNodeLabelDrawOptions(t.getOverriddenRenderOptions())||{};return i(n.fontSize,r.fontSize,r.atomFontSize)},_getNodeHydrogenDisplayLevel:function(e,t){var r=e.getOverriddenRenderOptions(),n=Kekule.Render.RenderOptionUtils.getHydrogenDisplayLevel(r);return Kekule.ObjUtils.notUnset(n)?n:t.hydrogenDisplayLevel},_needNodeDrawDot:function(e,t,r){t.getOverriddenRenderOptions();if(t instanceof Kekule.Atom){if(t.getAtomicNumber()!==Kekule.Render.DEF_ATOM_ATOMIC_NUM)return!1;if(this.getObjNeedDrawLabel(e,t))return!1;if(2===t.getLinkedBonds().length){var o=t.getLinkedMultipleBonds();if(2===o.length&&o[0].getBondOrder()===o[1].getBondOrder()){var i=o[0].getBondOrder();return i>=n.DOUBLE&&i<n.EXPLICIT_AROMATIC}}return!1}return!1},_needNodeDrawLabel:function(e,t){var r=Kekule.Render.RenderOptionUtils,n=Kekule.Render.NodeLabelDisplayMode,o=e.getOverriddenRenderOptions(),i=r.getNodeDisplayMode(o)||t.nodeDisplayMode;if(!(e instanceof Kekule.ChemStructureNode))return!1;if(i===n.HIDDEN)return!1;if(i===n.SHOWN)return!0;if(t.moleculeDisplayType===Kekule.Render.MoleculeDisplayType.CONDENSED)return!0;if(e.getLinkedConnectors().length<=0)return!0;if(e instanceof Kekule.Atom&&e.getAtomicNumber()===Kekule.Render.DEF_ATOM_ATOMIC_NUM&&!e.getMassNumber()){if(e.getRenderOption("customLabel"))return!0;var a=this._getNodeHydrogenDisplayLevel(e,t),s=Kekule.Render.HydrogenDisplayLevel;if(a===s.ALL)return!0;if(a===s.UNMATCHED_EXPLICIT){var l=e.getExplicitHydrogenCount();return Kekule.ObjUtils.notUnset(l)&&e.getImplicitHydrogenCount()!==l}return Kekule.ObjUtils.notUnset(e.getExplicitHydrogenCount())}return!0},_isNodeHasConnectorToDirection:function(e,r,n){Kekule.ObjUtils.isUnset(n)&&(n=.2);for(var o=0,i=e.length;o<i;++o){var a=e[o];if(r===t.LTR&&a.x>n)return!0;if(r===t.RTL&&a.x<-n)return!0;if(r===t.TTB&&a.y>n)return!0;if(r===t.BTT&&a.y<-n)return!0}return!1},_calcConnectorVectorWeight:function(e){for(var t=0,r=0,n=function(e,t){return 0==t?100:Math.min(100,Math.pow(e/t,2))},o=0,i=e.length;o<i;++o)t+=e[o].x*n(e[o].x,e[o].y)*1,r+=e[o].y*n(e[o].y,e[o].x)*1;return{x:t,y:r}},_calcConnectorVectorOfNode:function(e,t){for(var r={x:0,y:0},n=this._getStandardizedLinkedObjRelCoords(e,t,null),o=0,i=n.length;o<i;++o)r.x+=n[o].x,r.y+=n[o].y;return r.x===r.y===0&&(r={x:1,y:0}),r},_calcVectorAxisDirection:function(e){return Math.abs(e.x)>=Math.abs(e.y)?e.x>0?t.LTR:t.RTL:e.y>0?t.TTB:t.BTT},_decideNodeLabelCharDirection:function(e,t){for(var r=this._getStandardizedLinkedObjRelCoords(e,t,null),n=Kekule.Render.TextDirection,o=[n.LTR,n.RTL,n.TTB,n.BTT],i=0,a=o.length;i<a;++i)if(!this._isNodeHasConnectorToDirection(r,o[i]))return o[i];var s=this._calcConnectorVectorWeight(r);return Math.abs(s.x)>Math.abs(s.y)?s.x<=0?n.LTR:n.RTL:s.y<=0?n.TTB:n.BTT},_calcConnectorAnglesOfNode:function(e,t){for(var r=[],n=this._getStandardizedLinkedObjRelCoords(e,t,null),o=0,i=n.length;o<i;++o){var a=n[o],s=Math.atan2(a.y,a.x);s<0&&(s=2*Math.PI+s),r.push(s)}return r.sort(),r},_getMostEmptyDirectionAngleOfNode:function(e,t){var r,n=this._calcConnectorAnglesOfNode(e,t),o=n.length;if(0===o)r=0;else if(1===o)r=-n[0];else{for(var i=0,a=0,s=0;s<o;++s){var l=n[s],d=n[(s+1)%o]-l;d<0&&(d+=2*Math.PI),d>i&&(i=d,a=s)}r=n[a]+i/2}return r},doAutoAdjustAttachedMarkerPos:function(e,t,r,n,o){t&&!t.getCoordOfMode(this.getCoordMode())&&e.autoSetMarker2DPos(t,r,n,o)},doAdjustChemPropMarkerPos:function(e,t,r,n){e.beginUpdate();try{var o=e.getMarkerOfType(Kekule.ChemMarker.Charge);this.doAutoAdjustAttachedMarkerPos(e,o,t,r,n);var i=e.getMarkerOfType(Kekule.ChemMarker.Radical);this.doAutoAdjustAttachedMarkerPos(e,i,t,r,n);for(var a=e.getUnplacedMarkers(this.getCoordMode()),s=0,l=a.length;s<l;++s)this.doAutoAdjustAttachedMarkerPos(e,a[s],t,r,n)}finally{e.endUpdate()}},doDrawElectronStateMark:function(e,t,r,n,o,i,a,s,l,d,u,c,h){var g=r.getCharge(),p=r.getRadical(),f="";if(!o||Math.abs(g)>Math.pow(10,-o)/2){Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND;var C=n===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND;if(1===g)f=C?"⊕":"+";else if(-1===g)f=C?"⊖":"−";else{f=(o?Kekule.NumUtils.toDecimals(Math.abs(g),o):Math.abs(g).toString())+(g>0?"+":"−")}}if(p&&(f+=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(p,i)),!f)return null;var R=this.getTransformedCoord2D(e,r),D=this._getMostEmptyDirectionAngleOfNode(e,r),m=l/1,y={x:Math.cos(D)*m,y:Math.sin(D)*m};y=Kekule.CoordUtils.add(R,y);var T,x,O=Kekule.Render.BoxXAlignment,S=Kekule.Render.BoxYAlignment;return T=O.CENTER,x=S.CENTER,this.drawText(e,y,f,{fontFamily:a,fontSize:s,color:u,opacity:c,textBoxXAlignment:T,textBoxYAlignment:x,zoom:h||1})},doDrawConnectorShape:function(e,t,r,n,o){var i,a=Kekule.CoordUtils,s=r[0],l=r[1],d=this.getTransformedCoord2D(e,s,o.allowCoordBorrow),u=this.getTransformedCoord2D(e,l,o.allowCoordBorrow),c={x:d.x,y:d.y},h={x:u.x,y:u.y},g=(r=[s,l],[c,h]),p=a.getDistance(c,h),f=0,C=n.unitLength||1,R=Math.sqrt(Math.sqr(h.x-c.x)+Math.sqr(h.y-c.y)),D=[],m=n.bondLengthScaleRatio;if(Kekule.ObjUtils.notUnset(m)){var y=a.substract(h,c);!0,i=m>0?0:1;var T=1-Math.abs(m||1),x=1===i?-1:1;D[i]=a.multiply(y,x*T)}if(this.getObjNeedDrawLabel(e,s)||this.getObjNeedDrawLabel(e,l)){var O,S,k,v=n.atomLabelBoxExpandRatio,A=h.x-c.x,b=h.y-c.y,E=A>=0?1:-1,_=b>=0?1:-1,L=0===A;if(!L)var K=Math.abs(b/A);k=Math.abs(A)>=Math.abs(b);for(var w=0,B=r.length;w<B;++w){var I=r[w],M=g[w],U=null;if(this.getObjNeedDrawLabel(e,I))if(O=S=this._getNodeFontSize(e,I)*(o.zoom||1)*C*v/2,U=k?{x:O*E,y:O*K*_}:L?{x:0,y:S*_}:{x:S/K*E,y:S*_}){var P=D[w];P&&Math.abs(m)<=1?(Math.abs(U.x)>Math.abs(P.x)||Math.abs(U.y)>Math.abs(P.y))&&(D[w]=U):D[w]=U}E*=-1,_*=-1}}for(w=0,B=g.length;w<B;++w){M=g[w];if(U=D[w]){f+=a.getDistance(U,{x:0,y:0});var j=a.add(M,U);M.x=j.x,M.y=j.y}}if(f>=p)return null;var N=(n.bondLineWidth||n.strokeWidth||1)*(n.unitLength||1);n.strokeWidth=N;var F,G=n.renderType,z=Kekule.Render.ConnectorDrawUtils.getPossibleConnectorRenderTypes(t);return(Kekule.ObjUtils.isUnset(G)||z.indexOf(G)<0)&&(G=z[0]),this.isLineBasedConnector(G)?F=this.doDrawLineBasedConnector(e,G,s,l,c,h,R,n):this.isTriangleBasedConnector(G)?F=this.doDrawTriangleBasedConnector(e,G,s,l,c,h,R,n):this.isTriangleHashBasedConnector(G)?F=this.doDrawTriangleHashBasedConnector(e,G,s,l,c,h,R,n):this.isRectangleBasedConnector(G)?F=this.doDrawRectangleBasedConnector(e,G,s,l,c,h,R,n):this.isWavyBasedConnector(G)&&(F=this.doDrawWavyBasedConnector(e,G,s,l,c,h,R,n)),F},_lineBasedConnectorTypes:[e.SINGLE,e.DOUBLE,e.TRIPLE,e.QUAD,e.SCISSORS_DOUBLE,e.BOLD,e.BOLD_DOUBLE,e.BOLD_TRIPLE,e.DASHED,e.DASHED_DOUBLE,e.DASHED_TRIPLE,e.SOLID_DASH,e.BOLD_DASH,e.ARROWED],_triangleBasedConnectorTypes:[e.WEDGED_SOLID,e.WEDGED_SOLID_INV,e.WEDGED_HOLLOW,e.WEDGED_HOLLOW_INV],_triangleHashBasedConnectorTypes:[e.WEDGED_HASHED,e.WEDGED_HASHED_INV,e.HASHED],_rectangleBasedConnectorTypes:[e.WEDGED_SOLID_BOTH,e.WEDGED_HOLLOW_BOTH],isLineBasedConnector:function(e){return this._lineBasedConnectorTypes.indexOf(e)>=0},isTriangleBasedConnector:function(e){return this._triangleBasedConnectorTypes.indexOf(e)>=0},isTriangleHashBasedConnector:function(e){return this._triangleHashBasedConnectorTypes.indexOf(e)>=0},isRectangleBasedConnector:function(e){return this._rectangleBasedConnectorTypes.indexOf(e)>=0},isWavyBasedConnector:function(t){return e.WAVY},doDrawLineBasedConnector:function(t,r,n,o,i,a,s,l){var d=[],u={isBold:!1,isDash:!1},c={isBold:!0,isDash:!1},h={isBold:!1,isDash:!0};switch(r){case e.DOUBLE:case e.SCISSORS_DOUBLE:for(var g=0;g<2;++g,d.push(u));break;case e.TRIPLE:for(g=0;g<3;++g,d.push(u));break;case e.QUAD:for(g=0;g<4;++g,d.push(u));break;case e.BOLD:d.push(c);break;case e.BOLD_DOUBLE:d.push(c),d.push(u);break;case e.BOLD_TRIPLE:d.push(c);for(g=0;g<2;++g,d.push(u));break;case e.BOLD_QUAD:d.push(c);for(g=0;g<3;++g,d.push(u));break;case e.DASHED:d.push(h);break;case e.DASHED_DOUBLE:for(g=0;g<2;++g,d.push(h));break;case e.DASHED_TRIPLE:for(g=0;g<3;++g,d.push(h));break;case e.SOLID_DASH:d.push(u),d.push(h);break;case e.BOLD_DASH:d.push(c),d.push(h);break;case e.ARROWED:u.isArrow=!0,d.push(u);break;case e.SINGLE:default:d.push(u)}var p=r===e.SCISSORS_DOUBLE;return this.doDrawSymmetryLineConnector(t,n,o,i,a,s,d,p,l)},doDrawSymmetryLineConnector:function(e,t,r,n,o,i,a,s,l){var d=a.length,u=null,c=null;if(1===d){var h=l.strokeWidth;a[0].isBold&&(h*=l.boldBondLineWidthRatio);var g=null;a[0].isArrow&&(g={width:l.bondArrowWidth*l.unitLength,length:l.bondArrowLength*l.unitLength});var p=Object.create(l);p.strokeWidth=h,p.strokeColor=Kekule.Render.RenderOptionUtils.getColor(l),p.strokeDash=a[0].isDash,p.lineCap=l.bondLineCap,p.lineJoin=l.bondLineJoin;c=this.drawArrowLine(e,n,o,g,p);var f=this.createLineBoundInfo(n,o,h)}else if(d>1){u=this.createDrawGroup(e);var C=l.multipleBondSpacingAbs?l.multipleBondSpacingAbs:l.multipleBondSpacingRatio*i;l.multipleBondMaxAbsSpacing&&(C=Math.min(C,l.multipleBondMaxAbsSpacing)),C*=l.unitLength;var R=o.x-n.x,D=o.y-n.y,m=Math.sqrt(Math.sqr(R)+Math.sqr(D)),y=D/m,T=R/m,x=[],O=1;1&d||(O=s?0:Kekule.ObjUtils.isUnset(a.bondAlign)?this._decideEvenBondAlign(e,t,r):a.bondAlign);for(var S=0;S<d;++S)if(Kekule.ObjUtils.notUnset(a[S].offsetAdjust))x.push(a[S].offsetAdjust);else if(0===S&&0!==O)x.push(0);else{var k=1&S?1:-1;if(0!==O)var v=O*k*(S+1>>1);else v=(1*(S>>1)+.5)*k;x.push(v)}var A=C,b=0,E={x:0,y:0},_={x:0,y:0},L=[];for(S=0;S<d;++S){var K=Object.create(l),w=A*y,B=A*T,I={x:n.x-w*x[S],y:n.y+B*x[S]},M={x:o.x-w*x[S],y:o.y+B*x[S]};E=Kekule.CoordUtils.add(E,I),_=Kekule.CoordUtils.add(_,M);g=null;a[S].isArrow&&(g={width:l.bondArrowWidth*l.unitLength,length:l.bondArrowLength*l.unitLength});h=l.strokeWidth;a[S].isBold&&(h*=l.boldBondLineWidthRatio),K.strokeColor=l.color,K.strokeDash=a[S].isDash,K.lineCap=l.bondLineCap,K.lineJoin=l.bondLineJoin,L.push({coord1:I,coord2:M,arrowParams:g,drawOptions:K}),0!==S&&S!==d-1||(b+=h/2),A=a[S].isBold?C+Math.floor(h/2):C}if(s)for(S=0;S<d;++S){var U=L[S],P=L[d-S-1];c=this.drawArrowLine(e,U.coord1,P.coord2,U.arrowParams,U.drawOptions);this.addToDrawGroup(c,u)}else for(S=0;S<d;++S){var j=L[S];c=this.drawArrowLine(e,j.coord1,j.coord2,j.arrowParams,j.drawOptions);this.addToDrawGroup(c,u)}E=Kekule.CoordUtils.divide(E,d),_=Kekule.CoordUtils.divide(_,d);var N=C*Math.abs(x[x.length-1]-x[0])+b;f=this.createLineBoundInfo(E,_,N)}return{element:u||c,boundInfo:f}},_getStandardizedLinkedObjRelCoords:function(e,t,r){for(var n=[],o=this.getTransformedCoord2D(e,t),i=t.getLinkedExposedObjs(),a=0,s=i.length;a<s;++a){var l=i[a];if(l!==r){var d=this.getTransformedCoord2D(e,l),u=Kekule.CoordUtils.substract(d,o);u=Kekule.CoordUtils.standardize(u),n.push(u)}}return n},_decideEvenBondAlign:function(e,t,r){var n=Kekule.CoordUtils.substract(this.getTransformedCoord2D(e,r),this.getTransformedCoord2D(e,t));n=Kekule.CoordUtils.standardize(n);for(var o=this._getStandardizedLinkedObjRelCoords(e,t,r),i=this._getStandardizedLinkedObjRelCoords(e,r,t),a=0,s={x:0,y:0},l=0,d=o.length;l<d;++l)a+=this._calcSinglePointAlign(o[l],n),s.x+=o[l].x,s.y+=o[l].y;for(l=0,d=i.length;l<d;++l)a+=this._calcSinglePointAlign(i[l],n),s.x+=i[l].x,s.y+=i[l].y;return 0!==a?Math.sign(a):this._calcSinglePointAlign(s,n)},_calcSinglePointAlign:function(e,t){var r;if(Math.abs(t.x)<1e-4)return r=Math.abs(e.x)<1e-4?0:-Math.sign(e.x)*Math.sign(t.y);var n=t.y*e.x/t.x,o=e.y-n;return r=o>1e-4?1:o<-1e-4?-1:0,r*=Math.sign(t.x)},doDrawTriangleBasedConnector:function(t,r,n,o,i,a,s,l){var d=r===e.WEDGED_SOLID||r===e.WEDGED_SOLID_INV,u=r===e.WEDGED_SOLID_INV||r===e.WEDGED_HOLLOW_INV?[a,i]:[i,a],c=l.bondWedgeWidth*l.unitLength,h=this._calcTriangleBaselineCoords(u[0],u[1],c),g=Object.create(l);g.strokeColor=l.color,g.fillColor=d?l.color:null;var p={element:this.drawTriangle(t,u[0],h[0],h[1],g)};return p.boundInfo=this.createLineBoundInfo(u[0],u[1],c),p},doDrawTriangleHashBasedConnector:function(t,r,n,o,i,a,s,l){var d=r===e.WEDGED_HASHED_INV,u=r!==e.HASHED,c=d?[a,i]:[i,a],h=l.hashSpacing*l.unitLength,g=l.bondWedgeWidth*l.unitLength,p=u?l.bondWedgeHashMinWidth*l.unitLength:g,f=g-p,C=Kekule.CoordUtils.substract(c[1],c[0]),R=Math.sqrt(Math.sqr(C.x)+Math.sqr(C.y)),D=Math.floor(R/h),m=this.createDrawGroup(t),y=Object.create(l);y.strokeColor=l.color;for(var T=0;T<D;++T){var x=h*T/R,O={x:C.x*x,y:C.y*x};O=Kekule.CoordUtils.add(O,c[0]);var S=this._calcTriangleBaselineCoords(c[0],O,f*x+p),k=this.drawLine(t,S[0],S[1],y);this.addToDrawGroup(k,m)}var v={element:m};return v.boundInfo=this.createLineBoundInfo(c[0],c[1],g),v},_calcTriangleBaselineCoords:function(e,t,r){var n=Kekule.CoordUtils.substract(t,e),o=Math.sqrt(Math.sqr(n.x)+Math.sqr(n.y)),i=n.y/o,a=n.x/o,s=r/2,l=[];return l.push({x:t.x+s*i,y:t.y-s*a}),l.push({x:t.x-s*i,y:t.y+s*a}),l},doDrawRectangleBasedConnector:function(t,r,n,o,i,a,s,l){var d=r===e.WEDGED_SOLID_BOTH,u=l.bondWedgeWidth*l.unitLength,c=this._calcRectangleCornerCoords(i,a,u),h=Object.create(l);h.strokeColor=l.color,h.fillColor=d?l.color:null;var g=Kekule.Render.DrawPathUtils.makePath("M",[c[0].x,c[0].y],"L",[c[1].x,c[1].y],"L",[c[2].x,c[2].y],"L",[c[3].x,c[3].y],"Z"),p={element:this.drawPath(t,g,h)};return p.boundInfo=this.createLineBoundInfo(i,a,u),p},_calcRectangleCornerCoords:function(e,t,r){var n=Kekule.CoordUtils.substract(t,e),o=Math.sqrt(Math.sqr(n.x)+Math.sqr(n.y)),i=r/2,a=[],s=i*(n.y/o),l=i*(n.x/o);return a.push({x:e.x+s,y:e.y-l}),a.push({x:e.x-s,y:e.y+l}),a.push({x:t.x-s,y:t.y+l}),a.push({x:t.x+s,y:t.y-l}),a},doDrawWavyBasedConnector:function(e,t,r,n,o,i,a,s){for(var l,d=Kekule.CoordUtils,u=s.bondWavyRadius*s.unitLength,c=d.getDistance(o,i),h=Math.round(c/u),g=d.divide(d.substract(i,o),h),p=c/h,f=[],C=o,R=Math.atan2(g.y,g.x)+Math.PI,D={x:p/1.5*Math.sin(R),y:-p/1.5*Math.cos(R)},m=1,y=0;y<h;++y){m=-m,l=C,C=d.add(l,g);var T=d.multiply(D,m),x=d.add(l,T),O=d.add(C,T);0===y&&(f.push("M"),f.push([l.x,l.y])),f.push("C"),f.push([x.x,x.y,O.x,O.y,C.x,C.y])}var S=Kekule.Render.DrawPathUtils.makePath.apply(Kekule.Render.DrawPathUtils,f),k=Object.create(s);k.strokeColor=s.color,k.fillColor=null;var v={element:this.drawPath(e,S,k)};return v.boundInfo=this.createLineBoundInfo(o,i,p),v}}),Kekule.Render.StructFragment2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.StructFragment2DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this._concreteRenderer=null,this._concreteChemObj=null,this.initConcreteRenderer()},finalize:function(){this.tryApplySuper("finalize"),this._concreteRenderer&&(this._concreteRenderer.finalize(),this._concreteRenderer=null)},_getRenderSortIndex:function(){return this._concreteRenderer?this._concreteRenderer._getRenderSortIndex():this.tryApplySuper("_getRenderSortIndex")},initConcreteRenderer:function(){var e=this.getChemObj(),t=this.getDrawBridge();return this._isRendererMismatch(this._concreteRenderer,e)&&this._concreteRenderer&&(this._concreteRenderer.finalize(),this._concreteRenderer=null,this._concreteChemObj=null),!this._concreteRenderer&&e&&(e.hasCtab()?(this._concreteChemObj=e.getCtab(),this._concreteRenderer=new Kekule.Render.ChemCtab2DRenderer(e.getCtab(),t,this)):e.hasFormula()&&(this._concreteChemObj=e.getFormula(),this._concreteRenderer=new Kekule.Render.Formula2DRenderer(e.getFormula(),t,this))),this._concreteRenderer},_isRendererMismatch:function(e,t){return e&&!t||e instanceof Kekule.Render.ChemCtab2DRenderer&&!t.hasCtab()||e instanceof Kekule.Render.Formula2DRenderer&&!t.hasFormula()},getConcreteRenderer:function(){return this.initConcreteRenderer(),this._concreteRenderer},_getConcreteRendererDrawOptions:function(e){return e},isChemObjRenderedBySelf:function(e,t){var r=this.getConcreteRenderer();return this.tryApplySuper("isChemObjRenderedBySelf",[e,t])||t===this.getChemObj()||r&&r.isChemObjRenderedBySelf(e,t)},isChemObjRenderedDirectlyBySelf:function(e,t){this.getConcreteRenderer();return this.tryApplySuper("isChemObjRenderedDirectlyBySelf",[e,t])||t===this.getChemObj()||t===this._concreteChemObj},doSetRedirectContext:function(e){this.tryApplySuper("doSetRedirectContext",[e]);var t=this.getConcreteRenderer();t&&t.setRedirectContext(e)},getChildObjs:function(){var e=this.getChemObj();if(e){for(var t=[],r=(e.getExposedNodes()||[]).concat(e.getExposedConnectors()||[]),n=0,o=r.length;n<o;++n){var i=r[n];i.getAttachedMarkers&&(t=t.concat(i.getAttachedMarkers()||[]))}return t.concat(this.tryApplySuper("getChildObjs"))}return this.tryApplySuper("getChildObjs")},_needWholelyDraw:function(e,t){var r=this.tryApplySuper("_needWholelyDraw",[e,t]);if(!r){for(var n=this.getChemObj(),o=!1,i=0,a=e.length;i<a;++i){if(e[i].isChildOf(n)){o=!0;break}}r=o}return r},_createChargeAndRadicalMarkerOnStructFragment:function(e){e.beginUpdate();try{e.hasExplicitCharge&&e.hasExplicitCharge()&&e.fetchChargeMarker(!0);e.getNodes();for(var t=0,r=e.getNodeCount();t<r;++t){var n=e.getNodeAt(t);n.beginUpdate();try{n.hasExplicitChargeOrElectronicBias&&n.hasExplicitChargeOrElectronicBias()&&n.fetchChargeMarker(!0),n.getRadical()&&n.fetchRadicalMarker(!0),n.getNodeAt&&this._createChargeAndRadicalMarkerOnStructFragment(n)}finally{n.endUpdate()}}}finally{e.endUpdate()}},doDraw:function(e,t,r){var n=!!r.autoCreateChargeAndRadicalMarker;if(this.getCanModifyTargetObj()&&n){var o=this.getChemObj();this._createChargeAndRadicalMarkerOnStructFragment(o)}this.tryApplySuper("doDraw",[e,t,r])},doDrawSelf:function(e,t,r){this.tryApplySuper("doDrawSelf",[e,t,r]);var n=this.getChemObj(),o=t,i=this.getConcreteRenderer();if(!o&&i instanceof Kekule.Render.Formula2DRenderer&&n.getAbsBaseCoord2D){var a=n.getAbsBaseCoord2D(r.allowCoordBorrow);o=Kekule.CoordUtils.transform2D(a,r.transformParams)}return n.hasFormula()||n.hasCtab()?i?i.draw(e,o,this._getConcreteRendererDrawOptions(r)):void 0:null},doRedraw:function(e){return this.tryApplySuper("doRedraw",[e])},doUpdateSelf:function(e,t,r){if(this._extractObjsOfUpdateObjDetails(t).indexOf(this.getChemObj())>=0){var n=this.getRenderCache(e);return this.doClear(e),this.draw(e,n.baseCoord,n.options)}var o=this.getConcreteRenderer();if(o)return o.doUpdate(e,t,r)},doClearSelf:function(e){var t=this.getConcreteRenderer();if(t)return t.clear(e)},estimateRenderBox:function(e,t,r,n){var o=this.getConcreteRenderer();return o?o.estimateRenderBox(e,t,this._getConcreteRendererDrawOptions(r),n):null},transformCoordToObj:function(e,t,r){return this.tryApplySuper("transformCoordToObj",[e,t,r])},transformCoordToContext:function(e,t,r){return this.tryApplySuper("transformCoordToContext",[e,t,r])}}),Kekule.Render.Mol2DRenderer=Kekule.Render.StructFragment2DRenderer,Kekule.Render.CompositeObj2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeObj2DRenderer"}),Kekule.Render.CompositeMolecule2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule2DRenderer",getChildObjs:function(){for(var e=[],t=this.getChemObj().getSubMolecules(),r=0,n=t.getItemCount();r<n;++r){var o=t.getObjAt(r);e.push(o)}return e.concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.ChemObjGroupList2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule2DRenderer",getChildObjs:function(){var e=this.getChemObj();if(e instanceof Kekule.ChemObjList)for(var t=[],r=0,n=e.getItemCount();r<n;++r)t.push(e.getItemAt(r));else e instanceof Kekule.ChemStructureObjectGroup&&(t=e.getAllObjs());return(t||[]).concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.Reaction2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.Reaction2DRenderer",getChildObjs:function(){for(var e=[],t=this.getChemObj(),r=(e=[],0),n=t.getReactantCount();r<n;++r){var o=t.getReactantAt(r);e.push(o)}for(r=0,n=t.getProductCount();r<n;++r){o=t.getProductAt(r);e.push(o)}return(e||[]).concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.ChemSpaceElement2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpaceElement2DRenderer",getChildObjs:function(){var e=this.tryApplySuper("getChildObjs")||[];return e=(this.getChemObj().getChildren().toArray()||[]).concat(e)}}),Kekule.Render.ChemSpace2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpace2DRenderer",getChildObjs:function(){return[this.getChemObj().getRoot()].concat(this.tryApplySuper("getChildObjs")||[])},doEstimateSelfObjBox:function(e,t,r){var n=this.getChemObj().getSize2D()||{};return n.x&&n.y&&t.useExplicitSpaceSize?{x1:0,y1:0,x2:n.x,y2:n.y}:this.tryApplySuper("doEstimateSelfObjBox",[e,t,r])}}),Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.Charge,Kekule.Render.TextBasedChemMarker2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.Radical,Kekule.Render.TextBasedChemMarker2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.UnbondedElectronSet,Kekule.Render.UnbondedElectronSetRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.TextBlock,Kekule.Render.TextBlock2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ImageBlock,Kekule.Render.ImageBlock2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.StructureFragment,Kekule.Render.StructFragment2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.CompositeMolecule,Kekule.Render.CompositeMolecule2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.Reaction,Kekule.Render.Reaction2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemObjList,Kekule.Render.ChemObjGroupList2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemStructureObjectGroup,Kekule.Render.ChemObjGroupList2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemSpaceElement,Kekule.Render.ChemSpaceElement2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemSpace,Kekule.Render.ChemSpace2DRenderer)}(),function(){Kekule.Render.DrawPathUtils;var e=Kekule.CoordUtils,t=(Kekule.oneOf,Kekule.Glyph.NodeType),r=Kekule.Glyph.PathType;Kekule.Render.BaseGlyph2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.BaseGlyph2DRenderer",doDraw:function(e,t,r){var n=Object.create(r);return n.strokeColor=r.strokeColor||r.glyphStrokeColor,n.fillColor=r.fillColor||r.glyphFillColor,n.strokeWidth=r.strokeWidth||r.glyphStrokeWidth,n.lineCap=r.glyphLineCap,n.lineJoin=r.glyphLineJoin,this.tryApplySuper("doDraw",[e,t,n])}}),Kekule.Render.PathGlyphCtab2DRenderer=Class.create(Kekule.Render.Ctab2DRenderer,{CLASS_NAME:"Kekule.Render.PathGlyphCtab2DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this._nodeCoordOverrideMap=new Kekule.MapEx(!0)},doFinalize:function(){this._nodeCoordOverrideMap.finalize(),this.tryApplySuper("doFinalize")},extractGlyphDrawOptions:function(e){var t=e.unitLength||1;return{strokeColor:e.strokeColor||e.color||e.glyphStrokeColor,fillColor:e.fillColor||e.color||e.glyphFillColor,strokeWidth:(e.strokeWidth||e.glyphStrokeWidth)*t,lineCap:e.lineCap||e.glyphLineCap,lineJoin:e.lineJoin||e.glyphLineJoin}},doDraw:function(e,t,r){var n=this.tryApplySuper("doDraw",[e,t,r]);return this._nodeCoordOverrideMap.clear(),n},doDrawNode:function(e,r,n,o,i,a){var s,l=n.getNodeType();if(!l||l===t.LOCATION||l===t.CONTROLLER){var d=this._nodeCoordOverrideMap.get(n)||this.getTransformedCoord2D(e,n,a.allowCoordBorrow);s=this.createPointBoundInfo(d)}s&&this.basicDrawObjectUpdated(e,n,o,s,Kekule.Render.ObjectUpdateType.ADD)},doDrawConnector:function(e,t,r,n,o,i){var a=this.tryApplySuper("doDrawConnector",[e,t,r,n,o,i]),s=r.getControlPoints&&r.getControlPoints();if(s)for(var l=0,d=s.length;l<d;++l){var u=this.getTransformedCoord2D(e,s[l],i.allowCoordBorrow),c=this.createPointBoundInfo(u);this.basicDrawObjectUpdated(e,s[l],r,c,Kekule.Render.ObjectUpdateType.ADD)}return a},doDrawConnectorShape:function(t,n,o,i,a){var s,l=Kekule.Glyph.ArrowSide,d=o[0],u=o[1],c=e.clone(this.getTransformedCoord2D(t,d,a.allowCoordBorrow)),h=e.clone(this.getTransformedCoord2D(t,u,a.allowCoordBorrow)),g=this.extractGlyphDrawOptions(i),p=n.getPathType(),f=n.getPathParams()||{},C=this.getChemObj(),R=(f.lineGap||0)*i.defScaleRefLength,D=R&&f.lineCount||1,m=[];f.startArrowType&&f.startArrowWidth&&(s={arrowLength:(y=this._transformArrowLength(t,f.startArrowLength,f.startArrowWidth)).arrowLength,arrowWidth:y.arrowWidth,arrowType:f.startArrowType,arrowSide:f.startArrowSide,drawOnCenter:!f.startArrowSide||f.startArrowSide===l.BOTH});if(f.endArrowType&&f.endArrowWidth)var y,T={arrowLength:(y=this._transformArrowLength(t,f.endArrowLength,f.endArrowWidth)).arrowLength,arrowWidth:y.arrowWidth,arrowType:f.endArrowType,arrowSide:f.endArrowSide,drawOnCenter:!f.endArrowSide||f.endArrowSide===l.BOTH};for(var x=[],O=Kekule.Render.MetaShapeUtils.inflateShape,S=0,k=o.length;S<k;++S){var v=o[S].getPathNodeParams();if(v.useStickingOffset){var A=this.getStickingTargetRenderBound(t,o[S]);if(A){var b=v.stickingOffsetRelLength;if(Kekule.ObjUtils.isUnset(b)&&(b=i.glyphStickOffsetRelLength),b)A=O(A,this._doGetStickOffsetContextLength(t,b,i));x[S]=A}}}var E=[],_=[],L={y:0,x:R},K=e.substract(this.transformCoordToContext(t,C,{x:0,y:0}),this.transformCoordToContext(t,C,L)),w=e.getDistance(K,{x:0,y:0});if(p===r.LINE)E=(M=this._doDrawLineConnectorShape(t,C,n,o,c,h,D,w,s,T,x,g,i)).drawnElems,m=M.arrowElems,_=M.boundInfos;else if(p===r.ARC){var B=n.getControlPoints&&n.getControlPoints(),I=B&&B[0];if(I){var M,U=e.clone(this.getTransformedCoord2D(t,I,a.allowCoordBorrow));E=(M=this._doDrawArcConnectorShape(t,C,n,o,c,h,U,D,w,s,T,x,g,i)).drawnElems,m=M.arrowElems,_=M.boundInfos}}if(_.length||(_=null),D<=1&&!m.length)return{element:E&&E[0],boundInfo:_&&_[0]};var P=this.createDrawGroup(t);for(S=0;S<D;++S)E[S]&&this.addToDrawGroup(E[S],P);for(S=0,k=m.length;S<k;++S)m[S]&&this.addToDrawGroup(m[S],P);return{element:P,boundInfo:_}},_doGetStickOffsetContextLength:function(t,r,n){var o={x:r*n.medianObjRefLength,y:0},i=this.getRootRenderer(),a=i.transformCoordToContext(t,this.getChemObj(),{x:0,y:0}),s=i.transformCoordToContext(t,this.getChemObj(),o);return e.getDistance(a,s)},_doDrawLineConnectorShape:function(t,r,n,o,i,a,s,l,d,u,c,h,g){for(var p=[i,a],f=[i,a],C=(e.divide(e.add(i,a),2),0);C<2;++C){var R=c[C];if(R){var D=Kekule.Render.MetaShapeUtils.getCrossPointsOfVectorToShapeEdges(f,R,!0);D&&D.length&&(p[C]=D[0],this._nodeCoordOverrideMap.set(o[C],p[C]))}}var m=Kekule.Glyph.ArrowSide,y=[],T=[],x=[],O=e.substract(p[1],p[0]),S=O.x,k=O.y,v=e.getDistance(p[0],p[1]),A=v,b=(s-1)/2,E=l,_={y:E*(S/v),x:-E*(k/v)},L=(e.multiply(_,(s-1)/2),e.multiply(_,(s-1)/2)),K=e.substract(p[0],L),w=e.substract(p[1],L);for(C=0;C<s;++C){if(U=null,P=null,0!==C&&(K=e.add(K,_),w=e.add(w,_)),d||u){var B=C-b,I=E*Math.abs(B);if(d){if(d.drawOnCenter&&(!d.arrowSide||d.arrowSide===m.SINGLE&&B<0||d.arrowSide===m.REVERSED&&B>0))var M=d.arrowType===Kekule.Glyph.ArrowType.OPEN?d.arrowLength*I/(d.arrowWidth/2):d.arrowLength,U=e.add(K,e.multiply(O,M/A));d.drawOnCenter&&0===C&&Kekule.ArrayUtils.pushUnique(x,this.doDrawArrowShape(t,n,p[1],p[0],d,h,!0)),!d.drawOnCenter&&(d.arrowSide===m.SINGLE&&0===C||d.arrowSide===m.REVERSED&&C===s-1)&&Kekule.ArrayUtils.pushUnique(x,this.doDrawArrowShape(t,n,w,K,d,h,!0))}if(u){if(u.drawOnCenter&&(!u.arrowSide||u.arrowSide===m.SINGLE&&B<0||u.arrowSide===m.REVERSED&&B>0)){M=u.arrowType===Kekule.Glyph.ArrowType.OPEN?u.arrowLength*I/(u.arrowWidth/2):u.arrowLength;var P=e.substract(w,e.multiply(O,M/A))}u.drawOnCenter&&0===C&&Kekule.ArrayUtils.pushUnique(x,this.doDrawArrowShape(t,n,p[0],p[1],u,h)),!u.drawOnCenter&&(u.arrowSide===m.SINGLE&&0===C||u.arrowSide===m.REVERSED&&C===s-1)&&Kekule.ArrayUtils.pushUnique(x,this.doDrawArrowShape(t,n,K,w,u,h))}}var j=this.doDrawLineShape(t,n,U||K,P||w,h,g);y.push(j.element),T.push(j.boundInfo)}return{drawnElems:y,boundInfos:T,arrowElems:x}},_doDrawArcConnectorShape:function(t,r,n,o,i,a,s,l,d,u,c,h,g,p){for(var f=[],C=[],R=[],D=[i,a],m=e.divide(e.add(s,D[0]),2),y=e.divide(e.add(D[1],s),2),T=-(D[0].x-s.x)/(D[0].y-s.y),x=-(D[1].x-s.x)/(D[1].y-s.y),O={x:(y.y-m.y-x*y.x+T*m.x)/(T-x),y:m.y+T*(y.y-m.y-x*y.x+x*m.x)/(T-x)},S=e.getDistance(O,D[0]),k=e.substract(D[0],O),v=e.substract(D[1],O),A=e.substract(s,O),b=Kekule.GeometryUtils.standardizeAngle(Math.atan2(k.y,k.x)),E=Kekule.GeometryUtils.standardizeAngle(Math.atan2(v.y,v.x)),_=Kekule.GeometryUtils.standardizeAngle(Math.atan2(A.y,A.x)),L=[],K=0;K<2;++K){var w=h[K];if(w){var B=this._getCrossCoordsAndAnglesOfArcToShapeEdges(O,S,b,E,_,w);if(B&&B.length>=1){var I=B[0].coord,M=B[0].angle;L[K]=M,D[K]=I,this._nodeCoordOverrideMap.set(o[K],I)}}}L[0]&&(b=L[0]),L[1]&&(E=L[1]);var U,P,j=E-b,N=_-b,F=_-E,G=Math.sign(N)*Math.sign(F)*Math.sign(j)>0,z=10/S;if(u){var H=b-(G?z:-z);U={x:Math.cos(H),y:Math.sin(H)}}if(c){H=E+(G?z:-z);P={x:Math.cos(H),y:Math.sin(H)}}var W=S-d*((l-1)/2);for(K=0;K<l;++K){var V=W+K*d;if((u||c)&&l<=1){if(u&&0===K){var Y=e.add(O,e.multiply(U,V));Kekule.ArrayUtils.pushUnique(R,this.doDrawArrowShape(t,n,Y,D[0],u,g,!0))}if(c&&0===K){Y=e.add(O,e.multiply(P,V));Kekule.ArrayUtils.pushUnique(R,this.doDrawArrowShape(t,n,Y,D[1],c,g,!0))}}var X=this.doDrawArcShape(t,O,V,b,E,G,g);X.element&&f.push(X.element),X.boundInfo&&C.push(X.boundInfo)}return{drawnElems:f,boundInfos:C,arrowElems:R}},_getCrossCoordsAndAnglesOfArcToShapeEdges:function(t,r,n,o,i,a){for(var s=Kekule.Render.MetaShapeUtils.getEdgeBasicElements(a),l=s.vectors,d=[],u=0,c=l.length;u<c;++u){var h=l[u];(p=Kekule.GeometryUtils.getCrossPointsOfVectorToCircle(h,t,r,1e-4))&&p.length&&(d=d.concat(p))}var g=s.circles;for(u=0,c=g.length;u<c;++u){var p;h=g[u];(p=Kekule.GeometryUtils.getCrossPointsOfCircles(h.center,h.radius,t,r,1e-4))&&p.length&&(d=d.concat(p))}var f=[],C=Math.sign((i-n)*(i-o));for(u=0,c=d.length;u<c;++u){var R=e.substract(d[u],t),D=Kekule.GeometryUtils.standardizeAngle(Math.atan2(R.y,R.x));Math.sign((D-n)*(D-o))===C&&f.push({angle:D,coord:d[u]})}return f},_getNearestCoordToPoint:function(t,r){for(var n=null,o=null,i=0,a=r.length;i<a;++i){var s=e.getDistance(r[i],t);(!n||s<o)&&(n=r[i],o=s)}return n},_transformArrowLength:function(e,t,r){var n={x:t||0,y:r||0},o=Kekule.CoordUtils.substract(this.transformCoordToContext(e,this.getChemObj(),n),this.transformCoordToContext(e,this.getChemObj(),{x:0,y:0}));return{arrowLength:Math.abs(o.x),arrowWidth:Math.abs(o.y)}},doDrawArrowShape:function(t,r,n,o,i,a,s){var l,d,u=Kekule.Glyph.ArrowSide,c=Kekule.Glyph.ArrowType,h=e.substract(o,n),g=e.getDistance(o,n),p=h.y/g,f=h.x/g,C=i.arrowLength,R=i.arrowWidth/2,D=e.substract(o,e.multiply(h,C/g)),m={x:R*p,y:-R*f},y=Kekule.Render.DrawPathUtils,T=[];!i.arrowSide||!s&&i.arrowSide===u.SINGLE||s&&i.arrowSide===u.REVERSED?(l=e.add(D,m),T.push("M"),T.push([l.x,l.y]),T.push("L"),T.push([o.x,o.y])):(T.push("M"),T.push([o.x,o.y])),(!i.arrowSide||!s&&i.arrowSide===u.REVERSED||s&&i.arrowSide===u.SINGLE)&&(d=e.substract(D,m),T.push("L"),T.push([d.x,d.y]));var x=!1;if(i.arrowType===c.TRIANGLE){var O=l&&d?null:D;O&&(T.push("L"),T.push([O.x,O.y])),T.push("Z"),x=!0}var S=y.makePath.apply(this,T),k=Object.create(a);return x||(k.fillColor="transparent"),this.drawPath(t,S,k)},doDrawLineShape:function(e,t,r,n,o,i){return{element:this.drawLine(e,r,n,o),boundInfo:this.createLineBoundInfo(r,n,o.strokeWidth)}},doDrawArcShape:function(e,t,r,n,o,i,a){var s=Object.create(a);return s.fillColor=null,{element:this.drawArc(e,t,r,n,o,i,s),boundInfo:this.createArcBoundInfo(t,r,n,o,i,s.strokeWidth)}}}),Kekule.Render.PathGlyph2DRenderer=Class.create(Kekule.Render.BaseGlyph2DRenderer,{CLASS_NAME:"Kekule.Render.PathGlyph2DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this._concreteChemObj=e.getCtab(),this._concreteRenderer=new Kekule.Render.PathGlyphCtab2DRenderer(e.getCtab(),t,this)},finalize:function(){this.tryApplySuper("finalize"),this._concreteRenderer&&(this._concreteRenderer.finalize(),this._concreteRenderer=null)},_getRenderSortIndex:function(){return this._concreteRenderer?this._concreteRenderer._getRenderSortIndex():this.tryApplySuper("_getRenderSortIndex")},getRenderCache:function(e){return this._concreteRenderer.getRenderCache(e)},_getConcreteRendererDrawOptions:function(e){return e},isChemObjRenderedBySelf:function(e,t){return this.tryApplySuper("isChemObjRenderedBySelf",[e,t])||t===this.getChemObj()||this._concreteRenderer.isChemObjRenderedBySelf(e,t)},isChemObjRenderedDirectlyBySelf:function(e,t){return this.tryApplySuper("isChemObjRenderedDirectlyBySelf",[e,t])||t===this.getChemObj()},doSetRedirectContext:function(e){this.tryApplySuper("doSetRedirectContext",[e]),this._concreteRenderer.setRedirectContext(e)},doDraw:function(e,t,r){this.tryApplySuper("doDraw",[e,t,r]);this.getChemObj();var n=Object.create(r);return n.partialDrawObjs&&(n.partialDrawObjs=null),this._concreteRenderer.draw(e,t,this._getConcreteRendererDrawOptions(n))},doRedraw:function(e){return this._concreteRenderer.redraw(e)},doUpdate:function(e,t,r){if(this._extractObjsOfUpdateObjDetails(t).indexOf(this.getChemObj())>=0){var n=this.getRenderCache(e);return this.doClear(e),this.draw(e,n.baseCoord,n.options)}return this._concreteRenderer.doUpdate(e,t,r)},doClear:function(e){return this._concreteRenderer.clear(e)},estimateRenderBox:function(e,t,r){return this._concreteRenderer.estimateRenderBox(e,this._getConcreteRendererDrawOptions(t),r)},transformCoordToObj:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToObj(e,n,r)},transformCoordToContext:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToContext(e,n,r)}}),Kekule.Render.Renderer2DFactory.register(Kekule.Glyph.PathGlyph,Kekule.Render.PathGlyph2DRenderer)}(),Kekule.Render.CanvasRendererBridge=Class.create(Kekule.Render.Abstract2DDrawBridge,{CLASS_NAME:"Kekule.Render.CanvasRendererBridge",DEF_DOUBLE_BUFFERED:!1,SHADOW_CANVAS_FIELD:"__$shadow_canvas__",SHADOW_CONTEXT_FIELD:"__$shadow_context__",getShadowContext:function(e){return e[this.SHADOW_CONTEXT_FIELD]},getShadowCanvas:function(e){return e[this.SHADOW_CANVAS_FIELD]},getOperatingContext:function(e){return this.getShadowContext(e)||e},createContext:function(e,t,r,n){var o=n&&n.id,i=n&&n.doubleBuffered;void 0===i&&(i=this.DEF_DOUBLE_BUFFERED);e.ownerDocument;var a=document.createElement("canvas");o&&(a.id=o);var s={alpha:!0};n&&(s=Object.extend(s,n)),e.appendChild(a);var l=a.getContext("2d",s);if(i){var d=document.createElement("canvas");d.style.position="absolute",d.style.display="none",e.appendChild(d),l[this.SHADOW_CANVAS_FIELD]=d,l[this.SHADOW_CONTEXT_FIELD]=d.getContext("2d",s)}return n&&n.overSamplingRatio&&this.setContextParam(l,"overSamplingRatio",n.overSamplingRatio),this.setContextDimension(l,t,r),l},releaseContext:function(e){var t=e.canvas,r=this.getShadowCanvas(e),n=t.parentNode;n&&(n.removeChild(t),r&&n.removeChild(r))},_getContextRawDimension:function(e){return{width:e.canvas.width,height:e.canvas.height}},_setContextRawDimension:function(e,t,r){var n=this.getShadowCanvas(e);t&&(e.canvas.width=t,e.canvas.style.width=t+"px",n&&(n.width=t,n.style.width=t+"px")),r&&(e.canvas.height=r,e.canvas.style.height=r+"px",n&&(n.height=r,n.style.height=r+"px")),this.clearContext(e)},getContextElem:function(e){return e?e.canvas:null},setContextViewBox:function(e,t,r,n,o,i){},prepareContext:function(e){},clearContext:function(e){var t=e.canvas;t.setAttribute("width",t.width);var r=this.getShadowCanvas(e);r&&(r.width=t.width);var n=e.__$clearColor__;if(n){e.save();try{var o=this.getContextDimension(e);this.drawRect(e,{x:0,y:0},{x:o.width,y:o.height},{fillColor:n,strokeColor:n})}finally{e.restore()}}},setClearColor:function(e,t){e&&(e.__$clearColor__=t)},setFilter:function(e,t){var r=this.getContextElem(e);r&&(r.style.filter=t)},clearFilter:function(e){this.setFilter(e,"none")},renderContext:function(e){var t=this.getShadowCanvas(e);if(t){var r=this.getContextDimension(e);e.drawImage(t,0,0,r.width,r.height)}},canModifyGraphic:function(e){return!1},_drawDashLine:function(e,t,r,n){null==n&&(n=5),e.moveTo(t.x,t.y);for(var o=r.x-t.x,i=r.y-t.y,a=Math.floor(Math.sqrt(o*o+i*i)/n),s=o/a,l=i/a,d=0,u=t.x,c=t.y;d++<a;)u+=s,c+=l,e[d%2==0?"moveTo":"lineTo"](u,c);e[d%2==0?"moveTo":"lineTo"](r.x2,r.y)},drawLine:function(e,t,r,n){var o=this.getOperatingContext(e);o.beginPath(),this.setDrawStyle(o,n),n.strokeDash&&!this.isLineDashSupported(o)?this._drawDashLine(o,t,r,n.strokeDash):(o.moveTo(t.x,t.y),o.lineTo(r.x,r.y)),this.doneDraw(o,n)},drawTriangle:function(e,t,r,n,o){var i=this.getOperatingContext(e);i.beginPath(),this.setDrawStyle(i,o),i.moveTo(t.x,t.y),i.lineTo(r.x,r.y),i.lineTo(n.x,n.y),i.closePath(),this.doneDraw(i,o)},drawRect:function(e,t,r,n){var o=this.getOperatingContext(e);o.beginPath(),this.setDrawStyle(o,n),o.rect(t.x,t.y,r.x-t.x,r.y-t.y),this.doneDraw(o,n)},drawRoundRect:function(e,t,r,n,o){return this.drawRect(e,t,r,o)},drawCircle:function(e,t,r,n){var o=this.getOperatingContext(e);o.beginPath(),this.setDrawStyle(o,n),o.arc(t.x,t.y,r,0,2*Math.PI,!1),this.doneDraw(o,n)},drawArc:function(e,t,r,n,o,i,a){var s=this.getOperatingContext(e);s.beginPath(),this.setDrawStyle(s,a),s.arc(t.x,t.y,r,n,o,i),this.doneDraw(s,a)},_PATH_CMDS:["M","Z","L","C","Q"],_PATH_METHODS:["moveTo","closePath","lineTo","bezierCurveTo","quadraticCurveTo"],drawPath:function(e,t,r){var n=this.getOperatingContext(e);if(!(t.length<=0)){var o;n.beginPath(),this.setDrawStyle(n,r);for(var i=0,a=t.length;i<a;++i){o=[];var s=t[i],l=s.method.toUpperCase(),d=this._PATH_CMDS.indexOf(l);if(d>=0){var u=this._PATH_METHODS[d];o=s.params,n[u].apply(n,o)}}this.doneDraw(n,r)}},drawImage:function(e,t,r,n,o,i,a){var s=this.getOperatingContext(e),l=this.getContextElem(s).ownerDocument.createElement("img");l.src=t;var d=this;l.onload=function(){try{d.setDrawStyle(s,o);var t=e;a&&(t=a()),(t=d.getOperatingContext(t)).drawImage(l,r.x,r.y,n.x,n.y),i&&i(!0),d.doneDraw(s,o),l.onload=null}catch(e){throw i&&i(!1),e}},l.src=t},drawImageElem:function(e,t,r,n,o){var i=this.getOperatingContext(e);this.setDrawStyle(i,o),i.drawImage(t,r.x,r.y,n.x,n.y),this.doneDraw(i,o)},isLineDashSupported:function(e){return Kekule.ObjUtils.isUnset(this.isLineDashSupported._cachedValue)&&(this.isLineDashSupported._cachedValue=e.setLineDash&&"number"==typeof e.lineDashOffset),this.isLineDashSupported._cachedValue},setTransformSeq:function(e,t){for(var r=Kekule.CoordUtils,n=Kekule.MatrixUtils,o=n.createIdentity(3),i=0,a=t.length;i<a;++i){var s=t[i],l=Object.extend({rotateAngle:s.rotate},s),d=r.calcTransform2DMatrix(l);o=n.multiply(o,d)}e.setTransform(o[0][0],o[1][0],o[0][1],o[1][1],o[0][2],o[1][2])},setDrawStyle:function(e,t){if(Kekule.ObjUtils.notUnset(t.strokeWidth)?e.lineWidth=t.strokeWidth:e.lineWidth=1,t.strokeColor&&(e.strokeStyle=t.strokeColor),e.lineCap=t.lineCap||"butt",e.lineJoin=t.lineJoin||"miter",this.isLineDashSupported(e))if(t.strokeDash){var r=!0===t.strokeDash?[5]:Kekule.ArrayUtils.isArray(t.strokeDash)?t.strokeDash:[t.strokeDash];e.setLineDash(r)}else e.setLineDash([]);t.fillColor?e.fillStyle=t.fillColor:e.fillStyle="transparent",Kekule.ObjUtils.notUnset(t.opacity)?e.globalAlpha=t.opacity:e.globalAlpha=1,t.transforms&&t.transforms.length||t.transform?this.setTransformSeq(e,t.transforms||[t.transform]):e.setTransform(1,0,0,1,0,0)},doneDraw:function(e,t){e.stroke(),t.fillColor&&e.fill()},getCanvasFontStyle:function(e){var t="";return e.fontStyle&&(t+=e.fontStyle+" "),e.fontWeight&&(t+=e.fontWeight+" "),e.fontSize&&("string"==typeof e.fontSize?t+=e.fontSize+" ":t+=e.fontSize+"px "),e.fontFamily&&(t+=e.fontFamily+" "),t},drawText:function(e,t,r,n){var o=this.getOperatingContext(e),i=o.font,a=o.fillStyle,s=this.getCanvasFontStyle(n);this.setDrawStyle(o,n),o.font=s,n.color&&(o.fillStyle=n.color),o.textBaseline="top",o.fillText(r,t.x,t.y),o.fontStyle=i,o.fillStyle=a},canMeasureText:function(e){return!0},measureText:function(e,t,r){var n=this.getCanvasFontStyle(r);e.font=n;var o=e.measureText(t),i=r.fontSize;return"string"==typeof i&&(i=Kekule.StyleUtils.analysisUnitsValue(i).value),{width:o.width,height:i}},canMeasureDrawnText:function(e){return!1},canModifyText:function(e){return!1},createGroup:function(e){},addToGroup:function(e,t){},removeFromGroup:function(e,t){},exportToDataUri:function(e,t,r){var n=this.getContextElem(e);return n?n.toDataURL(t,r):null}}),Kekule.Render.CanvasRendererBridge.isSupported=function(){var e=!1,t=Kekule.$jsRoot.document;return t&&t.createElement&&(e=!!t.createElement("canvas").getContext),e},Kekule.Render.CanvasRendererBridge.getAvailabilityInformation=function(){var e=!1,t=Kekule.$jsRoot.document;return t&&t.createElement&&(e=!!t.createElement("canvas").getContext),{available:e,message:e?null:Kekule.$L("ErrorMsg.CANVAS2D_NOT_UNAVAILABLE")}},Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.CanvasRendererBridge,20),function(){"use strict";var e;Kekule.Render.RaphaelRendererBridge=Class.create(Kekule.Render.Abstract2DDrawBridge,{CLASS_NAME:"Kekule.Render.RaphaelRendererBridge",createContext:function(t,r,n,o){return e(t,r,n)},releaseContext:function(e){e.remove()},getContextDimension:function(e){return{width:e.width,height:e.height}},setContextDimension:function(e,t,r){e.setSize(t,r),this.clearContext(e)},clearContext:function(e){e.clear();var t=e.__$clearColor__;if(t){var r=this.getContextDimension(e);this.drawRect(e,{x:0,y:0},{x:r.width,y:r.height},{fillColor:t,strokeColor:t})}},setClearColor:function(e,t){e&&(e.__$clearColor__=t)},setFilter:function(e,t){var r=this.getContextElem(e);r&&(r.style.filter=t)},clearFilter:function(e){this.setFilter(e,"none")},getContextElem:function(e){return e?e.canvas:null},transformContextCoordToScreen:function(e,t){return t},transformScreenCoordToContext:function(e,t){return t},canModifyGraphic:function(e){return!0},drawPath:function(e,t,r){for(var n="",o=0,i=t.length;o<i;++o){var a=t[o];if(n+=a.method,a.params&&a.params.length)for(var s=0,l=a.params.length;s<l;++s)n+=0===s?"":",",DataType.isArrayValue(a.params[s])?n+=a.params[s].join(","):n+=a.params[s]}var d=e.path(n);return this.setBasicElemAttribs(d,r),d},drawLine:function(e,t,r,n){var o=e.line(t.x,t.y,r.x,r.y);return this.setBasicElemAttribs(o,n),o},drawTriangle:function(e,t,r,n,o){var i=e.triangle(t.x,t.y,r.x,r.y,n.x,n.y);return this.setBasicElemAttribs(i,o),i},drawRect:function(e,t,r,n){var o=e.rect(t.x,t.y,r.x-t.x,r.y-t.y);return this.setBasicElemAttribs(o,n),o},drawRoundRect:function(e,t,r,n,o){var i=e.rect(t.x,t.y,r.x-t.x,r.y-t.y,n);return this.setBasicElemAttribs(i,o),i},drawCircle:function(e,t,r,n){var o=e.circle(t.x,t.y,r);return this.setBasicElemAttribs(o,n),o},drawArc:function(e,t,r,n,o,i,a){var s=Kekule.GeometryUtils.polarToCartesian,l=Kekule.GeometryUtils.standardizeAngle,d=(Kekule.CoordUtils,s(t.x,t.y,r,o)),u=s(t.x,t.y,r,n),c=l(n,0),h=l(o,0)-c,g=l(h)<=Math.PI&&!i||l(h)>Math.PI&&i?"0":"1",p=i?"1":"0",f=["M",d.x,d.y,"A",r,r,0,g,p,u.x,u.y].join(" "),C=e.path(f);return this.setBasicElemAttribs(C,a),C},drawImage:function(e,t,r,n,o,i){try{var a=e.image(t,r.x,r.y,n.x,n.y);this.setBasicElemAttribs(a,o),i&&i(!0)}catch(e){throw i&&i(!1),e}return a},drawImageElem:function(e,t,r,n,o){return this.drawImage(e,t.src,r,n,o)},setBasicElemAttribs:function(e,t){if(Kekule.ObjUtils.notUnset(t.strokeWidth)&&e.attr("stroke-width",t.strokeWidth),t.strokeColor&&e.attr("stroke",t.strokeColor),t.strokeDash){e.attr("stroke-dasharray","- ")}t.fillColor&&e.attr("fill",t.fillColor),t.opacity&&e.attr({"stroke-opacity":t.opacity,"fill-opacity":t.opacity}),t.lineCap&&e.attr("stroke-linecap",t.lineCap),t.lineJoin&&e.attr("stroke-linejoin",t.lineJoin),(t.transforms&&t.transforms.length||t.transform)&&this.setTransformSeq(e,t.transforms||[t.transform])},setTransformSeq:function(e,t){for(var r=0,n=t.length;r<n;++r){var o=Object.extend({rotateAngle:t[r].rotate},t[r]);this.setTransform(e,o)}},setTransform:function(e,t){var r=t.center||{x:0,y:0};t.rotateAngle&&e.rotate(t.rotateAngle/Math.PI*180,r.x,r.y);var n=Kekule.oneOf(t.scaleX,t.scale,1),o=Kekule.oneOf(t.scaleY,t.scale,1);1===n&&1===o||e.scale(n,o,r.x,r.y),(t.translateX||t.translateY)&&e.translate(t.translateX||0,t.translateY||0)},getRaphaelFontStyle:function(e){var t={};return e.fontStyle&&(t["font-style"]=e.fontStyle),e.fontWeight&&(t["font-weight"]=e.fontWeight),e.fontSize&&(t["font-size"]=e.fontSize+"px"),e.fontFamily&&(t["font-family"]=e.fontFamily),t},drawText:function(e,t,r,n){r.endsWith(" ")&&(r=r.substring(0,r.length-1)+" "),r.startsWith(" ")&&(r=" "+r.substr(1));var o=this.getRaphaelFontStyle(n),i=e.text(-1e4,-1e4,r);return i.attr(o),n.color&&i.attr({stroke:n.color,fill:n.color}),this.modifyDrawnTextCoord(e,i,t),this.setBasicElemAttribs(i,n),i},canMeasureText:function(e){return!1},canMeasureDrawnText:function(e){return!0},canModifyText:function(e){return!0},measureDrawnText:function(e,t,r){var n=Kekule.oneOf,o=t.getBBox(),i={};return i.width=n(o.width,o.x2-o.x1),i.height=n(o.height,o.y2-o.y1),i},modifyDrawnTextCoord:function(e,t,r){var n=this.measureDrawnText(e,t,null);t.attr({x:r.x+n.width/2,y:r.y+n.height/2})},createGroup:function(e){return e.set()},addToGroup:function(e,t){return t.push(e)},removeFromGroup:function(e,t){return e!==t&&t.exclude(e)},removeDrawnElem:function(e,t){t.remove()},exportToDataUri:function(e,t,r){if(e.toSVG){var n=e.toSVG();return"data:image/svg+xml;base64,"+btoa(n)}if(e.canvas&&"svg"===e.canvas.tagName.toLowerCase()){n=DataType.XmlUtility.serializeNode(e.canvas);return"data:image/svg+xml;base64,"+btoa(n)}}}),Kekule.Render.RaphaelRendererBridge.isSupported=function(){var t=!1;return Kekule.$jsRoot.Raphael&&(t=!(!e.svg&&!e.vml)),t},Kekule.Render.RaphaelRendererBridge.getAvailabilityInformation=function(){var e=!!Kekule.$jsRoot.Raphael,t=!(!e||!Kekule.$jsRoot.Raphael.svg&&!Kekule.$jsRoot.Raphael.vml);return{available:!!t,message:e?t?null:Kekule.$L("ErrorMsg.RAPHAEL_SVG_VML_UNAVAILABLE"):Kekule.$L("ErrorMsg.RAPHAEL_LIB_NOT_UNAVAILABLE")}},Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.RaphaelRendererBridge,10);var t=function(){var e;t.registered||Kekule.$jsRoot.Raphael&&Kekule.$jsRoot.Raphael.el&&(e=Kekule.$jsRoot.Raphael,Kekule.Render.registerExternalModule("Raphael.js",e),t.registered=!0)};Kekule.externalResourceManager.on("Raphael.jsRegistered",function(){(e=Kekule.externalResourceManager.getResource("Raphael.js"))&&(e.fn.line=function(e,t,r,n){return this.path("M"+e+" "+t+" L"+r+" "+n)},e.fn.arrowLine=function(e,t,r,n,o){if(!o)return this.line(e,t,r,n);var i=this.set(),a=r-e,s=n-t,l=Math.atan(s/a),d=(o.width||6)/2,u=o.length||3,c=Math.atan(d/u),h=Math.sqrt(Math.sqr(d)+Math.sqr(u));return i.push(this.path("M"+r+" "+n+" L"+(r-h*Math.cos(l-c))+" "+(n-h*Math.sin(l-c))+" M"+r+" "+n+" L"+(r-h*Math.cos(l+c))+" "+(n-h*Math.sin(l+c))),this.path("M"+e+" "+t+" L"+r+" "+n)),i},e.fn.triangle=function(e,t,r,n,o,i){return this.path("M"+e+" "+t+" L"+r+" "+n+" L"+o+" "+i+" L"+e+" "+t)},e.fn.polygon=function(e){for(var t="M"+e[0].x+" "+e[0].y,r=1,n=e.length;r<n;++r)t+=" L"+e[r].x+" "+e[r].y;return t+="L"+e[0].x+" "+e[0].y,this.path(t)},e.el.translateCoord=function(e){if(this.forEach)this.forEach(function(t){t.translateCoord(e)});else{var t=this.attr(["x","y"]);void 0!==t.x&&void 0!==t.y&&this.attr({x:t.x+e.x,y:t.y+e.y})}return this},e.st.translateCoord=function(e){return this.forEach&&this.forEach(function(t){t.translateCoord(e)}),this},e.st.remove=function(e){this.forEach(function(e){e.remove()},this),this.clear()}),Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.RaphaelRendererBridge,10)}),Kekule.externalResourceManager.on("Raphael.jsUnregistered",function(){}),t(),Kekule.X.domReady(t)}(),function(){var e=Kekule.ObjUtils,t=Kekule.BoxUtils,r=Kekule.Render.Molecule3DDisplayType,n=Kekule.Render.Bond3DRenderMode,o=Kekule.Render.Bond3DRenderType,i=Kekule.Render.Bond3DSpliceMode,a=Kekule.Render.Node3DRenderMode,s=Kekule.oneOf;Kekule.globalOptions.add("render.render3D",{autofitOnPrimaryDirection:!1}),Kekule.Render.Abstract3DDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.Abstract3DDrawBridge",CONTEXT_PARAMS_FIELD:"__$context_params__",getGraphicQualityLevel:function(){return null},setGraphicQualityLevel:function(e){},transformContextCoordToScreen:function(e,t){return{x:t.x,y:t.y}},canModifyGraphic:function(e){return!1},createContext:function(e,t,r){return null},getContextDimension:function(e){return{}},setContextDimension:function(e,t,r){return null},clearContext:function(e){return null},getContextParam:function(e,t){return(e[this.CONTEXT_PARAMS_FIELD]||{})[t]},setContextParam:function(e,t,r){e[this.CONTEXT_PARAMS_FIELD]||(e[this.CONTEXT_PARAMS_FIELD]={}),e[this.CONTEXT_PARAMS_FIELD][t]=r},_getOverSamplingRatio:function(e){return this.getContextParam(e,"overSamplingRatio")||null},setClearColor:function(e,t){},drawSphere:function(e,t,r,n){},drawCylinder:function(e,t,r,n,o){},drawLine:function(e,t,r,n){},createDrawGroup:function(e){},addToDrawGroup:function(e,t){},removeFromDrawGroup:function(e,t){},getCameraProps:function(e){},setCameraProps:function(e,t){},exportToDataUri:function(e,t,r){}}),Kekule.Render.Base3DRenderer=Class.create(Kekule.Render.CompositeRenderer,{CLASS_NAME:"Kekule.Render.Base3DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r])},getRendererType:function(){return Kekule.Render.RendererType.R3D},getActualTargetContext:function(e){return this.getRedirectContext()||e},getCameraProps:function(e){return this.getDrawBridge().getCameraProps(e)},setCameraProps:function(e,t){return this.getDrawBridge().setCameraProps(e,t)},getInitialLightPositions:function(e){return this.getDrawBridge().getInitialLightPositions&&this.getDrawBridge().getInitialLightPositions(e)},getLightCount:function(e){return this.getDrawBridge().getLightCount&&this.getDrawBridge().getLightCount(e)},getLightProps:function(e,t){return this.getDrawBridge().getLightProps&&this.getDrawBridge().getLightProps(e,t)},setLightProps:function(e,t,r){return this.getDrawBridge().setLightProps(e,t,r)},drawSphere:function(e,t,r,n){return this.getDrawBridge().drawSphere(this.getActualTargetContext(e),t,r,n)},drawCylinder:function(e,t,r,n,o){var i=this.getDrawBridge();return i?i.drawCylinder(this.getActualTargetContext(e),t,r,n,o):null},drawCylinderEx:function(e,t,r,n,o){var i=null,a=this.drawCylinder(e,t,r,n,o);if(a&&o.withEndCaps){i=this.createDrawGroup(e);var s=this.drawSphere(e,t,n);this.addToDrawGroup(s,i);s=this.drawSphere(e,r,n);this.addToDrawGroup(s,i)}return i||a},drawParallelCylinders:function(e,t,r){var n=this.getDrawBridge();if(n.drawParallelCylinders)return n.drawParallelCylinders(this.getActualTargetContext(e),t,r);for(var o=this.createDrawGroup(e),i=0,a=t.length;i<a;++i){var s=t[i],l=this.drawCylinderEx(e,s.coord1,s.coord2,s.radius,{color:s.color,withEndCaps:r});l&&this.addToDrawGroup(l,o)}return o},drawLine:function(e,t,r,n){var o=this.getDrawBridge();return o?o.drawLine(this.getActualTargetContext(e),t,r,n):null},drawParallelLines:function(e,t,r){var n=this.getDrawBridge();if(n.drawParallelLines)return n.drawParallelLines(this.getActualTargetContext(e),t,r);if(n.drawLine){for(var o,i=t.length,a=[],s=0;s<i;++s){var l=t[s],d=this.drawLine(e,l.coord1,l.coord2,{lineWidth:l.lineWidth,color:l.color,opacity:l.opacity});d&&a.push(d)}if(a.length<=1)o=a[0];else{o=this.createDrawGroup(e);s=0;for(var u=a.length;s<u;++s)this.addToDrawGroup(a[s],o)}return o}},createDrawGroup:function(e){return this.getDrawBridge().createGroup(this.getActualTargetContext(e))},addToDrawGroup:function(e,t){return this.getDrawBridge().addToGroup(e,t)},removeFromDrawGroup:function(e,t){return this.getDrawBridge().removeFromGroup(e,t)},removeDrawnElem:function(e,t){}}),Kekule.Render.ChemObj3DRenderer=Class.create(Kekule.Render.Base3DRenderer,{CLASS_NAME:"Kekule.Render.ChemObj3DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this._enableTransformByCamera=!0},doEstimateSelfObjBox:function(e,t,r){return Kekule.Render.ObjUtils.getContainerBox(this.getChemObj(),this.getCoordMode(),r)},doEstimateRenderBox:function(e,r,n,o){var i=this.estimateObjBox(e,n,o);if(i){var a=this.prepareTransformParams(e,r,n,i);return t.transform3D(i,a)}return null},beginDraw:function(e,t,r){if(this.tryApplySuper("beginDraw",[e,t,r]),this.isRootRenderer()){var n=this.getDrawBridge();if(n&&n.setGraphicQualityLevel){var o=r.graphicQuality;n.setGraphicQualityLevel(o)}}},endDraw:function(e,t,r){this.isRootRenderer()&&this.adjustCamera(e,r.transformParams),this.tryApplySuper("endDraw",[e,t,r])},doDraw:function(e,t,r){return this.prepareTransformParams(e,t,r),this.tryApplySuper("doDraw",[e,t,r])},changeGeometryOptions:function(e,t,r){var n=Object.create(r);this.prepareTransformParams(e,t,n).pureCameraTransform?this.endDraw(e,t,n):(this.getDrawBridge().clearContext(e),this.draw(e,t,r))},prepareTransformParams:function(e,t,r,n){var o;if(r.transformParams)o=r.transformParams;else{var i=this.generateTransformParams(e,t,r,n);r.transformParams=i,o=i}var a=Kekule.CoordUtils.calcTransform3DMatrix(o),s=Kekule.CoordUtils.calcInverseTransform3DMatrix(o);return r.transformParams.transformMatrix=a,r.transformParams.invTransformMatrix=s,this.getRenderCache(e).transformParams=o,this.getRenderCache(e).transformMatrix=a,this.getRenderCache(e).invTransformMatrix=s,this.getRenderCache(e).transformParams=o,o},canDoPureCameraTransform:function(e,t){return this._enableTransformByCamera&&t.scaleX===t.scaleY&&t.scaleY===t.scaleZ&&!t.rotateAngle&&!t.rotateX&&!t.rotateY&&!t.rotateZ},generateTransformParams:function(t,r,n,o){var i={};i.allowCoordBorrow=s(n.allowCoordBorrow,!1),i.unitLength=n.unitLength||1,o||(o=this.estimateObjBox(t,n,i.allowCoordBorrow)),o||(o={x1:0,x2:1,y1:0,y2:1,z1:0,z2:1});var a={x:(o.x1+o.x2)/2,y:(o.y1+o.y2)/2,z:(o.z1+o.z2)/2},l=Kekule.ObjUtils;l.isUnset(n.translateX)&&l.isUnset(n.translateY)&&l.isUnset(n.translateZ)?r&&(i.translateX=r.x-a.x,i.translateY=r.y-a.y,i.translateZ=r.z||0-a.z||0):(i.translateX=n.translateX||0,i.translateY=n.translateY||0,i.translateZ=n.translateZ||0),i.zoom=n.zoom||1,i.scaleX=s(n.scaleX,n.scale,1),i.scaleY=s(n.scaleY,n.scale,1),i.scaleZ=s(n.scaleZ,n.scale,1);n.scaleX||n.scaleY||n.scaleZ||n.scale;e.notUnset(n.rotateMatrix)?i.rotateMatrix=n.rotateMatrix:e.notUnset(n.rotateAngle)&&e.notUnset(n.rotateAxisVector)?i.rotateMatrix=Kekule.CoordUtils.calcRotate3DMatrix({rotateAngle:n.rotateAngle,rotateAxisVector:n.rotateAxisVector}):(i.rotateX||i.rotateY||i.rotateZ)&&(i.rotateMatrix=Kekule.CoordUtils.calcRotate3DMatrix({rotateX:n.rotateX||0,rotateY:n.rotateY||0,rotateZ:n.rotateZ||0})),l.isUnset(n.center)&&(i.center=a),i.drawBaseCoord=r||Kekule.CoordUtils.transform3D(a,i);var d=Object.extend({},i);(i=this.getFinalTransformParams(t,i)).initialTransformOptions=d;var u=this.canDoPureCameraTransform(t,i);if(i.pureCameraTransform=u,this.isRootRenderer()&&(n.autofit||!n.cameraPos)){var c,h=this.getAutofitObjBoxInflation(t,this.getChemObj(),n),g=Kekule.BoxUtils.inflateBox(o,h.x,h.y,h.z),p=Math.max(Math.abs(g.x2-g.x1),Math.abs(g.y2-g.y1)),f=this.getCameraProps(t);c=Kekule.globalOptions.render.render3D.autofitOnPrimaryDirection?f.fov:f.fovMin||f.fov;var C=p/2/Math.tan(c/2),R=Math.sqrt(Math.sqr(C)-Math.sqr(p/2));if(u){R/=i.scaleX,i.cameraWidth=p/i.scaleX,i.cameraHeight=i.cameraWidth;var D,m,y,T,x=Kekule.MatrixUtils.create(4,1,[0,0,1,1]),O=Kekule.MatrixUtils.create(4,1,[0,1,1,1]);if(i.rotateMatrix){var S=Kekule.MatrixUtils.transpose(i.rotateMatrix);D=Kekule.MatrixUtils.multiply(S,x),y=Kekule.MatrixUtils.multiply(S,O),m={x:D[0],y:D[1],z:D[2]},T={x:y[0],y:y[1],z:y[2]}}else m={x:0,y:0,z:1},T={x:0,y:1,z:1};m=Kekule.CoordUtils.multiply(m,R),i.cameraPos={x:m.x,y:m.y,z:m.z},i.cameraPos=Kekule.CoordUtils.add(i.cameraPos,i.drawBaseCoord),i.cameraUp=T,i.scaleX=i.scaleY=i.scaleZ=1;var k=this.getInitialLightPositions(t);if(S){var v=this.getLightCount(t);if(k&&k.length&&v)for(var A=Math.min(k.length,v),b=[],E=0;E<A;++E){var _=k[E];if(_){var L=Kekule.MatrixUtils.create(4,1,[_.x,_.y,_.z,1]),K=Kekule.MatrixUtils.multiply(S,L),w={x:K[0],y:K[1],z:K[2]};b.push(w)}}}i.lightPositions=b||k,i.rotateMatrix=null}else i.cameraPos={x:i.drawBaseCoord.x,y:i.drawBaseCoord.y,z:R+i.drawBaseCoord.z},i.cameraUp={x:0,y:1,z:1};i.cameraLookAtVector=i.drawBaseCoord||{x:0,y:0,z:0};var B={x:-i.translateX,y:-i.translateY,z:-i.translateZ};i.translateX=i.translateY=i.translateZ=0,i.cameraPos=Kekule.CoordUtils.add(i.cameraPos,B),i.cameraLookAtVector=Kekule.CoordUtils.add(i.cameraLookAtVector,B)}return i},getFinalTransformParams:function(e,t){var r=Object.create(t);return r.zoom&&(r.scaleX*=r.zoom,r.scaleY*=r.zoom,r.scaleZ*=r.zoom),1!==r.unitLength&&(r.translateX*=r.unitLength,r.translateY*=r.unitLength,r.translateZ*=r.unitLength,r.drawBaseCoord&&(r.drawBaseCoord=Kekule.CoordUtils.multiply(r.drawBaseCoord,r.unitLength))),r},getRenderFinalTransformParams:function(e){return this.getRenderCache(e).transformParams},getRenderInitialTransformOptions:function(e){var t=this.getRenderFinalTransformParams(e);return t?t.initialTransformOptions:null},getAutofitObjBoxInflation:function(e,t,r){var n=r.fixedNodeRadius||0;return{x:n,y:n,z:n}},adjustCamera:function(e,t){var r=t.cameraWidth,n=t.cameraHeight,o={position:t.cameraPos,upVector:t.cameraUp,lookAtVector:t.cameraLookAtVector};if(r&&n){var i=r/2,a=n/2;o.left=-i,o.right=i,o.top=a,o.bottom=-a}this.setCameraProps(e,o),this.adjustLights(e,t)},adjustLights:function(e,t){for(var r=t.lightPositions||[],n=0,o=r.length;n<o;++n){var i=r[n];i&&this.setLightProps(e,n,{position:i})}}}),Kekule.Render.ChemCtab3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemCtab3DRenderer",TRANSFORM_COORD_FIELD:"__$transCoord3D__",DRAW_ELEM_FIELD:"__$drawElem__",DRAW_COLOR_FIELD:"__$drawColor__",BASE_RADIUS_FIELD:"__$baseRadius__",TRANSFORM_MATRIX_FIELD:"__$transMatrix__",INV_TRANSFORM_MATRIX_FIELD:"__$inverseTransMatrix__",CHILD_TRANSFORM_MATRIX_FIELD:"__$childTransMatrix__",HIDDEN_NODES_FIELD:"__$hiddenNodes__",HIDDEN_CONNECTORS_FIELD:"__$hiddenConnectors__",getObjDrawElem:function(e,t){return this.getExtraProp2(e,t,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(e,t,r){this.setExtraProp2(e,t,this.DRAW_ELEM_FIELD,r)},getObjDrawColor:function(e,t){return this.getExtraProp2(e,t,this.DRAW_COLOR_FIELD)},setObjDrawColor:function(e,t,r){this.setExtraProp2(e,t,this.DRAW_COLOR_FIELD,r)},getNodeBaseRadius:function(e,t){return this.getExtraProp2(e,t,this.BASE_RADIUS_FIELD)},setNodeBaseRadius:function(e,t,r){this.setExtraProp2(e,t,this.BASE_RADIUS_FIELD,r)},getHiddenNodes:function(e){return this.getExtraProp(e,this.HIDDEN_NODES_FIELD)||[]},setHiddenNodes:function(e,t){return this.setExtraProp(e,this.HIDDEN_NODES_FIELD,t)},getHiddenConnectors:function(e){return this.getExtraProp(e,this.HIDDEN_CONNECTORS_FIELD)||[]},setHiddenConnectors:function(e,t){return this.setExtraProp(e,this.HIDDEN_CONNECTORS_FIELD,t)},doEstimateSelfObjBox:function(e,t,r){return this.getChemObj().getExposedContainerBox3D(r)},doPrepare:function(e,t,o,i){var s,l,d=i,u=this.getRenderCache(e);switch(d.moleculeDisplayType){case r.WIRE:s=a.NONE,l=d.displayMultipleBond?n.MULTI_WIRE:n.WIRE;break;case r.STICKS:s=a.NONE,l=d.displayMultipleBond?n.MULTI_CYLINDER:n.CYLINDER;break;case r.SPACE_FILL:s=a.SPACE,l=n.NONE;break;case r.BALL_STICK:default:s=a.BALL,l=d.displayMultipleBond?n.MULTI_CYLINDER:n.CYLINDER}u.nodeRenderMode=s,u.connectorRenderMode=l,u.options=d;var c=t.getExposedNodes(),h=t.getExposedConnectors();return this.prepareHiddenObjects(e,c,h,d),this.prepareNodesDrawColor(e,c,d),this.prepareNodeBaseRadii(e,c,d),d},prepareHiddenObjects:function(e,t,r,n){var o=[];this.setHiddenNodes(e,o);for(var i=0,a=t.length;i<a;++i){var s=t[i];n.hideHydrogens&&s instanceof Kekule.Atom&&1===s.getAtomicNumber()&&o.push(s)}var l=[];this.setHiddenConnectors(e,l);for(i=0,a=r.length;i<a;++i){var d=r[i],u=d.getConnectedExposedObjs();Kekule.ArrayUtils.exclude(u,o)<2&&l.push(d)}},prepareNodesDrawColor:function(e,t,r){for(var n=r.useAtomSpecifiedColor,o=0,i=t.length;o<i;++o){var a=t[o],l=a.getOverriddenRender3DOptions()||{},d=l.color||l.atomColor;if(d&&!l.useAtomSpecifiedColor);else if(n||l.useAtomSpecifiedColor){var u=a.getAtomicNumber?a.getAtomicNumber():0;d=u>=0?Kekule.Render.RenderColorUtils.getColor(u,this.getRendererType()):Kekule.Render.RenderColorUtils.getColor(a.getClassLocalName(),this.getRendererType())}else d=s(l.color||r.atomColor);this.setObjDrawColor(e,a,d)}},prepareNodeBaseRadii:function(e,t,r){for(var n=0,o=t.length;n<o;++n){var i,a=t[n];i=this.calcNodeBaseRadius(a,r),this.setNodeBaseRadius(e,a,i)}},calcNodeBaseRadius:function(e,t){var r,n=e.getOverriddenRender3DOptions()||{},o=e.getAtomicNumber?e.getAtomicNumber():null;if(n.nodeRadius||t.nodeRadius)r=n.nodeRadius||t.nodeRadius;else if(s(n.useVdWRadius,t.useVdWRadius)&&o){r=Kekule.ChemicalElementsDataUtil.getElementProp(o,"radiiVdw")||n.fixedNodeRadius||t.fixedNodeRadius}else r=s(n.fixedNodeRadius,t.fixedNodeRadius);return r},doDrawSelf:function(e,t,r){this.tryApplySuper("doDrawSelf",[e,t,r]);var n=this.getChemObj(),o=r.transformParams;this.getRenderCache(e).transformOptions=o,this.transformCtabCoords3DToContext(e,n,o);var i=this.doPrepare(e,n,t,r);return this.doDrawCore(e,n,i,o)},doRedraw:function(e){var t=this.getRenderCache(e);return this.doDrawCore(e,this.getChemObj(),t.options,t.transformOptions)},doDrawCore:function(e,t,r,n){var o=this.createDrawGroup(e);return this.doDrawConnectors(e,o,t,r,n),this.doDrawNodes(e,o,t,r,n),this.setObjDrawElem(e,t,o),o},transformCtabCoords3DToContext:function(e,t,r){var n=r.allowCoordBorrow;r.scaleX=r.scaleX||r.scale,r.scaleY=r.scaleY||r.scale,r.scaleZ=r.scaleZ||r.scale;var o=Object.extend({},r);o.centerX=0,o.centerY=0;var i=r.transformMatrix;this.setExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD,i);var a=i;this.setExtraProp2(e,t,this.CHILD_TRANSFORM_MATRIX_FIELD,i);var s=r.invTransformMatrix;this.setExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD,s);for(var l=0,d=t.getNodeCount();l<d;++l){var u=t.getNodeAt(l);this.transformObjCoord3DToContext(e,u,i,a,n)}},transformObjCoord3DToContext:function(e,t,r,n,o){var i,a;if(t&&t.getAbsBaseCoord3D){if(a=t.getAbsBaseCoord3D(o)){var s=Kekule.CoordUtils.transform3DByMatrix(a,r);this.setTransformedCoord3D(e,t,s),i=s}if(t.getNodes)for(var l=0,d=t.getNodeCount();l<d;++l)this.transformObjCoord3DToContext(e,t.getNodeAt(l),n,n,o)}return i},getTransformedCoord3D:function(e,t,r){Kekule.ObjUtils.isUnset(r)&&(r=this.getRenderCache(e).options.transformParams.allowCoordBorrow);var n=t instanceof Kekule.BaseStructureNode&&this.getExtraProp2(e,t,this.TRANSFORM_COORD_FIELD);if(!n){var o=this.getChemObj(),i=this.getExtraProp2(e,o,this.TRANSFORM_MATRIX_FIELD),a=this.getExtraProp2(e,o,this.CHILD_TRANSFORM_MATRIX_FIELD);n=o&&(o.hasNode(t,!1)||o.hasConnector(t,!1))?this.transformObjCoord3DToContext(t,i,a,r):this.transformObjCoord3DToContext(t,a,a,r)}return n},setTransformedCoord3D:function(e,t,r){this.setExtraProp2(e,t,this.TRANSFORM_COORD_FIELD,r)},doTransformCoordToObj:function(e,t,r){var n=this.getExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD);return Kekule.CoordUtils.transform3DByMatrix(r,n)},doTransformCoordToContext:function(e,t,r){var n=this.getExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD);return Kekule.CoordUtils.transform3DByMatrix(r,n)},doDrawNodes:function(e,t,r,n,o){for(var i=r.getExposedNodes(),a=this.getHiddenNodes(e),s=0,l=i.length;s<l;++s){var d=i[s];if(!(a.indexOf(d)>=0))this.doDrawNode(e,t,d,r,n,o)}},doDrawNode:function(e,t,r,n,o,i){var s,l,d,u=this.getRenderCache(e).nodeRenderMode;if(u===a.NONE)return null;l=Kekule.Render.RenderOptionUtils.mergeObjLocalRender3DOptions(r,o),d=this.getNodeBaseRadius(e,r),Kekule.ObjUtils.isUnset(d)&&(d=this.calcNodeBaseRadius(r,o)),u===a.SPACE?d*=i.scaleX:d*=l.nodeRadiusRatio*i.scaleX;var c=this.getObjDrawColor(e,r),h=this.getTransformedCoord3D(e,r,i.allowCoordBorrow);s=this.drawSphere(e,h,d,{color:c,opacity:l.opacity});var g=this.createSphereBoundInfo(h,d);this.basicDrawObjectUpdated(e,r,n,g,Kekule.Render.ObjectUpdateType.ADD),s&&(this.setObjDrawElem(e,r,s),t&&this.addToDrawGroup(s,t))},doDrawConnectors:function(e,t,r,o,i){if(this.getRenderCache(e).connectorRenderMode===n.NONE)return null;for(var a=r.getExposedConnectors(),s=this.getHiddenConnectors(e),l=0,d=a.length;l<d;++l){var u=a[l];if(!(s.indexOf(u)>=0))this.doDrawConnector(e,t,u,r,o,i)}},doDrawConnector:function(e,t,r,n,o,i){var a=Object.create(o);a=Kekule.Render.RenderOptionUtils.mergeObjLocalRender3DOptions(r,o);for(var s,l,d,u,c,h=this.getHiddenNodes(e),g=r.getConnectedExposedObjs(),p=(g=Kekule.ArrayUtils.exclude(g,h)).length,f=p>2?this.createDrawGroup(e):null,C=0;C<p;++C)if(s=g[C],d=this.getTransformedCoord3D(e,s,i.allowCoordBorrow))for(var R=C+1;R<p;++R)l=g[R],(u=this.getTransformedCoord3D(e,l,i.allowCoordBorrow))&&(c=this.doDrawConnectorShape(e,r,[s,l],n,d,u,a,i))&&f&&this.addToDrawGroup(c,f);return f?this.addToDrawGroup(f,t):this.addToDrawGroup(c,t),f||c},doDrawConnectorShape:function(e,t,r,a,l,d,u,c){var h=Kekule.CoordUtils,g=t.getOverriddenRender3DOptions()||{},p=(u.unitLength,r[0]),f=r[1],C=s(g.bondSpliceMode,u.bondSpliceMode),R=C===i.MID_SPLIT?.5:null;if(C===i.WEIGHTING_SPLIT){var D=this.getNodeBaseRadius(e,p),m=this.getNodeBaseRadius(e,f);R=D&&m?D/(D+m):.5}var y=null,T=!1,x=[];if(R){var O=s(u.color||u.bondColor),S=s(g.color||g.bondColor);if(T=!1,S)x.push(S);else{var k=s(this.getObjDrawColor(e,p),O),v=s(this.getObjDrawColor(e,f),O);k!==v?(x.push(k),x.push(v),T=!0):x.push(s(k,u.color,u.bondColor,u.defBondColor))}}else x.push(s(g.color,g.bondColor,u.color,u.bondColor,u.defBondColor));if(R&&T){var A=d.x-l.x,b=d.y-l.y,E=d.z-l.z;(y={}).x=l.x+A*R,y.y=l.y+b*R,y.z=l.z+E*R}var _=T?[[l,y],[y,d]]:[[l,d]],L=this.getRenderCache(e).connectorRenderMode,K=this._getBondRenderType(t,L),w=!1,B=s(g.connectorRadius,u.connectorRadius)*s(g.connectorRadiusRatio,u.connectorRadiusRatio)*u.unitLength;B*=c.scaleX;var I=s(g.connectorLineWidth,u.connectorLineWidth)*u.unitLength;K!==o.SINGLE&&K!==o.DASH?(B*=s(g.multiConnectorRadiusRatio,u.multiConnectorRadiusRatio),w=L===n.MULTI_CYLINDER):w=!1;var M,U=[],P=1;switch(K){case o.SINGLE:P=1;break;case o.DOUBLE:P=2;break;case o.TRIPLE:P=3;break;case o.DASH:case o.SOLID_DASH:}var j=null;if((M=P)>1){var N=s(g.multiConnectorMarginRatio,u.multiConnectorMarginRatio)*B;w&&(N+=2*B);var F=h.getDistance(l,d),G=h.substract(d,l),z={x:-N*(G.y/F),y:N*(G.x/F),z:0};j=(M%2?0:.5)-Math.floor(M/2);var H=h.multiply(z,j)}for(var W=0,V=_.length;W<V;++W){if(1===M)($={}).coord1=_[W][0],$.coord2=_[W][1],T&&($.jointCoordIndex=0===W?2:1),$.color=x[W],$.radius=B,$.lineWidth=I,$.opacity=u.opacity,U.push($);else for(var Y=h.add(_[W][0],H),X=h.add(_[W][1],H),q=0;q<M;++q){var $;($={}).coord1=Y,$.coord2=X,Y=h.add(Y,z),X=h.add(X,z),T&&($.jointCoordIndex=0===W?2:1),$.color=x[W],$.radius=B,$.lineWidth=I,$.opacity=u.opacity,U.push($)}}var J,Q=L;return J=Q===n.WIRE||Q===n.MULTI_WIRE?this.createLineBoundInfo(l,d,{width:I}):this.createCylinderBoundInfo(l,d,{radius:B}),this.basicDrawObjectUpdated(e,t,a,J,Kekule.Render.ObjectUpdateType.ADD),this.doDrawConnectorSet(e,U,Q,K,u)},doDrawConnectorSet:function(e,t,r,o,i){if(r===n.WIRE||r===n.MULTI_WIRE)return this.drawParallelLines(e,t);var s=this.getRenderCache(e).nodeRenderMode===a.NONE;return this.drawParallelCylinders(e,t,s)},_getBondRenderType:function(e,t){var r=e.getOverriddenRender3DOptions()||{},n=Kekule.Render.Render3DOptionUtils.getConnectorRenderType(r);return n||Kekule.Render.ConnectorDrawUtils.getConnectorRender3DType(e,t)}}),Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.Render.ChemCtab3DRenderer),Kekule.Render.StructFragment3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.StructFragment3DRenderer",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r]),this._concreteRenderer=null,e.hasCtab()?this._concreteRenderer=new Kekule.Render.ChemCtab3DRenderer(e.getCtab(),t,this):(this._concreteRenderer=null,Kekule.raise(Kekule.$L("ErrorMsg.FORMULA_RENDERER_3D_NOT_AVAILABLE"))),this._concreteRenderer.setParentRenderer(this)},finalize:function(){this.tryApplySuper("finalize"),this._concreteRenderer&&this._concreteRenderer.finalize()},getRenderCache:function(e){return this._concreteRenderer.getRenderCache(e)},_getConcreteRendererDrawOptions:function(e){var t=Object.create(e||{}),r=this.getChemObj(),n=this.getRendererType()===Kekule.Render.RendererType.R3D?r.getOverriddenRender3DOptions():r.getOverriddenRenderOptions();return t=Object.extend(t,n||{})},isChemObjRenderedBySelf:function(e,t){return this.tryApplySuper("isChemObjRenderedBySelf",[e,t])||t===this.getChemObj()||this._concreteRenderer.isChemObjRenderedBySelf(e,t)},isChemObjRenderedDirectlyBySelf:function(e,t){return this.tryApplySuper("isChemObjRenderedDirectlyBySelf",[e,t])||t===this.getChemObj()},doSetRedirectContext:function(e){this.tryApplySuper("doSetRedirectContext",[e]),this._concreteRenderer.setRedirectContext(e)},doDrawSelf:function(e,t,r){return this.tryApplySuper("doDrawSelf",[e,t,r]),this._concreteRenderer.draw(e,t,this._getConcreteRendererDrawOptions(r))},doRedraw:function(e){return this._concreteRenderer.redraw(e)},doUpdateSelf:function(e,t,r){if(this._extractObjsOfUpdateObjDetails(t).indexOf(this.getChemObj())>=0){var n=this.getRenderCache(e);return this.doClear(e),this.draw(e,n.baseCoord,n.options)}return this._concreteRenderer.doUpdate(e,t,r)},doClearSelf:function(e){var t=this._concreteRenderer;if(t)return t.clear(e)},estimateRenderBox:function(e,t,r){return this._concreteRenderer.estimateRenderBox(e,this._getConcreteRendererDrawOptions(t),r)},getChildObjs:function(){var e=this.getChemObj();if(e&&e.getAttachedMarkers){for(var t=[],r=(e.getExposedNodes()||[]).concat(e.getExposedConnectors()||[]),n=0,o=r.length;n<o;++n){var i=r[n];t=t.concat(i.getAttachedMarkers()||[])}return t.concat(this.tryApplySuper("getChildObjs"))}return this.tryApplySuper("getChildObjs")},_needWholelyDraw:function(e,t){var r=this.tryApplySuper("_needWholelyDraw",[e,t]);if(!r){for(var n=this.getChemObj(),o=!1,i=0,a=e.length;i<a;++i){if(e[i].isChildOf(n)){o=!0;break}}r=o}return r},transformCoordToObj:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToObj(e,n,r)},transformCoordToContext:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToContext(e,n,r)}}),Kekule.Render.Mol3DRenderer=Kekule.Render.StructFragment3DRenderer,Kekule.Render.CompositeObj3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.CompositeObj3DRenderer"}),Kekule.Render.CompositeMolecule3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule3DRenderer",getChildObjs:function(){for(var e=[],t=this.getChemObj().getSubMolecules(),r=0,n=t.getItemCount();r<n;++r){var o=t.getObjAt(r);e.push(o)}return e.concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.ChemObjGroupList3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemObjGroupList3DRenderer",getChildObjs:function(){var e=this.getChemObj();if(e instanceof Kekule.ChemObjList)for(var t=[],r=0,n=e.getItemCount();r<n;++r)t.push(e.getItemAt(r));else e instanceof Kekule.ChemStructureObjectGroup&&(t=e.getAllObjs());return(t||[]).concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.ChemSpaceElement3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpaceElement3DRenderer",getChildObjs:function(){return(this.getChemObj().getChildren().toArray()||[]).concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.ChemSpace3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpace3DRenderer",getChildObjs:function(){return[this.getChemObj().getRoot()].concat(this.tryApplySuper("getChildObjs"))}}),Kekule.Render.Renderer3DFactory.register(Kekule.StructureFragment,Kekule.Render.StructFragment3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.CompositeMolecule,Kekule.Render.CompositeMolecule3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemObjList,Kekule.Render.ChemObjGroupList3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemStructureObjectGroup,Kekule.Render.ChemObjGroupList3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemSpaceElement,Kekule.Render.ChemSpaceElement3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemSpace,Kekule.Render.ChemSpace3DRenderer)}(),function(){"use strict";var e;Kekule.Render.ThreeObjectCache=Class.create({CLASS_NAME:"Kekule.Render.ThreeObjectCache",initialize:function(){this.cache=new Kekule.MapEx(!0)},finalize:function(){this.cache.finalize(),this.cache=null},createInstance:function(e,t){return null},isSameParams:function(e,t){if(e.length!==t.length)return!1;for(var r=0,n=e.length;r<n;++r)if(!this.isParamEqual(e[r],t[r]))return!1;return!0},isParamEqual:function(e,t){var r=e===t;return r||DataType.isObjectValue(e)&&DataType.isObjectValue(t)&&(r=Kekule.ObjUtils.equal(e,t)),r},add:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),r=this.cache.get(t);r||(r=[],this.cache.set(t,r));var n={params:e};return n.instance=this.createInstance(t,e),r.push(n),n.instance},get:function(){var e=Array.prototype.slice.call(arguments),t=e[0],r=this.cache.get(t);if(r){e.shift();for(var n=0,o=r.length;n<o;++n){var i=r[n].params;if(this.isSameParams(i,e))return r[n].instance}e.unshift(t)}return this.add.apply(this,e)}}),Kekule.Render.ThreeGeometryCache=Class.create(Kekule.Render.ThreeObjectCache,{CLASS_NAME:"Kekule.Render.ThreeGeometryCache",createInstance:function(t,r){var n=null,o=r;o[0];switch(t){case e.SphereGeometry:n=new e.SphereGeometry(o[1],o[2],o[3]);break;case e.CylinderGeometry:n=new e.CylinderGeometry(o[1],o[2],o[3],o[4],o[5],o[6])}return n}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.ThreeGeometryCache),Kekule.Render.ThreeMaterialCache=Class.create(Kekule.Render.ThreeObjectCache,{CLASS_NAME:"Kekule.Render.ThreeMaterialCache",createInstance:function(e,t){return new e(t[1])}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.ThreeMaterialCache),Kekule.Render.ThreeContext=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.ThreeContext",initialize:function(e,t,r,n){this.tryApplySuper("initialize"),this.setScene(e),this.setCamera(t),this.setLights(r),this.setRenderer(n)},initProperties:function(){this.defineProp("scene",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("camera",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("lights",{dataType:DataType.ARRAY,serializable:!1}),this.defineProp("renderer",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("width",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("height",{dataType:DataType.INT,serializable:!1,setter:null})},getDimension:function(){return{width:this.getWidth(),height:this.getHeight()}},setDimension:function(t,r){this.setPropStoreFieldValue("width",t),this.setPropStoreFieldValue("height",r),this.getRenderer().setSize(t,r);var n=this.getCamera();n instanceof e.OrthographicCamera?(n.left=t/-2,n.right=t/2,n.top=r/2,n.bottom=r/-2):n.aspect=t/r,n.updateProjectionMatrix()}}),Kekule.Render.ThreeRendererBridge=Class.create(Kekule.Render.Abstract3DDrawBridge,{CLASS_NAME:"Kekule.Render.ThreeRendererBridge",_qualitySettings:[null,{sphereSegments:6,sphereRings:6,cylinderSegmentsRadius:6},{sphereSegments:8,sphereRings:8,cylinderSegmentsRadius:8},{sphereSegments:16,sphereRings:16,cylinderSegmentsRadius:16},{sphereSegments:32,sphereRings:32,cylinderSegmentsRadius:32},{sphereSegments:64,sphereRings:64,cylinderSegmentsRadius:64}],initialize:function(){this.geometryCache=Kekule.Render.ThreeGeometryCache.getInstance(),this.materialCache=Kekule.Render.ThreeMaterialCache.getInstance(),this._quality=null,this._modelParams={},this._webglEnabled=!0},finalize:function(){this.geometryCache=null,this.materialCache=null},getGraphicQualityLevel:function(){return this._quality},setGraphicQualityLevel:function(e){this._webglEnabled?this._quality=e:this._quality=Kekule.Render.Render3DGraphicQuality.EXTREME_LOW,this._modelParams=this.calcModelParams(this._quality)},_updateGraphicQualityLevel:function(){this._webglEnabled||this.setGraphicQualityLevel(Kekule.Render.Render3DGraphicQuality.EXTREME_LOW)},calcModelParams:function(e){var t=this._qualitySettings[e];return t||(t=this._qualitySettings[Kekule.Render.Render3DGraphicQuality.MEDIUM]),t},getInitialLightPositions:function(e){return[{x:5,y:5,z:10}]},createContext:function(t,r,n,o){var i=Kekule.BrowserFeature,a={preserveDrawingBuffer:!0,alpha:!0,antialias:!0};o&&(a=Object.extend(a,o));var s=i.webgl?new e.WebGLRenderer(a):i.canvas?new e.CanvasRenderer(a):new e.SVGRenderer(a),l=new e.PerspectiveCamera;l.fov=5,this._webglEnabled=s instanceof e.WebGLRenderer,this._updateGraphicQualityLevel();var d=new e.Scene;d.add(l),s.setSize(r,n);const u=!0===s.useLegacyLights||void 0===s.useLegacyLights&&parseInt(e.REVISION)<155?1:Math.PI;for(var c=this.getInitialLightPositions(),h=[],g=0,p=c.length;g<p;++g){var f=new e.DirectionalLight(13421772,1*u,10,!0),C=c[g];f.castShadow=!0,f.position.set(C.x,C.y,C.z),d.add(f),h.push(f)}f=new e.AmbientLight(2105376,1*u);d.add(f),t.appendChild(s.domElement);var R=new Kekule.Render.ThreeContext(d,l,h,s);return R.setDimension(r,n),R},releaseContext:function(e){var t=this.getContextElem(e);e.finalize(),t&&t.parentNode.removeChild(t)},getContextElem:function(e){return e?e.getRenderer().domElement:null},getContextDimension:function(e){return{width:e.getWidth(),height:e.getHeight()}},setContextDimension:function(e,t,r){e.setDimension(t,r)},transformContextCoordToScreen:function(e,t){var r=e.getDimension();return{x:t.x+r.width/2,y:t.y+r.height/2}},transformScreenCoordToContext:function(e,t){var r=e.getDimension();return{x:t.x-r.width/2,y:t.y-r.height/2,z:0}},canModifyGraphic:function(e){return!0},colorStrToHex:function(e){return Kekule.StyleUtils.colorStrToValue(e)},createGroup:function(t){var r=new e.Object3D;return r.__objGroup__=!0,t.getScene().add(r),r},addToGroup:function(e,t){return t.add(e),t},removeFromGroup:function(e,t){t.remove(e)},setClearColor:function(t,r){var n=t.getRenderer();n&&(n.setClearColor?r?t.getRenderer().setClearColor(new e.Color(r),1):t.getRenderer().setClearColor(new e.Color,0):n.setClearColorHex&&(r?t.getRenderer().setClearColorHex(this.colorStrToHex(r),1):t.getRenderer().setClearColorHex(null,0)))},clearContext:function(e){e.getScene().clearMesh(),this.renderContext(e)},renderContext:function(e){e.getRenderer().render(e.getScene(),e.getCamera())},drawSphere:function(t,r,n,o){var i=this._modelParams.sphereSegments,a=this._modelParams.sphereRings,s=this.geometryCache.get(e.SphereGeometry,t.getScene(),1,i,a),l=this.materialCache.get(e.MeshLambertMaterial,t.getScene(),{color:this.colorStrToHex(o.color),opacity:o.opacity||1}),d=new e.Mesh(s,l);return d.scale.x=n,d.scale.y=n,d.scale.z=n,d.position.x=r.x,d.position.y=r.y,d.position.z=r.z,t.getScene().add(d),d},drawLine:function(t,r,n,o){this.colorStrToHex(o.color);var i,a=this.materialCache.get(e.LineBasicMaterial,t.getScene(),{color:this.colorStrToHex(o.color),opacity:o.opacity||1,linewidth:o.lineWidth||1});if(e.Geometry)(i=new e.Geometry).vertices.push(new e.Vector3(r.x,r.y,r.z)),i.vertices.push(new e.Vector3(n.x,n.y,n.z));else{i=new e.BufferGeometry;var s=[new e.Vector3(r.x,r.y,r.z),new e.Vector3(n.x,n.y,n.z)];i.setFromPoints(s)}var l=new e.Line(i,a);return t.getScene().add(l),l},drawCylinder:function(t,r,n,o,i){var a=Kekule.CoordUtils,s=this._modelParams.cylinderSegmentsRadius,l=a.getDistance(r,n),d=this.geometryCache.get(e.CylinderGeometry,t.getScene(),1,1,1,s,1,!0),u=this.materialCache.get(e.MeshLambertMaterial,t.getScene(),{color:this.colorStrToHex(i.color),opacity:i.opacity||1}),c=new e.Mesh(d,u);c.scale.y=l,c.scale.x=o,c.scale.z=o;var h=Kekule.ObjUtils.isUnset(i.quaternion)?this._calcQuaternion(r,n):i.quaternion;return h&&(c.applyQuaternion?c.applyQuaternion(h):(c.useQuaternion=!0,c.quaternion=h,c.updateMatrix())),c.position.x=(r.x+n.x)/2,c.position.y=(r.y+n.y)/2,c.position.z=(r.z+n.z)/2,t.getScene().add(c),c},drawParallelCylinders:function(e,t,r){Kekule.CoordUtils;for(var n=t[0],o=this._calcQuaternion(n.coord1,n.coord2),i=this.createGroup(e),a=0,s=t.length;a<s;++a){var l=t[a],d=this.drawCylinder(e,l.coord1,l.coord2,l.radius,{color:l.color,quaternion:o,opacity:l.opacity});this.addToGroup(d,i)}if(r){var u;for(a=0,s=t.length;a<s;++a){l=t[a];for(var c=0,h=(u=Kekule.ObjUtils.isUnset(l.jointCoordIndex)?[l.coord1,l.coord2]:1===l.jointCoordIndex?[l.coord2]:[l.coord1]).length;c<h;++c){d=this.drawSphere(e,u[c],l.radius,{color:l.color,opacity:l.opacity});this.addToGroup(d,i)}}}return i},removeDrawnElem:function(e,t){t.parent&&t.parent.remove&&t.parent.remove(t)},_calcQuaternion:function(t,r){var n=Kekule.CoordUtils,o=n.substract(r,t);if(o.x||o.z){var i={x:o.z,y:0,z:-o.x};i=n.standardize(i);var a=Math.atan2(Math.sqrt(Math.sqr(o.x)+Math.sqr(o.z)),o.y)/2,s=Math.cos(a),l=Math.sin(a);return new e.Quaternion(l*i.x,l*i.y,l*i.z,s)}return null},getLightCount:function(e){var t=e.getLights();return t&&t.length||0},getLightProps:function(e,t){return{position:e.getLights()[t].position}},setLightProps:function(e,t,r){var n=e.getLights()[t],o=r.position;o&&(n.position.x=o.x,n.position.y=o.y,n.position.z=o.z),n.updateMatrix()},getCameraProps:function(e){var t=e.getCamera(),r=t.fov*Math.PI/180,n=r*(t.aspect||1),o=Math.min(r,n);return{position:t.position,fov:r,aspect:t.aspect,fovVertical:r,fovHorizontal:n,fovMin:o,left:t.left,right:t.right,top:t.top,bottom:t.bottom,lookAtVector:t.lookAtVector,upVector:t.up}},setCameraProps:function(t,r){var n=t.getCamera(),o=Kekule.ObjUtils.notUnset,i=r.position;if(i&&(n.position.x=i.x,n.position.y=i.y,n.position.z=i.z),o(r.near)&&(n.near=r.near),o(r.far)&&(n.far=r.far),r.fov&&(n.fov=180*r.fov/Math.PI),r.aspect&&(n.aspect=r.aspect),o(r.left)&&(n.left=r.left),o(r.top)&&(n.top=r.top),o(r.bottom)&&(n.bottom=r.bottom),o(r.right)&&(n.right=r.right),o(r.upVector)){var a=r.upVector;n.up=new e.Vector3(a.x,a.y,a.z)}if(o(r.lookAtVector)){a=r.lookAtVector;n.lookAt(new e.Vector3(a.x,a.y,a.z))}n.updateMatrix()},exportToDataUri:function(t,r,n){var o=t.getRenderer();if(e.SVGRenderer&&o instanceof e.SVGRenderer){var i=t.getRenderer().domElement,a=DataType.XmlUtility.serializeNode(i);return"data:image/svg+xml;base64,"+btoa(a)}return(i=t.getRenderer().domElement)?i.toDataURL(r,n):null}}),Kekule.Render.ThreeRendererBridge.isSupported=function(){var e=void 0!==Kekule.Render.getExternalModule("three.js");if(e){var t=Kekule.BrowserFeature;e=t.webgl||t.canvas||t.svg}return!!e},Kekule.Render.ThreeRendererBridge.getAvailabilityInformation=function(){var e=!1,t=void 0!==Kekule.Render.getExternalModule("three.js"),r=Kekule.BrowserFeature,n=r.webgl,o=r.canvas||r.svg,i=null;return t?n||o?e=!0:i=Kekule.$L("ErrorMsg.THREEJS_DRAWING_NOT_UNAVAILABLE"):i=Kekule.$L("ErrorMsg.THREEJS_LIB_NOT_UNAVAILABLE"),{available:e,message:i}},Kekule.Render.DrawBridge3DMananger.register(Kekule.Render.ThreeRendererBridge,20);var t=function(){var e;t.registered||Kekule.$jsRoot.THREE&&Kekule.$jsRoot.THREE.Object3D&&(e=Kekule.$jsRoot.THREE,Kekule.Render.registerExternalModule("three.js",e),t.registered=!0)};Kekule.externalResourceManager.on("three.jsRegistered",function(){(e=Kekule.externalResourceManager.getResource("three.js"))&&(e.Object3D.prototype.clear||(e.Object3D.prototype.clear=function(){for(var e=this.children,t=e.length-1;t>=0;t--){var r=e[t];r.clear(),this.remove(r)}}),e.Scene.prototype.clearMesh||(e.Scene.prototype.clearMesh=function(){for(var t=this.children,r=t.length-1;r>=0;r--){var n=t[r];(n instanceof e.Mesh||n instanceof e.Line||n.__objGroup__)&&(n.clear(),this.remove(n))}}),Kekule.Render.DrawBridge3DMananger.register(Kekule.Render.ThreeRendererBridge,20))}),Kekule.externalResourceManager.on("three.jsUnregistered",function(){}),t(),Kekule.X.domReady(t)}(),Kekule.Render.ChemObjPainter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.ChemObjPainter",initialize:function(e,t,r,n){this.tryApplySuper("initialize");var o=e||Kekule.Render.RendererType.R2D;this.setPropStoreFieldValue("renderType",o),this.setPropStoreFieldValue("chemObj",t),this.setPropStoreFieldValue("drawBridge",r||(o===Kekule.Render.RendererType.R3D?Kekule.Render.DrawBridge3DMananger.getPreferredBridgeInstance():Kekule.Render.DrawBridge2DMananger.getPreferredBridgeInstance())),n&&this.setPropStoreFieldValue("renderConfigs",n)},finalize:function(){this.getRenderer()&&this.getRenderer().finalize(),this.tryApplySuper("finalize")},initProperties:function(){this.defineProp("renderType",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:!1,setter:null}),this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:!1,setter:null}),this.defineProp("renderConfigs",{dataType:DataType.OBJECT,serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("renderConfigs");return e||(e=this.getRenderType()===Kekule.Render.RendererType.R3D?Kekule.Render.Render3DConfigs.getInstance():Kekule.Render.Render2DConfigs.getInstance()),e}}),this.defineProp("renderer",{dateType:"Kekule.Render.AbstractRenderer",serializable:!1,setter:null}),this.defineProp("canModifyTargetObj",{dataType:DataType.BOOL}),this.defineProp("boundInfoRecorder",{dataType:"Kekule.Render.BoundInfoRecorder",serializable:!1,setter:null,getter:function(){var e=this.getRenderer();return e&&e.getBoundInfoRecorder()}})},getDrawOptionFromConfigs:function(e){return Kekule.Render.RenderOptionUtils.convertConfigsToPlainHash(e)},prepareRenderer:function(){if(this.getRenderer())return this.getRenderer();var e=(this.getRenderType()===Kekule.Render.RendererType.R3D?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass)(this.getChemObj());if(e){var t=new e(this.getChemObj(),this.getDrawBridge(),this);return this.setPropStoreFieldValue("renderer",t),t}return Kekule.error(Kekule.$L("ErrorMsg.CANNOT_FIND_SUITABLE_RENDERER_FOR_OBJ")),null},createContext:function(e,t,r){return this.getDrawBridge().createContext(e,t,r)},_convertContextBoxToScreen:function(e,t){if(!t)return{};var r=this.getDrawBridge(),n=r.transformContextCoordToScreen(e,{x:t.x1,y:t.y1}),o=r.transformContextCoordToScreen(e,{x:t.x2,y:t.y2});return Kekule.BoxUtils.createBox(n,o)},estimateObjBox:function(e,t,r){return this._generateDrawOptions(t),this.prepareRenderer(),this.getRenderer().estimateObjBox(e,t,r)},estimateRenderBox:function(e,t,r,n){var o=this._generateDrawOptions(r);return this.prepareRenderer(),this.getRenderer().estimateRenderBox(e,t,o,n)},estimateScreenBox:function(e,t,r,n){var o=this.estimateRenderBox(e,t,r,n);return o?this._convertContextBoxToScreen(e,o):null},_generateDrawOptions:function(e){var t=this.getRenderConfigs(),r=t?this.getDrawOptionFromConfigs(t):{};return r=Object.extend(r,e)},draw:function(e,t,r){if(!this.getChemObj())return null;this.prepareRenderer();var n=this._generateDrawOptions(r);return this.getRenderer().draw(e,t,n)},redraw:function(e){return this.getRenderer().redraw(e)},getActualRenderTransformParams:function(e){var t=this.getRenderer();return t?t.getRenderFinalTransformParams(e):null},getActualInitialRenderTransformOptions:function(e){var t=this.getRenderer();return t?t.getRenderInitialTransformOptions(e):null},changeGeometryOptions:function(e,t,r){var n=this.getRenderer();if(n&&n.changeGeometryOptions){var o=this._generateDrawOptions(r);return n.changeGeometryOptions(e,t,o)}return this.clearContext(e),this.draw(e,t,r)},supportGeometryOptionChange:function(){var e=this.getRenderer();return e&&e.changeGeometryOptions},beginUpdatePainter:function(){return this.getRenderer().beginUpdateRenderer()},endUpdatePainter:function(){return this.getRenderer().endUpdateRenderer()},update:function(e,t,r){return this.getRenderer().update(e,t,r)},addNew:function(e,t){return this.getRenderer().addNew(e,t)},modify:function(e,t){return this.getRenderer().modify(e,t)},remove:function(e,t){return this.getRenderer().remove(e,t)},clear:function(e){var t=this.getRenderer();return t&&t.clear(e),this},clearContext:function(e){return this.getDrawBridge().clearContext(e)}}),Kekule.Render.ChemObjPainter2D=Class.create(Kekule.Render.ChemObjPainter,{CLASS_NAME:"Kekule.Render.ChemObjPainter2D",initialize:function(e,t,r){this.tryApplySuper("initialize",[Kekule.Render.RendererType.R2D,e,t,r])}}),Kekule.Render.ChemObjPainter3D=Class.create(Kekule.Render.ChemObjPainter,{CLASS_NAME:"Kekule.Render.ChemObjPainter3D",initialize:function(e,t,r){this.tryApplySuper("initialize",[Kekule.Render.RendererType.R3D,e,t,r])}});