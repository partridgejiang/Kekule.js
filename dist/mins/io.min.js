Kekule.TextLinesBuffer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.TextLinesBuffer",LINEBREAK:"\n",initialize:function(e){this.tryApplySuper("initialize"),this.setPropStoreFieldValue("lines",[]),e&&("string"==typeof e?this.setText(e):this.setLines(e)),this.setCurrLineNo(0)},initProperties:function(){this.defineProp("lines",{dataType:DataType.ARRAY,serializable:!1}),this.defineProp("text",{dataType:DataType.STRING,serializable:!1,getter:function(){return this.getLines().join(this.LINEBREAK)},setter:function(e){this.setPropStoreFieldValue("lines",[]),this.reset(),this.appendText(e)}}),this.defineProp("currLineNo",{dataType:DataType.INT,serializable:!1})},getUnreadLines:function(){var e=[].concat(this.getLines());return e.splice(0,this.getCurrLineNo()),e},getUnreadText:function(){return this.getUnreadLines().join(this.LINEBREAK)},appendText:function(e){var t=e.split(this.LINEBREAK);this.appendLines(t)},appendLines:function(e){this.setPropStoreFieldValue("lines",this.getLines().concat(e)),this.notifyPropSet("lines",this.getPropStoreFieldValue("lines"))},clear:function(){this.setLines([]),this.setCurrLineNo(0)},incCurrLineNo:function(e){null==e&&(e=1);var t=this.getCurrLineNo();t+=e,this.setCurrLineNo(t)},getLineAt:function(e){var t=this.getLines()[e];return t&&t.length&&"\r"===t.charAt(t.length-1)&&(t=t.substring(0,t.length-1)),t},getCurrLine:function(){return this.getLineAt(this.getCurrLineNo())},readLine:function(){var e=this.getLineAt(this.getCurrLineNo());return this.incCurrLineNo(),e},writeLine:function(e){this.getLines().splice(this.getCurrLineNo(),0,e),this.incCurrLineNo()},writeLines:function(e){for(var t=0,r=e.length;t<r;++t)this.writeLine(e[t])},writeText:function(e){var t=e.split(this.LINEBREAK);this.writeLines(t)},eof:function(){return this.getCurrLineNo()>=this.getLines().length},reset:function(){this.setCurrLineNo(0)}}),function(){Kekule.globalOptions.add("IO",{}),Kekule.IO={},Kekule.IO.ChemDataType={TEXT:"text",DOM:"dom",JSON:"json",BINARY:"bin",OTHER:"other",UNKNOWN:"unknown",isBinaryType:function(e){var t=Kekule.IO.ChemDataType;return!e||e===t.BINARY||e===t.OTHER||e===t.UNKNOWN}},Kekule.IO.DataFormat={},Kekule.IO.MimeType={TEXT:"text/plain",HTML:"text/html",XML:"text/xml",JSON:"application/json",JAVASCRIPT:"application/javascript",GIF:"image/gif",JPEG:"image/jpeg",PNG:"image/png",XPNG:"image/x-png",OCTSTREAM:"application/octet-stream"},Kekule.IO.DataFormatsManager={_formats:{},register:function(t,r,l,a,i,n,o){var u=null;u||(u=e._formats[t]),u||(u={id:t},e._formats[t]=u),u.mimeType=r;var s=DataType.isArrayValue(l)?l:[l];return s=s.map(function(e){return e?e.toLowerCase():e}),u.fileExts?Kekule.ArrayUtils.pushUnique(u.fileExts,s):u.fileExts=s,a&&a!==Kekule.IO.ChemDataType.UNKNOWN&&(u.dataType=a),u.title=i,u.description=n,o&&(u=Object.extend(u,o)),u},unregister:function(t){e._formats[t]&&delete e._formats[t]},getAllIds:function(){return Kekule.ObjUtils.getOwnedFieldNames(e._formats)},getFormatInfo:function(t){return e._formats[t]||null},getMimeType:function(t){var r=e.getFormatInfo(t);return r?r.mimeType:null},getFileExts:function(t){var r=e.getFormatInfo(t);return r?r.fileExts:null},findFormat:function(t,r){if(!t&&!r)return null;for(var l=e.getAllIds(),a=!1,i=0,n=l.length;i<n;++i){var o=e.getFormatInfo(l[i]);if((a=t&&t===o.mimeType)||(a=r&&o.fileExts.indexOf(r.toLowerCase())>=0),a)return o}return null},findFormatId:function(e,t){var r=Kekule.IO.DataFormatsManager.findFormat(e,t);return r?r.id:null}};var e=Kekule.IO.DataFormatsManager;Kekule.IO.dataFormatsManager=Kekule.IO.DataFormatsManager,Kekule.IO.ChemDataReader=Class.create(ObjectEx,{initialize:function(e){this.tryApplySuper("initialize")},CLASS_NAME:"Kekule.IO.ChemDataReader",readData:function(e,t,r,l){if(!t){var a=Kekule.IO.DataFormatsManager.getFormatInfo(r);(t=a?a.dataType:null)||(t="string"==typeof e?Kekule.IO.ChemDataType.TEXT:e.getElementsByTagName?Kekule.IO.ChemDataType.DOM:Kekule.IO.ChemDataType.BINARY)}var i=this.doReadData(e,t,r,l||{});if(i instanceof Kekule.ChemObject&&i.getSrcInfo){var n=i.getSrcInfo();n.data=e,n.dataType=t;var o=Kekule.IO.DataFormatsManager.getFormatInfo(r);o&&(n.format=r,n.mimeType=o.mimeType,n.possibleFileExts=o.fileExts)}return i},doReadData:function(e,t,r,l){}}),Kekule.IO.ChemDataWriter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.IO.ChemDataWriter",initialize:function(e){this.tryApplySuper("initialize")},writeData:function(e,t,r,l){if(!t){var a=Kekule.IO.DataFormatsManager.getFormatInfo(r);t=a?a.dataType:null}return this.doWriteData(e,t,r,l||{})},doWriteData:function(e,t,r,l){}}),Kekule.IO.ChemDataReaderManager={_readers:[],register:function(e,t,r,l){if(e&&t&&r&&(!DataType.isArrayValue(r)||r.length)){if(Kekule.IO.ChemDataReaderManager.getReaderInfoById(e))return Kekule.raise(Kekule.$L("ErrorMsg.READER_ID_ALREADY_EXISTS")),null;var a={id:e,readerClass:t,formatId:DataType.isArrayValue(r)?r:[r]};return a=Object.extend(a,l),Kekule.IO.ChemDataReaderManager._readers.push(a),a}},unregister:function(e){for(var t=-1,r=Kekule.IO.ChemDataReaderManager._readers,l=0,a=r.length;l<a;++l){if(r[l].id===e){t=l;break}}if(t>=0){var i=r[t];return r.splice(t,1),i}return null},getAllReadableFormatIds:function(){for(var e=[],t=Kekule.IO.ChemDataReaderManager._readers,r=0,l=t.length;r<l;++r){var a=t[r].formatId;Kekule.ArrayUtils.pushUnique(e,a)}return e},getAllReadableFormats:function(){for(var t=[],r=Kekule.IO.ChemDataReaderManager.getAllReadableFormatIds(),l=0,a=r.length;l<a;++l){var i=e.getFormatInfo(r[l]);i&&t.push(i)}return t},getAvailableReaderInfos:function(e){for(var t=[],r=Kekule.IO.ChemDataReaderManager._readers,l=r.length-1;l>=0;--l)Kekule.ObjUtils.match(r[l],e)&&t.push(r[l]);return t},getReaderInfo:function(e){for(var t=Kekule.IO.ChemDataReaderManager._readers,r=t.length-1;r>=0;--r)if(Kekule.ObjUtils.match(t[r],e))return t[r];return null},getReaderInfoById:function(e){return Kekule.IO.ChemDataReaderManager.getReaderInfo({id:e})},getReaderInfoByFormat:function(e,t){for(var r=Kekule.IO.ChemDataReaderManager._readers,l=r.length-1;l>=0;--l)if((!t||Kekule.ObjUtils.match(r[l],t))&&r[l].formatId.indexOf(e)>=0)return r[l];return null},getReaderInfoByFileExt:function(e,t){var r=Kekule.IO.DataFormatsManager.findFormatId(null,e);return r?Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(r,t):null},createReaderOfInfo:function(e){return new e.readerClass(e.createOptions)},getReaderOfInfo:function(e){return e.instance||(e.instance=Kekule.IO.ChemDataReaderManager.createReaderOfInfo(e)),e.instance},createReader:function(e){var t=Kekule.IO.ChemDataReaderManager.getReaderInfo(e);if(t)return Kekule.IO.ChemDataReaderManager.createReaderOfInfo(t)},getReader:function(e){var t=Kekule.IO.ChemDataReaderManager.getReaderInfo(e);if(t)return Kekule.IO.ChemDataReaderManager.getReaderOfInfo(t)},createReaderById:function(e){return Kekule.IO.ChemDataReaderManager.createReader({id:e})},getReaderById:function(e){return Kekule.IO.ChemDataReaderManager.getReader({id:e})},createReaderByFormat:function(e,t){var r=Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(e,t);return r?Kekule.IO.ChemDataReaderManager.createReaderOfInfo(r):null},getReaderByFormat:function(e,t){var r=Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(e,t);return r?Kekule.IO.ChemDataReaderManager.getReaderOfInfo(r):null},createReaderByFileExt:function(e,t){var r=Kekule.IO.ChemDataReaderManager.getReaderInfoByFileExt(e,t);return r?Kekule.IO.ChemDataReaderManager.createReaderOfInfo(r):null},getReaderByFileExt:function(e,t){var r=Kekule.IO.ChemDataReaderManager.getReaderInfoByFileExt(e,t);return r?Kekule.IO.ChemDataReaderManager.getReaderOfInfo(r):null},createReaderByMimeType:function(e){var t=Kekule.IO.DataFormatsManager.findFormatId(e,null);return t?Kekule.IO.ChemDataReaderManager.createReaderByFormat(t):null},getReaderByMimeType:function(e){var t=Kekule.IO.DataFormatsManager.findFormatId(e,null);return t?Kekule.IO.ChemDataReaderManager.getReaderByFormat(t):null}},Kekule.IO.ChemDataWriterManager={_writers:[],register:function(e,t,r,l,a){if(e&&t&&l&&(!DataType.isArrayValue(l)||l.length)){var i=Kekule.IO.ChemDataWriterManager.getWriterInfoById(e);if(i)return t===i.writerClass?(Kekule.ArrayUtils.pushUnique(i.srcClasses,r),Kekule.ArrayUtils.pushUnique(i.formatId,l),i):(Kekule.raise(Kekule.$L("ErrorMsg.WRITER_ID_ALREADY_EXISTS")),null);var n={id:e,writerClass:t,srcClasses:r,formatId:DataType.isArrayValue(l)?l:[l]};return n=Object.extend(n,a),Kekule.IO.ChemDataWriterManager._writers.push(n),n}},unregister:function(e){for(var t=-1,r=Kekule.IO.ChemDataWriterManager._writers,l=0,a=r.length;l<a;++l){if(r[l].id===e){t=l;break}}if(t>=0){var i=r[t];return r.splice(t,1),i}return null},getAllWritableFormatIds:function(){for(var e=[],t=Kekule.IO.ChemDataWriterManager._writers,r=0,l=t.length;r<l;++r){var a=t[r].formatId;Kekule.ArrayUtils.pushUnique(e,a)}return e},getAllWritableFormats:function(){for(var t=[],r=Kekule.IO.ChemDataWriterManager.getAllWritableFormatIds(),l=0,a=r.length;l<a;++l){var i=e.getFormatInfo(r[l]);i&&t.push(i)}return t},getAvailableWriterInfos:function(e,t){for(var r=[],l=ClassEx.isClass(t)?t:t.getClass?t.getClass():t?null:void 0,a=Kekule.IO.ChemDataWriterManager._writers,i=a.length-1;i>=0;--i)if(Kekule.ObjUtils.match(a[i],e))if(void 0!==l){if(l)for(var n=0,o=a[i].srcClasses.length;n<o;++n)ClassEx.isOrIsDescendantOf(l,a[i].srcClasses[n])&&r.push(a[i])}else r.push(a[i]);return r},getWriterInfo:function(e,t){for(var r=Kekule.IO.ChemDataWriterManager._writers,l=r.length-1;l>=0;--l)if(Kekule.ObjUtils.match(r[l],e)){if(t){for(var a=0,i=r[l].srcClasses.length;a<i;++a)if(t instanceof r[l].srcClasses[a])return r[l];return null}return r[l]}return null},getWriterInfoById:function(e,t){return Kekule.IO.ChemDataWriterManager.getWriterInfo({id:e},t)},getWriterInfoByFormat:function(e,t,r){for(var l=Kekule.IO.ChemDataWriterManager._writers,a=l.length-1;a>=0;--a)if((!t||Kekule.ObjUtils.match(l[a],t))&&l[a].formatId.indexOf(e)>=0){if(r){for(var i=0,n=l[a].srcClasses.length;i<n;++i)if(r instanceof l[a].srcClasses[i])return l[a];return null}return l[a]}return null},getWriterInfoByFileExt:function(e,t,r){var l=Kekule.IO.DataFormatsManager.findFormatId(null,e);return l?Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(l,t,r):null},createWriterOfInfo:function(e){return new e.writerClass(e.createOptions)},getWriterOfInfo:function(e){return e.instance||(e.instance=Kekule.IO.ChemDataWriterManager.createWriterOfInfo(e)),e.instance},createWriter:function(e,t){var r=Kekule.IO.ChemDataWriterManager.getWriterInfo(e,t);return r?Kekule.IO.ChemDataWriterManager.createWriterOfInfo(r):null},getWriter:function(e,t){var r=Kekule.IO.ChemDataWriterManager.getWriterInfo(e,t);return r?Kekule.IO.ChemDataWriterManager.getWriterOfInfo(r):null},createWriterById:function(e,t){return Kekule.IO.ChemDataWriterManager.createWriter({id:e},t)},getWriterById:function(e,t){return Kekule.IO.ChemDataWriterManager.getWriter({id:e},t)},createWriterByFormat:function(e,t,r){var l=Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(e,t,r);return l?Kekule.IO.ChemDataWriterManager.createWriterOfInfo(l):null},getWriterByFormat:function(e,t,r){var l=Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(e,t,r);return l?Kekule.IO.ChemDataWriterManager.getWriterOfInfo(l):null},createWriterByFileExt:function(e,t,r){var l=Kekule.IO.ChemDataWriterManager.getWriterInfoByFileExt(e,t,r);return l?Kekule.IO.ChemDataWriterManager.createWriterOfInfo(l):null},getWriterByFileExt:function(e,t,r){var l=Kekule.IO.ChemDataWriterManager.getWriterInfoByFileExt(e,t,r);return l?Kekule.IO.ChemDataWriterManager.getWriterOfInfo(l):null},createWriterByMimeType:function(e,t){var r=Kekule.IO.DataFormatsManager.findFormatId(e,null);return r?Kekule.IO.ChemDataWriterManager.createWriterByFormat(r,null,t):null},getWriterByMimeType:function(e){var t=Kekule.IO.DataFormatsManager.findFormatId(e,null);return t?Kekule.IO.ChemDataWriterManager.getWriterByFormat(t,null):null}},Kekule.IO.loadFormatData=function(e,t,r){var l=Kekule.IO.ChemDataReaderManager.getReaderByFormat(t);if(l){var a=l.readData(e,null,t,r);if(!1===a){var i=Kekule.$L("ErrorMsg.FAIL_TO_READ_FORMAT")+t;Kekule.raise(i)}return a}i=Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FORMAT")+t;return Kekule.raise(i),null},Kekule.IO.loadMimeData=function(e,t,r){return Kekule.IO.loadTypedData(e,t,null,r)},Kekule.IO.loadTypedData=function(e,t,r,l){var a;r&&(a=Kekule.UrlUtils.extractFileExt(r));var i,n=Kekule.IO.DataFormatsManager.findFormatId(t||null,a);if(n&&(i=Kekule.IO.loadFormatData(e,n,l)),!1!==i){if(i instanceof Kekule.ChemObject&&i.getSrcInfo){var o=i.getSrcInfo();t&&(o.mimeType=t),a&&(o.fileExt=a),r&&(o.url=r,o.fileName=r)}return i}var u=t?Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_MIMETYPE")+t:Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FILEEXT")+a;return Kekule.raise(u),null},Kekule.IO.loadFileData=function(e,t,r,l){if(Kekule.BrowserFeature.fileapi){var a,i=e.name,n=Kekule.UrlUtils.extractFileExt(i);if(!(a=r?Kekule.IO.DataFormatsManager.getFormatInfo(r):Kekule.IO.DataFormatsManager.findFormat(null,n))){var o=Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FILEEXT")+n;return void Kekule.raise(o)}var u=Kekule.IO.ChemDataType.isBinaryType(a.dataType),s=new FileReader;s.onload=function(e){var r=s.result,n=Kekule.IO.loadFormatData(r,a.id,l);n&&n.getSrcInfo&&(n.getSrcInfo().fileName=i);t(n,!1!==n,r)},u?s.readAsArrayBuffer(e):s.readAsText(e)}else Kekule.error(Kekule.$L("ErrorMsg.FILE_API_NOT_SUPPORTED"))},Kekule.IO.loadUrlData=function(e,t,r,l){if(!Kekule.Ajax)return Kekule.raise(Kekule.$L("ErrorMsg.AJAX_FILELOADER_NOT_FOUND")),null;Kekule.Ajax.sendRequest(e,function(a,i,n){if(a&&n){var o;if(r&&(o=Kekule.IO.DataFormatsManager.getFormatInfo(r)),!r){var u=Kekule.Ajax.getResponseMimeType(i);o=Kekule.IO.DataFormatsManager.findFormat(u)}if(!r){var s=Kekule.UrlUtils.extractFileExt(e);o=Kekule.IO.DataFormatsManager.findFormat(null,s)}if(!o){var d=Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FILEEXT")+s;return void Kekule.raise(d)}var m=Kekule.IO.loadFormatData(a,o.id,l);m.getSrcInfo().fileName=e,t(m,n=!1!==m,a)}else Kekule.raise(Kekule.$L("ErrorMsg.FAIL_TO_LOAD_FILE_URL")+e)})},Kekule.IO.saveFormatData=function(e,t,r){var l=Kekule.IO.ChemDataWriterManager.getWriterByFormat(t,null,e);if(l)return l.writeData(e,null,t,r);var a=Kekule.$L("ErrorMsg.NO_SUITABLE_WRITER_FOR_FORMAT")+t;return Kekule.raise(a),null},Kekule.IO.saveMimeData=function(e,t,r){return Kekule.IO.saveTypedData(e,t,null,r)},Kekule.IO.saveTypedData=function(e,t,r,l){var a;r&&((a=Kekule.UrlUtils.extractFileExt(r))||(a=r));var i,n=Kekule.IO.DataFormatsManager.findFormatId(t||null,a);if(n&&(i=Kekule.IO.saveFormatData(e,n,l)),Kekule.ObjUtils.isUnset(i)){var o=t?Kekule.$L("ErrorMsg.NO_SUITABLE_WRITER_FOR_MIMETYPE")+t:Kekule.$L("ErrorMsg.NO_SUITABLE_WRITER_FOR_FILEEXT")+a;return Kekule.raise(o),null}return i}}(),function(){"use strict";Kekule.globalOptions.add("IO.cml",{prettyPrint:!0,enableReadRootObjList:!0,defaultRootObjListHolder:Kekule.ChemSpace}),Kekule.IO.CML={CML2CORE_NAMESPACE_URI:"http://www.xml-cml.org/schema/cml2/core",CML3_SCHEMA_NAMESPACE_URI:"http://www.xml-cml.org/schema",ARRAY_VALUE_DELIMITER:" ",TYPED_ELEM_NAMES:["string","integer","float"],TYPED_ARRAY_ELEM_NAMES:["stringArray","integerArray","floatArray"],ATOMS_REF_ATTRIBS:["atomRef","atomRefs2","atomRefs3","atomRefs4","atomRefs","atomRefArray"],BONDS_REF_ATTRIBS:["bondRef","bondRefs","bondRefArray"],MOL_REF_ATTRIBS:["moleculeRef","moleculeRefs"],DEFAULT_VALUE_DELIMITER_PATTERN:/\s+/gm},Kekule.IO.CML.LEGAL_CORE_NAMESPACE_URIS=[Kekule.IO.CML.CML2CORE_NAMESPACE_URI,Kekule.IO.CML.CML3_SCHEMA_NAMESPACE_URI],Kekule.IO.CmlUtils={_cmlUnitConvMap:[["m","m","m",!0],["second","s","sec",!0],["hour","h","hr",!1],["kg","kg","kg",!0],["k","K","K",!0],["mol","mol","mol",!0],["candela","cd","cd",!0],["radian","rad","rad",!0],["steradian","sr","sr",!0],["hertz","Hz","Hz",!0],["newton","N","N",!0],["joule","J","J",!0],["watt","W","W",!0],["pascal","Pa","Pa",!0],["coulomb","C","C",!0],["volt","V","V",!0],["ampere","A","A",!0],["ohm","[Omega]","Ω",!0],["farad","F","F",!0],["siemens","S","S",!0],["weber","Wb","Wb",!0],["tesla","T","T",!0],["henry","H","H",!0],["becquerel","Bq","Bq",!0],["gray","Gy","Gy",!0],["sievert","Sv","Sv",!0],["katal","kat","kat",!0],["molarity","_i_M__i_","mol/L",!0],["molality","_i_m__i_","mol/kg",!0],["m2","m2","m2",!0],["m3","m3","m3",!0],["m.s-1","m.s-1","m/s",!0],["m.s-2","m.s-2","m·s-2",!0],["rad.s-1","rad.s-1","rad/s",!0],["n.s","N.s","N·s",!0],["n.m.s","N.m.s","N·m·s",!0],["n.m","N.m","N·m",!0],["m-1","m-1","m-1",!0],["kg.m-3","kg.m-3","kg·m-3",!0],["kg-1.m3","kg-1.m3","kg-1·m3",!0],["m-3.mol","m-3.mol","m-3·mol",!0],["m3.mol-1","m3.mol-1","m3/mol",!0],["j.k-1","J.K-1","J/K",!0],["j.k-1.mol-1","J.K-1.mol-1","J·K-1·mol-1",!0],["j.k-1.kg-1","J.K-1.kg-1","J·K-1·kg-1",!0],["j.mol-1","J.mol-1","J/mol",!0],["j.kg-1","J.kg-1","J/kg",!0],["j.m-3","J.m-3","J·m-3",!0],["n.m-1","N.m-1 = J.m-2","N/m",!0],["w.m-2","W.m-2","W·m-2",!0],["w.m-1.k-1","W.m-1.K-1","W·m-1·K-1",!0],["m2.s-1","m2.s-1","m2/s",!0],["pa.s","Pa.s","Pa·s",!0],["pa.s","N.s.m-2","Pa·s",!0],["c.m-3","C.m-3","C·m-3",!0],["a.m-2","A.m-2","A·m-2",!0],["s.m-1","S.m-1","S/m",!0],["s.m2.mol-1","S.m2.mol-1","S·m2/mol",!0],["f.m-1","F.m-1","F/m",!0],["h.m-1","H.m-1","H/m",!0],["v.m-1","V.m-1","V/m",!0],["a.m-1","A.m-1","A/m",!0],["cd.m-2","cd.m-2","cd·m-2",!0],["c.kg-1","C.kg-1","C/kg",!0],["gy.s-1","Gy.s-1","Gy/s",!0],["j.m-1","J.m-1","J/m",!0],["ang","[Aring]","Å",!1],["deg","[deg]","deg",!1],["ang3","A3","Å3",!1],["celsius","[deg]C","℃",!1],["debye","D","D",!1],["electron","e","e",!1],["hartree","hart","hart",!1],["gpa","GPa","GPa",!1],["gpa-1","GPa-1","GPa-1",!1],["atmosphere","atm","atm",!1],["kcal.mol-1.ang-1","kcal mol-1 ang-1","kcal·mol-1·ang-1",!1],["kj.mol-1","kj mol-1","kj/mol",!1],["l","L","L",!1],["ml","mL","mL",!1],["kcal.ang-1","kcal.ang-1","kcal/Å",!1],["kcal.rad-1","kcal.rad-1","kcal/rad",!1],["ph","pH","pH",!1],["centipoise","cp","cp",!1],["km.s-1","km/s","km/s",!1],["arbitrary","arb","arb",!1]],tryParseFloat:function(e){var t=parseFloat(e);return Kekule.NumUtils.isNormalNumber(t)?t:e},convertSimpleValueByDataType:function(e,t,r){var l;switch(t){case"xsd:boolean":l=Kekule.StrUtils.strToBool(e);break;case"xsd:float":case"xsd:double":case"xsd:duration":case"xsd:decimal":l=parseFloat(e);break;case"xsd:integer":case"xsd:nonPositiveInteger":case"xsd:negativeInteger":case"xsd:long":case"xsd:int":case"xsd:short":case"xsd:byte":case"xsd:nonNegativeInteger":case"xsd:unsignedLong":case"xsd:unsignedInt":case"xsd:unsignedShort":case"xsd:unsignedByte":case"xsd:positiveInteger":l=parseInt(e);break;default:l=e}return l},getCmlTypeForDataType:function(e){return e==DataType.INT?"xsd:integer":e==DataType.FLOAT?"xsd:float":e==DataType.BOOL?"xsd:boolean":null},cmlNsTokenToKekule:function(e){return e.replace(/\:/g,".")},kekuleNsTokenToCml:function(e){return e.replace(/\./g,":")},getCmlNsValueDetails:function(e){var t=e.indexOf(":");return{namespace:t>=0?e.substring(0,t):"",localName:t>=0?e.substr(t+1):e}},getCmlNsValueLocalPart:function(e){var t=e.indexOf(":");return t>=0?e.substr(t+1):e},cmlUnitStrToMetricsUnitSymbol:function(e){for(var t,r,l=Kekule.IO.CmlUtils.getCmlNsValueLocalPart(e),a=l.toLowerCase(),i=a.length>3&&a.endsWith("s")?a.substr(0,a.length-1):null,n=(Kekule.Unit,Kekule.IO.CmlUtils._cmlUnitConvMap),o=0,u=n.length;o<u;++o)if(l===n[o][0]||l===n[o][1]){t=n[o][2];break}if(!t)for(o=0,u=n.length;o<u;++o)if(a===n[o][0].toLowerCase()||a===n[o][1].toLowerCase()){t=n[o][2];break}if(!t&&i)for(o=0,u=n.length;o<u;++o)if(i===n[o][0].toLowerCase()||i===n[o][1].toLowerCase()){t=n[o][2];break}t||(t=(r=Kekule.Unit.getUnit(l,!0))&&r.symbol);t||(t=(r=Kekule.Unit.getUnitByName(l,!0))&&r.symbol);!t&&i&&(t=(r=Kekule.Unit.getUnitByName(i,!0))&&r.symbol);return t||l},metricsUnitSymbolToCmlUnitStr:function(e){for(var t,r=Kekule.IO.CmlUtils._cmlUnitConvMap,l=0,a=r.length;l<a;++l){var i=r[l];if(e===i[2]){t=(i[3]?"siUnits:":"units:")+i[0];break}}return t||(t="units:"+e),t},cmlBondOrderToKekule:function(e){var t=parseInt(e);if(t!=t)switch(e.toUpperCase()){case"A":t=Kekule.BondOrder.EXPLICIT_AROMATIC;break;case"D":t=Kekule.BondOrder.DOUBLE;break;case"T":t=Kekule.BondOrder.TRIPLE;break;case"S":default:t=Kekule.BondOrder.SINGLE}return t},kekuleBondOrderToCml:function(e){switch(e){case Kekule.BondOrder.EXPLICIT_AROMATIC:return"A";case Kekule.BondOrder.QUAD:return"4";case Kekule.BondOrder.DOUBLE:return"D";case Kekule.BondOrder.TRIPLE:return"T";default:return"S"}},cmlBondStereoToKekule:function(e){var t;switch(e.toUpperCase()){case"E":t=Kekule.BondStereo.E;break;case"Z":t=Kekule.BondStereo.Z;break;case"C":t=Kekule.BondStereo.CIS;break;case"T":t=Kekule.BondStereo.TRANS;break;case"W":t=Kekule.BondStereo.UP;break;case"H":t=Kekule.BondStereo.DOWN;break;default:t=Kekule.BondStereo.NONE}return t},kekuleBondStereoToCml:function(e){switch(e){case Kekule.BondStereo.UP:return{value:"W"};case Kekule.BondStereo.UP_INVERTED:return{value:"W",invert:!0};case Kekule.BondStereo.DOWN:return{value:"H"};case Kekule.BondStereo.DOWN_INVERTED:return{value:"H",invert:!0};case Kekule.BondStereo.E:return{value:"E"};case Kekule.BondStereo.Z:return{value:"Z"};case Kekule.BondStereo.CIS:return{value:"C"};case Kekule.BondStereo.TRANS:return{value:"T"};default:return{value:null}}},reagentRoleToKekule:function(e){var t=Kekule.ReactionRole;switch(e){case"reagent":return t.REAGENT;case"catalyst":case"solvent":return t.CATALYST;default:return e}},kekuleReagentRoleToCml:function(e){var t=Kekule.ReactionRole;switch(e){case t.REAGENT:return"reagent";case t.CATALYST:return"catalyst";case t.SOLVENT:return"solvent";default:return e}},isDummyElementType:function(e){return"Du"==e||"Dummy"==e},isRGroupElementType:function(e){return"R"==e},isAtomListElementType:function(e){return"L"==e},getNodeElementType:function(e){if(e instanceof Kekule.Atom)return e.getSymbol();if(!(e instanceof Kekule.Pseudoatom))return e instanceof Kekule.VariableAtom?"R":e instanceof Kekule.StructureFragment?"R":e.getSymbol?e.getSymbol():"*";switch(e.getAtomType()){case Kekule.PseudoatomType.DUMMY:return"Du";case Kekule.PseudoatomType.ANY:return"A";case Kekule.PseudoatomType.HETERO:return"Q";case Kekule.PseudoatomType.CUSTOM:default:return e.getSymbol()}},createNodeByCmdElementType:function(e,t,r){return Kekule.IO.CmlUtils.isDummyElementType(t)?new Kekule.Pseudoatom(e,Kekule.PseudoatomType.DUMMY):Kekule.IO.CmlUtils.isRGroupElementType(t)?new Kekule.RGroup(e):Kekule.IO.CmlUtils.isAtomListElementType(t)?new Kekule.VariableAtom(e):Kekule.Element.isElementSymbolAvailable(t)||t==Kekule.Element.UNSET_ELEMENT?new Kekule.Atom(e,t,Math.round(r)):new Kekule.Pseudoatom(e,Kekule.PseudoatomType.CUSTOM,t)}};var e=Kekule.IO.CmlUtils;Kekule.IO.CmlDomUtils={splitCmlArrayValue:function(e){return"object"==typeof e&&e.length?e:Kekule.StrUtils.normalizeSpace(Kekule.StrUtils.trim(e)).split(Kekule.IO.CML.ARRAY_VALUE_DELIMITER)},mergeToCmlArrayValue:function(e){return e.join(" ")},analysisCmlFormulaConciseValue:function(e){for(var t,r=Kekule.IO.CmlDomUtils.splitCmlArrayValue(e),l=0,a=r.length,i=[],n=null;l<a;){var o=r[l],u=parseFloat(o);u!=u?(n&&i.push(n),n={elementType:o}):n?(n.count=u,i.push(n),n=null):l==a-1&&(t=u),++l}return{isotopes:i,formalCharge:t}},getCmlBuiltinElemInfo:function(e,t,r){var l=e.getAttribute("builtin");return!l&&t&&(e.getAttributeNS?l=e.getAttributeNS(t,"builtin"):r&&(l=r.getAttributeNS(t,"builtin",e))),l?{name:l,value:Kekule.DomUtils.getElementText(e)}:null},readCmlTypedPropertyElem:function(e,t,r){var l;if(!(l=e.getAttribute("builtin"))&&t&&(e.getAttributeNS?l=e.getAttributeNS(t,"builtin"):r&&(l=r.getAttributeNS(t,"builtin",e))),l){var a=Kekule.DomUtils.getElementText(e);switch(Kekule.DomUtils.getLocalName(e)){case"float":a=parseFloat(a);break;case"integer":a=parseInt(a)}return{name:l,value:a}}return null},readCmlTypedPropertyArrayElem:function(e,t,r){var l;if(!(l=e.getAttribute("builtin"))&&t&&(e.getAttributeNS?l=e.getAttributeNS(t,"builtin"):r&&(l=r.getAttributeNS(t,"builtin",e))),l){var a=Kekule.DomUtils.getElementText(e),i=Kekule.IO.CmlDomUtils.splitCmlArrayValue(a);switch(Kekule.DomUtils.getLocalName(e)){case"float":for(var n=0,o=i.length;n<o;++n)i[n]=parseFloat(i[n]);break;case"integer":for(n=0,o=i.length;n<o;++n)i[n]=parseInt(i[n])}return{name:l,values:i}}return null},hasDirectCmlTypedElemChildren:function(e,t){for(var r=0,l=Kekule.IO.CML.TYPED_ELEM_NAMES.length;r<l;++r){var a=Kekule.IO.CML.TYPED_ELEM_NAMES[r];if(Kekule.DomUtils.getDirectChildElems(e,null,a,t).length>0)return!0}return!1},hasDirectCmlTypedArrayElemChildren:function(e,t){for(var r=0,l=Kekule.IO.CML.TYPED_ARRAY_ELEM_NAMES.length;r<l;++r){var a=Kekule.IO.CML.TYPED_ARRAY_ELEM_NAMES[r];if(Kekule.DomUtils.getDirectChildElems(e,null,a,t).length>0)return!0}return!1},isCmlTypedElem:function(e,t){var r=Kekule.IO.CML.TYPED_ELEM_NAMES.indexOf(Kekule.DomUtils.getLocalName(e))>=0;return t&&(r=r&&e.namespaceURI==t),r},isCmlTypedArrayElem:function(e,t){var r=Kekule.IO.CML.TYPED_ARRAY_ELEM_NAMES.indexOf(Kekule.DomUtils.getLocalName(e))>=0;return t&&(r=r&&e.namespaceURI==t),r},isCmlBuiltInMarkedElem:function(e,t){var r=Kekule.DomUtils.hasAttribute(e,"builtin");return t&&r&&(r=e.namespaceURI===t),r},FILTER_TYPED_ELEM:1,FILTER_TYPEDARRAY_ELEM:2,FILTER_ALL:3,getCmlTypedElem:function(e,t,r){var l=e.namespaceURI,a=Kekule.DomUtils.getDirectChildElemsOfAttribValues(e,[{builtin:t}],null,null,l);if(a&&a.length>0)for(var i=a.length-1;i>=0;--i){if(r&Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM&&Kekule.IO.CmlDomUtils.isCmlTypedElem(a[i],l))return a[i];if(r&Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM&&Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(a[i],l))return a[i]}return null},getCmlTypedElems:function(e,t,r){var l=[],a=e.namespaceURI,i=Kekule.DomUtils.getDirectChildElemsOfAttribValues(e,[{builtin:t}],null,null,a);if(i&&i.length>0)for(var n=i.length-1;n>=0;--n)r&Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM&&Kekule.IO.CmlDomUtils.isCmlTypedElem(i[n],a)?l.push(i[n]):r&Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM&&Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(i[n],a)&&l.push(i[n]);return l.length?l:null},getCmlTypedElemValue:function(e,t,r,l){r||(r=Kekule.IO.CmlDomUtils.FILTER_ALL);var a=Kekule.IO.CmlDomUtils.getCmlTypedElem(e,t,r);if(a)return Kekule.DomUtils.getElementText(a)},getMultipleCmlTypedElemValues:function(e,t,r,l){r||(r=Kekule.IO.CmlDomUtils.FILTER_ALL);var a=Kekule.IO.CmlDomUtils.getCmlTypedElems(e,t,r);if(a){for(var i=[],n=0,o=a.length;n<o;++n)i.push(Kekule.DomUtils.getElementText(a[n]));return i}return null},getCmlElemAttribute:function(e,t,r,l){r||(r=Kekule.IO.CmlDomUtils.FILTER_ALL);var a=Kekule.DomUtils.getSameNSAttributeValue(e,t,l);return a||(a=Kekule.IO.CmlDomUtils.getCmlTypedElemValue(e,t,r,l)),a},getMultipleCmlElemAttribute:function(e,t,r,l){r||(r=Kekule.IO.CmlDomUtils.FILTER_ALL);var a=Kekule.DomUtils.getSameNSAttributeValue(e,t,l);return a||(a=Kekule.IO.CmlDomUtils.getMultipleCmlTypedElemValues(e,t,r,l)),a},setCmlElemAttribute:function(e,t,r,l){return Kekule.DomUtils.setSameNSAttributeValue(e,t,r,l)},fetchCmlElemAttributeValuesToJson:function(e,t,r,l){t||(t=Kekule.IO.CmlDomUtils.FILTER_ALL);for(var a=e.namespaceURI,i=Kekule.DomUtils.fetchAttributeValuesToJson(e,a,!0),n=Kekule.DomUtils.getDirectChildElems(e,null,null,a),o=0,u=n.length;o<u;++o){var s=n[o];if(t&Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM&&(Kekule.IO.CmlDomUtils.isCmlTypedElem(s,a)||Kekule.IO.CmlDomUtils.isCmlBuiltInMarkedElem(s,a)))(d=Kekule.IO.CmlDomUtils.readCmlTypedPropertyElem(s,a,l))&&(i[d.name]&&r?i[d.name]+=Kekule.IO.CML.ARRAY_VALUE_DELIMITER+d.value:i[d.name]=d.value);else if(t&Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM&&Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(s,a)){var d;(d=Kekule.IO.CmlDomUtils.getCmlBuiltinElemInfo(s,a,l))&&(i[d.name]&&r?i[d.name]+=Kekule.IO.CML.ARRAY_VALUE_DELIMITER+d.value:i[d.name]=d.value)}}return i},isScalarElem:function(e,t){var r="scalar"==Kekule.DomUtils.getLocalName(e);return t&&(r=r&&e.namespaceURI==t),r},getCmlId:function(e,t){return Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"id",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,t)},setCmlId:function(e,t,r){return Kekule.IO.CmlDomUtils.setCmlElemAttribute(e,"id",t,r)},getCmlTitle:function(e,t){return Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"title",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,t)},setCmlTitle:function(e,t,r){return Kekule.IO.CmlDomUtils.setCmlElemAttribute(e,"title",t,r)}};var t=Kekule.IO.CmlDomUtils;Kekule.IO.CmlElementReaderFactory={_readers:{},register:function(e,t){if(Kekule.ArrayUtils.isArray(e))for(var r=0,l=e.length;r<l;++r)Kekule.IO.CmlElementReaderFactory.register(e[r],t);else Kekule.IO.CmlElementReaderFactory._readers[e.toLowerCase()]=t},getReader:function(e){var t;t="string"!=typeof e?Kekule.DomUtils.getLocalName(e):e;var r=Kekule.IO.CmlElementReaderFactory._readers[t.toLowerCase()];return r?new r:null}},Kekule.IO.CmlElementWriterFactory={_writers:{},register:function(e,t){if(Kekule.ArrayUtils.isArray(e))for(var r=0,l=e.length;r<l;++r)Kekule.IO.CmlElementWriterFactory.register(e[r],t);else Kekule.IO.CmlElementWriterFactory._writers[e]=t},getWriter:function(e){var t;t="string"!=typeof e?DataType.getType(e):e;var r=Kekule.IO.CmlElementWriterFactory._writers[t];if(!r&&e.getClassName)for(var l=e,a=Kekule.ObjUtils.getOwnedFieldNames(Kekule.IO.CmlElementWriterFactory._writers),i=a.length-1;i>=0;--i){var n=ClassEx.findClass(a[i]);if(n&&l instanceof n){r=Kekule.IO.CmlElementWriterFactory._writers[a[i]];break}}return r?new r:null}},Kekule.IO.CmlElementHandler=Class.create(ObjectEx,{CLASS_NAME:"Kekule.IO.CmlElementHandler",initialize:function(){this.tryApplySuper("initialize"),this._childHandlers=[]},doFinalize:function(){for(var e=this._childHandlers.length-1;e>=0;--e){var t=this._childHandlers[e];t&&t.finalize&&t.finalize()}this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("domHelper",{dataType:"Kekule.DomHelper",serializable:!1,getter:function(){return this.getPropStoreFieldValue("domHelper")||this.setPropStoreFieldValue("domHelper",new Kekule.DomHelper),this.getPropStoreFieldValue("domHelper")}}),this.defineProp("coreNamespaceURI",{dataType:DataType.STRING,serializable:!1}),this.defineProp("namespaces",{dataType:DataType.ARRAY,serializable:!1}),this.defineProp("rootEvoker",{dataType:DataType.Object,serializable:!1})},getPrefixForNamespaceUri:function(e){var t=this.getNamespaces();if(t)for(var r=0,l=t.length;r<l;++r)if(t[r].namespaceURI===e)return t[r].prefix},matchCoreNamespace:function(e){var t;return t=e?"string"!=typeof e?e.namespaceURI:e:"",!this.getCoreNamespaceURI()&&!t||this.getCoreNamespaceURI()&&this.getCoreNamespaceURI()==t},copySettingsToChildHandler:function(e){e.setDomHelper(this.getDomHelper()),e.setCoreNamespaceURI(this.getCoreNamespaceURI()),e.setNamespaces(this.getNamespaces()),e.setRootEvoker(this.getRootEvoker())},_appendChildHandler:function(e){Kekule.ArrayUtils.pushUnique(this._childHandlers,e)},_iterateChildHandlers:function(e,t,r){if(e)for(var l=0,a=this._childHandlers.length;l<a;++l){var i=this._childHandlers[l];i&&(e.apply(t,[i]),r&&i._iterateChildHandlers&&i._iterateChildHandlers(e,t,r))}}}),Kekule.IO.CmlElementReader=Class.create(Kekule.IO.CmlElementHandler,{CLASS_NAME:"Kekule.IO.CmlElementReader",readElement:function(e,t,r,l){var a=this.doReadElement(e,t,r,l);if(a&&a.getId&&!a.getId()&&a.setId){var i=Kekule.IO.CmlDomUtils.getCmlId(e,this.getDomHelper);i&&this.setObjId(a,i)}return a},doReadElement:function(e,t,r,l){},readChildElement:function(e,t,r){return this.doReadChildElement(e,t,r)},doReadChildElement:function(e,t,r){return this.doReadChildElementDef(e,t,r)},readChildElementDef:function(e,t,r){return this.doReadChildElementDef(e,t,r)},doReadChildElementDef:function(e,t,r){var l=this.doGetChildElementReader(e,t,r);if(!l)return null;try{return l.readElement(e,t,r)}finally{}},doGetChildElementReader:function(e,t,r){var l=Kekule.IO.CmlElementReaderFactory.getReader(e);return l&&(this.copySettingsToChildHandler(l),this._appendChildHandler(l)),l},iterateChildElements:function(e,t,r,l){for(var a=[],i=Kekule.DomUtils.getDirectChildElems(e,null,null,this.getCoreNamespaceURI()),n=0,o=i.length;n<o;++n){var u=this.readChildElement(i[n],t,r);u&&(a.push({element:i[n],result:u}),l&&l(i[n],u,t,r))}return a},doneReadingDocument:function(e){this.doDoneReadingDocument(),e&&this._iterateChildHandlers(function(t){t&&t.doneReadingDocument&&t.doneReadingDocument(e)})},doDoneReadingDocument:function(){},getLoadedObjById:function(e){var t=this.getRootEvoker();return t&&t.getLoadedObjById&&t.getLoadedObjById(e)},setObjIdMapValue:function(e,t){var r=this.getRootEvoker();r.setObjIdMapValue&&r.setObjIdMapValue(e,t)},setObjId:function(e,t){e.setId&&e.setId(t);var r=e.getId&&e.getId();r&&this.setObjIdMapValue(r,e)},_createChildObjsHolder:function(e,t){for(var r=new t,l=0,a=e.length;l<a;++l)r.appendChild(e[l]);return r}}),Kekule.IO.CmlElementWriter=Class.create(Kekule.IO.CmlElementHandler,{CLASS_NAME:"Kekule.IO.CmlElementWriter",writeObject:function(e,t,r){if(!t&&!l)return Kekule.error(Kekule.$L("ErrorMsg.CML_CAN_NOT_OUTPUT_TO_EMPTY_ELEMENT")),null;var l=t.ownerDocument;this.getDomHelper().getDocument!=l&&this.getDomHelper().setDocument(l);var a=this.doCreateElem(e,t,l);a?t.appendChild(a):a=t;var i=this.doWriteObject(e,a,r)||a;return i&&e&&(this.writeObjId(e,i),this.writeObjAdditionalInfo(e,i,r)),i},writeObjId:function(e,t){if(e.getId){var r=e.getId();!r&&e.setId&&(r=this.autoIdentifyForObj(e)),Kekule.IO.CmlDomUtils.setCmlId(t,r,this.getDomHelper())}},autoIdentifyForObj:function(e){return e.getId&&!e.getId()&&e.setId&&(e.getOwner&&e.getOwner()&&e.getOwner().getAutoId?e.setId(e.getOwner().getAutoId(e)):e.setId(this.getAutoIdForObj(e))),e.getId&&e.getId()},getAutoIdForObj:function(e){var t=e.getAutoIdPrefix?e.getAutoIdPrefix():"obj";return Kekule.IO.CmlElementWriter._UID_SEED||(Kekule.IO.CmlElementWriter._UID_SEED=(new Date).getTime()),++Kekule.IO.CmlElementWriter._UID_SEED,""+t+Kekule.IO.CmlElementWriter._UID_SEED.toString()},writeScalarAttribs:function(e,t,r){if(e.getScalarAttribs){var l=this.doGetChildObjectWriter("Kekule.Scalar");if(l)for(var a=0,i=e.getScalarAttribCount();a<i;++a)l.writeObject(e.getScalarAttribAt(a),t,r)}},writeObjInfoValues:function(e,t,r){if(e.getInfo){var l,a=this.getObjInfoKeysNeedToSaveToMetaList(e);if(!a||!a.length)return;for(var i=0,n=a.length;i<n;++i){var o=a[i],u=e.getInfoValue(a[i]);o&&u&&!Kekule.IO.CmlDomUtils.getCmlElemAttribute(t,o,this.getDomHelper())&&(l||(l=this.getOrCreateChildElem("metaDataList",t)),this.doWriteObjInfoValueItem(o,u,e,l,r))}}},doWriteObjInfoValueItem:function(e,t,r,l,a){return this.writeObjMetaValueToListElem(r,e,null,t,l)},writeObjMetaValueToListElem:function(e,t,r,l,a,i,n){i||(i="metaData");var o=this.createChildElem(i,a);return Kekule.IO.CmlDomUtils.setCmlElemAttribute(o,"name",t,this.getDomHelper()),Kekule.IO.CmlDomUtils.setCmlElemAttribute(o,"content",DataType.StringUtils.serializeValue(r),this.getDomHelper()),l&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(o,"metadataType",l,this.getDomHelper()),o},getObjInfoKeysNeedToSaveToMetaList:function(e){return e.getInfoKeys?e.getInfoKeys():null},writeObjAdditionalInfo:function(e,t,r){this.writeScalarAttribs(e,t,r),this.writeObjInfoValues(e,t,r)},doCreateElem:function(e,t){},createChildElem:function(e,t,r){var l=r||this.getCoreNamespaceURI(),a=this.getDomHelper().createElementNS(l,e);return t&&t.appendChild(a),a},getOrCreateChildElem:function(e,t,r){var l=this.getDomHelper().getElementsByTagNameNS(r,e,t)[0];return l||(l=this.createChildElem(e,t,r)),l},doWriteObject:function(e,t,r){},doGetChildObjectWriter:function(e,t,r){var l=Kekule.IO.CmlElementWriterFactory.getWriter(e);return l&&(this.copySettingsToChildHandler(l),this._appendChildHandler(l)),l},reportTypeMismatchError:function(e){Kekule.error(Kekule.$L("ErrorMsg.CML_ELEM_WRITER_TYPE_INPROPER").format(this.getClassName(),DataType.getType(e)))},addNamespace:function(e,t,r,l){this.getDomHelper().addNamespace(e,t,r,l)},addNamespaces:function(e,t,r){for(var l=0,a=t.length;l<a;++l)this.addNamespace(e,t[l].prefix,t[l].namespaceURI,r)},doneWritingDocument:function(e){this.doDoneWritingDocument(),e&&this._iterateChildHandlers(function(t){t&&t.doneWritingDocument&&t.doneWritingDocument(e)})},doDoneWritingDocument:function(){}}),Kekule.IO.CmlBaseListReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlBaseListReader",doReadElement:function(e,t,r,l){var a=this.doCreateList(e);return a=this.doReadList(a,e,t,r,this.getDomHelper())},doCreateList:function(e){return[]},doAppendObjToList:function(e,t){return t&&t.push&&t.push(e),t},doReadChildElem:function(e,t,r,l,a){return t.readElement(e,a,this)},doReadList:function(e,t,r,l,a){var i=Kekule.DomUtils.getDirectChildElems(t,null,null,this.getCoreNamespaceURI());if(i)for(var n=0,o=i.length;n<o;++n){var u=i[n],s=this.doGetChildElementReader(u,r,this);if(s){var d=this.doReadChildElem(u,s,r,l,e);d&&this.doAppendObjToList(d,e)}}return e}}),Kekule.IO.CmlBaseListWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlBaseListWriter",doCreateElem:function(e,t){var r=this.doGetListElemTagName(e,t);return r?this.createChildElem(r,t):null},doGetListElemTagName:function(e,t){return"list"},doWriteObject:function(e,t,r){var l=Kekule.ChemStructureUtils.getChildStructureObjs(e,!1);return this.writeList(l,t,r)},writeList:function(e,t,r){for(var l=0,a=e.length;l<a;++l){var i=e[l];if(i){var n=this.doGetChildObjectWriter(i);n&&n.writeObject(i,t,r)}}return t}}),Kekule.IO.CmlNameReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlNameReader",initialize:function(){this.tryApplySuper("initialize")},doReadElement:function(e,t,r,l){var a=Kekule.DomUtils.getElementText(e),i=Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"convention");if(a){var n={};return n.name=a,i?n.convention=i:t&&t.setName&&t.setName(a),n}return null}}),Kekule.IO.CmlScalarReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlScalarReader",doReadElement:function(e,t,r,l){var a=this.readScalar(e);return t&&t.appendScalarAttrib&&t.appendScalarAttrib(a),a},readScalar:function(e){var t,r=Kekule.DomUtils.fetchAttributeValuesToJson(e,this.getCoreNamespaceURI(),!0);if((o=Kekule.DomUtils.getElementText(e))&&(r.value=o),r.value&&(r.dataType?(r.value=Kekule.IO.CmlUtils.convertSimpleValueByDataType(r.value,r.dataType),r.errorValue&&(r.errorValue=Kekule.IO.CmlUtils.convertSimpleValueByDataType(r.errorValue,r.dataType,!0))):r.value=Kekule.IO.CmlUtils.tryParseFloat(r.value)),r){t=new Kekule.Scalar;for(var l=Kekule.ObjUtils.getOwnedFieldNames(r),a=0,i=l.length;a<i;++a){var n=l[a],o=r[n];switch(n){case"value":t.setValue(o);break;case"errorValue":t.setErrorValue(o);break;case"units":t.setUnit(Kekule.IO.CmlUtils.cmlUnitStrToMetricsUnitSymbol(o));break;case"title":t.setTitle(o);break;case"dictRef":t.setName(Kekule.IO.CmlUtils.cmlNsTokenToKekule(o)),t.setInfoValue("dictRef",o);break;default:t.setInfoValue(n,o)}}}return t}}),Kekule.IO.CmlScalarWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlScalarWriter",doCreateElem:function(e,t){return this.createChildElem("scalar",t)},doWriteObject:function(t,r,l){if(!(t instanceof Kekule.Scalar))return this.reportTypeMismatchError(t),null;var a;if(Kekule.ObjUtils.isUnset(t.getValue())||(Kekule.DomUtils.setElementText(r,t.getValue()),a=DataType.getType(t.getValue())),t.getName()&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(r,"dictRef",Kekule.IO.CmlUtils.kekuleNsTokenToCml(t.getName()),this.getDomHelper()),t.getErrorValue()&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(r,"errorValue",t.getErrorValue(),this.getDomHelper()),t.getUnit()&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(r,"units",Kekule.IO.CmlUtils.metricsUnitSymbolToCmlUnitStr(t.getUnit()),this.getDomHelper()),t.getTitle()&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(r,"title",t.getTitle(),this.getDomHelper()),a){var i=e.getCmlTypeForDataType(a);i&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(r,"datatype",i,this.getDomHelper())}}}),Kekule.IO.CmlArrayReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlArrayReader",initProperties:function(){this.defineProp("expandSteppedArray",{dataType:DataType.BOOL,serializable:!1}),this.defineProp("defaultItemDataType",{dataType:DataType.STRING,serializable:!1})},doReadElement:function(e,t,r,l){return this.readArray(e)},readArray:function(e){var t=Kekule.DomUtils.fetchAttributeValuesToJson(e,this.getCoreNamespaceURI(),!0);if(t.size&&(t.size=parseInt(t.size)),Kekule.ObjUtils.notUnset(t.start)&&Kekule.ObjUtils.notUnset(t.end))t.start=parseFloat(t.start),t.end=parseFloat(t.end),t.stepSize&&(t.stepSize=parseFloat(t.stepSize)),!t.size&&t.stepSize?t.size=Math.round(Math.abs((arrayJson.end-arrayJson.start)/t.stepSize)):t.size&&!t.stepSize&&(t.stepSize=(t.end-t.start)/t.size);else{var r=Kekule.DomUtils.getElementText(e);t.values=this._generateExplicitArray(t,r)}return t},_generateSteppedArray:function(e){var t=null;if(this.getExpandSteppedArray()){var r=e.size,l=e.stepSize,a=e.start;t=[a];for(var i=0;i<r;++i){if((a+=l)>e.end){t.push(e.end);break}t.push(a)}}return t},_generateExplicitArray:function(e,t){var r=!!e.delimiter,l=r?e.delimiter:Kekule.IO.CML.DEFAULT_VALUE_DELIMITER_PATTERN,a=t.split(l);r&&(a.shift(),a.pop());for(var i=e.dataType||this.getDefaultItemDataType(),n=[],o=0,u=a.length;o<u;++o){var s=a[o].trim();!r&&s&&(i?n.push(Kekule.IO.CmlUtils.convertSimpleValueByDataType(s,i)):n.push(s))}return n}}),Kekule.IO.CmlArrayWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlArrayWriter",DEF_TAGNAME:"array",DEF_DELIMITER:" ",initProperties:function(){this.defineProp("defaultItemDataType",{dataType:DataType.STRING,serializable:!1}),this.defineProp("defaultItemDataUnit",{dataType:DataType.STRING,serializable:!1})},getArrayTagName:function(){return this.DEF_TAGNAME},getDefaultArrayValueDelimiter:function(){return this.DEF_DELIMITER},doCreateElem:function(e,t){return this.createChildElem(this.getArrayTagName(),t)},doWriteObject:function(e,t,r){var l;if(DataType.isObjectValue(e))l=Object.extend({},e);else{if(!DataType.isArrayValue(e))return this.reportTypeMismatchError(e),null;l={values:e}}return l=Object.extend(l,{unit:l.unit||r.unit||this.getDefaultItemDataUnit(),dataType:l.dataType||r.dataType||this.getDefaultItemDataType(),delimiter:l.delimiter||r.delimiter||this.getDefaultArrayValueDelimiter()}),this.writeArrayObj(l,t,r)},writeArrayObj:function(r,l,a){for(var i=this.getDomHelper(),n=["id","title","dictRef"],o=0,u=n.length;o<u;++o){var s=r[n[o]];Kekule.ObjUtils.notUnset(s)&&t.setCmlElemAttribute(l,n[o],s,i)}r.unit&&t.setCmlElemAttribute(l,"units",e.metricsUnitSymbolToCmlUnitStr(r.unit),i),r.dataType&&t.setCmlElemAttribute(l,"dataType",e.getCmlTypeForDataType(r.dataType),i);var d=r.values,m=d?d.length:r.size;if(m&&t.setCmlElemAttribute(l,"size",m,i),d){var c=r.delimiter||this.getDefaultArrayValueDelimiter();Kekule.DomUtils.setElementText(l,d.join(c)),c!==this.getDefaultArrayValueDelimiter()&&t.setCmlElemAttribute(l,"delimiter",c,i)}else Kekule.ObjUtils.notUnset(r.start)&&t.setCmlElemAttribute(l,"start",r.start,i),Kekule.ObjUtils.notUnset(r.end)&&t.setCmlElemAttribute(l,"end",r.end,i)}}),Kekule.IO.CmlMetaDataReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlMetaReader",doReadElement:function(e,t,r,l){var a=this.readMeta(e);return t&&t.setInfoValue&&a.key&&a.value&&t.setInfoValue(a.key,a.value),a},readMeta:function(e){var t=Kekule.DomUtils.fetchAttributeValuesToJson(e,this.getCoreNamespaceURI(),!0);return{key:t.name,value:DataType.StringUtils.deserializeValue(t.content),metadataType:t.metadataType}}}),Kekule.IO.CmlMetaDataListReader=Class.create(Kekule.IO.CmlBaseListReader,{CLASS_NAME:"Kekule.IO.CmlMetaListReader",doReadChildElem:function(e,t,r,l,a){return t.readElement(e,r,this)}}),Kekule.IO.CmlConditionListReader=Class.create(Kekule.IO.CmlBaseListReader,{CLASS_NAME:"Kekule.IO.CmlConditionListReader"}),Kekule.IO.CmlParameterReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlParameterReader",doReadElement:function(e,t,r,l){return this.readParameter(e,t,r)},readParameter:function(e,t,r){var l=Kekule.DomUtils.fetchAttributeValuesToJson(e,this.getCoreNamespaceURI(),!0),a={key:l.name||l.dictRef,value:DataType.StringUtils.deserializeValue(l.value),title:l.title};this.iterateChildElements(e,t,r,function(e,t){"scalar"===Kekule.DomUtils.getLocalName(e).toLowerCase()&&(a.value=t)});return a}}),Kekule.IO.CmlParameterListReader=Class.create(Kekule.IO.CmlBaseListReader,{CLASS_NAME:"Kekule.IO.CmlParameterListReader"}),Kekule.IO.CmlChemStructureReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlChemStructureReader",initialize:function(){this.tryApplySuper("initialize")},hasAtomChildren:function(e,t){return t.getElementsByTagNameNS(this.getCoreNamespaceURI(),"atom",e).length},getAtomChildren:function(e,t){return t.getElementsByTagNameNS(this.getCoreNamespaceURI(),"atom",e)},atomInfoToJSON:function(e,t){return Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(e,Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,!0,t)},arrayedAtomInfosToJSON:function(e,t){for(var r=["id","atomID","elementType","isotope","hydrogenCount","formalCharge","count","xFract","yFract","zFract","x2","y2","x3","y3","z3"],l=["id","id","elementType","isotope","hydrogenCount","formalCharge","count","xFract","yFract","zFract","x2","y2","x3","y3","z3"],a=[],i=0,n=r.length;i<n;++i){var o,u=[];(o=Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,r[i],Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM,t))&&(u=Kekule.IO.CmlDomUtils.splitCmlArrayValue(o));for(var s=0,d=u.length;s<d;++s)a[s]||(a[s]={}),u[s]&&(a[s][l[i]]=u[s])}return a}}),Kekule.IO.CmlFormulaReader=Class.create(Kekule.IO.CmlChemStructureReader,{CLASS_NAME:"Kekule.IO.CmlFormulaReader",doReadElement:function(e,t,r,l){return this.readFormula(e,this.getDomHelper())},readFormula:function(e,t){var r=new Kekule.MolecularFormula,l=Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"formalCharge",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,t);l&&r.setCharge(parseFloat(l));var a=Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"concise",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,t),i=Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"inline",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,t);if(a)this.setConcise(r,a);else if(i)this.setInlineFormula(r,i);else for(var n=Kekule.DomUtils.getDirectChildElems(e,null,null,this.getCoreNamespaceURI()),o=0,u=n.length;o<u;++o)switch(Kekule.DomUtils.getLocalName(n[o])){case"formula":this.readSubFormula(r,n[o],t);break;case"atomArray":this.readAtomArray(r,n[o],t);break;default:Kekule.IO.CmlDomUtils.isCmlTypedElem(e)||Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(e)||this.readChildElementDef(e,r)}return r},readConsice:function(e){var t=null;return e&&(t=new Kekule.MolecularFormula,this.setConcise(t,e)),t},setConcise:function(e,t){var r=Kekule.IO.CmlDomUtils.analysisCmlFormulaConciseValue(t);return r.isotopes&&r.isotopes.length&&this.createSectionsFromAtomAttribs(e,r.isotopes),r.formalCharge&&e.setCharge(r.formalCharge),e},setInlineFormula:function(e,t){return Kekule.FormulaUtils.textToFormula(t,null,e),e},readAtomArray:function(e,t,r){var l=[],a=this.getAtomChildren(t,r);if(a.length>0)for(var i=0,n=a.length;i<n;++i){var o=a[i],u=this.atomInfoToJSON(o,r);l.push(u)}else l=this.arrayedAtomInfosToJSON(t,r);return this.createSectionsFromAtomAttribs(e,l),e},createSectionsFromAtomAttribs:function(e,t){for(var r=0,l=t.length;r<l;++r){var a=t[r].elementType;if(a){var i=Kekule.IO.CmlUtils.createNodeByCmdElementType(null,a),n=t[r].formalCharge||0,o=t[r].count;e.appendSection(i,o,n)}}},readSubFormula:function(e,t,r){var l=this.readElement(t,r),a=Kekule.IO.CmlDomUtils.getCmlElemAttribute(t,"count",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,r);e.appendSection(l,parseFloat(a)||1,l.getCharge()||0)}}),Kekule.IO.CmlFormulaWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlFormulaWriter",doCreateElem:function(e,t){return this.createChildElem("formula",t)},doWriteObject:function(e,t,r){if(!(e instanceof Kekule.MolecularFormula))return this.reportTypeMismatchError(e),null;for(var l=[],a=[],i=[],n=0,o=e.getSectionCount();n<o;++n){var u=e.getSectionAt(n);if(u.obj instanceof Kekule.MolecularFormula){this.createAtomArrayElem(l,a,i,t),l=[],a=[],i=[];this.writeSubFormula(u.obj,u.count||1,t,r)}else l.push(Kekule.IO.CmlUtils.getNodeElementType(u.obj)),a.push(u.count||1),i.push(e.getSectionCharge(u)||0),n==o-1&&this.createAtomArrayElem(l,a,i,t)}e.getCharge()&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(t,"formalCharge",e.getCharge(),this.getDomHelper())},writeSubFormula:function(e,t,r,l){var a=this.createChildElem("formula",r);return this.doWriteObject(e,a,l),t>1&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,"count",t,this.getDomHelper()),a},createAtomArrayElem:function(e,t,r,l){if(!(e.length<=0)){var a=this.createChildElem("atomArray",l),i=Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(e),n=Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(t);Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,"elementType",i,this.getDomHelper()),Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,"count",n,this.getDomHelper());for(var o=!1,u=0,s=r.length;u<s;++u)if(r[u]){o=!0;break}if(o){var d=Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(t);Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,"formalCharge",d,this.getDomHelper())}return a}}}),Kekule.IO.CmlMoleculeReader=Class.create(Kekule.IO.CmlChemStructureReader,{CLASS_NAME:"Kekule.IO.CmlMoleculeReader",initialize:function(){this.tryApplySuper("initialize")},initProperties:function(){this.defineProp("structureBuilder",{dataType:"Kekule.ChemStructureBuilder",serializable:!1,getter:function(){return this.getPropStoreFieldValue("structureBuilder")||this.setPropStoreFieldValue("structureBuilder",new Kekule.ChemStructureBuilder),this.getPropStoreFieldValue("structureBuilder")},setter:null})},doReadElement:function(e,t,r,l){return this.readMolecule(e,r,this.getDomHelper())},doReadChildElement:function(e,t,r){if("molecule"==Kekule.DomUtils.getLocalName(e)&&this.matchCoreNamespace(e)){if(t&&t.getSubMolecules){var l=this.readElement(e,t,r);if(l){var a=Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"amount",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM)||Kekule.IO.CmlDomUtils.getCmlElemAttribute(e,"count",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM),i=a?{amount:parseFloat(a)}:null;t.getSubMolecules().appendObj(l,i)}return l}return null}return this.tryApplySuper("doReadChildElement",[e,t,r])},hasSubMolecule:function(e){return Kekule.DomUtils.getDirectChildElems(e,null,"molecule",this.getCoreNamespaceURI()).length>0},readMolecule:function(e,t,r){var l;return this.hasSubMolecule(e)?(l=new Kekule.CompositeMolecule,this.iterateChildElements(e,l,t)):l=this.readMoleculeCore(e,r),this.readMoleculeAttribs(l,e,r),l},readMoleculeAttribs:function(e,t,r){for(var l=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(t,null,!0,r),a=Kekule.ObjUtils.getOwnedFieldNames(l),i=0,n=a.length;i<n;++i){var o=a[i],u=l[o];switch(o){case"id":this.setObjId(e,u);break;case"title":e.setInfoValue("title",u);break;case"formalCharge":u&&e.setCharge(parseFloat(u));break;case"formula":this.readFormulaAttrib(e,u);break;case"amount":case"count":break;default:e.setInfoValue(o,u)}}},readMoleculeCore:function(e,t){var r=new Kekule.Molecule;this.getStructureBuilder().setTarget(r);for(var l=e.firstChild;l;){if(l.nodeType!=Node.ELEMENT_NODE);else if(this.matchCoreNamespace(l))switch(Kekule.DomUtils.getLocalName(l)){case"atomArray":this.readMoleculeAtomArray(r,l,this.getStructureBuilder(),t);break;case"bondArray":this.readMoleculeBondArray(r,l,this.getStructureBuilder(),t);break;case"formula":this.readFormula(r,l,t);break;case"atom":this.getStructureBuilder().setTarget(r);var a=this.readAtom(l,t);this.getStructureBuilder().appendNode(a);break;case"bond":this.getStructureBuilder().setTarget(r);var i=this.readBond(r,l,t);this.getStructureBuilder().appendConnector(i);break;case"molecule":break;default:Kekule.IO.CmlDomUtils.isCmlTypedElem(l)||Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(l)||this.readChildElementDef(l,r)}else;l=l.nextSibling}return r.hasCtab()&&this.connectUpBondAndAtom(r),r},connectUpBondAndAtom:function(e){for(var t=e.getConnectors(),r=0,l=t.length;r<l;++r){var a=t[r],i=a[this._BOND_ATOM_REF_TEMP_FIELD];if(i&&i.length)for(var n=0,o=i.length;n<o;++n){var u=e.getNodeById(i[n]);u?a.appendConnectedObj(u):Kekule.raise((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.ATOMID_NOT_EXISTS"):"Atom id not exists: ")+i[n])}delete a[this._BOND_ATOM_REF_TEMP_FIELD];var s=a[this._BOND_BOND_REF_TEMP_FIELD];if(s&&s.length)for(n=0,o=s.length;n<o;++n){var d=e.getConnectorById(s[n]);d?a.appendConnectedObj(d):Kekule.raise((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.BONDID_NOT_EXISTS"):"Bond id not exists: ")+s[n])}delete a[this._BOND_BOND_REF_TEMP_FIELD]}},readMoleculeAtomArray:function(e,t,r,l){r.setTarget(e);var a=this.getAtomChildren(t,l);if(a.length>0)for(var i=0,n=a.length;i<n;++i){var o=a[i],u=this.readAtom(o,l);r.appendNode(u)}else{var s=this.readArrayedAtoms(t,l);for(i=0,n=s.length;i<n;++i)r.appendNode(s[i])}},readAtom:function(e,t){var r,l=!Kekule.IO.CmlDomUtils.hasDirectCmlTypedElemChildren(e,this.getCoreNamespaceURI()),a=this.atomInfoToJSON(e,t);if(r=this.createStructureNodeOfAttribs(a),l)for(var i=Kekule.DomUtils.getDirectChildElems(e,null,null,this.getCoreNamespaceURI()),n=0,o=i.length;n<o;++n){e=i[n];this.readChildElementDef(e,r)}return r},readArrayedAtoms:function(e,t){for(var r=this.arrayedAtomInfosToJSON(e,t),l=[],a=0,i=r.length;a<i;++a){var n=this.createStructureNodeOfAttribs(r[a]);n&&l.push(n)}return l},createStructureNodeOfAttribs:function(e){var t;e.elementType||(e.elementType=Kekule.Element.UNSET_ELEMENT);var r=null;void 0!==e.id&&(r=e.id),delete e.id;var l,a,i=e.isotope?Math.round(e.isotope):null;if(t=Kekule.IO.CmlUtils.createNodeByCmdElementType(r,e.elementType,i),delete e.elementType,void 0!==e.hydrogenCount&&t.setExplicitHydrogenCount&&t.setExplicitHydrogenCount(parseInt(e.hydrogenCount,10)),delete e.hydrogenCount,e.formalCharge&&t.setCharge(parseInt(e.formalCharge)),delete e.formalCharge,e.title&&t.setInfoValue("title",e.title),delete e.title,e.role&&t.setInfoValue("role",e.role),delete e.role,void 0!==e.x2&&void 0!==e.y2)l={x:parseFloat(e.x2),y:parseFloat(e.y2)};else if(e.xy2){var n=Kekule.IO.CmlDomUtils.splitCmlArrayValue(e.xy2);2==n.length&&(l={x:parseFloat(n[0]),y:parseFloat(n[1])})}if(delete e.x2,delete e.y2,delete e.xy2,void 0!==e.x3&&void 0!==e.y3&&void 0!==e.z3)a={x:parseFloat(e.x3),y:parseFloat(e.y3),z:parseFloat(e.z3)};else if(e.xyz3){var o=Kekule.IO.CmlDomUtils.splitCmlArrayValue(e.xyz3);3==o.length&&(l={x:parseFloat(o[0]),y:parseFloat(o[1]),z:parseFloat(o[2])})}for(var u in delete e.x3,delete e.y3,delete e.z3,delete e.xyz3,l&&t.setCoord2D(l),a&&t.setCoord3D(a),e)e.hasOwnProperty(u)&&"string"==typeof e[u]&&t.setInfoValue(u,e[u]);return t},_BOND_ATOM_REF_TEMP_FIELD:"__cml_atomRefs",_BOND_BOND_REF_TEMP_FIELD:"__cml_bondRefs",readMoleculeBondArray:function(e,t,r,l){r.setTarget(e);var a=l.getElementsByTagNameNS(this.getCoreNamespaceURI(),"bond",t);if(a.length>0)for(var i=0,n=a.length;i<n;++i){var o=a[i],u=this.readBond(e,o,l);r.appendConnector(u)}else{var s=this.readArrayedBonds(e,t,l);for(i=0,n=s.length;i<n;++i)r.appendConnector(s[i])}},readBond:function(e,t,r){var l,a,i;if(i=!Kekule.IO.CmlDomUtils.hasDirectCmlTypedElemChildren(t,this.getCoreNamespaceURI()),a=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(t,Kekule.IO.CmlUtils.FILTER_TYPED_ELEM,!0,r),l=this.createStructureConnectorOfAttribs(e,a),i)for(var n=Kekule.DomUtils.getDirectChildElems(t,null,null,this.getCoreNamespaceURI()),o=0,u=n.length;o<u;++o){t=n[o];if("bondStereo"==Kekule.DomUtils.getLocalName(t)){var s=Kekule.DomUtils.getElementText(t);s||(s=Kekule.IO.CmlDomUtils.getCmlElemAttribute(t,"conversionValue",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,r)),s||(s=Kekule.IO.CmlUtils.getCmlNsValueLocalPart(Kekule.IO.CmlDomUtils.getCmlElemAttribute(t,"dictRef",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,r)));var d=Kekule.IO.CmlUtils.cmlBondStereoToKekule(s);d!=Kekule.BondStereo.NONE&&l.setStereo&&l.setStereo(d)}else this.readChildElementDef(t,l)}return l},readArrayedBonds:function(e,t,r){var l=["id","bondID","atomRef1","atomRef2","order","bondStereo"],a=["id","id","atomRefs2","atomRefs2","order","bondStereo"],i=[],n=Kekule.IO.CmlDomUtils.getMultipleCmlElemAttribute(t,"atomRefs",Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM,r);if(n&&n.length)for(var o=0,u=n.length;o<u;++o)for(var s=n[o],d=0,m=(c=Kekule.IO.CmlDomUtils.splitCmlArrayValue(s)).length;d<m;++d)i[d]||(i[d]={}),null==i[d].atomRefs&&(i[d].atomRefs=[]),i[d].atomRefs.push(c[d]);for(o=0,u=l.length;o<u;++o){var c=[];(s=Kekule.IO.CmlDomUtils.getCmlElemAttribute(t,l[o],Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM,r))&&(c=Kekule.IO.CmlDomUtils.splitCmlArrayValue(s));for(d=0,m=c.length;d<m;++d)i[d]||(i[d]={}),c[d]&&("atomRef1"==l[o]||"atomRef2"==l[o]?(null==i[d].atomRefs2&&(i[d].atomRefs2=[]),"atomRef1"==l[o]?i[d].atomRefs2[0]=c[d]:i[d].atomRefs2[1]=c[d]):i[d][a[o]]=c[d])}var k=[];for(o=0,u=i.length;o<u;++o){var g=this.createStructureConnectorOfAttribs(e,i[o]);g&&k.push(g)}return k},createStructureConnectorOfAttribs:function(e,t){var r,l,a;if(t.id&&(l=t.id),delete t.id,void 0!==t.order&&(a=Kekule.IO.CmlUtils.cmlBondOrderToKekule(t.order)),delete t.order,r=new Kekule.Bond(l,null,a),t.bondStereo){var i=Kekule.IO.CmlUtils.cmlBondStereoToKekule(t.bondStereo);i!=Kekule.BondStereo.NONE&&r.setStereo&&r.setStereo(i)}delete t.bondStereo;for(var n=0,o=Kekule.IO.CML.ATOMS_REF_ATTRIBS.length;n<o;++n){if(null!=t[s=Kekule.IO.CML.ATOMS_REF_ATTRIBS[n]]){var u=Kekule.IO.CmlDomUtils.splitCmlArrayValue(t[s]);u.length>0&&(r[this._BOND_ATOM_REF_TEMP_FIELD]=u),delete t[s];break}}for(n=0,o=Kekule.IO.CML.BONDS_REF_ATTRIBS.length;n<o;++n){var s;if(null!=t[s=Kekule.IO.CML.BONDS_REF_ATTRIBS[n]]){var d=Kekule.IO.CmlDomUtils.splitCmlArrayValue(t[s]);d.length>0&&(r[this._BOND_BOND_REF_TEMP_FIELD]=d),delete t[s];break}}for(var m in t)t.hasOwnProperty(m)&&"string"==typeof t[m]&&r.setInfoValue(m,t[m]);return r},readFormula:function(e,t,r){var l=this.doGetChildElementReader(t);if(l){this.copySettingsToChildHandler(l);var a=l.readElement(t,e,this);a&&e.setFormula(a)}},readFormulaAttrib:function(e,t){var r=this.doGetChildElementReader("formula");if(r){var l=r.readConsice?r.readConsice(t):null;l&&e.setFormula(l)}}}),Kekule.IO.CmlMoleculeWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlMoleculeWriter",initProperties:function(){this.defineProp("allowCascadeGroup",{dataType:DataType.BOOL})},doCreateElem:function(e,t){return this.createChildElem("molecule",t)},doWriteObject:function(e,t,r){return this.writeMolecule(e,t,r)},writeMolecule:function(e,t,r){return this.writeMoleculeAttribs(e,t),e instanceof Kekule.CompositeMolecule?this.writeCompositeMolecule(e,t,r):this.writeMoleculeCore(e,t,r)},writeMoleculeAttribs:function(e,t){var r=[];e.getCharge()&&r.push({key:"formalCharge",value:e.getCharge()});for(var l=["title","dictRef","chirality","ref","spinMultiplicity","symmetryOriented","role"],a=0,i=l.length;a<i;++a){var n=l[a],o=e.getInfoValue(n);Kekule.ObjUtils.isUnset(o)||r.push({key:n,value:e.getInfoValue(n)})}for(a=0,i=r.length;a<i;++a)Kekule.IO.CmlDomUtils.setCmlElemAttribute(t,r[a].key,r[a].value,this.getDomHelper())},writeCompositeMolecule:function(e,t,r){for(var l=e.getSubMolecules(),a=0,i=l.getItemCount();a<i;++a){var n=l.getItemAt(a),o=n.obj,u=this.writeObject(o,t,r);n.amount&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(u,"amount",n.amount,this.getDomHelper())}return t},writeMoleculeCore:function(e,t,r){if(e.hasFormula()){var l=e.getFormula();this.doGetChildObjectWriter(l).writeObject(l,t,r)}e.hasCtab()&&this.writeCtab(e.getCtab(),e,t,r)},writeCtab:function(e,t,r,l){this.identifyObjsInCtab(e,t);var a=this.getAllowCascadeGroup()?e.getNodes():e.getLeafNodes();if(a.length>0)for(var i=this.createChildElem("atomArray",r),n=0,o=a.length;n<o;++n)this.writeCtabNode(a[n],i,l);var u=this.getAllowCascadeGroup()?e.getConnectors():e.getAllChildConnectors();if(u.length>0){var s=this.createChildElem("bondArray",r);for(n=0,o=u.length;n<o;++n)this.writeCtabConnector(u[n],s,l)}},writeCtabNode:function(e,t,r){var l=this.createChildElem("atom",t);this.writeObjId(e,l);var a=Kekule.IO.CmlUtils.getNodeElementType(e);Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"elementType",a,this.getDomHelper());var i=e.getMassNumber?e.getMassNumber():null;i&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"isotope",i,this.getDomHelper());var n=e.getExplicitHydrogenCount?e.getExplicitHydrogenCount():null;Kekule.ObjUtils.isUnset(n)||Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"hydrogenCount",n,this.getDomHelper());var o=e.getCharge?e.getCharge():null;o&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"formalCharge",o,this.getDomHelper());e.getParity&&e.getParity();var u=e.getInfoValue?e.getInfoValue("title"):null;u&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"title",u,this.getDomHelper());var s=e.getInfoValue?e.getInfoValue("role"):null;if(s&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"role",s,this.getDomHelper()),e.hasCoord2D&&e.hasCoord2D()){var d=e.getAbsCoord2D();!Kekule.ObjUtils.isUnset(d.x)&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"x2",d.x,this.getDomHelper()),!Kekule.ObjUtils.isUnset(d.y)&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"y2",d.y,this.getDomHelper())}if(e.hasCoord3D&&e.hasCoord3D()){var m=e.getAbsCoord3D();!Kekule.ObjUtils.isUnset(m.x)&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"x3",m.x,this.getDomHelper()),!Kekule.ObjUtils.isUnset(m.y)&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"y3",m.y,this.getDomHelper()),!Kekule.ObjUtils.isUnset(m.z)&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,"z3",m.z,this.getDomHelper())}for(var c=["occupancy","xFract","xyzFract","yFract","convention","dictRef","ref"],k=0,g=c.length;k<g;++k){var I=c[k],O=e.getInfoValue(I);O&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(l,I,O,this.getDomHelper())}return this.writeObjAdditionalInfo(e,l,r),l},writeCtabConnector:function(e,t,r){var l=!1,a=this.createChildElem("bond",t);this.writeObjId(e,a);var i=e.getBondOrder?e.getBondOrder():null;if(i){var n=Kekule.IO.CmlUtils.kekuleBondOrderToCml(i);n&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,"order",n,this.getDomHelper())}var o,u=e.getStereo?e.getStereo():null;if(u){var s=Kekule.IO.CmlUtils.kekuleBondStereoToCml(u);if(s.value){var d=this.createChildElem("bondStereo",a);Kekule.DomUtils.setElementText(d,s.value),s.invert&&(l=!0)}}for(var m=[],c=[],k=0,g=e.getConnectedObjCount();k<g;++k){var I=e.getConnectedObjAt(k);if(I.getId&&I.getId()){var O=I.getId();I instanceof Kekule.ChemStructureNode?l?m.unshift(O):m.push(O):I instanceof Kekule.ChemStructureConnector&&c.push(O)}}if(o=m.length){var f=1==o?"atomRefs":o>=2&&o<=4?"atomRefs"+o:"atomRefs";Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,f,Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(m),this.getDomHelper())}if(o=c.length){f="bondRefs";Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,f,Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(c),this.getDomHelper())}var C=["convention","dictRef","ref"];for(k=0,g=C.length;k<g;++k){var h=C[k],K=e.getInfoValue(h);K&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,h,K,this.getDomHelper())}return this.writeObjAdditionalInfo(e,a,r),a},identifyObjsInCtab:function(e,t){for(var r=0,l=e.getNodeCount();r<l;++r){var a=e.getNodeAt(r);a.getId()||this.autoIdentifyForObj(a,t),e.isSubFragment(a)&&a.hasCtab&&a.hasCtab()&&this.identifyObjsInCtab(a.getCtab(),t)}for(r=0,l=e.getConnectorCount();r<l;++r){var i=e.getConnectorAt(r);i.getId()||this.autoIdentifyForObj(i,t)}}}),Kekule.IO.CmlMoleculeWriter._UID_SEED=null,Kekule.IO.CmlReactionReagentReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlReactionReagentReader",doReadElement:function(e,t,r,l){return this.readReagent(e,r,this.getDomHelper())},readReagent:function(e,t,r){var l=null,a=Kekule.DomUtils.getDirectChildElems(e,null,"molecule",this.getCoreNamespaceURI());if(a&&a.length){var i=a[a.length-1],n=this.doGetChildElementReader(i).readElement(i,null,this);n&&(l={},Kekule.RoleMapUtils.setItem(l,n),this.readReagentAttribs(l,e,r))}return l},readReagentAttribs:function(e,t,r){for(var l=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(t,Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,!0,r),a=Kekule.ObjUtils.getOwnedFieldNames(l),i=0,n=a.length;i<n;++i){var o=a[i],u=l[o];switch(o){case"role":e.role=Kekule.IO.CmlUtils.reagentRoleToKekule(u);break;case"amount":case"count":e.amount=parseFloat(u);break;default:e[o]=u}}return e}}),Kekule.IO.CmlReactionReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlReactionReader",doReadElement:function(e,t,r,l){return this.readReaction(e,this.getDomHelper())},readReaction:function(e,t){for(var r=new Kekule.Reaction,l=Kekule.DomUtils.getDirectChildElems(e,null,null,this.getCoreNamespaceURI()),a=0,i=l.length;a<i;++a)this.isComponentListElem(l[a])?this.readComponentList(r,l[a],t):this.readChildElement(l[a],r);var n=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(e,Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,null,this.getDomHelper()),o=Kekule.ObjUtils.getOwnedFieldNames(n);for(a=0,i=o.length;a<i;++a){var u=o[a],s=n[u];switch(u){case"name":r.setName(s);break;case"title":r.setTitle(s);break;case"type":r.setReactionType(s);break;case"yield":r.setYield(parseFloat(s));break;default:r.setInfoValue(u,s)}}return r},readComponentList:function(e,t,r){var l=this.getListElemComponentName(t),a=e.getComponentArray(l,!0);if(a)for(var i=Kekule.DomUtils.getDirectChildElems(t,null,null,this.getCoreNamespaceURI()),n=0,o=i.length;n<o;++n){var u=this.readChildElement(i[n],a);u&&(l==Kekule.ReactionComponent.CONDITION&&u instanceof ObjectEx?e.appendItem(l,u):e.appendMap(l,u))}},isComponentListElem:function(e){return["reactantList","productList","substanceList","conditionList"].indexOf(Kekule.DomUtils.getLocalName(e))>=0},getListElemComponentName:function(e){switch(Kekule.DomUtils.getLocalName(e)){case"reactantList":return Kekule.ReactionComponent.REACTANT;case"productList":return Kekule.ReactionComponent.PRODUCT;case"conditionList":return Kekule.ReactionComponent.CONDITION;default:return Kekule.ReactionComponent.SUBSTANCE}}}),Kekule.IO.CmlReactionWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlReactionWriter",doCreateElem:function(e,t){return this.createChildElem("reaction",t)},doWriteObject:function(e,t,r){return this.writeReaction(e,t,r)},writeReaction:function(e,t,r){for(var l=[Kekule.ReactionComponent.REACTANT,Kekule.ReactionComponent.PRODUCT,Kekule.ReactionComponent.SUBSTANCE,Kekule.ReactionComponent.CONDITION],a=0,i=l.length;a<i;++a)this.writeCompList(e,l[a],t,r);return this.writeReactionAttribs(e,t,r),t},writeReactionAttribs:function(e,t,r){var l=[];e.getName()&&l.push({key:"name",value:e.getName()}),e.getTitle()&&l.push({key:"title",value:e.getTitle()}),e.getReactionType()&&l.push({key:"type",value:e.getReactionType()}),e.getYield()&&l.push({key:"yield",value:e.getYield()});for(var a=["dictRef","convention","format","ref","role","type","state","yield","atomMap","electronMap"],i=0,n=a.length;i<n;++i)Kekule.ObjUtils.isUnset(e.getInfoValue(a[i]))||l.push({key:a[i],value:e.getInfoValue(a[i])});for(i=0,n=l.length;i<n;++i)Kekule.IO.CmlDomUtils.setCmlElemAttribute(t,l[i].key,l[i].value,this.getDomHelper())},writeCompList:function(e,t,r,l){if(e.getComponentItemCount(t)<=0)return null;for(var a=this.getReactionComponentCmlName(t),i=this.createChildElem(a+"List",r),n=0,o=e.getComponentItemCount(t);n<o;++n){var u=e.getMapAt(t,n),s=e.getMapItemAt(t,n);if(u&&s){var d;t!=Kekule.ReactionComponent.CONDITION?(d=this.createChildElem(a,i),Kekule.ObjUtils.isUnset(u.amount)||Kekule.IO.CmlDomUtils.setCmlElemAttribute(d,"amount",u.amount,this.getDomHelper()),u.role&&Kekule.IO.CmlDomUtils.setCmlElemAttribute(d,"role",Kekule.IO.CmlUtils.kekuleReagentRoleToCml(u.role),this.getDomHelper())):d=i;var m=this.doGetChildObjectWriter(s);m&&m.writeObject(s,d,l)}}},getReactionComponentCmlName:function(e){switch(e){case Kekule.ReactionComponent.REACTANT:return"reactant";case Kekule.ReactionComponent.PRODUCT:return"product";case Kekule.ReactionComponent.CONDITION:return"condition";default:return"substance"}}}),Kekule.IO.CmlListReader=Class.create(Kekule.IO.CmlBaseListReader,{CLASS_NAME:"Kekule.IO.CmlListReader",doCreateList:function(e){switch(Kekule.DomUtils.getLocalName(e)){case"moleculeList":return new Kekule.MoleculeList;case"reactionList":return new Kekule.ReactionList;default:return new Kekule.ChemObjList}},doAppendObjToList:function(e,t){return t&&t.append?t.append(e):this.tryApplySuper("doAppendObjToList",[e,t]),t}}),Kekule.IO.CmlListWriter=Class.create(Kekule.IO.CmlBaseListWriter,{CLASS_NAME:"Kekule.IO.CmlListWriter",doGetListElemTagName:function(e,t){var r;switch(DataType.getType(e)){case"Kekule.MoleculeList":r="moleculeList";break;case"Kekule.ReactionList":r="reactionList";break;default:r=this.tryApplySuper("doGetListElemTagName",[e,t])}return r}}),Kekule.IO.CmlTransparentListWriter=Class.create(Kekule.IO.CmlBaseListWriter,{CLASS_NAME:"Kekule.IO.CmlTransparentListWriter",doGetListElemTagName:function(e,t){return null}}),Kekule.IO.CmlRootReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlRootReader",doReadElement:function(e,t,r,l){var a;if(this.analysisElem(e),"cml"!=Kekule.DomUtils.getLocalName(e)&&(a=this.getReader(e)),a)return a.readElement(e,null,this,l);var i=l.defaultRootObjListHolder&&l.enableReadRootObjList,n=[],o=Kekule.DomUtils.getDirectChildElems(e,null,null,this.getCoreNamespaceURI());if(o){for(var u=0,s=o.length;u<s;++u)if(a=this.getReader(o[u])){var d=a.readElement(o[u],null,this,l);if(!i)return d;n.push(d)}return n.length<=0?null:n.length<=1?n[0]:this._createChildObjsHolder(n,l.defaultRootObjListHolder)}return null},getReader:function(e){return this.doGetChildElementReader(e)},analysisElem:function(e){var t=this.getDomHelper();t.setForceAnalysisDoc(!0),this.getDomHelper().setRootElement(e);for(var r=t.getNamespaces(),l=null,a=0,i=r.length;a<i;++a){var n=r[a].namespaceURI;if(Kekule.IO.CML.LEGAL_CORE_NAMESPACE_URIS.indexOf(n)>=0){l=n;break}}this.setCoreNamespaceURI(l||null),this.setNamespaces(r)}}),Kekule.IO.CmlRootWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlRootWriter",getWriter:function(e){return this.doGetChildObjectWriter(e)},writeObject:function(e,t,r){var l;this.getDomHelper().setForceAnalysisDoc(!0),this.getDomHelper().setRootElement(t),l=e instanceof Kekule.ChemSpace?e.getRoot():e;var a=this.getWriter(l);return a?a.writeObject(l,t,r):null}}),Kekule.IO.CmlReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.CmlReader",initProperties:function(){this.defineProp("objIdMap",{dataType:DataType.HASH,serializable:!1})},doReadData:function(e,t,r,l){var a,i;t!=Kekule.IO.ChemDataType.DOM?a=DataType.XmlUtility.parse(e).documentElement:a=e.documentElement?e.documentElement:e;var n=Kekule.IO.CmlElementReaderFactory.getReader("cml");if(n)try{this.setObjIdMap({}),n.setRootEvoker(this);var o=Object.extend({},Kekule.globalOptions.IO.cml);o=Object.extend(o,l||{}),i=n.readElement(a,null,null,o),n.doneReadingDocument(!0)}finally{n.finalize(),this.setObjIdMap(null)}return i},getLoadedObjById:function(e){var t=this.getObjIdMap();return t&&t[e]},setObjIdMapValue:function(e,t){var r=this.getObjIdMap();r&&(r[e]=t)}}),Kekule.IO.CmlWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.CmlWriter",initialize:function(e){this.tryApplySuper("initialize",[e]);var t=e||{};this.setPrettyPrint(Kekule.ObjUtils.isUnset(t.prettyPrint)?Kekule.globalOptions.IO.cml.prettyPrint:t.prettyPrint)},initProperties:function(){this.defineProp("prettyPrint",{dataType:DataType.BOOL,defaultValue:!0}),this.defineProp("rootElemWriter",{dataType:DataType.OBJECT,setter:null,serializable:!1})},doWriteData:function(e,t,r,l){var a=Kekule.IO.CML.CML3_SCHEMA_NAMESPACE_URI,i=DataType.XmlUtility.newDocument("cml",a),n=Kekule.IO.CmlElementWriterFactory.getWriter("Kekule.ChemDocument");if(n){var o;try{this.setPropStoreFieldValue("rootElemWriter",n);var u=Object.extend({},Kekule.globalOptions.IO.cml);u=Object.extend(u,l||{}),n.setCoreNamespaceURI(a),o=n.writeObject(e,i.documentElement,u),n.doneWritingDocument(!0),t==Kekule.IO.ChemDataType.TEXT&&(o=DataType.XmlUtility.serializeNode(i.documentElement,{prettyPrint:u.prettyPrint||this.getPrettyPrint()}))}finally{this.setPropStoreFieldValue("rootElemWriter",null),n.finalize()}return o}return Kekule.error(Kekule.$L("ErrorMsg.UNABLE_TO_OUTPUT_AS_CML").format(DataType.getType(e))),null}}),function(){Kekule.IO.MimeType.CML="chemical/x-cml";var e=Kekule.IO.CmlElementReaderFactory;e.register("name",Kekule.IO.CmlNameReader),e.register("scalar",Kekule.IO.CmlScalarReader),e.register("metaData",Kekule.IO.CmlMetaDataReader),e.register("metaDataList",Kekule.IO.CmlMetaDataListReader),e.register("formula",Kekule.IO.CmlFormulaReader),e.register("molecule",Kekule.IO.CmlMoleculeReader),e.register(["reactant","product","substance"],Kekule.IO.CmlReactionReagentReader),e.register("reaction",Kekule.IO.CmlReactionReader),e.register(["list","moleculeList","reactionList"],Kekule.IO.CmlListReader),e.register(["conditionlist"],Kekule.IO.CmlConditionListReader),e.register(["parameter"],Kekule.IO.CmlParameterReader),e.register(["parameterlist"],Kekule.IO.CmlParameterListReader),e.register(["array"],Kekule.IO.CmlArrayReader),e.register("cml",Kekule.IO.CmlRootReader);var t=Kekule.IO.CmlElementWriterFactory;t.register(DataType.ARRAY,Kekule.IO.CmlArrayWriter),t.register("Kekule.Scalar",Kekule.IO.CmlScalarWriter),t.register("Kekule.MolecularFormula",Kekule.IO.CmlFormulaWriter),t.register(["Kekule.ChemStructureFragment","Kekule.Molecule","Kekule.CompositeMolecule"],Kekule.IO.CmlMoleculeWriter),t.register("Kekule.Reaction",Kekule.IO.CmlReactionWriter),t.register(["Kekule.ChemObjList","Kekule.ChemStructureObjectGroup"],Kekule.IO.CmlListWriter),t.register(["Kekule.ChemSpaceElement","Kekule.ChemSpace"],Kekule.IO.CmlTransparentListWriter),t.register("Kekule.ChemDocument",Kekule.IO.CmlRootWriter),Kekule.IO.DataFormat.CML="cml",Kekule.IO.DataFormatsManager.register("cml",Kekule.IO.MimeType.CML,"cml",Kekule.IO.ChemDataType.TEXT,"Chemical Markup Language");var r=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.CML);Kekule.IO.ChemDataReaderManager.register("cml",Kekule.IO.CmlReader,[r]),Kekule.IO.ChemDataWriterManager.register("cml",Kekule.IO.CmlWriter,[Kekule.Scalar,Kekule.StructureFragment,Kekule.Reaction,Kekule.ChemObjList,Kekule.ChemSpace],[r])}()}(),Kekule.IO.MdlVersion={V2000:2,V3000:3},Kekule.IO.MDL={VER2000:"V2000",VER3000:"V3000",SYMBOL_ANYATOM:"A",SYMBOL_STARATOM:"*",SYMBOL_HETEROATOM:"Q",SYMBOL_RGROUP:"R",SYMBOL_RGROUP2:"R#",SYMBOL_LONEPAIR:"LP",SYMBOL_ATOMLIST:"L",SYMBOL_DUMMYATOM:"Du",SD_DATA_HEAD_PREFIX:">",MOL_DELIMITER:"$$$$"},Kekule.IO.MdlUtils={isUnspecifiedAtomSymbol:function(e){return e===Kekule.IO.MDL.SYMBOL_ANYATOM||e===Kekule.IO.MDL.SYMBOL_STARATOM},isHeteroAtomSymbol:function(e){return e===Kekule.IO.MDL.SYMBOL_HETEROATOM},isRGroupSymbol:function(e){return e===Kekule.IO.MDL.SYMBOL_RGROUP||e===Kekule.IO.MDL.SYMBOL_RGROUP2},isLonePairSymbol:function(e){return e===Kekule.IO.MDL.SYMBOL_LONEPAIR},isAtomListSymbol:function(e){return e===Kekule.IO.MDL.SYMBOL_ATOMLIST},analysisMdlDateTimeStr:function(e,t){var r=new Date,l=0,a=2,i=(parseInt(e.substr(l,a).trim(),10)||1)-1;l+=a;var n=parseInt(e.substr(l,a).trim(),10)||0;l+=a,a=t?4:2;var o=parseInt(e.substr(l,a),10)||0;t||(o+=o>=70?1900:2e3),r.setFullYear(o,i,n),l+=a,a=2;var u=parseInt(e.substr(l,a),10)||0;l+=a;var s=parseInt(e.substr(l,a),10)||0;return r.setHours(u,s),r},generateMdlDateTimeStr:function(e,t){var r="";return r+=(e.getMonth()+1).toString().lpad(2,"0"),r+=e.getDate().toString().lpad(2,"0"),r+=t?e.getFullYear().toString().lpad(4,"0"):(e.getFullYear()%100).toString().lpad(2,"0"),r+=e.getHours().toString().lpad(2,"0"),r+=e.getMinutes().toString().lpad(2,"0")},mdlRadicalToKekule:function(e){return e},kekuleRadicalToMdl:function(e){return e},bondTypeToKekuleOrder:function(e){switch(e){case 1:return Kekule.BondOrder.SINGLE;case 2:return Kekule.BondOrder.DOUBLE;case 3:return Kekule.BondOrder.TRIPLE;case 4:return Kekule.BondOrder.EXPLICIT_AROMATIC;default:return Kekule.BondOrder.UNSET}},kekuleBondOrderToMdlType:function(e){switch(e){case Kekule.BondOrder.SINGLE:return 1;case Kekule.BondOrder.DOUBLE:return 2;case Kekule.BondOrder.TRIPLE:return 3;case Kekule.BondOrder.EXPLICIT_AROMATIC:return 4;default:return 1}},getRxnMarkVersion:function(e){var t=e.substr(0,4);return"$RXN"!=t?null:(t=e.substr(4).trim())==Kekule.IO.MDL.VER3000?Kekule.IO.MdlVersion.V3000:Kekule.IO.MdlVersion.V2000},assertIlegalForCtabOutput:function(e){return e instanceof Kekule.StructureFragment?!!e.hasCtab()||(Kekule.error(Kekule.$L("ErrorMsg.MOLECULE_HAS_NO_CTAB_TO_OUTPUT")),!1):(Kekule.error(Kekule.$L("ErrorMsg.CAN_NOT_WRITE_NON_MOLECULE_TO_MOL")),!1)}},Kekule.IO.MdlStructureUtils={fillFragment:function(e,t,r){if(e.clear(),t){var l;if(l=r&&r!=Kekule.CoordMode.UNKNOWN?r==Kekule.CoordMode.COORD3D:t.atomInfos.isCoord3D,t.atomInfos)for(var a=0,i=t.atomInfos.length;a<i;++a){if(s=t.atomInfos[a]){var n=Kekule.IO.MdlStructureUtils.createStructureNode(e,s,l);n?e.appendNode(n):Kekule.raise(Kekule.$L("ErrorMsg.MDL_CTAB_ATOM_CANNOT_CREATE"))}}if(t.bondInfos)for(a=0,i=t.bondInfos.length;a<i;++a){if(s=t.bondInfos[a]){var o=Kekule.IO.MdlStructureUtils.createStructureConnector(e,s);o?e.appendConnector(o):Kekule.raise(Kekule.$L("ErrorMsg.MDL_CTAB_BOND_CANNOT_CREATE"))}}if(t.sgInfos&&t.sgInfos.length){var u=[];for(a=0,i=t.sgInfos.length;a<i;++a){var s;if((s=t.sgInfos[a])&&"SUP"==s.sgType){for(var d=[],m=0,c=s.atomIndexes.length;m<c;++m)d.push(e.getNodeAt(s.atomIndexes[m]));d.length&&u.push({atoms:d,text:s.label})}}for(a=0,i=u.length;a<i;++a){if((d=u[a].atoms).length){var k=e.marshalSubFragment(d,new Kekule.SubGroup),g=u[a].text;k.setFormulaText&&g.match(/.+\d/)?k.setFormulaText(u[a].text):k.setAbbr(u[a].text)}}}}return e},createStructureNode:function(e,t,r){var l;if(t.atomListInfo||Kekule.IO.MdlUtils.isAtomListSymbol(t.symbol)){l=new Kekule.VariableAtom;var a=[];t.atomListInfo&&t.atomListInfo.symbols&&(a=a.concat(t.atomListInfo.symbols),t.atomListInfo.isAllowList?l.setAllowedIsotopeIds(a):l.setDisallowedIsotopeIds(a))}else if(Kekule.IO.MdlUtils.isRGroupSymbol(t.symbol))l=new Kekule.RGroup;else if(Kekule.IO.MdlUtils.isHeteroAtomSymbol(t.symbol))l=new Kekule.Pseudoatom(null,Kekule.PseudoatomType.HETERO);else if(Kekule.IO.MdlUtils.isUnspecifiedAtomSymbol(t.symbol))l=new Kekule.Pseudoatom(null,Kekule.PseudoatomType.ANY);else{var i=Kekule.ChemicalElementsDataUtil.getElementInfo(t.symbol);if(i){var n=null;if(t.massNumber)n=t.massNumber;else if(t.massDiff&&i){var o=i.naturalMass,u=(n=Math.round(o+t.massDiff),Kekule.IsotopesDataUtil.getIsotopeInfo(i.atomicNumber,n));u||(n=Math.floor(o+t.massDiff),u=Kekule.IsotopesDataUtil.getIsotopeInfo(i.atomicNumber,n)),u||(n=Math.ceil(o+t.massDiff),u=Kekule.IsotopesDataUtil.getIsotopeInfo(i.atomicNumber,n)),u||(n=null)}l=new Kekule.Atom(null,t.symbol,n)}else{var s=Kekule.IsotopesDataUtil.getIsotopeInfo(t.symbol);l=s?new Kekule.Atom(null,s.atomicNumber,s.massNumber):new Kekule.Pseudoatom(null,Kekule.PseudoatomType.ANY)}}return t.charge&&l.setCharge(t.charge),t.radical&&l.setRadical(t.radical),t.parity&&l.setParity&&l.setParity(t.parity),void 0!==t.hydrongenCount&&l.setExplicitHydrogenCount&&l.setExplicitHydrogenCount(t.hydrongenCount),r?l.setCoord3D({x:t.x,y:t.y,z:t.z}):l.setCoord2D({x:t.x,y:t.y}),l},createStructureConnector:function(e,t){var r=e.getNodeAt(t.atomIndex1),l=e.getNodeAt(t.atomIndex2);if(r&&l){var a=[r,l];if(t.endAtomIndexes)for(var i=0,n=t.endAtomIndexes.length;i<n;++i){var o=e.getNodeAt(t.endAtomIndexes[i]);o&&a.push(o)}var u=new Kekule.Bond(null,a,t.order);return void 0!==t.stereo&&u.setStereo(t.stereo),u}return null},isNodeVariableAtom:function(e){return e instanceof Kekule.VariableAtom},getAtomTypeStr:function(e,t){if(e instanceof Kekule.Atom)return e.getSymbol();if(!(e instanceof Kekule.Pseudoatom)){if(e instanceof Kekule.RGroup)return Kekule.IO.MDL.SYMBOL_RGROUP;if(e instanceof Kekule.VariableAtom){if(t)return Kekule.IO.MDL.SYMBOL_ATOMLIST;var r="[",l=e.getAllowedIsotopeIds();if(l&&l.length||(r="NOT[",l=e.getDisallowedIsotopeIds()),l&&l.length){for(var a=[],i=0,n=l.length;i<n;++i){var o=Kekule.IsotopesDataUtil.getIsotopeIdDetail(l[i]);o&&o.symbol&&a.push(o.symbol)}return r=r+a.join(",")+"]"}return Kekule.IO.MDL.SYMBOL_ATOMLIST}return"?"}switch(e.getAtomType()){case Kekule.PseudoatomType.ANY:return Kekule.IO.MDL.SYMBOL_ANYATOM;case Kekule.PseudoatomType.HETERO:return Kekule.IO.MDL.SYMBOL_HETEROATOM;default:return Kekule.IO.MDL.SYMBOL_DUMMYATOM}},getMoleculeCtabStructureInfo:function(e,t){var r={};r.atoms=e.getLeafNodes(),r.bonds=e.getAllChildConnectors(),r.subGroups=e.getSubFragments();for(var l=0,a=0,i=0,n=r.atoms.length;i<n;++i)r.atoms[i].hasCoord3D()&&++a,r.atoms[i].hasCoord2D()&&++l,t.explicitChiralFlagInCountLine&&r.atoms[i].getParity&&r.atoms[i].getParity()&&(r.chiral=!0);return r.coordMode=l>a?Kekule.CoordMode.COORD2D:Kekule.CoordMode.COORD3D,r},splitConnectedNodes:function(e){for(var t={primaryNodes:[]},r=0,l=e.getConnectedObjs(),a=0,i=l.length;a<i;++a)l[a]instanceof Kekule.ChemStructureNode&&(r<2?(t.primaryNodes.push(l[a]),++r):(t.remainNodes||(t.remainNodes=[]),t.remainNodes.push(l[a])));return t},generateClassicStyleCountLine:function(e,t){if(t==Kekule.IO.MdlVersion.V3000)return"  0  0  0     0  0              0 V3000";var r="";r+=e.atoms.length.toString().lpad(3),r+=e.bonds.length.toString().lpad(3),r+="0".lpad(3),r+="0".lpad(3),r+=(e.chiral?"1":"0").lpad(3),r+="0".lpad(3);for(var l=0;l<4;++l)r+="0".lpad(3);return r+="999",r+=Kekule.IO.MDL.VER2000.lpad(6)}},Kekule.IO.MdlBlockHandler=Class.create(ObjectEx,{CLASS_NAME:"Kekule.IO.MdlBlockHandler",initProperties:function(){this.defineProp("textBuffer",{dataType:"Kekule.TextLinesBuffer",serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("textBuffer");return e||(e=this.createTextBuffer(),this.setPropStoreFieldValue("textBuffer",e)),e},setter:null})},createTextBuffer:function(){return new Kekule.TextLinesBuffer}}),Kekule.IO.MdlBlockReader=Class.create(Kekule.IO.MdlBlockHandler,{CLASS_NAME:"Kekule.IO.MdlBlockReader",readBlock:function(e,t){return"string"==typeof e?this.getTextBuffer().setText(e):this.getTextBuffer().setLines(e),this.getTextBuffer().reset(),this.doReadBlock(this.getTextBuffer())},doReadBlock:function(e,t){}}),Kekule.IO.MdlBlockWriter=Class.create(Kekule.IO.MdlBlockHandler,{CLASS_NAME:"Kekule.IO.MdlBlockWriter",writeBlock:function(e,t){return this.getTextBuffer().clear(),this.doWriteBlock(e,this.getTextBuffer(),t),this.getTextBuffer().getText()},doWriteBlock:function(e,t,r){}}),Kekule.IO.Mdl2kUtils={atomLineChargeToKekule:function(e){switch(e){case 1:return 3;case 2:return 2;case 3:return 1;case 5:return-1;case 6:return-2;case 7:return-3;default:return 0}},chargeToMdlAtomLineValue:function(e){switch(e){case 1:return 3;case 2:return 2;case 3:return 1;case-1:return 5;case-2:return 6;case-3:return 7;default:return 0}},atomLineChargeToRadical:function(e){return 4==e?Kekule.RadicalOrder.DOUBLET:0},radicalToMdlAtomLineValue:function(e){return e==Kekule.RadicalOrder.DOUBLET?4:0},chargeOrRadicalToMdlAtomLineValue:function(e,t){return e?Kekule.IO.Mdl2kUtils.chargeToMdlAtomLineValue(e):t?Kekule.IO.Mdl2kUtils.radicalToMdlAtomLineValue(e):0},bondStereoToKekule:function(e,t){if(t==Kekule.BondOrder.SINGLE)switch(e){case 1:return Kekule.BondStereo.UP;case 4:return Kekule.BondStereo.UP_OR_DOWN;case 6:return Kekule.BondStereo.DOWN;default:return Kekule.BondStereo.NONE}else{if(t!=Kekule.BondOrder.DOUBLE)return Kekule.BondStereo.NONE;switch(e){case 3:return Kekule.BondStereo.E_Z_BY_COORDINATES;default:return Kekule.BondStereo.NONE}}},bondStereoToMdlBondLineValue:function(e,t,r){var l=Kekule.BondStereo,a={};if(t==Kekule.BondOrder.SINGLE)if(r&&[l.UP_INVERTED,l.DOWN_INVERTED].indexOf(e)>=0&&(a.inverted=!0),a.inverted)e===l.UP_INVERTED?a.stereo=1:e===l.DOWN_INVERTED&&(a.stereo=6);else switch(e){case l.DOWN_INVERTED:case l.UP:a.stereo=1;break;case l.UP_INVERTED:case l.DOWN:a.stereo=6;break;case l.UP_OR_DOWN_INVERTED:case l.UP_OR_DOWN:a.stereo=4;break;default:a.stereo=0}else if(t==Kekule.BondOrder.DOUBLE)switch(e){case Kekule.BondStereo.E_Z_BY_COORDINATES:a.stereo=3;break;default:a.stereo=0}else a.stereo=0;return a},coordToStr:function(e){return(e||0).toFixed(4)},getMassDiff:function(e){var t=Kekule.ChemicalElementsDataUtil.getElementInfo(e.getAtomicNumber()).naturalMass;return Math.round(e.getMassNumber()-t)},getAtomListPropLineValue:function(e){var t="",r=e.getAllowedIsotopeIds();if(r&&r.length?t=" F ":(t=" T ",r=e.getDisallowedIsotopeIds()),r&&r.length){for(var l=[],a=0,i=r.length;a<i;++a){var n=Kekule.IsotopesDataUtil.getIsotopeIdDetail(r[a]);n&&n.symbol&&l.push(n.symbol.rpad(4))}var o=l.join("");return t=l.length.toString().lpad(3)+t+o}return null},getCtabPropLineTag:function(e,t){return(t||"M")+"  "+e},getCtabPropLineCountTag:function(e,t,r){var l=(r||"M")+"  "+e;return t&&(l+=t.toString().lpad(3)),l},generateCtabPropLine:function(e,t,r,l){return Kekule.IO.Mdl2kUtils.getCtabPropLineCountTag(t,r,l)+" "+e.join(" ")}},Kekule.IO.Mdl2kCTabReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.Mdl2kCTabReader",doReadBlock:function(e,t){return this.analysisCTab(e)},analysisCTab:function(e){var t={},r=e.readLine(),l=this.analysisCountLine(r),a=[];a.isCoord3D=!1;for(var i=0;i<l.atomCount;++i){r=e.readLine();var n=this.analysisAtomLine(r);n.z&&(a.isCoord3D=!0),a.push(n)}var o=[];for(i=0;i<l.bondCount;++i){r=e.readLine();var u=this.analysisBondLine(r);o.push(u)}for(i=0;i<l.atomListCount;++i){r=e.readLine();var s=this.analysisAtomListInfoLine(r);a[s.atomIndex]&&(a[s.atomIndex].atomListInfo=s)}for(i=0;i<l.stextCount;++i)r=e.readLine(),r=e.readLine();for(var d=[];!e.eof();){r=e.readLine();var m=this.analysisPropertyLine(r,a,d);if("END"===m.prop)break;if("SKP"===m.prop)for(i=0;i<m.count&&!e.eof();++i)r=e.readLine();else if("A"===m.leading){if(e.eof())break;var c=m.atomIndex;r=e.readLine(),a[c].symbol=r.trim()}}return t.countInfo=l,t.atomInfos=a,t.bondInfos=o,t.sgInfos=d,t},analysisCountLine:function(e){var t={},r=e.substr(33,6).trim();return r&&r!=Kekule.IO.MDL.VER2000?(Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL2000_FORMAT_DATA")),null):(r=e.substr(0,3),t.atomCount=parseInt(r,10),r=e.substr(3,3),t.bondCount=parseInt(r,10),r=e.substr(12,3),t.isChiral=0!=parseInt(r,10),r=e.substr(15,3),t.stextCount=parseInt(r,10),t)},analysisAtomLine:function(e){var t={},r=e.substr(0,10);t.x=parseFloat(r),r=e.substr(10,10),t.y=parseFloat(r),r=e.substr(20,10),t.z=parseFloat(r),r=e.substr(31,3),t.symbol=r.trim(),r=e.substr(34,2),t.massDiff=parseInt(r,10),r=e.substr(36,3);var l=parseInt(r,10),a=Kekule.IO.Mdl2kUtils.atomLineChargeToRadical(l);return a?t.radical=a:t.charge=Kekule.IO.Mdl2kUtils.atomLineChargeToKekule(l),r=e.substr(39,3),(l=parseInt(r,10))&&(t.parity=l),r=e.substr(42,3),(l=parseInt(r,10))>0&&(t.hydrongenCount=l-1),t},analysisBondLine:function(e){var t={},r=e.substr(0,3);t.atomIndex1=parseInt(r,10)-1,r=e.substr(3,3),t.atomIndex2=parseInt(r,10)-1,r=e.substr(6,3),t.order=Kekule.IO.MdlUtils.bondTypeToKekuleOrder(parseInt(r,10)),r=e.substr(9,3);var l=Kekule.IO.Mdl2kUtils.bondStereoToKekule(parseInt(r,10),t.order);return l&&(t.stereo=l),t},analysisAtomListInfoLine:function(e){var t={},r=e.substr(0,3);t.atomIndex=parseInt(r,10)-1,r=e.substr(4,1),t.isAllowList="f"==r.toLowerCase(),r=e.substr(9,1);var l=Math.min(parseInt(r,10),5);t.atomicNumbers=[];for(var a=11,i=0;i<l;++i){a+=4*i,r=e.substr(a,3);var n=parseInt(r,10);n&&t.atomicNumbers.push(n)}return t},analysisPropertyLine:function(e,t,r){var l={},a=e.substr(0,1);if(l.leading=a,"M"==a){var i,n,o=e.substr(3,3).trim();if(l.prop=o,"END"===o)return l;if(["CHG","RAD","ISO"].indexOf(o)>=0){var u=parseInt(e.substr(6,3).trim());l.entryCount=u,l.entries=[];for(var s="CHG"===o?"charge":"RAD"===o?"radical":"massNumber",d=10,m=0;m<u;++m){var c=parseInt(e.substr(d,3).trim(),10)-1,k=parseInt(e.substr(d+4,3).trim(),10);d+=8,l.entries.push({atomIndex:c,propName:k}),t[c][s]=k}}else["STY","SLB"].indexOf(o)>=0?n=r[i=parseInt(e.substr(10,3),10)-1]:["SAL","SBL","SMT","SCL","SAP","SBV"].indexOf(o)>=0&&(n=r[i=parseInt(e.substr(7,3),10)-1]);switch(o){case"ALS":var g={},I=e.substr(7,3).trim();g.atomIndex=parseInt(I,10)-1,l.atomIndex=g.atomIndex;var O=parseInt(e.substr(10,3)),f=e.substr(14,1);g.isAllowList="f"==f.toLowerCase(),g.symbols=[];for(m=0;m<O;++m)f=e.substr(16+4*m,4).trim(),g.symbols.push(f);l.atomListInfo=g;var C=t[g.atomIndex].atomListInfo;C?C.isAllowList!==g.isAllowList?t[g.atomIndex].atomListInfo=g:C.symbols=Kekule.ArrayUtils.pushUnique(C.symbols,g.symbols):t[g.atomIndex].atomListInfo=g;break;case"STY":"SUP"==e.substr(14,3)&&(r[i]={sgType:"SUP"});break;case"SLB":n&&(n.labelId=e.substr(14).trim());break;case"SAL":if(n){var h=parseInt(e.substr(10,3));n.atomIndexes||(n.atomIndexes=[]);for(m=0;m<h;++m){f=e.substr(14+4*m,3),c=parseInt(f)-1;n.atomIndexes.push(c)}}break;case"SBL":if(n&&"SUP"==n.sgType){var K=parseInt(e.substr(10,3));n.crossBondIndexes||(n.crossBondIndexes=[]);for(m=0;m<K;++m){f=e.substr(14+4*m,3);var p=parseInt(f)-1;n.crossBondIndexes.push(p)}}break;case"SMT":n&&("SUP"==n.sgType?n.label=e.substr(11).trim():n.subscript=e.substr(11).trim());break;case"SCL":n&&(n.sgClass=e.substr(11).trim());break;case"SBV":if(n){var M=parseInt(e.substr(11,3),10)-1;n.bondVectors||(n.bondVectors=[]),n.bondVectors[M]={bondIndex:M,x:parseFloat(e.substr(14,10)),y:parseFloat(e.substr(24,10))};var E=e.substr(34,10).trim();E&&(n.bondVectors[M].z=parseFloat(E)||0)}}}else if("A"===a){d=3,c=parseInt(e.substr(d,3).trim(),10)-1;l.atomIndex=c}else if("V"===a);else if("G"===a);else if("S"===a){o=e.substr(3,3).trim();l.prop=o,l.count=parseInt(e.substr(6,3),10)}return l}}),Kekule.IO.Mdl2kCTabWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.Mdl2kCTabWriter",initialize:function(e){this.tryApplySuper("initialize"),this.setCoordMode(e||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("coordMode",{dataType:DataType.INT,deaultValue:Kekule.CoordMode.UNKNOWN})},doWriteBlock:function(e,t,r){return Kekule.IO.MdlUtils.assertIlegalForCtabOutput(e),this.outputCtab(e,t,r)},outputCtab:function(e,t,r){var l=[],a=Kekule.IO.MdlStructureUtils.getMoleculeCtabStructureInfo(e,r);if(this.getCoordMode()!=Kekule.CoordMode.UNKNOWN&&(a.coordMode=this.getCoordMode()),t.writeLine(this.generateCountLine(a)),this.outputAtomBlock(e,a,t,l),this.outputBondBlock(e,a,t),l.length)for(var i=0,n=l.length;i<n;++i)t.writeLine(l[i]);this.outputSubgroupsPropLines(e,a,t),t.writeLine(Kekule.IO.Mdl2kUtils.getCtabPropLineTag("END"))},generateCountLine:function(e){return Kekule.IO.MdlStructureUtils.generateClassicStyleCountLine(e,Kekule.IO.MdlVersion.V2000)},outputAtomBlock:function(e,t,r,l){for(var a=0,i=t.atoms.length;a<i;++a){var n=t.atoms[a],o=this.generateAtomLine(a,t.coordMode,n,l);r.writeLine(o)}},generateAtomLine:function(e,t,r,l){var a=Kekule.IO.Mdl2kUtils.coordToStr,i="",n=(e+1).toString().lpad(3),o=t==Kekule.CoordMode.COORD3D?r.getAbsCoord3D():r.getAbsCoord2D();if(i+=a(o.x).lpad(10)+a(o.y).lpad(10)+a(o.z).lpad(10),i+=" "+Kekule.IO.MdlStructureUtils.getAtomTypeStr(r,!0).rpad(3),Kekule.IO.MdlStructureUtils.isNodeVariableAtom(r)){var u=Kekule.IO.Mdl2kUtils.getAtomListPropLineValue(r);if(u){var s=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("ALS")+" "+n+u;l.push(s)}}if(r.getMassNumber&&r.getMassNumber()){i+=(Kekule.IO.Mdl2kUtils.getMassDiff(r.getIsotope())||0).toString().lpad(2);s=Kekule.IO.Mdl2kUtils.generateCtabPropLine([n,r.getMassNumber().toString().lpad(3)],"ISO",1);l.push(s)}else i+="0".lpad(2);if(i+=Kekule.IO.Mdl2kUtils.chargeOrRadicalToMdlAtomLineValue(r.getCharge?r.getCharge():null,r.getRadical?r.getRadical():null).toString().lpad(3),r.getCharge&&r.getCharge()){s=Kekule.IO.Mdl2kUtils.generateCtabPropLine([n,r.getCharge().toString().lpad(3)],"CHG",1);l.push(s)}if(r.getRadical&&r.getRadical()){s=Kekule.IO.Mdl2kUtils.generateCtabPropLine([n,Kekule.IO.MdlUtils.kekuleRadicalToMdl(r.getRadical()).toString().lpad(3)],"RAD",1);l.push(s)}i+=(r.getParity&&r.getParity()||0).toString().lpad(3);var d=r.getExplicitHydrogenCount?r.getExplicitHydrogenCount():null;i+=(Kekule.ObjUtils.isUnset(d)?"0":(d+1).toString()).lpad(3);for(var m=0,c="0".lpad(3);m<8;++m)i+=c;return i},outputBondBlock:function(e,t,r){for(var l=0,a=t.bonds.length;l<a;++l){var i=t.bonds[l],n=this.generateBondLine(l,i,t.atoms);r.writeLine(n)}},generateBondLine:function(e,t,r){var l,a,i="";t.getStereo&&t.getBondOrder?l=(a=Kekule.IO.Mdl2kUtils.bondStereoToMdlBondLineValue(t.getStereo(),t.getBondOrder(),!0)).stereo.toString().lpad(3):(a={},l+="0".lpad(3));var n,o,u=Kekule.IO.MdlStructureUtils.splitConnectedNodes(t);return n=(r.indexOf(u.primaryNodes[0])+1).toString().lpad(3),o=(r.indexOf(u.primaryNodes[1])+1).toString().lpad(3),a&&a.inverted?i+=o+n:i+=n+o,t.getBondOrder?i+=Kekule.IO.MdlUtils.kekuleBondOrderToMdlType(t.getBondOrder()).toString().lpad(3):i+="0".lpad(3),i+=l,i+="0".lpad(3),i+="0".lpad(3),i+="0".lpad(3)},outputSubgroupsPropLines:function(e,t,r){for(var l=0,a=t.subGroups.length;l<a;++l)for(var i=this.generateSgroupLines(l,t.subGroups[l],t),n=0,o=i.length;n<o;++n)r.writeLine(i[n])},generateSgroupLines:function(e,t,r){var l=[],a=(e+1).toString().lpad(3),i=Kekule.IO.Mdl2kUtils.generateCtabPropLine([a,"SUP"],"STY",1);l.push(i),i=Kekule.IO.Mdl2kUtils.generateCtabPropLine([a,a],"SLB",1),l.push(i);var n=t.getAbbr&&t.getAbbr()||t.getFormulaText&&t.getFormulaText()||t.getName&&t.getName();n&&(i=Kekule.IO.Mdl2kUtils.generateCtabPropLine([a,n],"SMT"),l.push(i));for(var o=[],u=0,s=(O=t.getLeafNodes()).length;u<s;++u){(e=r.atoms.indexOf(O[u]))>=0&&o.push((e+1).toString().lpad(3))}o=o.sort();var d=Kekule.ArrayUtils.divide(o,15);for(u=0,s=d.length;u<s;++u){var m=d[u];i=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("SAL")+" "+a+m.length.toString().lpad(3)+" "+m.join(" "),l.push(i)}var c=t.getCrossConnectors(),k=[],g=[],I=Kekule.IO.Mdl2kUtils.coordToStr;for(u=0,s=c.length;u<s;++u){if((e=r.bonds.indexOf(c[u]))>=0){k.push((e+1).toString().lpad(3));var O,f=[e+1],C={};2==(O=Kekule.IO.MdlStructureUtils.splitConnectedNodes(c[u]).primaryNodes).length&&(r.coordMode==Kekule.CoordMode.COORD2D?(C=Kekule.CoordUtils.substract(O[0].getAbsCoord2D(),O[1].getAbsCoord2D()),f=f.concat([I(C.x).lpad(10),I(C.y).lpad(10)])):(C=Kekule.CoordUtils.substract(O[0].getAbsCoord3D(),O[1].getAbsCoord3D()),f=f.concat([I(C.x),I(C.y),I(C.z)]))),g.push(f)}}k=k.sort();var h=Kekule.ArrayUtils.divide(k,15);for(u=0,s=h.length;u<s;++u){var K=h[u];i=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("SBL")+" "+a+K.length.toString().lpad(3)+" "+K.join(" "),l.push(i)}for(u=0,s=g.length;u<s;++u){var p=g[u].shift(),M=g[u].join("");i=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("SBV")+" "+a+" "+p.toString().lpad(3)+M,l.push(i)}return l}}),Kekule.IO.Mdl3kUtils={get3kBlockStartTag:function(e){return"BEGIN "+e.toUpperCase()},get3kBlockEndTag:function(e){return"END "+e.toUpperCase()},isAtomList:function(e){return e.search(/\[.+\]/)>=0},analysisAtomList:function(e){var t=/\[(.+)\]/g.exec(e);if(t&&t.length>=2){t=t[1].split(",");var r={};r.isAllowList=!(0==e.trim().indexOf("NOT")),r.symbols=[];for(var l=0,a=t.length;l<a;++l)r.symbols.push(t[l].trim());return r}return null},bondCfgToKekule:function(e){switch(e){case 0:return Kekule.BondStereo.NONE;case 1:return Kekule.BondStereo.UP;case 2:return Kekule.BondStereo.UP_OR_DOWN;case 3:return Kekule.BondStereo.DOWN;default:return Kekule.BondStereo.NONE}},bondStereoToMdlCfg:function(e,t){var r=Kekule.BondStereo,l={};if(t&&[r.UP_INVERTED,r.DOWN_INVERTED].indexOf(e)>=0&&(l.inverted=!0),l.inverted)e===r.UP_INVERTED?l.cfg=1:e===r.DOWN_INVERTED&&(l.cfg=3);else switch(e){case r.UP:case r.DOWN_INVERTED:l.cfg=1;break;case r.UP_OR_DOWN:l.cfg=2;break;case r.DOWN:case r.UP_INVERTED:l.cfg=3;break;default:l.cfg=0}return l},coordToStr:function(e){return(e||0).toFixed(6)}},Kekule.IO.Mdl3kValueUtils={SEPARATOR:" ",KEYVALUE_CONNECTOR:"=",STR_QUOTE:'"',ESC_QUOTE:'""',VALUELIST_PATTERN:/\(.+\)/g,split:function(e,t){for(var r=t||Kekule.IO.Mdl3kValueUtils.SEPARATOR,l=Kekule.IO.Mdl3kValueUtils.STR_QUOTE,a=[],i=!1,n=!1,o=!1,u="",s=0,d=e.length;s<d;++s){var m=e.charAt(s);m==l?!i&&e.charAt(s+1)==l||i&&e.charAt(s-1)==l||(i=!i):"["==m?n=!0:"]"==m?n=!1:"("==m?o=!0:")"==m&&(o=!1),m==r?i||n||o||!u?u+=m:(a.push(u),u=""):u+=m}return u&&a.push(u),a},merge:function(e,t){var r=t||Kekule.IO.Mdl3kValueUtils.SEPARATOR;return e.join(r)},isKeyValuePair:function(e){return e.indexOf(Kekule.IO.Mdl3kValueUtils.KEYVALUE_CONNECTOR)>=0},splitKeyValue:function(e){var t={},r=Kekule.IO.Mdl3kValueUtils.KEYVALUE_CONNECTOR,l=e.indexOf(r);return l<0?t.value=e:(t.key=e.substr(0,l),t.value=e.substr(l+r.length)),t},mergeKeyValue:function(e,t){return t?""+t+Kekule.IO.Mdl3kValueUtils.KEYVALUE_CONNECTOR+e:e},isValueList:function(e){return e.search(Kekule.IO.Mdl3kValueUtils.VALUELIST_PATTERN)>=0},splitValueList:function(e){var t=/\((.+)\)/.exec(e);if(t&&t.length>1){var r=t[1],l=Kekule.IO.Mdl3kValueUtils.split(r);return l.shift(),l}return[e]},mergeValueList:function(e){for(var t="("+e.length,r=0,l=e.length;r<l;++r)t+=Kekule.IO.Mdl3kValueUtils.SEPARATOR+e[r];return t+=")"},unquoteValue:function(e){var t=Kekule.IO.Mdl3kValueUtils.STR_QUOTE,r=e.trim();r.substr(0,t.length)==t&&(r=r.substr(t.length)),r.substr(r.length-t.length)==t&&(r=r.substr(0,r.length-t.length));var l=new RegExp(t+t,"g");return r=r.replace(l,t),Kekule.IO.Mdl3kValueUtils.isValueList(r)&&(r=Kekule.IO.Mdl3kValueUtils.splitValueList(r)),r},quoteValue:function(e){var t=Kekule.IO.Mdl3kValueUtils.STR_QUOTE,r=""+e,l=new RegExp(t,"g");return(r=r.replace(l,t+t)).indexOf(Kekule.IO.Mdl3kValueUtils.SEPARATOR)>=0&&(r=t+r+t),r},splitValues:function(e){for(var t=[],r=Kekule.IO.Mdl3kValueUtils.split(e),l=0,a=r.length;l<a;++l){var i=Kekule.IO.Mdl3kValueUtils.splitKeyValue(r[l]);i.value&&(i.value=Kekule.IO.Mdl3kValueUtils.unquoteValue(i.value)),t.push(i)}return t},mergeValues:function(e){for(var t,r=0,l=e.length;r<l;++r){var a,i,n,o=e[r];"object"!=typeof o||Kekule.ArrayUtils.isArray(o)?i=o:(a=o.key,i=o.value),n=Kekule.ArrayUtils.isArray(i)?Kekule.IO.Mdl3kValueUtils.mergeValueList(i):Kekule.IO.Mdl3kValueUtils.quoteValue(i),a&&(n=Kekule.IO.Mdl3kValueUtils.mergeKeyValue(n,a)),t=Kekule.IO.Mdl3kValueUtils.appendToken(t,n)}return t},appendToken:function(e,t,r){var l=r||Kekule.IO.Mdl3kValueUtils.SEPARATOR,a=e||"";return a&&a.substr(a.length-l.length,l.length)!=l?a+=Kekule.IO.Mdl3kValueUtils.SEPARATOR+t:a=t,a}},Kekule.IO.Mdl3kTextBuffer=Class.create(Kekule.TextLinesBuffer,{CLASS_NAME:"Kekule.Mdl3kTextBuffer",LEADING_TAG:"M  V30 ",LINE_CONTI_MARK:"-",MAX_COL_WIDTH:80,initialize:function(e){this.tryApplySuper("initialize",[e])},isStartWithLeadingTag:function(e){return e.substr(0,this.LEADING_TAG.length)==this.LEADING_TAG},isEndWithContinueMark:function(e){var t=e.trim();return t.substr(t.length-this.LINE_CONTI_MARK.length)==this.LINE_CONTI_MARK},getLineWithout3kTag:function(e){if(!e)return e;var t=this.LEADING_TAG.length;return e.substr(0,t)==this.LEADING_TAG?e.substr(t):e},getLineAtEx:function(e){var t=this.getLineAt(e),r=1;if(t&&this.isEndWithContinueMark(t)&&this.isStartWithLeadingTag(this.getLines()[e])){var l=t.lastIndexOf(this.LINE_CONTI_MARK);t=t.substr(0,l);var a=this.getLineAtEx(e+1);t+=a.line,r+=a.lineCount}return{line:t,lineCount:r}},getLineAt:function(e){var t=this.tryApplySuper("getLineAt",[e]);return this.getLineWithout3kTag(t)},readLine:function(){var e=this.getLineAtEx(this.getCurrLineNo());return this.incCurrLineNo(e.lineCount),e.line||""},writeLine:function(e,t){if(t)return this.tryApplySuper("writeLine",[e]);var r,l=e;if(this.isStartWithLeadingTag(e)||(l=this.LEADING_TAG+l),l.length>this.MAX_COL_WIDTH){var a=this.LINE_CONTI_MARK,i=(Kekule.IO.Mdl3kValueUtils.SEPARATOR,this.MAX_COL_WIDTH-a.length);r=l.substr(i),l=l.substr(0,i),l+=a}var n=this.tryApplySuper("writeLine",[l]);return r&&(n=this.writeLine(r,t)),n},writeLines:function(e,t){for(var r=0,l=e.length;r<l;++r)this.writeLine(e[r],t)},getBlockBuffer:function(e,t){for(var r,l=Kekule.IO.Mdl3kUtils.get3kBlockStartTag(e),a=Kekule.IO.Mdl3kUtils.get3kBlockEndTag(e),i=this.getCurrLineNo(),n=this.readLine().trim();n!=l&&!this.eof();)n=this.readLine().trim();if(this.eof())r=null;else{var o=this.getCurrLineNo(),u=this.getCurrLineNo();for(n=this.readLine().trim();n!=a&&!this.eof();)u=this.getCurrLineNo(),n=this.readLine().trim();if(n==a)var s=this.getLines().slice(o,u);else s=this.getLines().slice(o);r=new Kekule.IO.Mdl3kTextBuffer(s)}return t&&this.setCurrLineNo(i),r}}),Kekule.IO.Mdl3kBlockReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.Mdl3kBlockReader",createTextBuffer:function(){return new Kekule.IO.Mdl3kTextBuffer},doReadBlock:function(e,t){var r,l=!(e instanceof Kekule.IO.Mdl3kTextBuffer);l?(r=new Kekule.IO.Mdl3kTextBuffer).setLines(e.getUnreadLines()):r=e;var a=r.getCurrLineNo(),i=this.doRead3kBlock(r,t),n=r.getCurrLineNo();if(l){var o=n-a;e.incCurrLineNo(o)}return i},doRead3kBlock:function(e,t){}}),Kekule.IO.Mdl3kBlockWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.Mdl3kBlockWriter",createTextBuffer:function(){return new Kekule.IO.Mdl3kTextBuffer},writeStartTag:function(e,t){t.writeLine(Kekule.IO.Mdl3kUtils.get3kBlockStartTag(e))},writeEndTag:function(e,t){t.writeLine(Kekule.IO.Mdl3kUtils.get3kBlockEndTag(e))},doWriteBlock:function(e,t,r){var l,a=!(t instanceof Kekule.IO.Mdl3kTextBuffer);a?((l=new Kekule.IO.Mdl3kTextBuffer).setLines(t.getUnreadLines()),l.reset()):l=t;var i=this.doWrite3kBlock(e,l,r);return a&&t.appendLines(a.getLines()),i},doWrite3kBlock:function(e,t,r){}}),Kekule.IO.Mdl3kCTabReader=Class.create(Kekule.IO.Mdl3kBlockReader,{CLASS_NAME:"Kekule.IO.Mdl3kCTabReader",doRead3kBlock:function(e,t){var r=e.getBlockBuffer("CTAB");return r||(r=e).reset(),this.analysisCTab(r)},analysisCTab:function(e){var t={},r=e.readLine(),l=this.analysisCountLine(r);if(!l)return null;var a,i,n=[],o=e.getBlockBuffer("ATOM");if(!o)return Kekule.raise(Kekule.$L("ErrorMsg.MDL3000_ATOMBLOCK_NOT_FOUND")),null;a=this.analysisAtomBlock(o,n);var u,s=e.getBlockBuffer("BOND");s&&(i=this.analysisBondBlock(s,n));var d=e.getBlockBuffer("SGROUP");return d&&(u=this.analysisSGroupBlock(d,n)),t.countInfo=l,t.atomInfos=a,t.atomIndexMap=n,i&&(t.bondInfos=i),u&&(t.sgInfos=u),t},analysisCountLine:function(e){var t={},r=Kekule.IO.Mdl3kValueUtils.splitValues(e);if("COUNTS"==r.shift().value){var l=r.shift().value;return t.atomCount=parseInt(l,10),l=r.shift().value,t.bondCount=parseInt(l,10),l=r.shift().value,t.sgroupCount=parseInt(l,10),l=r.shift().value,t.isChiral=0!=parseInt(l,10),t}Kekule.raise(Kekule.$L("ErrorMsg.MALFORMED_MDL3000_COUNTLINE"))},analysisAtomBlock:function(e,t){for(var r=Kekule.CoordMode.COORD2D,l=[];!e.eof();){var a=e.readLine(),i=this.analysisAtomLine(a),n=l.push(i)-1;t[i.index]=n,i.z&&(r=Kekule.CoordMode.COORD3D)}return l.coordMode=r,l.isCoord3D=r==Kekule.CoordMode.COORD3D,l},analysisAtomLine:function(e,t){var r={},l=Kekule.IO.Mdl3kValueUtils.splitValues(e);r.index=parseInt(l.shift().value,10);var a=l.shift().value.trim();if(Kekule.IO.Mdl3kUtils.isAtomList(a)){var i=Kekule.IO.Mdl3kUtils.analysisAtomList(a);i&&(r.atomListInfo=i,r.symbol="L")}else r.symbol=a;r.x=parseFloat(l.shift().value),r.y=parseFloat(l.shift().value),r.z=parseFloat(l.shift().value),l.shift();for(var n=0,o=l.length;n<o;++n){var u=l[n],s=u.key,d=u.value;switch(s){case"CHG":(m=parseInt(d,10))&&(r.charge=m);break;case"RAD":(m=parseInt(d,10))&&(r.radical=m);break;case"CFG":(m=parseInt(d,10))&&(r.parity=m);break;case"MASS":r.massNumber=parseFloat(d);break;case"VAL":break;case"HCOUNT":(m=parseInt(d,10))&&(r.hydrongenCount=-1==m?0:m-1);break;case"RGROUPS":var m;(m=parseInt(d,10))&&(r.rgroupCount=m)}}return r},analysisBondBlock:function(e,t){for(var r=[];!e.eof();){var l=e.readLine(),a=this.analysisBondLine(l,t);r[a.index]=a}return r},analysisBondLine:function(e,t){var r={},l=Kekule.IO.Mdl3kValueUtils.splitValues(e);r.index=parseInt(l.shift().value,10);var a=l.shift().value;r.order=Kekule.IO.MdlUtils.bondTypeToKekuleOrder(parseInt(a,10)),r.atomIndex1=t[parseInt(l.shift().value,10)],r.atomIndex2=t[parseInt(l.shift().value,10)];for(var i=0,n=l.length;i<n;++i){var o=l[i].key,u=l[i].value;switch(o){case"CFG":var s=parseInt(u,10);r.stereo=Kekule.IO.Mdl3kUtils.bondCfgToKekule(s);break;case"ENDPTS":if(Kekule.ArrayUtils.isArray(u)){r.endAtomIndexes=[];for(var d=0,m=u.length;d<m;++d)r.endAtomIndexes.push(t[parseInt(u[d],10)])}else r.endAtomIndexes=[t[parseInt(u,10)]]}}return r},analysisSGroupBlock:function(e,t){var r=[],l=null,a=e.getCurrLineNo(),i=e.readLine();for("DEFAULT"==Kekule.IO.Mdl3kValueUtils.splitValues(i).shift().value?l=this.fetchSGroupOptionalValues(i,t):e.setCurrLineNo(a);!e.eof();){i=e.readLine();var n=this.analysisSGroupLine(i,t,l);r[n.index]=n}return r},analysisSGroupLine:function(e,t,r){var l={},a=Kekule.IO.Mdl3kValueUtils.splitValues(e);l.index=parseInt(a.shift().value,10),l.sgType=a.shift().value.trim(),l.extIndex=parseInt(a.shift().value,10);var i=this.fetchSGroupOptionalValues(a,t);return r&&(i=Object.extend(r,i)),l=Object.extend(l,i)},fetchSGroupOptionalValues:function(e,t){for(var r={},l=0,a=e.length;l<a;++l){var i=e[l].key,n=e[l].value;switch(i){case"ATOMS":r.atomIndexes=[];for(var o=0,u=n.length;o<u;o++)r.atomIndexes.push(t[n[o]]);break;case"XBONDS":r.crossBondIndexes=[].concat(n);break;case"SUBTYPE":r.subType=n;break;case"LABEL":r.label=n;break;case"CSTATE":r.bondVectors||(r.bondVectors=[]);var s=parseInt(n.shift(),10),d=parseFloat(n.shift())||0,m=parseFloat(n.shift())||0,c=parseFloat(n.shift())||0;r.bondVectors[s]={bondIndex:s,x:d,y:m,z:c};break;case"CLASS":r.sgClass=n}}return r}}),Kekule.IO.Mdl3kCTabWriter=Class.create(Kekule.IO.Mdl3kBlockWriter,{CLASS_NAME:"Kekule.IO.Mdl3kCTabWriter",initialize:function(e){this.tryApplySuper("initialize"),this.setCoordMode(e||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("coordMode",{dataType:DataType.INT,deaultValue:Kekule.CoordMode.UNKNOWN})},doWrite3kBlock:function(e,t,r){return Kekule.IO.MdlUtils.assertIlegalForCtabOutput(e),this.outputCtab(e,t,r)},outputCtab:function(e,t,r){var l=Kekule.IO.MdlStructureUtils.getMoleculeCtabStructureInfo(e,r);this.writeStartTag("CTAB",t),this.getCoordMode()!=Kekule.CoordMode.UNKNOWN&&(l.coordMode=this.getCoordMode()),t.writeLine(this.generateCountLine(l)),this.outputAtomBlock(e,l,t),this.outputBondBlock(e,l,t),this.outputSgroupBlock(e,l,t),this.writeEndTag("CTAB",t)},generateCompatibilityCountLine:function(e){return Kekule.IO.MdlStructureUtils.generateClassicStyleCountLine(e,Kekule.IO.MdlVersion.V3000)},generateCountLine:function(e){var t=["COUNTS"];t.push(e.atoms.length),t.push(e.bonds.length),t.push(e.subGroups.length),t.push(0);var r=e.chiral?1:0;return t.push(r),Kekule.IO.Mdl3kValueUtils.mergeValues(t)},outputAtomBlock:function(e,t,r){this.writeStartTag("ATOM",r);for(var l=0,a=t.atoms.length;l<a;++l){var i=t.atoms[l],n=this.generateAtomLine(l,t.coordMode,i);r.writeLine(n)}this.writeEndTag("ATOM",r)},generateAtomLine:function(e,t,r){var l=Kekule.IO.Mdl3kUtils.coordToStr,a=[e+1,Kekule.IO.MdlStructureUtils.getAtomTypeStr(r)];if(t==Kekule.CoordMode.COORD2D){var i=r.getAbsCoord2D();a=a.concat([l(i.x),l(i.y),l(0)])}else{i=r.getAbsCoord3D();a=a.concat([l(i.x),l(i.y),l(i.z)])}return a.push(0),r.getCharge&&r.getCharge()&&a.push({key:"CHG",value:r.getCharge()}),r.getRadical&&r.getRadical()&&a.push({key:"RAD",value:r.getRadical()}),r.getParity&&r.getParity()&&a.push({key:"CFG",value:r.getParity()}),r.getMassNumber&&r.getMassNumber()&&a.push({key:"MASS",value:r.getMassNumber()}),r.getExplicitHydrogenCount&&!Kekule.ObjUtils.isUnset(r.getExplicitHydrogenCount())&&a.push({key:"HCOUNT",value:r.getExplicitHydrogenCount()+1}),Kekule.IO.Mdl3kValueUtils.mergeValues(a)},outputBondBlock:function(e,t,r){if(!(t.bonds.length<=0)){this.writeStartTag("BOND",r);for(var l=0,a=t.bonds.length;l<a;++l){var i=t.bonds[l],n=this.generateBondLine(l,i,t.atoms);r.writeLine(n)}this.writeEndTag("BOND",r)}},generateBondLine:function(e,t,r){var l=[e+1,Kekule.IO.MdlUtils.kekuleBondOrderToMdlType(t.getBondOrder?t.getBondOrder():Kekule.BondOrder.UNSET)],a=t.getStereo&&t.getStereo()?Kekule.IO.Mdl3kUtils.bondStereoToMdlCfg(t.getStereo(),!0):{},i=[],n=[],o=Kekule.IO.MdlStructureUtils.splitConnectedNodes(t),u=r.indexOf(o.primaryNodes[0])+1,s=r.indexOf(o.primaryNodes[1])+1;if(i=a.inverted?[s,u]:[u,s],o.remainNodes&&o.remainNodes.length)for(var d=0,m=o.remainNodes.length;d<m;++d)n.push(r.indexOf(o.remainNodes[d])+1);return l=l.concat(i),a&&a.cfg&&l.push({key:"CFG",value:a.cfg}),n.length>0&&(l.push({key:"ENDPTS",value:n}),l.push({key:"ATTACH",value:"ALL"})),Kekule.IO.Mdl3kValueUtils.mergeValues(l)},outputSgroupBlock:function(e,t,r){if(!(t.subGroups.length<=0)){this.writeStartTag("SGROUP",r);for(var l=0,a=t.subGroups.length;l<a;++l){var i=this.generateSgroupLine(l,t.subGroups[l],t);r.writeLine(i)}this.writeEndTag("SGROUP",r)}},generateSgroupLine:function(e,t,r){for(var l=r.atoms,a=r.bonds,i=[e+1,"SUP",e+1],n=[],o=0,u=(g=t.getLeafNodes()).length;o<u;++o){(e=l.indexOf(g[o]))>=0&&n.push(e+1)}n=n.sort(),i.push({key:"ATOMS",value:n});var s=t.getAbbr&&t.getAbbr()||t.getFormulaText&&t.getFormulaText()||t.getName&&t.getName();s&&i.push({key:"LABEL",value:s});var d=t.getCrossConnectors(),m=[],c=[],k=Kekule.IO.Mdl3kUtils.coordToStr;for(o=0,u=d.length;o<u;++o){if((e=a.indexOf(d[o]))>=0){m.push(e+1);var g,I=[e+1],O={};2==(g=Kekule.IO.MdlStructureUtils.splitConnectedNodes(d[o]).primaryNodes).length&&(r.coordMode==Kekule.CoordMode.COORD2D?(O=Kekule.CoordUtils.substract(g[0].getAbsCoord2D(),g[1].getAbsCoord2D()),I=I.concat([k(O.x),k(O.y),0])):(O=Kekule.CoordUtils.substract(g[0].getAbsCoord3D(),g[1].getAbsCoord3D()),I=I.concat([k(O.x),k(O.y),k(O.z)]))),c.push(I)}}m=m.sort(),i.push({key:"XBONDS",value:m});for(o=0,u=c.length;o<u;++o)i.push({key:"CSTATE",value:c[o]});return Kekule.IO.Mdl3kValueUtils.mergeValues(i)}}),Kekule.globalOptions.add("IO.mdl",{mdlVersion:Kekule.IO.MdlVersion.V2000,coordMode:Kekule.CoordMode.UNKNOWN,explicitChiralFlagInCountLine:!0}),Kekule.IO.MdlStructureFragmentReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlStructureFragmentReader",initialize:function(e){this.tryApplySuper("initialize"),this.setCoordMode(e||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},createFragment:function(e){},createCtabReader:function(e){return e==Kekule.IO.MdlVersion.V3000?new Kekule.IO.Mdl3kCTabReader:new Kekule.IO.Mdl2kCTabReader},getCtabVersion:function(e){var t=e.getCurrLineNo(),r=e.readLine();e.setCurrLineNo(t);var l=r.substr(33,6).trim();return"V3000"==l?Kekule.IO.MdlVersion.V3000:Kekule.IO.MdlVersion.V2000},createStructureFromJson:function(e,t){var r=this.createFragment();return r&&Kekule.IO.MdlStructureUtils.fillFragment(r,e,this.getCoordMode()),r},doReadBlock:function(e,t){var r=this.getCtabVersion(e);if(!r)return null;var l=this.createCtabReader(r).doReadBlock(e,t);return l.atomInfos.coordMode&&(this._forceCoordMode=l.atomInfos.coordMode),this.createStructureFromJson(l,t)}}),Kekule.IO.MdlStructureFragmentWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.MdlStructureFragmentWriter",initialize:function(e,t){this.tryApplySuper("initialize"),this.setMdlVersion(e||Kekule.IO.MdlVersion.V2000),this.setCoordMode(t||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000}),this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},createCtabWriter:function(e){return e==Kekule.IO.MdlVersion.V3000?new Kekule.IO.Mdl3kCTabWriter(this.getCoordMode()):new Kekule.IO.Mdl2kCTabWriter(this.getCoordMode())},doWriteBlock:function(e,t,r){var l=this.createCtabWriter(this.getMdlVersion()).writeBlock(e,r);t.writeText(l)}}),Kekule.IO.Mdl3kMoleculeCTabReader=Class.create(Kekule.IO.MdlStructureFragmentReader,{CLASS_NAME:"Kekule.IO.Mdl3kMoleculeCTabReader",createFragment:function(e){return new Kekule.Molecule},doReadBlock:function(e,t){var r=this.createCtabReader(Kekule.IO.MdlVersion.V3000).doReadBlock(e,t);return this.createStructureFromJson(r,t)}}),Kekule.IO.Mdl3kMoleculeCTabWriter=Class.create(Kekule.IO.MdlStructureFragmentWriter,{CLASS_NAME:"Kekule.IO.Mdl3kMoleculeCTabWriter",initialize:function(e){this.tryApplySuper("initialize",[Kekule.IO.MdlVersion.V3000,e])},doWriteBlock:function(e,t,r){var l=new Kekule.IO.Mdl3kCTabWriter(this.getCoordMode()).writeBlock(e,r);t.writeText(l)}}),Kekule.IO.MdlMoleculeReader=Class.create(Kekule.IO.MdlStructureFragmentReader,{CLASS_NAME:"Kekule.IO.MdlMoleculeReader",createFragment:function(e){return new Kekule.Molecule},readHeaderInfo:function(e,t){var r={},l=e.readLine();l&&(r.name=l);var a=e.readLine(),i=this.readInfoLine(a);i&&(r=Object.extend(r,i));var n=e.readLine();return n&&(r.comment=n),r},readInfoLine:function(e){var t={};if(e.trim()){var r=e.substr(0,2).trim();r&&(t.userAbbr=r),(r=e.substr(2,8).trim())&&(t.programName=r),(r=e.substr(10,10)).trim()&&(t.date=Kekule.IO.MdlUtils.analysisMdlDateTimeStr(r,!1)),r=e.substr(20,2),t.coordMode="3D"==r?Kekule.CoordMode.COORD3D:"2D"==r?Kekule.CoordMode.COORD2D:Kekule.CoordMode.UNKNOWN}return t},doReadBlock:function(e,t){var r=this.readHeaderInfo(e,t);r&&void 0!==r.coordMode&&this.setCoordMode(r.coordMode);var l=this.tryApplySuper("doReadBlock",[e,t]);(l&&r&&(r.name&&l.setName(r.name),r.userAbbr&&l.setInfoValue("author",r.userAbbr),r.programName&&l.setInfoValue("generator",r.programName),r.date&&l.setInfoValue("date",r.date),r.comment&&l.setInfoValue("comment",r.comment)),e.eof())||"M  END"===e.getCurrLine().trim().toUpperCase()&&e.readLine();return l}}),Kekule.IO.MdlMoleculeWriter=Class.create(Kekule.IO.MdlStructureFragmentWriter,{CLASS_NAME:"Kekule.IO.MdlMoleculeWriter",writeHeaderInfo:function(e,t,r){t.writeLine(e.getName()||Kekule.$L("Texts.UNNAMED")||"");var l=this.generateInfoLine(e);t.writeLine(l);var a=e.getInfoValue("comment");t.writeLine(a||"")},generateInfoLine:function(e){var t="",r=e.getInfoValue("author");t+=r?r.toString().substr(0,2).rpad(2):"  ";var l=e.getInfoValue("generator");t+=l?l.toString().substr(0,8).rpad(8):Kekule.LIBNAME_CORE.rpad(8);var a=e.getInfoValue("date")||new Date;return t+=Kekule.IO.MdlUtils.generateMdlDateTimeStr(a,!1),t+=this.getCoordMode()==Kekule.CoordMode.COORD3D?"3D":"2D"},getMolecule:function(e){return Kekule.ChemStructureUtils.getTotalStructFragment(e)},doWriteBlock:function(e,t,r){var l=this.getMolecule(e);if(l){var a=Kekule.IO.MdlStructureUtils.getMoleculeCtabStructureInfo(l,r);this.setCoordMode(a.coordMode),this.writeHeaderInfo(l,t,r),this.getMdlVersion()==Kekule.IO.MdlVersion.V3000&&t.writeLine(Kekule.IO.MdlStructureUtils.generateClassicStyleCountLine(a,this.getMdlVersion())),this.tryApplySuper("doWriteBlock",[l,t,r]),this.getMdlVersion()==Kekule.IO.MdlVersion.V3000&&t.writeLine("M  END")}}}),Kekule.IO.MdlStructDataReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlStructDataReader",DATA_HEAD_PREFIX:Kekule.IO.MDL.SD_DATA_HEAD_PREFIX,DATA_DBFIELD_PATTERN:/\bDT(\d+)\b/,DATA_KEY_NAME_PATTERN:/\<(.+)\>/,MOL_DELIMITER:Kekule.IO.MDL.MOL_DELIMITER,doReadBlock:function(e,t){var r=new Kekule.IO.MdlMoleculeReader;try{for(var l,a,i,n=[];!e.eof();){try{i=r.doReadBlock(e,null)}catch(e){i=null}if(!i)break;for(n.push(i),l=null,a=null;!e.eof();){var o=this.analysisDataLine(e.readLine());if(o){var u=o.lineType;if("dataheader"===u)l=o.key;else if("datavalue"===u)l&&(a=o.value,i.setInfoValue(l,a));else if("moldelimiter"===u)break}}}if(n.length>1){for(var s=new Kekule.ChemObjList,d=0,m=n.length;d<m;++d)s.append(n[d]);return s}return n[0]}finally{r.finalize()}},analysisDataLine:function(e){var t,r=e.trim();return r.startsWith(this.DATA_HEAD_PREFIX)?("dataheader",(t=this.getDataHeaderKey(e))?{lineType:"dataheader",key:t}:null):r.startsWith(this.MOL_DELIMITER)?{lineType:"moldelimiter"}:r?{lineType:"datavalue",value:e}:null},getDataHeaderKey:function(e){var t=this.DATA_KEY_NAME_PATTERN.exec(e);return t&&t.length>1?t[1]:(t=this.DATA_DBFIELD_PATTERN.exec(e))&&t.length>1?t[1]:e},doReadDataBlock:function(e,t){e.readLine()}}),Kekule.IO.MdlStructDataWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.MdlStructDataWriter",IGNORED_INFO_FIELDS:["generator","author","date","comment"],initialize:function(e,t){this.tryApplySuper("initialize"),this.setMdlVersion(e||Kekule.IO.MdlVersion.V2000),this.setCoordMode(t||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000}),this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},doWriteBlock:function(e,t,r){var l=this.getChildMols(e),a=new Kekule.IO.MdlMoleculeWriter;a.setMdlVersion(this.getMdlVersion()),a.setCoordMode(this.getCoordMode());for(var i=0,n=l.length;i<n;++i){var o=l[i];try{var u=a.writeBlock(o,r);t.writeText(u);var s=this.getMolData(o);this.doWriteDataBlock(s,t,r),t.writeLine(Kekule.IO.MDL.MOL_DELIMITER)}catch(e){}}},doWriteDataBlock:function(e,t,r){for(var l=Kekule.ObjUtils.getOwnedFieldNames(e),a=0,i=l.length;a<i;++a){var n=l[a];if(this.IGNORED_INFO_FIELDS.indexOf(n)<0){var o=Kekule.IO.MDL.SD_DATA_HEAD_PREFIX+" <"+n+">",u=e[n];o&&u&&(t.writeLine(o),t.writeLine(u),t.writeLine(""))}}},getChildMols:function(e){for(var t=Kekule.ChemStructureUtils.getChildStructureObjs(e,!0),r=[],l=0,a=t.length;l<a;++l){var i=t[l];i instanceof Kekule.StructureFragment&&r.push(i)}return r},getMolData:function(e){return e.getInfo?e.getInfo()||{}:null}}),Kekule.IO.MdlBaseReactionReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlBaseReactionReader",readHeaderBlock:function(e,t){var r,l={},a=e.readLine().trim();return"$RXN"!=(r=a.substr(0,4))?(Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL_RXN_DATA")),null):(r=a.substr(4).trim(),l.version="V3000"==r?Kekule.IO.MdlVersion.V3000:Kekule.IO.MdlVersion.V2000,(a=e.readLine().trim())&&(l.name=a),(r=(a=e.readLine()).substr(0,6).trim())&&(l.userAbbr=r),(r=a.substr(6,9).trim())&&(l.programName=r),(r=a.substr(15,10)).trim()&&(l.date=Kekule.IO.MdlUtils.analysisMdlDateTimeStr(r,!0)),(a=e.readLine().trim())&&(l.comment=a),l)},readSubstanceCountLine:function(e){},readMolBlock:function(e){},doReadBlock:function(e,t){for(var r=this.readHeaderBlock(e,null),l=this.readSubstanceCountLine(e.readLine()),a=new Kekule.Reaction,i=0;i<l.reactantCount;++i){(n=this.readMolBlock(e))&&a.appendReactant(n)}for(i=0;i<l.productCount;++i){var n;(n=this.readMolBlock(e))&&a.appendProduct(n)}return a&&r&&(r.name&&a.setName(r.name),r.userAbbr&&a.setInfoValue("author",r.userAbbr),r.programName&&a.setInfoValue("generator",r.programName),r.date&&a.setInfoValue("date",r.date),r.comment&&a.setInfoValue("comment",r.comment)),a}}),Kekule.IO.Mdl2kReactionReader=Class.create(Kekule.IO.MdlBaseReactionReader,{CLASS_NAME:"Kekule.IO.Mdl2kReactionReader",readHeaderBlock:function(e,t){var r=this.tryApplySuper("readHeaderBlock",[e,t]);return r.version!=Kekule.IO.MdlVersion.V2000?(Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL2000_RXN_DATA")),null):r},readSubstanceCountLine:function(e){var t={};return t.reactantCount=parseInt(e.substr(0,3),10)||0,t.productCount=parseInt(e.substr(3,3),10)||0,t},readMolBlock:function(e){for(var t=e.readLine();"$MOL"!==t&&!e.eof();)t=e.readLine();if(e.eof())return null;var r=[];for(t=e.getCurrLine();"$MOL"!==t&&!e.eof();)r.push(t),e.incCurrLineNo(),t=e.getCurrLine();return(new Kekule.IO.MdlMoleculeReader).readBlock(r,null)}}),Kekule.IO.Mdl3kReactionReader=Class.create(Kekule.IO.MdlBaseReactionReader,{CLASS_NAME:"Kekule.IO.Mdl3kReactionReader",createTextBuffer:function(){return new Kekule.IO.Mdl3kTextBuffer},readHeaderBlock:function(e,t){var r=this.tryApplySuper("readHeaderBlock",[e,t]);return r.version!=Kekule.IO.MdlVersion.V3000?(Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL3000_RXN_DATA")),null):r},readSubstanceCountLine:function(e){var t={},r=Kekule.IO.Mdl3kValueUtils.splitValues(e);return"COUNTS"!=r.shift().value.trim()?(Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL3000_RXN_COUNTLINE")),null):(t.reactantCount=parseInt(r.shift().value,10)||0,t.productCount=parseInt(r.shift().value,10)||0,t)},readMolBlock:function(e){if(e.getBlockBuffer){var t=e.getBlockBuffer("CTAB");return(new Kekule.IO.Mdl3kMoleculeCTabReader).doReadBlock(t)}return null}}),Kekule.IO.MdlReactionReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlReactionReader",doReadBlock:function(e,t){return(Kekule.IO.MdlUtils.getRxnMarkVersion(e.getCurrLine())==Kekule.IO.MdlVersion.V3000?new Kekule.IO.Mdl3kReactionReader:new Kekule.IO.Mdl2kReactionReader).readBlock(e.getUnreadLines(),t)}}),Kekule.IO.MdlReactionWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.MdlReactionWriter",initialize:function(e,t){this.tryApplySuper("initialize"),this.setMdlVersion(e||Kekule.IO.MdlVersion.V2000),this.setCoordMode(t||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000}),this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},writeHeaderBlock:function(e,t,r){var l;l="$RXN"+(this.getMdlVersion()==Kekule.IO.MdlVersion.V3000?" "+Kekule.IO.MDL.VER3000:""),t.writeLine(l),t.writeLine(e.getName()||""),l=(e.getInfoValue("author")||"").substr(0,6).rpad(6),l+=(e.getInfoValue("generator")||"").substr(0,9).rpad(9);var a=e.getInfoValue("date")||new Date;l+=Kekule.IO.MdlUtils.generateMdlDateTimeStr(a,!0),t.writeLine(l);var i=e.getInfoValue("comment")||"";t.writeLine(i)},generateSubstanceCountLine:function(e){return this.getMdlVersion()==Kekule.IO.MdlVersion.V3000?"M  V30 COUNTS "+Kekule.IO.Mdl3kValueUtils.mergeValues([e.getReactantCount(),e.getProductCount()]):e.getReactantCount().toString().lpad(3)+e.getProductCount().toString().lpad(3)},writeMolDelimiterLine:function(e){this.getMdlVersion()==Kekule.IO.MdlVersion.V2000&&e.writeLine("$MOL")},writeMolBlock:function(e,t,r){var l=(this.getMdlVersion()==Kekule.IO.MdlVersion.V3000?new Kekule.IO.Mdl3kMoleculeCTabWriter(this.getCoordMode()):new Kekule.IO.MdlMoleculeWriter(this.getMdlVersion(),this.getCoordMode())).writeBlock(e,r);t.writeText(l)},doWriteBlock:function(e,t,r){var l=this.getMdlVersion()==Kekule.IO.MdlVersion.V3000;this.writeHeaderBlock(e,t,r);var a=this.generateSubstanceCountLine(e);t.writeLine(a),l&&t.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockStartTag("REACTANT"));for(var i=0;i<e.getReactantCount();++i)this.writeMolDelimiterLine(t),this.writeMolBlock(e.getReactantAt(i),t,r);l&&t.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockEndTag("REACTANT")),l&&t.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockStartTag("PRODUCT"));for(i=0;i<e.getProductCount();++i)this.writeMolDelimiterLine(t),this.writeMolBlock(e.getProductAt(i),t,r);l&&(t.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockEndTag("PRODUCT")),t.writeLine("M  END"))}}),Kekule.IO.BaseMdlReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.BaseMdlReader",doReadData:function(e,t,r){return t!=Kekule.IO.ChemDataType.TEXT?(Kekule.error(Kekule.$L("ErrorMsg.MDL_INPUT_DATATYPE_NOT_TEXT")),null):this.doReadMdlData(e)},doReadMdlData:function(e){return null}}),Kekule.IO.BaseMdlWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.BaseMdlWriter",initialize:function(e){this.tryApplySuper("initialize",[e]),e||(e={}),this.setMdlVersion(e.mdlVersion||Kekule.globalOptions.IO.mdl.mdlVersion),this.setCoordMode(e.coordMode||Kekule.globalOptions.IO.mdl.coordMode)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000}),this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},writeData:function(e,t,r,l){var a={explicitChiralFlagInCountLine:Kekule.globalOptions.IO.mdl.explicitChiralFlagInCountLine},i=l?Object.extend(a,l):a;return this.tryApplySuper("writeData",[e,t,r,i])},doWriteData:function(e,t,r,l){var a=t||Kekule.IO.ChemDataType.TEXT;return a!=Kekule.IO.ChemDataType.TEXT?(Kekule.error(Kekule.$L("ErrorMsg.MDL_OUTPUT_DATATYPE_NOT_TEXT")),null):this.tryApplySuper("doWriteData",[e,a,r,l])}}),Kekule.IO.MdlMolReader=Class.create(Kekule.IO.BaseMdlReader,{CLASS_NAME:"Kekule.IO.MdlMolReader",doReadMdlData:function(e){return(new Kekule.IO.MdlMoleculeReader).readBlock(e,null)}}),Kekule.IO.MdlMolWriter=Class.create(Kekule.IO.BaseMdlWriter,{CLASS_NAME:"Kekule.IO.MdlMolWriter",doWriteData:function(e,t,r,l){return new Kekule.IO.MdlMoleculeWriter(this.getMdlVersion(),this.getCoordMode()).writeBlock(e,l)}}),Kekule.IO.MdlSdReader=Class.create(Kekule.IO.BaseMdlReader,{CLASS_NAME:"Kekule.IO.MdlSdReader",doReadMdlData:function(e){return(new Kekule.IO.MdlStructDataReader).readBlock(e,null)}}),Kekule.IO.MdlSdWriter=Class.create(Kekule.IO.BaseMdlWriter,{CLASS_NAME:"Kekule.IO.MdlSdWriter",doWriteData:function(e,t,r,l){return new Kekule.IO.MdlStructDataWriter(this.getMdlVersion(),this.getCoordMode()).writeBlock(e,l)}}),Kekule.IO.MdlRxnReader=Class.create(Kekule.IO.BaseMdlReader,{CLASS_NAME:"Kekule.IO.MdlRxnReader",doReadMdlData:function(e){return(new Kekule.IO.MdlReactionReader).readBlock(e,null)}}),Kekule.IO.MdlRxnWriter=Class.create(Kekule.IO.BaseMdlWriter,{CLASS_NAME:"Kekule.IO.MdlRxnWriter",doWriteData:function(e,t,r,l){return new Kekule.IO.MdlReactionWriter(this.getMdlVersion(),this.getCoordMode()).writeBlock(e,l)}}),Kekule.IO.MdlReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.MdlReader",doReadData:function(e,t,r){return t!=Kekule.IO.ChemDataType.TEXT?(Kekule.error(Kekule.$L("ErrorMsg.MDL_INPUT_DATATYPE_NOT_TEXT")),null):("$RXN"==e.substr(0,4)?new Kekule.IO.MdlReactionReader:new Kekule.IO.MdlMoleculeReader).readBlock(e,null)}}),Kekule.IO.MdlWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.MdlWriter",initialize:function(e){this.tryApplySuper("initialize",[e]);var t=e||{};this.setMdlVersion(t.mdlVersion||Kekule.globalOptions.IO.mdl.mdlVersion),this.setCoordMode(t.coordMode||Kekule.globalOptions.IO.mdl.coordMode)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000}),this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},doWriteData:function(e,t,r,l){var a;if(e instanceof Kekule.Reaction)a=new Kekule.IO.MdlRxnWriter(this.getMdlVersion(),this.getCoordMode());else{if(!(e instanceof Kekule.StructureFragment)){var i=e&&e.getClassName?e.getClassName():typeof e;return Kekule.error(Kekule.$L("ErrorMsg.UNABLE_TO_OUTPUT_AS_MDL").format(i)),null}a=new Kekule.IO.MdlMolWriter(this.getMdlVersion(),this.getCoordMode())}if(a)return a.writeData(e,t,l)}}),function(){Kekule.IO.DataFormat.MOL="mol",Kekule.IO.DataFormat.RXN="rxn",Kekule.IO.DataFormat.SD="sd",Kekule.IO.DataFormat.MOL3K="mol3k",Kekule.IO.DataFormat.RXN3K="rxn3k",Kekule.IO.MimeType.MDL_MOL="chemical/x-mdl-molfile",Kekule.IO.MimeType.MDL_RXN="chemical/x-mdl-rxnfile",Kekule.IO.MimeType.MDL_SD="chemical/x-mdl-sdfile",Kekule.IO.DataFormatsManager.register("mol",Kekule.IO.MimeType.MDL_MOL,"mol",Kekule.IO.ChemDataType.TEXT,"MDL Mol 2000 format"),Kekule.IO.DataFormatsManager.register("rxn",Kekule.IO.MimeType.MDL_RXN,"rxn",Kekule.IO.ChemDataType.TEXT,"MDL Reaction 2000 format"),Kekule.IO.DataFormatsManager.register("sd",Kekule.IO.MimeType.MDL_SD,["sd","sdf"],Kekule.IO.ChemDataType.TEXT,"MDL Structure-Data format"),Kekule.IO.DataFormatsManager.register("mol3k",Kekule.IO.MimeType.MDL_MOL,"mol",Kekule.IO.ChemDataType.TEXT,"MDL Mol 3000 format"),Kekule.IO.DataFormatsManager.register("rxn3k",Kekule.IO.MimeType.MDL_RXN,"rxn",Kekule.IO.ChemDataType.TEXT,"MDL Reaction 3000 format"),Kekule.IO.ChemDataReaderManager.register("MDL-mol",Kekule.IO.MdlMolReader,["mol","mol3k"]),Kekule.IO.ChemDataReaderManager.register("MDL-rxn",Kekule.IO.MdlRxnReader,["rxn","rxn3k"]),Kekule.IO.ChemDataReaderManager.register("MDL-general",Kekule.IO.MdlReader,["mol","mol3k","rxn","rxn3k"]),Kekule.IO.ChemDataReaderManager.register("MDL-sd",Kekule.IO.MdlSdReader,"sd");var e=[Kekule.StructureFragment,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace];Kekule.IO.ChemDataWriterManager.register("MDL-mol",Kekule.IO.MdlMolWriter,e,"mol"),Kekule.IO.ChemDataWriterManager.register("MDL-mol3k",Kekule.IO.MdlMolWriter,e,"mol3k",{createOptions:{mdlVersion:Kekule.IO.MdlVersion.V3000}}),Kekule.IO.ChemDataWriterManager.register("MDL-rxn",Kekule.IO.MdlRxnWriter,[Kekule.Reaction],"rxn"),Kekule.IO.ChemDataWriterManager.register("MDL-rxn3k",Kekule.IO.MdlRxnWriter,[Kekule.Reaction],"rxn3k"),Kekule.IO.ChemDataWriterManager.register("MDL-sd",Kekule.IO.MdlSdWriter,e,"sd")}(),function(){"use strict";var e=Kekule.ArrayUtils;Kekule.IO.SMILES={ATOM_BRACKET_LEFT:"[",ATOM_BRACKET_RIGHT:"]",ATOM_WILDCARD:"*",ATOM_H:"H",ORGAN_SUBSET_ATOMS:["B","C","N","O","S","P","F","Cl","Br","I"],AROMATIC_SUBSET_ATOMS:["B","C","N","O","S","P"],BOND_SINGLE:"-",BOND_DOUBLE:"=",BOND_TRIPLE:"#",BOND_QUAD:"$",BOND_AROMATIC:":",BOND_FAKE:".",RING_BOND_TWO_DIGIT_NO_PREFIX:"%",BRANCH_BRACKET_LEFT:"(",BRANCH_BRACKET_RIGHT:")",ROTATION_DIR_CLOCKWISE:"@@",ROTATION_DIR_ANTICLOCKWISE:"@",DIRECTION_BOND_SYMBOLS:["/","\\"]};var t=Kekule.IO.SMILES;Kekule.IO.SMILES.PrimaryPathMode={LONGEST:0,HEAVIEST:1,RANDOM:2},Kekule.IO.SMILES.StartingVertexMode={MANUAL:0,HEAVIEST:1,LIGHTEST:2,RANDOM:3},Kekule.IO.SmilesGenerationMode={HEAVIEST_AND_LONGEST:0,HEAVIEST:1,LIGHTEST_AND_LONGEST:2,RANDOM:3},Kekule.IO.SmilesUtils={createGraphDepthSpanningTreesEx:function(e,r,l){var a=l&&l.primaryPathMode||t.PrimaryPathMode.LONGEST,i=l&&l.startingVertexMode||t.StartingVertexMode.MANUAL;return Kekule.IO.SmilesUtils.doCreateGraphDepthSpanningTreesEx(e,r,a,i)},doCreateGraphDepthSpanningTreesEx:function(r,l,a,i){for(var n=function(e){var r={vertexes:[],edges:[],primaryPath:{vertexes:[],edges:[],length:0}},l=e;l.getData("__$visitedEx__")||(r.vertexes.push(l),l.setData("__$visitedEx__",!0));for(var i,o=l.getEdges(),u=-1,s=a===t.PrimaryPathMode.RANDOM?Math.floor(Math.random()*o.length):-1,d=0,m=o.length;d<m;++d){var c=!1,k=o[d],g=l.getNeighborOnEdge(k);if(!g.getData("__$visitedEx__")){r.vertexes.push(g),r.edges.push(k),g.setData("__$visitedEx__",!0);var I=n(g);if(r.vertexes=r.vertexes.concat(I.vertexes),r.edges=r.edges.concat(I.edges),s>=0&&d===s)c=!0;else if(a===t.PrimaryPathMode.HEAVIEST){var O=g.getData("__$weight__");O>u&&(u=O,c=!0)}else(I.primaryPath.length>r.primaryPath.length||!r.primaryPath.length)&&(c=!0);c&&(r.primaryPath.vertexes=I.primaryPath.vertexes,r.primaryPath.edges=I.primaryPath.edges,r.primaryPath.length=I.primaryPath.length,i=k)}}return i&&(r.primaryPath.edges.unshift(i),r.primaryPath.length=(r.primaryPath.length||0)+1),r.primaryPath.vertexes.unshift(l),r},o=function(e,r){return r===t.StartingVertexMode.LIGHTEST?e[0]:r===t.StartingVertexMode.RANDOM?e[Math.floor(Math.random()*e.length)]:e[e.length-1]},u=e.clone(r.getVertexes()),s=a===t.PrimaryPathMode.HEAVIEST,d=0,m=u.length;d<m;++d)u[d].setData("__$visitedEx__",!1),s&&u[d].setData("__$weight__",d);for(var c=i===t.StartingVertexMode.MANUAL?l:o(u,i),k=[];u.length;){var g;g=c&&u.indexOf(c)>=0?c:o(u,i);var I={vertexes:[],edges:[],primaryPath:{vertexes:[],edges:[],length:0}},O=n(g);I.vertexes=I.vertexes.concat(O.vertexes),I.edges=I.edges.concat(O.edges),I.primaryPath.length=(I.primaryPath.length||0)+O.primaryPath.length,I.primaryPath.vertexes=I.primaryPath.vertexes.concat(O.primaryPath.vertexes),I.primaryPath.edges=I.primaryPath.edges.concat(O.primaryPath.edges),u=e.exclude(u,O.vertexes),k.push(I)}return k}},Kekule.IO.SmilesMolWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.SmilesMolWriter",doWriteData:function(e,t,r,l){var a=this.getMolecule(e);return l&&l.generationMode===Kekule.IO.SmilesGenerationMode.RANDOM&&l.randomOutputCount>1?a?this._outputRandomSmiles(a,l.randomOutputCount,l):[]:a?this.writeStructFragment(a,l):""},_outputRandomSmiles:function(e,t,r){var l=[],a=Math.round(1.5*t),i=Object.create(r);i.generationMode=Kekule.IO.SmilesGenerationMode.RANDOM;for(var n=0;n<a;++n){var o=this.writeStructFragment(e,i);if(l.indexOf(o)<0&&(l.push(o),l.length>=t))break}return l},getMolecule:function(e){return Kekule.ChemStructureUtils.getTotalStructFragment(e)},writeStructFragment:function(r,l){if(r.hasCtab()&&!r.isEmpty()){var a=r.clone();a.standardize&&(a.clean({hangingChemConnector:!0,orphanChemNode:!1}),a.standardize({cleanStructure:!1}));var i=[],n=[];if(a.getAromaticRings)for(var o=a.getAromaticRings(),u=0,s=o.length;u<s;++u){var d=o[u];e.pushUnique(i,d.nodes),e.pushUnique(n,d.connectors)}var m=Kekule.BondType,c=Kekule.GraphAdaptUtils.ctabToGraph(a.getCtab(),null,{expandSubStructures:!0,ignoreBondedHydrogen:!0,bondTypes:[m.COVALENT,m.UNKNOWN]}),k=c.getVertexes(),g=(c.getEdges(),k[k.length-1]),I=Kekule.IO.SmilesGenerationMode,O=l&&l.generationMode,f={primaryPathMode:O===I.HEAVIEST?t.PrimaryPathMode.HEAVIEST:O===I.RANDOM?t.PrimaryPathMode.RANDOM:t.PrimaryPathMode.LONGEST,startingVertexMode:O===I.RANDOM?t.StartingVertexMode.RANDOM:O===I.LIGHTEST_AND_LONGEST?t.StartingVertexMode.LIGHTEST:t.StartingVertexMode.HEAVIEST},C=Kekule.IO.SmilesUtils.createGraphDepthSpanningTreesEx(c,g,f),h=this._prepareStereoBondsInformation(a.getCtab(),l),K=[],p="";for(u=0,s=C.length;u<s;++u){var M,E=C[u],T=E.primaryPath,D=T.vertexes[0];M=this._writeMolVertex(D,null,T.edges,E.edges,K,i,n,{bondStereoDirMap:h},l),0===u?p=M:p+=t.BOND_FAKE+M}return p}return""},_prepareStereoBondsInformation:function(e,t){var r=t.ignoreStereoBond;if(Kekule.ObjUtils.isUnset(r)&&(r=t.ignoreStereo||!1),r)return null;for(var l=0,a=new Kekule.MapEx,i=0,n=e.getConnectorCount();i<n;++i){var o=e.getConnectorAt(i);if(o.getParity&&o.getParity()){++l;for(var u=Kekule.MolStereoUtils.getStereoBondKeyNeighborConnectors(o),s=this._getStereoDoubleBondInitialDirectionSymbols(o),d=[],m=0,c=0,k=u.length;c<k;++c)a.has(u[c])&&(d[c]=!0,s[c]!==a.get(u[c])&&++m);if(m<2)for(c=0,k=u.length;c<k;++c)if(!d[c]){var g=1===m?this._getInvertBondDirectionSymbol(s[c]):s[c];a.set(u[c],g)}}}return l?a:null},_writeMolVertex:function(e,r,l,a,i,n,o,u,s){var d,m,c=e.getData("object"),k=e.getEdges(),g=[],I=[],O=[],f=[],C=s.ignoreStereoBond;Kekule.ObjUtils.isUnset(C)&&(C=s.ignoreStereo||!1);for(var h=k.length-1;h>=0;--h){var K=k[h];if(K!==r){var p=K.getData("object");if(a.indexOf(K)>=0){var M=e.getNeighborOnEdge(K),E=this._writeMolVertex(M,K,l,a,i,n,o,u,s);l.indexOf(K)>=0?(m=M,d=E):(I.push(M),g.push(E))}else{var T=i.indexOf(K);T<0&&(T=i.length,i.push(K)),f.push(e.getNeighborOnEdge(K));var D=this._outputConnectorStr(p,K.getVertexes()[0].getData("object"),K.getVertexes()[1].getData("object"),n,o,u.bondStereoDirMap);D+=(T+=1)<10?T:t.RING_BOND_TWO_DIGIT_NO_PREFIX+T,O.push(D)}}}var A,L="";if(r){"",A=e.getNeighborOnEdge(r).getData("object");var y=r.getData("object");L+=this._outputConnectorStr(y,r.getVertexes()[0].getData("object"),r.getVertexes()[1].getData("object"),n,o,u.bondStereoDirMap)}for(var S=[],R=(h=0,f.length);h<R;++h)S.push(f[h].getData("object"));for(h=0,R=I.length;h<R;++h)S.push(I[h].getData("object"));m&&S.push(m.getData("object")),L+=this._outputNodeStr(c,n.indexOf(c)>=0,A,S,s);for(h=0,R=O.length;h<R;++h)L+=O[h];!d&&g.length&&(d=g.shift());for(h=0,R=g.length;h<R;++h)L+=t.BRANCH_BRACKET_LEFT+g[h]+t.BRANCH_BRACKET_RIGHT;return L+="",d&&(L+=d),L},_outputNodeStr:function(e,r,l,a,i){var n,o;e instanceof Kekule.Atom?(n=o=e.getSymbol(),r&&(n=n.toLowerCase())):n=t.ATOM_WILDCARD;var u,s=i.ignoreStereoAtom;if(Kekule.ObjUtils.isUnset(s)&&(s=i.ignoreStereo||!1),!s&&e.getParity&&e.getParity()&&a&&a.length){var d=e.getLinkedHydrogenAtomsWithSingleBond();d&&1===d.length&&a.indexOf(d[0])<0&&a.push(d[0]);var m=e.getHydrogenCount&&e.getHydrogenCount(!1)||0;if(d.length&&m)u="";else{var c=Kekule.MolStereoUtils.calcTetrahedronChiralCenterRotationDirection(null,e,l,a,!!m,!1,{allowExplicitHydrogen:!0,allowExplicitVerticalHydrogen:!0});u=c===Kekule.RotationDir.CLOCKWISE?t.ROTATION_DIR_CLOCKWISE:c===Kekule.RotationDir.ANTICLOCKWISE?t.ROTATION_DIR_ANTICLOCKWISE:""}u&&(n+=u)}var k=this._getNodeHydrogenCount(e,i),g=!0,I=e.getRadical?Math.round(e.getRadical()||0):0;if(u);else if(I);else if(e instanceof Kekule.Atom)if(k&&r&&"C"!==o);else if((i.ignoreExplicitHydrogens||i.ignoreImplicitHydrogens)&&k!==this._getNodeHydrogenCount(e,{}));else{var O=e.getValence&&e.getValence()||0,f=Kekule.ValenceUtils.getMaxPossibleValence(e.getAtomicNumber(),e.getCharge())||0;if(O)if(O>f&&k);else if(e.hasExplicitHydrogens())(e.getExplicitHydrogenCount()||0)===(e.getImplicitHydrogenCount()||0)&&(g=!1);else(e.getValence&&e.getValence({ignoreExplicitHydrogens:!0,ignoreBondHydrogens:!0})||0)<O||(g=!1)}g&&((m=Math.round(k))>0&&(n+=t.ATOM_H),m>1&&(n+=m));var C=Math.round(e.getCharge());if(C){var h=C>0?"+":"-";(C>1||C<-1)&&(h=Math.abs(C)+h),n+=h}var K=e.getMassNumber?e.getMassNumber():null;K&&(n=Math.abs(K)+n);var p=!1;return g||C||K||u||I||(!r&&t.ORGAN_SUBSET_ATOMS.indexOf(o)>=0||r&&t.AROMATIC_SUBSET_ATOMS.indexOf(o)>=0)&&(p=!0),p||(n=t.ATOM_BRACKET_LEFT+n+t.ATOM_BRACKET_RIGHT),n},_getNodeHydrogenCount:function(e,t){var r=e.getLinkedHydrogenAtomsWithSingleBondCount&&e.getLinkedHydrogenAtomsWithSingleBondCount(!0)||0,l=e.getExplicitHydrogenCount&&e.getExplicitHydrogenCount();(t.ignoreExplicitHydrogens||(r+=l||0),Kekule.ObjUtils.isUnset(l)&&!t.ignoreImplicitHydrogens)&&(r+=e.getImplicitHydrogenCount&&e.getImplicitHydrogenCount()||0);return r},_outputConnectorStr:function(e,r,l,a,i,n){if(e instanceof Kekule.Bond){if(e.getBondType()===Kekule.BondType.COVALENT){if(i.indexOf(e)>=0)return"";var o=a.indexOf(r)>=0&&a.indexOf(l)>=0,u=e.getBondOrder(),s=Kekule.BondOrder,d=u===s.DOUBLE?t.BOND_DOUBLE:u===s.TRIPLE?t.BOND_TRIPLE:u===s.QUAD?t.BOND_QUAD:o?t.BOND_SINGLE:"";return n&&n.has(e)&&(d+=n.get(e)),d}return""}return t.BOND_FAKE},_getStereoDoubleBondInitialDirectionSymbols:function(e){var r=e.getParity();return r?r===Kekule.StereoParity.EVEN?[t.DIRECTION_BOND_SYMBOLS[0],t.DIRECTION_BOND_SYMBOLS[0]]:[t.DIRECTION_BOND_SYMBOLS[0],t.DIRECTION_BOND_SYMBOLS[1]]:["",""]},_getInvertBondDirectionSymbol:function(e){return e===t.DIRECTION_BOND_SYMBOLS[1]?t.DIRECTION_BOND_SYMBOLS[0]:t.DIRECTION_BOND_SYMBOLS[1]}}),Kekule.IO.MimeType.SMILES="chemical/x-daylight-smiles",Kekule.IO.DataFormat.SMILES="smi";Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.SMILES,Kekule.IO.MimeType.SMILES,["smi","smiles"],Kekule.IO.ChemDataType.TEXT,"SMILES format");var r=[Kekule.StructureFragment,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace];Kekule.IO.ChemDataWriterManager.register("SMILES",Kekule.IO.SmilesMolWriter,r,[Kekule.IO.DataFormat.SMILES])}(),Kekule.globalOptions.add("IO.kekuleNative",{prettyPrint:!0}),Kekule.IO.KcjReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.KcjReader",readData:function(e,t){var r,l=t||Kekule.IO.ChemDataType.TEXT;return l==Kekule.IO.ChemDataType.JSON&&(r=e),l!=Kekule.IO.ChemDataType.TEXT?(Kekule.error(Kekule.$L("ErrorMsg.KCJ_INPUT_DATATYPE_NOT_JSON_OR_TEXT")),null):(r=DataType.JsonUtility.parse(e),this.tryApplySuper("readData",[r,Kekule.IO.ChemDataType.JSON]))},doReadData:function(e,t){var r=Class.ObjSerializerFactory.getSerializer("json");return r?r.load(null,e):(Kekule.error(Kekule.$L("ErrorMsg.JSON_SERIALIZER_NOT_EXISTS")),null)}}),Kekule.IO.KcjWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.KcjWriter",initialize:function(e){this.tryApplySuper("initialize",[e]);var t=e||{};this.setPrettyPrint(Kekule.ObjUtils.isUnset(t.prettyPrint)?Kekule.globalOptions.IO.kekuleNative.prettyPrint:t.prettyPrint)},initProperties:function(){this.defineProp("prettyPrint",{dataType:DataType.BOOL,defaultValue:!0})},writeData:function(e,t,r,l){var a=t||Kekule.IO.ChemDataType.TEXT;if(a!=Kekule.IO.ChemDataType.JSON&&a!=Kekule.IO.ChemDataType.TEXT)return Kekule.error(Kekule.$L("ErrorMsg.KCJ_OUTPUT_DATATYPE_NOT_JSON_OR_TEXT")),null;var i=this.tryApplySuper("writeData",[e,Kekule.IO.ChemDataType.JSON]);if(a==Kekule.IO.ChemDataType.JSON)return i;if(a==Kekule.IO.ChemDataType.TEXT){var n=l&&Kekule.ObjUtils.notUnset(l.prettyPrint)?l.prettyPrint:this.getPrettyPrint();return DataType.JsonUtility.serializeToStr(i,{prettyPrint:n})}},doWriteData:function(e,t,r,l){var a=Class.ObjSerializerFactory.getSerializer("json");if(!a)return Kekule.error(Kekule.$L("ErrorMsg.JSON_SERIALIZER_NOT_EXISTS")),null;var i={};return a.save(e,i),i}}),Kekule.IO.KcxReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.KcxReader",readData:function(e,t){var r,l=t||Kekule.IO.ChemDataType.TEXT;return l==Kekule.IO.ChemDataType.DOM&&(r=e),l!=Kekule.IO.ChemDataType.TEXT?(Kekule.error(Kekule.$L("ErrorMsg.KCX_INPUT_DATATYPE_NOT_DOM_OR_TEXT")),null):(r=DataType.XmlUtility.parse(e).documentElement,this.tryApplySuper("readData",[r,Kekule.IO.ChemDataType.DOM]))},doReadData:function(e,t){var r=Class.ObjSerializerFactory.getSerializer("xml");return r?r.load(null,e):(Kekule.error(Kekule.$L("ErrorMsg.XML_SERIALIZER_NOT_EXISTS")),null)}}),Kekule.IO.KcxWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.KcxWriter",initialize:function(e){this.tryApplySuper("initialize",[e]);var t=e||{};this.setPrettyPrint(Kekule.ObjUtils.isUnset(t.prettyPrint)?Kekule.globalOptions.IO.kekuleNative.prettyPrint:t.prettyPrint),this.setRootTag(t.rootTag||"kcx")},initProperties:function(){this.defineProp("prettyPrint",{dataType:DataType.BOOL,defaultValue:!0}),this.defineProp("rootTag",{dataType:DataType.STRING})},writeData:function(e,t){var r=t||Kekule.IO.ChemDataType.TEXT;if(r!=Kekule.IO.ChemDataType.DOM&&r!=Kekule.IO.ChemDataType.TEXT)return Kekule.error(Kekule.$L("ErrorMsg.KCX_OUTPUT_DATATYPE_NOT_DOM_OR_TEXT")),null;var l=this.tryApplySuper("writeData",[e,Kekule.IO.ChemDataType.DOM]);if(r==Kekule.IO.ChemDataType.DOM)return l;if(r==Kekule.IO.ChemDataType.TEXT){var a={prettyPrint:this.getPrettyPrint()};return DataType.XmlUtility.serializeNode(l,a)}},doWriteData:function(e,t){var r=Class.ObjSerializerFactory.getSerializer("xml");if(!r)return Kekule.error(Kekule.$L("ErrorMsg.XML_SERIALIZER_NOT_EXISTS")),null;var l=DataType.XmlUtility.newDocument(this.getRootTag());return r.save(e,l.documentElement),l.documentElement}}),function(){Kekule.IO.MimeType.KEKULE_JSON="chemical/x-kekule-json",Kekule.IO.MimeType.KEKULE_XML="chemical/x-kekule-xml",Kekule.IO.DataFormat.KEKULE_JSON="Kekule-JSON",Kekule.IO.DataFormat.KEKULE_XML="Kekule-XML",Kekule.IO.DataFormatsManager.register("JSON",Kekule.IO.MimeType.JSON,"json",Kekule.IO.ChemDataType.TEXT,"JSON format"),Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.KEKULE_JSON,Kekule.IO.MimeType.KEKULE_JSON,"kcj",Kekule.IO.ChemDataType.TEXT,"Kekule Chemical JSON format"),Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.KEKULE_XML,Kekule.IO.MimeType.KEKULE_XML,"kcx",Kekule.IO.ChemDataType.TEXT,"Kekule Chemical XML format");var e=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.JSON),t=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.KEKULE_JSON),r=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.KEKULE_XML);Kekule.IO.ChemDataReaderManager.register("json",Kekule.IO.KcjReader,e),Kekule.IO.ChemDataReaderManager.register("kcj",Kekule.IO.KcjReader,t),Kekule.IO.ChemDataReaderManager.register("kcx",Kekule.IO.KcxReader,r),Kekule.IO.ChemDataWriterManager.register("kcj",Kekule.IO.KcjWriter,[Kekule.ChemObject],t,{createOptions:{prettyPrint:!1}}),Kekule.IO.ChemDataWriterManager.register("kcx",Kekule.IO.KcxWriter,[Kekule.ChemObject],r,{createOptions:{prettyPrint:!0}})}();