!function(){var e=Kekule,t=Kekule.ChemStructureNodeLabels,r=Kekule.CoordMode;ClassEx.extend(Kekule.ChemObject,{getDefCoordPos:function(e){return Kekule.Render.CoordPos.CENTER},getCoordPos:function(e){var t=e===Kekule.CoordMode.COORD3D?this.getPropStoreFieldValue("coordPos3D"):this.getPropStoreFieldValue("coordPos2D");return Kekule.ObjUtils.isUnset(t)&&(t=this.getDefCoordPos(e)),t},getOverrideRenderOptions:function(e){if(e&&e.length){for(var t={},r=0,n=e.length;r<n;++r)t=Object.extend(t,e[r]);return t}return null},_appendOverrideRenderOptionItem:function(e,t){var r=this.getPropStoreFieldValue(t);r||(r=[],this.setPropStoreFieldValue(t,r));var n=r.indexOf(e);return n>=0&&r.splice(n,1),r.push(e),this.notifyPropSet(t,r),this},_deleteOverrideRenderOptionItem:function(e,t){var r=this.getPropStoreFieldValue(t);if(r){var n=r.indexOf(e);return n>=0&&(r.splice(n,1),this.notifyPropSet(t,r)),this}},addOverrideRenderOptionItem:function(e){return this._appendOverrideRenderOptionItem(e,"overrideRenderOptionItems")},addOverrideRender3DOptionItem:function(e){return this._appendOverrideRenderOptionItem(e,"overrideRender3DOptionItems")},removeOverrideRenderOptionItem:function(e){return this._deleteOverrideRenderOptionItem(e,"overrideRenderOptionItems")},removeOverrideRender3DOptionItem:function(e){return this._deleteOverrideRenderOptionItem(e,"overrideRender3DOptionItems")},getOverriddenRenderOptions:function(){var e=this.getRenderOptions()||{},t=this.getOverrideRenderOptions(this.getOverrideRenderOptionItems());return t&&(e=Object.extend(e,t)),e},getOverriddenRender3DOptions:function(){var e=Object.create(this.getRender3DOptions()||null),t=this.getOverrideRenderOptions(this.getOverrideRender3DOptionItems());return t&&(e=Object.extend(e,t)),e},setRenderOption:function(e,t){var r;(r=this.getRenderOptions())||this.setRenderOptions({}),(r=this.getRenderOptions())[e]!==t&&(r[e]=t,this.notifyPropSet("renderOptions",r))},setRender3DOption:function(e,t){var r;(r=this.getRender3DOptions())||this.setRender3DOptions({}),(r=this.getRender3DOptions())[e]!==t&&(r[e]=t,this.notifyPropSet("render3DOptions",r))},getRenderOption:function(e){var t=this.getOverriddenRenderOptions();return t?t[e]:void 0},getRender3DOption:function(e){var t=this.getOverriddenRender3DOptions();return t?t[e]:void 0},getCascadedRenderOption:function(e){var t=this.getOverriddenRenderOptions(),r=t?t[e]:void 0;if(Kekule.ObjUtils.isUnset(r)){var n=this.getParent?this.getParent():null;r=n&&n.getCascadedRenderOption?n.getCascadedRenderOption(e):void 0}return r},getCascadedRender3DOption:function(e){var t=this.getOverriddenRender3DOptions(),r=t?t[e]:void 0;if(Kekule.ObjUtils.isUnset(r)){var n=this.getParent?this.getParent():null;r=n&&n.getCascadedRender3DOption?n.getCascadedRender3DOption(e):void 0}return r},getBaseCoord:function(e,t){var n=this.getCoordPos(e),o=this.getCoordOfMode?this.getCoordOfMode(e,t):null;if(o&&n!==Kekule.Render.CoordPos.CENTER&&n===Kekule.Render.CoordPos.CORNER_TL){var i=this.getExposedContainerBox(e,t),a={x:(i.x2-i.x1)/2,y:(i.y2-i.y1)/2};e===r.COORD3D&&(a.z=(i.z2-i.z1)/2),e===r.COORD3D?o=Kekule.CoordUtils.add(o,a):(o.x+=a.x,o.y-=a.y)}return o},getBaseCoord2D:function(e){return this.getBaseCoord(Kekule.CoordMode.COORD2D,e)},getBaseCoord3D:function(e){return this.getBaseCoord(Kekule.CoordMode.COORD3D,e)},getAbsBaseCoord:function(e,t){var n=this.getCoordPos(e),o=this.getAbsCoordOfMode?this.getAbsCoordOfMode(e,t):null;if(o&&n!==Kekule.Render.CoordPos.CENTER&&n===Kekule.Render.CoordPos.CORNER_TL){var i=this.getExposedContainerBox(e,t),a={x:(i.x2-i.x1)/2,y:(i.y2-i.y1)/2};e===r.COORD3D&&(a.z=(i.z2-i.z1)/2),e===r.COORD3D?o=Kekule.CoordUtils.add(o,a):(o.x+=a.x,o.y-=a.y)}return o},getAbsBaseCoord2D:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD2D,e)},getAbsBaseCoord3D:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD3D,e)},setAbsBaseCoord:function(e,t,n){var o=this.getCoordPos(t),i=Kekule.CoordUtils.clone(e);if(e&&o!==Kekule.Render.CoordPos.CENTER&&o===Kekule.Render.CoordPos.CORNER_TL){var a=this.getExposedContainerBox(t,n),s={x:(a.x2-a.x1)/2,y:(a.y2-a.y1)/2};t===r.COORD3D&&(s.z=(a.z2-a.z1)/2),t===r.COORD3D?i=Kekule.CoordUtils.substract(i,s):(i.x-=s.x,i.y+=s.y)}return this.setAbsCoordOfMode?this.setAbsCoordOfMode(i,t):this.setCoordOfMode&&this.setCoordOfMode(i,t),this},setAbsBaseCoord2D:function(e,t){return this.setAbsCoordOfMode(e,Kekule.CoordMode.COORD2D,t)},setAbsBaseCoord3D:function(e,t){return this.setAbsCoordOfMode(e,Kekule.CoordMode.COORD3D,t)},getExposedAncestor:function(){var e=this.getParent();return e?e.isExpanded()?this:e.getExposedAncestor():this},isExposed:function(){var e=this.getParent();return!e||e.isExpanded()},isExpanded:function(){return!0},setExpanded:function(e){},getLinkedExposedObjs:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t){var n=this.getLinkedConnectorAt(t);if(n.isExposed())for(var o=n.getConnectedExposedObjs(),i=0,a=o.length;i<a;++i)o[i]!==this&&Kekule.ArrayUtils.pushUnique(e,o[i])}return e},getExposedContainerBox:function(e,t){return this.getContainerBox(e,t)},getAllAutoScaleRefLengths:function(e,t){return[]},getAllContainingConnectors:function(){return this.getAllChildConnectors?this.getAllChildConnectors():[]},getConnectorLengthMedian:function(e,t){var r=this.getAllContainingConnectors();return Kekule.ChemStructureUtils.getConnectorLengthMedian(r,e,t)}}),ClassEx.defineProps(Kekule.ChemObject,[{name:"coordPos2D",dataType:DataType.INT,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getCoordPos(Kekule.CoordMode.COORD2D)}},{name:"coordPos3D",dataType:DataType.INT,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getCoordPos(Kekule.CoordMode.COORD3D)}},{name:"renderOptions",dataType:DataType.OBJECT},{name:"render3DOptions",dataType:DataType.OBJECT},{name:"overrideRenderOptionItems",dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC},{name:"overrideRender3DOptionItems",dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC}]),ClassEx.extend(Kekule.ChemObjList,{getAllContainingConnectors:function(){for(var e=[],t=0,r=this.getItemCount();t<r;++t){var n=this.getItemAt(t);n.getAllContainingConnectors&&(e=e.concat(n.getAllContainingConnectors()))}return e},getAllAutoScaleRefLengths:function(e,t){for(var r=[],n=0,o=this.getItemCount();n<o;++n){var i=this.getItemAt(n);i.getAllAutoScaleRefLengths&&(r=r.concat(i.getAllAutoScaleRefLengths(e,t)))}return r},getExposedContainerBox:function(e,t){for(var r,n=this.toArray(),o=0,i=n.length;o<i;++o){var a=n[o];if(a.isExposed()){var s=a.getExposedContainerBox?a.getExposedContainerBox(e,t):a.getContainerBox?a.getContainerBox(e,t):null;s&&(r=r?Kekule.BoxUtils.getContainerBox(r,s):Kekule.BoxUtils.clone(s))}}return r}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ChemObjList),ClassEx.extend(Kekule.ChemSpaceElement,{getAllContainingConnectors:function(){return this.getChildren().getAllContainingConnectors()},getAllAutoScaleRefLengths:function(e,t){return this.getChildren().getAllAutoScaleRefLengths(e,t)}}),ClassEx.extend(Kekule.ChemSpace,{getAllContainingConnectors:function(){return this.getRoot().getAllContainingConnectors()},getAllAutoScaleRefLengths:function(e,t){return this.getDefAutoScaleRefLength()?[this.getDefAutoScaleRefLength()]:this.getRoot().getAllAutoScaleRefLengths(e,t)}}),ClassEx.defineProps(Kekule.ChemObject,[{name:"defAutoScaleRefLength",dataType:DataType.NUMBER,scope:Class.PropertyScope.PUBLIC}]),ClassEx.extend(Kekule.BaseStructureConnector,{getBaseCoord:function(e,t){for(var r=null,n=0,o=e===Kekule.CoordMode.COORD2D?{x:0,y:0}:{x:0,y:0,z:0},i=0,a=this.getConnectedObjCount();i<a;++i){var s=this.getConnectedObjAt(i),d=s.getBaseCoord?s.getBaseCoord(e,t):null;d&&(o=Kekule.CoordUtils.add(o,d),++n)}return n&&(r=Kekule.CoordUtils.divide(o,n)),r},getAbsBaseCoord:function(e,t){for(var r=null,n=0,o=e===Kekule.CoordMode.COORD2D?{x:0,y:0}:{x:0,y:0,z:0},i=0,a=this.getConnectedObjCount();i<a;++i){var s=this.getConnectedObjAt(i),d=s.getAbsBaseCoord?s.getAbsBaseCoord(e,t):null;d&&(o=Kekule.CoordUtils.add(o,d),++n)}return n&&(r=Kekule.CoordUtils.divide(o,n)),r},getAbsCoordOfMode:function(e,t){return this.getAbsBaseCoord(e,t)},getConnectedExposedObjs:function(){for(var e=this.getConnectedObjs(),t=[],r=0,n=e.length;r<n;++r){var o=e[r].getExposedAncestor();t.indexOf(o)<0&&t.push(o)}return t},getLength:function(e,t){var r=this.getConnectedObjs();if(2!==r.length)return null;var n=r[0].getAbsBaseCoord?r[0].getAbsBaseCoord(e,t):null,o=r[1].getAbsBaseCoord?r[1].getAbsBaseCoord(e,t):null;return Kekule.CoordUtils.getDistance(n,o)},getLength2D:function(e){return this.getLength(Kekule.CoordMode.COORD2D,e)},getLength3D:function(e){return this.getLength(Kekule.CoordMode.COORD3D,e)}}),ClassEx.defineProps(Kekule.BaseStructureConnector,[{name:"absCoord2D",dataType:DataType.HASH,serializable:!1,getter:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD2D,e)}},{name:"absCoord3D",dataType:DataType.HASH,serializable:!1,getter:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD3D,e)}}]),ClassEx.extend(Kekule.ChemStructureConnector,{getAllAutoScaleRefLengths:function(e,t){return[this.getLength(e,t)]}}),ClassEx.extend(Kekule.BaseStructureNode,{getBaseCoord:function(e,t){return this.getCoordOfMode(e,t)},getAbsBaseCoord:function(e,t){return this.getAbsCoordOfMode(e,t)},getExposedContainerBox:function(e,t){return this.getContainerBox(e,t)},getExposedContainerBox2D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD2D,e);return t.width=t.x2-t.x1,t.height=t.y2-t.y1,t},getExposedContainerBox3D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD3D,e);return t.deltaX=t.x2-t.x1,t.deltaY=t.y2-t.y1,t.deltaZ=t.z2-t.z1,t}}),ClassEx.extend(Kekule.ChemStructureNode,{getDisplayRichText:function(e,t,r,n,o,i){var a=Kekule.Render;Kekule.ObjUtils.isUnset(t)&&(t=!0);var s,d=a.RichTextUtils.create(),l=this.getRenderOption("customLabel");return(s=l?a.RichTextUtils.strToRichText(l):this.getCoreDisplayRichTextItem(e,t,r,n))&&(t&&(s=this.appendElectronStateDisplayText(s,n,o,i)),s&&(a.RichTextUtils.append(d,s),d.anchorItem=s)),d},getCoreDisplayRichTextItem:function(e,t,r,n){return null},appendElectronStateDisplayText:function(e,t,r,n){var o=Kekule.Render,i=this.getCharge(),a=this.getRadical(),s=o.ChemDisplayTextUtils.createElectronStateDisplayTextSection(i,a,t,r,n);if(s){var d=o.RichTextUtils.createGroup();return o.RichTextUtils.append(d,e),o.RichTextUtils.append(d,s),d.charDirection=Kekule.Render.TextDirection.LTR,d.anchorItem=e,d}return e}}),ClassEx.extend(Kekule.AbstractAtom,{getDisplayRichText:function($super,e,t,r,n,o,i){var a=Kekule.Render;Kekule.ObjUtils.isUnset(e)&&(e=a.HydrogenDisplayLevel.DEFAULT);var s=$super(e,t,r,n,o,i),d=0;switch(e){case a.HydrogenDisplayLevel.NONE:d=0;break;case a.HydrogenDisplayLevel.ALL:d=this.getHydrogenCount();break;case a.HydrogenDisplayLevel.EXPLICIT:d=this.getExplicitHydrogenCount();break;case a.HydrogenDisplayLevel.UNMATCHED_EXPLICIT:this.getImplicitHydrogenCount&&this.getImplicitHydrogenCount()!==this.getExplicitHydrogenCount()&&(d=this.getExplicitHydrogenCount())}return d&&(s=this.appendHydrogenDisplayText(s,d)),s},appendHydrogenDisplayText:function(e,t){var r=Kekule.Render;if(t)if(t>1){var n=r.RichTextUtils.createGroup();n.charDirection=Kekule.Render.TextDirection.LTR;var o=r.RichTextUtils.appendText2(n,"H");r.RichTextUtils.appendText(n,t.toString(),{textType:r.RichText.SUB,refItem:o}),r.RichTextUtils.append(e,n)}else r.RichTextUtils.appendText(e,"H");return e}}),ClassEx.extend(Kekule.Atom,{getCoreDisplayRichTextItem:function(r,n,o,i){var a,s=Kekule.Render,d=s.RichTextUtils.createGroup(),l=this.getIsotopeAlias();this.getSymbol();l||this.getSymbol()!==e.Element.UNSET_ELEMENT?l&&Kekule.ChemStructureNodeLabels.ENABLE_ISOTOPE_ALIAS?(a=s.RichTextUtils.createSection(this.getIsotopeAlias(),{charDirection:Kekule.Render.TextDirection.LTR}),(d=s.RichTextUtils.append(d,a)).anchorItem=a):(a=s.RichTextUtils.createSection(this.getSymbol(),{charDirection:Kekule.Render.TextDirection.LTR}),(d=s.RichTextUtils.append(d,a)).anchorItem=a,this.getMassNumber()!==Kekule.Isotope.UNSET_MASSNUMBER&&((d=s.RichTextUtils.insertText(d,0,this.getMassNumber().toString(),{textType:s.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR,refItem:d.anchorItem})).charDirection=Kekule.Render.TextDirection.LTR)):d=s.RichTextUtils.appendText(d,o&&o.getUnsetElement()||t.UNSET_ELEMENT);return d}}),ClassEx.extend(Kekule.Pseudoatom,{getCoreDisplayRichTextItem:function(e,r,n,o){var i,a=Kekule.Render,s=n;return(i=this.getLabel())||(i=s&&s.getUnsetElement()||t.UNSET_ELEMENT),a.RichTextUtils.createSection(i,{charDirection:Kekule.Render.TextDirection.LTR})}});var n=function(e,t,r){var n,o=Kekule.Render,i=Kekule.IsotopesDataUtil.getIsotopeIdDetail(t);i.massNumber&&(n=o.RichTextUtils.appendText2(e,i.massNumber.toString(),{textType:Kekule.Render.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR}));var a=o.RichTextUtils.appendText2(e,i.symbol,{charDirection:Kekule.Render.TextDirection.LTR},r);return n&&(n.refItem=a),e.charDirection=Kekule.Render.TextDirection.LTR,e};ClassEx.extend(Kekule.VariableAtom,{getCoreDisplayRichTextItem:function(e,r,o,i){var a,s=Kekule.Render,d=o;if(this.isListEmpty())return(a=s.RichTextUtils.strToRichText(d&&d.getVariableAtom()||t.VARIABLE_ATOM)).charDirection=Kekule.Render.TextDirection.LTR,a;var l=this.getAllowedIsotopeIds()||this.getDisallowedIsotopeIds(),u=this.isDisallowedList();if((a=s.RichTextUtils.createGroup()).charDirection=Kekule.Render.TextDirection.LTR,u&&(a=s.RichTextUtils.appendText(a,d.getIsoListDisallowPrefix())),a=s.RichTextUtils.appendText(a,d.getIsoListLeadingBracket()),l&&l.length)for(var c=0,h=l.length;c<h;++c){var g=l[c];g&&(0!=c&&(a=s.RichTextUtils.appendText(a,d.getIsoListDelimiter())),a=n(a,g,0==c))}return a=s.RichTextUtils.appendText(a,d.getIsoListTailingBracket())}}),ClassEx.extend(Kekule.StructureConnectionTable,{exposedNodesHasCoord2D:function(e){for(var t=this.getExposedNodes(),r=0,n=t.length;r<n;++r)if(t[r].hasCoord2D(e))return!0;return!1},exposedNodesHasCoord3D:function(e){for(var t=this.getExposedNodes(),r=0,n=t.length;r<n;++r)if(t[r].hasCoord3D(e))return!0;return!1},getExposedNodes:function(){for(var e=[],t=this.getNodes(),r=0,n=t.length;r<n;++r){var o=t[r];if(o.getExposedNodes&&o.isExpanded()){var i=o.getExposedNodes();e=e.concat(i)}else o.isExposed()&&e.push(o)}return e},getExposedConnectors:function(){for(var e=this.getConnectors(),t=this.getNodes(),r=0,n=t.length;r<n;++r){var o=t[r];if(o.getConnectors&&o.isExpanded()){var i=o.getExposedConnectors();e=e.concat(i)}}return e},getExposedContainerBox:function(e,t){var r=this.getExposedNodes();return r.length?this.getNodesContainBox(r,e,t):null},getExposedContainerBox2D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD2D,e);return t.width=t.x2-t.x1,t.height=t.y2-t.y1,t},getExposedContainerBox3D:function(e){var t=this.getExposedContainerBox(Kekule.CoordMode.COORD3D,e);return t.deltaX=t.x2-t.x1,t.deltaY=t.y2-t.y1,t.deltaZ=t.z2-t.z1,t},getConnectorLengthMedian:function(e,t){var r=this.getAllContainingConnectors();return Kekule.ChemStructureUtils.getConnectorLengthMedian(r,e,t)},getAllAutoScaleRefLengths:function(e,t){for(var r=this.getAllContainingConnectors(),n=[],o=0,i=r.length;o<i;++o){var a=r[o];if(a&&a.getAllAutoScaleRefLengths){var s=a.getAllAutoScaleRefLengths(e,t);s&&(n=n.concat(s))}}return n}}),ClassEx.extend(Kekule.ContentBlock,{getDefCoordPos:function($super,e){return e!==r.COORD3D?Kekule.Render.CoordPos.CORNER_TL:$super(e)}}),ClassEx.extend(Kekule.ChemMarker.ChemPropertyMarker,{getDefCoordPos:function($super,e){return e!==r.COORD3D?Kekule.Render.CoordPos.CENTER:$super(e)}}),ClassEx.extend(Kekule.StructureFragment,{isExpanded:function(){var e=this.getOverriddenRenderOptions();return!!e&&!!e.expanded},setExpanded:function(e){this.setRenderOption("expanded",e)},getExposedNodes:function(){return this.hasCtab()?this.getCtab().getExposedNodes():[]},getExposedConnectors:function(){return this.hasCtab()?this.getCtab().getExposedConnectors():[]},exposedNodesHasCoord2D:function(e){return!!this.hasCtab()&&this.getCtab().exposedNodesHasCoord2D(e)},exposedNodesHasCoord3D:function(e){return!!this.hasCtab()&&this.getCtab().exposedNodesHasCoord3D(e)},getExposedContainerBox:function(e,t){if(this.hasCtab()){var r=this.getCtab().getExposedContainerBox(e,t);return r||(r=this.getContainerBox(e,t)),r}return this.getContainerBox(e,t)},getConnectorLengthMedian:function(e,t){return this.hasCtab()?this.getCtab().getConnectorLengthMedian(e,t):null},getAutoScaleRefLength:function(e,t){return this.getConnectorLengthMedian(e,t)},getAllAutoScaleRefLengths:function(e,t){return this.hasCtab()?this.getCtab().getAllAutoScaleRefLengths(e,t):null}}),ClassEx.extend(Kekule.SubGroup,{getCoreDisplayRichTextItem:function(e,r,n,o){var i,a=Kekule.Render,s=null,d=this.getAbbr();if(d||(s=this.getFormulaText()?Kekule.FormulaUtils.textToFormula(this.getFormulaText()):this.getFormula(!1)||this.calcFormula())&&!s.isEmpty()||(d=n&&n.getRgroup()||t.SUBGROUP),d)if(d.length<=3)(i=a.RichTextUtils.createSection(d)).charDirection=Kekule.Render.TextDirection.LTR;else{var l=this._indexOfFirstUppercaseLetter(d);l<0&&(l=0),(i=a.RichTextUtils.createGroup()).charDirection=Kekule.Render.TextDirection.LTR,l>0&&((u=a.RichTextUtils.createSection(d.substring(0,l))).charDirection=Kekule.Render.TextDirection.INHERIT,i=a.RichTextUtils.append(i,u));var u=a.RichTextUtils.createSection(d.charAt(l));(i=a.RichTextUtils.append(i,u)).anchorItem=u,l<d.length-1&&((u=a.RichTextUtils.createSection(d.substring(l+1))).charDirection=Kekule.Render.TextDirection.INHERIT,i=a.RichTextUtils.append(i,u))}else if(s){i=s.getDisplayRichText(r,n,o),(u=a.RichTextUtils.getFirstNormalTextSection(i))||(u=i.items[0]),i.anchorItem=u}return i},_indexOfFirstUppercaseLetter:function(e){for(var t=0,r=e.length;t<r;++t){var n=e.charAt(t);if(n>="A"&&n<="Z")return t}return-1},_autoSetSelfCoord:function(e,t){if(!this._isAutoSettingSelfCoord&&!(this.getCoordOfMode(e,t)||(a=this.getAnchorNodeCount())<=0)){this.beginUpdate();try{this._isAutoSettingSelfCoord=!0;for(var r={},n=0;n<a;++n){(s=this.getAnchorNodeAt(n))._autoSetSelfCoord&&s._autoSetSelfCoord(e,t),(d=s.getAbsCoordOfMode(e,t))&&(r=Kekule.CoordUtils.add(r,d))}var o=Kekule.CoordUtils.divide(r,a);this.setAbsCoordOfMode(o,e);var i=this.getCoordOfMode(e)||{},a=this.getNodeCount();for(n=0;n<a;++n){var s,d;(d=(s=this.getNodeAt(n)).getCoordOfMode(e,t))&&(d=Kekule.CoordUtils.substract(d,i),s.setCoordOfMode(d,e))}}finally{this._isAutoSettingSelfCoord=!1,this.endUpdate()}}},doGetAbsCoord2D:function($super,e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD2D,e),$super(e)},doGetAbsCoord3D:function($super,e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD3D,e),$super(e)},doSetAbsCoord2D:function($super,e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD2D),$super(e)},doSetAbsCoord3D:function($super,e){return this._autoSetSelfCoord(Kekule.CoordMode.COORD3D),$super(e)}}),ClassEx.extend(Kekule.MolecularFormula,{getDisplayRichText:function(e,t,r,n,o){var i=Kekule.Render;return Kekule.ObjUtils.isUnset(e)&&(e=!0),i.ChemDisplayTextUtils.formulaToRichText(this,e,null,r,t,n,o)},getDisplayText:function(e,t,r){var n=this.getDisplayRichText();return Kekule.Render.RichTextUtils.toText(n)}}),ClassEx.extend(Kekule.Molecule,{afterInitialization:function(){this.setExpanded(!0)}}),ClassEx.extend(Kekule.CompositeMolecule,{getExposedContainerBox:function(e,t){var r=null,n=this.getPropStoreFieldValue("subMolecules");if(n)for(var o=0,i=n.length;o<i;++o){var a=n[o].getExposedContainerBox(e,t);a&&(r=r?Kekule.BoxUtils.getContainerBox(r,a):Kekule.BoxUtils.clone(a))}return r},getAllAutoScaleRefLengths:function(e,t){var r=[],n=this.getPropStoreFieldValue("subMolecules");if(n)for(var o=0,i=n.getItemCount();o<i;++o){var a=n.getObjAt(o).getAllAutoScaleRefLengths(e,t);a&&(r=r.concat(a))}return r}})}(),Kekule.Render={},Kekule.Render.CoordSystem={CHEM:0,CONTEXT:1,SCREEN:2},Kekule.Render.RendererType={R2D:2,R3D:3},Kekule.Render.CoordPos={CENTER:0,CORNER_TL:21,DEFAULT:0},Kekule.Render.DEF_ATOM_ATOMIC_NUM=6,Kekule.Render.MoleculeDisplayType={SKELETAL:1,CONDENSED:2,DEFAULT:1},Kekule.Render.Molecule2DDisplayType=Kekule.Render.MoleculeDisplayType,Kekule.Render.NodeLabelDisplayMode={HIDDEN:-1,SHOWN:1,SMART:0,DEFAULT:0},Kekule.Render.HydrogenDisplayLevel={NONE:0,EXPLICIT:1,UNMATCHED_EXPLICIT:2,ALL:10,LABELED:30,DEFAULT:30},Kekule.Render.TextDirection={DEFAULT:0,LTR:1,RTL:3,TTB:2,BTT:4,INHERIT:10},Kekule.Render.TextAlign={DEFAULT:0,LEFT:1,RIGHT:2,TOP:3,BOTTOM:4,CENTER:5,LEADING:10,TRAILING:11,getAbsAlign:function(e,t){var r=e,n=Kekule.Render.TextAlign,o=Kekule.Render.TextDirection;if(e===n.LEADING||e===n.TRAILING){var i=e==n.LEADING;switch(t){case o.RTL:r=i?n.RIGHT:n.LEFT;break;case o.TTB:r=i?n.TOP:n.BOTTOM;break;case o.BTT:r=i?n.BOTTOM:n.TOP;break;case o.LTR:default:r=i?n.LEFT:n.RIGHT}}return r}},Kekule.Render.BoxXAlignment={LEFT:0,RIGHT:1,CENTER:2},Kekule.Render.BoxYAlignment={TOP:0,BOTTOM:1,CENTER:2},Kekule.Render.TextBoxAlignmentMode={BOX:0,ANCHOR:1},Kekule.Render.BondRenderType={SINGLE:0,DOUBLE:1,TRIPLE:2,QUAD:3,DASHED:4,DASHED_DOUBLE:5,DASHED_TRIPLE:6,SOLID_DASH:7,ARROWED:8,ARROWED_INV:9,HASHED:10,BOLD:11,BOLD_DOUBLE:12,BOLD_TRIPLE:13,BOLD_QUAD:14,BOLD_DASH:16,WEDGED_SOLID:20,WEDGED_SOLID_INV:21,WEDGED_HOLLOW:22,WEDGED_HOLLOW_INV:23,WEDGED_HASHED:24,WEDGED_HASHED_INV:25,WEDGED_SOLID_BOTH:26,WEDGED_HOLLOW_BOTH:27,WAVY:30,SCISSORS_DOUBLE:40},Kekule.Render.ChargeMarkRenderType={NUM_WITH_SYMBOL:1,DEFAULT:1,CIRCLE_AROUND:3},Kekule.Render.Render3DGraphicQuality={EXTREME_LOW:1,LOW:2,MEDIUM:3,HIGH:4,EXTREME_HIGH:5},Kekule.Render.Molecule3DDisplayType={WIRE:31,STICKS:32,BALL_STICK:33,SPACE_FILL:34,DEFAULT:33},Kekule.Render.Bond3DRenderMode={NONE:0,WIRE:1,MULTI_WIRE:2,CYLINDER:3,MULTI_CYLINDER:4,isWireMode:function(e){var t=Kekule.Render.Bond3DRenderMode;return e===t.WIRE||e===t.MULTI_WIRE},isCylinderMode:function(e){var t=Kekule.Render.Bond3DRenderMode;return e===t.CYLINDER||e===t.MULTI_CYLINDER}},Kekule.Render.Bond3DSpliceMode={UNSPLIT:1,MID_SPLIT:2,WEIGHTING_SPLIT:3},Kekule.Render.Bond3DRenderType={SINGLE:1,DOUBLE:2,TRIPLE:3,DASH:-1,SOLID_DASH:-2},Kekule.Render.Node3DRenderMode={NONE:0,BALL:1,SPACE:2},Kekule.Render.MetaShapeType={POINT:0,CIRCLE:1,LINE:2,RECT:3,ARC:5,POLYLINE:11,POLYGON:10,SPHERE:101,CYLINDER:102,COMPOSITE:-1},Kekule.Render.BoundShapeType=Kekule.Render.MetaShapeType,Kekule.Render.ObjectUpdateType={MODIFY:0,ADD:1,REMOVE:2,CLEAR:3},Kekule.Render.AbstractRenderer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.AbstractRenderer",RENDER_CACHE_FIELD:"__$renderCache$__",initialize:function($super,e,t,r){$super(),this.setPropValue("chemObj",e,!0),r&&this.setParent(r),this.setDrawBridge(t),this.setBubbleEvent(!0),this._suspendUpdateStatus=0,this._suspendUpdateInfos=[]},finalize:function($super){var e=this.getPropStoreFieldValue("boundInfoRecorder");e&&e.finalize(),this.setPropValue("chemObj",null,!0),this.setDrawBridge(null),$super()},initProperties:function(){this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:!1,setter:null}),this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("parent",{dateType:DataType.OBJECT,serializable:!1}),this.defineProp("parentRenderer",{dateType:"Kekule.Render.AbstractRenderer",serializable:!1,getter:function(){var e=this.getParent();return e instanceof Kekule.Render.AbstractRenderer?e:null},setter:function(e){this.setParent(e)}}),this.defineProp("redirectContext",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("canModifyTargetObj",{dataType:DataType.BOOL,serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("canModifyTargetObj");if(Kekule.ObjUtils.isUnset(e)){var t=this.getParent();t&&t.getCanModifyTargetObj&&(e=t.getCanModifyTargetObj())}return e}}),this.defineProp("boundInfoRecorder",{dataType:"Kekule.Render.BoundInfoRecorder",serializable:!1,setter:null,getter:function(e){if(this.isRootRenderer()){var t=this.getPropStoreFieldValue("boundInfoRecorder");return t||e||(t=this._createBoundInfoRecorder()),t}var r=this.getRootRenderer();return r&&r.getBoundInfoRecorder(e)}}),this.defineEvent("clear"),this.defineEvent("updateBasicDrawObject")},_createBoundInfoRecorder:function(){var e=this.getPropStoreFieldValue("boundInfoRecorder");e&&e.finalize();var t=new Kekule.Render.BoundInfoRecorder(this);return this.setPropStoreFieldValue("boundInfoRecorder",t),t},isRootRenderer:function(){return!this.getParentRenderer()},getHigherLevelObj:function(){return this.getParent()},getRootRenderer:function(){if(this.isRootRenderer())return this;var e=this.getParentRenderer();return e?e.getRootRenderer():this},getRendererType:function(){return Kekule.Render.RendererType.R2D},getCoordMode:function(){return this.getRendererType()===Kekule.Render.RendererType.R3D?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D},_getRenderSortIndex:function(){return 0},getRenderCache:function(e){var t=this.getExtraProp(e,this.RENDER_CACHE_FIELD);return t||(t={},this.setExtraProp(e,this.RENDER_CACHE_FIELD,t)),t},beginDraw:function(e,t,r){var n=this.getDrawBridge();n.prepareContext&&n.prepareContext(e)},endDraw:function(e,t,r){var n=this.getDrawBridge();n.renderContext&&n.renderContext(e)},updateDrawInfoInCache:function(e,t,r,n,o){var i=this.getRenderCache(t);t&&(i.context=t),r&&(i.baseCoord=r),e&&(i.chemObj=e),n&&(i.options=n),o&&(i.realDrawOptions=o)},_isCurrChemObjNeedToBeDrawn:function(e,t){for(var r=this.getChemObj(),n=0,o=e.length;n<o;++n){var i=e[n];if(i===r||i.isChildOf(r))return!0}return!1},getAutoBaseCoord:function(e){return this.doGetAutoBaseCoord(e)},doGetAutoBaseCoord:function(e){return null},getCachedDrawOptions:function(e){return this.getRenderCache(e).options},getCachedDrawnElem:function(e){return this.getRenderCache(e).drawnElem},draw:function(e,t,r){try{this.__isDrawing=!0,this.getBoundInfoRecorder();var n={},o=this.getParentRenderer();if(o)var i=o.getRenderCache().options;i?(n=Object.create(i),n=Object.extend(n,r)):n=Object.create(r||null);var a=this.getChemObj(),s=n.partialDrawObjs;if(s&&!this._isCurrChemObjNeedToBeDrawn(s,e))return null;var d=this.getRendererType()===Kekule.Render.RendererType.R3D?"getRender3DOptions":"getRenderOptions",l=a[d]?a[d]():null,u=a[d=this.getRendererType()===Kekule.Render.RendererType.R3D?"getOverriddenRender3DOptions":"getOverriddenRenderOptions"]?a[d]():null;n=Kekule.Render.RenderOptionUtils.mergeRenderOptions(l||{},n),this.getRenderCache().options=n,n=Kekule.Render.RenderOptionUtils.mergeRenderOptions(u||{},n),this.updateDrawInfoInCache(this.getChemObj(),e,t,r,n);var c=this.isRootRenderer();this.invokeEvent("prepareDrawing",{context:e,obj:this.getChemObj()}),c&&this.beginDraw(e,t,n);var h=this.doDraw(e,t,n);this.getRenderCache(e).drawnElem=h,c&&this.endDraw(e,t,n),this.invokeEvent("draw",{context:e,obj:this.getChemObj()})}finally{this.__isDrawing=!1}return h},doDraw:function(e,t,r){return this.doDrawSelf(e,t,r)},doDrawSelf:function(e,t,r){return null},redraw:function(e){var t=this.isRootRenderer();if(t){var r=this.getRenderCache(e)||{};this.beginDraw(e,r.baseCoord,r.options)}var n=this.doRedraw(e);return this.getRenderCache(e).drawnElem=n,t&&this.endDraw(e,r.baseCoord,r.options),n},doRedraw:function(e){var t=this.getRenderCache(e);return this.draw(e,t.baseCoord,t.options)},canModifyGraphic:function(e){var t=this.getDrawBridge();return!!t.canModifyGraphic&&t.canModifyGraphic(e)},beginUpdateRenderer:function(){++this._suspendUpdateStatus},endUpdateRenderer:function(){--this._suspendUpdateStatus,this._suspendUpdateStatus<=0&&(this._suspendUpdateStatus=0),this.isUpdatingRenderer()||this.doEndUpdateRenderer()},doEndUpdateRenderer:function(){this.updateEx(this._suspendUpdateInfos),this._suspendUpdateInfos=[]},isUpdatingRenderer:function(){return this._suspendUpdateStatus>0},updateEx:function(e){var t=!0;if(this.isUpdatingRenderer())return this._suspendUpdateInfos||(this._suspendUpdateInfos=[]),this._mergeRendererUpdateInfo(this._suspendUpdateInfos,e),!0;if(!this.canModifyGraphic(s)){if(this.isRootRenderer()){var r=[];for(o=0,i=e.length;o<i;++o){s=(a=e[o]).context;Kekule.ArrayUtils.pushUnique(r,s)}for(o=0,i=r.length;o<i;++o){this.getDrawBridge().clearContext(s);var n=this.getRenderCache(s);this.draw(s,n.baseCoord,n.options)}return!0}return this.getParentRenderer().updateEx(e)}for(var o=0,i=e.length;o<i;++o){for(var a,s=(a=e[o]).context,d=0,l=a.items.length;d<l;++d){var u=a.items[d];if(!(t=t&&this.doUpdate(s,u.updatedObjDetails,u.updateType)))break}if(!t)break}return t},_mergeRendererUpdateInfo:function(e,t){for(var r=0,n=t.length;r<n;++r){var o=t[r],i=this._indexOfContextInRendererUpdateInfos(o.context,e);if(i<0)e.push(o);else{var a=e[i];a.items=a.items.concat(o.items)}}return e},_indexOfContextInRendererUpdateInfos:function(e,t){for(var r=0,n=t.length;r<n;++r){if(t[r].context===e)return r}return-1},update:function(e,t,r){for(var n=[],o=0,i=t.length;o<i;++o){var a=t[o].obj;this.isChemObjRenderedBySelf(e,a)&&n.push(t[o])}return!n.length||this.updateEx([{context:e,items:[{updateType:r,updatedObjDetails:n}]}])},doUpdate:function(e,t,r){return this.doUpdateSelf(e,t,r)},doUpdateSelf:function(e,t,r){if(this.canModifyGraphic(e)){for(var n=!1,o=this.getChemObj(),i=0,a=t.length;i<a;++i){if(t[i].obj===o){n=!0;break}}if(n){if(r===Kekule.Render.ObjectUpdateType.CLEAR)return this.doClear(e);this.doClear(e);var s=this.getRenderCache(e);return this.draw(e,s.baseCoord,s.options)}}return!1},_extractObjsOfUpdateObjDetails:function(e){return Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(e)},_createUpdateObjDetailsFromObjs:function(e){return Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(e)},addNew:function(e,t){var r=this._createUpdateObjDetailsFromObjs(t);return this.update(e,r,Kekule.Render.ObjectUpdateType.ADD)},modify:function(e,t){return this.update(e,t,Kekule.Render.ObjectUpdateType.MODIFY)},remove:function(e,t){var r=this._createUpdateObjDetailsFromObjs(t);return this.update(e,r,Kekule.Render.ObjectUpdateType.REMOVE)},clear:function(e){this.doClear(e);this.invokeEvent("clear",{context:e,obj:this.getChemObj()})},doClear:function(e){return!!this.canModifyGraphic()&&this.doClearSelf(e)},doClearSelf:function(e){if(!this.canModifyGraphic())return!1;var t=this.getRenderCache(e).drawnElem;if(t)try{this.getDrawBridge().removeDrawnElem(e,t)}catch(e){}this.getRenderCache(e).drawnElem=null},estimateObjBox:function(e,t,r){var n=this.doEstimateObjBox(e,t,r);return n&&(n=this._fillBoxDefaultValue(n,this.getRendererType())),n},doEstimateObjBox:function(e,t,r){return this.doEstimateSelfObjBox(e,t,r)},doEstimateSelfObjBox:function(e,t,r){return null},estimateRenderBox:function(e,t,r,n){var o=this.doEstimateRenderBox(e,t,r,n);return o&&(o=this._fillBoxDefaultValue(o,this.getRendererType())),o},doEstimateRenderBox:function(e,t,r,n){return null},_fillBoxDefaultValue:function(e,t){e||(e={});var r=t===Kekule.Render.RendererType.R3D,n={x1:e.x1||0,x2:e.x2||0,y1:e.y1||0,y2:e.y2||0};return r&&(n.z1=e.z1||0,n.z2=e.z2||0),n},transformCoordToObj:function(e,t,r){return this.doTransformCoordToObj(e,t,r)},doTransformCoordToObj:function(e,t,r){return r},transformCoordToContext:function(e,t,r){return this.doTransformCoordToContext(e,t,r)},doTransformCoordToContext:function(e,t,r){return r},transformContextCoordToScreen:function(e,t){return this.doTransformContextCoordToScreen(e,t)},doTransformContextCoordToScreen:function(e,t){var r=this.getDrawBridge();return r&&r.transformContextCoordToScreen?r.transformContextCoordToScreen(e,t):t},basicDrawObjectUpdated:function(e,t,r,n,o){this.invokeEvent("updateBasicDrawObject",{context:e,obj:t,parentObj:r,boundInfo:n,updateType:o})},isChemObjRenderedBySelf:function(e,t){return t===this.getRenderCache(e).chemObj},isChemObjRenderedDirectlyBySelf:function(e,t){return!(!t||!this.getRenderCache(e).chemObj)&&t===this.getRenderCache(e).chemObj},getObjRenderBound:function(e,t,r){var n=this.getBoundInfoRecorder(),o=t;return r&&t.getCoordStickTarget&&(o=t.getCoordStickTarget()||o),n&&n.getBound(e,o)},getStickingTargetRenderBound:function(e,t){var r;if(t.getCoordStickTarget&&(r=t.getCoordStickTarget()),r){var n=this.getBoundInfoRecorder();return n&&n.getBound(e,r,!0)}return null},createBoundInfo:function(e,t,r){return Kekule.Render.MetaShapeUtils.createShapeInfo(e,t,r)},createPointBoundInfo:function(e){return this.createBoundInfo(Kekule.Render.BoundShapeType.POINT,[e])},createCircleBoundInfo:function(e,t){return this.createBoundInfo(Kekule.Render.BoundShapeType.CIRCLE,[e],{radius:t})},createArcBoundInfo:function(e,t,r,n,o,i){return this.createBoundInfo(Kekule.Render.BoundShapeType.ARC,[e],{radius:t,startAngle:r,endAngle:n,anticlockwise:o,width:i})},createLineBoundInfo:function(e,t,r){return this.createBoundInfo(Kekule.Render.BoundShapeType.LINE,[e,t],{width:r})},createRectBoundInfo:function(e,t){return this.createBoundInfo(Kekule.Render.BoundShapeType.RECT,[e,t])},createSphereBoundInfo:function(e,t){return this.createBoundInfo(Kekule.Render.BoundShapeType.SPHERE,[e],{radius:t})},createCylinderBoundInfo:function(e,t,r){return this.createBoundInfo(Kekule.Render.BoundShapeType.CYLINDER,[e,t],{radius:r})}}),Kekule.ClassDefineUtils.addExtraObjMapSupport(Kekule.Render.AbstractRenderer),Kekule.Render.DummyRenderer=Class.create(Kekule.Render.AbstractRenderer,{CLASS_NAME:"Kekule.Render.DummyRenderer",draw:function(e,t,r){},redraw:function(e){}}),Kekule.Render.CompositeRenderer=Class.create(Kekule.Render.AbstractRenderer,{CLASS_NAME:"Kekule.Render.CompositeRenderer",initProperties:function(){this.defineProp("targetChildObjs",{dataType:DataType.ARRAY,serializable:!1}),this.defineProp("childRendererMap",{dataType:DataType.OBJECT,serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("childRendererMap");return e||(e=new Kekule.MapEx(!0),this.setPropStoreFieldValue("childRendererMap",e)),e}})},finalize:function($super){this.reset(),$super()},_getRenderSortIndex:function($super){for(var e=$super(),t=this.prepareChildRenderers(),r=0,n=t.length;r<n;++r){var o=t[r]._getRenderSortIndex();o>e&&(e=o)}return e},doEstimateObjBox:function($super,e,t,r){for(var n=$super(e,t,r),o=this.prepareChildRenderers(),i=Kekule.BoxUtils,a=0,s=o.length;a<s;++a){var d=o[a];if(d){var l=d.estimateObjBox(e,t,r);l&&(n=n?i.getContainerBox(n,l):i.clone(l))}}return n},isChemObjRenderedBySelf:function($super,e,t){var r=$super(e,t);if(!r)for(var n=this.getChildRenderers(),o=0,i=n.length;o<i;++o){if(n[o].isChemObjRenderedBySelf(e,t))return!0}if(!r){this.refreshChildObjs();var a=this.getTargetChildObjs();r=a&&a.indexOf(t)>=0}return r},isChemObjRenderedDirectlyBySelf:function($super,e,t){return $super(e,t)},doSetRedirectContext:function($super,e){$super(e);var t=this.getChildRenderers();if(t&&t.length)for(var r=0,n=t.length;r<n;++r)t[r].setRedirectContext(e)},getChildObjs:function(){var e=this.getChemObj();return e&&e.getAttachedMarkers?[].concat(e.getAttachedMarkers()||[]):[]},prepareChildObjs:function(){var e=this.getTargetChildObjs();return e||(this.setTargetChildObjs(this.getChildObjs()),this.getTargetChildObjs())},refreshChildObjs:function(){this.setTargetChildObjs(null),this.prepareChildObjs()},getChildRenderers:function(){return this.getChildRendererMap().getValues()},getRendererForChild:function(e,t){var r=this.getRendererType()===Kekule.Render.RendererType.R3D?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass,n=this.getChildRendererMap();if(!(i=n.get(e))&&t){var o=r(e)||Kekule.Render.DummyRenderer,i=o?new o(e,this.getDrawBridge(),this):null;n.set(e,i),i.setRedirectContext(this.getRedirectContext())}return i},prepareChildRenderers:function(){for(var e=this.getChildRendererMap(),t=this.prepareChildObjs()||[],r=e.getKeys(),n=0,o=r.length;n<o;++n){var i=r[n];t.indexOf(i)<0&&e.remove(i)}for(n=0,o=t.length;n<o;++n){var a=t[n];this.getRendererForChild(a,!0)}return e.getValues()},releaseChildRenderers:function(){var e=this.getChildRendererMap(),t=e.getValues();if(t){for(var r=0,n=t.length;r<n;++r)t[r].finalize();e.clear()}},hasChildRenderers:function(){var e=this.getChildRendererMap().getValues();return e&&e.length},prepare:function(){this.prepareChildObjs(),this.prepareChildRenderers()},reset:function(){this.setTargetChildObjs(null),this.releaseChildRenderers()},_needWholelyDraw:function(e,t){var r=this.getChemObj();return!e||e.indexOf(r)>=0},doDraw:function($super,e,t,r){this.refreshChildObjs(),this.prepareChildRenderers();var n=Object.create(r);if(r.partialDrawObjs&&this._needWholelyDraw(r.partialDrawObjs,e)&&(n.partialDrawObjs=null),this.getTargetChildObjs().length){var o=this.doDrawSelf(e,t,n),i=this.doDrawChildren(e,t,n);return o&&this.addToDrawGroup(o,i),i}return $super(e,t,n)},doDrawChildren:function(e,t,r){var n=this.createDrawGroup(e),o=this.getChildRenderers();this._sortChildRenderers(o);var i=Object.create(r);this.getRenderCache(e).childDrawOptions=i;for(var a=0,s=o.length;a<s;++a){var d=o[a].draw(e,null,i);n&&d&&this.addToDrawGroup(d,n)}return n},_sortChildRenderers:function(e){e.sort(function(e,t){return e._getRenderSortIndex()-t._getRenderSortIndex()})},doClear:function($super,e){return $super(e),this.hasChildRenderers()&&this.doClearChildren(e),!0},doClearChildren:function(e){for(var t=this.getChildRendererMap().getValues(),r=0,n=t.length;r<n;++r)t[r]&&t[r].clear(e)},doUpdate:function($super,e,t,r){return this.refreshChildObjs(),$super(e,t,r),this.getTargetChildObjs().length&&this.doUpdateChildren(e,t,r),!0},doUpdateChildren:function(e,t,r){for(var n=Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(t),o=this.getTargetChildObjs()||[],i=this.getChildRendererMap(),a=Kekule.ArrayUtils.toArray(n),s=new Kekule.MapEx(!1),d=[],l=!1,u=0,c=a.length;u<c;++u){var h=a[u];this.isChemObjRenderedDirectlyBySelf(e,h)&&(l=!0)}if(l)return this.doClear(e),this.redraw(e),!0;for(u=0,c=a.length;u<c;++u){h=a[u];if(D=i.get(h))r===Kekule.Render.ObjectUpdateType.REMOVE?(D.clear(),i.remove(h)):(Kekule.ArrayUtils.pushUnique(d,D),x=[h],s.set(D,x));else{var g=this._getRenderersForChildObj(e,h);if(!g.length&&o.indexOf(h)>=0){var f=(y=this.getRendererForChild(h,!0)).draw(e,null,this.getRenderCache(e).childDrawOptions);if(f){var C=this.getCachedDrawnElem(e);C&&this.addToDrawGroup(f,C)}}for(var R=0,p=g.length;R<p;++R){var D=g[R],x=s.get(D);x||(d.push(D),x=[],s.set(D,x)),x.push(h)}}}var m=!0;for(u=0,c=d.length;u<c;++u){D=d[u];var T=s.get(D),O=Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(T),y=D.update(e,O,r);m=m&&y}return m},_getRenderersForChildObj:function(e,t){for(var r=[],n=this.getChildRenderers(),o=0,i=n.length;o<i;++o){var a=n[o];a.isChemObjRenderedBySelf(e,t)&&r.push(a)}return r}}),Kekule.Render.Renderer2DFactory=Kekule.FactoryUtils.createSimpleFactory(Kekule.FactoryUtils.MATCH_BY_CLASS),Kekule.Render.get2DRendererClass=function(e){var t=e instanceof ObjectEx?e.getClass():e;return Kekule.Render.Renderer2DFactory.getClass(t)},Kekule.Render.Renderer3DFactory=Kekule.FactoryUtils.createSimpleFactory(Kekule.FactoryUtils.MATCH_BY_CLASS),Kekule.Render.get3DRendererClass=function(e){var t=e instanceof ObjectEx?e.getClass():e;return Kekule.Render.Renderer3DFactory.getClass(t)},Kekule.Render.DrawBridgeManager=Class.create({CLASS_NAME:"Kekule.Render.DrawBridgeManager",initialize:function(){this._items=[],this._preferredItem=null},_indexOfBridgeClass:function(e){for(var t=0,r=this._items.length;t<r;++t){if(this._items[t].bridgeClass===e)return t}return-1},_sortItems:function(){this._items.sort(function(e,t){return(e.priorityLevel||0)-(t.priorityLevel||0)})},_reselectPreferred:function(){this._sortItems();for(var e=this._items.length-1;e>=0;--e){var t=this._items[e];if(t.isSupported)return this._preferredItem=t,t}return this._preferredItem=null,null},register:function(e,t){t||(t=0);var r,n=this._indexOfBridgeClass(e);return n>=0?(r=this._items[n]).priorityLevel=t:((r={bridgeClass:e,priorityLevel:t}).isSupported=!!e.isSupported&&e.isSupported(),this._items.push(r)),this._sortItems(),(!this._preferredItem||this._preferredItem.priorityLevel<t)&&r.isSupported&&(this._preferredItem=r),r},unregister:function(e){var t=null,r=this._indexOfBridgeClass(e);return r>=0&&(t=this._items[r],this._items.splice(r,1),t===this._preferredItem&&this._reselectPreferred()),t},getPreferredBridgeClass:function(){return this._preferredItem?this._preferredItem.bridgeClass:null},getPreferredBridgeInstance:function(){var e=this.getPreferredBridgeClass();return e?new e:null}}),Kekule.Render.DrawBridge2DMananger=new Kekule.Render.DrawBridgeManager,Kekule.Render.DrawBridge3DMananger=new Kekule.Render.DrawBridgeManager,function(){var e=Kekule.Render;e.atomColorSets={jmol:["#000099","#FFFFFF","#D9FFFF","#CC80FF","#C2FF00","#FFB5B5","#909090","#3050F8","#FF0D0D","#90E050","#B3E3F5","#AB5CF2","#8AFF00","#BFA6A6","#F0C8A0","#FF8000","#FFFF30","#1FF01F","#80D1E3","#8F40D4","#3DFF00","#E6E6E6","#BFC2C7","#A6A6AB","#8A99C7","#9C7AC7","#E06633","#F090A0","#50D050","#C88033","#7D80B0","#C28F8F","#668F8F","#BD80E3","#FFA100","#A62929","#5CB8D1","#702EB0","#00FF00","#94FFFF","#94E0E0","#73C2C9","#54B5B5","#3B9E9E","#248F8F","#0A7D8C","#006985","#C0C0C0","#FFD98F","#A67573","#668080","#9E63B5","#D47A00","#940094","#429EB0","#57178F","#00C900","#70D4FF","#FFFFC7","#D9FFC7","#C7FFC7","#A3FFC7","#8FFFC7","#61FFC7","#45FFC7","#30FFC7","#1FFFC7","#00FF9C","#00E675","#00D452","#00BF38","#00AB24","#4DC2FF","#4DA6FF","#2194D6","#267DAB","#266696","#175487","#D0D0E0","#FFD123","#B8B8D0","#A6544D","#575961","#9E4FB5","#AB5C00","#754F45","#428296","#420066","#007D00","#70ABFA","#00BAFF","#00A1FF","#008FFF","#0080FF","#006BFF","#545CF2","#785CE3","#8A4FE3","#A136D4","#B31FD4","#B31FBA","#B30DA6","#BD0D87","#C70066","#CC0059","#D1004F","#D90045","#E00038","#E6002E","#EB0026","#000000","#000000"],cpk2D:["#000000","#000000","#FFC0CB","#B22222",null,"#00FF00","#000000","#8F8FFF","#F00000","#DAA520",null,"#0000FF","#228B22","#808090","#DAA520","#FFA500","#FFC832","#00FF00",null,"#0000FF","#808090","#808090","#808090","#808090","#808090","#808090","#FFA500","#A52A2A","#A52A2A","#A52A2A","#A52A2A"]};var t=e.atomColorSets.cpk2D,r=e.atomColorSets.jmol;t[35]="#A52A2A",t[47]="#808090",t[53]="#A020F0",t[56]="#FFA500",t[79]="#DAA520",t.SubGroup=r.SubGroup="#0000CC",e.atom3DColors=Kekule.Render.atomColorSets.jmol,e.atom2DColors=Kekule.Render.atomColorSets.cpk2D,e.atomColors=[],e.atomColors[e.RendererType.R2D]=e.atom2DColors,e.atomColors[e.RendererType.R3D]=e.atom3DColors}(),Kekule.Render.RichText={SECTION:"section",GROUP:"group",LINES:"lines",SUP:"superscript",SUB:"subscript",NORMAL:"normal"},Kekule.Render.RichTextUtils={STYLE_PROPS:["fontSize","fontFamily","fontWeight","fontStyle","color","opacity"],create:function(){return Kekule.Render.RichTextUtils.createGroup()},createGroup:function(e,t){var r={role:e||"group",items:[]};if(t)for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);return r},createSection:function(e,t){var r={text:e};if(t)for(var n in t)t.hasOwnProperty(n)&&(r[n]=t[n]);return r},strToRichText:function(e,t){e||(e="");var r=Kekule.Render.RichTextUtils,n=e.split("\n");if(n.length<=1)return Kekule.Render.RichTextUtils.appendText(r.create(),e,t);for(var o=r.createGroup(Kekule.Render.RichText.LINES),i=0,a=n.length;i<a;++i){var s=n[i]||" ";r.appendText(o,s,t)}return o},insertText:function(e,t,r,n,o){var i=Kekule.Render.RichTextUtils.createSection(r,n);return e.items.splice(t,0,i),o&&(e.anchorItem=i),e},appendText:function(e,t,r,n){var o=Kekule.Render.RichTextUtils.createSection(t,r);return e.items.push(o),n&&(e.anchorItem=o),e},appendText2:function(e,t,r,n){var o=Kekule.Render.RichTextUtils.createSection(t,r);return e.items.push(o),n&&(e.anchorItem=o),o},insert:function(e,t,r){return e.items.splice(t,0,r),e},append:function(e,t){return e.items.push(t),e},appendItems:function(e,t){return e.items=e.items.concat(Kekule.ArrayUtils.toArray(t)),e},getItemType:function(e){return e.items?e.role:Kekule.Render.RichText.SECTION},getItemRole:function(e){var t=Kekule.Render.RichText;return Kekule.Render.RichTextUtils.getItemType(e)===t.GROUP?t.GROUP:t.SECTION},getItemTextType:function(e){return e.textType||Kekule.Render.RichText.NORMAL},isSuperscript:function(e){return Kekule.Render.RichTextUtils.getItemTextType(e)==Kekule.Render.RichText.SUP},isSubscript:function(e){return Kekule.Render.RichTextUtils.getItemTextType(e)==Kekule.Render.RichText.SUB},isGroup:function(e){return Kekule.Render.RichTextUtils.getItemType(e)===Kekule.Render.RichText.GROUP},isSection:function(e){return Kekule.Render.RichTextUtils.getItemType(e)===Kekule.Render.RichText.SECTION},getFirstNormalTextSection:function(e){for(var t=0,r=e.items.length;t<r;++t){var n=e.items[t];if(Kekule.Render.RichTextUtils.getItemTextType(n)===Kekule.Render.RichText.NORMAL)return n}return null},getActualRefItem:function(e,t){var r=e.refItem;if(!r&&t.items.length>1){var n=t.items.indexOf(e);r=n>0?t.items[n-1]:0==n?t.items[1]:null}return r},getFinalAnchorItem:function(e){return e.anchorItem?Kekule.Render.RichTextUtils.getFinalAnchorItem(e.anchorItem):e},tidy:function(e){for(var t=Kekule.Render.RichTextUtils.createGroup(e.role),r=-1,n=0,o=e.items.length;n<o;++n){var i=e.items[n];if(i.items){var a=Kekule.Render.RichTextUtils.tidy(i);if(1==a.items.length){var s=Object.extend({},a);delete s.items,delete s.role,i=s=Object.extend(s,a.items[0])}else if(a.items.length>0){++r,t.items.push(a);continue}}var d=!1;if(r>=0){var l=t.items[r];l.items||Kekule.ObjUtils.equal(i,l,["text"])&&(l.text+=i.text,d=!0)}d||(++r,t.items.push(Object.extend({},i)))}return t},clone:function(e){var t={};if(Object.extend(t,e),e.items){t.items=[];for(var r=0,n=e.items.length;r<n;++r){var o={};o=Kekule.Render.RichTextUtils.clone(e.items[r]),t.items.push(o)}}if(t.items){if(e.anchorItem){var i=e.items.indexOf(e.anchorItem);t.anchorItem=i>=0?t.items[i]:null}for(r=0,n=t.items.length;r<n;++r){var a=e.items[r];o=t.items[r];if(a.refItem){i=e.items.indexOf(a.refItem);o.refItem=i>=0?t.items[i]:null}}}return t},toText:function(e){var t="";if(!e.items)return e.text||"";for(var r=0,n=e.items.length;r<n;++r){var o=e.items[r];o.items?t+=Kekule.Render.RichTextUtils.toText(o):o.text&&(t+=o.text)}return t},_toDebugHtml:function(e){if(!e.items)return e.text;for(var t="",r=0,n=e.items.length;r<n;++r){var o=e.items[r];if(o.items)t+=Kekule.Render.RichTextUtils._toDebugHtml(o);else if(o.text)switch(o.textType){case Kekule.Render.RichText.SUB:t+="<sub>"+o.text+"</sub>";break;case Kekule.Render.RichText.SUP:t+="<sup>"+o.text+"</sup>";break;default:t+=o.text}}return t},toSimpleHtmlCode:function(e){return Kekule.Render.RichTextUtils._toDebugHtml(e)},toHtml:function(e,t,r){var n,o,i=Kekule.Render.RichText;o=t.charDirection?t.charDirection===Kekule.Render.TextDirection.RTL||t.charDirection===Kekule.Render.TextDirection.BTT:r;var a=t.role;if(a===i.SECTION||t.text){var s=t.textType,d=s===i.SUB?"sub":s===i.SUP?"sup":"span";n=e.createElement(d);var l=t.text;o&&(l=l.reverse()),Kekule.DomUtils.setElementText(n,t.text||"")}else{var u,c,h=null;a===i.LINES?(n=e.createElement("div"),h="p",u="margin:0.2em 0;padding:0"):n=e.createElement("span");for(var g=0,f=t.items.length;g<f;++g){var C=t.items[g],R=Kekule.Render.RichTextUtils.toHtml(e,C,o);if(h){var p=e.createElement(h);u&&(p.style.cssText=u),p.appendChild(R),R=p}o&&c?n.insertBefore(R,c):n.appendChild(R),c=R}}var D=n.style,x=Kekule.Render.RichTextUtils.STYLE_PROPS;for(g=0,f=x.length;g<f;++g){var m=x[g];t[m]&&(D[m]=t[m])}return n},fromHtml:function(e){var t=Kekule.Render.RichText,r=Kekule.Render.RichTextUtils,n=Kekule.DomUtils,o=Kekule.StyleUtils;return function e(i,a){if(i.nodeType===Node.TEXT_NODE)return(y=(y=i.nodeValue).replace(/[\r\n]/g,"")).trim()?r.createSection(y):null;if(i.nodeType===Node.ELEMENT_NODE){var s=r.STYLE_PROPS;s.push("direction");for(var d={},l=0,u=s.length;l<u;++l){var c,h=s[l];(c=a?o.getComputedStyle(i,h):i.style[h])&&(d[h]=c)}if(d.direction?(d.charDirection="ltr"===d.direction?Kekule.Render.TextDirection.LTR:"rtl"===d.direction?Kekule.Render.TextDirection.RTL:"inherit"===d.direction?Kekule.Render.TextDirection.INHERIT:null,delete d.direction):d.charDirection=Kekule.Render.TextDirection.DEFAULT,n.getFirstChildElem(i)){var g=t.GROUP,f=n.getChildNodesOfTypes(i,[Node.ELEMENT_NODE,Node.TEXT_NODE]),C=[],R=!1;for(l=0,u=f.length;l<u;++l){var p=f[l],D=e(p,!1);p.nodeType===Node.ELEMENT_NODE&&("br"===p.tagName.toLowerCase()&&(C.push("br"),R=!0),o.isBlockElem(p)&&(R=!0,D._isLine=!0)),D&&C.push(D)}if(R){var x=[],m=[];for(l=0,u=C.length;l<u;++l)if((D=C[l])._isLine||"br"==D){if(m.length){if(m.length>1){var T=r.createGroup();r.appendItems(T,m),x.push(T)}else x.push(m[0]);m=[]}D._isLine&&(delete D._isLine,x.push(D))}else m.push(D);m.length&&(m.length>1?(T=r.createGroup(),r.appendItems(T,m),x.push(T)):x.push(m[0])),C=x}R&&(g=t.LINES);var O=r.createGroup(g,d);for(l=0,u=C.length;l<u;++l)r.append(O,C[l]);return O}var y=n.getElementText(i),E=i.tagName.toLowerCase();return d.textType="sub"===E?t.SUB:"sup"===E?t.SUP:t.NORMAL,y?r.createSection(y,d):null}}(e,!0)}},Kekule.Render.ChemDisplayTextUtils={RADICAL_LABELS:["","••","•","••"],RADICAL_TRIPLET_ALTER_LABEL:"^^",getRadicalDisplayText:function(e,t){return t&&e===Kekule.RadicalOrder.TRIPLET?Kekule.Render.ChemDisplayTextUtils.RADICAL_TRIPLET_ALTER_LABEL:Kekule.Render.ChemDisplayTextUtils.RADICAL_LABELS[e]},getChargeDisplayText:function(e,t,r){var n="";if(!!e&&(!t||Math.abs(e)>Math.pow(10,-t)/2)){var o=e>0?"+":"-",i=Math.abs(e);1!=i?n+=t?Kekule.NumUtils.toDecimals(i,t):i.toString():r===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND&&(o=e>0?"⊕":"⊖"),n+=o}return n},createElectronStateDisplayTextSection:function(e,t,r,n,o){var i=null,a="";return e&&(a=Kekule.Render.ChemDisplayTextUtils.getChargeDisplayText(e,r,n)),t&&(a+=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(t,o)||""),a&&(i=Kekule.Render.RichTextUtils.createSection(a,{textType:Kekule.Render.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR})),i},formulaToRichText:function(e,t,r,n,o,i,a){return Kekule.Render.ChemDisplayTextUtils._convFormulaToRichTextGroup(e,!1,t,r,n,o,i,a)},_convFormulaToRichTextGroup:function(e,t,r,n,o,i,a,s){var d=Kekule.Render.RichTextUtils.createGroup(),l=e.getSections();if(t){var u=e.getMaxNestedLevel()%Kekule.FormulaUtils.FORMULA_BRACKET_TYPE_COUNT,c=Kekule.FormulaUtils.FORMULA_BRACKETS[u][0],h=Kekule.FormulaUtils.FORMULA_BRACKETS[u][1];d=Kekule.Render.RichTextUtils.appendText(d,c)}for(var g=0,f=l.length;g<f;++g){var C=l[g].obj,R=e.getSectionCharge(l[g]),p=null;if(C instanceof Kekule.MolecularFormula)p=Kekule.Render.ChemDisplayTextUtils._convFormulaToRichTextGroup(C,!0,!1,!1,o,i,a);else if(C.getDisplayRichText)p=C.getDisplayRichText(Kekule.Render.HydrogenDisplayLevel.NONE,!1,null,i,o,a);if(p){if(1!=l[g].count&&((p=Kekule.Render.RichTextUtils.appendText(p,l[g].count.toString(),{textType:Kekule.Render.RichText.SUB})).charDirection=Kekule.Render.TextDirection.LTR),r&&R)(D=Kekule.Render.ChemDisplayTextUtils.createElectronStateDisplayTextSection(R,null,o,a,s))&&Kekule.Render.RichTextUtils.append(p,D);d=Kekule.Render.RichTextUtils.append(d,p)}}if(t&&(d=Kekule.Render.RichTextUtils.appendText(d,h)),r||n){R=e.getCharge();var D,x=e.getRadical();(D=Kekule.Render.ChemDisplayTextUtils.createElectronStateDisplayTextSection(R,x,o,a))&&Kekule.Render.RichTextUtils.append(d,D)}return d}},Kekule.Render.TextDrawUtils={isHorizontalLine:function(e){return e==Kekule.Render.TextDirection.LTR||e==Kekule.Render.TextDirection.RTL||null==e},isVerticalLine:function(e){return e==Kekule.Render.TextDirection.TTB||e==Kekule.Render.TextDirection.BTT},getOppositeDirection:function(e){var t=Kekule.Render.TextDirection;switch(e){case t.LTR:return t.RTL;case t.RTL:return t.LTR;case t.TTB:return t.BTT;case t.BTT:return t.TTB}},isOppositeDirection:function(e,t){return Kekule.Render.TextDrawUtils.getOppositeDirection(e)===t},getActualDirection:function(e,t){var r=Kekule.Render.TextDirection;return e===r.LINE_BREAK?t===r.TTB||t===r.BTT?r.LTR:t===r.LTR||t===r.RTL?r.TTB:e:e},getActualAlign:function(e,t){var r=Kekule.Render.TextAlgin,n=Kekule.Render.TextDirection;switch(e){case r.LEFT:case r.RIGHT:case r.TOP:case r.BOTTOM:case r.CENTER:return e;case r.LEADING:switch(t){case n.TTB:return r.TOP;case n.BTT:return r.BOTTOM;case n.RTL:return r.RIGHT;case n.LTR:default:return r.LEFT}case r.TRAILING:switch(t){case n.BTT:return r.TOP;case n.TTB:return r.BOTTOM;case n.RTL:return r.LEFT;case n.LTR:default:return r.RIGHT}}}},Kekule.Render.DrawPathUtils={makePath:function(){for(var e,t=[],r=null,n=[],o=0,i=arguments.length;o<i;++o){var a=arguments[o];DataType.isArrayValue(a)?n=n.concat(a):"number"==typeof a?n.push(a):(r&&(e={method:r,params:n},t.push(e),r=null,n=[]),r=a.toString()),o===i-1&&r&&(e={method:r,params:n},t.push(e))}return t}},Kekule.Render.ConnectorDrawUtils={getPossibleConnectorRenderTypes:function(e){if(e instanceof Kekule.Bond)return Kekule.Render.ConnectorDrawUtils.getPossibleBondRenderTypes(e);var t=Kekule.Render.BondRenderType;return[t.SINGLE,t.DASHED,t.WAVY]},getDefConnectorRenderType:function(e){return Kekule.Render.ConnectorDrawUtils.getPossibleConnectorRenderTypes(e)[0]},getPossibleBondRenderTypes:function(e){var t=Kekule.Render.BondRenderType,r=Kekule.BondType;switch(e.getBondType()){case r.HYDROGEN:return[t.DASHED,t.ARROWED,t.WAVY];case r.COORDINATE:return[t.ARROWED,t.SINGLE,t.DASHED,t.WAVY];case r.IONIC:case r.METALLIC:case r.UNKNOWN:return[t.SINGLE,t.DASHED,t.WAVY];case r.COVALENT:break;default:return[t.SINGLE,t.DASHED,t.ARROWED,t.WAVY]}if(e.getConnectedObjCount()>2)return[t.DASHED,t.SINGLE];var n=Kekule.BondOrder;switch(e.getBondOrder()){case n.DOUBLE:var o=[t.DOUBLE,t.DASHED_DOUBLE,t.BOLD_DOUBLE,t.WAVY];return e.getStereo&&[Kekule.BondStereo.E_OR_Z,Kekule.BondStereo.CIS_OR_TRANS].indexOf(e.getStereo())>=0&&o.unshift(t.SCISSORS_DOUBLE),o;case n.TRIPLE:return[t.TRIPLE,t.BOLD_TRIPLE,t.WAVY];case n.QUAD:return[t.QUAD,t.BOLD_QUAD,t.WAVY];case n.EXPLICIT_AROMATIC:return[t.SOLID_DASH,t.WAVY];case n.SINGLE:var i=Kekule.BondStereo,a=[t.SINGLE,t.BOLD,t.WAVY];switch(e.getStereo()){case i.UP:a.unshift(t.WEDGED_SOLID,t.WEDGED_HOLLOW);break;case i.UP_INVERTED:a.unshift(t.WEDGED_SOLID_INV,t.WEDGED_HOLLOW_INV);break;case i.DOWN:a.unshift(t.WEDGED_HASHED,t.DASHED);break;case i.DOWN_INVERTED:a.unshift(t.WEDGED_HASHED_INV,t.DASHED);break;case i.UP_OR_DOWN:case i.UP_OR_DOWN_INVERTED:a=[t.WAVY,t.SINGLE];break;case i.CLOSER:a=[t.WEDGED_SOLID_BOTH,t.WEDGED_HOLLOW_BOTH]}return a;default:return[t.SINGLE,t.DASHED,t.ARROWED,t.WAVY]}},getDefBondRenderType:function(e){return Kekule.Render.ConnectorDrawUtils.getPossibleBondRenderTypes(e)[0]},getConnectorRender3DType:function(e,t){var r=Kekule.Render.Bond3DRenderType,n=Kekule.Render.Bond3DRenderMode;return(!t||t!==n.WIRE&&t!==n.CYLINDER)&&e instanceof Kekule.Bond?Kekule.Render.ConnectorDrawUtils.getBondRender3DTypes(e):r.SINGLE},getBondRender3DTypes:function(e){var t=Kekule.Render.Bond3DRenderType,r=Kekule.BondType;switch(e.getBondType()){case r.HYDROGEN:return t.DASH;case r.COVALENT:break;default:return t.SINGLE}var n=Kekule.BondOrder;switch(e.getBondOrder()){case n.DOUBLE:return t.DOUBLE;case n.TRIPLE:return t.TRIPLE;case n.EXPLICIT_AROMATIC:return t.SOLID_DASH;default:return t.SINGLE}}},Kekule.Render.ObjUtils={getContainerBox:function(e,t,r){var n;t||(t=Kekule.CoordMode.COORD2D);var o=e;if(o.getExposedContainerBox)n=o.getExposedContainerBox(t,r);else if(o.getContainerBox)n=o.getContainerBox(t,r);else{var i=o.getAbsCoordOfMode?o.getAbsCoordOfMode(t):null;n=i?Kekule.BoxUtils.createBox(i,i):null}return n}},Kekule.Render.MetaShapeUtils={createShapeInfo:function(e,t,r){var n={shapeType:e,coords:t};return r&&(n=Object.extend(n,r)),n},isCompositeShape:function(e){return DataType.isArrayValue(e)},inflateShape:function(e,t){if(!e)return null;var r,n=Kekule.Render.MetaShapeType,o=Kekule.Render.MetaShapeUtils;if(o.isCompositeShape(e)){for(var i=[],a=0,s=e.length;a<s;++a){var d=e[a],l=o.inflateShape(d,t);i.push(l)}return i}switch(e.shapeType){case n.POINT:r=o._inflatePointShape(e,t);break;case n.CIRCLE:r=o._inflateCircleShape(e,t);break;case n.LINE:r=o._inflateLineShape(e,t);break;case n.RECT:r=o._inflateRectShape(e,t);break;case n.POLYGON:r=o._inflatePolygonShape(e,t);break;case n.ARC:r=o._inflateArcShape(e,t)}return r},_inflatePointShape:function(e,t){return Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.CIRCLE,[e.coords[0]],{radius:t})},_inflateCircleShape:function(e,t){return Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.CIRCLE,[e.coords[0]],{radius:e.radius+t})},_inflateLineShape:function(e,t){return Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.LINE,[e.coords[0],e.coords[1]],{width:(e.width||0)+2*t})},_inflateArcShape:function(e,t){var r=Object.extend({},e);return r.width=(e.width||0)+2*t,r},_inflateRectShape:function(e,t){var r=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.RECT,[]),n=Kekule.Render.MetaShapeUtils._inflateCoords(e.coords,t);return r.coords=n,r},_inflatePolygonShape:function(e,t){var r=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.POLYGON,[]),n=Kekule.Render.MetaShapeUtils._inflateCoords(e.coords,t);return r.coords=n,r},_inflateCoords:function(e,t){for(var r=Kekule.CoordUtils,n=[],o=r.getCenter(e),i=0,a=e.length;i<a;++i){var s=e[i],d=r.substract(s,o),l=r.getDistance(d),u=r.multiply(d,t/l),c=r.add(s,u);n.push(c)}return n},getDistance:function(e,t,r){if(Kekule.Render.MetaShapeUtils.isCompositeShape(t)){for(var n=null,o=0,i=t.length;o<i;++o){var a=t[o],s=Kekule.Render.MetaShapeUtils.getDistance(e,a,r);(null===n||n>s)&&(n=s)}return n}var d=Kekule.Render.MetaShapeType,l=Kekule.Render.MetaShapeUtils,u=r?l.inflateShape(t,r):t;switch(t.shapeType){case d.POINT:return r?l._getDistanceToCircle(e,u):l._getDistanceToPoint(e,u);case d.CIRCLE:return l._getDistanceToCircle(e,u);case d.LINE:return l._getDistanceToLine(e,u);case d.RECT:return l._getDistanceToRect(e,u);case d.POLYGON:return l._getDistanceToPolygon(e,u);case d.ARC:return l._getDistanceToArc(e,u);default:return!1}},_getDistanceToPoint:function(e,t){return Kekule.CoordUtils.getDistance(e,t.coords[0])},_getDistanceToCircle:function(e,t){return Kekule.CoordUtils.getDistance(e,t.coords[0])-t.radius},_getDistanceToArc:function(e,t){var r=Kekule.CoordUtils,n=r.substract(e,t.coords[0]),o=Math.atan2(n.y,n.x);if(Kekule.Render.MetaShapeUtils.isAngleInArcRange(o,t.startAngle,t.endAngle,t.anticlockwise)){var i=r.getDistance(e,t.coords[0]);i=Math.abs(i-t.radius);return t.width&&t.width>1&&(i-=t.width/2),Math.max(0,i)}var a,s=t.coords[0];a=t.width&&t.width>1?[t.radius-t.width/2,t.radius+t.width/2]:[t.radius];for(var d=[],l=t.startAngle,u=t.endAngle,c=0,h=a.length;c<h;++c){var g=a[c],f=r.add(s,{x:g*Math.cos(l),y:g*Math.sin(l)}),C=r.add(s,{x:g*Math.cos(u),y:g*Math.sin(u)});d.push(f),d.push(C)}var R=null;for(c=0,h=d.length;c<h;++c){i=r.getDistance(d[c],e);(null===R||R>i)&&(R=i)}return R},_getDistanceToLine:function(e,t){var r=Kekule.Render.MetaShapeUtils,n=t.coords,o=Kekule.Render.MetaShapeUtils._calcVerticalLineCrossPoint(e,n[0],n[1]),i=Kekule.NumUtils;if(i.isFloatEqual(n[0].x,n[1].x)&&i.isFloatEqual(n[0].y,n[1].y)){var a={coords:[t.coords[0]],radius:t.width};return r._getDistanceToCircle(e,a)}var s=Kekule.CoordUtils.substract(n[1],n[0]);if(Math.abs(s.y)>Math.abs(s.x)?Math.sign(o.y-n[0].y)*Math.sign(o.y-n[1].y)<=0:Math.sign(o.x-n[0].x)*Math.sign(o.x-n[1].x)<=0)return Kekule.CoordUtils.getDistance(e,o)-(t.width||0)/2;var d={coords:[t.coords[0]],radius:t.width||0},l={coords:[t.coords[1]],radius:t.width||0},u=r._getDistanceToCircle(e,d),c=r._getDistanceToCircle(e,l);return Math.min(u,c)},_getDistanceToRect:function(e,t){var r=t.coords,n=e.x-r[0].x,o=e.x-r[1].x,i=e.y-r[0].y,a=e.y-r[1].y;if(n*o<=0&&i*a<=0)return-Math.min(Math.abs(n),Math.abs(o),Math.abs(i),Math.abs(a));var s=Kekule.CoordUtils;return Math.min(s.getDistance(e,r[0]),s.getDistance(e,r[1]),s.getDistance(e,{x:r[0].x,y:r[1].y}),s.getDistance(e,{x:r[1].x,y:r[0].y}))},_getDistanceToPolygon:function(e,t){Kekule.CoordUtils;for(var r=Kekule.Render.MetaShapeUtils,n=Kekule.Render.MetaShapeType,o=r._isInsidePolygon(e,t),i=t.coords,a=null,s=0,d=i.length;s<d;++s){var l=i[s],u=i[(s+1)%d],c=r.createShapeInfo(n.LINE,[l,u],{width:0}),h=r._getDistanceToLine(e,c);null===a?a=h:a>h&&(a=h)}return o&&(a=-a),a},_getDistanceOfTwoLines:function(e,t){Kekule.Render.MetaShapeUtils;var r=Kekule.GeometryUtils;if(r.getCrossPointOfLines(e[0],e[1],t[0],t[1]))return 0;var n=r.getDistanceFromPointToLine(e[0],t[0],t[1]),o=r.getDistanceFromPointToLine(e[1],t[0],t[1]),i=r.getDistanceFromPointToLine(t[0],e[0],e[1]),a=r.getDistanceFromPointToLine(t[1],e[0],e[1]);return Math.min(n,o,i,a)},isCoordInside:function(e,t,r){if(!e)return!1;if(Kekule.Render.MetaShapeUtils.isCompositeShape(t)){for(var n=0,o=t.length;n<o;++n){var i=t[n];if(Kekule.Render.MetaShapeUtils.isCoordInside(e,i,r))return!0}return!1}var a=Kekule.Render.MetaShapeType,s=Kekule.Render.MetaShapeUtils,d=r?s.inflateShape(t,r):t;if(!d)return!1;switch(t.shapeType){case a.POINT:return r?s._isInsideCircle(e,d):s._isInsidePoint(e,d);case a.CIRCLE:return s._isInsideCircle(e,d);case a.LINE:return s._isInsideLine(e,d);case a.RECT:return s._isInsideRect(e,d);case a.POLYGON:return s._isInsidePolygon(e,d);case a.ARC:return s._isInsideArc(e,d);default:return!1}},_isInsidePoint:function(e,t){return Kekule.CoordUtils.isEqual(e,t.coords[0])},_isInsideCircle:function(e,t){return Kekule.CoordUtils.getDistance(e,t.coords[0])<=t.radius},_isInsideLine:function(e,t){var r=t.coords,n=Kekule.Render.MetaShapeUtils._calcVerticalLineCrossPoint(e,r[0],r[1]),o=Kekule.NumUtils;if(o.isFloatEqual(r[0].x,r[1].x)&&o.isFloatEqual(r[0].y,r[1].y)){var i={coords:[t.coords[0]],radius:t.width};return Kekule.Render.MetaShapeUtils._isInsideCircle(e,i)}var a=Kekule.CoordUtils.substract(r[1],r[0]);return!!(Math.abs(a.y)>Math.abs(a.x)?Math.sign(n.y-r[0].y)*Math.sign(n.y-r[1].y)<=0:Math.sign(n.x-r[0].x)*Math.sign(n.x-r[1].x)<=0)&&Kekule.CoordUtils.getDistance(e,n)<=t.width/2},_isInsideArc:function(e,t){var r=Kekule.CoordUtils,n=Kekule.GeometryUtils,o=r.getDistance(e,t.coords[0]),i=Math.abs(o-t.radius)<t.width/2;if(i){var a=r.substract(e,t.coords[0]),s=n.standardizeAngle(Math.atan2(a.y,a.x),0);i=Kekule.Render.MetaShapeUtils.isAngleInArcRange(s,t.startAngle,t.endAngle,t.anticlockwise)}return i},_isInsideRect:function(e,t){var r=t.coords;return Kekule.CoordUtils.insideRect(e,r[0],r[1])},_isInsidePolygon:function(e,t){for(var r=Kekule.CoordUtils,n=t.coords,o=0,i=0,a=n.length;i<a;++i){var s=n[i],d=n[(i+1)%a],l=r.substract(d,s);if(0!==l.x){var u={x:e.x};u.y=(u.x-s.x)/l.x*l.y+s.y,r.insideRect(u,s,d)&&++o}}return o%2==0},_calcVerticalLineCrossPoint:function(e,t,r){var n={};if(Math.abs(t.x-r.x)<1e-10)n.x=t.x,n.y=e.y;else{var o=(r.y-t.y)/(r.x-t.x);n.x=(o*o*t.x+o*(e.y-t.y)+e.x)/(o*o+1),n.y=o*(n.x-t.x)+t.y}return n},getContainerBox:function(e,t){var r=Kekule.Render.MetaShapeType,n=Kekule.Render.MetaShapeUtils,o=Kekule.BoxUtils;if(!e)return null;var i,a=e.coords;if(t=t||0,n.isCompositeShape(e)){i=null;for(var s=0,d=e.length;s<d;++s){var l=e[s],u=n.getContainerBox(l);i=i?o.getContainerBox(i,u):u}}else switch(e.shapeType){case r.POINT:case r.CIRCLE:var c=e.shapeType===r.POINT?0:e.radius||0,h=a[0];i=o.createBox({x:h.x-c,y:h.y-c},{x:h.x+c,y:h.y+c});break;case r.LINE:i=o.createBox(a[0],a[1]),i=Kekule.BoxUtils.inflateBox(i,(e.width||0)/2);break;case r.ARC:i=Kekule.Render.MetaShapeUtils._getArcContainerBox(e);break;case r.RECT:i=o.createBox(a[0],a[1]);break;case r.POLYGON:i=o.createBox(a[0],a[0]);for(s=1,d=a.length;s<d;++s){h=a[s];i={x1:Math.min(i.x1,h.x),y1:Math.min(i.y1,h.y),x2:Math.max(i.x2,h.x),y2:Math.max(i.y2,h.y)}}}return t&&(i=Kekule.BoxUtils.inflateBox(i,t)),i},_getArcContainerBox:function(e){var t,r=Kekule.Render.MetaShapeUtils,n=Kekule.CoordUtils;t=e.width&&e.width>1?[e.radius+e.width/2,e.radius-e.width/2]:[e.radius];for(var o=e.coords[0],i=Math.PI/2,a=function(e,t){return n.add(o,{x:t*Math.cos(e),y:t*Math.sin(e)})},s=[],d=0,l=t.length;d<l;++d){var u=t[d],c=a(e.startAngle,u),h=a(e.endAngle,u);s=s.concat([c,h]);for(var g=[0,i,2*i,3*i],f=0,C=g.length;f<C;++f)r.isAngleInArcRange(g[f],e.startAngle,e.endAngle,e.anticlockwise)&&s.push(a(g[f],u))}return n.getContainerBox(s)},isAngleInArcRange:function(e,t,r,n){var o=Kekule.GeometryUtils.standardizeAngle,i=o(t),a=o(r),s=o(e),d=Math.sign(s-i)*Math.sign(s-a)*Math.sign(a-i);return n?d>=0:d<=0},isIntersectingLine:function(e,t,r){var n=Kekule.Render.MetaShapeType,o=Kekule.Render.MetaShapeUtils;if(o.isCompositeShape(e)){for(var i=0,a=e.length;i<a;++i){var s=e[i];if(o.isIntersectingLine(s,t,r))return!0}return!1}var d=o.createShapeInfo(n.LINE,t),l=r/2,u=e.coords;switch(e.shapeType){case n.POINT:return(h=o._getDistanceToLine(u[0],d))<=l;case n.CIRCLE:return(h=o._getDistanceToLine(u[0],d))<=l+(d.radius||0);case n.LINE:return(h=o._getDistanceOfTwoLines(u,t))<=l+(d.width||0);case n.RECT:case n.POLYGON:var c=o._getCoordsForShapeInComparingWithPolygon(e),h=null,g=c.length-1;for(i=0,a=c.length;i<a;++i){var f=[c[i],c[g]],C=o._getDistanceOfTwoLines(f,t);(null===h||C<h)&&(h=C),g=i}return h<=l}return!1},isInsideBox:function(e,t){var r=Kekule.Render.MetaShapeUtils.getContainerBox(e);return Kekule.BoxUtils.isInside(r,t)},isIntersectingBox:function(e,t){if(!Kekule.Render.MetaShapeUtils.isCompositeShape(e)){var r=e.coords;for(o=0,i=r.length;o<i;++o){var n=r[o];if(Kekule.CoordUtils.isInsideBox(n,t))return!0}return!1}for(var o=0,i=e.length;o<i;++o){var a=e[o];if(Kekule.Render.MetaShapeUtils.isIntersectingBox(a,t))return!0}},isPointInsidePolygon:function(e,t){for(var r=!1,n=t.length,o=n-1,i=0;i<n;++i)t[i].y>e.y!=t[o].y>e.y&&e.x<(t[o].x-t[i].x)*(e.y-t[i].y)/(t[o].y-t[i].y)+t[i].x&&(r=!r),o=i;return r},isInsidePolygon:function(e,t){var r=Kekule.Render.MetaShapeUtils,n=r._getCoordsForShapeInComparingWithPolygon(e);if(!n)return!1;for(var o=0,i=n.length;o<i;++o){var a=n[o];if(!r.isPointInsidePolygon(a,t))return!1}return!0},isIntersectingPolygon:function(e,t){var r=Kekule.Render.MetaShapeUtils,n=r._getCoordsForShapeInComparingWithPolygon(e);if(!n)return!1;for(var o=0,i=n.length;o<i;++o){var a=n[o];if(r.isPointInsidePolygon(a,t))return!0}return!1},isIntersectingPolyline:function(e,t,r){for(var n=Kekule.Render.MetaShapeUtils,o=0,i=t.length-1;o<i;++o){var a=[t[o],t[o+1]];if(n.isIntersectingLine(e,a,r))return!0}return!1},_getCoordsForShapeInComparingWithPolygon:function(e){var t,r=Kekule.Render.MetaShapeType,n=Kekule.Render.MetaShapeUtils;if(n.isCompositeShape(e)){t=[];for(var o=0,i=e.length;o<i;++o){var a=e[o],s=n._getCoordsForShapeInComparingWithPolygon(a);t=t.concat(s)}return t}var d=e.coords;switch(e.shapeType){case r.POINT:t=[d[0]];break;case r.CIRCLE:var l=e.radius||0;if(l){var u=l,c=u/Math.sqrt(2);t=[{x:u,y:0},{x:c,y:c},{x:0,y:u},{x:-c,y:c},{x:-u,y:0},{x:-c,y:-c},{x:0,y:-u},{x:c,y:-c}]}else t=[d[0]];break;case r.LINE:t=[d[0],d[1]];break;case r.RECT:var h=d[0],g=d[1];t=[h,{x:g.x,y:h.y},g,{x:h.x,y:g.y}];break;case r.POLYGON:t=d}return t},getEdgeVectors:function(e){var t,r=Kekule.Render.MetaShapeType,n=Kekule.Render.MetaShapeUtils,o=Kekule.CoordUtils;if(n.isCompositeShape(e)){t=[];for(var i=0,a=e.length;i<a;++i){var s=e[i],d=n.getEdgeVectors(s);t=t.concat(d)}return t}var l=e.coords;switch(e.shapeType){case r.POINT:t=[[l[0],l[0]]];break;case r.CIRCLE:t=null;break;case r.LINE:var u=e.width;if(u){var c=l[0],h=l[1],g=o.substract(h,c),f=o.getDistance(c,h),C=u/2,R=C*(g.y/f),p=C*(g.x/f),D=[{x:c.x-R,y:c.y+p},{x:c.x+R,y:c.y-p},{x:h.x+R,y:h.y-p},{x:h.x-R,y:h.y+p}];t=[[D[0],D[1]],[D[1],D[2]],[D[2],D[3]],[D[3],D[0]]]}else t=[[l[0],l[1]]];break;case r.RECT:var x=l[0],m=(c={x:(h=l[1]).x,y:x.y},{x:x.x,y:h.y});t=[[x,c],[c,h],[h,m],[m,x]];break;case r.POLYGON:t=[];for(i=0,a=l.length-1;i<a;++i){var T=++i;T>=a&&(T=0),t.push([l[i],l[T]])}}return t},getEdgeBasicElements:function(e){var t=Kekule.Render.MetaShapeType,r=Kekule.Render.MetaShapeUtils,n={vectors:[],circles:[]};if(r.isCompositeShape(e)){for(var o=0,i=e.length;o<i;++o){var a=e[o],s=r.getEdgeBasicElements(a);n.vectors=n.concat(s.vectors),n.circles=n.concat(s.circles)}return n}var d=e.coords;switch(e.shapeType){case t.POINT:n.circles.push({center:d[0],radius:0});break;case t.CIRCLE:n.circles.push({center:d[0],radius:e.radius});break;default:n.vectors=n.vectors.concat(Kekule.Render.MetaShapeUtils.getEdgeVectors(e))}return n},getCrossPointsOfVectorToShapeEdges:function(e,t,r,n){for(var o=Kekule.Render.MetaShapeUtils.getEdgeBasicElements(t),i=o.vectors,a=o.circles,s=[],d=0,l=i.length;d<l;++d){var u=i[d],c=Kekule.GeometryUtils.getCrossPointOfVectors(e,u);if(c&&(s.push(c),r))return s}for(d=0,l=a.length;d<l;++d){var h=a[d],g=Kekule.GeometryUtils.getCrossPointsOfVectorToCircle(e,h.center,h.radius,n);if(g&&g.length&&(s=s.concat(g),r))return s}return s}},Kekule.Render.RenderOptionUtils={mergeObjLocalRenderOptions:function(e,t){var r=e&&e.getOverriddenRenderOptions?e.getOverriddenRenderOptions():null;return Kekule.Render.RenderOptionUtils.mergeRenderOptions(r||{},t)},mergeObjLocalRender3DOptions:function(e,t){var r=e&&e.getOverriddenRender3DOptions?e.getOverriddenRender3DOptions():null;return Kekule.Render.RenderOptionUtils.mergeRenderOptions(r||{},t)},mergeRenderOptions:function(e,t){var r=Object.create(t);return r=Object.extend(r,e,!0,!0)},getColor:function(e){return e?e.color:null},getMoleculeDisplayType:function(e){return e?e.moleculeDisplayType:null},getNodeDisplayMode:function(e){return e?e.nodeDisplayMode:null},getHydrogenDisplayLevel:function(e){return e?e.hydrogenDisplayLevel:null},getShowCharge:function(e){return e?e.showCharge:null},getChargeDrawOptions:function(e){if(e){return Object.copyValues({},e,["showCharge","chargeMarkType","chargeMarkFontSize","chargeMarkMargin","chargeMarkCircleWidth","color","opacity"])}return null},getNodeLabelDrawOptions:function(e){if(e){return Object.copyValues({},e,["fontSize","fontFamily","supFontSizeRatio","subFontSizeRatio","superscriptOverhang","subscriptOversink","textBoxXAlignment","textBoxYAlignment","color","opacity"])}return null},getConnectorRenderType:function(e){return e?e.renderType:null},getConnectorDrawParams:function(e){if(e){return Object.copyValues({},e,["bondLineWidth","boldBondLineWidth","hashSpacing","multipleBondSpacingRatio","multipleBondSpacingAbs","multipleBondMaxAbsSpacing","bondArrowLength","bondArrowWidth","bondWedgeWidth","bondWedgeHashMinWidth","color","opacity"])}return null},convertConfigsToPlainHash:function(e){var t=Kekule.Render.RenderOptionUtils;return e instanceof Kekule.Render.Render3DConfigs?t.convert3DConfigsToPlainHash(e):t.convert2DConfigsToPlainHash(e)},convert2DConfigsToPlainHash:function(e){var t=Kekule.ObjUtils,r={};r._configs=e;var n=e.getGeneralConfigs().toHash();return t.replacePropName(n,"drawOpacity","opacity"),r=Object.extend(r,n),n=e.getMoleculeDisplayConfigs().toHash(),t.replacePropName(n,"defMoleculeDisplayType","moleculeDisplayType"),t.replacePropName(n,"defNodeDisplayMode","nodeDisplayMode"),t.replacePropName(n,"defHydrogenDisplayLevel","hydrogenDisplayLevel"),t.replacePropName(n,"defChargeMarkType","chargeMarkType"),(r=Object.extend(r,n)).displayLabelConfigs=e.getDisplayLabelConfigs(),n=e.getTextFontConfigs().toHash(),r=Object.extend(r,n),n=e.getLengthConfigs().toHash(),(r=Object.extend(r,n)).unitLength=r.unitLength||1,n=e.getColorConfigs().toHash(),r=Object.extend(r,n)},convert3DConfigsToPlainHash:function(e){var t=Kekule.ObjUtils,r={};r._configs=e;var n=e.getGeneralConfigs().toHash();t.replacePropName(n,"drawOpacity","opacity"),r=Object.extend(r,n);n=e.getEnvironmentConfigs().toHash();r=Object.extend(r,n);n=e.getMoleculeDisplayConfigs().toHash();t.replacePropName(n,"defMoleculeDisplayType","moleculeDisplayType"),t.replacePropName(n,"defBondSpliceMode","bondSpliceMode"),t.replacePropName(n,"defDisplayMultipleBond","displayMultipleBond"),t.replacePropName(n,"defBondColor","bondColor"),t.replacePropName(n,"defAtomColor","atomColor"),r=Object.extend(r,n);n=e.getModelConfigs().toHash();r=Object.extend(r,n);n=e.getLengthConfigs().toHash();return r=Object.extend(r,n)},getCascadeRenderOptionValueOfObjs:function(e,t,r){for(var n,o=!1,i=Kekule.ArrayUtils.toArray(e),a=r?"getCascadedRender3DOption":"getCascadedRenderOption",s=0,d=i.length;s<d;++s){var l=i[s];if(l[a]){var u=l[a](t);if(o){if(n!=u)return null}else n=u,o=!0}}return n},setRenderOptionValueOfObjs:function(e,t,r){for(var n=Kekule.ArrayUtils.toArray(e),o=0,i=n.length;o<i;++o){var a=n[o];if(a.setRenderOption)for(var s=Kekule.ObjUtils.getOwnedFieldNames(t),d=0,l=s.length;d<l;++d)a.setRenderOption(s[d],t[s[d]])}}},Kekule.Render.Render3DOptionUtils={getConnectorRenderType:function(e){return e?e.renderType:null},convertConfigsToPlainHash:function(e){}},Kekule.Render.RenderColorUtils={getActiveAtomColorSet:function(e){return Kekule.Render.atomColors[e]},setActiveAtomColorSet:function(e,t){var r=Kekule.Render.AtomColorSets[e];return r&&(Kekule.Render.atomColorSet[t]=r),r},getColor:function(e,t){var r=Kekule.Render.RenderColorUtils.getActiveAtomColorSet(t),n=r[e];return n||(n=r[0]),n}},Kekule.Render.UpdateObjUtils={_extractObjsOfUpdateObjDetails:function(e){for(var t=[],r=0,n=e.length;r<n;++r){var o=e[r];o.obj&&Kekule.ArrayUtils.pushUnique(t,o.obj)}return t},_createUpdateObjDetailsFromObjs:function(e){for(var t=[],r=0,n=e.length;r<n;++r)t.push({obj:e[r]});return t}},function(){"use strict";var e=Kekule.OBJDEF_TEXTS,t=Class.PropertyScope;Kekule.Render.PredefinedConfigsMap=Class.create(Kekule.ConfigPresetMap,{CLASS_NAME:"Kekule.Render.PredefinedConfigsMap"}),Kekule.Render.GeneralConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.GeneralConfigs",initProperties:function(){this.addBoolConfigProp("allowCoordBorrow",!0,{scope:t.PUBLIC}),this.addFloatConfigProp("drawOpacity",1,{title:e.TITLE_DRAWOPACITY,description:e.DES_DRAWOPACITY})}}),Kekule.Render.Render2DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render2DConfigs",initProperties:function(){this.addConfigProp("generalConfigs","Kekule.Render.GeneralConfigs"),this.addConfigProp("moleculeDisplayConfigs","Kekule.Render.MoleculeDisplayConfigs"),this.addConfigProp("displayLabelConfigs","Kekule.Render.DisplayLabelConfigs"),this.addConfigProp("textFontConfigs","Kekule.Render.TextFontConfigs"),this.addConfigProp("lengthConfigs","Kekule.Render.LengthConfigs"),this.addConfigProp("colorConfigs","Kekule.Render.ColorConfigs")},initPropValues:function($super){$super(),this.setPropStoreFieldValue("generalConfigs",new Kekule.Render.GeneralConfigs),this.setPropStoreFieldValue("moleculeDisplayConfigs",new Kekule.Render.MoleculeDisplayConfigs),this.setPropStoreFieldValue("displayLabelConfigs",new Kekule.Render.DisplayLabelConfigs),this.setPropStoreFieldValue("textFontConfigs",new Kekule.Render.TextFontConfigs),this.setPropStoreFieldValue("lengthConfigs",new Kekule.Render.LengthConfigs),this.setPropStoreFieldValue("colorConfigs",new Kekule.Render.ColorConfigs)},initInteractStyleMap:function(){}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.Render2DConfigs),Kekule.Render.getRender2DConfigs=function(){return Kekule.Render.Render2DConfigs.getInstance()},Kekule.Render.MoleculeDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.MoleculeDisplayConfigs",initProperties:function(){this.addIntConfigProp("defMoleculeDisplayType",Kekule.Render.MoleculeDisplayType.SKELETAL,{enumSource:Kekule.Render.MoleculeDisplayType}),this.addIntConfigProp("defNodeDisplayMode",Kekule.Render.NodeLabelDisplayMode.SMART,{enumSource:Kekule.Render.NodeLabelDisplayMode}),this.addIntConfigProp("defHydrogenDisplayLevel",Kekule.Render.HydrogenDisplayLevel.DEFAULT,{enumSource:Kekule.Render.HydrogenDisplayLevel}),this.addIntConfigProp("defChargeMarkType",Kekule.Render.ChargeMarkRenderType.DEFAULT,{enumSource:Kekule.Render.ChargeMarkRenderType}),this.addBoolConfigProp("distinguishSingletAndTripletRadical",!1),this.addIntConfigProp("partialChargeDecimalsLength",2),this.addBoolConfigProp("autoCreateChargeAndRadicalMarker",!0)}}),Kekule.Render.DisplayLabelConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.DisplayLabelConfigs",DEF_UNSET_ELEMENT:"?",DEF_DUMMY_ATOM:"Du",DEF_HETERO_ATOM:"Q",DEF_ANY_ATOM:"A",DEF_VARIABLE_ATOM:"L",DEF_RGROUP:"R",DEF_ISO_LIST_LEADING_BRACKET:"[",DEF_ISO_LIST_TAILING_BRACKET:"]",DEF_ISO_LIST_DELIMITER:",",DEF_ISO_LIST_DISALLOW_PREFIX:"NOT",initProperties:function(){var e=Kekule.ChemStructureNodeLabels;this.addBoolConfigProp("enableIsotopeAlias",e.ENABLE_ISOTOPE_ALIAS,{getter:function(){return e.ENABLE_ISOTOPE_ALIAS},setter:function(t){e.ENABLE_ISOTOPE_ALIAS=t}}),this.addStrConfigProp("unsetElement",e.UNSET_ELEMENT,{getter:function(){return e.UNSET_ELEMENT},setter:function(t){t&&(e.UNSET_ELEMENT=t)}}),this.addStrConfigProp("dummyAtom",e.DUMMY_ATOM,{getter:function(){return e.DUMMY_ATOM},setter:function(t){t&&(e.DUMMY_ATOM=t)}}),this.addStrConfigProp("heteroAtom",e.HETERO_ATOM,{getter:function(){return e.HETERO_ATOM},setter:function(t){t&&(e.HETERO_ATOM=t)}}),this.addStrConfigProp("anyAtom",e.ANY_ATOM,{getter:function(){return e.ANY_ATOM},setter:function(t){t&&(e.ANY_ATOM=t)}}),this.addStrConfigProp("variableAtom",e.VARIABLE_ATOM,{getter:function(){return e.VARIABLE_ATOM},setter:function(t){t&&(e.VARIABLE_ATOM=t)}}),this.addStrConfigProp("rgroup",e.SUBGROUP,{getter:function(){return e.SUBGROUP},setter:function(t){t&&(e.SUBGROUP=t)}}),this.addStrConfigProp("isoListLeadingBracket",e.ISO_LIST_LEADING_BRACKET,{getter:function(){return e.ISO_LIST_LEADING_BRACKET},setter:function(t){t&&(e.ISO_LIST_LEADING_BRACKET=t)}}),this.addStrConfigProp("isoListTailingBracket",e.ISO_LIST_TAILING_BRACKET,{getter:function(){return e.ISO_LIST_TAILING_BRACKET},setter:function(t){t&&(e.ISO_LIST_TAILING_BRACKET=t)}}),this.addStrConfigProp("isoListDelimiter",e.ISO_LIST_DELIMITER,{getter:function(){return e.ISO_LIST_DELIMITER},setter:function(t){t&&(e.ISO_LIST_DELIMITER=t)}}),this.addStrConfigProp("isoListDisallowPrefix",e.ISO_LIST_DISALLOW_PREFIX,{getter:function(){return e.ISO_LIST_DISALLOW_PREFIX},setter:function(t){t&&(e.ISO_LIST_DISALLOW_PREFIX=t)}})}}),Kekule.Render.TextFontConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.TextFontConfigs",DEF_LABEL_FONT_FAMILY:"",initProperties:function(){this.addStrConfigProp("labelFontFamily","Arial, Helvetica, sans-serif"),this.addStrConfigProp("atomFontFamily","Arial, Helvetica, sans-serif"),this.addFloatConfigProp("supFontSizeRatio",.66),this.addFloatConfigProp("subFontSizeRatio",.66),this.addFloatConfigProp("superscriptOverhang",.2),this.addFloatConfigProp("subscriptOversink",.2),this.addIntConfigProp("textCharDirection",Kekule.Render.TextDirection.LTR,{enumSource:Kekule.Render.TextDirection}),this.addIntConfigProp("textHorizontalAlign",Kekule.Render.TextAlign.LEADING,{enumSource:Kekule.Render.TextAlign}),this.addIntConfigProp("textVerticalAlign",Kekule.Render.TextAlign.LEADING,{enumSource:Kekule.Render.TextAlign}),this.addIntConfigProp("textBoxXAlignment",Kekule.Render.BoxXAlignment.LEFT,{enumSource:Kekule.Render.BoxXAlignment,scope:t.PUBLIC}),this.addIntConfigProp("textBoxYAlignment",Kekule.Render.BoxYAlignment.TOP,{enumSource:Kekule.Render.BoxYAlignment,scope:t.PUBLIC}),this.addIntConfigProp("textBoxAlignmentMode",Kekule.Render.TextBoxAlignmentMode.ANCHOR,{enumSource:Kekule.Render.TextBoxAlignmentMode,scope:t.PUBLIC})}}),Kekule.Render.LengthConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.LengthConfigs",initProperties:function(){this.addFloatConfigProp("unitLength",1,{scope:t.PUBLIC}),this.addFloatConfigProp("labelFontSize",14),this.addFloatConfigProp("atomFontSize",14),this.addFloatConfigProp("atomLabelBoxExpandRatio",1.2,{scope:t.PUBLIC}),this.addFloatConfigProp("chargeMarkFontSize",10),this.addFloatConfigProp("chargeMarkMargin",5),this.addFloatConfigProp("chemMarkerFontSize",10),this.addFloatConfigProp("chemMarkerMargin",5),this.addFloatConfigProp("allenCenterAtomRadius",3),this.addFloatConfigProp("defBondLength",25),this.addFloatConfigProp("bondLineWidth",1),this.addFloatConfigProp("boldBondLineWidthRatio",2,{scope:t.PUBLIC}),this.addFloatConfigProp("hashSpacing",3),this.addFloatConfigProp("multipleBondSpacingRatio",.18),this.addFloatConfigProp("multipleBondSpacingAbs",null,{scope:t.PUBLIC}),this.addFloatConfigProp("multipleBondMaxAbsSpacing",5),this.addFloatConfigProp("bondArrowLength",6),this.addFloatConfigProp("bondArrowWidth",6),this.addFloatConfigProp("bondWedgeWidth",6),this.addFloatConfigProp("bondWedgeHashMinWidth",2),this.addFloatConfigProp("bondWavyRadius",5),this.addFloatConfigProp("glyphStrokeWidth",1),this.addFloatConfigProp("glyphStickOffsetRelLength",.1),this.addFloatConfigProp("rxnMolMargin",10,{scope:t.PUBLIC}),this.addFloatConfigProp("defScaleRefLength",.8),this.addFloatConfigProp("autofitContextPadding",45)},getActualLength:function(e){var t=this.getPropValue(e);return null!=t?t*this.getUnitLength():null}}),Kekule.Render.ColorConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.ColorConfigs",initProperties:function(){this.addBoolConfigProp("useAtomSpecifiedColor",!1),this.addStrConfigProp("labelColor","#000000"),this.addStrConfigProp("atomColor","#000000"),this.addStrConfigProp("bondColor","#000000"),this.addStrConfigProp("glyphStrokeColor","#999999"),this.addStrConfigProp("glyphFillColor","#999999")}}),Kekule.Render.Render3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render3DConfigs",initProperties:function(){this.addConfigProp("generalConfigs","Kekule.Render.GeneralConfigs"),this.addConfigProp("moleculeDisplayConfigs","Kekule.Render.Molecule3DDisplayConfigs"),this.addConfigProp("lengthConfigs","Kekule.Render.Length3DConfigs"),this.addConfigProp("environmentConfigs","Kekule.Render.Render3DEnvironmentConfigs"),this.addConfigProp("modelConfigs","Kekule.Render.Model3DConfigs")},initPropValues:function($super){$super(),this.setPropStoreFieldValue("generalConfigs",new Kekule.Render.GeneralConfigs),this.setPropStoreFieldValue("environmentConfigs",new Kekule.Render.Render3DEnvironmentConfigs),this.setPropStoreFieldValue("moleculeDisplayConfigs",new Kekule.Render.Molecule3DDisplayConfigs),this.setPropStoreFieldValue("modelConfigs",new Kekule.Render.Model3DConfigs),this.setPropStoreFieldValue("lengthConfigs",new Kekule.Render.Length3DConfigs)}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.Render3DConfigs),Kekule.Render.getRender3DConfigs=function(){return Kekule.Render.Render3DConfigs.getInstance()},Kekule.Render.Render3DEnvironmentConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render3DEnvironmentConfigs",initProperties:function(){this.addIntConfigProp("graphicQuality",Kekule.Render.Render3DGraphicQuality.MEDIUM,{enumSource:Kekule.Render.Render3DGraphicQuality})}}),Kekule.Render.Molecule3DDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Molecule3DDisplayConfigs",initProperties:function(){this.addIntConfigProp("defMoleculeDisplayType",Kekule.Render.Molecule3DDisplayType.BALL_STICK,{enumSource:Kekule.Render.Molecule3DDisplayType}),this.addIntConfigProp("defBondSpliceMode",Kekule.Render.Bond3DSpliceMode.WEIGHTING_SPLIT,{enumSource:Kekule.Render.Bond3DSpliceMode}),this.addBoolConfigProp("defDisplayMultipleBond",!0),this.addStrConfigProp("defBondColor","#FFFFFF"),this.addStrConfigProp("defAtomColor","#000099"),this.addBoolConfigProp("useAtomSpecifiedColor",!0)}}),Kekule.Render.Model3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Model3DConfigs",initProperties:function(){this.addBoolConfigProp("showNodeLabel",!0,{scope:t.PUBLIC}),this.addBoolConfigProp("hideHydrogens",!1),this.addBoolConfigProp("useVdWRadius",!0),this.addFloatConfigProp("nodeRadiusRatio",.25,{scope:t.PUBLIC}),this.addFloatConfigProp("connectorRadiusRatio",.25,{scope:t.PUBLIC}),this.addFloatConfigProp("multiConnectorRadiusRatio",.5),this.addFloatConfigProp("multiConnectorMarginRatio",1)}}),Kekule.Render.Length3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Length3DConfigs",initProperties:function(){this.addFloatConfigProp("unitLength",1,{scope:t.PUBLIC}),this.addFloatConfigProp("fixedNodeRadius",1.7),this.addFloatConfigProp("connectorRadius",.6),this.addFloatConfigProp("connectorLineWidth",2),this.addFloatConfigProp("defBondLength",100,{scope:t.PUBLIC})},getActualLength:function(e){var t=this.getPropValue(e);return null!=t?t*this.getUnitLength():null}})}(),function(){var e=Kekule.Render.RichText,t=Kekule.Render.RichTextUtils,r=Kekule.Render.TextDirection,n=Kekule.Render.TextDrawUtils,o=Kekule.Render.TextAlign;Kekule.Render.AbstractTextDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.AbstractTextDrawBridge",drawText:function(e,t,r,n){return null},canMeasureText:function(e){return!1},measureText:function(e,t,r){return{}},canMeasureDrawnText:function(e){return!1},measureDrawnText:function(e,t,r){return{}},canModifyText:function(e){return!1},modifyDrawnTextCoord:function(e,t,r){},createGroup:function(e){},addToGroup:function(e,t){},removeFromGroup:function(e,t){}}),Kekule.Render.BaseRichTextDrawer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.BaseRichTextDrawer",ITEM_PARENT_FIELD:"__$parent__",initialize:function($super,e,t,r){$super(),this.options=t||{},e&&this.setDrawBridge(e),r&&this.setDrawConfigs(r)},initProperties:function(){this.defineProp("drawBridge",{dataType:"Kekule.Render.AbstractTextDrawBridge",serializable:!1}),this.defineProp("drawConfigs",{dataType:"Kekule.Render.Render2DConfigs",serializable:!1})},fillOptions:function(e){if(e){var t=e.getTextFontConfigs(),r=this.options;r.supFontSizeRatio=t.getSupFontSizeRatio(),r.subFontSizeRatio=t.getSubFontSizeRatio(),r.superscriptOverhang=t.getSuperscriptOverhang(),r.subscriptOversink=t.getSubscriptOversink(),r.textCharDirection=t.getTextCharDirection(),r.textLineDirection=t.getTextLineDirection(),r.textHorizontalAlign=t.getTextHorizontalAlign(),r.textVerticalAlign=t.getTextVerticalAlign(),r.textBoxXAlignment=t.getTextBoxXAlignment(),r.textBoxYAlignment=t.getTextBoxYAlignment(),r.textBoxAlignmentMode=t.getTextBoxAlignmentMode()}},cloneRichText:function(e){return Kekule.Render.RichTextUtils.clone(e)},_FONT_OPTION_FIELDS:["fontSize","fontFamily","fontWeight","fontStyle","color","overhang","oversink","opacity","zoom"],_DRAW_OPTIONS_FIELDS:["textType","charDirection","defaultCharDirection","fontSize","fontFamily","fontWeight","fontStyle","color","horizontalAlign","verticalAlign","zoom"],_fillLocalDrawOptions:function(e,t){for(var n=t||{},o=0,i=this._DRAW_OPTIONS_FIELDS.length;o<i;++o){var a=this._DRAW_OPTIONS_FIELDS[o],s=e[a];Kekule.ObjUtils.notUnset(s)&&(n[a]=s,0)}return Kekule.ObjUtils.isUnset(e.charDirection)?n.charDirection=r.DEFAULT:e.charDirection===r.INHERIT&&(n.charDirection=t.charDirection),n},RECT_INFO_FIELD:"__rectInfo__",ACTUAL_FONT_FIELD:"__drawFont__",RENDER_TEXT_FIELD:"__renderText__",RENDER_ELEM_FIELD:"__renderElem__",LOCAL_DRAW_OPTIONS_FIELD:"__drawOptions__",_setItemRectInfo:function(e,t,r){e[this.RECT_INFO_FIELD]={boundRect:Object.extend({},t),alignRect:Object.extend({},r)}},_getItemRectInfo:function(e){return e[this.RECT_INFO_FIELD]},_setActualFontInfo:function(e,t){e[this.ACTUAL_FONT_FIELD]=t},_getActualFontInfo:function(e){return e[this.ACTUAL_FONT_FIELD]},_setRenderText:function(e,t){e[this.RENDER_TEXT_FIELD]=t},_getRenderText:function(e){return e[this.RENDER_TEXT_FIELD]||e.text},_setRenderElem:function(e,t){e[this.RENDER_ELEM_FIELD]=t},_getRenderElem:function(e){return e[this.RENDER_ELEM_FIELD]},_itemHasNoAlignRect:function(e){return Kekule.ObjUtils.notUnset(e._noAlignRect)?!!e._noAlignRect:t.isSubscript(e)||t.isSuperscript(e)},drawEx:function(e,t,r,n,o){var i;n?(i=Object.create(this.options||{}),i=Object.extend(i,n)):i=this.options,i.defaultCharDirection||(i.defaultCharDirection=i.charDirection);var a=this.cloneRichText(r),s=this.getDrawBridge(),d={delayDrawing:s.canMeasureText(),adjustDrawing:s.canModifyText()};return this.doPrepare(e,t,a,i,d),{drawnObj:this.doRenderRichText(e,a,i,d),boundRect:this._getItemRectInfo(a).boundRect}},draw:function(e,t,r,n,o){return this.drawEx(e,t,r,n,o).drawnObj},doPrepare:function(e,t,r,n,o){var i=this.doPrepareItem(e,r,n,o),a=null;n.textBoxAlignmentMode===Kekule.Render.TextBoxAlignmentMode.ANCHOR&&(a=this.doGetRootAnchorItemAbsAlignRect(r));var s,d=this._getItemRectInfo(r);if(a){var l=this.doAlignRectToCoord(t,a,n.textBoxXAlignment,n.textBoxYAlignment);s={x:l.left-a.left,y:l.top-a.top}}else{var u=this.doAlignRectToCoord(t,d.alignRect,n.textBoxXAlignment,n.textBoxYAlignment);s={x:u.left-d.alignRect.left,y:u.top-d.alignRect.top}}var c=Kekule.RectUtils.shiftRect(d.alignRect,s.x,s.y),h=Kekule.RectUtils.shiftRect(d.boundRect,s.x,s.y);return this._setItemRectInfo(r,h,c),i},doAlignRectToCoord:function(e,t,r,n){var o=Kekule.Render.BoxXAlignment,i=Kekule.Render.BoxYAlignment,a=r===o.RIGHT?-1:r===o.CENTER?-.5:0,s=n===i.TOP?0:n===i.CENTER?-.5:-1,d=Object.extend({},t);return d.left=e.x+d.width*a,d.top=e.y+d.height*s,d},doGetRootAnchorItemAbsAlignRect:function(e){var t=e;if(t.anchorItem){for(var r=this._getItemRectInfo(t).alignRect,n={x:r.left,y:r.top};t.anchorItem;)t=t.anchorItem,r=this._getItemRectInfo(t).alignRect,n.x+=r.left,n.y+=r.top;return Kekule.RectUtils.createRect(n.x,n.y,r.width,r.height)}return null},doCalcActualDrawFontInfo:function(e,r){function n(e,t){if("string"==typeof e){var r=Kekule.StyleUtils.analysisUnitsValue(e);return r.value=Math.round(Math.max(r.value*t,1)),""+r.value+r.units}return e*t}for(var o={sizeScale:1},i=0,a=this._FONT_OPTION_FIELDS.length;i<a;++i){var s=this._FONT_OPTION_FIELDS[i];Kekule.ObjUtils.notUnset(r[s])&&(o[s]=r[s])}return Kekule.ObjUtils.notUnset(o.zoom)&&(o.fontSize=n(o.fontSize,o.zoom||1),o.zoom=null),t.isSuperscript(e)?(o.sizeScale=r.supFontSizeRatio,o.fontSize=n(o.fontSize,r.supFontSizeRatio),o.isSup=!0,Kekule.ObjUtils.isUnset(o.overhang)&&(o.overhang=r.superscriptOverhang||0)):t.isSubscript(e)&&(o.sizeScale=r.subFontSizeRatio,o.fontSize=n(o.fontSize,r.subFontSizeRatio),o.isSub=!0,Kekule.ObjUtils.isUnset(o.oversink)&&(o.oversink=r.subscriptOversink||0)),o},doPrepareItem:function(n,o,i,a){var s,d=t.getItemType(o),l=Object.create(i);switch(((l=this._fillLocalDrawOptions(o,l)).charDirection===r.DEFAULT||Kekule.ObjUtils.isUnset(l.charDirection))&&(l.charDirection=l.defaultCharDirection),d){case e.SECTION:s=this.doPrepareSection(n,o,l,a);break;case e.LINES:s=this.doPrepareLines(n,o,l,a);break;default:s=this.doPrepareGroup(n,o,l,a)}return s},doPrepareSection:function(e,o,i,a){var s=this.getDrawBridge(),d=this.doCalcActualDrawFontInfo(o,i);this._setActualFontInfo(o,d);var l,u=o.text;if(n.isVerticalLine(i.charDirection)&&u.length>1){var c=o;c.role="group",delete c.text,c.charDirection=i.charDirection;var h=Object.create(i);h=Object.extend(h,d),c.items=[];for(var g=0,f=u.length;g<f;++g)t.appendText(c,u.charAt(g));return this.doPrepareItem(e,c,h,a)}if(i.charDirection===r.RTL&&(u=u.reverse()),this._setRenderText(o,u),a.delayDrawing)l=s.measureText(e,u,d);else{var C=this.getDrawBridge().drawText(e,{x:-1e4,y:-1e4},u,d);this._setRenderElem(o,C),l=s.measureDrawnText(e,C,d)}var R={left:0,top:0,width:l.width||0,height:l.height||0};this._setItemRectInfo(o,R,R)},doPrepareLines:function(e,t,n,o){for(var i=n.charDirection||r.DEFAULT,a=t.items,s=i===r.TTB?r.RTL:i===r.BTT?r.LTR:r.TTB,d=0,l=a.length;d<l;++d){var u=a[d];u.charDirection||(u.charDirection=i)}return t.charDirection=s,n.charDirection=s,n._originCharDirection=i,this.doPrepareGroup(e,t,n,o)},doPrepareGroup:function(e,i,a,s){for(var d=0,l=(M=i.items).length;d<l;++d){var u=M[d];this.doPrepareItem(e,u,a,s)}var c,h=a.charDirection||r.DEFAULT,g=a._originCharDirection||h,f=n.isHorizontalLine(h),C=f?"x":"y",R=f?"y":"x",p=o.getAbsAlign(a.horizontalAlign,g),D=o.getAbsAlign(a.verticalAlign,g);c=f?D==o.TOP?0:D==o.CENTER?-.5:-1:p==o.RIGHT?-1:p==o.CENTER?-.5:0;var x={x:0,y:0},m=h===r.RTL||h===r.BTT?-1:1,T=f?"left":"top",O=f?"top":"left",y=[];for(d=0,l=M.length;d<l;++d){u=M[d];var E=(w=this._getItemRectInfo(u)).boundRect,k=w.alignRect;if(m>0){var v=x[C]-E[T];E[T]=x[C],k[T]+=v}var S={x:E.width,y:E.height};if(x[C]+=S[C]*m,m<0){v=x[C]-E[T];E[T]=x[C],k[T]+=v}S={x:k.width,y:k.height};if(!!(K=this._getActualFontInfo(u))&&(K.isSup||K.isSub)&&t.getActualRefItem(u,i))y.push(u);else{var b=K?K.oversink||-(K.overhang||0):0;f||(b=-b);var A=S[R]*(c+b),_=k[O]-A;k[O]=A,E[O]-=_}}for(d=0,l=y.length;d<l;++d){u=y[d];var L=t.getActualRefItem(u,i),K=this._getActualFontInfo(u),w=this._getItemRectInfo(u),I=this._getItemRectInfo(L).alignRect;E=w.boundRect,k=w.alignRect;if(K.isSup){var B=K.overhang;f?(k.top=I.top,k.height=I.height,E.top=I.top-I.height*B):(k.left=I.left,k.width=I.width,E.left=I.lefy+I.width-E.left+I.width*B)}else{b=K.oversink;f?(k.top=I.top,k.height=I.height,E.top=I.top+I.height-E.height+I.height*b):(k.left=I.left,k.width=I.width,E.left=I.left-I.width*b)}}var M,U=null,P=null;for(d=0,l=(M=i.items).length;d<l;++d){u=M[d];w=this._getItemRectInfo(u),this._itemHasNoAlignRect(u)&&(U||d!=l-1)||(U=U?Kekule.RectUtils.getContainerRect(U,w.alignRect):Object.extend({},w.alignRect)),P=P?Kekule.RectUtils.getContainerRect(P,w.boundRect):Object.extend({},w.boundRect)}if(M.length<=0&&(U=Kekule.RectUtils.createRect(0,0,0,0),P=Kekule.RectUtils.createRect(0,0,0,0)),0!==(_={x:-U.left,y:-U.top}).x||0!==_.y){for(d=0,l=M.length;d<l;++d)(w=this._getItemRectInfo(M[d])).alignRect=Kekule.RectUtils.shiftRect(w.alignRect,_.x,_.y),w.boundRect=Kekule.RectUtils.shiftRect(w.boundRect,_.x,_.y);U.left=0,U.top=0,P.left+=_.x,P.top+=_.y}this._setItemRectInfo(i,P,U)},doRenderRichText:function(e,t,r,n){var o=this.getDrawBridge().createGroup(e);return this.doRenderItem(e,{x:0,y:0},t,n,o),o},doRenderItem:function(r,n,o,i,a){var s;switch(t.getItemType(o)){case e.SECTION:s=this.doRenderSection(r,n,o,i,a);break;default:s=this.doRenderGroup(r,n,o,i,a)}return s},doRenderGroup:function(e,t,r,n,o){var i=r.items;if(i.length<=0)return null;for(var a=this._getItemRectInfo(r),s={x:t.x+a.alignRect.left,y:t.y+a.alignRect.top},d=0,l=i.length;d<l;++d)this.doRenderItem(e,s,i[d],n,o)},doRenderSection:function(e,t,r,n,o){var i=this._getItemRectInfo(r).boundRect,a={x:i.left,y:i.top};a=Kekule.CoordUtils.add(a,t);var s,d=this._getRenderText(r),l=this._getActualFontInfo(r),u=this.getDrawBridge();n.delayDrawing?s=u.drawText(e,a,d,l):n.adjustDrawing&&(s=this._getRenderElem(r),u.modifyDrawnTextCoord(e,s,a)),u.addToGroup(s,o)}})}(),Kekule.Render.BoundInfoRecorder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.BoundInfoRecorder",initialize:function($super,e){$super(),this.setPropStoreFieldValue("boundInfos",new Kekule.TwoTupleMapEx(!0)),this._renderer=e,e&&e.setBoundInfoRecorder&&e.setBoundInfoRecorder(this),this.installEventListener(e)},finalize:function($super){this._renderer&&this.uninstallEventListener(this._renderer);var e=this.getPropStoreFieldValue("boundInfos");e&&e.clear(),$super()},initProperties:function(){this.defineProp("boundInfos",{dataType:"Kekule.TwoTupleMapEx",serializable:!1,setter:null}),this.defineProp("targetContext",{dataType:DataType.OBJECT,serializable:!1})},needRecordOnContext:function(e){var t=this.getTargetContext();return!t||t===e},installEventListener:function(e){e.addEventListener("updateBasicDrawObject",this._reactRendererUpdateBasicDrawObject,this),e.addEventListener("clear",this._reactRendererClear,this)},uninstallEventListener:function(e){e.removeEventListener("updateBasicDrawObject",this._reactRendererUpdateBasicDrawObject,this),e.removeEventListener("clear",this._reactRendererClear,this)},_reactRendererUpdateBasicDrawObject:function(e){var t=Kekule.Render.ObjectUpdateType;if(this.needRecordOnContext(e.context)){var r=e.updateType;r===t.ADD?this.add(e.context,e.obj,e.parentObj,e.boundInfo,e.target):r===t.MODIFY?this.modify(e.context,e.obj,e.parentObj,e.boundInfo,e.target):r===t.REMOVE?this.remove(e.context,e.obj):r===t.CLEAR&&this.clear(e.context),this.invokeEvent("updateBasicDrawObject",e)}},_reactRendererClear:function(e){this.needRecordOnContext(e.context)&&this.clearOnRenderer(e.context,e.target);this.getAllRecordedInfoOfContext(e.context)},getInfo:function(e,t){return this.getBoundInfos().get(e,t)},getBelongedInfos:function(e,t){if(a=this.getInfo(e,t))return[a];for(var r=[],n=this.getAllRecordedInfoOfContext(e),o=0,i=n.length;o<i;++o){var a;(a=n[o]).obj.isChildOf(t)&&r.push(a)}return r},getBound:function(e,t){var r=(l=this.getInfo(e,t))?l.boundInfo:null;if(!r){for(var n=Kekule.BoxUtils,o=Kekule.Render.MetaShapeUtils,i=this.getBelongedInfos(e,t),a=null,s=0,d=i.length;s<d;++s){var l=i[s],u=o.getContainerBox(l.boundInfo,0);a=a?n.getContainerBox(a,u):u}a&&(r=o.createShapeInfo(Kekule.Render.MetaShapeType.RECT,[{x:a.x1,y:a.y1},{x:a.x2,y:a.y2}]))}return r},clearOnRenderer:function(e,t){var r=(o=this.getBoundInfos()).getSecondLevelMap(e);if(r)for(var n=r.getKeys(),o=r.getValues(),i=n.length-1;i>=0;--i){var a=n[i];o[i].renderer===t&&r.remove(a)}},clear:function(e){var t=this.getBoundInfos().getSecondLevelMap(e);return t&&t.clear(),this},clearAll:function(){return this.getBoundInfos().clear(),this},add:function(e,t,r,n,o){return this.getBoundInfos().set(e,t,{obj:t,parentObj:r,boundInfo:n,renderer:o}),this},modify:function(e,t,r,n,o){var i=this.getBoundInfos().get(e,t);i||(i={},this.getBoundInfos.set(e,t,i));var a=Kekule.ObjUtils.notUnset;return a(r)&&(i.parentObj=r),a(n)&&(i.boundInfo=n),a(o)&&(i.renderer=o),this},remove:function(e,t,r){return this.getBoundInfos().remove(e,t),this},getAllRecordedInfoOfContext:function(e){var t=this.getBoundInfos().getSecondLevelMap(e);return t?t.getValues():[]},getAllBoundInfosOfContext:function(e){for(var t=this.getAllRecordedInfoOfContext(e),r=[],n=0,o=t.length;n<o;++n){var i=t[n].boundInfo;i&&r.push(i)}return r},getContainerBox:function(e){for(var t=Kekule.BoxUtils,r=Kekule.Render.MetaShapeUtils,n=null,o=this.getAllBoundInfosOfContext(e),i=0,a=o.length;i<a;++i){var s=r.getContainerBox(o[i],0);n=t.getContainerBox(n,s)}return n},getIntersectionInfos:function(e,t,r,n,o){for(var i=[],a=this.getAllRecordedInfoOfContext(e),s=0,d=a.length;s<d;++s){var l=a[s].boundInfo;o&&!o(a[s])||l&&Kekule.Render.MetaShapeUtils.isCoordInside(t,l,n)&&i.push(a[s])}return i}}),function(){var e=Kekule.Render.BondRenderType,t=Kekule.Render.TextDirection,r=Kekule.BoxUtils,n=Kekule.BondOrder,o=Kekule.CoordUtils,i=Kekule.oneOf;Kekule.Render.Abstract2DDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.Abstract2DDrawBridge",createContext:function(e,t,r){return null},releaseContext:function(e){},getContextDimension:function(e){return{}},setContextDimension:function(e,t,r){return null},getContextElem:function(e){},setContextViewBox:function(e,t,r,n,o,i){},clearContext:function(e){return null},setClearColor:function(e,t){},transformContextCoordToScreen:function(e,t){return t},transformScreenCoordToContext:function(e,t){return t},canModifyGraphic:function(e){return!1},drawPath:function(e,t,r){},drawLine:function(e,t,r,n){},drawTriangle:function(e,t,r,n,o){},drawRect:function(e,t,r,n){},drawRoundRect:function(e,t,r,n,o){},drawCircle:function(e,t,r,n){},drawArc:function(e,t,r,n,o,i,a){},drawImage:function(e,t,r,n,o,i){},drawImageElem:function(e,t,r,n,o){},createGroup:function(e){return null},addToGroup:function(e,t){},removeFromGroup:function(e,t){},removeDrawnElem:function(e,t){},exportToDataUri:function(e,t,r){}}),Kekule.Render.Base2DRenderer=Class.create(Kekule.Render.CompositeRenderer,{CLASS_NAME:"Kekule.Render.Base2DRenderer",initialize:function($super,e,t,r){$super(e,t,r),this.__$redirectContextDebug__=!1,this._richTextDrawer=null},initProperties:function(){this.defineProp("richTextDrawerClass",{dataType:DataType.CLASS,serializable:!1})},getActualTargetContext:function(e){return this.getRedirectContext()||e},getRendererType:function(){return Kekule.Render.RendererType.R2D},canMeasureText:function(e){return this.getDrawBridge().canMeasureText(e)},getAutoScaleRefDrawLength:function(e){return e.defBondLength},getAutoScaleRefObjLength:function(e,t){var r=e||this.getChemObj();if(!r.getAllAutoScaleRefLengths)return null;var n=r.getAllAutoScaleRefLengths(Kekule.CoordMode.COORD2D,t);return n&&n.length?Kekule.ArrayUtils.getMedian(n):void 0},getRichTextDrawer:function(){if(!this._richTextDrawer){var e=this.getRichTextDrawerClass()||Kekule.Render.BaseRichTextDrawer;this._richTextDrawer=new e(this.getDrawBridge())}return this._richTextDrawer},drawPath:function(e,t,r){return this.getDrawBridge().drawPath(this.getActualTargetContext(e),t,r)},drawLine:function(e,t,r,n){if(this.__$redirectContextDebug__){var o=Object.create(n);return this.getRedirectContext()&&(o.color=o.strokeColor="#ff0000"),this.getDrawBridge().drawLine(this.getActualTargetContext(e),t,r,o)}return this.getDrawBridge().drawLine(this.getActualTargetContext(e),t,r,n)},drawArrowLine:function(e,t,r,n,o){var i=this.getActualTargetContext(e);if(n){var a=this.createDrawGroup(i),s=this.drawLine(i,t,r,o);this.addToDrawGroup(s,a);var d=r.x-t.x,l=r.y-t.y,u=Math.atan(l/d),c=Math.sign(d)||1,h=(n.width||6)/2,g=n.length||3,f=Math.atan(h/g),C=Math.sqrt(Math.sqr(h)+Math.sqr(g))*c,R=Math.cos(u-f)*C,p=Math.sin(u-f)*C,D=Math.cos(u+f)*C,x=Math.sin(u+f)*C;return s=this.drawLine(i,r,{x:r.x-R,y:r.y-p},o),this.addToDrawGroup(s,a),s=this.drawLine(i,r,{x:r.x-D,y:r.y-x},o),this.addToDrawGroup(s,a),a}return this.drawLine(i,t,r,o)},drawTriangle:function(e,t,r,n,o){return this.getDrawBridge().drawTriangle(this.getActualTargetContext(e),t,r,n,o)},drawRect:function(e,t,r,n){var o={x:Math.min(t.x,r.x),y:Math.min(t.y,r.y)},i={x:Math.max(t.x,r.x),y:Math.max(t.y,r.y)};return this.getDrawBridge().drawRect(this.getActualTargetContext(e),o,i,n)},drawRoundRect:function(e,t,r,n,o){var i={x:Math.min(t.x,r.x),y:Math.min(t.y,r.y)},a={x:Math.max(t.x,r.x),y:Math.max(t.y,r.y)};return this.getDrawBridge().drawRoundRect(this.getActualTargetContext(e),i,a,n,o)},drawCircle:function(e,t,r,n){return this.getDrawBridge().drawCircle(this.getActualTargetContext(e),t,r,n)},drawArc:function(e,t,r,n,o,i,a){return this.getDrawBridge().drawArc(this.getActualTargetContext(e),t,r,n,o,i,a)},drawText:function(e,t,r,n){var o=this.getRichTextDrawer(),i=Kekule.Render.RichTextUtils.strToRichText(r,n);if(this.__$redirectContextDebug__){var a=Object.create(n||{});return this.getRedirectContext()&&(a.color=a.strokeColor="#ff0000"),o.drawEx(this.getActualTargetContext(e),t,i,a)}return o.drawEx(this.getActualTargetContext(e),t,i,n)},drawRichText:function(e,t,r,n){var o=this.getRichTextDrawer();if(this.__$redirectContextDebug__){var i=Object.create(n||{});return this.getRedirectContext()&&(i.color=i.strokeColor="#ff0000"),o.drawEx(this.getActualTargetContext(e),t,r,i)}return o.drawEx(this.getActualTargetContext(e),t,r,n)},drawImage:function(e,t,r,n,o,i){var a=this;return this.getDrawBridge().drawImage(this.getActualTargetContext(e),t,r,n,o,i,function(){return a.getActualTargetContext(e)})},drawImageElem:function(e,t,r,n,o){if(t.complete)return this.getDrawBridge().drawImageElem(this.getActualTargetContext(e),t,r,n,o);var i=Kekule.X.Event;if(i){var a=this,s=function(){i.removeListener(t,"load",d)},d=function(){s(),a.update(a.getActualTargetContext(e),[{obj:a.getChemObj()}],Kekule.Render.ObjectUpdateType.MODIFY)};i.addListener(t,"load",d),i.addListener(t,"error",s)}},createDrawGroup:function(e){return this.getDrawBridge().createGroup(this.getActualTargetContext(e))},addToDrawGroup:function(e,t){return this.getDrawBridge().addToGroup(e,t)},removeFromDrawGroup:function(e,t){return this.getDrawBridge().removeFromGroup(e,t)},removeDrawnElem:function(e,t){return this.getDrawBridge().removeDrawnElem(this.getActualTargetContext(e),t)},transformScreenCoordToContext:function(e,t){return this.doTransformScreenCoordToContext(this.getActualTargetContext(e),t)},doTransformScreenCoordToContext:function(e,t){var r=this.getDrawBridge();return r&&r.transformScreenCoordToContext?r.transformScreenCoordToContext(this.getActualTargetContext(e),t):t}}),Kekule.Render.ChemObj2DRenderer=Class.create(Kekule.Render.Base2DRenderer,{CLASS_NAME:"Kekule.Render.ChemObj2DRenderer",_getRenderSortIndex:function($super){var e=this.getChemObj();return e&&e.coordStickTarget&&e.getCoordStickTarget()?1:$super()},doEstimateSelfObjBox:function(e,t,r){return Kekule.Render.ObjUtils.getContainerBox(this.getChemObj(),this.getCoordMode(),r)},doEstimateRenderBox:function(e,t,n,o){var i=this.estimateObjBox(e,n,o);if(i){var a=this.prepareTransformParams(e,t,n,i);return r.transform2D(i,a)}return null},doGetAutoBaseCoord:function(e){var t=e.transformParams;if(t){var r=this.getChemObj(),n=r.getAbsBaseCoord?r.getAbsBaseCoord(Kekule.CoordMode.COORD2D):r.getAbsBaseCoord2D?r.getAbsBaseCoord2D():null;if(n)return Kekule.CoordUtils.transform2D(n,t)}return null},doDraw:function($super,e,t,r){var n=this.getAutoScaleRefObjLength(this.getChemObj(),r.allowCoordBorrow);return r.medianObjRefLength=n||r.defScaleRefLength,this.prepareTransformParams(e,t,r),this.prepareGeneralOptions(e,r),$super(e,t,r)},prepareGeneralOptions:function(e,t){},prepareTransformParams:function(e,t,r,n){var o;if(r.transformParams)o=r.transformParams;else{var i=this.generateTransformParams(e,t,r,n);r.transformParams=i,o=i}var a=Kekule.CoordUtils.calcTransform2DMatrix(o),s=Kekule.CoordUtils.calcInverseTransform2DMatrix(o);return r.transformParams.transformMatrix=a,r.transformParams.invTransformMtrix=s,this.getRenderCache(e).transformParams=o,this.getRenderCache(e).transformMatrix=a,this.getRenderCache(e).invTransformMatrix=s,o},calcPreferedTransformOptions:function(e,t,r,n){var o={};o.allowCoordBorrow=i(r.allowCoordBorrow,!1),o.unitLength=r.unitLength||1,n||(n=this.estimateObjBox(e,r,o.allowCoordBorrow)),n||(n={x1:0,x2:1,y1:0,y2:1});var a={x:(n.x1+n.x2)/2,y:(n.y1+n.y2)/2},s=Kekule.ObjUtils;if(s.isUnset(r.translateX)&&s.isUnset(r.translateY)?t&&(o.translateX=t.x-a.x,o.translateY=t.y-a.y):(o.translateX=r.translateX||0,o.translateY=r.translateY||0),o.zoom=r.zoom||1,r.scale||r.scaleX||r.scaleY)o.scaleX=i(r.scaleX,r.scale,1),o.scaleY=i(r.scaleY,r.scale,1);else if(r.autofit){var d=this.getDrawBridge().getContextDimension(e);d.x=d.width,d.y=d.height,(d=this.getDrawBridge().transformScreenCoordToContext(e,d)).width=d.x,d.height=d.y;var l=r.autofitContextPadding;l*=2*o.unitLength,n.width=n.x2-n.x1,n.height=n.y2-n.y1;var u=Math.max(d.width-l,0)/(n.width||1),c=Math.max(d.height-l,0)/(n.height||1);s.isUnset(r.retainAspect)||r.retainAspect?o.scaleX=o.scaleY=Math.min(u,c):(o.scaleX=u,o.scaleY=c)}else{var h=i(r.refDrawLength,this.getAutoScaleRefDrawLength(r))||1,g=r.medianObjRefLength;Kekule.ObjUtils.isUnset(g)&&(g=r.defScaleRefLength),o.scaleX=o.scaleY=h/g||1}return s.notUnset(r.rotateAngle)&&(o.rotateAngle=r.rotateAngle),s.isUnset(r.center)?o.center=a:o.center=r.center,o.drawBaseCoord=t||Kekule.CoordUtils.transform2D(a,o),o},generateTransformParams:function(e,t,r,n){var o=this.calcPreferedTransformOptions(e,t,r,n),i=Object.extend({},o);return(o=this.getFinalTransformParams(e,o)).initialTransformOptions=i,o},getFinalTransformParams:function(e,t){var r=Object.create(t);return r.zoom&&(r.scaleX*=r.zoom,r.scaleY*=r.zoom),r.scaleY=-r.scaleY,r.unitLength&&(r.translateX*=r.unitLength,r.translateY*=r.unitLength,r.drawBaseCoord.x*=r.unitLength,r.drawBaseCoord.y*=r.unitLength),r},getRenderFinalTransformParams:function(e){return this.getRenderCache(e).transformParams},getRenderInitialTransformOptions:function(e){var t=this.getRenderFinalTransformParams(e);return t?t.initialTransformOptions:null},doTransformCoordToObj:function(e,t,r){var n=this.getRenderCache(e).invTransformMatrix;return Kekule.CoordUtils.transform2DByMatrix(r,n)},doTransformCoordToContext:function(e,t,r){var n=this.getRenderCache(e).transformMatrix;return Kekule.CoordUtils.transform2DByMatrix(r,n)}}),Kekule.Render.RichTextBased2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.RichTextBased2DRenderer",DRAWN_OBJ_FIELD:"__$drawnObj__",initialize:function($super,e,t,r){$super(e,t,r),this.__$alwaysRecalcSize__=!1,this.__$isRecalculatingSize=!1},getDrawnObj:function(e){return this.getExtraProp(e,this.DRAWN_OBJ_FIELD)},setDrawnObj:function(e,t){this.setExtraProp(e,this.DRAWN_OBJ_FIELD,t)},getRichText:function(e,t){return null},extractRichTextDrawOptions:function(e){var t=Object.create(e||{});return t.horizontalAlign=i(t.horizontalAlign,t.textHorizontalAlign),t.verticalAlign=i(t.verticalAlign,t.textVerticalAlign),t.charDirection=i(t.charDirection,t.textCharDirection),t},getDrawTextCoord:function(e,t){return t},doDrawSelf:function($super,e,t,r){$super(e,t,r);var n=this.getChemObj(),o=(r.transformParams,this.getRichText(this.getChemObj(),r));if(!o)return null;t||(t=this.getAutoBaseCoord(r));var i=this.getDrawTextCoord(e,t),a=this.drawRichText(e,i,o,this.extractRichTextDrawOptions(r)),s=a.boundRect,d=this.createRectBoundInfo({x:s.left,y:s.top},{x:s.left+s.width,y:s.top+s.height});return this.basicDrawObjectUpdated(e,n,n,d,Kekule.Render.ObjectUpdateType.ADD),this.getRenderCache(e).drawnObj=a.drawnObj,this.setDrawnObj(e,a.drawnObj),(this.getCanModifyTargetObj()&&n.getNeedRecalcSize&&n.getNeedRecalcSize()||this.__$alwaysRecalcSize__)&&this._autosetObjSize(e,n,d),a.drawnObj},_autosetObjSize:function(e,t,r){if(!this.__$isRecalculatingSize&&t.hasProperty("size2D")&&t.setNeedRecalcSize){this.__$isRecalculatingSize=!0;try{var n=r.coords,o=this.transformCoordToObj(e,t,n[0]),i=this.transformCoordToObj(e,t,n[1]),a=Kekule.CoordUtils.substract(i,o);t.setPropStoreFieldValue("size2D",{x:Math.abs(a.x),y:Math.abs(a.y)}),t.setNeedRecalcSize(!1)}finally{this.__$isRecalculatingSize=!1}}}}),Kekule.Render.TextBlock2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.TextBlock2DRenderer",getRichText:function(e,t){return Kekule.Render.RichTextUtils.strToRichText(e.getText())},doEstimateSelfObjBox:function(e,t,r){return this.getChemObj().getBox2D(r)},getDrawTextCoord:function(e,t){var r=this.getChemObj(),n=r.getExposedContainerBox(),o={x:n.x1,y:n.y2},i={x:n.x2,y:n.y1},a=this.transformCoordToContext(e,r,o),s=this.transformCoordToContext(e,r,i),d=Kekule.CoordUtils.substract(s,a);return{x:t.x-d.x/2,y:t.y-d.y/2}},extractRichTextDrawOptions:function($super,e){var t=$super(e);return t.fontSize=i(t.fontSize,t.labelFontSize),t.fontFamily=i(t.fontFamily,t.labelFontFamily),t.color=i(t.color,t.labelColor),t.textBoxXAlignment=Kekule.Render.BoxXAlignment.LEFT,t.textBoxYAlignment=Kekule.Render.BoxYAlignment.TOP,t}}),Kekule.Render.Formula2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.Formula2DRenderer",basicDrawObjectUpdated:function($super,e,t,r,n,o){return t===this.getChemObj()?$super(e,t.getParent(),t.getParent(),n,o):$super(e,t,r,n,o)},getRichText:function(e,t){return e.getDisplayRichText(!0,t.displayLabelConfigs,t.partialChargeDecimalsLength,t.chargeMarkType)},doEstimateSelfObjBox:function(e,t,n){var o=this.getChemObj()?this.getChemObj().getParent():null;if(o){var i=o?o.getAbsBaseCoord2D(n):{x:0,y:0};return r.createBox(i,i)}return null},extractRichTextDrawOptions:function($super,e){var t=$super(e);return t.fontSize=i(t.fontSize,t.atomFontSize),t.fontFamily=i(t.fontFamily,t.atomFontFamily),t.color=i(t.color,t.labelColor,t.atomColor),t.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER,t.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER,t}}),Kekule.Render.TextBasedChemMarker2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.TextBasedChemMarker2DRenderer",initialize:function($super,e,t,r){$super(e,t,r)},doDrawSelf:function($super,e,t,r){return $super(e,t,r)},getRichText:function(e,t){var r,n=this.getChemObj();if(n instanceof Kekule.ChemMarker.Charge){var o=n.getValue();if(r=Kekule.Render.ChemDisplayTextUtils.getChargeDisplayText(o,t.partialChargeDecimalsLength,t.chargeMarkType))return Kekule.Render.RichTextUtils.createSection(r,{charDirection:Kekule.Render.TextDirection.LTR})}else if(n instanceof Kekule.ChemMarker.Radical){var i=n.getValue();if(r=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(i,t.distinguishSingletAndTripletRadical))return Kekule.Render.RichTextUtils.createSection(r,{charDirection:Kekule.Render.TextDirection.LTR})}return null},doEstimateSelfObjBox:function($super,e,t,r){return $super(e,t,r)},extractRichTextDrawOptions:function($super,e){var t=$super(e),r=this.getChemObj();return t.fontSize=i(r.getRenderOption("fontSize"),t.chemMarkerFontSize,t.fontSize,t.atomFontSize),t.fontFamily=i(t.fontFamily,t.atomFontFamily),t.color=i(t.color,t.atomColor,t.labelColor),t.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER,t.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER,t}}),Kekule.Render.ImageBlock2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.ImageBlock2DRenderer",initialize:function($super,e,t,r){$super(e,t,r)},doDrawSelf:function($super,e,t,r){$super(e,t,r);var n=this.getChemObj();r.transformParams;if(!n||!n.getSrc||!n.getSrc())return null;t||(t=this.getAutoBaseCoord(r));var o,i=n.getExposedContainerBox(),a={x:i.x1,y:i.y2},s={x:i.x2,y:i.y1},d=this.transformCoordToContext(e,n,a),l=this.transformCoordToContext(e,n,s),u=Kekule.CoordUtils.substract(l,d),c={x:t.x-u.x/2,y:t.y-u.y/2},h=n.getCacheImg();return o=h?this.drawImageElem(e,h,c,u,r):this.drawImage(e,n.getSrc(),c,u,r),this.basicDrawObjectUpdated(e,n,n,this.createRectBoundInfo(c,Kekule.CoordUtils.add(c,u)),Kekule.Render.ObjectUpdateType.ADD),o}}),Kekule.Render.UnbondedElectronSetRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.UnbondedElectronSetRenderer",_extractActualDrawOptions:function(e){var t=Object.create(e),r=this.getChemObj();return t.fontSize=i(r.getRenderOption("fontSize"),t.chargeMarkFontSize,t.fontSize,t.atomFontSize),t.color=i(t.color,t.atomColor,t.labelColor),t.strokeColor=t.color,t.fillColor=t.color,t.electronGap=t.fontSize/3*(t.unitLength||1)*(t.zoom||1),t.electronRadius=t.fontSize/12*(t.unitLength||1)*(t.zoom||1),t},_drawSingleElectron:function(e,t,r,n){return this.drawCircle(e,t,r,n)},_drawElectrons:function(e,t,r,n,i){var a=o.substract(r,n),s=o.getDistance(a);if(0===s)var d=0,l=1;else d=a.x/s,l=a.y/s;for(var u,c,h=i.electronGap,g=i.electronRadius,f={x:h*l,y:-h*d},C=(t-1)/2,R=o.substract(r,o.multiply(f,C)),p=[],D=t>1?this.createDrawGroup(e):null,x=0;x<t;++x)p.push(R),u=this._drawSingleElectron(e,R,g,i),D&&this.addToDrawGroup(u,D),R=o.add(R,f);if(p.length<=1)c=this.createCircleBoundInfo(p[0],g);else{var m=o.multiply(f,2*g/h),T=o.substract(p[0],m),O=o.add(p[t-1],m);c=this.createLineBoundInfo(T,O,g)}return{electronCoords:p,drawnElem:D||u,electronRadius:g,boundInfo:c}},_doGetParentCoord:function(e,t,r){var n=r.transformParams;if(n){var i=t,a=i.getAbsBaseCoord?i.getAbsBaseCoord(Kekule.CoordMode.COORD2D):i.getAbsBaseCoord2D?i.getAbsBaseCoord2D():null;if(a)return o.transform2D(a,n)}return null},doDrawSelf:function($super,e,t,r){$super(e,t,r);var n=this._extractActualDrawOptions(r),o=this.getChemObj(),i=o.getParent();r.transformParams;if(!o||!i||!o.getElectronCount||(o.getElectronCount()||0)<=0)return null;t||(t=this.getAutoBaseCoord(r));var a=this._doGetParentCoord(e,i,r);if(!t||!a)return null;var s=this._drawElectrons(e,o.getElectronCount(),t,a,n);s.electronCoords,s.electronRadius;return this.basicDrawObjectUpdated(e,o,i,s.boundInfo,Kekule.Render.ObjectUpdateType.ADD),s.drawnElem}}),Kekule.Render.Ctab2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.Ctab2DRenderer",DRAW_ELEM_FIELD:"__$drawElem__",TRANSFORM_COORD_FIELD:"__$transCoord2D__",TRANSFORM_MATRIX_FIELD:"__$transMatrix__",RENDERED_OBJS_FIELD:"__$renderedObjs__",INV_TRANSFORM_MATRIX_FIELD:"__$inverseTransMatrix__",CHILD_TRANSFORM_MATRIX_FIELD:"__$childTransMatrix__",_getRenderSortIndex:function($super){for(var e=this.getChemObj().getExposedNodes(),t=0,r=e.length;t<r;++t){var n=e[t];if(n&&n.coordStickTarget&&n.getCoordStickTarget())return 1}return $super()},doEstimateSelfObjBox:function(e,t,r){return this.getChemObj().getExposedContainerBox2D(r)},getObjDrawElem:function(e,t){return this.getExtraProp2(e,t,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(e,t,r){this.setExtraProp2(e,t,this.DRAW_ELEM_FIELD,r)},getRenderedObjs:function(e){return this.getExtraProp(e,this.RENDERED_OBJS_FIELD)},addRenderedObj:function(e,t){var r=this.getRenderedObjs(e);r?Kekule.ArrayUtils.pushUnique(r,t):(r=[t],this.setExtraProp(e,this.RENDERED_OBJS_FIELD,r))},removeRenderedObj:function(e,t){var r=this.getRenderedObjs(e);r&&Kekule.ArrayUtils.remove(r,t)},clearRenderedObj:function(e){this.setExtraProp(e,this.RENDERED_OBJS_FIELD,null)},prepareGeneralOptions:function($super,e,t){return $super(e,t)},doPrepare:function($super,e,t,r,n){$super(e,t,r,n),this.doPrepareLayout(e,t,r,n)},doPrepareLayout:function(e,t,r,n){},handleNodeSpecifiedRenderOptions:function(e,t){var r=(e.getOverriddenRenderOptions?e.getOverriddenRenderOptions():null)||{},n=Object.create(t);return n=Object.extend(n,r)},handleConnectorSpecifiedRenderOptions:function($super,e,t){var r=(e.getOverriddenRenderOptions?e.getOverriddenRenderOptions():null)||{},n=Object.create(t||null);return n=Object.extend(n,r)},isChemObjRenderedBySelf:function($super,e,t){var r=this.getRenderedObjs(e);return $super(e,t)||r&&r.indexOf(t)>=0||this.getChemObj().hasChildObj(t)&&(!t.isExposed||t.isExposed())},isChemObjRenderedDirectlyBySelf:function($super,e,t){var r=this.getRenderedObjs(e);return $super(e,t)||r&&r.indexOf(t)>=0},doDrawSelf:function($super,e,t,r){$super(e,t,r);var n=this.getChemObj();this._ctab=n;var o=r.transformParams;return this.getRenderCache(e).transformOptions=o,this.transformCtabCoords2DToContext(e,n,o),this.doPrepare(e,n,t,r),this.getRenderCache(e).appliedOptions=r,this.doDrawCore(e,n,r,o)},doRedraw:function(e){var t=this.getRenderCache(e);return this.doDrawCore(e,this.getChemObj(),t.appliedOptions,t.transformOptions)},doDrawCore:function(e,t,r,n){this.clearRenderedObj(e);var o=this.createDrawGroup(e);return this.doDrawConnectors(e,o,t,r,n),this.doDrawNodes(e,o,t,r,n),this.setObjDrawElem(e,t,o),o},doUpdateSelf:function($super,e,t,r){if(this.canModifyGraphic(e)){var n=!1,o=Kekule.Render.ObjectUpdateType;switch(r){case o.ADD:n=this.doAddNew(e,t);break;case o.MODIFY:n=this.doModify(e,t);break;case o.REMOVE:n=this.doRemove(e,Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(t));break;default:return $super(e,t,r)}return n}return $super(e,t,r)},doAddNew:function(e,t){return!!this.canModifyGraphic()&&this.doModify(e,t)},doModify:function(e,t){if(this.canModifyGraphic()){var r=this._extractObjsOfUpdateObjDetails(t);this.remove(e,r);var n=this.getChemObj(),o=this.getObjDrawElem(e,n),i=this.getRenderCache(e),a=i.appliedOptions;r.indexOf(n)>=0&&this.draw(e,i.baseCoord,a);for(var s=0,d=r.length;s<d;++s){var l=r[s];if(!l.isExposed||l.isExposed())if(n.hasConnector(l)){var u=this.handleConnectorSpecifiedRenderOptions(l,a);this.doDrawConnector(e,o,l,this.getChemObj(),u,i.transformParams||{})}else if(n.hasNode(l)){u=this.handleNodeSpecifiedRenderOptions(l,a);this.doDrawNode(e,o,l,this.getChemObj(),u,i.transformParams)}}return!0}return!1},doRemove:function(e,t){if(this.canModifyGraphic()){for(var r=Kekule.ArrayUtils.toArray(t),n=0,o=r.length;n<o;++n){var i=r[n],a=this.getObjDrawElem(e,i);if(a){var s=this.getObjDrawElem(e,this.getChemObj());this.removeFromDrawGroup(a,s),this.removeDrawnElem(e,a)}this.removeRenderedObj(e,i),this.removeExtraProp2(e,i),this.basicDrawObjectUpdated(e,i,this.getChemObj(),null,Kekule.Render.ObjectUpdateType.REMOVE)}return!0}return!1},getCoordTransformOptions:function(e){return this.getRenderCache(e).transformOptions},transformCtabCoords2DToContext:function(e,t,r){var n=r.allowCoordBorrow,o=Object.extend({},r);o.centerX=0,o.centerY=0;var i=r.transformMatrix;this.setExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD,i);var a=i;this.setExtraProp2(e,t,this.CHILD_TRANSFORM_MATRIX_FIELD,i);var s=r.invTransformMatrix;this.setExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD,s);for(var d=0,l=t.getNodeCount();d<l;++d){var u=t.getNodeAt(d);this.transformObjCoord2DToContext(e,u,i,a,n)}},transformObjCoord2DToContext:function(e,t,r,n,o){var i;if(t&&t.getAbsBaseCoord2D){var a=t.getAbsBaseCoord2D(o);if(a){var s=Kekule.CoordUtils.transform2DByMatrix(a,r);this.setTransformedCoord2D(e,t,s),i=s}if(t.getNodes)for(var d=0,l=t.getNodeCount();d<l;++d)this.transformObjCoord2DToContext(e,t.getNodeAt(d),n,n,o)}return i},getTransformedCoord2D:function(e,t,r){Kekule.ObjUtils.isUnset(r)&&(r=this.getRenderCache(e).options.transformParams.allowCoordBorrow);var n=t instanceof Kekule.BaseStructureNode,o=t.getParent(),i=n&&o&&o instanceof Kekule.BaseStructureConnector,a=n&&!i&&this.getExtraProp2(e,t,this.TRANSFORM_COORD_FIELD);if(!a){var s=this.getChemObj(),d=this.getExtraProp2(e,s,this.TRANSFORM_MATRIX_FIELD),l=this.getExtraProp2(e,s,this.CHILD_TRANSFORM_MATRIX_FIELD);a=s&&(s.hasNode(t,!1)||s.hasConnector(t,!1))?this.transformObjCoord2DToContext(e,t,d,l,r):this.transformObjCoord2DToContext(e,t,l,l,r)}return a},setTransformedCoord2D:function(e,t,r){this.setExtraProp2(e,t,this.TRANSFORM_COORD_FIELD,r)},doTransformCoordToObj:function($super,e,t,r){var n=this.getExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD);return n?Kekule.CoordUtils.transform2DByMatrix(r,n):$super(e,t,r)},doTransformCoordToContext:function($super,e,t,r){var n=this.getExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD);return n?Kekule.CoordUtils.transform2DByMatrix(r,n):$super(e,t,r)},doDrawNodes:function(e,t,r,n,o){for(var i=r.getExposedNodes(),a=0,s=i.length;a<s;++a){var d=i[a],l=this.handleNodeSpecifiedRenderOptions(d,n);this.doDrawNode(e,t,d,r,l,o)}},doDrawNode:function(e,t,r,n,o,i){},doDrawConnectors:function(e,t,r,n,o){for(var i=r.getExposedConnectors(),a=0,s=i.length;a<s;++a){var d=i[a],l=this.handleConnectorSpecifiedRenderOptions(d,n);this.doDrawConnector(e,t,d,r,l,o)}},doDrawConnector:function(e,t,r,n,o,i){var a,s,d,l,u=r.getConnectedExposedObjs(),c=u.length;if(c<2)return null;for(var h,g=c>2?this.createDrawGroup(e):null,f=c>2?[]:null,C=o,R=0;R<c;++R)if(s=u[R],this.getTransformedCoord2D(e,s,i.allowCoordBorrow))for(var p=R+1;p<c;++p)if(d=u[p],this.getTransformedCoord2D(e,d,i.allowCoordBorrow)&&(h=this.doDrawConnectorShape(e,r,[s,d],C,i))){(l=h.element)&&g&&this.addToDrawGroup(l,g);var D=h.boundInfo;f&&D&&f.push(D)}return(a=g||l)&&t&&this.addToDrawGroup(a,t),a?this.setObjDrawElem(e,r,a):this.setObjDrawElem(e,r,null),this.addRenderedObj(e,r),(D||f)&&this.basicDrawObjectUpdated(e,r,n,f||D,Kekule.Render.ObjectUpdateType.ADD),a},doDrawConnectorShape:function(e,t,r,n,o){}}),Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.Render.Ctab2DRenderer),Kekule.Render.ChemCtab2DRenderer=Class.create(Kekule.Render.Ctab2DRenderer,{CLASS_NAME:"Kekule.Render.ChemCtab2DRenderer",OBJ_NEED_LABEL_FIELD:"__$needDrawLabel__",OBJ_NEED_DOT_FIELD:"__$needDrawDot__",getObjNeedDrawLabel:function(e,t){var r=this.getExtraProp2(e,t,this.OBJ_NEED_LABEL_FIELD);if(Kekule.ObjUtils.isUnset(r)){var n=this.getRenderCache(e).appliedOptions;r=!(t instanceof Kekule.ChemStructureConnector)&&this._needNodeDrawLabel(t,n),this.setObjNeedDrawLabel(e,t,r)}return r},setObjNeedDrawLabel:function(e,t,r){this.setExtraProp2(e,t,this.OBJ_NEED_LABEL_FIELD,r)},getObjNeedDrawDot:function(e,t){var r=this.getRenderCache(e).appliedOptions;return!(t instanceof Kekule.ChemStructureConnector)&&this._needNodeDrawDot(e,t,r)},doPrepare:function($super,e,t,r,n){n.fontSize||(n.fontSize=n.atomFontSize),n.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER,n.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER,$super(e,t,r,n)},doPrepareLayout:function($super,e,t,r,n){$super(e,t,r,n);for(var o=t.getExposedNodes(),i=0,a=o.length;i<a;++i){var s=o[i],d=this._needNodeDrawLabel(s,n);this.setObjNeedDrawLabel(e,s,d)}},handleNodeSpecifiedRenderOptions:function($super,e,t){var r=$super(e,t);return!r.color&&r.atomColor&&(r.color=r.atomColor),!r.fontFamily&&r.atomFontFamily&&(r.fontFamily=r.atomFontFamily),!r.fontSize&&r.atomFontSize&&(r.fontSize=r.atomFontSize),r},handleConnectorSpecifiedRenderOptions:function($super,e,t){var r=$super(e,t);return!r.color&&r.bondColor&&(r.color=r.bondColor),r},doDrawNode:function(e,t,r,n,o,i){var a,s,d=this.getTransformedCoord2D(e,r,i.allowCoordBorrow),l=o,u=r.getAtomicNumber?r.getAtomicNumber():0,c=r.getOverriddenRenderOptions()||{},h=c.color||c.atomColor;if(h)l.color=h;else if(l.useAtomSpecifiedColor){var g;if(u<=0){var f=r.getClassLocalName();g=Kekule.Render.RenderColorUtils.getColor(f,this.getRendererType())}else g=Kekule.Render.RenderColorUtils.getColor(u,this.getRendererType());l.color=g}r.getCharge()||r.getRadical();var C=r.getCharge()&&!r.fetchChargeMarker(!1),R=r.getRadical()&&!r.fetchRadicalMarker(!1),p=!1;if(this.getObjNeedDrawLabel(e,r)){p=!0;var D=this._getNodeHydrogenDisplayLevel(r,l);D===Kekule.Render.HydrogenDisplayLevel.LABELED&&(D=Kekule.Render.HydrogenDisplayLevel.ALL);var x=!(!C&&!R),m=r.getDisplayRichText(D,x,l.displayLabelConfigs,l.partialChargeDecimalsLength,l.chargeMarkType,l.distinguishSingletAndTripletRadical),T=l.charDirection?l.charDirection:this._decideNodeLabelCharDirection(e,r);l.fontSize*=l.unitLength;var O=Object.create(l);O.charDirection=T;var y=(S=this.drawRichText(e,d,m,O)).drawnObj,E=S.boundRect;s=this.createRectBoundInfo({x:E.left,y:E.top},{x:E.left+E.width,y:E.top+E.height}),a=y}else{var k,v,S;if(this.getObjNeedDrawDot(e,r)&&Kekule.ObjUtils.isUnset(l.atomRadius)&&(l.atomRadius=l.allenCenterAtomRadius),l.atomRadius){var b=l.atomRadius*l.unitLength;l.strokeColor=l.color,l.fillColor=l.color,k=this.drawCircle(e,d,b,l),s=this.createCircleBoundInfo(d,b)}else s=this.createPointBoundInfo(d);if(C||R)(S=this.doDrawElectronStateMark(e,t,r,l.chargeMarkType,l.partialChargeDecimalsLength,l.distinguishSingletAndTripletRadical,l.fontFamily,l.chargeMarkFontSize*l.unitLength,l.chargeMarkMargin*l.unitLength,l.chargeMarkCircleWidth*l.unitLength,l.color,l.opacity,l.zoom||1))&&(v=S.drawnObj);k&&v?(a=this.createDrawGroup(e),this.addToDrawGroup(a,k),this.addToDrawGroup(a,v)):a=k||v}if(r.getUnplacedMarkers(this.getCoordMode()).length>=0){var A,_=l.chemMarkerMargin;if(p){_+=this._getNodeFontSize(e,r)*(i.zoom||1)*l.unitLength*1/2-_/2;var L=Kekule.Render.TextDirection,K=(L.LTR,L.RTL,L.TTB,L.BTT,T===L.LTR?{x:1,y:0}:T===L.RTL?{x:-1,y:0}:T===L.TTB?{x:0,y:1}:T===L.BTT?{x:0,y:-1}:{x:0,y:0}),w={x:K.x*i.scaleX,y:K.y*i.scaleY};A=w.x>0?0:w.x<0?Math.PI:w.y>0?Math.PI/2:w.y<0?3*Math.PI/2:null}var I=_/l.defBondLength*l.medianObjRefLength;this.doAdjustChemPropMarkerPos(r,I,i.allowCoordBorrow,Kekule.ObjUtils.notUnset(A)?[A]:[])}return a?(this.setObjDrawElem(e,r,a),t&&this.addToDrawGroup(a,t)):this.setObjDrawElem(e,r,null),this.addRenderedObj(e,r),this.basicDrawObjectUpdated(e,r,n,s,Kekule.Render.ObjectUpdateType.ADD),a},_getNodeFontSize:function(e,t,r){r||(r=this.getRenderCache(e).appliedOptions||this.getRenderCache(e).options);var n=Kekule.Render.RenderOptionUtils.getNodeLabelDrawOptions(t.getOverriddenRenderOptions())||{};return i(n.fontSize,r.fontSize,r.atomFontSize)},_getNodeHydrogenDisplayLevel:function(e,t){var r=e.getOverriddenRenderOptions(),n=Kekule.Render.RenderOptionUtils.getHydrogenDisplayLevel(r);return Kekule.ObjUtils.notUnset(n)?n:t.hydrogenDisplayLevel},_needNodeDrawDot:function(e,t,r){t.getOverriddenRenderOptions();if(t instanceof Kekule.Atom){if(t.getAtomicNumber()!==Kekule.Render.DEF_ATOM_ATOMIC_NUM)return!1;if(this.getObjNeedDrawLabel(e,t))return!1;if(2===t.getLinkedBonds().length){var o=t.getLinkedMultipleBonds();if(2===o.length&&o[0].getBondOrder()===o[1].getBondOrder()){var i=o[0].getBondOrder();return i>=n.DOUBLE&&i<n.EXPLICIT_AROMATIC}}return!1}return!1},_needNodeDrawLabel:function(e,t){var r=Kekule.Render.RenderOptionUtils,n=Kekule.Render.NodeLabelDisplayMode,o=e.getOverriddenRenderOptions(),i=r.getNodeDisplayMode(o)||t.nodeDisplayMode;if(!(e instanceof Kekule.ChemStructureNode))return!1;if(i===n.HIDDEN)return!1;if(i===n.SHOWN)return!0;if(t.moleculeDisplayType===Kekule.Render.MoleculeDisplayType.CONDENSED)return!0;if(e.getLinkedConnectors().length<=0)return!0;if(e instanceof Kekule.Atom&&e.getAtomicNumber()===Kekule.Render.DEF_ATOM_ATOMIC_NUM&&!e.getMassNumber()){if(e.getRenderOption("customLabel"))return!0;var a=this._getNodeHydrogenDisplayLevel(e,t),s=Kekule.Render.HydrogenDisplayLevel;if(a===s.ALL)return!0;if(a===s.UNMATCHED_EXPLICIT){var d=e.getExplicitHydrogenCount();return Kekule.ObjUtils.notUnset(d)&&e.getImplicitHydrogenCount()!==d}return Kekule.ObjUtils.notUnset(e.getExplicitHydrogenCount())}return!0},_isNodeHasConnectorToDirection:function(e,r,n){Kekule.ObjUtils.isUnset(n)&&(n=.2);for(var o=0,i=e.length;o<i;++o){var a=e[o];if(r===t.LTR&&a.x>n)return!0;if(r===t.RTL&&a.x<-n)return!0;if(r===t.TTB&&a.y>n)return!0;if(r===t.BTT&&a.y<-n)return!0}return!1},_calcConnectorVectorWeight:function(e){for(var t=0,r=0,n=function(e,t){return 0==t?100:Math.min(100,Math.pow(e/t,2))},o=0,i=e.length;o<i;++o)t+=e[o].x*n(e[o].x,e[o].y)*1,r+=e[o].y*n(e[o].y,e[o].x)*1;return{x:t,y:r}},_calcConnectorVectorOfNode:function(e,t){for(var r={x:0,y:0},n=this._getStandardizedLinkedObjRelCoords(e,t,null),o=0,i=n.length;o<i;++o)r.x+=n[o].x,r.y+=n[o].y;return r.x===r.y===0&&(r={x:1,y:0}),r},_calcVectorAxisDirection:function(e){return Math.abs(e.x)>=Math.abs(e.y)?e.x>0?t.LTR:t.RTL:e.y>0?t.TTB:t.BTT},_decideNodeLabelCharDirection:function(e,t){for(var r=this._getStandardizedLinkedObjRelCoords(e,t,null),n=Kekule.Render.TextDirection,o=[n.LTR,n.RTL,n.TTB,n.BTT],i=0,a=o.length;i<a;++i)if(!this._isNodeHasConnectorToDirection(r,o[i]))return o[i];var s=this._calcConnectorVectorWeight(r);return Math.abs(s.x)>Math.abs(s.y)?s.x<=0?n.LTR:n.RTL:s.y<=0?n.TTB:n.BTT},_calcConnectorAnglesOfNode:function(e,t){for(var r=[],n=this._getStandardizedLinkedObjRelCoords(e,t,null),o=0,i=n.length;o<i;++o){var a=n[o],s=Math.atan2(a.y,a.x);s<0&&(s=2*Math.PI+s),r.push(s)}return r.sort(),r},_getMostEmptyDirectionAngleOfNode:function(e,t){var r,n=this._calcConnectorAnglesOfNode(e,t),o=n.length;if(0===o)r=0;else if(1===o)r=-n[0];else{for(var i=0,a=0,s=0;s<o;++s){var d=n[s],l=n[(s+1)%o]-d;l<0&&(l+=2*Math.PI),l>i&&(i=l,a=s)}r=n[a]+i/2}return r},doAutoAdjustAttachedMarkerPos:function(e,t,r,n,o){t&&!t.getCoordOfMode(this.getCoordMode())&&e.autoSetMarker2DPos(t,r,n,o)},doAdjustChemPropMarkerPos:function(e,t,r,n){e.beginUpdate();try{var o=e.getMarkerOfType(Kekule.ChemMarker.Charge);this.doAutoAdjustAttachedMarkerPos(e,o,t,r,n);var i=e.getMarkerOfType(Kekule.ChemMarker.Radical);this.doAutoAdjustAttachedMarkerPos(e,i,t,r,n);for(var a=e.getUnplacedMarkers(this.getCoordMode()),s=0,d=a.length;s<d;++s)this.doAutoAdjustAttachedMarkerPos(e,a[s],t,r,n)}finally{e.endUpdate()}},doDrawElectronStateMark:function(e,t,r,n,o,i,a,s,d,l,u,c,h){var g=r.getCharge(),f=r.getRadical(),C="";if(!o||Math.abs(g)>Math.pow(10,-o)/2){Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND;var R=n===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND;if(1===g)C=R?"⊕":"+";else if(-1===g)C=R?"⊖":"−";else{C=(o?Kekule.NumUtils.toDecimals(Math.abs(g),o):Math.abs(g).toString())+(g>0?"+":"−")}}if(f&&(C+=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(f,i)),!C)return null;var p=this.getTransformedCoord2D(e,r),D=this._getMostEmptyDirectionAngleOfNode(e,r),x=d/1,m={x:Math.cos(D)*x,y:Math.sin(D)*x};m=Kekule.CoordUtils.add(p,m);var T,O,y=Kekule.Render.BoxXAlignment,E=Kekule.Render.BoxYAlignment;return T=y.CENTER,O=E.CENTER,this.drawText(e,m,C,{fontFamily:a,fontSize:s,color:u,opacity:c,textBoxXAlignment:T,textBoxYAlignment:O,zoom:h||1})},doDrawConnectorShape:function(e,t,r,n,o){var i,a=Kekule.CoordUtils,s=r[0],d=r[1],l=this.getTransformedCoord2D(e,s,o.allowCoordBorrow),u=this.getTransformedCoord2D(e,d,o.allowCoordBorrow),c={x:l.x,y:l.y},h={x:u.x,y:u.y},g=(r=[s,d],[c,h]),f=a.getDistance(c,h),C=0,R=n.unitLength||1,p=Math.sqrt(Math.sqr(h.x-c.x)+Math.sqr(h.y-c.y)),D=[],x=n.bondLengthScaleRatio;if(Kekule.ObjUtils.notUnset(x)){var m=a.substract(h,c);!0,i=x>0?0:1;var T=1-Math.abs(x||1),O=1===i?-1:1;D[i]=a.multiply(m,O*T)}if(this.getObjNeedDrawLabel(e,s)||this.getObjNeedDrawLabel(e,d)){var y,E,k,v=n.atomLabelBoxExpandRatio,S=h.x-c.x,b=h.y-c.y,A=S>=0?1:-1,_=b>=0?1:-1,L=0===S;if(!L)var K=Math.abs(b/S);k=Math.abs(S)>=Math.abs(b);for(var w=0,I=r.length;w<I;++w){var B=r[w],M=g[w],U=null;if(this.getObjNeedDrawLabel(e,B))if(y=E=this._getNodeFontSize(e,B)*(o.zoom||1)*R*v/2,U=k?{x:y*A,y:y*K*_}:L?{x:0,y:E*_}:{x:E/K*A,y:E*_}){var P=D[w];P&&Math.abs(x)<=1?(Math.abs(U.x)>Math.abs(P.x)||Math.abs(U.y)>Math.abs(P.y))&&(D[w]=U):D[w]=U}A*=-1,_*=-1}}for(w=0,I=g.length;w<I;++w){M=g[w];if(U=D[w]){C+=a.getDistance(U,{x:0,y:0});var j=a.add(M,U);M.x=j.x,M.y=j.y}}if(C>=f)return null;var N=(n.bondLineWidth||n.strokeWidth||1)*(n.unitLength||1);n.strokeWidth=N;var F,G=n.renderType,H=Kekule.Render.ConnectorDrawUtils.getPossibleConnectorRenderTypes(t);return(Kekule.ObjUtils.isUnset(G)||H.indexOf(G)<0)&&(G=H[0]),this.isLineBasedConnector(G)?F=this.doDrawLineBasedConnector(e,G,s,d,c,h,p,n):this.isTriangleBasedConnector(G)?F=this.doDrawTriangleBasedConnector(e,G,s,d,c,h,p,n):this.isTriangleHashBasedConnector(G)?F=this.doDrawTriangleHashBasedConnector(e,G,s,d,c,h,p,n):this.isRectangleBasedConnector(G)?F=this.doDrawRectangleBasedConnector(e,G,s,d,c,h,p,n):this.isWavyBasedConnector(G)&&(F=this.doDrawWavyBasedConnector(e,G,s,d,c,h,p,n)),F},_lineBasedConnectorTypes:[e.SINGLE,e.DOUBLE,e.TRIPLE,e.QUAD,e.SCISSORS_DOUBLE,e.BOLD,e.BOLD_DOUBLE,e.BOLD_TRIPLE,e.DASHED,e.DASHED_DOUBLE,e.DASHED_TRIPLE,e.SOLID_DASH,e.BOLD_DASH,e.ARROWED],_triangleBasedConnectorTypes:[e.WEDGED_SOLID,e.WEDGED_SOLID_INV,e.WEDGED_HOLLOW,e.WEDGED_HOLLOW_INV],_triangleHashBasedConnectorTypes:[e.WEDGED_HASHED,e.WEDGED_HASHED_INV,e.HASHED],_rectangleBasedConnectorTypes:[e.WEDGED_SOLID_BOTH,e.WEDGED_HOLLOW_BOTH],isLineBasedConnector:function(e){return this._lineBasedConnectorTypes.indexOf(e)>=0},isTriangleBasedConnector:function(e){return this._triangleBasedConnectorTypes.indexOf(e)>=0},isTriangleHashBasedConnector:function(e){return this._triangleHashBasedConnectorTypes.indexOf(e)>=0},isRectangleBasedConnector:function(e){return this._rectangleBasedConnectorTypes.indexOf(e)>=0},isWavyBasedConnector:function(t){return e.WAVY},doDrawLineBasedConnector:function(t,r,n,o,i,a,s,d){var l=[],u={isBold:!1,isDash:!1},c={isBold:!0,isDash:!1},h={isBold:!1,isDash:!0};switch(r){case e.DOUBLE:case e.SCISSORS_DOUBLE:for(var g=0;g<2;++g,l.push(u));break;case e.TRIPLE:for(g=0;g<3;++g,l.push(u));break;case e.QUAD:for(g=0;g<4;++g,l.push(u));break;case e.BOLD:l.push(c);break;case e.BOLD_DOUBLE:l.push(c),l.push(u);break;case e.BOLD_TRIPLE:l.push(c);for(g=0;g<2;++g,l.push(u));break;case e.BOLD_QUAD:l.push(c);for(g=0;g<3;++g,l.push(u));break;case e.DASHED:l.push(h);break;case e.DASHED_DOUBLE:for(g=0;g<2;++g,l.push(h));break;case e.DASHED_TRIPLE:for(g=0;g<3;++g,l.push(h));break;case e.SOLID_DASH:l.push(u),l.push(h);break;case e.BOLD_DASH:l.push(c),l.push(h);break;case e.ARROWED:u.isArrow=!0,l.push(u);break;case e.SINGLE:default:l.push(u)}var f=r===e.SCISSORS_DOUBLE;return this.doDrawSymmetryLineConnector(t,n,o,i,a,s,l,f,d)},doDrawSymmetryLineConnector:function(e,t,r,n,o,i,a,s,d){var l=a.length,u=null,c=null;if(1===l){var h=d.strokeWidth;a[0].isBold&&(h*=d.boldBondLineWidthRatio);var g=null;a[0].isArrow&&(g={width:d.bondArrowWidth*d.unitLength,length:d.bondArrowLength*d.unitLength});var f={strokeWidth:h,strokeColor:Kekule.Render.RenderOptionUtils.getColor(d),strokeDash:a[0].isDash,opacity:d.opacity},C=(c=this.drawArrowLine(e,n,o,g,f),this.createLineBoundInfo(n,o,h))}else if(l>1){u=this.createDrawGroup(e);var R=d.multipleBondSpacingAbs?d.multipleBondSpacingAbs:d.multipleBondSpacingRatio*i;d.multipleBondMaxAbsSpacing&&(R=Math.min(R,d.multipleBondMaxAbsSpacing)),R*=d.unitLength;var p=o.x-n.x,D=o.y-n.y,x=Math.sqrt(Math.sqr(p)+Math.sqr(D)),m=D/x,T=p/x,O=[],y=1;1&l||(y=s?0:Kekule.ObjUtils.isUnset(a.bondAlign)?this._decideEvenBondAlign(e,t,r):a.bondAlign);for(var E=0;E<l;++E)if(Kekule.ObjUtils.notUnset(a[E].offsetAdjust))O.push(a[E].offsetAdjust);else if(0===E&&0!==y)O.push(0);else{var k=1&E?1:-1;if(0!==y)var v=y*k*(E+1>>1);else v=(1*(E>>1)+.5)*k;O.push(v)}var S=R;S>_&&(_=S),S<L&&(L=S);var b={x:0,y:0},A={x:0,y:0},_=0,L=0,K=[];for(E=0;E<l;++E){var w=Object.create(d),I=S*m,B=S*T,M={x:n.x-I*O[E],y:n.y+B*O[E]},U={x:o.x-I*O[E],y:o.y+B*O[E]};b=Kekule.CoordUtils.add(b,M),A=Kekule.CoordUtils.add(A,U);g=null;a[E].isArrow&&(g={width:d.bondArrowWidth*d.unitLength,length:d.bondArrowLength*d.unitLength});h=d.strokeWidth;a[E].isBold&&(h*=d.boldBondLineWidthRatio),w.strokeColor=d.color,w.strokeDash=a[E].isDash,K.push({coord1:M,coord2:U,arrowParams:g,drawOptions:w}),S=a[E].isBold?R+Math.floor(h/2):R}if(s)for(E=0;E<l;++E){var P=K[E],j=K[l-E-1];c=this.drawArrowLine(e,P.coord1,j.coord2,P.arrowParams,P.drawOptions);this.addToDrawGroup(c,u)}else for(E=0;E<l;++E){var N=K[E];c=this.drawArrowLine(e,N.coord1,N.coord2,N.arrowParams,N.drawOptions);this.addToDrawGroup(c,u)}b=Kekule.CoordUtils.divide(b,l),A=Kekule.CoordUtils.divide(A,l);C=this.createLineBoundInfo(b,A,_-L)}return{element:u||c,boundInfo:C}},_getStandardizedLinkedObjRelCoords:function(e,t,r){for(var n=[],o=this.getTransformedCoord2D(e,t),i=t.getLinkedExposedObjs(),a=0,s=i.length;a<s;++a){var d=i[a];if(d!==r){var l=this.getTransformedCoord2D(e,d),u=Kekule.CoordUtils.substract(l,o);u=Kekule.CoordUtils.standardize(u),n.push(u)}}return n},_decideEvenBondAlign:function(e,t,r){var n=Kekule.CoordUtils.substract(this.getTransformedCoord2D(e,r),this.getTransformedCoord2D(e,t));n=Kekule.CoordUtils.standardize(n);for(var o=this._getStandardizedLinkedObjRelCoords(e,t,r),i=this._getStandardizedLinkedObjRelCoords(e,r,t),a=0,s={x:0,y:0},d=0,l=o.length;d<l;++d)a+=this._calcSinglePointAlign(o[d],n),s.x+=o[d].x,s.y+=o[d].y;for(d=0,l=i.length;d<l;++d)a+=this._calcSinglePointAlign(i[d],n),s.x+=i[d].x,s.y+=i[d].y;return 0!==a?Math.sign(a):this._calcSinglePointAlign(s,n)},_calcSinglePointAlign:function(e,t){var r;if(Math.abs(t.x)<1e-4)return r=Math.abs(e.x)<1e-4?0:-Math.sign(e.x)*Math.sign(t.y);var n=t.y*e.x/t.x,o=e.y-n;return r=o>1e-4?1:o<-1e-4?-1:0,r*=Math.sign(t.x)},doDrawTriangleBasedConnector:function(t,r,n,o,i,a,s,d){var l=r===e.WEDGED_SOLID||r===e.WEDGED_SOLID_INV,u=r===e.WEDGED_SOLID_INV||r===e.WEDGED_HOLLOW_INV?[a,i]:[i,a],c=d.bondWedgeWidth*d.unitLength,h=this._calcTriangleBaselineCoords(u[0],u[1],c),g=Object.create(d);g.strokeColor=d.color,g.fillColor=l?d.color:null;var f={element:this.drawTriangle(t,u[0],h[0],h[1],g)};return f.boundInfo=this.createLineBoundInfo(u[0],u[1],c),f},doDrawTriangleHashBasedConnector:function(t,r,n,o,i,a,s,d){var l=r===e.WEDGED_HASHED_INV,u=r!==e.HASHED,c=l?[a,i]:[i,a],h=d.hashSpacing*d.unitLength,g=d.bondWedgeWidth*d.unitLength,f=u?d.bondWedgeHashMinWidth*d.unitLength:g,C=g-f,R=Kekule.CoordUtils.substract(c[1],c[0]),p=Math.sqrt(Math.sqr(R.x)+Math.sqr(R.y)),D=Math.floor(p/h),x=this.createDrawGroup(t),m=Object.create(d);m.strokeColor=d.color;for(var T=0;T<D;++T){var O=h*T/p,y={x:R.x*O,y:R.y*O};y=Kekule.CoordUtils.add(y,c[0]);var E=this._calcTriangleBaselineCoords(c[0],y,C*O+f),k=this.drawLine(t,E[0],E[1],m);this.addToDrawGroup(k,x)}var v={element:x};return v.boundInfo=this.createLineBoundInfo(c[0],c[1],g),v},_calcTriangleBaselineCoords:function(e,t,r){var n=Kekule.CoordUtils.substract(t,e),o=Math.sqrt(Math.sqr(n.x)+Math.sqr(n.y)),i=n.y/o,a=n.x/o,s=r/2,d=[];return d.push({x:t.x+s*i,y:t.y-s*a}),d.push({x:t.x-s*i,y:t.y+s*a}),d},doDrawRectangleBasedConnector:function(t,r,n,o,i,a,s,d){var l=r===e.WEDGED_SOLID_BOTH,u=d.bondWedgeWidth*d.unitLength,c=this._calcRectangleCornerCoords(i,a,u),h=Object.create(d);h.strokeColor=d.color,h.fillColor=l?d.color:null;var g=Kekule.Render.DrawPathUtils.makePath("M",[c[0].x,c[0].y],"L",[c[1].x,c[1].y],"L",[c[2].x,c[2].y],"L",[c[3].x,c[3].y],"Z"),f={element:this.drawPath(t,g,h)};return f.boundInfo=this.createLineBoundInfo(i,a,u),f},_calcRectangleCornerCoords:function(e,t,r){var n=Kekule.CoordUtils.substract(t,e),o=Math.sqrt(Math.sqr(n.x)+Math.sqr(n.y)),i=r/2,a=[],s=i*(n.y/o),d=i*(n.x/o);return a.push({x:e.x+s,y:e.y-d}),a.push({x:e.x-s,y:e.y+d}),a.push({x:t.x-s,y:t.y+d}),a.push({x:t.x+s,y:t.y-d}),a},doDrawWavyBasedConnector:function(e,t,r,n,o,i,a,s){for(var d,l=Kekule.CoordUtils,u=s.bondWavyRadius*s.unitLength,c=l.getDistance(o,i),h=Math.round(c/u),g=l.divide(l.substract(i,o),h),f=c/h,C=[],R=o,p=Math.atan2(g.y,g.x)+Math.PI,D={x:f/1.5*Math.sin(p),y:-f/1.5*Math.cos(p)},x=1,m=0;m<h;++m){x=-x,d=R,R=l.add(d,g);var T=l.multiply(D,x),O=l.add(d,T),y=l.add(R,T);0===m&&(C.push("M"),C.push([d.x,d.y])),C.push("C"),C.push([O.x,O.y,y.x,y.y,R.x,R.y])}var E=Kekule.Render.DrawPathUtils.makePath.apply(Kekule.Render.DrawPathUtils,C),k=Object.create(s);k.strokeColor=s.color,k.fillColor=null;var v={element:this.drawPath(e,E,k)};return v.boundInfo=this.createLineBoundInfo(o,i,f),v}}),Kekule.Render.StructFragment2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.StructFragment2DRenderer",initialize:function($super,e,t,r){$super(e,t,r),this._concreteRenderer=null,this._concreteChemObj=null,this.initConcreteRenderer()},finalize:function($super){$super(),this._concreteRenderer&&(this._concreteRenderer.finalize(),this._concreteRenderer=null)},_getRenderSortIndex:function($super){return this._concreteRenderer?this._concreteRenderer._getRenderSortIndex():$super()},initConcreteRenderer:function(){var e=this.getChemObj(),t=this.getDrawBridge();return this._isRendererMismatch(this._concreteRenderer,e)&&this._concreteRenderer&&(this._concreteRenderer.finalize(),this._concreteRenderer=null,this._concreteChemObj=null),!this._concreteRenderer&&e&&(e.hasCtab()?(this._concreteChemObj=e.getCtab(),this._concreteRenderer=new Kekule.Render.ChemCtab2DRenderer(e.getCtab(),t,this)):e.hasFormula()&&(this._concreteChemObj=e.getFormula(),this._concreteRenderer=new Kekule.Render.Formula2DRenderer(e.getFormula(),t,this))),this._concreteRenderer},_isRendererMismatch:function(e,t){return e&&!t||e instanceof Kekule.Render.ChemCtab2DRenderer&&!t.hasCtab()||e instanceof Kekule.Render.Formula2DRenderer&&!t.hasFormula()},getConcreteRenderer:function(){return this.initConcreteRenderer(),this._concreteRenderer},_getConcreteRendererDrawOptions:function(e){return e},isChemObjRenderedBySelf:function($super,e,t){var r=this.getConcreteRenderer();return $super(e,t)||t===this.getChemObj()||r&&r.isChemObjRenderedBySelf(e,t)},isChemObjRenderedDirectlyBySelf:function($super,e,t){this.getConcreteRenderer();return $super(e,t)||t===this.getChemObj()||t===this._concreteChemObj},doSetRedirectContext:function($super,e){$super(e);var t=this.getConcreteRenderer();t&&t.setRedirectContext(e)},getChildObjs:function($super){var e=this.getChemObj();if(e){for(var t=[],r=(e.getExposedNodes()||[]).concat(e.getExposedConnectors()||[]),n=0,o=r.length;n<o;++n){var i=r[n];i.getAttachedMarkers&&(t=t.concat(i.getAttachedMarkers()||[]))}return t.concat($super())}return $super()},_needWholelyDraw:function($super,e,t){var r=$super(e,t);if(!r){for(var n=this.getChemObj(),o=!1,i=0,a=e.length;i<a;++i){if(e[i].isChildOf(n)){o=!0;break}}r=o}return r},_createChargeAndRadicalMarkerOnStructFragment:function(e){e.beginUpdate();try{e.getCharge&&e.getCharge()&&e.fetchChargeMarker(!0);e.getNodes();for(var t=0,r=e.getNodeCount();t<r;++t){var n=e.getNodeAt(t);n.beginUpdate();try{n.getCharge()&&n.fetchChargeMarker(!0),n.getRadical()&&n.fetchRadicalMarker(!0),n.getNodeAt&&this._createChargeAndRadicalMarkerOnStructFragment(n)}finally{n.endUpdate()}}}finally{e.endUpdate()}},doDraw:function($super,e,t,r){var n=!!r.autoCreateChargeAndRadicalMarker;if(this.getCanModifyTargetObj()&&n){var o=this.getChemObj();this._createChargeAndRadicalMarkerOnStructFragment(o)}$super(e,t,r)},doDrawSelf:function($super,e,t,r){$super(e,t,r);var n=this.getChemObj(),o=t,i=this.getConcreteRenderer();if(!o&&i instanceof Kekule.Render.Formula2DRenderer&&n.getAbsBaseCoord2D){var a=n.getAbsBaseCoord2D(r.allowCoordBorrow);o=Kekule.CoordUtils.transform2D(a,r.transformParams)}return n.hasFormula()||n.hasCtab()?i?i.draw(e,o,this._getConcreteRendererDrawOptions(r)):void 0:null},doRedraw:function($super,e){return $super(e)},doUpdateSelf:function(e,t,r){if(this._extractObjsOfUpdateObjDetails(t).indexOf(this.getChemObj())>=0){var n=this.getRenderCache(e);return this.doClear(e),this.draw(e,n.baseCoord,n.options)}var o=this.getConcreteRenderer();if(o)return o.doUpdate(e,t,r)},doClearSelf:function(e){var t=this.getConcreteRenderer();if(t)return t.clear(e)},estimateRenderBox:function(e,t,r,n){var o=this.getConcreteRenderer();return o?o.estimateRenderBox(e,t,this._getConcreteRendererDrawOptions(r),n):null},transformCoordToObj:function($super,e,t,r){return $super(e,t,r)},transformCoordToContext:function($super,e,t,r){return $super(e,t,r)}}),Kekule.Render.Mol2DRenderer=Kekule.Render.StructFragment2DRenderer,Kekule.Render.CompositeObj2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeObj2DRenderer"}),Kekule.Render.CompositeMolecule2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule2DRenderer",getChildObjs:function($super){for(var e=[],t=this.getChemObj().getSubMolecules(),r=0,n=t.getItemCount();r<n;++r){var o=t.getObjAt(r);e.push(o)}return e.concat($super())}}),Kekule.Render.ChemObjGroupList2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule2DRenderer",getChildObjs:function($super){var e=this.getChemObj();if(e instanceof Kekule.ChemObjList)for(var t=[],r=0,n=e.getItemCount();r<n;++r)t.push(e.getItemAt(r));else e instanceof Kekule.ChemStructureObjectGroup&&(t=e.getAllObjs());return(t||[]).concat($super())}}),Kekule.Render.Reaction2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.Reaction2DRenderer",getChildObjs:function($super){for(var e=[],t=this.getChemObj(),r=(e=[],0),n=t.getReactantCount();r<n;++r){var o=t.getReactantAt(r);e.push(o)}for(r=0,n=t.getProductCount();r<n;++r){o=t.getProductAt(r);e.push(o)}return(e||[]).concat($super())}}),Kekule.Render.ChemSpaceElement2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpaceElement2DRenderer",getChildObjs:function($super){var e=$super()||[];return e=(this.getChemObj().getChildren().toArray()||[]).concat(e)}}),Kekule.Render.ChemSpace2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpace2DRenderer",getChildObjs:function($super){return[this.getChemObj().getRoot()].concat($super()||[])},doEstimateSelfObjBox:function($super,e,t,r){var n=this.getChemObj().getSize2D();return n.x&&n.y&&t.useExplicitSpaceSize?{x1:0,y1:0,x2:n.x,y2:n.y}:$super(e,t,r)}}),Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.Charge,Kekule.Render.TextBasedChemMarker2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.Radical,Kekule.Render.TextBasedChemMarker2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.UnbondedElectronSet,Kekule.Render.UnbondedElectronSetRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.TextBlock,Kekule.Render.TextBlock2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ImageBlock,Kekule.Render.ImageBlock2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.StructureFragment,Kekule.Render.StructFragment2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.CompositeMolecule,Kekule.Render.CompositeMolecule2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.Reaction,Kekule.Render.Reaction2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemObjList,Kekule.Render.ChemObjGroupList2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemStructureObjectGroup,Kekule.Render.ChemObjGroupList2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemSpaceElement,Kekule.Render.ChemSpaceElement2DRenderer),Kekule.Render.Renderer2DFactory.register(Kekule.ChemSpace,Kekule.Render.ChemSpace2DRenderer)}(),function(){Kekule.Render.DrawPathUtils;var e=Kekule.CoordUtils,t=(Kekule.oneOf,Kekule.Glyph.NodeType),r=Kekule.Glyph.PathType;Kekule.Render.BaseGlyph2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.BaseGlyph2DRenderer",doDraw:function($super,e,t,r){var n=Object.create(r);return n.strokeColor=r.strokeColor||r.glyphStrokeColor,n.fillColor=r.fillColor||r.glyphFillColor,n.strokeWidth=r.strokeWidth||r.glyphStrokeWidth,$super(e,t,n)}}),Kekule.Render.PathGlyphCtab2DRenderer=Class.create(Kekule.Render.Ctab2DRenderer,{CLASS_NAME:"Kekule.Render.PathGlyphCtab2DRenderer",initialize:function($super,e,t,r){$super(e,t,r),this._nodeCoordOverrideMap=new Kekule.MapEx(!0)},doFinalize:function($super){this._nodeCoordOverrideMap.finalize(),$super()},extractGlyphDrawOptions:function(e){var t=e.unitLength||1;return{strokeColor:e.strokeColor||e.color||e.glyphStrokeColor,fillColor:e.fillColor||e.color||e.glyphFillColor,strokeWidth:(e.strokeWidth||e.glyphStrokeWidth)*t}},doDraw:function($super,e,t,r){var n=$super(e,t,r);return this._nodeCoordOverrideMap.clear(),n},doDrawNode:function(e,r,n,o,i,a){var s,d=n.getNodeType();if(!d||d===t.LOCATION||d===t.CONTROLLER){var l=this._nodeCoordOverrideMap.get(n)||this.getTransformedCoord2D(e,n,a.allowCoordBorrow);s=this.createPointBoundInfo(l)}s&&this.basicDrawObjectUpdated(e,n,o,s,Kekule.Render.ObjectUpdateType.ADD)},doDrawConnector:function($super,e,t,r,n,o,i){var a=$super(e,t,r,n,o,i),s=r.getControlPoints&&r.getControlPoints();if(s)for(var d=0,l=s.length;d<l;++d){var u=this.getTransformedCoord2D(e,s[d],i.allowCoordBorrow),c=this.createPointBoundInfo(u);this.basicDrawObjectUpdated(e,s[d],r,c,Kekule.Render.ObjectUpdateType.ADD)}return a},doDrawConnectorShape:function(t,n,o,i,a){var s,d=Kekule.Glyph.ArrowSide,l=o[0],u=o[1],c=e.clone(this.getTransformedCoord2D(t,l,a.allowCoordBorrow)),h=e.clone(this.getTransformedCoord2D(t,u,a.allowCoordBorrow)),g=this.extractGlyphDrawOptions(i),f=n.getPathType(),C=n.getPathParams()||{},R=this.getChemObj(),p=(C.lineGap||0)*i.defScaleRefLength,D=p&&C.lineCount||1,x=[];C.startArrowType&&C.startArrowWidth&&(s={arrowLength:(m=this._transformArrowLength(t,C.startArrowLength,C.startArrowWidth)).arrowLength,arrowWidth:m.arrowWidth,arrowType:C.startArrowType,arrowSide:C.startArrowSide,drawOnCenter:!C.startArrowSide||C.startArrowSide===d.BOTH});if(C.endArrowType&&C.endArrowWidth)var m,T={arrowLength:(m=this._transformArrowLength(t,C.endArrowLength,C.endArrowWidth)).arrowLength,arrowWidth:m.arrowWidth,arrowType:C.endArrowType,arrowSide:C.endArrowSide,drawOnCenter:!C.endArrowSide||C.endArrowSide===d.BOTH};for(var O=[],y=Kekule.Render.MetaShapeUtils.inflateShape,E=0,k=o.length;E<k;++E){var v=o[E].getPathNodeParams();if(v.useStickingOffset){var S=this.getStickingTargetRenderBound(t,o[E]);if(S){var b=v.stickingOffsetRelLength;if(Kekule.ObjUtils.isUnset(b)&&(b=i.glyphStickOffsetRelLength),b)S=y(S,this._doGetStickOffsetContextLength(t,b,i));O[E]=S}}}var A=[],_=[],L={y:0,x:p},K=e.substract(this.transformCoordToContext(t,R,{x:0,y:0}),this.transformCoordToContext(t,R,L)),w=e.getDistance(K,{x:0,y:0});if(f===r.LINE)A=(M=this._doDrawLineConnectorShape(t,R,n,o,c,h,D,w,s,T,O,g,i)).drawnElems,x=M.arrowElems,_=M.boundInfos;else if(f===r.ARC){var I=n.getControlPoints&&n.getControlPoints(),B=I&&I[0];if(B){var M,U=e.clone(this.getTransformedCoord2D(t,B,a.allowCoordBorrow));A=(M=this._doDrawArcConnectorShape(t,R,n,o,c,h,U,D,w,s,T,O,g,i)).drawnElems,x=M.arrowElems,_=M.boundInfos}}if(_.length||(_=null),D<=1&&!x.length)return{element:A&&A[0],boundInfo:_&&_[0]};var P=this.createDrawGroup(t);for(E=0;E<D;++E)A[E]&&this.addToDrawGroup(A[E],P);for(E=0,k=x.length;E<k;++E)x[E]&&this.addToDrawGroup(x[E],P);return{element:P,boundInfo:_}},_doGetStickOffsetContextLength:function(t,r,n){var o={x:r*n.medianObjRefLength,y:0},i=this.getRootRenderer(),a=i.transformCoordToContext(t,this.getChemObj(),{x:0,y:0}),s=i.transformCoordToContext(t,this.getChemObj(),o);return e.getDistance(a,s)},_doDrawLineConnectorShape:function(t,r,n,o,i,a,s,d,l,u,c,h,g){for(var f=[i,a],C=[i,a],R=(e.divide(e.add(i,a),2),0);R<2;++R){var p=c[R];if(p){var D=Kekule.Render.MetaShapeUtils.getCrossPointsOfVectorToShapeEdges(C,p,!0);D&&D.length&&(f[R]=D[0],this._nodeCoordOverrideMap.set(o[R],f[R]))}}var x=Kekule.Glyph.ArrowSide,m=[],T=[],O=[],y=e.substract(f[1],f[0]),E=y.x,k=y.y,v=e.getDistance(f[0],f[1]),S=v,b=(s-1)/2,A=d,_={y:A*(E/v),x:-A*(k/v)},L=(e.multiply(_,(s-1)/2),e.multiply(_,(s-1)/2)),K=e.substract(f[0],L),w=e.substract(f[1],L);for(R=0;R<s;++R){if(U=null,P=null,0!==R&&(K=e.add(K,_),w=e.add(w,_)),l||u){var I=R-b,B=A*Math.abs(I);if(l){if(l.drawOnCenter&&(!l.arrowSide||l.arrowSide===x.SINGLE&&I<0||l.arrowSide===x.REVERSED&&I>0))var M=l.arrowType===Kekule.Glyph.ArrowType.OPEN?l.arrowLength*B/(l.arrowWidth/2):l.arrowLength,U=e.add(K,e.multiply(y,M/S));l.drawOnCenter&&0===R&&Kekule.ArrayUtils.pushUnique(O,this.doDrawArrowShape(t,n,f[1],f[0],l,h,!0)),!l.drawOnCenter&&(l.arrowSide===x.SINGLE&&0===R||l.arrowSide===x.REVERSED&&R===s-1)&&Kekule.ArrayUtils.pushUnique(O,this.doDrawArrowShape(t,n,w,K,l,h,!0))}if(u){if(u.drawOnCenter&&(!u.arrowSide||u.arrowSide===x.SINGLE&&I<0||u.arrowSide===x.REVERSED&&I>0)){M=u.arrowType===Kekule.Glyph.ArrowType.OPEN?u.arrowLength*B/(u.arrowWidth/2):u.arrowLength;var P=e.substract(w,e.multiply(y,M/S))}u.drawOnCenter&&0===R&&Kekule.ArrayUtils.pushUnique(O,this.doDrawArrowShape(t,n,f[0],f[1],u,h)),!u.drawOnCenter&&(u.arrowSide===x.SINGLE&&0===R||u.arrowSide===x.REVERSED&&R===s-1)&&Kekule.ArrayUtils.pushUnique(O,this.doDrawArrowShape(t,n,K,w,u,h))}}var j=this.doDrawLineShape(t,n,U||K,P||w,h,g);m.push(j.element),T.push(j.boundInfo)}return{drawnElems:m,boundInfos:T,arrowElems:O}},_doDrawArcConnectorShape:function(t,r,n,o,i,a,s,d,l,u,c,h,g,f){for(var C=[],R=[],p=[],D=[i,a],x=e.divide(e.add(s,D[0]),2),m=e.divide(e.add(D[1],s),2),T=-(D[0].x-s.x)/(D[0].y-s.y),O=-(D[1].x-s.x)/(D[1].y-s.y),y={x:(m.y-x.y-O*m.x+T*x.x)/(T-O),y:x.y+T*(m.y-x.y-O*m.x+O*x.x)/(T-O)},E=e.getDistance(y,D[0]),k=e.substract(D[0],y),v=e.substract(D[1],y),S=e.substract(s,y),b=Kekule.GeometryUtils.standardizeAngle(Math.atan2(k.y,k.x)),A=Kekule.GeometryUtils.standardizeAngle(Math.atan2(v.y,v.x)),_=Kekule.GeometryUtils.standardizeAngle(Math.atan2(S.y,S.x)),L=[],K=0;K<2;++K){var w=h[K];if(w){var I=this._getCrossCoordsAndAnglesOfArcToShapeEdges(y,E,b,A,_,w);if(I&&I.length>=1){var B=I[0].coord,M=I[0].angle;L[K]=M,D[K]=B,this._nodeCoordOverrideMap.set(o[K],B)}}}L[0]&&(b=L[0]),L[1]&&(A=L[1]);var U,P,j=A-b,N=_-b,F=_-A,G=Math.sign(N)*Math.sign(F)*Math.sign(j)>0,H=10/E;if(u){var z=b-(G?H:-H);U={x:Math.cos(z),y:Math.sin(z)}}if(c){z=A+(G?H:-H);P={x:Math.cos(z),y:Math.sin(z)}}var W=E-l*((d-1)/2);for(K=0;K<d;++K){var V=W+K*l;if((u||c)&&d<=1){if(u&&0===K){var Y=e.add(y,e.multiply(U,V));Kekule.ArrayUtils.pushUnique(p,this.doDrawArrowShape(t,n,Y,D[0],u,g,!0))}if(c&&0===K){Y=e.add(y,e.multiply(P,V));Kekule.ArrayUtils.pushUnique(p,this.doDrawArrowShape(t,n,Y,D[1],c,g,!0))}}var X=this.doDrawArcShape(t,y,V,b,A,G,g);X.element&&C.push(X.element),X.boundInfo&&R.push(X.boundInfo)}return{drawnElems:C,boundInfos:R,arrowElems:p}},_getCrossCoordsAndAnglesOfArcToShapeEdges:function(t,r,n,o,i,a){for(var s=Kekule.Render.MetaShapeUtils.getEdgeBasicElements(a),d=s.vectors,l=[],u=0,c=d.length;u<c;++u){var h=d[u];(f=Kekule.GeometryUtils.getCrossPointsOfVectorToCircle(h,t,r,1e-4))&&f.length&&(l=l.concat(f))}var g=s.circles;for(u=0,c=g.length;u<c;++u){var f;h=g[u];(f=Kekule.GeometryUtils.getCrossPointsOfCircles(h.center,h.radius,t,r,1e-4))&&f.length&&(l=l.concat(f))}var C=[],R=Math.sign((i-n)*(i-o));for(u=0,c=l.length;u<c;++u){var p=e.substract(l[u],t),D=Kekule.GeometryUtils.standardizeAngle(Math.atan2(p.y,p.x));Math.sign((D-n)*(D-o))===R&&C.push({angle:D,coord:l[u]})}return C},_getNearestCoordToPoint:function(t,r){for(var n=null,o=null,i=0,a=r.length;i<a;++i){var s=e.getDistance(r[i],t);(!n||s<o)&&(n=r[i],o=s)}return n},_transformArrowLength:function(e,t,r){var n={x:t||0,y:r||0},o=Kekule.CoordUtils.substract(this.transformCoordToContext(e,this.getChemObj(),n),this.transformCoordToContext(e,this.getChemObj(),{x:0,y:0}));return{arrowLength:Math.abs(o.x),arrowWidth:Math.abs(o.y)}},doDrawArrowShape:function(t,r,n,o,i,a,s){var d,l,u=Kekule.Glyph.ArrowSide,c=Kekule.Glyph.ArrowType,h=e.substract(o,n),g=e.getDistance(o,n),f=h.y/g,C=h.x/g,R=i.arrowLength,p=i.arrowWidth/2,D=e.substract(o,e.multiply(h,R/g)),x={x:p*f,y:-p*C},m=Kekule.Render.DrawPathUtils,T=[];!i.arrowSide||!s&&i.arrowSide===u.SINGLE||s&&i.arrowSide===u.REVERSED?(d=e.add(D,x),T.push("M"),T.push([d.x,d.y]),T.push("L"),T.push([o.x,o.y])):(T.push("M"),T.push([o.x,o.y])),(!i.arrowSide||!s&&i.arrowSide===u.REVERSED||s&&i.arrowSide===u.SINGLE)&&(l=e.substract(D,x),T.push("L"),T.push([l.x,l.y]));var O=!1;if(i.arrowType===c.TRIANGLE){var y=d&&l?null:D;y&&(T.push("L"),T.push([y.x,y.y])),T.push("Z"),O=!0}var E=m.makePath.apply(this,T),k=Object.create(a);return O||(k.fillColor="transparent"),this.drawPath(t,E,k)},doDrawLineShape:function(e,t,r,n,o,i){return{element:this.drawLine(e,r,n,o),boundInfo:this.createLineBoundInfo(r,n,o.strokeWidth)}},doDrawArcShape:function(e,t,r,n,o,i,a){var s=Object.create(a);return s.fillColor=null,{element:this.drawArc(e,t,r,n,o,i,s),boundInfo:this.createArcBoundInfo(t,r,n,o,i,s.strokeWidth)}}}),Kekule.Render.PathGlyph2DRenderer=Class.create(Kekule.Render.BaseGlyph2DRenderer,{CLASS_NAME:"Kekule.Render.PathGlyph2DRenderer",initialize:function($super,e,t,r){$super(e,t,r),this._concreteChemObj=e.getCtab(),this._concreteRenderer=new Kekule.Render.PathGlyphCtab2DRenderer(e.getCtab(),t,this)},finalize:function($super){$super(),this._concreteRenderer&&(this._concreteRenderer.finalize(),this._concreteRenderer=null)},_getRenderSortIndex:function($super){return this._concreteRenderer?this._concreteRenderer._getRenderSortIndex():$super()},getRenderCache:function(e){return this._concreteRenderer.getRenderCache(e)},_getConcreteRendererDrawOptions:function(e){return e},isChemObjRenderedBySelf:function($super,e,t){return $super(e,t)||t===this.getChemObj()||this._concreteRenderer.isChemObjRenderedBySelf(e,t)},isChemObjRenderedDirectlyBySelf:function($super,e,t){return $super(e,t)||t===this.getChemObj()},doSetRedirectContext:function($super,e){$super(e),this._concreteRenderer.setRedirectContext(e)},doDraw:function($super,e,t,r){$super(e,t,r);this.getChemObj();var n=Object.create(r);return n.partialDrawObjs&&(n.partialDrawObjs=null),this._concreteRenderer.draw(e,t,this._getConcreteRendererDrawOptions(n))},doRedraw:function(e){return this._concreteRenderer.redraw(e)},doUpdate:function(e,t,r){if(this._extractObjsOfUpdateObjDetails(t).indexOf(this.getChemObj())>=0){var n=this.getRenderCache(e);return this.doClear(e),this.draw(e,n.baseCoord,n.options)}return this._concreteRenderer.doUpdate(e,t,r)},doClear:function(e){return this._concreteRenderer.clear(e)},estimateRenderBox:function(e,t,r){return this._concreteRenderer.estimateRenderBox(e,this._getConcreteRendererDrawOptions(t),r)},transformCoordToObj:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToObj(e,n,r)},transformCoordToContext:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToContext(e,n,r)}}),Kekule.Render.Renderer2DFactory.register(Kekule.Glyph.PathGlyph,Kekule.Render.PathGlyph2DRenderer)}(),Kekule.Render.CanvasRendererBridge=Class.create({CLASS_NAME:"Kekule.Render.CanvasRendererBridge",DEF_DOUBLE_BUFFERED:!1,SHADOW_CANVAS_FIELD:"__$shadow_canvas__",SHADOW_CONTEXT_FIELD:"__$shadow_context__",getShadowContext:function(e){return e[this.SHADOW_CONTEXT_FIELD]},getShadowCanvas:function(e){return e[this.SHADOW_CANVAS_FIELD]},getOperatingContext:function(e){return this.getShadowContext(e)||e},createContext:function(e,t,r,n,o){void 0===o&&(o=this.DEF_DOUBLE_BUFFERED);e.ownerDocument;var i=document.createElement("canvas");n&&(i.id=n),e.appendChild(i);var a=i.getContext("2d");if(o){var s=document.createElement("canvas");s.style.position="absolute",s.style.display="none",e.appendChild(s),a[this.SHADOW_CANVAS_FIELD]=s,a[this.SHADOW_CONTEXT_FIELD]=s.getContext("2d")}return this.setContextDimension(a,t,r),a},releaseContext:function(e){var t=e.canvas,r=this.getShadowCanvas(e),n=t.parentNode;n&&(n.removeChild(t),r&&n.removeChild(r))},getContextDimension:function(e){return{width:e.canvas.width,height:e.canvas.height}},setContextDimension:function(e,t,r){var n=this.getShadowCanvas(e);t&&(e.canvas.width=t,e.canvas.style.width=t+"px",n&&(n.width=t,n.style.width=t+"px")),r&&(e.canvas.height=r,e.canvas.style.height=r+"px",n&&(n.height=r,n.style.height=r+"px")),this.clearContext(e)},getContextElem:function(e){return e?e.canvas:null},setContextViewBox:function(e,t,r,n,o,i){},clearContext:function(e){var t=e.canvas;t.setAttribute("width",t.width);var r=this.getShadowCanvas(e);r&&(r.width=t.width);var n=e.__$clearColor__;if(n){e.save();try{var o=this.getContextDimension(e);this.drawRect(e,{x:0,y:0},{x:o.width,y:o.height},{fillColor:n,strokeColor:n})}finally{e.restore()}}},setClearColor:function(e,t){e&&(e.__$clearColor__=t)},renderContext:function(e){var t=this.getShadowCanvas(e);t&&e.drawImage(t,0,0)},transformContextCoordToScreen:function(e,t){return t},transformScreenCoordToContext:function(e,t){return t},canModifyGraphic:function(e){return!1},_drawDashLine:function(e,t,r,n){null==n&&(n=5),e.moveTo(t.x,t.y);for(var o=r.x-t.x,i=r.y-t.y,a=Math.floor(Math.sqrt(o*o+i*i)/n),s=o/a,d=i/a,l=0,u=t.x,c=t.y;l++<a;)u+=s,c+=d,e[l%2==0?"moveTo":"lineTo"](u,c);e[l%2==0?"moveTo":"lineTo"](r.x2,r.y)},drawLine:function(e,t,r,n){var o=this.getOperatingContext(e);o.beginPath(),this.setDrawStyle(o,n),n.strokeDash&&!this.isLineDashSupported(o)?this._drawDashLine(o,t,r,n.strokeDash):(o.moveTo(t.x,t.y),o.lineTo(r.x,r.y)),this.doneDraw(o,n)},drawTriangle:function(e,t,r,n,o){var i=this.getOperatingContext(e);i.beginPath(),this.setDrawStyle(i,o),i.moveTo(t.x,t.y),i.lineTo(r.x,r.y),i.lineTo(n.x,n.y),i.closePath(),this.doneDraw(i,o)},drawRect:function(e,t,r,n){var o=this.getOperatingContext(e);o.beginPath(),this.setDrawStyle(o,n),o.rect(t.x,t.y,r.x-t.x,r.y-t.y),this.doneDraw(o,n)},drawRoundRect:function(e,t,r,n,o){return this.drawRect(e,t,r,o)},drawCircle:function(e,t,r,n){var o=this.getOperatingContext(e);o.beginPath(),this.setDrawStyle(o,n),o.arc(t.x,t.y,r,0,2*Math.PI,!1),this.doneDraw(o,n)},drawArc:function(e,t,r,n,o,i,a){var s=this.getOperatingContext(e);s.beginPath(),this.setDrawStyle(s,a),s.arc(t.x,t.y,r,n,o,i),this.doneDraw(s,a)},_PATH_CMDS:["M","Z","L","C","Q"],_PATH_METHODS:["moveTo","closePath","lineTo","bezierCurveTo","quadraticCurveTo"],drawPath:function(e,t,r){var n=this.getOperatingContext(e);if(!(t.length<=0)){var o;n.beginPath(),this.setDrawStyle(n,r);for(var i=0,a=t.length;i<a;++i){o=[];var s=t[i],d=s.method.toUpperCase(),l=this._PATH_CMDS.indexOf(d);if(l>=0){var u=this._PATH_METHODS[l];o=s.params,n[u].apply(n,o)}}this.doneDraw(n,r)}},drawImage:function(e,t,r,n,o,i,a){var s=this.getOperatingContext(e),d=this.getContextElem(s).ownerDocument.createElement("img");d.src=t;var l=this;d.onload=function(){try{l.setDrawStyle(s,o);var t=e;a&&(t=a()),(t=l.getOperatingContext(t)).drawImage(d,r.x,r.y,n.x,n.y),i&&i(!0),l.doneDraw(s,o)}catch(e){throw i&&i(!1),e}},d.src=t},drawImageElem:function(e,t,r,n,o){var i=this.getOperatingContext(e);this.setDrawStyle(i,o),i.drawImage(t,r.x,r.y,n.x,n.y),this.doneDraw(i,o)},isLineDashSupported:function(e){return Kekule.ObjUtils.isUnset(this.isLineDashSupported._cachedValue)&&(this.isLineDashSupported._cachedValue=e.setLineDash&&"number"==typeof e.lineDashOffset),this.isLineDashSupported._cachedValue},setDrawStyle:function(e,t){if(Kekule.ObjUtils.notUnset(t.strokeWidth)?e.lineWidth=t.strokeWidth:e.lineWidth=1,t.strokeColor&&(e.strokeStyle=t.strokeColor),e.lineCap=t.lineCap||"butt",e.lineJoin=t.lineJoin||"miter",this.isLineDashSupported(e))if(t.strokeDash){var r=!0===t.strokeDash?[5]:Kekule.ArrayUtils.isArray(t.strokeDash)?t.strokeDash:[t.strokeDash];e.setLineDash(r)}else e.setLineDash([]);t.fillColor?e.fillStyle=t.fillColor:e.fillStyle="transparent",Kekule.ObjUtils.notUnset(t.opacity)?e.globalAlpha=t.opacity:e.globalAlpha=1},doneDraw:function(e,t){e.stroke(),t.fillColor&&e.fill()},getCanvasFontStyle:function(e){var t="";return e.fontStyle&&(t+=e.fontStyle+" "),e.fontWeight&&(t+=e.fontWeight+" "),e.fontSize&&("string"==typeof e.fontSize?t+=e.fontSize+" ":t+=e.fontSize+"px "),e.fontFamily&&(t+=e.fontFamily+" "),t},drawText:function(e,t,r,n){var o=this.getOperatingContext(e),i=o.font,a=o.fillStyle,s=this.getCanvasFontStyle(n);this.setDrawStyle(o,n),o.font=s,n.color&&(o.fillStyle=n.color),o.textBaseline="top",o.fillText(r,t.x,t.y),o.fontStyle=i,o.fillStyle=a},canMeasureText:function(e){return!0},measureText:function(e,t,r){var n=this.getCanvasFontStyle(r);e.font=n;var o=e.measureText(t),i=r.fontSize;return"string"==typeof i&&(i=Kekule.StyleUtils.analysisUnitsValue(i).value),{width:o.width,height:i}},canMeasureDrawnText:function(e){return!1},canModifyText:function(e){return!1},createGroup:function(e){},addToGroup:function(e,t){},removeFromGroup:function(e,t){},exportToDataUri:function(e,t,r){var n=this.getContextElem(e);return n?n.toDataURL(t,r):null}}),Kekule.Render.CanvasRendererBridge.isSupported=function(){var e=!1,t=Kekule.$jsRoot.document;return t&&t.createElement&&(e=!!t.createElement("canvas").getContext),e},Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.CanvasRendererBridge,20),this.Raphael&&(Raphael.fn.line=function(e,t,r,n){return this.path("M"+e+" "+t+" L"+r+" "+n)},Raphael.fn.arrowLine=function(e,t,r,n,o){if(!o)return this.line(e,t,r,n);var i=this.set(),a=r-e,s=n-t,d=Math.atan(s/a),l=(o.width||6)/2,u=o.length||3,c=Math.atan(l/u),h=Math.sqrt(Math.sqr(l)+Math.sqr(u));return i.push(this.path("M"+r+" "+n+" L"+(r-h*Math.cos(d-c))+" "+(n-h*Math.sin(d-c))+" M"+r+" "+n+" L"+(r-h*Math.cos(d+c))+" "+(n-h*Math.sin(d+c))),this.path("M"+e+" "+t+" L"+r+" "+n)),i},Raphael.fn.triangle=function(e,t,r,n,o,i){return this.path("M"+e+" "+t+" L"+r+" "+n+" L"+o+" "+i+" L"+e+" "+t)},Raphael.fn.polygon=function(e){for(var t="M"+e[0].x+" "+e[0].y,r=1,n=e.length;r<n;++r)t+=" L"+e[r].x+" "+e[r].y;return t+="L"+e[0].x+" "+e[0].y,this.path(t)},Raphael.el.translateCoord=function(e){if(this.forEach)this.forEach(function(t){t.translateCoord(e)});else{var t=this.attr(["x","y"]);void 0!==t.x&&void 0!==t.y&&this.attr({x:t.x+e.x,y:t.y+e.y})}return this},Raphael.st.translateCoord=function(e){return this.forEach&&this.forEach(function(t){t.translateCoord(e)}),this},Raphael.st.remove=function(e){this.forEach(function(e){e.remove()},this),this.clear()}),Kekule.Render.RaphaelRendererBridge=Class.create({CLASS_NAME:"Kekule.Render.RaphaelRendererBridge",createContext:function(e,t,r){return Raphael(e,t,r)},releaseContext:function(e){e.remove()},getContextDimension:function(e){return{width:e.width,height:e.height}},setContextDimension:function(e,t,r){e.setSize(t,r),this.clearContext(e)},clearContext:function(e){e.clear();var t=e.__$clearColor__;if(t){var r=this.getContextDimension(e);this.drawRect(e,{x:0,y:0},{x:r.width,y:r.height},{fillColor:t,strokeColor:t})}},setClearColor:function(e,t){e&&(e.__$clearColor__=t)},getContextElem:function(e){return e?e.canvas:null},transformContextCoordToScreen:function(e,t){return t},transformScreenCoordToContext:function(e,t){return t},canModifyGraphic:function(e){return!0},drawPath:function(e,t,r){for(var n="",o=0,i=t.length;o<i;++o){var a=t[o];if(n+=a.method,a.params&&a.params.length)for(var s=0,d=a.params.length;s<d;++s)n+=0===s?"":",",DataType.isArrayValue(a.params[s])?n+=a.params[s].join(","):n+=a.params[s]}var l=e.path(n);return this.setBasicElemAttribs(l,r),l},drawLine:function(e,t,r,n){var o=e.line(t.x,t.y,r.x,r.y);return this.setBasicElemAttribs(o,n),o},drawTriangle:function(e,t,r,n,o){var i=e.triangle(t.x,t.y,r.x,r.y,n.x,n.y);return this.setBasicElemAttribs(i,o),i},drawRect:function(e,t,r,n){var o=e.rect(t.x,t.y,r.x-t.x,r.y-t.y);return this.setBasicElemAttribs(o,n),o},drawRoundRect:function(e,t,r,n,o){var i=e.rect(t.x,t.y,r.x-t.x,r.y-t.y,n);return this.setBasicElemAttribs(i,o),i},drawCircle:function(e,t,r,n){var o=e.circle(t.x,t.y,r);return this.setBasicElemAttribs(o,n),o},drawArc:function(e,t,r,n,o,i,a){var s=Kekule.GeometryUtils.polarToCartesian,d=Kekule.GeometryUtils.standardizeAngle,l=(Kekule.CoordUtils,s(t.x,t.y,r,o)),u=s(t.x,t.y,r,n),c=d(n,0),h=d(o,0)-c,g=d(h)<=Math.PI&&!i||d(h)>Math.PI&&i?"0":"1",f=i?"1":"0",C=["M",l.x,l.y,"A",r,r,0,g,f,u.x,u.y].join(" "),R=e.path(C);return this.setBasicElemAttribs(R,a),R},drawImage:function(e,t,r,n,o,i){try{var a=e.image(t,r.x,r.y,n.x,n.y);this.setBasicElemAttribs(a,o),i&&i(!0)}catch(e){throw i&&i(!1),e}return a},drawImageElem:function(e,t,r,n,o){return this.drawImage(e,t.src,r,n,o)},setBasicElemAttribs:function(e,t){if(Kekule.ObjUtils.notUnset(t.strokeWidth)&&e.attr("stroke-width",t.strokeWidth),t.strokeColor&&e.attr("stroke",t.strokeColor),t.strokeDash){e.attr("stroke-dasharray","- ")}t.fillColor&&e.attr("fill",t.fillColor),t.opacity&&e.attr({"stroke-opacity":t.opacity,"fill-opacity":t.opacity}),t.lineCap&&e.attr("stroke-linecap",t.linecap),t.lineJoin&&e.attr("stroke-linejoin",t.linejoin)},getRaphaelFontStyle:function(e){var t={};return e.fontStyle&&(t["font-style"]=e.fontStyle),e.fontWeight&&(t["font-weight"]=e.fontWeight),e.fontSize&&(t["font-size"]=e.fontSize+"px"),e.fontFamily&&(t["font-family"]=e.fontFamily),t},drawText:function(e,t,r,n){r.endsWith(" ")&&(r=r.substring(0,r.length-1)+" "),r.startsWith(" ")&&(r=" "+r.substr(1));var o=this.getRaphaelFontStyle(n),i=e.text(-1e4,-1e4,r);return i.attr(o),n.color&&i.attr({stroke:n.color,fill:n.color}),this.modifyDrawnTextCoord(e,i,t),this.setBasicElemAttribs(i,n),i},canMeasureText:function(e){return!1},canMeasureDrawnText:function(e){return!0},canModifyText:function(e){return!0},measureDrawnText:function(e,t,r){var n=Kekule.oneOf,o=t.getBBox(),i={};return i.width=n(o.width,o.x2-o.x1),i.height=n(o.height,o.y2-o.y1),i},modifyDrawnTextCoord:function(e,t,r){var n=this.measureDrawnText(e,t,null);t.attr({x:r.x+n.width/2,y:r.y+n.height/2})},createGroup:function(e){return e.set()},addToGroup:function(e,t){return t.push(e)},removeFromGroup:function(e,t){return e!==t&&t.exclude(e)},removeDrawnElem:function(e,t){t.remove()},exportToDataUri:function(e,t,r){if(e.toSVG){var n=e.toSVG();return"data:image/svg+xml;base64,"+btoa(n)}if(e.canvas&&"svg"===e.canvas.tagName.toLowerCase()){n=DataType.XmlUtility.serializeNode(e.canvas);return"data:image/svg+xml;base64,"+btoa(n)}}}),Kekule.Render.RaphaelRendererBridge.isSupported=function(){var e=!1;return Kekule.$jsRoot.Raphael&&(e=!(!Raphael.svg&&!Raphael.vml)),e},Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.RaphaelRendererBridge,10),function(){var e=Kekule.ObjUtils,t=Kekule.BoxUtils,r=Kekule.Render.Molecule3DDisplayType,n=Kekule.Render.Bond3DRenderMode,o=Kekule.Render.Bond3DRenderType,i=Kekule.Render.Bond3DSpliceMode,a=Kekule.Render.Node3DRenderMode,s=Kekule.oneOf;Kekule.Render.Abstract3DDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.Abstract3DDrawBridge",getGraphicQualityLevel:function(){return null},setGraphicQualityLevel:function(e){},transformContextCoordToScreen:function(e,t){return{x:t.x,y:t.y}},canModifyGraphic:function(e){return!1},createContext:function(e,t,r){return null},getContextDimension:function(e){return{}},setContextDimension:function(e,t,r){return null},clearContext:function(e){return null},setClearColor:function(e,t){},drawSphere:function(e,t,r,n){},drawCylinder:function(e,t,r,n,o){},drawLine:function(e,t,r,n){},createDrawGroup:function(e){},addToDrawGroup:function(e,t){},removeFromDrawGroup:function(e,t){},getCameraProps:function(e){},setCameraProps:function(e,t){},exportToDataUri:function(e,t,r){}}),Kekule.Render.Base3DRenderer=Class.create(Kekule.Render.CompositeRenderer,{CLASS_NAME:"Kekule.Render.Base3DRenderer",initialize:function($super,e,t,r){$super(e,t,r)},getRendererType:function(){return Kekule.Render.RendererType.R3D},getActualTargetContext:function(e){return this.getRedirectContext()||e},getCameraProps:function(e){return this.getDrawBridge().getCameraProps(e)},setCameraProps:function(e,t){return this.getDrawBridge().setCameraProps(e,t)},getInitialLightPositions:function(e){return this.getDrawBridge().getInitialLightPositions&&this.getDrawBridge().getInitialLightPositions(e)},getLightCount:function(e){return this.getDrawBridge().getLightCount&&this.getDrawBridge().getLightCount(e)},getLightProps:function(e,t){return this.getDrawBridge().getLightProps&&this.getDrawBridge().getLightProps(e,t)},setLightProps:function(e,t,r){return this.getDrawBridge().setLightProps(e,t,r)},drawSphere:function(e,t,r,n){return this.getDrawBridge().drawSphere(this.getActualTargetContext(e),t,r,n)},drawCylinder:function(e,t,r,n,o){var i=this.getDrawBridge();return i?i.drawCylinder(this.getActualTargetContext(e),t,r,n,o):null},drawCylinderEx:function(e,t,r,n,o){var i=null,a=this.drawCylinder(e,t,r,n,o);if(a&&o.withEndCaps){i=this.createDrawGroup(e);var s=this.drawSphere(e,t,n);this.addToDrawGroup(s,i);s=this.drawSphere(e,r,n);this.addToDrawGroup(s,i)}return i||a},drawParallelCylinders:function(e,t,r){var n=this.getDrawBridge();if(n.drawParallelCylinders)return n.drawParallelCylinders(this.getActualTargetContext(e),t,r);for(var o=this.createDrawGroup(e),i=0,a=t.length;i<a;++i){var s=t[i],d=this.drawCylinderEx(e,s.coord1,s.coord2,s.radius,{color:s.color,withEndCaps:r});d&&this.addToDrawGroup(d,o)}return o},drawLine:function(e,t,r,n){var o=this.getDrawBridge();return o?o.drawLine(this.getActualTargetContext(e),t,r,n):null},drawParallelLines:function(e,t,r){var n=this.getDrawBridge();if(n.drawParallelLines)return n.drawParallelLines(this.getActualTargetContext(e),t,r);if(n.drawLine){for(var o,i=t.length,a=[],s=0;s<i;++s){var d=t[s],l=this.drawLine(e,d.coord1,d.coord2,{lineWidth:d.lineWidth,color:d.color,opacity:d.opacity});l&&a.push(l)}if(a.length<=1)o=a[0];else{o=this.createDrawGroup(e);s=0;for(var u=a.length;s<u;++s)this.addToDrawGroup(a[s],o)}return o}},createDrawGroup:function(e){return this.getDrawBridge().createGroup(this.getActualTargetContext(e))},addToDrawGroup:function(e,t){return this.getDrawBridge().addToGroup(e,t)},removeFromDrawGroup:function(e,t){return this.getDrawBridge().removeFromGroup(e,t)},removeDrawnElem:function(e,t){}}),Kekule.Render.ChemObj3DRenderer=Class.create(Kekule.Render.Base3DRenderer,{CLASS_NAME:"Kekule.Render.ChemObj3DRenderer",initialize:function($super,e,t,r){$super(e,t,r),this._enableTransformByCamera=!0},doEstimateSelfObjBox:function(e,t,r){return Kekule.Render.ObjUtils.getContainerBox(this.getChemObj(),this.getCoordMode(),r)},doEstimateRenderBox:function(e,r,n,o){var i=this.estimateObjBox(e,n,o);if(i){var a=this.prepareTransformParams(e,r,n,i);return t.transform3D(i,a)}return null},beginDraw:function($super,e,t,r){if($super(e,t,r),this.isRootRenderer()){var n=this.getDrawBridge();if(n&&n.setGraphicQualityLevel){var o=r.graphicQuality;n.setGraphicQualityLevel(o)}}},endDraw:function($super,e,t,r){this.isRootRenderer()&&this.adjustCamera(e,r.transformParams),$super(e,t,r)},doDraw:function($super,e,t,r){return this.prepareTransformParams(e,t,r),$super(e,t,r)},changeGeometryOptions:function(e,t,r){var n=Object.create(r);this.prepareTransformParams(e,t,n).pureCameraTransform?this.endDraw(e,t,n):(this.getDrawBridge().clearContext(e),this.draw(e,t,r))},prepareTransformParams:function(e,t,r,n){var o;if(r.transformParams)o=r.transformParams;else{var i=this.generateTransformParams(e,t,r,n);r.transformParams=i,o=i}var a=Kekule.CoordUtils.calcTransform3DMatrix(o),s=Kekule.CoordUtils.calcInverseTransform3DMatrix(o);return r.transformParams.transformMatrix=a,r.transformParams.invTransformMtrix=s,this.getRenderCache(e).transformParams=o,this.getRenderCache(e).transformMatrix=a,this.getRenderCache(e).invTransformMatrix=s,this.getRenderCache(e).transformParams=o,o},canDoPureCameraTransform:function(e,t){return this._enableTransformByCamera&&t.scaleX===t.scaleY&&t.scaleY===t.scaleZ&&!t.rotateAngle&&!t.rotateX&&!t.rotateY&&!t.rotateZ},generateTransformParams:function(t,r,n,o){var i={};i.allowCoordBorrow=s(n.allowCoordBorrow,!1),i.unitLength=n.unitLength||1,o||(o=this.estimateObjBox(t,n,i.allowCoordBorrow)),o||(o={x1:0,x2:1,y1:0,y2:1,z1:0,z2:1});var a={x:(o.x1+o.x2)/2,y:(o.y1+o.y2)/2,z:(o.z1+o.z2)/2},d=Kekule.ObjUtils;d.isUnset(n.translateX)&&d.isUnset(n.translateY)&&d.isUnset(n.translateZ)?r&&(i.translateX=r.x-a.x,i.translateY=r.y-a.y,i.translateZ=r.z||0-a.z||0):(i.translateX=n.translateX||0,i.translateY=n.translateY||0,i.translateZ=n.translateZ||0),i.zoom=n.zoom||1,i.scaleX=s(n.scaleX,n.scale,1),i.scaleY=s(n.scaleY,n.scale,1),i.scaleZ=s(n.scaleZ,n.scale,1);n.scaleX||n.scaleY||n.scaleZ||n.scale;e.notUnset(n.rotateMatrix)?i.rotateMatrix=n.rotateMatrix:e.notUnset(n.rotateAngle)&&e.notUnset(n.rotateAxisVector)?i.rotateMatrix=Kekule.CoordUtils.calcRotate3DMatrix({rotateAngle:n.rotateAngle,rotateAxisVector:n.rotateAxisVector}):(i.rotateX||i.rotateY||i.rotateZ)&&(i.rotateMatrix=Kekule.CoordUtils.calcRotate3DMatrix({rotateX:n.rotateX||0,rotateY:n.rotateY||0,rotateZ:n.rotateZ||0})),d.isUnset(n.center)&&(i.center=a),i.drawBaseCoord=r||Kekule.CoordUtils.transform3D(a,i);var l=Object.extend({},i);(i=this.getFinalTransformParams(t,i)).initialTransformOptions=l;var u=this.canDoPureCameraTransform(t,i);if(i.pureCameraTransform=u,this.isRootRenderer()&&(n.autofit||!n.cameraPos)){var c=this.getAutofitObjBoxInflation(t,this.getChemObj(),n),h=Kekule.BoxUtils.inflateBox(o,c.x,c.y,c.z),g=Math.max(h.x2-h.x1,h.y2-h.y1),f=this.getCameraProps(t),C=g/2/Math.tan(f.fov/2),R=Math.sqrt(Math.sqr(C)-Math.sqr(g/2));if(u){R/=i.scaleX,i.cameraWidth=g/i.scaleX,i.cameraHeight=i.cameraWidth;var p,D,x,m,T=Kekule.MatrixUtils.create(4,1,[0,0,1,1]),O=Kekule.MatrixUtils.create(4,1,[0,1,1,1]);if(i.rotateMatrix){var y=Kekule.MatrixUtils.transpose(i.rotateMatrix);p=Kekule.MatrixUtils.multiply(y,T),x=Kekule.MatrixUtils.multiply(y,O),D={x:p[0],y:p[1],z:p[2]},m={x:x[0],y:x[1],z:x[2]}}else D={x:0,y:0,z:1},m={x:0,y:1,z:1};D=Kekule.CoordUtils.multiply(D,R),i.cameraPos={x:D.x,y:D.y,z:D.z},i.cameraPos=Kekule.CoordUtils.add(i.cameraPos,i.drawBaseCoord),i.cameraUp=m,i.scaleX=i.scaleY=i.scaleZ=1;var E=this.getInitialLightPositions(t);if(y){var k=this.getLightCount(t);if(E&&E.length&&k)for(var v=Math.min(E.length,k),S=[],b=0;b<v;++b){var A=E[b];if(A){var _=Kekule.MatrixUtils.create(4,1,[A.x,A.y,A.z,1]),L=Kekule.MatrixUtils.multiply(y,_),K={x:L[0],y:L[1],z:L[2]};S.push(K)}}}i.lightPositions=S||E,i.rotateMatrix=null}else i.cameraPos={x:i.drawBaseCoord.x,y:i.drawBaseCoord.y,z:R+i.drawBaseCoord.z},i.cameraUp={x:0,y:1,z:1};i.cameraLookAtVector=i.drawBaseCoord||{x:0,y:0,z:0};var w={x:-i.translateX,y:-i.translateY,z:-i.translateZ};i.translateX=i.translateY=i.translateZ=0,i.cameraPos=Kekule.CoordUtils.add(i.cameraPos,w),i.cameraLookAtVector=Kekule.CoordUtils.add(i.cameraLookAtVector,w)}return i},getFinalTransformParams:function(e,t){var r=Object.create(t);return r.zoom&&(r.scaleX*=r.zoom,r.scaleY*=r.zoom,r.scaleZ*=r.zoom),1!==r.unitLength&&(r.translateX*=r.unitLength,r.translateY*=r.unitLength,r.translateZ*=r.unitLength,r.drawBaseCoord&&(r.drawBaseCoord=Kekule.CoordUtils.multiply(r.drawBaseCoord,r.unitLength))),r},getRenderFinalTransformParams:function(e){return this.getRenderCache(e).transformParams},getRenderInitialTransformOptions:function(e){var t=this.getRenderFinalTransformParams(e);return t?t.initialTransformOptions:null},getAutofitObjBoxInflation:function(e,t,r){var n=r.fixedNodeRadius||0;return{x:n,y:n,z:n}},adjustCamera:function(e,t){var r=t.cameraWidth,n=t.cameraHeight,o={position:t.cameraPos,upVector:t.cameraUp,lookAtVector:t.cameraLookAtVector};if(r&&n){var i=r/2,a=n/2;o.left=-i,o.right=i,o.top=a,o.bottom=-a}this.setCameraProps(e,o),this.adjustLights(e,t)},adjustLights:function(e,t){for(var r=t.lightPositions||[],n=0,o=r.length;n<o;++n){var i=r[n];i&&this.setLightProps(e,n,{position:i})}}}),Kekule.Render.ChemCtab3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemCtab3DRenderer",TRANSFORM_COORD_FIELD:"__$transCoord3D__",DRAW_ELEM_FIELD:"__$drawElem__",DRAW_COLOR_FIELD:"__$drawColor__",BASE_RADIUS_FIELD:"__$baseRadius__",TRANSFORM_MATRIX_FIELD:"__$transMatrix__",INV_TRANSFORM_MATRIX_FIELD:"__$inverseTransMatrix__",CHILD_TRANSFORM_MATRIX_FIELD:"__$childTransMatrix__",HIDDEN_NODES_FIELD:"__$hiddenNodes__",HIDDEN_CONNECTORS_FIELD:"__$hiddenConnectors__",getObjDrawElem:function(e,t){return this.getExtraProp2(e,t,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(e,t,r){this.setExtraProp2(e,t,this.DRAW_ELEM_FIELD,r)},getObjDrawColor:function(e,t){return this.getExtraProp2(e,t,this.DRAW_COLOR_FIELD)},setObjDrawColor:function(e,t,r){this.setExtraProp2(e,t,this.DRAW_COLOR_FIELD,r)},getNodeBaseRadius:function(e,t){return this.getExtraProp2(e,t,this.BASE_RADIUS_FIELD)},setNodeBaseRadius:function(e,t,r){this.setExtraProp2(e,t,this.BASE_RADIUS_FIELD,r)},getHiddenNodes:function(e){return this.getExtraProp(e,this.HIDDEN_NODES_FIELD)||[]},setHiddenNodes:function(e,t){return this.setExtraProp(e,this.HIDDEN_NODES_FIELD,t)},getHiddenConnectors:function(e){return this.getExtraProp(e,this.HIDDEN_CONNECTORS_FIELD)||[]},setHiddenConnectors:function(e,t){return this.setExtraProp(e,this.HIDDEN_CONNECTORS_FIELD,t)},doEstimateSelfObjBox:function(e,t,r){return this.getChemObj().getExposedContainerBox3D(r)},doPrepare:function(e,t,o,i){var s,d,l=i,u=this.getRenderCache(e);switch(l.moleculeDisplayType){case r.WIRE:s=a.NONE,d=l.displayMultipleBond?n.MULTI_WIRE:n.WIRE;break;case r.STICKS:s=a.NONE,d=l.displayMultipleBond?n.MULTI_CYLINDER:n.CYLINDER;break;case r.SPACE_FILL:s=a.SPACE,d=n.NONE;break;case r.BALL_STICK:default:s=a.BALL,d=l.displayMultipleBond?n.MULTI_CYLINDER:n.CYLINDER}u.nodeRenderMode=s,u.connectorRenderMode=d,u.options=l;var c=t.getExposedNodes(),h=t.getExposedConnectors();return this.prepareHiddenObjects(e,c,h,l),this.prepareNodesDrawColor(e,c,l),this.prepareNodeBaseRadii(e,c,l),l},prepareHiddenObjects:function(e,t,r,n){var o=[];this.setHiddenNodes(e,o);for(var i=0,a=t.length;i<a;++i){var s=t[i];n.hideHydrogens&&s instanceof Kekule.Atom&&1===s.getAtomicNumber()&&o.push(s)}var d=[];this.setHiddenConnectors(e,d);for(i=0,a=r.length;i<a;++i){var l=r[i],u=l.getConnectedExposedObjs();Kekule.ArrayUtils.exclude(u,o)<2&&d.push(l)}},prepareNodesDrawColor:function(e,t,r){for(var n=r.useAtomSpecifiedColor,o=0,i=t.length;o<i;++o){var a=t[o],d=a.getOverriddenRender3DOptions()||{},l=d.color||d.atomColor;if(l&&!d.useAtomSpecifiedColor);else if(n||d.useAtomSpecifiedColor){var u=a.getAtomicNumber?a.getAtomicNumber():0;l=u>=0?Kekule.Render.RenderColorUtils.getColor(u,this.getRendererType()):Kekule.Render.RenderColorUtils.getColor(a.getClassLocalName(),this.getRendererType())}else l=s(d.color||r.atomColor);this.setObjDrawColor(e,a,l)}},prepareNodeBaseRadii:function(e,t,r){for(var n=0,o=t.length;n<o;++n){var i,a=t[n];i=this.calcNodeBaseRadius(a,r),this.setNodeBaseRadius(e,a,i)}},calcNodeBaseRadius:function(e,t){var r,n=e.getOverriddenRender3DOptions()||{},o=e.getAtomicNumber?e.getAtomicNumber():null;if(n.nodeRadius||t.nodeRadius)r=n.nodeRadius||t.nodeRadius;else if(s(n.useVdWRadius,t.useVdWRadius)&&o){r=Kekule.ChemicalElementsDataUtil.getElementProp(o,"radiiVdw")||n.fixedNodeRadius||t.fixedNodeRadius}else r=s(n.fixedNodeRadius,t.fixedNodeRadius);return r},doDrawSelf:function($super,e,t,r){$super(e,t,r);var n=this.getChemObj(),o=r.transformParams;this.getRenderCache(e).transformOptions=o,this.transformCtabCoords3DToContext(e,n,o);var i=this.doPrepare(e,n,t,r);return this.doDrawCore(e,n,i,o)},doRedraw:function(e){var t=this.getRenderCache(e);return this.doDrawCore(e,this.getChemObj(),t.options,t.transformOptions)},doDrawCore:function(e,t,r,n){var o=this.createDrawGroup(e);return this.doDrawConnectors(e,o,t,r,n),this.doDrawNodes(e,o,t,r,n),this.setObjDrawElem(e,t,o),o},transformCtabCoords3DToContext:function(e,t,r){var n=r.allowCoordBorrow;r.scaleX=r.scaleX||r.scale,r.scaleY=r.scaleY||r.scale,r.scaleZ=r.scaleZ||r.scale;var o=Object.extend({},r);o.centerX=0,o.centerY=0;var i=r.transformMatrix;this.setExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD,i);var a=i;this.setExtraProp2(e,t,this.CHILD_TRANSFORM_MATRIX_FIELD,i);var s=r.invTransformMatrix;this.setExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD,s);for(var d=0,l=t.getNodeCount();d<l;++d){var u=t.getNodeAt(d);this.transformObjCoord3DToContext(e,u,i,a,n)}},transformObjCoord3DToContext:function(e,t,r,n,o){var i,a;if(t&&t.getAbsBaseCoord3D){if(a=t.getAbsBaseCoord3D(o)){var s=Kekule.CoordUtils.transform3DByMatrix(a,r);this.setTransformedCoord3D(e,t,s),i=s}if(t.getNodes)for(var d=0,l=t.getNodeCount();d<l;++d)this.transformObjCoord3DToContext(e,t.getNodeAt(d),n,n,o)}return i},getTransformedCoord3D:function(e,t,r){Kekule.ObjUtils.isUnset(r)&&(r=this.getRenderCache(e).options.transformParams.allowCoordBorrow);var n=t instanceof Kekule.BaseStructureNode&&this.getExtraProp2(e,t,this.TRANSFORM_COORD_FIELD);if(!n){var o=this.getChemObj(),i=this.getExtraProp2(e,o,this.TRANSFORM_MATRIX_FIELD),a=this.getExtraProp2(e,o,this.CHILD_TRANSFORM_MATRIX_FIELD);n=o&&(o.hasNode(t,!1)||o.hasConnector(t,!1))?this.transformObjCoord3DToContext(t,i,a,r):this.transformObjCoord3DToContext(t,a,a,r)}return n},setTransformedCoord3D:function(e,t,r){this.setExtraProp2(e,t,this.TRANSFORM_COORD_FIELD,r)},doTransformCoordToObj:function(e,t,r){var n=this.getExtraProp2(e,t,this.INV_TRANSFORM_MATRIX_FIELD);return Kekule.CoordUtils.transform3DByMatrix(r,n)},doTransformCoordToContext:function(e,t,r){var n=this.getExtraProp2(e,t,this.TRANSFORM_MATRIX_FIELD);return Kekule.CoordUtils.transform3DByMatrix(r,n)},doDrawNodes:function(e,t,r,n,o){for(var i=r.getExposedNodes(),a=this.getHiddenNodes(e),s=0,d=i.length;s<d;++s){var l=i[s];if(!(a.indexOf(l)>=0))this.doDrawNode(e,t,l,r,n,o)}},doDrawNode:function(e,t,r,n,o,i){var s,d,l,u=this.getRenderCache(e).nodeRenderMode;if(u===a.NONE)return null;d=Kekule.Render.RenderOptionUtils.mergeObjLocalRender3DOptions(r,o),l=this.getNodeBaseRadius(e,r),Kekule.ObjUtils.isUnset(l)&&(l=this.calcNodeBaseRadius(r,o)),u===a.SPACE?l*=i.scaleX:l*=d.nodeRadiusRatio*i.scaleX;var c=this.getObjDrawColor(e,r),h=this.getTransformedCoord3D(e,r,i.allowCoordBorrow);s=this.drawSphere(e,h,l,{color:c,opacity:d.opacity});var g=this.createSphereBoundInfo(h,l);this.basicDrawObjectUpdated(e,r,n,g,Kekule.Render.ObjectUpdateType.ADD),s&&(this.setObjDrawElem(e,r,s),t&&this.addToDrawGroup(s,t))},doDrawConnectors:function(e,t,r,o,i){if(this.getRenderCache(e).connectorRenderMode===n.NONE)return null;for(var a=r.getExposedConnectors(),s=this.getHiddenConnectors(e),d=0,l=a.length;d<l;++d){var u=a[d];if(!(s.indexOf(u)>=0))this.doDrawConnector(e,t,u,r,o,i)}},doDrawConnector:function(e,t,r,n,o,i){var a=Object.create(o);a=Kekule.Render.RenderOptionUtils.mergeObjLocalRender3DOptions(r,o);for(var s,d,l,u,c,h=this.getHiddenNodes(e),g=r.getConnectedExposedObjs(),f=(g=Kekule.ArrayUtils.exclude(g,h)).length,C=f>2?this.createDrawGroup(e):null,R=0;R<f;++R)if(s=g[R],l=this.getTransformedCoord3D(e,s,i.allowCoordBorrow))for(var p=R+1;p<f;++p)d=g[p],(u=this.getTransformedCoord3D(e,d,i.allowCoordBorrow))&&(c=this.doDrawConnectorShape(e,r,[s,d],n,l,u,a,i))&&C&&this.addToDrawGroup(c,C);return C?this.addToDrawGroup(C,t):this.addToDrawGroup(c,t),C||c},doDrawConnectorShape:function(e,t,r,a,d,l,u,c){var h=Kekule.CoordUtils,g=t.getOverriddenRender3DOptions()||{},f=(u.unitLength,r[0]),C=r[1],R=s(g.bondSpliceMode,u.bondSpliceMode),p=R===i.MID_SPLIT?.5:null;if(R===i.WEIGHTING_SPLIT){var D=this.getNodeBaseRadius(e,f),x=this.getNodeBaseRadius(e,C);p=D&&x?D/(D+x):.5}var m=null,T=!1,O=[];if(p){var y=s(u.color||u.bondColor),E=s(g.color||g.bondColor);if(T=!1,E)O.push(E);else{var k=s(this.getObjDrawColor(e,f),y),v=s(this.getObjDrawColor(e,C),y);k!==v?(O.push(k),O.push(v),T=!0):O.push(s(k,u.color,u.bondColor,u.defBondColor))}}else O.push(s(g.color,g.bondColor,u.color,u.bondColor,u.defBondColor));if(p&&T){var S=l.x-d.x,b=l.y-d.y,A=l.z-d.z;(m={}).x=d.x+S*p,m.y=d.y+b*p,m.z=d.z+A*p}var _=T?[[d,m],[m,l]]:[[d,l]],L=this.getRenderCache(e).connectorRenderMode,K=this._getBondRenderType(t,L),w=!1,I=s(g.connectorRadius,u.connectorRadius)*s(g.connectorRadiusRatio,u.connectorRadiusRatio)*u.unitLength;I*=c.scaleX;var B=s(g.connectorLineWidth,u.connectorLineWidth)*u.unitLength;K!==o.SINGLE&&K!==o.DASH?(I*=s(g.multiConnectorRadiusRatio,u.multiConnectorRadiusRatio),w=L===n.MULTI_CYLINDER):w=!1;var M,U=[],P=1;switch(K){case o.SINGLE:P=1;break;case o.DOUBLE:P=2;break;case o.TRIPLE:P=3;break;case o.DASH:case o.SOLID_DASH:}var j=null;if((M=P)>1){var N=s(g.multiConnectorMarginRatio,u.multiConnectorMarginRatio)*I;w&&(N+=2*I);var F=h.getDistance(d,l),G=h.substract(l,d),H={x:-N*(G.y/F),y:N*(G.x/F),z:0};j=(M%2?0:.5)-Math.floor(M/2);var z=h.multiply(H,j)}for(var W=0,V=_.length;W<V;++W){if(1===M)($={}).coord1=_[W][0],$.coord2=_[W][1],T&&($.jointCoordIndex=0===W?2:1),$.color=O[W],$.radius=I,$.lineWidth=B,$.opacity=u.opacity,U.push($);else for(var Y=h.add(_[W][0],z),X=h.add(_[W][1],z),q=0;q<M;++q){var $;($={}).coord1=Y,$.coord2=X,Y=h.add(Y,H),X=h.add(X,H),T&&($.jointCoordIndex=0===W?2:1),$.color=O[W],$.radius=I,$.lineWidth=B,$.opacity=u.opacity,U.push($)}}var Q,J=L;return Q=J===n.WIRE||J===n.MULTI_WIRE?this.createLineBoundInfo(d,l,{width:B}):this.createCylinderBoundInfo(d,l,{radius:I}),this.basicDrawObjectUpdated(e,t,a,Q,Kekule.Render.ObjectUpdateType.ADD),this.doDrawConnectorSet(e,U,J,K,u)},doDrawConnectorSet:function(e,t,r,o,i){if(r===n.WIRE||r===n.MULTI_WIRE)return this.drawParallelLines(e,t);var s=this.getRenderCache(e).nodeRenderMode===a.NONE;return this.drawParallelCylinders(e,t,s)},_getBondRenderType:function(e,t){var r=e.getOverriddenRender3DOptions()||{},n=Kekule.Render.Render3DOptionUtils.getConnectorRenderType(r);return n||Kekule.Render.ConnectorDrawUtils.getConnectorRender3DType(e,t)}}),Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.Render.ChemCtab3DRenderer),Kekule.Render.StructFragment3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.StructFragment3DRenderer",initialize:function($super,e,t,r){$super(e,t,r),this._concreteRenderer=null,e.hasCtab()?this._concreteRenderer=new Kekule.Render.ChemCtab3DRenderer(e.getCtab(),t,this):(this._concreteRenderer=null,Kekule.raise(Kekule.$L("ErrorMsg.FORMULA_RENDERER_3D_NOT_AVAILABLE"))),this._concreteRenderer.setParentRenderer(this)},finalize:function($super){$super(),this._concreteRenderer&&this._concreteRenderer.finalize()},getRenderCache:function(e){return this._concreteRenderer.getRenderCache(e)},_getConcreteRendererDrawOptions:function(e){var t=Object.create(e),r=this.getChemObj(),n=this.getRendererType()===Kekule.Render.RendererType.R3D?r.getOverriddenRender3DOptions():r.getOverriddenRenderOptions();return t=Object.extend(t,n||{})},isChemObjRenderedBySelf:function($super,e,t){return $super(e,t)||t===this.getChemObj()||this._concreteRenderer.isChemObjRenderedBySelf(e,t)},isChemObjRenderedDirectlyBySelf:function($super,e,t){return $super(e,t)||t===this.getChemObj()},doSetRedirectContext:function($super,e){$super(e),this._concreteRenderer.setRedirectContext(e)},doDrawSelf:function($super,e,t,r){return $super(e,t,r),this._concreteRenderer.draw(e,t,this._getConcreteRendererDrawOptions(r))},doRedraw:function(e){return this._concreteRenderer.redraw(e)},doUpdateSelf:function(e,t,r){if(this._extractObjsOfUpdateObjDetails(t).indexOf(this.getChemObj())>=0){var n=this.getRenderCache(e);return this.doClear(e),this.draw(e,n.baseCoord,n.options)}return this._concreteRenderer.doUpdate(e,t,r)},doClearSelf:function(e){var t=this._concreteRenderer;if(t)return t.clear(e)},estimateRenderBox:function(e,t,r){return this._concreteRenderer.estimateRenderBox(e,this._getConcreteRendererDrawOptions(t),r)},getChildObjs:function($super){var e=this.getChemObj();if(e&&e.getAttachedMarkers){for(var t=[],r=(e.getExposedNodes()||[]).concat(e.getExposedConnectors()||[]),n=0,o=r.length;n<o;++n){var i=r[n];t=t.concat(i.getAttachedMarkers()||[])}return t.concat($super())}return $super()},_needWholelyDraw:function($super,e,t){var r=$super(e,t);if(!r){for(var n=this.getChemObj(),o=!1,i=0,a=e.length;i<a;++i){if(e[i].isChildOf(n)){o=!0;break}}r=o}return r},transformCoordToObj:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToObj(e,n,r)},transformCoordToContext:function(e,t,r){var n=this.getChemObj()===t?this._concreteChemObj:t;return this._concreteRenderer.transformCoordToContext(e,n,r)}}),Kekule.Render.Mol3DRenderer=Kekule.Render.StructFragment3DRenderer,Kekule.Render.CompositeObj3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.CompositeObj3DRenderer"}),Kekule.Render.CompositeMolecule3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule3DRenderer",getChildObjs:function($super){for(var e=[],t=this.getChemObj().getSubMolecules(),r=0,n=t.getItemCount();r<n;++r){var o=t.getObjAt(r);e.push(o)}return e.concat($super())}}),Kekule.Render.ChemObjGroupList3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemObjGroupList3DRenderer",getChildObjs:function($super){var e=this.getChemObj();if(e instanceof Kekule.ChemObjList)for(var t=[],r=0,n=e.getItemCount();r<n;++r)t.push(e.getItemAt(r));else e instanceof Kekule.ChemStructureObjectGroup&&(t=e.getAllObjs());return(t||[]).concat($super())}}),Kekule.Render.ChemSpaceElement3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpaceElement3DRenderer",getChildObjs:function($super){return(this.getChemObj().getChildren().toArray()||[]).concat($super())}}),Kekule.Render.ChemSpace3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpace3DRenderer",getChildObjs:function($super){return[this.getChemObj().getRoot()].concat($super())}}),Kekule.Render.Renderer3DFactory.register(Kekule.StructureFragment,Kekule.Render.StructFragment3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.CompositeMolecule,Kekule.Render.CompositeMolecule3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemObjList,Kekule.Render.ChemObjGroupList3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemStructureObjectGroup,Kekule.Render.ChemObjGroupList3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemSpaceElement,Kekule.Render.ChemSpaceElement3DRenderer),Kekule.Render.Renderer3DFactory.register(Kekule.ChemSpace,Kekule.Render.ChemSpace3DRenderer)}(),Kekule.$jsRoot.THREE&&(THREE.Object3D.prototype.clear=function(){for(var e=this.children,t=e.length-1;t>=0;t--){var r=e[t];r.clear(),this.remove(r)}},THREE.Scene.prototype.clearMesh=function(){for(var e=this.children,t=e.length-1;t>=0;t--){var r=e[t];(r instanceof THREE.Mesh||r instanceof THREE.Line||r.__objGroup__)&&(r.clear(),this.remove(r))}}),Kekule.Render.ThreeObjectCache=Class.create({CLASS_NAME:"Kekule.Render.ThreeObjectCache",initialize:function(){this.cache=new Kekule.MapEx(!0)},finalize:function(){this.cache.finalize(),this.cache=null},createInstance:function(e,t){return null},isSameParams:function(e,t){if(e.length!==t.length)return!1;for(var r=0,n=e.length;r<n;++r)if(!this.isParamEqual(e[r],t[r]))return!1;return!0},isParamEqual:function(e,t){var r=e===t;return r||DataType.isObjectValue(e)&&DataType.isObjectValue(t)&&(r=Kekule.ObjUtils.equal(e,t)),r},add:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),r=this.cache.get(t);r||(r=[],this.cache.set(t,r));var n={params:e};return n.instance=this.createInstance(t,e),r.push(n),n.instance},get:function(){var e=Array.prototype.slice.call(arguments),t=e[0],r=this.cache.get(t);if(r){e.shift();for(var n=0,o=r.length;n<o;++n){var i=r[n].params;if(this.isSameParams(i,e))return r[n].instance}e.unshift(t)}return this.add.apply(this,e)}}),Kekule.Render.ThreeGeometryCache=Class.create(Kekule.Render.ThreeObjectCache,{CLASS_NAME:"Kekule.Render.ThreeGeometryCache",createInstance:function(e,t){var r=null,n=t;n[0];switch(e){case THREE.SphereGeometry:r=new THREE.SphereGeometry(n[1],n[2],n[3]);break;case THREE.CylinderGeometry:r=new THREE.CylinderGeometry(n[1],n[2],n[3],n[4],n[5],n[6])}return r}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.ThreeGeometryCache),Kekule.Render.ThreeMaterialCache=Class.create(Kekule.Render.ThreeObjectCache,{CLASS_NAME:"Kekule.Render.ThreeMaterialCache",createInstance:function(e,t){return new e(t[1])}}),Kekule.ClassUtils.makeSingleton(Kekule.Render.ThreeMaterialCache),Kekule.Render.ThreeContext=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.ThreeContext",initialize:function($super,e,t,r,n){$super(),this.setScene(e),this.setCamera(t),this.setLights(r),this.setRenderer(n)},initProperties:function(){this.defineProp("scene",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("camera",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("lights",{dataType:DataType.ARRAY,serializable:!1}),this.defineProp("renderer",{dataType:DataType.OBJECT,serializable:!1}),this.defineProp("width",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("height",{dataType:DataType.INT,serializable:!1,setter:null})},getDimension:function(){return{width:this.getWidth(),height:this.getHeight()}},setDimension:function(e,t){this.setPropStoreFieldValue("width",e),this.setPropStoreFieldValue("height",t),this.getRenderer().setSize(e,t);var r=this.getCamera();r instanceof THREE.OrthographicCamera?(r.left=e/-2,r.right=e/2,r.top=t/2,r.bottom=t/-2):r.aspect=e/t,r.updateProjectionMatrix()}}),Kekule.Render.ThreeRendererBridge=Class.create({CLASS_NAME:"Kekule.Render.ThreeRendererBridge",_qualitySettings:[null,{sphereSegments:6,sphereRings:6,cylinderSegmentsRadius:6},{sphereSegments:8,sphereRings:8,cylinderSegmentsRadius:8},{sphereSegments:16,sphereRings:16,cylinderSegmentsRadius:16},{sphereSegments:32,sphereRings:32,cylinderSegmentsRadius:32},{sphereSegments:64,sphereRings:64,cylinderSegmentsRadius:64}],initialize:function(){this.geometryCache=Kekule.Render.ThreeGeometryCache.getInstance(),this.materialCache=Kekule.Render.ThreeMaterialCache.getInstance(),this._quality=null,this._modelParams={},this._webglEnabled=!0},finalize:function(){this.geometryCache=null,this.materialCache=null},getGraphicQualityLevel:function(){return this._quality},setGraphicQualityLevel:function(e){this._webglEnabled?this._quality=e:this._quality=Kekule.Render.Render3DGraphicQuality.EXTREME_LOW,this._modelParams=this.calcModelParams(this._quality)},_updateGraphicQualityLevel:function(){this._webglEnabled||this.setGraphicQualityLevel(Kekule.Render.Render3DGraphicQuality.EXTREME_LOW)},calcModelParams:function(e){var t=this._qualitySettings[e];return t||(t=this._qualitySettings[Kekule.Render.Render3DGraphicQuality.MEDIUM]),t},getInitialLightPositions:function(e){return[{x:5,y:5,z:10}]},createContext:function(e,t,r){var n=Kekule.BrowserFeature,o=n.webgl?new THREE.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0}):n.canvas?new THREE.CanvasRenderer:new THREE.SVGRenderer,i=new THREE.PerspectiveCamera;i.fov=5,this._webglEnabled=o instanceof THREE.WebGLRenderer,this._updateGraphicQualityLevel();var a=new THREE.Scene;a.add(i),o.setSize(t,r);for(var s=this.getInitialLightPositions(),d=[],l=0,u=s.length;l<u;++l){var c=new THREE.DirectionalLight(13421772,1,10,!0),h=s[l];c.position.set(h.x,h.y,h.z),a.add(c),d.push(c)}c=new THREE.AmbientLight(2105376);a.add(c),e.appendChild(o.domElement);var g=new Kekule.Render.ThreeContext(a,i,d,o);return g.setDimension(t,r),g},releaseContext:function(e){var t=this.getContextElem(e);e.finalize(),t&&t.parentNode.removeChild(t)},getContextElem:function(e){return e?e.getRenderer().domElement:null},getContextDimension:function(e){return{width:e.getWidth(),height:e.getHeight()}},setContextDimension:function(e,t,r){e.setDimension(t,r)},transformContextCoordToScreen:function(e,t){var r=e.getDimension();return{x:t.x+r.width/2,y:t.y+r.height/2}},transformScreenCoordToContext:function(e,t){var r=e.getDimension();return{x:t.x-r.width/2,y:t.y-r.height/2,z:0}},canModifyGraphic:function(e){return!0},colorStrToHex:function(e){return Kekule.StyleUtils.colorStrToValue(e)},createGroup:function(e){var t=new THREE.Object3D;return t.__objGroup__=!0,e.getScene().add(t),t},addToGroup:function(e,t){return t.add(e),t},removeFromGroup:function(e,t){t.remove(e)},setClearColor:function(e,t){var r=e.getRenderer();r&&(r.setClearColorHex?t?e.getRenderer().setClearColorHex(this.colorStrToHex(t),1):e.getRenderer().setClearColorHex(null,0):r.setClearColor&&(t?e.getRenderer().setClearColor(this.colorStrToHex(t),1):e.getRenderer().setClearColor(null,0)))},clearContext:function(e){e.getScene().clearMesh(),this.renderContext(e)},renderContext:function(e){e.getRenderer().render(e.getScene(),e.getCamera())},drawSphere:function(e,t,r,n){var o=this._modelParams.sphereSegments,i=this._modelParams.sphereRings,a=this.geometryCache.get(THREE.SphereGeometry,e.getScene(),1,o,i),s=this.materialCache.get(THREE.MeshLambertMaterial,e.getScene(),{color:this.colorStrToHex(n.color),opacity:n.opacity||1}),d=new THREE.Mesh(a,s);return d.scale.x=r,d.scale.y=r,d.scale.z=r,d.position.x=t.x,d.position.y=t.y,d.position.z=t.z,e.getScene().add(d),d},drawLine:function(e,t,r,n){this.colorStrToHex(n.color);var o=this.materialCache.get(THREE.LineBasicMaterial,e.getScene(),{color:this.colorStrToHex(n.color),opacity:n.opacity||1,linewidth:n.lineWidth||1}),i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(t.x,t.y,t.z)),i.vertices.push(new THREE.Vector3(r.x,r.y,r.z));var a=new THREE.Line(i,o);return e.getScene().add(a),a},drawCylinder:function(e,t,r,n,o){var i=Kekule.CoordUtils,a=this._modelParams.cylinderSegmentsRadius,s=i.getDistance(t,r),d=this.geometryCache.get(THREE.CylinderGeometry,e.getScene(),1,1,1,a,1,!0),l=this.materialCache.get(THREE.MeshLambertMaterial,e.getScene(),{color:this.colorStrToHex(o.color),opacity:o.opacity||1}),u=new THREE.Mesh(d,l);u.scale.y=s,u.scale.x=n,u.scale.z=n;var c=Kekule.ObjUtils.isUnset(o.quaternion)?this._calcQuaternion(t,r):o.quaternion;return c&&(u.applyQuaternion?u.applyQuaternion(c):(u.useQuaternion=!0,u.quaternion=c,u.updateMatrix())),u.position.x=(t.x+r.x)/2,u.position.y=(t.y+r.y)/2,u.position.z=(t.z+r.z)/2,e.getScene().add(u),u},drawParallelCylinders:function(e,t,r){Kekule.CoordUtils;for(var n=t[0],o=this._calcQuaternion(n.coord1,n.coord2),i=this.createGroup(e),a=0,s=t.length;a<s;++a){var d=t[a],l=this.drawCylinder(e,d.coord1,d.coord2,d.radius,{color:d.color,quaternion:o,opacity:d.opacity});this.addToGroup(l,i)}if(r){var u;for(a=0,s=t.length;a<s;++a){d=t[a];for(var c=0,h=(u=Kekule.ObjUtils.isUnset(d.jointCoordIndex)?[d.coord1,d.coord2]:1===d.jointCoordIndex?[d.coord2]:[d.coord1]).length;c<h;++c){l=this.drawSphere(e,u[c],d.radius,{color:d.color,opacity:d.opacity});this.addToGroup(l,i)}}}return i},removeDrawnElem:function(e,t){t.parent&&t.parent.remove&&t.parent.remove(t)},_calcQuaternion:function(e,t){var r=Kekule.CoordUtils,n=r.substract(t,e);if(n.x||n.z){var o={x:n.z,y:0,z:-n.x};o=r.standardize(o);var i=Math.atan2(Math.sqrt(Math.sqr(n.x)+Math.sqr(n.z)),n.y)/2,a=Math.cos(i),s=Math.sin(i);return new THREE.Quaternion(s*o.x,s*o.y,s*o.z,a)}return null},getLightCount:function(e){var t=e.getLights();return t&&t.length||0},getLightProps:function(e,t){return{position:e.getLights()[t].position}},setLightProps:function(e,t,r){var n=e.getLights()[t],o=r.position;o&&(n.position.x=o.x,n.position.y=o.y,n.position.z=o.z),n.updateMatrix()},getCameraProps:function(e){var t=e.getCamera();return{position:t.position,fov:t.fov*Math.PI/180,aspect:t.aspect,left:t.left,right:t.right,top:t.top,bottom:t.bottom,lookAtVector:t.lookAtVector,upVector:t.up}},setCameraProps:function(e,t){var r=e.getCamera(),n=Kekule.ObjUtils.notUnset,o=t.position;if(o&&(r.position.x=o.x,r.position.y=o.y,r.position.z=o.z),n(t.near)&&(r.near=t.near),n(t.far)&&(r.near=t.far),t.fov&&(r.fov=180*t.fov/Math.PI),t.aspect&&(r.aspect=t.aspect),n(t.left)&&(r.left=t.left),n(t.top)&&(r.top=t.top),n(t.bottom)&&(r.bottom=t.bottom),n(t.right)&&(r.right=t.right),n(t.upVector)){var i=t.upVector;r.up=new THREE.Vector3(i.x,i.y,i.z)}if(n(t.lookAtVector)){i=t.lookAtVector;r.lookAt(new THREE.Vector3(i.x,i.y,i.z))}r.updateMatrix()},exportToDataUri:function(e,t,r){var n=e.getRenderer();if(THREE.SVGRenderer&&n instanceof THREE.SVGRenderer){var o=e.getRenderer().domElement,i=DataType.XmlUtility.serializeNode(o);return"data:image/svg+xml;base64,"+btoa(i)}return(o=e.getRenderer().domElement)?o.toDataURL(t,r):null}}),Kekule.Render.ThreeRendererBridge.isSupported=function(){var e=void 0!==Kekule.$jsRoot.THREE;if(e){var t=Kekule.BrowserFeature;e=t.webgl||t.canvas||t.svg}return!!e},Kekule.Render.DrawBridge3DMananger.register(Kekule.Render.ThreeRendererBridge,20),Kekule.Render.ChemObjPainter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.ChemObjPainter",initialize:function($super,e,t,r,n){$super();var o=e||Kekule.Render.RendererType.R2D;this.setPropStoreFieldValue("renderType",o),this.setPropStoreFieldValue("chemObj",t),this.setPropStoreFieldValue("drawBridge",r||(o===Kekule.Render.RendererType.R3D?Kekule.Render.DrawBridge3DMananger.getPreferredBridgeInstance():Kekule.Render.DrawBridge2DMananger.getPreferredBridgeInstance())),n&&this.setPropStoreFieldValue("renderConfigs",n)},finalize:function($super){this.getRenderer()&&this.getRenderer().finalize(),$super()},initProperties:function(){this.defineProp("renderType",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:!1,setter:null}),this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:!1,setter:null}),this.defineProp("renderConfigs",{dataType:DataType.OBJECT,serializable:!1,getter:function(){var e=this.getPropStoreFieldValue("renderConfigs");return e||(e=this.getRenderType()===Kekule.Render.RendererType.R3D?Kekule.Render.Render3DConfigs.getInstance():Kekule.Render.Render2DConfigs.getInstance()),e}}),this.defineProp("renderer",{dateType:"Kekule.Render.AbstractRenderer",serializable:!1,setter:null}),this.defineProp("canModifyTargetObj",{dataType:DataType.BOOL}),this.defineProp("boundInfoRecorder",{dataType:"Kekule.Render.BoundInfoRecorder",serializable:!1,setter:null,getter:function(){var e=this.getRenderer();return e&&e.getBoundInfoRecorder()}})},getDrawOptionFromConfigs:function(e){return Kekule.Render.RenderOptionUtils.convertConfigsToPlainHash(e)},prepareRenderer:function(){if(this.getRenderer())return this.getRenderer();var e=(this.getRenderType()===Kekule.Render.RendererType.R3D?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass)(this.getChemObj());if(e){var t=new e(this.getChemObj(),this.getDrawBridge(),this);return this.setPropStoreFieldValue("renderer",t),t}return Kekule.error(Kekule.$L("ErrorMsg.CANNOT_FIND_SUITABLE_RENDERER_FOR_OBJ")),null},createContext:function(e,t,r){return this.getDrawBridge().createContext(e,t,r)},_convertContextBoxToScreen:function(e,t){if(!t)return{};var r=this.getDrawBridge(),n=r.transformContextCoordToScreen(e,{x:t.x1,y:t.y1}),o=r.transformContextCoordToScreen(e,{x:t.x2,y:t.y2});return Kekule.BoxUtils.createBox(n,o)},estimateObjBox:function(e,t,r){return this._generateDrawOptions(t),this.prepareRenderer(),this.getRenderer().estimateObjBox(e,t,r)},estimateRenderBox:function(e,t,r,n){var o=this._generateDrawOptions(r);return this.prepareRenderer(),this.getRenderer().estimateRenderBox(e,t,o,n)},estimateScreenBox:function(e,t,r,n){var o=this.estimateRenderBox(e,t,r,n);return o?this._convertContextBoxToScreen(e,o):null},_generateDrawOptions:function(e){var t=this.getRenderConfigs(),r=t?this.getDrawOptionFromConfigs(t):{};return r=Object.extend(r,e)},draw:function(e,t,r){this.prepareRenderer();var n=this._generateDrawOptions(r);return this.getRenderer().draw(e,t,n)},redraw:function(e){return this.getRenderer().redraw(e)},getActualRenderTransformParams:function(e){var t=this.getRenderer();return t?t.getRenderFinalTransformParams(e):null},getActualInitialRenderTransformOptions:function(e){var t=this.getRenderer();return t?t.getRenderInitialTransformOptions(e):null},changeGeometryOptions:function(e,t,r){var n=this.getRenderer();if(n&&n.changeGeometryOptions){var o=this._generateDrawOptions(r);return n.changeGeometryOptions(e,t,o)}return this.clearContext(e),this.draw(e,t,r)},supportGeometryOptionChange:function(){var e=this.getRenderer();return e&&e.changeGeometryOptions},beginUpdatePainter:function(){return this.getRenderer().beginUpdateRenderer()},endUpdatePainter:function(){return this.getRenderer().endUpdateRenderer()},update:function(e,t,r){return this.getRenderer().update(e,t,r)},addNew:function(e,t){return this.getRenderer().addNew(e,t)},modify:function(e,t){return this.getRenderer().modify(e,t)},remove:function(e,t){return this.getRenderer().remove(e,t)},clear:function(e){var t=this.getRenderer();return t&&t.clear(e),this},clearContext:function(e){return this.getDrawBridge().clearContext(e)}}),Kekule.Render.ChemObjPainter2D=Class.create(Kekule.Render.ChemObjPainter,{CLASS_NAME:"Kekule.Render.ChemObjPainter2D",initialize:function($super,e,t,r){$super(Kekule.Render.RendererType.R2D,e,t,r)}}),Kekule.Render.ChemObjPainter3D=Class.create(Kekule.Render.ChemObjPainter,{CLASS_NAME:"Kekule.Render.ChemObjPainter3D",initialize:function($super,e,t,r){$super(Kekule.Render.RendererType.R3D,e,t,r)}});