Kekule.TextLinesBuffer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.TextLinesBuffer",LINEBREAK:"\n",initialize:function($super,a){$super();this.setPropStoreFieldValue("lines",[]);if(a){if(typeof(a)=="string"){this.setText(a)}else{this.setLines(a)}}this.setCurrLineNo(0)},initProperties:function(){this.defineProp("lines",{dataType:DataType.ARRAY,serializable:false});this.defineProp("text",{dataType:DataType.STRING,serializable:false,getter:function(){return this.getLines().join(this.LINEBREAK)},setter:function(a){this.setPropStoreFieldValue("lines",[]);this.reset();this.appendText(a)}});this.defineProp("currLineNo",{dataType:DataType.INT,serializable:false})},getUnreadLines:function(){var a=[].concat(this.getLines());a.splice(0,this.getCurrLineNo());return a},getUnreadText:function(){return this.getUnreadLines().join(this.LINEBREAK)},appendText:function(b){var a=b.split(this.LINEBREAK);this.appendLines(a)},appendLines:function(a){this.setPropStoreFieldValue("lines",this.getLines().concat(a));this.notifyPropSet("lines",this.getPropStoreFieldValue("lines"))},clear:function(){this.setLines([]);this.setCurrLineNo(0)},incCurrLineNo:function(b){if((b===null)||(typeof(b)=="undefined")){b=1}var a=this.getCurrLineNo();a+=b;this.setCurrLineNo(a)},getLineAt:function(a){var b=this.getLines()[a];if(b&&b.length&&(b.charAt(b.length-1)==="\r")){b=b.substring(0,b.length-1)}return b},getCurrLine:function(){return this.getLineAt(this.getCurrLineNo())},readLine:function(){var a=this.getLineAt(this.getCurrLineNo());this.incCurrLineNo();return a},writeLine:function(b){var a=this.getLines();a.splice(this.getCurrLineNo(),0,b);this.incCurrLineNo()},writeLines:function(b){for(var c=0,a=b.length;c<a;++c){this.writeLine(b[c])}},writeText:function(b){var a=b.split(this.LINEBREAK);this.writeLines(a)},eof:function(){return this.getCurrLineNo()>=this.getLines().length},reset:function(){this.setCurrLineNo(0)}});(function(){Kekule.globalOptions.add("IO",{});Kekule.IO={};Kekule.IO.ChemDataType={TEXT:"text",DOM:"dom",JSON:"json",BINARY:"bin",OTHER:"other",UNKNOWN:"unknown",isBinaryType:function(b){var c=Kekule.IO.ChemDataType;return(!b)||(b===c.BINARY)||(b===c.OTHER)||(b===c.UNKNOWN)}};Kekule.IO.DataFormat={};Kekule.IO.MimeType={TEXT:"text/plain",HTML:"text/html",XML:"text/xml",JSON:"application/json",JAVASCRIPT:"application/javascript",GIF:"image/gif",JPEG:"image/jpeg",PNG:"image/png",XPNG:"image/x-png",OCTSTREAM:"application/octet-stream"};Kekule.IO.DataFormatsManager={_formats:{},register:function(b,c,e,g,f,h,i){var j=null;if(!j){j=a._formats[b]}if(!j){j={id:b};a._formats[b]=j}j.mimeType=c;var d=DataType.isArrayValue(e)?e:[e];if(!j.fileExts){j.fileExts=d}else{Kekule.ArrayUtils.pushUnique(j.fileExts,d)}if(g&&(g!==Kekule.IO.ChemDataType.UNKNOWN)){j.dataType=g}j.title=f;j.description=h;if(i){j=Object.extend(j,i)}return j},unregister:function(b){if(a._formats[b]){delete a._formats[b]}},getAllIds:function(){return Kekule.ObjUtils.getOwnedFieldNames(a._formats)},getFormatInfo:function(b){return a._formats[b]||null},getMimeType:function(c){var b=a.getFormatInfo(c);return b?b.mimeType:null},getFileExts:function(c){var b=a.getFormatInfo(c);return b?b.fileExts:null},findFormat:function(h,d){if(!h&&!d){return null}var f=a.getAllIds();var b=false;for(var e=0,c=f.length;e<c;++e){var g=a.getFormatInfo(f[e]);b=(h&&(h===g.mimeType));if(!b){b=(d&&(g.fileExts.indexOf(d)>=0))}if(b){return g}}return null},findFormatId:function(d,b){var c=Kekule.IO.DataFormatsManager.findFormat(d,b);return c?c.id:null}};var a=Kekule.IO.DataFormatsManager;Kekule.IO.dataFormatsManager=Kekule.IO.DataFormatsManager;Kekule.IO.ChemDataReader=Class.create(ObjectEx,{initialize:function($super,b){$super()},CLASS_NAME:"Kekule.IO.ChemDataReader",readData:function(g,d,i,e){if(!d){var f=Kekule.IO.DataFormatsManager.getFormatInfo(i);d=f?f.dataType:null;if(!d){d=(typeof(g)==="string")?Kekule.IO.ChemDataType.TEXT:(g.getElementsByTagName?Kekule.IO.ChemDataType.DOM:Kekule.IO.ChemDataType.BINARY)}}var b=this.doReadData(g,d,i,e||{});if((b instanceof Kekule.ChemObject)&&(b.getSrcInfo)){var h=b.getSrcInfo();h.data=g;h.dataType=d;var c=Kekule.IO.DataFormatsManager.getFormatInfo(i);if(c){h.format=i;h.mimeType=c.mimeType;h.possibleFileExts=c.fileExts}}return b},doReadData:function(d,b,e,c){}});Kekule.IO.ChemDataWriter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.IO.ChemDataWriter",initialize:function($super,b){$super()},writeData:function(f,b,e,c){if(!b){var d=Kekule.IO.DataFormatsManager.getFormatInfo(e);b=d?d.dataType:null}return this.doWriteData(f,b,e,c||{})},doWriteData:function(e,b,d,c){}});Kekule.IO.ChemDataReaderManager={_readers:[],register:function(f,d,e,b){if(!f||!d||!e||(DataType.isArrayValue(e)&&!e.length)){return}if(Kekule.IO.ChemDataReaderManager.getReaderInfoById(f)){Kekule.raise(Kekule.$L("ErrorMsg.READER_ID_ALREADY_EXISTS"));return null}var c={id:f,readerClass:d,formatId:DataType.isArrayValue(e)?e:[e]};c=Object.extend(c,b);Kekule.IO.ChemDataReaderManager._readers.push(c);return c},getAllReadableFormatIds:function(){var b=[];var e=Kekule.IO.ChemDataReaderManager._readers;for(var d=0,c=e.length;d<c;++d){var f=e[d];var g=f.formatId;Kekule.ArrayUtils.pushUnique(b,g)}return b},getAllReadableFormats:function(){var b=[];var e=Kekule.IO.ChemDataReaderManager.getAllReadableFormatIds();for(var d=0,c=e.length;d<c;++d){var f=a.getFormatInfo(e[d]);if(f){b.push(f)}}return b},getAvailableReaderInfos:function(e){var b=[];var c=Kekule.IO.ChemDataReaderManager._readers;for(var d=c.length-1;d>=0;--d){if(Kekule.ObjUtils.match(c[d],e)){b.push(c[d])}}return b},getReaderInfo:function(d){var b=Kekule.IO.ChemDataReaderManager._readers;for(var c=b.length-1;c>=0;--c){if(Kekule.ObjUtils.match(b[c],d)){return b[c]}}return null},getReaderInfoById:function(b){return Kekule.IO.ChemDataReaderManager.getReaderInfo({id:b})},getReaderInfoByFormat:function(e,b){var c=Kekule.IO.ChemDataReaderManager._readers;for(var d=c.length-1;d>=0;--d){if((!b)||Kekule.ObjUtils.match(c[d],b)){if(c[d].formatId.indexOf(e)>=0){return c[d]}}}return null},getReaderInfoByFileExt:function(c,b){var d=Kekule.IO.DataFormatsManager.findFormatId(null,c);return d?Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(d,b):null},createReaderOfInfo:function(b){return new b.readerClass(b.createOptions)},getReaderOfInfo:function(b){if(!b.instance){b.instance=Kekule.IO.ChemDataReaderManager.createReaderOfInfo(b)}return b.instance},createReader:function(c){var b=Kekule.IO.ChemDataReaderManager.getReaderInfo(c);if(b){return Kekule.IO.ChemDataReaderManager.createReaderOfInfo(b)}},getReader:function(c){var b=Kekule.IO.ChemDataReaderManager.getReaderInfo(c);if(b){return Kekule.IO.ChemDataReaderManager.getReaderOfInfo(b)}},createReaderById:function(b){return Kekule.IO.ChemDataReaderManager.createReader({id:b})},getReaderById:function(b){return Kekule.IO.ChemDataReaderManager.getReader({id:b})},createReaderByFormat:function(d,b){var c=Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(d,b);return c?IO.ChemDataReaderManager.createReaderOfInfo(c):null},getReaderByFormat:function(d,b){var c=Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(d,b);return c?Kekule.IO.ChemDataReaderManager.getReaderOfInfo(c):null},createReaderByFileExt:function(c,b){var d=Kekule.IO.ChemDataReaderManager.getReaderInfoByFileExt(c,b);return d?Kekule.IO.ChemDataReaderManager.createReaderOfInfo(d):null},getReaderByFileExt:function(c,b){var d=Kekule.IO.ChemDataReaderManager.getReaderInfoByFileExt(c,b);return d?Kekule.IO.ChemDataReaderManager.getReaderOfInfo(d):null},createReaderByMimeType:function(c){var b=Kekule.IO.DataFormatsManager.findFormatId(c,null);return b?Kekule.IO.ChemDataReaderManager.createReaderByFormat(b):null},getReaderByMimeType:function(c){var b=Kekule.IO.DataFormatsManager.findFormatId(c,null);return b?Kekule.IO.ChemDataReaderManager.getReaderByFormat(b):null}};Kekule.IO.ChemDataWriterManager={_writers:[],register:function(g,b,c,f,d){if(!g||!b||!f||(DataType.isArrayValue(f)&&!f.length)){return}if(Kekule.IO.ChemDataWriterManager.getWriterInfoById(g)){Kekule.raise(Kekule.$L("ErrorMsg.WRITER_ID_ALREADY_EXISTS"));return null}var e={id:g,writerClass:b,srcClasses:c,formatId:DataType.isArrayValue(f)?f:[f]};e=Object.extend(e,d);Kekule.IO.ChemDataWriterManager._writers.push(e);return e},getAllWritableFormatIds:function(){var b=[];var e=Kekule.IO.ChemDataWriterManager._writers;for(var d=0,c=e.length;d<c;++d){var f=e[d];var g=f.formatId;Kekule.ArrayUtils.pushUnique(b,g)}return b},getAllWritableFormats:function(){var b=[];var e=Kekule.IO.ChemDataWriterManager.getAllWritableFormatIds();for(var d=0,c=e.length;d<c;++d){var f=a.getFormatInfo(e[d]);if(f){b.push(f)}}return b},getAvailableWriterInfos:function(l,g){var b=[];var h=ClassEx.isClass(g)?g:g.getClass?g.getClass():g?null:undefined;var c=Kekule.IO.ChemDataWriterManager._writers;for(var f=c.length-1;f>=0;--f){if(Kekule.ObjUtils.match(c[f],l)){if(h!==undefined){if(h){for(var e=0,d=c[f].srcClasses.length;e<d;++e){if(ClassEx.isOrIsDescendantOf(h,c[f].srcClasses[e])){b.push(c[f])}}}}else{b.push(c[f])}}}return b},getWriterInfo:function(g,e){var b=Kekule.IO.ChemDataWriterManager._writers;for(var f=b.length-1;f>=0;--f){if(Kekule.ObjUtils.match(b[f],g)){if(e){for(var d=0,c=b[f].srcClasses.length;d<c;++d){if(e instanceof b[f].srcClasses[d]){return b[f]}}return null}else{return b[f]}}}return null},getWriterInfoById:function(c,b){return Kekule.IO.ChemDataWriterManager.getWriterInfo({id:c},b)},getWriterInfoByFormat:function(h,b,f){var c=Kekule.IO.ChemDataWriterManager._writers;for(var g=c.length-1;g>=0;--g){if((!b)||Kekule.ObjUtils.match(c[g],b)){if(c[g].formatId.indexOf(h)>=0){if(f){for(var e=0,d=c[g].srcClasses.length;e<d;++e){if(f instanceof c[g].srcClasses[e]){return c[g]}}return null}return c[g]}}}return null},getWriterInfoByFileExt:function(d,b,c){var e=Kekule.IO.DataFormatsManager.findFormatId(null,d);return e?Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(e,b,c):null},createWriterOfInfo:function(b){return new b.writerClass(b.createOptions)},getWriterOfInfo:function(b){if(!b.instance){b.instance=Kekule.IO.ChemDataWriterManager.createWriterOfInfo(b)}return b.instance},createWriter:function(d,b){var c=Kekule.IO.ChemDataWriterManager.getWriterInfo(d,b);if(c){return Kekule.IO.ChemDataWriterManager.createWriterOfInfo(c)}else{return null}},getWriter:function(d,b){var c=Kekule.IO.ChemDataWriterManager.getWriterInfo(d,b);if(c){return Kekule.IO.ChemDataWriterManager.getWriterOfInfo(c)}else{return null}},createWriterById:function(c,b){return Kekule.IO.ChemDataWriterManager.createWriter({id:c},b)},getWriterById:function(c,b){return Kekule.IO.ChemDataWriterManager.getWriter({id:c},b)},createWriterByFormat:function(e,b,c){var d=Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(e,b,c);return d?Kekule.IO.ChemDataWriterManager.createWriterOfInfo(d):null},getWriterByFormat:function(e,b,c){var d=Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(e,b,c);return d?Kekule.IO.ChemDataWriterManager.getWriterOfInfo(d):null},createWriterByFileExt:function(d,b,c){var e=Kekule.IO.ChemDataWriterManager.getWriterInfoByFileExt(d,b,c);return e?Kekule.IO.ChemDataWriterManager.createWriterOfInfo(e):null},getWriterByFileExt:function(d,b,c){var e=Kekule.IO.ChemDataWriterManager.getWriterInfoByFileExt(d,b,c);return e?Kekule.IO.ChemDataWriterManager.getWriterOfInfo(e):null},createWriterByMimeType:function(d,b){var c=Kekule.IO.DataFormatsManager.findFormatId(d,null);return c?Kekule.IO.ChemDataWriterManager.createWriterByFormat(c,null,b):null},getWriterByMimeType:function(c){var b=Kekule.IO.DataFormatsManager.findFormatId(c,null);return b?Kekule.IO.ChemDataWriterManager.getWriterByFormat(b,null,srcObj):null}};Kekule.IO.loadFormatData=function(e,g,d){var c=Kekule.IO.ChemDataReaderManager.getReaderByFormat(g);if(c){var b=c.readData(e,null,g,d);if(!b){var f=Kekule.$L("ErrorMsg.FAIL_TO_READ_FORMAT")+g;Kekule.raise(f)}return b}else{var f=Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FORMAT")+g;Kekule.raise(f);return null}};Kekule.IO.loadMimeData=function(c,d,b){return Kekule.IO.loadTypedData(c,d,null,b)};Kekule.IO.loadTypedData=function(f,c,b,h){var i;if(b){i=Kekule.UrlUtils.extractFileExt(b)}var g=Kekule.IO.DataFormatsManager.findFormatId(c,c?null:i);var j;if(g){j=Kekule.IO.loadFormatData(f,g,h)}if(j){if((j instanceof Kekule.ChemObject)&&(j.getSrcInfo)){var e=j.getSrcInfo();if(c){e.mimeType=c}if(i){e.fileExt=i}if(b){e.url=b;e.fileName=b}}return j}else{var d=c?(Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_MIMETYPE")+c):(Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FILEEXT")+i);Kekule.raise(d);return null}};Kekule.IO.loadFileData=function(e,i,h,k){if(Kekule.BrowserFeature.fileapi){var f=e.name;var c=Kekule.UrlUtils.extractFileExt(f);var j;if(!h){j=Kekule.IO.DataFormatsManager.findFormat(null,c)}else{j=Kekule.IO.DataFormatsManager.getFormatInfo(h)}if(!j){var d=Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FILEEXT")+c;Kekule.raise(d);return}var b=Kekule.IO.ChemDataType.isBinaryType(j.dataType);var g=new FileReader();g.onload=function(n){var l=g.result;var p=Kekule.IO.loadFormatData(l,j.id,k);var m=p.getSrcInfo();m.fileName=f;var o=!!p;i(p,o)};if(b){g.readAsArrayBuffer(e)}else{g.readAsText(e)}}else{Kekule.error(Kekule.$L("ErrorMsg.FILE_API_NOT_SUPPORTED"))}};Kekule.IO.loadUrlData=function(b,e,d,c){if(Kekule.Ajax){Kekule.Ajax.sendRequest(b,function(k,f,n){if(k&&n){var l;if(d){l=Kekule.IO.DataFormatsManager.getFormatInfo(d)}if(!d){var g=Kekule.Ajax.getResponseMimeType(f);l=Kekule.IO.DataFormatsManager.findFormat(g)}if(!d){var h=Kekule.UrlUtils.extractFileExt(b);l=Kekule.IO.DataFormatsManager.findFormat(null,h)}if(!l){var j=Kekule.$L("ErrorMsg.NO_SUITABLE_READER_FOR_FILEEXT")+h;Kekule.raise(j);return}var m=Kekule.IO.loadFormatData(k,l.id,c);var i=m.getSrcInfo();i.fileName=b;var n=!!m;e(m,n)}else{Kekule.raise(Kekule.$L("ErrorMsg.FAIL_TO_LOAD_FILE_URL")+b)}})}else{Kekule.raise(Kekule.$L("ErrorMsg.AJAX_FILELOADER_NOT_FOUND"));return null}};Kekule.IO.saveFormatData=function(g,f,c){var d=Kekule.IO.ChemDataWriterManager.getWriterByFormat(f,null,g);if(d){var b=d.writeData(g,null,f,c);return b}else{var e=Kekule.$L("ErrorMsg.NO_SUITABLE_WRITER_FOR_FORMAT")+f;Kekule.raise(e);return null}};Kekule.IO.saveMimeData=function(d,c,b){return Kekule.IO.saveTypedData(d,c,null,b)};Kekule.IO.saveTypedData=function(i,h,e,d){var c;if(e){c=Kekule.UrlUtils.extractFileExt(e);if(!c){c=e}}var g=Kekule.IO.DataFormatsManager.findFormatId(h,h?null:c);var b;if(g){b=Kekule.IO.saveFormatData(i,g,d)}if(Kekule.ObjUtils.isUnset(b)){var f=h?(Kekule.$L("ErrorMsg.NO_SUITABLE_WRITER_FOR_MIMETYPE")+h):(Kekule.$L("ErrorMsg.NO_SUITABLE_WRITER_FOR_FILEEXT")+c);Kekule.raise(f);return null}else{return b}}})();Kekule.globalOptions.add("IO.cml",{prettyPrint:true});Kekule.IO.CML={CML2CORE_NAMESPACE_URI:"http://www.xml-cml.org/schema/cml2/core",CML3_SCHEMA_NAMESPACE_URI:"http://www.xml-cml.org/schema",ARRAY_VALUE_DELIMITER:" ",TYPED_ELEM_NAMES:["string","integer","float"],TYPED_ARRAY_ELEM_NAMES:["stringArray","integerArray","floatArray"],ATOMS_REF_ATTRIBS:["atomRef","atomRefs2","atomRefs3","atomRefs4","atomRefs","atomRefArray"],BONDS_REF_ATTRIBS:["bondRef","bondRefs","bondRefArray"]};Kekule.IO.CML.LEGAL_CORE_NAMESPACE_URIS=[Kekule.IO.CML.CML2CORE_NAMESPACE_URI,Kekule.IO.CML.CML3_SCHEMA_NAMESPACE_URI];Kekule.IO.CmlUtils={cmlBondOrderToKekule:function(b){var a=parseInt(b);if(a!==a){switch(b.toUpperCase()){case"A":a=Kekule.BondOrder.EXPLICIT_AROMATIC;break;case"D":a=Kekule.BondOrder.DOUBLE;break;case"T":a=Kekule.BondOrder.TRIPLE;break;case"S":default:a=Kekule.BondOrder.SINGLE;break}}return a},kekuleBondOrderToCml:function(a){switch(a){case Kekule.BondOrder.EXPLICIT_AROMATIC:return"A";case Kekule.BondOrder.QUAD:return"4";case Kekule.BondOrder.DOUBLE:return"D";case Kekule.BondOrder.TRIPLE:return"T";default:return"S"}},cmlBondStereoToKekule:function(b){var a;switch(b.toUpperCase()){case"E":a=Kekule.BondStereo.E;break;case"Z":a=Kekule.BondStereo.Z;break;case"C":a=Kekule.BondStereo.CIS;break;case"T":a=Kekule.BondStereo.TRANS;break;case"W":a=Kekule.BondStereo.UP;break;case"H":a=Kekule.BondStereo.DOWN;break;default:a=Kekule.BondStereo.NONE;break}return a},kekuleBondStereoToCml:function(a){switch(a){case Kekule.BondStereo.UP:return{value:"W"};case Kekule.BondStereo.UP_INVERTED:return{value:"W",invert:true};case Kekule.BondStereo.DOWN:return{value:"H"};case Kekule.BondStereo.DOWN_INVERTED:return{value:"H",invert:true};case Kekule.BondStereo.E:return{value:"E"};case Kekule.BondStereo.Z:return{value:"Z"};case Kekule.BondStereo.CIS:return{value:"C"};case Kekule.BondStereo.TRANS:return{value:"T"};default:return{value:null}}},reagentRoleToKekule:function(a){var b=Kekule.ReactionRole;switch(a){case"reagent":return b.REAGENT;case"catalyst":return b.CATALYST;case"solvent":return b.CATALYST;default:return a}},kekuleReagentRoleToCml:function(a){var b=Kekule.ReactionRole;switch(a){case b.REAGENT:return"reagent";case b.CATALYST:return"catalyst";case b.CATALYST:return"solvent";default:return a}},isDummyElementType:function(a){return((a=="Du")||(a=="Dummy"))},isRGroupElementType:function(a){return(a=="R")},isAtomListElementType:function(a){return(a=="L")},getNodeElementType:function(a){if(a instanceof Kekule.Atom){return a.getSymbol()}else{if(a instanceof Kekule.Pseudoatom){switch(a.getAtomType()){case Kekule.PseudoatomType.DUMMY:return"Du";case Kekule.PseudoatomType.ANY:return"A";case Kekule.PseudoatomType.HETERO:return"Q";case Kekule.PseudoatomType.CUSTOM:default:return a.getSymbol()}}else{if(a instanceof Kekule.VariableAtom){return"R"}else{if(a instanceof Kekule.StructureFragment){return"R"}else{if(a.getSymbol){return a.getSymbol()}else{return"*"}}}}}},createNodeByCmdElementType:function(c,b,a){if(Kekule.IO.CmlUtils.isDummyElementType(b)){result=new Kekule.Pseudoatom(c,Kekule.PseudoatomType.DUMMY)}else{if(Kekule.IO.CmlUtils.isRGroupElementType(b)){result=new Kekule.RGroup(c)}else{if(Kekule.IO.CmlUtils.isAtomListElementType(b)){result=new Kekule.VariableAtom(c)}else{if(Kekule.Element.isElementSymbolAvailable(b)||(b==Kekule.Element.UNSET_ELEMENT)){result=new Kekule.Atom(c,b,Math.round(a))}else{result=new Kekule.Pseudoatom(c,Kekule.PseudoatomType.CUSTOM,b)}}}}return result}};Kekule.IO.CmlDomUtils={splitCmlArrayValue:function(b){if((typeof(b)=="object")&&(b.length)){return b}var a=Kekule.StrUtils.normalizeSpace(Kekule.StrUtils.trim(b));return a.split(Kekule.IO.CML.ARRAY_VALUE_DELIMITER)},mergeToCmlArrayValue:function(a){return a.join(" ")},analysisCmlFormulaConciseValue:function(h){var f=Kekule.IO.CmlDomUtils.splitCmlArrayValue(h);var d=0;var c=f.length;var j=[];var g=null;var a;while(d<c){var b=f[d];var e=parseFloat(b);if(e!=e){if(g){j.push(g)}g={elementType:b}}else{if(g){g.count=e;j.push(g);g=null}else{if(d==c-1){a=e}}}++d}return{isotopes:j,formalCharge:a}},getCmlBuiltinElemInfo:function(c,b,a){var d;d=c.getAttribute("builtin");if((!d)&&b){if(c.getAttributeNS){d=c.getAttributeNS(b,"builtin")}else{if(a){d=a.getAttributeNS(b,"builtin",c)}}}if(d){var e=Kekule.DomUtils.getElementText(node);return{name:d,value:e}}else{return null}},readCmlTypedPropertyElem:function(c,b,a){var d;d=c.getAttribute("builtin");if((!d)&&b){if(c.getAttributeNS){d=c.getAttributeNS(b,"builtin")}else{if(a){d=a.getAttributeNS(b,"builtin",c)}}}if(d){var e=Kekule.DomUtils.getElementText(c);switch(Kekule.DomUtils.getLocalName(c)){case"float":e=parseFloat(e);break;case"integer":e=parseInt(e);break;default:}return{name:d,value:e}}else{return null}},readCmlTypedPropertyArrayElem:function(f,d,c){var g;g=f.getAttribute("builtin");if((!g)&&d){if(f.getAttributeNS){g=f.getAttributeNS(d,"builtin")}else{if(c){g=c.getAttributeNS(d,"builtin",f)}}}if(g){var h=Kekule.DomUtils.getElementText(node);var b=Kekule.IO.CmlDomUtils.splitCmlArrayValue(h);switch(Kekule.DomUtils.getLocalName(f)){case"float":for(var e=0,a=b.length;e<a;++e){b[e]=parseFloat(b[e])}break;case"integer":for(var e=0,a=b.length;e<a;++e){b[e]=parseInt(b[e])}break;default:}return{name:g,values:b}}else{return null}},hasDirectCmlTypedElemChildren:function(f,c){for(var e=0,a=Kekule.IO.CML.TYPED_ELEM_NAMES.length;e<a;++e){var b=Kekule.IO.CML.TYPED_ELEM_NAMES[e];var d=Kekule.DomUtils.getDirectChildElems(f,null,b,c);if(d.length>0){return true}}return false},hasDirectCmlTypedArrayElemChildren:function(f,c){for(var e=0,a=Kekule.IO.CML.TYPED_ARRAY_ELEM_NAMES.length;e<a;++e){var b=Kekule.IO.CML.TYPED_ARRAY_ELEM_NAMES[e];var d=Kekule.DomUtils.getDirectChildElems(f,null,b,c);if(d.length>0){return true}}return false},isCmlTypedElem:function(c,b){var a=(Kekule.IO.CML.TYPED_ELEM_NAMES.indexOf(Kekule.DomUtils.getLocalName(c))>=0);if(b){a=a&&(c.namespaceURI==b)}return a},isCmlTypedArrayElem:function(c,b){var a=(Kekule.IO.CML.TYPED_ARRAY_ELEM_NAMES.indexOf(Kekule.DomUtils.getLocalName(c))>=0);if(b){a=a&&(c.namespaceURI==b)}return a},isCmlBuiltInMarkedElem:function(c,b){var a=Kekule.DomUtils.hasAttribute(c,"builtin");if(b&&a){a=c.namespaceURI===b}return a},FILTER_TYPED_ELEM:1,FILTER_TYPEDARRAY_ELEM:2,FILTER_ALL:3,getCmlTypedElem:function(e,d,c){var f=e.namespaceURI;var a=Kekule.DomUtils.getDirectChildElemsOfAttribValues(e,[{builtin:d}],null,null,f);if(a&&(a.length>0)){for(var b=a.length-1;b>=0;--b){if((c&Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM)&&Kekule.IO.CmlDomUtils.isCmlTypedElem(a[b],f)){return a[b]}else{if((c&Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM)&&Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(a[b],f)){return a[b]}}}}return null},getCmlTypedElems:function(f,e,d){var a=[];var g=f.namespaceURI;var b=Kekule.DomUtils.getDirectChildElemsOfAttribValues(f,[{builtin:e}],null,null,g);if(b&&(b.length>0)){for(var c=b.length-1;c>=0;--c){if((d&Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM)&&Kekule.IO.CmlDomUtils.isCmlTypedElem(b[c],g)){a.push(b[c])}else{if((d&Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM)&&Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(b[c],g)){a.push(b[c])}}}}return a.length?a:null},getCmlTypedElemValue:function(d,c,b,a){if(!b){b=Kekule.IO.CmlDomUtils.FILTER_ALL}var e=Kekule.IO.CmlDomUtils.getCmlTypedElem(d,c,b);if(e){return Kekule.DomUtils.getElementText(e)}},getMultipleCmlTypedElemValues:function(h,g,f,d){if(!f){f=Kekule.IO.CmlDomUtils.FILTER_ALL}var c=Kekule.IO.CmlDomUtils.getCmlTypedElems(h,g,f);if(c){var a=[];for(var e=0,b=c.length;e<b;++e){a.push(Kekule.DomUtils.getElementText(c[e]))}return a}else{return null}},getCmlElemAttribute:function(e,d,c,b){if(!c){c=Kekule.IO.CmlDomUtils.FILTER_ALL}var a=Kekule.DomUtils.getSameNSAttributeValue(e,d,b);if((a===null)||(a===undefined)){a=Kekule.IO.CmlDomUtils.getCmlTypedElemValue(e,d,c,b)}return a},getMultipleCmlElemAttribute:function(e,d,c,b){if(!c){c=Kekule.IO.CmlDomUtils.FILTER_ALL}var a=Kekule.DomUtils.getSameNSAttributeValue(e,d,b);if((a===null)||(a===undefined)){a=Kekule.IO.CmlDomUtils.getMultipleCmlTypedElemValues(e,d,c,b)}return a},setCmlElemAttribute:function(c,b,d,a){return Kekule.DomUtils.setSameNSAttributeValue(c,b,d,a)},fetchCmlElemAttributeValuesToJson:function(d,b,k,h){if(!b){b=Kekule.IO.CmlDomUtils.FILTER_ALL}var c=d.namespaceURI;var m=Kekule.DomUtils.fetchAttributeValuesToJson(d,c,true);var j=Kekule.DomUtils.getDirectChildElems(d,null,null,c);for(var g=0,e=j.length;g<e;++g){var a=j[g];if((b&Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM)&&(Kekule.IO.CmlDomUtils.isCmlTypedElem(a,c)||Kekule.IO.CmlDomUtils.isCmlBuiltInMarkedElem(a,c))){var f=Kekule.IO.CmlDomUtils.readCmlTypedPropertyElem(a,c,h);if(f){if(m[f.name]&&k){m[f.name]+=Kekule.IO.CML.ARRAY_VALUE_DELIMITER+f.value}else{m[f.name]=f.value}}}else{if((b&Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM)&&Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(a,c)){var f=Kekule.IO.CmlDomUtils.getCmlBuiltinElemInfo(a,c,h);if(f){if(m[f.name]&&k){m[f.name]+=Kekule.IO.CML.ARRAY_VALUE_DELIMITER+f.value}else{m[f.name]=f.value}}}}}return m},isScalarElem:function(c,b){var a=(Kekule.DomUtils.getLocalName(c)=="scalar");if(b){a=a&&(c.namespaceURI==b)}return a},getCmlId:function(b,a){return Kekule.IO.CmlDomUtils.getCmlElemAttribute(b,"id",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,a)},setCmlId:function(b,c,a){return Kekule.IO.CmlDomUtils.setCmlElemAttribute(b,"id",c,a)},getCmlTitle:function(b,a){return Kekule.IO.CmlDomUtils.getCmlElemAttribute(b,"title",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,a)},setCmlTitle:function(b,c,a){return Kekule.IO.CmlDomUtils.setCmlElemAttribute(b,"title",c,a)}};Kekule.IO.CmlElementReaderFactory={_readers:{},register:function(a,d){if(Kekule.ArrayUtils.isArray(a)){for(var c=0,b=a.length;c<b;++c){Kekule.IO.CmlElementReaderFactory.register(a[c],d)}}else{Kekule.IO.CmlElementReaderFactory._readers[a]=d}},getReader:function(c){var a;if(typeof(c)!="string"){a=Kekule.DomUtils.getLocalName(c)}else{a=c}var b=Kekule.IO.CmlElementReaderFactory._readers[a];if(b){return new b()}else{return null}}};Kekule.IO.CmlElementWriterFactory={_writers:{},register:function(d,a){if(Kekule.ArrayUtils.isArray(d)){for(var c=0,b=d.length;c<b;++c){Kekule.IO.CmlElementWriterFactory.register(d[c],a)}}else{Kekule.IO.CmlElementWriterFactory._writers[d]=a}},getWriter:function(objOrTypeName){var name;if(typeof(objOrTypeName)!="string"){name=DataType.getType(objOrTypeName)}else{name=objOrTypeName}var writerClass=Kekule.IO.CmlElementWriterFactory._writers[name];if((!writerClass)&&(objOrTypeName.getClassName)){var obj=objOrTypeName;var typeNames=Kekule.ObjUtils.getOwnedFieldNames(Kekule.IO.CmlElementWriterFactory._writers);for(var i=typeNames.length-1;i>=0;--i){if(obj instanceof eval(typeNames[i])){writerClass=Kekule.IO.CmlElementWriterFactory._writers[typeNames[i]];break}}}if(writerClass){return new writerClass()}else{return null}}};Kekule.IO.CmlElementHandler=Class.create(ObjectEx,{CLASS_NAME:"Kekule.IO.CmlElementHandler",initProperties:function(){this.defineProp("domHelper",{dataType:"Kekule.DomHelper",serializable:false,getter:function(){if(!this.getPropStoreFieldValue("domHelper")){this.setPropStoreFieldValue("domHelper",new Kekule.DomHelper())}return this.getPropStoreFieldValue("domHelper")}});this.defineProp("coreNamespaceURI",{dataType:DataType.STRING,serializable:false})},matchCoreNamespace:function(a){var b;if(!a){b=""}else{if(typeof(a)!="string"){b=a.namespaceURI}else{b=a}}return((!this.getCoreNamespaceURI())&&(!b)||(this.getCoreNamespaceURI()&&(this.getCoreNamespaceURI()==b)))},copySettingsToChildHandler:function(a){a.setDomHelper(this.getDomHelper());a.setCoreNamespaceURI(this.getCoreNamespaceURI())}});Kekule.IO.CmlElementReader=Class.create(Kekule.IO.CmlElementHandler,{CLASS_NAME:"Kekule.IO.CmlElementReader",readElement:function(b,c){var a=this.doReadElement(b,c);if(a&&a.getId&&(!a.getId())){if(a.setId){var d=Kekule.IO.CmlDomUtils.getCmlId(b,this.getDomHelper);if(d){a.setId(d)}}}return a},doReadElement:function(a,b){},readChildElement:function(a,b){return this.doReadChildElement(a,b)},doReadChildElement:function(a,b){return this.doReadChildElementDef(a,b)},readChildElementDef:function(a,b){return this.doReadChildElementDef(a,b)},doReadChildElementDef:function(b,c){var a=Kekule.IO.CmlElementReaderFactory.getReader(b);if(a){this.copySettingsToChildHandler(a);return a.readElement(b,c)}else{return null}},iterateChildElements:function(d,e){var c=Kekule.DomUtils.getDirectChildElems(d,null,null,this.getCoreNamespaceURI());for(var b=0,a=c.length;b<a;++b){this.readChildElement(c[b],e)}}});Kekule.IO.CmlElementWriter=Class.create(Kekule.IO.CmlElementHandler,{CLASS_NAME:"Kekule.IO.CmlElementWriter",writeObject:function(e,b,d){if(!(b)&&(!d)){Kekule.error(Kekule.$L("ErrorMsg.CML_CAN_NOT_OUTPUT_TO_EMPTY_ELEMENT"));return null}if((!b)&&d){b=d.documentElement}else{if(!d){d=b.ownerDocument}}if(this.getDomHelper().getDocument!=d){this.getDomHelper().setDocument(d)}var c=this.doCreateElem(e,b,d);if(c){b.appendChild(c)}else{c=b}var a=this.doWriteObject(e,c)||c;if(a&&e){this.writeObjId(e,a);this.writeObjAdditionalInfo(e,a)}return a},writeObjId:function(b,a){if(b.getId&&b.getId()){Kekule.IO.CmlDomUtils.setCmlId(a,b.getId(),this.getDomHelper())}},writeScalarAttribs:function(e,c){if(e.getScalarAttribs){var d=Kekule.IO.CmlElementWriterFactory.getWriter("Kekule.Scalar");if(d){this.copySettingsToChildHandler(d);for(var b=0,a=e.getScalarAttribCount();b<a;++b){d.writeObject(e.getScalarAttribAt(b),c)}}}},writeObjInfoValues:function(c,a){if(c.getInfo){var j=c.getInfoKeys();var e;for(var d=0,b=j.length;d<b;++d){var g=j[d];var f=c.getInfoValue(j[d]);if(g&&f&&(!Kekule.IO.CmlDomUtils.getCmlElemAttribute(a,g,this.getDomHelper()))){if(!e){e=this.createChildElem("metaDataList",a)}var h=this.createChildElem("metaData",e);Kekule.IO.CmlDomUtils.setCmlElemAttribute(h,"name",g,this.getDomHelper());Kekule.IO.CmlDomUtils.setCmlElemAttribute(h,"content",DataType.StringUtils.serializeValue(f),this.getDomHelper())}}}},writeObjAdditionalInfo:function(b,a){this.writeScalarAttribs(b,a);this.writeObjInfoValues(b,a)},doCreateElem:function(b,a){},createChildElem:function(e,b,c){var d=c||this.getCoreNamespaceURI();var a=this.getDomHelper().createElementNS(d,e);if(b){b.appendChild(a)}return a},doWriteObject:function(b,a){},reportTypeMismatchError:function(a){Kekule.error(Kekule.$L("ErrorMsg.CML_ELEM_WRITER_TYPE_INPROPER").format(this.getClassName(),DataType.getType(a)))}});Kekule.IO.CmlNameReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlNameReader",initialize:function($super){$super()},doReadElement:function(d,e){var c=Kekule.DomUtils.getElementText(d);var b=Kekule.IO.CmlDomUtils.getCmlElemAttribute(d,"convention");if(c){var a={};a.name=c;if(b){a.convention=b}else{if(e.setName){e.setName(c)}}return a}return null}});Kekule.IO.CmlScalarReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlScalarReader",doReadElement:function(b,c){var a=this.readScalar(b);if(c&&c.appendScalarAttrib){c.appendScalarAttrib(a)}else{}return a},readScalar:function(f){var h=Kekule.DomUtils.fetchAttributeValuesToJson(f,this.getCoreNamespaceURI(),true);var g=Kekule.DomUtils.getElementText(f);if(g){h.value=g}if(h.value){if(h.dataType){switch(h.dataType){case"xsd:boolean":h.value=Kekule.StrUtils.strToBool(h.value);break;case"xsd:float":case"xsd:double":case"xsd:duration":case"xsd:decimal":case"xsd:integer":case"xsd:nonPositiveInteger":case"xsd:negativeInteger":case"xsd:long":case"xsd:int":case"xsd:short":case"xsd:byte":case"xsd:nonNegativeInteger":case"xsd:unsignedLong":case"xsd:unsignedInt":case"xsd:unsignedShort":case"xsd:unsignedByte":case"xsd:positiveInteger":h.value=parseFloat(h.value);if(h.errorValue){h.errorValue=parseFloat(h.errorValue)}break}}}var a;if(h){a=new Kekule.Scalar();var e=Kekule.ObjUtils.getOwnedFieldNames(h);for(var d=0,b=e.length;d<b;++d){var c=e[d];var g=h[c];switch(c){case"value":a.setValue(g);break;case"errorValue":a.setErrorValue(g);break;case"units":a.setUnit(g);break;case"title":a.setTitle(g);break;case"dictRef":a.setName(g);break;default:a.setInfoValue(c,g)}}}return a}});Kekule.IO.CmlScalarWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlScalarWriter",doCreateElem:function(b,a){return this.createChildElem("scalar",a)},doWriteObject:function(d,c){if(!(d instanceof Kekule.Scalar)){this.reportTypeMismatchError(d);return null}var b;if(!Kekule.ObjUtils.isUnset(d.getValue())){Kekule.DomUtils.setElementText(c,d.getValue());b=DataType.getType(d.getValue())}if(d.getName()){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"dictRef",d.getName(),this.getDomHelper())}if(d.getErrorValue()){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"errorValue",d.getErrorValue(),this.getDomHelper())}if(d.getUnit()){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"units",d.getUnit(),this.getDomHelper())}if(d.getTitle()){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"title",d.getTitle(),this.getDomHelper())}if(b){var a=(b==DataType.INT)?"xsd:integer":(b==DataType.FLOAT)?"xsd:float":(b==DataType.BOOL)?"xsd:boolean":null;if(a){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"datatype",a,this.getDomHelper())}}}});Kekule.IO.CmlMetaDataReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlMetaReader",doReadElement:function(a,b){var c=this.readMeta(a);if(b&&b.setInfoValue){if(c.key&&c.value){b.setInfoValue(c.key,c.value)}}else{}return c},readMeta:function(b){var c=Kekule.DomUtils.fetchAttributeValuesToJson(b,this.getCoreNamespaceURI(),true);var a={key:c.name,value:DataType.StringUtils.deserializeValue(c.content)};return a}});Kekule.IO.CmlMetaDataListReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlMetaListReader",doReadElement:function(e,g){var f=Kekule.DomUtils.getDirectChildElems(e,null,"metaData",this.getCoreNamespaceURI());for(var d=0,c=f.length;d<c;++d){var b=f[d];var a=Kekule.IO.CmlElementReaderFactory.getReader(b);if(a){this.copySettingsToChildHandler(a);a.readElement(b,g)}}}});Kekule.IO.CmlChemStructureReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlChemStructureReader",initialize:function($super){$super()},hasAtomChildren:function(c,a){var b=a.getElementsByTagNameNS(this.getCoreNamespaceURI(),"atom",c);return b.length},getAtomChildren:function(c,a){var b=a.getElementsByTagNameNS(this.getCoreNamespaceURI(),"atom",c);return b},atomInfoToJSON:function(c,b){var a;var d={};d=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(c,Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,true,b);return d},arrayedAtomInfosToJSON:function(b,n){var c=["id","atomID","elementType","isotope","hydrogenCount","formalCharge","count","xFract","yFract","zFract","x2","y2","x3","y3","z3"];var g=["id","id","elementType","isotope","hydrogenCount","formalCharge","count","xFract","yFract","zFract","x2","y2","x3","y3","z3"];var h=[];for(var m=0,d=c.length;m<d;++m){var a;var o=[];a=Kekule.IO.CmlDomUtils.getCmlElemAttribute(b,c[m],Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM,n);if(a){o=Kekule.IO.CmlDomUtils.splitCmlArrayValue(a)}for(var f=0,e=o.length;f<e;++f){if(!h[f]){h[f]={}}if(o[f]){h[f][g[m]]=o[f]}}}return h}});Kekule.IO.CmlFormulaReader=Class.create(Kekule.IO.CmlChemStructureReader,{CLASS_NAME:"Kekule.IO.CmlFormulaReader",doReadElement:function(a,b){return this.readFormula(a,this.getDomHelper())},readFormula:function(g,d){var b=new Kekule.MolecularFormula();var f=Kekule.IO.CmlDomUtils.getCmlElemAttribute(g,"formalCharge",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,d);if(f){b.setCharge(parseFloat(f))}var a=Kekule.IO.CmlDomUtils.getCmlElemAttribute(g,"concise",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,d);if(a){this.setConcise(b,a)}else{var h=Kekule.DomUtils.getDirectChildElems(g,null,null,this.getCoreNamespaceURI());for(var e=0,c=h.length;e<c;++e){switch(Kekule.DomUtils.getLocalName(h[e])){case"formula":this.readSubFormula(b,h[e],d);break;case"atomArray":this.readAtomArray(b,h[e],d);break;default:if(Kekule.IO.CmlDomUtils.isCmlTypedElem(node)||Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(node)){}else{this.readChildElementDef(node,b)}}}}return b},readConsice:function(b){var a=null;if(b){a=new Kekule.MolecularFormula();this.setConcise(a,b)}return a},setConcise:function(c,a){var b=Kekule.IO.CmlDomUtils.analysisCmlFormulaConciseValue(a);if(b.isotopes&&b.isotopes.length){this.createSectionsFromAtomAttribs(c,b.isotopes)}if(b.formalCharge){c.setCharge(b.formalCharge)}return c},readAtomArray:function(a,b,g){var d=[];var f=this.getAtomChildren(b,g);if(f.length>0){for(var e=0,c=f.length;e<c;++e){var j=f[e];var h=this.atomInfoToJSON(j,g);d.push(h)}}else{d=this.arrayedAtomInfosToJSON(b,g)}this.createSectionsFromAtomAttribs(a,d);return a},createSectionsFromAtomAttribs:function(h,g){for(var b=0,a=g.length;b<a;++b){var f=g[b].elementType;if(f){var e=Kekule.IO.CmlUtils.createNodeByCmdElementType(null,f);var c=(g[b].formalCharge)||0;var d=g[b].count;h.appendSection(e,d,c)}}},readSubFormula:function(d,c,a){var e=this.readElement(c,a);var b=Kekule.IO.CmlDomUtils.getCmlElemAttribute(c,"count",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,a);d.appendSection(e,parseFloat(b)||1,e.getCharge()||0)}});Kekule.IO.CmlFormulaWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlFormulaWriter",doCreateElem:function(b,a){return this.createChildElem("formula",a)},doWriteObject:function(b,f){if(!(b instanceof Kekule.MolecularFormula)){this.reportTypeMismatchError(b);return null}var e=[];var h=[];var g=[];for(var c=0,a=b.getSectionCount();c<a;++c){var j=b.getSectionAt(c);if(j.obj instanceof Kekule.MolecularFormula){this.createAtomArrayElem(e,h,g,f);e=[];h=[];g=[];var d=this.writeSubFormula(j.obj,j.count||1,f)}else{e.push(Kekule.IO.CmlUtils.getNodeElementType(j.obj));h.push(j.count||1);g.push(b.getSectionCharge(j)||0);if(c==a-1){this.createAtomArrayElem(e,h,g,f)}}}if(b.getCharge()){Kekule.IO.CmlDomUtils.setCmlElemAttribute(f,"formalCharge",b.getCharge(),this.getDomHelper())}},writeSubFormula:function(d,c,b){var a=this.createChildElem("formula",b);this.doWriteObject(d,a);if(c>1){Kekule.IO.CmlDomUtils.setCmlElemAttribute(a,"count",c,this.getDomHelper())}return a},createAtomArrayElem:function(e,h,g,f){if(e.length<=0){return}var m=this.createChildElem("atomArray",f);var b=Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(e);var a=Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(h);Kekule.IO.CmlDomUtils.setCmlElemAttribute(m,"elementType",b,this.getDomHelper());Kekule.IO.CmlDomUtils.setCmlElemAttribute(m,"count",a,this.getDomHelper());var j=false;for(var d=0,c=g.length;d<c;++d){if(g[d]){j=true;break}}if(j){var k=Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(h);Kekule.IO.CmlDomUtils.setCmlElemAttribute(m,"formalCharge",k,this.getDomHelper())}return m}});Kekule.IO.CmlMoleculeReader=Class.create(Kekule.IO.CmlChemStructureReader,{CLASS_NAME:"Kekule.IO.CmlMoleculeReader",initialize:function($super){$super()},initProperties:function(){this.defineProp("structureBuilder",{dataType:"Kekule.ChemStructureBuilder",serializable:false,getter:function(){if(!this.getPropStoreFieldValue("structureBuilder")){this.setPropStoreFieldValue("structureBuilder",new Kekule.ChemStructureBuilder())}return this.getPropStoreFieldValue("structureBuilder")},setter:null})},doReadElement:function(a,b){return this.readMolecule(a,this.getDomHelper())},doReadChildElement:function($super,d,e){if((Kekule.DomUtils.getLocalName(d)=="molecule")&&(this.matchCoreNamespace(d))){if(e.getSubMolecules){var a=this.readElement(d,e);if(a){var c=Kekule.IO.CmlDomUtils.getCmlElemAttribute(d,"amount",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM)||Kekule.IO.CmlDomUtils.getCmlElemAttribute(d,"count",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM);var b=c?{amount:parseFloat(c)}:null;e.getSubMolecules().appendObj(a,b)}return a}else{return null}}else{return $super(d,e)}},hasSubMolecule:function(b){var a=Kekule.DomUtils.getDirectChildElems(b,null,"molecule",this.getCoreNamespaceURI());return(a.length>0)},readMolecule:function(c,b){var a;if(this.hasSubMolecule(c)){a=new Kekule.CompositeMolecule();this.iterateChildElements(c,a)}else{a=this.readMoleculeCore(c,b)}this.readMoleculeAttribs(a,c,b);return a},readMoleculeAttribs:function(f,c,g){var a=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(c,null,true,g);var b=Kekule.ObjUtils.getOwnedFieldNames(a);for(var e=0,d=b.length;e<d;++e){var j=b[e];var h=a[j];switch(j){case"id":f.setId(h);break;case"title":f.setInfoValue("title",h);break;case"formalCharge":if(h){f.setCharge(parseFloat(h))}break;case"formula":this.readFormulaAttrib(f,h);break;case"amount":case"count":break;default:f.setInfoValue(j,h)}}},readMoleculeCore:function(f,d){var b=new Kekule.Molecule();this.getStructureBuilder().setTarget(b);var e=f.firstChild;while(e){if(e.nodeType!=Node.ELEMENT_NODE){}else{if(!this.matchCoreNamespace(e)){}else{switch(Kekule.DomUtils.getLocalName(e)){case"atomArray":this.readMoleculeAtomArray(b,e,this.getStructureBuilder(),d);break;case"bondArray":this.readMoleculeBondArray(b,e,this.getStructureBuilder(),d);break;case"formula":this.readFormula(b,e,d);break;case"atom":this.getStructureBuilder().setTarget(b);var a=this.readAtom(e,d);this.getStructureBuilder().appendNode(a);break;case"bond":this.getStructureBuilder().setTarget(b);var c=this.readBond(b,e,d);this.getStructureBuilder().appendConnector(c);break;case"molecule":break;default:if(Kekule.IO.CmlDomUtils.isCmlTypedElem(e)||Kekule.IO.CmlDomUtils.isCmlTypedArrayElem(e)){}else{this.readChildElementDef(e,b)}}}}e=e.nextSibling}if(b.hasCtab()){this.connectUpBondAndAtom(b)}return b},connectUpBondAndAtom:function(g){var h=g.getConnectors();for(var f=0,c=h.length;f<c;++f){var o=h[f];var b=o[this._BOND_ATOM_REF_TEMP_FIELD];if(b&&b.length){for(var e=0,d=b.length;e<d;++e){var m=g.getNodeById(b[e]);if(m){o.appendConnectedObj(m)}else{Kekule.raise((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.ATOMID_NOT_EXISTS"):"Atom id not exists: ")+b[e])}}}delete o[this._BOND_ATOM_REF_TEMP_FIELD];var n=o[this._BOND_BOND_REF_TEMP_FIELD];if(n&&n.length){for(var e=0,d=n.length;e<d;++e){var a=g.getConnectorById(n[e]);if(a){o.appendConnectedObj(a)}else{Kekule.raise((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.BONDID_NOT_EXISTS"):"Bond id not exists: ")+n[e])}}}delete o[this._BOND_BOND_REF_TEMP_FIELD]}},readMoleculeAtomArray:function(f,a,j,g){j.setTarget(f);var e=this.getAtomChildren(a,g);if(e.length>0){for(var c=0,b=e.length;c<b;++c){var h=e[c];var k=this.readAtom(h,g);j.appendNode(k)}}else{var d=this.readArrayedAtoms(a,g);for(var c=0,b=d.length;c<b;++c){j.appendNode(d[c])}}},readAtom:function(f,c){var a;hasChildInfoElems=!Kekule.IO.CmlDomUtils.hasDirectCmlTypedElemChildren(f,this.getCoreNamespaceURI());var g=this.atomInfoToJSON(f,c);a=this.createStructureNodeOfAttribs(g);if(hasChildInfoElems){var e=Kekule.DomUtils.getDirectChildElems(f,null,null,this.getCoreNamespaceURI());for(var d=0,b=e.length;d<b;++d){var f=e[d];this.readChildElementDef(f,a)}}return a},readArrayedAtoms:function(f,c){var g=this.arrayedAtomInfosToJSON(f,c);var a=[];for(var d=0,b=g.length;d<b;++d){var e=this.createStructureNodeOfAttribs(g[d]);if(e){a.push(e)}}return a},createStructureNodeOfAttribs:function(b){var i;if(!b.elementType){b.elementType=Kekule.Element.UNSET_ELEMENT}var c=null;if(b.id!==undefined){c=b.id}delete b.id;var a=b.isotope?Math.round(b.isotope):null;i=Kekule.IO.CmlUtils.createNodeByCmdElementType(c,b.elementType,a);delete b.elementType;if(b.hydrogenCount!==undefined){if(i.setExplicitHydrogenCount){i.setExplicitHydrogenCount(parseInt(b.hydrogenCount,10))}}delete b.hydrogenCount;if(b.formalCharge){i.setCharge(parseInt(b.formalCharge))}delete b.formalCharge;if(b.title){i.setInfoValue("title",b.title)}delete b.title;if(b.role){i.setInfoValue("role",b.role)}delete b.role;var f,d;if((b.x2!==undefined)&&(b.y2!==undefined)){f={x:parseFloat(b.x2),y:parseFloat(b.y2)}}else{if(b.xy2){var h=Kekule.IO.CmlDomUtils.splitCmlArrayValue(b.xy2);if(h.length==2){f={x:parseFloat(h[0]),y:parseFloat(h[1])}}}}delete b.x2;delete b.y2;delete b.xy2;if((b.x3!==undefined)&&(b.y3!==undefined)&&(b.z3!==undefined)){d={x:parseFloat(b.x3),y:parseFloat(b.y3),z:parseFloat(b.z3)}}else{if(b.xyz3){var e=Kekule.IO.CmlDomUtils.splitCmlArrayValue(b.xyz3);if(e.length==3){f={x:parseFloat(e[0]),y:parseFloat(e[1]),z:parseFloat(e[2])}}}}delete b.x3;delete b.y3;delete b.z3;delete b.xyz3;if(f){i.setCoord2D(f)}if(d){i.setCoord3D(d)}for(var g in b){if(b.hasOwnProperty(g)&&(typeof(b[g])=="string")){i.setInfoValue(g,b[g])}}return i},_BOND_ATOM_REF_TEMP_FIELD:"__cml_atomRefs",_BOND_BOND_REF_TEMP_FIELD:"__cml_bondRefs",readMoleculeBondArray:function(f,b,k,h){k.setTarget(f);var j=h.getElementsByTagNameNS(this.getCoreNamespaceURI(),"bond",b);if(j.length>0){for(var e=0,d=j.length;e<d;++e){var a=j[e];var c=this.readBond(f,a,h);k.appendConnector(c)}}else{var g=this.readArrayedBonds(f,b,h);for(var e=0,d=g.length;e<d;++e){k.appendConnector(g[e])}}},readBond:function(h,c,j){var m;var a=[];var f=false;f=!Kekule.IO.CmlDomUtils.hasDirectCmlTypedElemChildren(c,this.getCoreNamespaceURI());a=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(c,Kekule.IO.CmlUtils.FILTER_TYPED_ELEM,true,j);m=this.createStructureConnectorOfAttribs(h,a);if(f){var b=Kekule.DomUtils.getDirectChildElems(c,null,null,this.getCoreNamespaceURI());for(var e=0,d=b.length;e<d;++e){var c=b[e];if(Kekule.DomUtils.getLocalName(c)=="bondStereo"){var g=Kekule.DomUtils.getElementText(c);if(!g){g=Kekule.IO.CmlDomUtils.getCmlElemAttribute(c,"conversionValue",Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,j)}var k=Kekule.IO.CmlUtils.cmlBondStereoToKekule(g);if((k!=Kekule.BondStereo.NONE)&&m.setStereo){m.setStereo(k)}}else{this.readChildElementDef(c,m)}}}return m},readArrayedBonds:function(o,b,p){var c=["id","bondID","atomRef1","atomRef2","order","bondStereo"];var m=["id","id","atomRefs2","atomRefs2","order","bondStereo"];var d=[];var h=Kekule.IO.CmlDomUtils.getMultipleCmlElemAttribute(b,"atomRefs",Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM,p);if(h&&h.length){for(var n=0,e=h.length;n<e;++n){var a=h[n];var q=Kekule.IO.CmlDomUtils.splitCmlArrayValue(a);for(var g=0,f=q.length;g<f;++g){if(!d[g]){d[g]={}}if(d[g]["atomRefs"]==undefined){d[g]["atomRefs"]=[]}(d[g]["atomRefs"]).push(q[g])}}}for(var n=0,e=c.length;n<e;++n){var a;var q=[];a=Kekule.IO.CmlDomUtils.getCmlElemAttribute(b,c[n],Kekule.IO.CmlDomUtils.FILTER_TYPEDARRAY_ELEM,p);if(a){q=Kekule.IO.CmlDomUtils.splitCmlArrayValue(a)}for(var g=0,f=q.length;g<f;++g){if(!d[g]){d[g]={}}if(q[g]){if((c[n]=="atomRef1")||(c[n]=="atomRef2")){if(d[g]["atomRefs2"]==undefined){d[g]["atomRefs2"]=[]}if(c[n]=="atomRef1"){d[g]["atomRefs2"][0]=q[g]}else{d[g]["atomRefs2"][1]=q[g]}}else{d[g][m[n]]=q[g]}}}}var s=[];for(var n=0,e=d.length;n<e;++n){var r=this.createStructureConnectorOfAttribs(o,d[n]);if(r){s.push(r)}}return s},createStructureConnectorOfAttribs:function(g,a){var n;var b,j;if(a.id){b=a.id}delete a.id;if(a.order!==undefined){j=Kekule.IO.CmlUtils.cmlBondOrderToKekule(a.order)}delete a.order;n=new Kekule.Bond(b,null,j);if(a.bondStereo){var m=Kekule.IO.CmlUtils.cmlBondStereoToKekule(a.bondStereo);if((m!=Kekule.BondStereo.NONE)&&n.setStereo){n.setStereo(m)}}delete a.bondStereo;for(var f=0,e=Kekule.IO.CML.ATOMS_REF_ATTRIBS.length;f<e;++f){var d=Kekule.IO.CML.ATOMS_REF_ATTRIBS[f];if(a[d]!=undefined){var c=Kekule.IO.CmlDomUtils.splitCmlArrayValue(a[d]);if(c.length>0){n[this._BOND_ATOM_REF_TEMP_FIELD]=c}delete a[d];break}}for(var f=0,e=Kekule.IO.CML.BONDS_REF_ATTRIBS.length;f<e;++f){var d=Kekule.IO.CML.BONDS_REF_ATTRIBS[f];if(a[d]!=undefined){var h=Kekule.IO.CmlDomUtils.splitCmlArrayValue(a[d]);if(h.length>0){n[this._BOND_BOND_REF_TEMP_FIELD]=h}delete a[d];break}}for(var k in a){if(a.hasOwnProperty(k)&&(typeof(a[k])=="string")){n.setInfoValue(k,a[k])}}return n},readFormula:function(b,d,c){var a=Kekule.IO.CmlElementReaderFactory.getReader(d);if(a){this.copySettingsToChildHandler(a);var e=a.readElement(d,b);if(e){b.setFormula(e)}}},readFormulaAttrib:function(c,b){var a=Kekule.IO.CmlElementReaderFactory.getReader("formula");if(a){var d=a.readConsice?a.readConsice(b):null;if(d){c.setFormula(d)}}}});Kekule.IO.CmlMoleculeWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlMoleculeWriter",initProperties:function(){this.defineProp("allowCascadeGroup",{dataType:DataType.BOOL})},doCreateElem:function(b,a){return this.createChildElem("molecule",a)},doWriteObject:function(b,a){return this.writeMolecule(b,a)},writeMolecule:function(b,c){var a;this.writeMoleculeAttribs(b,c);if(b instanceof Kekule.CompositeMolecule){a=this.writeCompositeMolecule(b,c)}else{a=this.writeMoleculeCore(b,c)}return a},writeMoleculeAttribs:function(a,g){var h=[];if(a.getCharge()){h.push({key:"formalCharge",value:a.getCharge()})}var e=["title","dictRef","chirality","ref","spinMultiplicity","symmetryOriented","role"];for(var d=0,b=e.length;d<b;++d){var c=e[d];var f=a.getInfoValue(c);if(!Kekule.ObjUtils.isUnset(f)){h.push({key:c,value:a.getInfoValue(c)})}}for(var d=0,b=h.length;d<b;++d){Kekule.IO.CmlDomUtils.setCmlElemAttribute(g,h[d].key,h[d].value,this.getDomHelper())}},writeCompositeMolecule:function(c,e){var h=c.getSubMolecules();for(var d=0,b=h.getItemCount();d<b;++d){var g=h.getItemAt(d);var a=g.obj;var f=this.writeObject(a,e);if(g.amount){Kekule.IO.CmlDomUtils.setCmlElemAttribute(f,"amount",g.amount,this.getDomHelper())}}return e},writeMoleculeCore:function(a,b){if(a.hasFormula()){var d=a.getFormula();var c=Kekule.IO.CmlElementWriterFactory.getWriter(d);this.copySettingsToChildHandler(c);c.writeObject(d,b)}if(a.hasCtab()){this.writeCtab(a.getCtab(),a,b)}},writeCtab:function(f,j,c){this.identifyObjsInCtab(f,j);var a=this.getAllowCascadeGroup()?f.getNodes():f.getLeafNodes();if(a.length>0){var d=this.createChildElem("atomArray",c);for(var h=0,e=a.length;h<e;++h){this.writeCtabNode(a[h],d)}}var b=this.getAllowCascadeGroup()?f.getConnectors():f.getAllChildConnectors();if(b.length>0){var g=this.createChildElem("bondArray",c);for(var h=0,e=b.length;h<e;++h){this.writeCtabConnector(b[h],g)}}},writeCtabNode:function(b,c){var s=this.createChildElem("atom",c);this.writeObjId(b,s);var m=Kekule.IO.CmlUtils.getNodeElementType(b);Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"elementType",m,this.getDomHelper());var a=b.getMassNumber?b.getMassNumber():null;if(a){Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"isotope",a,this.getDomHelper())}var j=b.getExplicitHydrogenCount?b.getExplicitHydrogenCount():null;if(!Kekule.ObjUtils.isUnset(j)){Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"hydrogenCount",j,this.getDomHelper())}var k=b.getCharge?b.getCharge():null;if(k){Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"formalCharge",k,this.getDomHelper())}var e=b.getParity?b.getParity():null;if(e){}var o=b.getInfoValue?b.getInfoValue("title"):null;if(o){Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"title",o,this.getDomHelper())}var h=b.getInfoValue?b.getInfoValue("role"):null;if(h){Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"role",h,this.getDomHelper())}if(b.hasCoord2D&&b.hasCoord2D()){var n=b.getAbsCoord2D();Kekule.ObjUtils.isUnset(n.x)?null:Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"x2",n.x,this.getDomHelper());Kekule.ObjUtils.isUnset(n.y)?null:Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"y2",n.y,this.getDomHelper())}if(b.hasCoord3D&&b.hasCoord3D()){var g=b.getAbsCoord3D();Kekule.ObjUtils.isUnset(g.x)?null:Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"x3",g.x,this.getDomHelper());Kekule.ObjUtils.isUnset(g.y)?null:Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"y3",g.y,this.getDomHelper());Kekule.ObjUtils.isUnset(g.z)?null:Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,"z3",g.z,this.getDomHelper())}var r=["occupancy","xFract","xyzFract","yFract","convention","dictRef","ref"];for(var f=0,d=r.length;f<d;++f){var q=r[f];var p=b.getInfoValue(q);if(p){Kekule.IO.CmlDomUtils.setCmlElemAttribute(s,q,p,this.getDomHelper())}}this.writeObjAdditionalInfo(b,s);return s},writeCtabConnector:function(a,u){var o=false;var g=this.createChildElem("bond",u);this.writeObjId(a,g);var p=a.getBondOrder?a.getBondOrder():null;if(p){var k=Kekule.IO.CmlUtils.kekuleBondOrderToCml(p);if(k){Kekule.IO.CmlDomUtils.setCmlElemAttribute(g,"order",k,this.getDomHelper())}}var s=a.getStereo?a.getStereo():null;if(s){var e=Kekule.IO.CmlUtils.kekuleBondStereoToCml(s);if(e.value){var t=this.createChildElem("bondStereo",g);Kekule.DomUtils.setElementText(t,e.value);if(e.invert){o=true}}}var f=[];var d=[];for(var q=0,n=a.getConnectedObjCount();q<n;++q){var h=a.getConnectedObjAt(q);if(h.getId&&h.getId()){var j=h.getId();if(h instanceof Kekule.ChemStructureNode){if(o){f.unshift(j)}else{f.push(j)}}else{if(h instanceof Kekule.ChemStructureConnector){d.push(j)}}}}var c=f.length;if(c){var b=(c==1)?"atomRefs":((c>=2)&&(c<=4))?"atomRefs"+c:"atomRefs";Kekule.IO.CmlDomUtils.setCmlElemAttribute(g,b,Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(f),this.getDomHelper())}var c=d.length;if(c){var b="bondRefs";Kekule.IO.CmlDomUtils.setCmlElemAttribute(g,b,Kekule.IO.CmlDomUtils.mergeToCmlArrayValue(d),this.getDomHelper())}var r=["convention","dictRef","ref"];for(var q=0,n=r.length;q<n;++q){var v=r[q];var m=a.getInfoValue(v);if(m){Kekule.IO.CmlDomUtils.setCmlElemAttribute(g,v,m,this.getDomHelper())}}this.writeObjAdditionalInfo(a,g);return g},identifyObjsInCtab:function(e,a){for(var d=0,c=e.getNodeCount();d<c;++d){var f=e.getNodeAt(d);if(!f.getId()){this.autoIdentifyForObj(f,a)}if(e.isSubFragment(f)&&f.hasCtab&&f.hasCtab()){this.identifyObjsInCtab(f.getCtab(),a)}}for(var d=0,c=e.getConnectorCount();d<c;++d){var b=e.getConnectorAt(d);if(!b.getId()){this.autoIdentifyForObj(b,a)}}},autoIdentifyForObj:function(b,a){if(!b.getId()){if(b.getOwner&&b.getOwner()&&b.getOwner().getAutoId){b.setId(b.getOwner().getAutoId(b))}else{b.setId(this.getAutoIdForObj(b,a))}}},getAutoIdForObj:function(e,a){var d=e.getAutoIdPrefix?e.getAutoIdPrefix():"obj";if(!Kekule.IO.CmlMoleculeWriter._UID_SEED){Kekule.IO.CmlMoleculeWriter._UID_SEED=(new Date()).getTime()}++Kekule.IO.CmlMoleculeWriter._UID_SEED;var b=Kekule.IO.CmlMoleculeWriter._UID_SEED.toString();var c=""+d+b;return c}});Kekule.IO.CmlMoleculeWriter._UID_SEED=null;Kekule.IO.CmlReactionReagentReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlReactionReagentReader",doReadElement:function(a,b){return this.readReagent(a,this.getDomHelper())},readReagent:function(e,d){var f=null;var g=Kekule.DomUtils.getDirectChildElems(e,null,"molecule",this.getCoreNamespaceURI());if(g&&g.length){var c=g[g.length-1];var b=Kekule.IO.CmlElementReaderFactory.getReader(c);this.copySettingsToChildHandler(b);var a=b.readElement(c,null);if(a){f={};Kekule.RoleMapUtils.setItem(f,a);this.readReagentAttribs(f,e,d)}}else{}return f},readReagentAttribs:function(b,c,f){var a=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(c,Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,true,f);var j=Kekule.ObjUtils.getOwnedFieldNames(a);for(var e=0,d=j.length;e<d;++e){var h=j[e];var g=a[h];switch(h){case"role":b.role=Kekule.IO.CmlUtils.reagentRoleToKekule(g);break;case"amount":case"count":b.amount=parseFloat(g);break;default:b[h]=g}}return b}});Kekule.IO.CmlReactionReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlReactionReader",doReadElement:function(a,b){return this.readReaction(a,this.getDomHelper())},readReaction:function(d,g){var k=new Kekule.Reaction();var c=Kekule.DomUtils.getDirectChildElems(d,null,null,this.getCoreNamespaceURI());for(var f=0,e=c.length;f<e;++f){if(this.isComponentListElem(c[f])){this.readComponentList(k,c[f],g)}else{this.readChildElement(c[f],k)}}var a=Kekule.IO.CmlDomUtils.fetchCmlElemAttributeValuesToJson(d,Kekule.IO.CmlDomUtils.FILTER_TYPED_ELEM,null,this.getDomHelper());var b=Kekule.ObjUtils.getOwnedFieldNames(a);for(var f=0,e=b.length;f<e;++f){var j=b[f];var h=a[j];switch(j){case"name":k.setName(h);break;case"title":k.setTitle(h);break;case"type":k.setReactionType(h);break;case"yield":k.setYield(parseFloat(h));break;default:k.setInfoValue(j,h)}}return k},readComponentList:function(f,b,g){var e=this.getListElemComponentName(b);var j=f.getComponentArray(e,true);if(j){var a=Kekule.DomUtils.getDirectChildElems(b,null,null,this.getCoreNamespaceURI());for(var d=0,c=a.length;d<c;++d){var h=this.readChildElement(a[d],j);if(h){if((e==Kekule.ReactionComponent.CONDITION)&&(h instanceof ObjectEx)){f.appendItem(e,h)}else{f.appendMap(e,h)}}}}},isComponentListElem:function(a){return["reactantList","productList","substanceList","conditionList"].indexOf(Kekule.DomUtils.getLocalName(a))>=0},getListElemComponentName:function(a){switch(Kekule.DomUtils.getLocalName(a)){case"reactantList":return Kekule.ReactionComponent.REACTANT;case"productList":return Kekule.ReactionComponent.PRODUCT;case"conditionList":return Kekule.ReactionComponent.CONDITION;default:return Kekule.ReactionComponent.SUBSTANCE}}});Kekule.IO.CmlReactionWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlReactionWriter",doCreateElem:function(b,a){return this.createChildElem("reaction",a)},doWriteObject:function(b,a){return this.writeReaction(b,a)},writeReaction:function(c,d){var e=[Kekule.ReactionComponent.REACTANT,Kekule.ReactionComponent.PRODUCT,Kekule.ReactionComponent.SUBSTANCE,Kekule.ReactionComponent.CONDITION];for(var b=0,a=e.length;b<a;++b){this.writeCompList(c,e[b],d)}this.writeReactionAttribs(c,d);return d},writeReactionAttribs:function(d,e){var f=[];d.getName()?f.push({key:"name",value:d.getName()}):null;d.getTitle()?f.push({key:"title",value:d.getTitle()}):null;d.getReactionType()?f.push({key:"type",value:d.getReactionType()}):null;d.getYield()?f.push({key:"yield",value:d.getYield()}):null;var c=["dictRef","convention","format","ref","role","type","state","yield","atomMap","electronMap"];for(var b=0,a=c.length;b<a;++b){if(!Kekule.ObjUtils.isUnset(d.getInfoValue(c[b]))){f.push({key:c[b],value:d.getInfoValue(c[b])})}}for(var b=0,a=f.length;b<a;++b){Kekule.IO.CmlDomUtils.setCmlElemAttribute(e,f[b].key,f[b].value,this.getDomHelper())}},writeCompList:function(m,j,k){if(m.getComponentItemCount(j)<=0){return null}else{var a=this.getReactionComponentCmlName(j);var f=this.createChildElem(a+"List",k);for(var h=0,e=m.getComponentItemCount(j);h<e;++h){var b=m.getMapAt(j,h);var g=m.getMapItemAt(j,h);if(b&&g){var c;if(j!=Kekule.ReactionComponent.CONDITION){c=this.createChildElem(a,f);if(!Kekule.ObjUtils.isUnset(b.amount)){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"amount",b.amount,this.getDomHelper())}if(b.role){Kekule.IO.CmlDomUtils.setCmlElemAttribute(c,"role",Kekule.IO.CmlUtils.kekuleReagentRoleToCml(b.role),this.getDomHelper())}}else{c=f}var d=Kekule.IO.CmlElementWriterFactory.getWriter(g);if(d){this.copySettingsToChildHandler(d);d.writeObject(g,c)}}}}},getReactionComponentCmlName:function(a){switch(a){case Kekule.ReactionComponent.REACTANT:return"reactant";case Kekule.ReactionComponent.PRODUCT:return"product";case Kekule.ReactionComponent.CONDITION:return"condition";default:return"substance"}}});Kekule.IO.CmlListReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlListReader",doReadElement:function(b,c){var a=this.createList(b);a=this.readList(a,b,this.getDomHelper());return a},createList:function(a){switch(Kekule.DomUtils.getLocalName(a)){case"moleculeList":return new Kekule.MoleculeList();break;case"reactionList":return new Kekule.ReactionList();break;default:return new Kekule.ChemObjList()}},readList:function(h,c,j){var b=Kekule.DomUtils.getDirectChildElems(c,null,null,this.getCoreNamespaceURI());if(b){for(var f=0,d=b.length;f<d;++f){var a=b[f];var g=Kekule.IO.CmlElementReaderFactory.getReader(a);if(g){this.copySettingsToChildHandler(g);var e=g.readElement(a,null);if(e){h.append(e)}}}}return h}});Kekule.IO.CmlListWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlListWriter",doCreateElem:function(c,a){var b;switch(DataType.getType(c)){case"Kekule.MoleculeList":b="moleculeList";break;case"Kekule.ReactionList":b="reactionList";break;default:b="list"}return this.createChildElem(b,a)},doWriteObject:function(c,b){var a=Kekule.ChemStructureUtils.getChildStructureObjs(c,false);return this.writeList(a,b)},writeList:function(f,d){for(var b=0,a=f.length;b<a;++b){var c=f[b];if(c){var e=Kekule.IO.CmlElementWriterFactory.getWriter(c);if(e){this.copySettingsToChildHandler(e);e.writeObject(c,d)}}}return d}});Kekule.IO.CmlRootReader=Class.create(Kekule.IO.CmlElementReader,{CLASS_NAME:"Kekule.IO.CmlRootReader",doReadElement:function(e,f){this.analysisElem(e);var a;if(Kekule.DomUtils.getLocalName(e)!="cml"){a=this.getReader(e)}if(a){return a.readElement(e,null)}else{var d=Kekule.DomUtils.getDirectChildElems(e,null,null,this.getCoreNamespaceURI());if(d){for(var c=0,b=d.length;c<b;++c){a=this.getReader(d[c]);if(a){return a.readElement(d[c],null);break}}}}return null},getReader:function(b){var a=Kekule.IO.CmlElementReaderFactory.getReader(b);if(a){this.copySettingsToChildHandler(a);return a}return null},analysisElem:function(c){var d=this.getDomHelper();d.setForceAnalysisDoc(true);this.getDomHelper().setRootElement(c);var g=d.getNamespaces();var a=null;for(var e=0,b=g.length;e<b;++e){var f=g[e].namespaceURI;if(Kekule.IO.CML.LEGAL_CORE_NAMESPACE_URIS.indexOf(f)>=0){a=f;break}}this.setCoreNamespaceURI(a||null)}});Kekule.IO.CmlRootWriter=Class.create(Kekule.IO.CmlElementWriter,{CLASS_NAME:"Kekule.IO.CmlRootWriter",getWriter:function(b){var a=Kekule.IO.CmlElementWriterFactory.getWriter(b);if(a){this.copySettingsToChildHandler(a);return a}return null},writeObject:function(e,a,d){var b=this.getDomHelper();b.setForceAnalysisDoc(true);this.getDomHelper().setRootElement(a);var f;if(e instanceof Kekule.ChemSpace){f=e.getRoot()}else{f=e}var c=this.getWriter(f);if(c){return c.writeObject(f,a)}else{return null}}});Kekule.IO.CmlReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.CmlReader",doReadData:function(d,c,f){var b;if(c!=Kekule.IO.ChemDataType.DOM){var e=XmlUtility.parse(d);b=e.documentElement}else{if(d.documentElement){b=d.documentElement}else{b=d}}var a=Kekule.IO.CmlElementReaderFactory.getReader("cml");return a.readElement(b,null)}});Kekule.IO.CmlWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.CmlWriter",initialize:function($super,a){$super(a);var b=a||{};this.setPrettyPrint(Kekule.ObjUtils.isUnset(b.prettyPrint)?Kekule.globalOptions.IO.cml.prettyPrint:b.prettyPrint)},initProperties:function(){this.defineProp("prettyPrint",{dataType:DataType.BOOL,defaultValue:true})},doWriteData:function(f,b,e){var g=Kekule.IO.CML.CML3_SCHEMA_NAMESPACE_URI;var d=XmlUtility.newDocument("cml",g);var c=Kekule.IO.CmlElementWriterFactory.getWriter("Kekule.ChemDocument");if(c){c.setCoreNamespaceURI(g);var a=c.writeObject(f,d.documentElement);if(b==Kekule.IO.ChemDataType.TEXT){a=XmlUtility.serializeNode(d.documentElement,{prettyPrint:this.getPrettyPrint()})}return a}else{Kekule.error(Kekule.$L("ErrorMsg.UNABLE_TO_OUTPUT_AS_CML").format(DataType.getType(f)));return null}}});(function(){Kekule.IO.MimeType.CML="chemical/x-cml";var c=Kekule.IO.CmlElementReaderFactory;c.register("name",Kekule.IO.CmlNameReader);c.register("scalar",Kekule.IO.CmlScalarReader);c.register("metaData",Kekule.IO.CmlMetaDataReader);c.register("metaDataList",Kekule.IO.CmlMetaDataListReader);c.register("formula",Kekule.IO.CmlFormulaReader);c.register("molecule",Kekule.IO.CmlMoleculeReader);c.register(["reactant","product","substance"],Kekule.IO.CmlReactionReagentReader);c.register("reaction",Kekule.IO.CmlReactionReader);c.register(["list","moleculeList","reactionList"],Kekule.IO.CmlListReader);c.register("cml",Kekule.IO.CmlRootReader);var b=Kekule.IO.CmlElementWriterFactory;b.register("Kekule.Scalar",Kekule.IO.CmlScalarWriter);b.register("Kekule.MolecularFormula",Kekule.IO.CmlFormulaWriter);b.register(["Kekule.ChemStructureFragment","Kekule.Molecule","Kekule.CompositeMolecule"],Kekule.IO.CmlMoleculeWriter);b.register("Kekule.Reaction",Kekule.IO.CmlReactionWriter);b.register(["Kekule.ChemObjList","Kekule.ChemStructureObjectGroup","Kekule.ChemSpaceElement","Kekule.ChemSpace"],Kekule.IO.CmlListWriter);b.register("Kekule.ChemDocument",Kekule.IO.CmlRootWriter);Kekule.IO.DataFormatsManager.register("cml",Kekule.IO.MimeType.CML,"cml",Kekule.IO.ChemDataType.TEXT,"Chemical Markup Language");var a=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.CML);Kekule.IO.ChemDataReaderManager.register("cml",Kekule.IO.CmlReader,[a]);Kekule.IO.ChemDataWriterManager.register("cml",Kekule.IO.CmlWriter,[Kekule.Scalar,Kekule.StructureFragment,Kekule.Reaction,Kekule.ChemObjList,Kekule.ChemSpace],[a])})();Kekule.IO.MdlVersion={V2000:2,V3000:3};Kekule.IO.MDL={VER2000:"V2000",VER3000:"V3000",SYMBOL_ANYATOM:"A",SYMBOL_STARATOM:"*",SYMBOL_HETEROATOM:"Q",SYMBOL_RGROUP:"R",SYMBOL_RGROUP2:"R#",SYMBOL_LONEPAIR:"LP",SYMBOL_ATOMLIST:"L",SYMBOL_DUMMYATOM:"Du",SD_DATA_HEAD_PREFIX:">",MOL_DELIMITER:"$$$$"};Kekule.IO.MdlUtils={isUnspecifiedAtomSymbol:function(a){return((a===Kekule.IO.MDL.SYMBOL_ANYATOM)||(a===Kekule.IO.MDL.SYMBOL_STARATOM))},isHeteroAtomSymbol:function(a){return(a===Kekule.IO.MDL.SYMBOL_HETEROATOM)},isRGroupSymbol:function(a){return(a===Kekule.IO.MDL.SYMBOL_RGROUP)||((a===Kekule.IO.MDL.SYMBOL_RGROUP2))},isLonePairSymbol:function(a){return(a===Kekule.IO.MDL.SYMBOL_LONEPAIR)},isAtomListSymbol:function(a){return(a===Kekule.IO.MDL.SYMBOL_ATOMLIST)},analysisMdlDateTimeStr:function(h,b){var c=new Date();var f=0,a=2;var g=(parseInt(h.substr(f,a).trim(),10)||1)-1;f+=a;var j=parseInt(h.substr(f,a).trim(),10)||0;f+=a;a=b?4:2;var i=parseInt(h.substr(f,a),10)||0;if(!b){if(i>=70){i+=1900}else{i+=2000}}c.setFullYear(i,g,j);f+=a;a=2;var e=parseInt(h.substr(f,a),10)||0;f+=a;var d=parseInt(h.substr(f,a),10)||0;c.setHours(e,d);return c},generateMdlDateTimeStr:function(b,a){var c="";c+=b.getMonth().toString().lpad(2,"0");c+=b.getDate().toString().lpad(2,"0");if(a){c+=b.getFullYear().toString().lpad(4,"0")}else{c+=(b.getFullYear()%100).toString().lpad(2,"0")}c+=b.getHours().toString().lpad(2,"0");c+=b.getMinutes().toString().lpad(2,"0");return c},mdlRadicalToKekule:function(a){return a},kekuleRadicalToMdl:function(a){return a},bondTypeToKekuleOrder:function(a){switch(a){case 1:return Kekule.BondOrder.SINGLE;break;case 2:return Kekule.BondOrder.DOUBLE;break;case 3:return Kekule.BondOrder.TRIPLE;break;case 4:return Kekule.BondOrder.EXPLICIT_AROMATIC;break;default:return Kekule.BondOrder.UNSET}},kekuleBondOrderToMdlType:function(a){switch(a){case Kekule.BondOrder.SINGLE:return 1;break;case Kekule.BondOrder.DOUBLE:return 2;break;case Kekule.BondOrder.TRIPLE:return 3;break;case Kekule.BondOrder.EXPLICIT_AROMATIC:return 4;break;default:return 1}},getRxnMarkVersion:function(a){var b=a.substr(0,4);if(b!="$RXN"){return null}else{b=a.substr(4).trim();return(b==Kekule.IO.MDL.VER3000)?Kekule.IO.MdlVersion.V3000:Kekule.IO.MdlVersion.V2000}},assertIlegalForCtabOutput:function(a){if(!(a instanceof Kekule.StructureFragment)){Kekule.error(Kekule.$L("ErrorMsg.CAN_NOT_WRITE_NON_MOLECULE_TO_MOL"));return false}else{if(!a.hasCtab()){Kekule.error(Kekule.$L("ErrorMsg.MOLECULE_HAS_NO_CTAB_TO_OUTPUT"));return false}else{return true}}}};Kekule.IO.MdlStructureUtils={fillFragment:function(m,q,d){m.clear();if(q){var r;if(d&&(d!=Kekule.CoordMode.UNKNOWN)){r=d==Kekule.CoordMode.COORD3D}else{r=q.atomInfos.isCoord3D}if(q.atomInfos){for(var f=0,b=q.atomInfos.length;f<b;++f){var a=q.atomInfos[f];if(a){var h=Kekule.IO.MdlStructureUtils.createStructureNode(m,a,r);if(h){m.appendNode(h)}else{Kekule.raise(Kekule.$L("ErrorMsg.MDL_CTAB_ATOM_CANNOT_CREATE"))}}}}if(q.bondInfos){for(var f=0,b=q.bondInfos.length;f<b;++f){var a=q.bondInfos[f];if(a){var s=Kekule.IO.MdlStructureUtils.createStructureConnector(m,a);if(s){m.appendConnector(s)}else{Kekule.raise(Kekule.$L("ErrorMsg.MDL_CTAB_BOND_CANNOT_CREATE"))}}}}if(q.sgInfos&&q.sgInfos.length){var o=[];for(var f=0,b=q.sgInfos.length;f<b;++f){var a=q.sgInfos[f];if(a&&(a.sgType=="SUP")){var g=[];for(var e=0,c=a.atomIndexes.length;e<c;++e){g.push(m.getNodeAt(a.atomIndexes[e]))}if(g.length){o.push({atoms:g,text:a.label})}}}for(var f=0,b=o.length;f<b;++f){var g=o[f].atoms;if(g.length){var n=m.marshalSubFragment(g,new Kekule.SubGroup());var p=o[f].text;if(n.setFormulaText&&p.match(/.+\d/)){n.setFormulaText(o[f].text)}else{n.setAbbr(o[f].text)}}}}}return m},createStructureNode:function(g,h,i){var j;if(h.atomListInfo||Kekule.IO.MdlUtils.isAtomListSymbol(h.symbol)){j=new Kekule.VariableAtom();var f=[];if(h.atomListInfo&&h.atomListInfo.symbols){f=f.concat(h.atomListInfo.symbols);if(h.atomListInfo.isAllowList){j.setAllowedIsotopeIds(f)}else{j.setDisallowedIsotopeIds(f)}}}else{if(Kekule.IO.MdlUtils.isRGroupSymbol(h.symbol)){j=new Kekule.RGroup()}else{if(Kekule.IO.MdlUtils.isHeteroAtomSymbol(h.symbol)){j=new Kekule.Pseudoatom(null,Kekule.PseudoatomType.HETERO)}else{if(Kekule.IO.MdlUtils.isUnspecifiedAtomSymbol(h.symbol)){j=new Kekule.Pseudoatom(null,Kekule.PseudoatomType.ANY)}else{var e=Kekule.ChemicalElementsDataUtil.getElementInfo(h.symbol);if(e){var b=null;if(h.massNumber){b=h.massNumber}else{if(h.massDiff){if(e){var d=e.naturalMass;var b=Math.round(d+h.massDiff);var c=Kekule.IsotopesDataUtil.getIsotopeInfo(e.atomicNumber,b);if(!c){b=Math.floor(d+h.massDiff);c=Kekule.IsotopesDataUtil.getIsotopeInfo(e.atomicNumber,b)}if(!c){b=Math.ceil(d+h.massDiff);c=Kekule.IsotopesDataUtil.getIsotopeInfo(e.atomicNumber,b)}if(!c){b=null}}}}j=new Kekule.Atom(null,h.symbol,b)}else{var a=Kekule.IsotopesDataUtil.getIsotopeInfo(h.symbol);if(a){j=new Kekule.Atom(null,a.atomicNumber,a.massNumber)}else{j=new Kekule.Pseudoatom(null,Kekule.PseudoatomType.ANY)}}}}}}if(h.charge){j.setCharge(h.charge)}if(h.radical){j.setRadical(h.radical)}if(h.parity&&j.setParity){j.setParity(h.parity)}if(typeof(h.hydrongenCount)!="undefined"){if(j.setExplicitHydrogenCount){j.setExplicitHydrogenCount(h.hydrongenCount)}}if(i){j.setCoord3D({x:h.x,y:h.y,z:h.z})}else{j.setCoord2D({x:h.x,y:h.y})}return j},createStructureConnector:function(h,a){var d=h.getNodeAt(a.atomIndex1);var c=h.getNodeAt(a.atomIndex2);if(d&&c){var f=[d,c];if(a.endAtomIndexes){for(var e=0,b=a.endAtomIndexes.length;e<b;++e){var g=h.getNodeAt(a.endAtomIndexes[e]);if(g){f.push(g)}}}var j=new Kekule.Bond(null,f,a.order);if(typeof(a.stereo)!="undefined"){j.setStereo(a.stereo)}return j}else{return null}},isNodeVariableAtom:function(a){return a instanceof Kekule.VariableAtom},getAtomTypeStr:function(d,h){if(d instanceof Kekule.Atom){return d.getSymbol()}else{if(d instanceof Kekule.Pseudoatom){switch(d.getAtomType()){case Kekule.PseudoatomType.ANY:return Kekule.IO.MDL.SYMBOL_ANYATOM;case Kekule.PseudoatomType.HETERO:return Kekule.IO.MDL.SYMBOL_HETEROATOM;default:return Kekule.IO.MDL.SYMBOL_DUMMYATOM}}else{if(d instanceof Kekule.RGroup){return Kekule.IO.MDL.SYMBOL_RGROUP}else{if(d instanceof Kekule.VariableAtom){if(h){return Kekule.IO.MDL.SYMBOL_ATOMLIST}else{var j="[";var a=d.getAllowedIsotopeIds();if(a&&a.length){}else{j="NOT[";a=d.getDisallowedIsotopeIds()}if(a&&a.length){var b=[];for(var f=0,e=a.length;f<e;++f){var g=Kekule.IsotopesDataUtil.getIsotopeIdDetail(a[f]);if(g&&g.symbol){b.push(g.symbol)}}var c=b.join(",");j=j+c+"]";return j}else{return Kekule.IO.MDL.SYMBOL_ATOMLIST}}}else{return"?"}}}}},getMoleculeCtabStructureInfo:function(f){var a={};a.atoms=f.getLeafNodes();a.bonds=f.getAllChildConnectors();a.subGroups=f.getSubFragments();var c=0,d=0;for(var e=0,b=a.atoms.length;e<b;++e){if(a.atoms[e].hasCoord3D()){++d}if(a.atoms[e].hasCoord2D()){++c}}a.coordMode=(c>d)?Kekule.CoordMode.COORD2D:Kekule.CoordMode.COORD3D;return a},splitConnectedNodes:function(c){var a={primaryNodes:[]};var e=0;var f=c.getConnectedObjs();for(var d=0,b=f.length;d<b;++d){if(f[d] instanceof Kekule.ChemStructureNode){if(e<2){a.primaryNodes.push(f[d]);++e}else{if(!a.remainNodes){a.remainNodes=[]}a.remainNodes.push(f[d])}}}return a},generateClassicStyleCountLine:function(d,a){if(a==Kekule.IO.MdlVersion.V3000){return"  0  0  0     0  0              0 V3000"}else{var c="";c+=d.atoms.length.toString().lpad(3);c+=d.bonds.length.toString().lpad(3);c+="0".lpad(3);c+="0".lpad(3);c+="0".lpad(3);c+="0".lpad(3);for(var b=0;b<4;++b){c+="0".lpad(3)}c+="999";c+=Kekule.IO.MDL.VER2000.lpad(6);return c}}};Kekule.IO.MdlBlockHandler=Class.create(ObjectEx,{CLASS_NAME:"Kekule.IO.MdlBlockHandler",initProperties:function(){this.defineProp("textBuffer",{dataType:"Kekule.TextLinesBuffer",serializable:false,getter:function(){var a=this.getPropStoreFieldValue("textBuffer");if(!a){a=this.createTextBuffer();this.setPropStoreFieldValue("textBuffer",a)}return a},setter:null})},createTextBuffer:function(){return new Kekule.TextLinesBuffer()}});Kekule.IO.MdlBlockReader=Class.create(Kekule.IO.MdlBlockHandler,{CLASS_NAME:"Kekule.IO.MdlBlockReader",readBlock:function(a,b){if(typeof(a)=="string"){this.getTextBuffer().setText(a)}else{this.getTextBuffer().setLines(a)}this.getTextBuffer().reset();return this.doReadBlock(this.getTextBuffer())},doReadBlock:function(b,a){}});Kekule.IO.MdlBlockWriter=Class.create(Kekule.IO.MdlBlockHandler,{CLASS_NAME:"Kekule.IO.MdlBlockWriter",writeBlock:function(a){this.getTextBuffer().clear();this.doWriteBlock(a,this.getTextBuffer());return this.getTextBuffer().getText()},doWriteBlock:function(a,b){}});Kekule.IO.Mdl2kUtils={atomLineChargeToKekule:function(a){switch(a){case 1:return 3;break;case 2:return 2;break;case 3:return 1;break;case 5:return -1;break;case 6:return -2;break;case 7:return -3;break;default:return 0}},chargeToMdlAtomLineValue:function(a){switch(a){case 1:return 3;break;case 2:return 2;break;case 3:return 1;break;case -1:return 5;break;case -2:return 6;break;case -3:return 7;break;default:return 0}},atomLineChargeToRadical:function(a){if(a==4){return Kekule.RadicalType.DOUBLET}else{return 0}},radicalToMdlAtomLineValue:function(a){return(a==Kekule.RadicalType.DOUBLET)?4:0},chargeOrRadicalToMdlAtomLineValue:function(b,a){if(b){return Kekule.IO.Mdl2kUtils.chargeToMdlAtomLineValue(b)}else{if(a){return Kekule.IO.Mdl2kUtils.radicalToMdlAtomLineValue(b)}else{return 0}}},bondStereoToKekule:function(b,a){if(a==Kekule.BondOrder.SINGLE){switch(b){case 1:return Kekule.BondStereo.UP;break;case 4:return Kekule.BondStereo.UP_OR_DOWN;break;case 6:return Kekule.BondStereo.DOWN;break;default:return Kekule.BondStereo.NONE}}else{if(a==Kekule.BondOrder.DOUBLE){switch(b){case 3:return Kekule.BondStereo.E_Z_BY_COORDINATES;break;default:return Kekule.BondStereo.NONE}}else{return Kekule.BondStereo.NONE}}},bondStereoToMdlBondLineValue:function(b,a){if(a==Kekule.BondOrder.SINGLE){switch(b){case Kekule.BondStereo.UP:return 1;case Kekule.BondStereo.UP_OR_DOWN:return 4;case Kekule.BondStereo.DOWN:return 6;default:return 0}}else{if(a==Kekule.BondOrder.DOUBLE){switch(b){case Kekule.BondStereo.E_Z_BY_COORDINATES:return 3;default:return 0}}else{return 0}}},coordToStr:function(a){return(a||0).toFixed(4)},getMassDiff:function(b){var a=Kekule.ChemicalElementsDataUtil.getElementInfo(b.getAtomicNumber());var c=a.naturalMass;return Math.round(b.getMassNumber()-c)},getAtomListPropLineValue:function(h){var g="";var f=h.getAllowedIsotopeIds();if(f&&f.length){g=" F "}else{g=" T ";f=h.getDisallowedIsotopeIds()}if(f&&f.length){var c=[];for(var d=0,b=f.length;d<b;++d){var e=Kekule.IsotopesDataUtil.getIsotopeIdDetail(f[d]);if(e&&e.symbol){c.push(e.symbol.rpad(4))}}var a=c.join("");g=c.length.toString().lpad(3)+g+a;return g}else{return null}},getCtabPropLineTag:function(b,a){return(a||"M")+"  "+b},getCtabPropLineCountTag:function(d,a,c){var b=(c||"M")+"  "+d;if(a){b+=(a).toString().lpad(3)}return b},generateCtabPropLine:function(b,e,c,d){var a=Kekule.IO.Mdl2kUtils.getCtabPropLineCountTag(e,c,d);return a+" "+b.join(" ")}};Kekule.IO.Mdl2kCTabReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.Mdl2kCTabReader",doReadBlock:function(b,a){return this.analysisCTab(b)},analysisCTab:function(d){var n={};var m=d.readLine();var j=this.analysisCountLine(m);var e=[];e.isCoord3D=false;for(var h=0;h<j.atomCount;++h){m=d.readLine();var k=this.analysisAtomLine(m);if(k.z){e.isCoord3D=true}e.push(k)}var g=[];for(var h=0;h<j.bondCount;++h){m=d.readLine();var b=this.analysisBondLine(m);g.push(b)}for(var h=0;h<j.atomListCount;++h){m=d.readLine();var f=this.analysisAtomListInfoLine(m);if(e[f.atomIndex]){e[f.atomIndex].atomListInfo=f}}for(var h=0;h<j.stextCount;++h){m=d.readLine();m=d.readLine()}var l=[];while(!d.eof()){m=d.readLine();var c=this.analysisPropertyLine(m,e,l);if(c.prop==="END"){break}if(c.prop==="SKP"){for(var h=0;h<c.count;++h){if(d.eof()){break}m=d.readLine()}}else{if(c.leading==="A"){if(d.eof()){break}var a=c.atomIndex;m=d.readLine();e[a].symbol=m.trim()}}}n.countInfo=j;n.atomInfos=e;n.bondInfos=g;n.sgInfos=l;return n},analysisCountLine:function(b){var a={};var c=b.substr(33,6).trim();if(c&&c!=Kekule.IO.MDL.VER2000){Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL2000_FORMAT_DATA"));return null}c=b.substr(0,3);a.atomCount=parseInt(c,10);c=b.substr(3,3);a.bondCount=parseInt(c,10);c=b.substr(12,3);a.isChiral=(parseInt(c,10)!=0);c=b.substr(15,3);a.stextCount=parseInt(c,10);return a},analysisAtomLine:function(c){var b={};var e=c.substr(0,10);b.x=parseFloat(e);e=c.substr(10,10);b.y=parseFloat(e);e=c.substr(20,10);b.z=parseFloat(e);e=c.substr(31,3);b.symbol=e.trim();e=c.substr(34,2);b.massDiff=parseInt(e,10);e=c.substr(36,3);var d=parseInt(e,10);var a=Kekule.IO.Mdl2kUtils.atomLineChargeToRadical(d);if(a){b.radical=a}else{b.charge=Kekule.IO.Mdl2kUtils.atomLineChargeToKekule(d)}e=c.substr(39,3);var d=parseInt(e,10);if(d){b.parity=d}e=c.substr(42,3);var d=parseInt(e,10);if(d>0){b.hydrongenCount=d-1}return b},analysisBondLine:function(b){var a={};var d=b.substr(0,3);a.atomIndex1=parseInt(d,10)-1;d=b.substr(3,3);a.atomIndex2=parseInt(d,10)-1;d=b.substr(6,3);a.order=Kekule.IO.MdlUtils.bondTypeToKekuleOrder(parseInt(d,10));d=b.substr(9,3);var c=Kekule.IO.Mdl2kUtils.bondStereoToKekule(parseInt(d,10),a.order);if(c){a.stereo=c}return a},analysisAtomListInfoLine:function(b){var a={};var f=b.substr(0,3);a.atomIndex=parseInt(f,10)-1;f=b.substr(4,1);a.isAllowList=(f.toLowerCase()=="f");f=b.substr(9,1);var e=Math.min(parseInt(f,10),5);a.atomicNumbers=[];var g=11;for(var d=0;d<e;++d){g+=4*d;f=b.substr(g,3);var c=parseInt(f,10);if(c){a.atomicNumbers.push(c)}}return a},analysisPropertyLine:function(o,p,j){var n={};var x=o.substr(0,1);n.leading=x;if(x=="M"){var y=o.substr(3,3).trim();n.prop=y;var A,h,u;if(y==="END"){return n}if(["CHG","RAD","ISO"].indexOf(y)>=0){var e=parseInt(o.substr(6,3).trim());n.entryCount=e;n.entries=[];propName=(y==="CHG")?"charge":(y==="RAD")?"radical":"massNumber";var m=10;for(var v=0;v<e;++v){var A=parseInt(o.substr(m,3).trim(),10)-1;var l=parseInt(o.substr(m+4,3).trim(),10);m+=8;n.entries.push({atomIndex:A,propName:l});p[A][propName]=l}}else{if(["STY","SLB"].indexOf(y)>=0){h=parseInt(o.substr(10,3),10)-1;u=j[h]}else{if(["SAL","SBL","SMT","SCL","SAP","SBV"].indexOf(y)>=0){h=parseInt(o.substr(7,3),10)-1;u=j[h]}}}var d=14;switch(y){case"ALS":var t={};var a=o.substr(7,3).trim();t.atomIndex=parseInt(a,10)-1;n.atomIndex=t.atomIndex;var k=parseInt(o.substr(10,3));var r=o.substr(14,1);t.isAllowList=(r.toLowerCase()=="f");t.symbols=[];for(var v=0;v<k;++v){r=o.substr(16+v*4,4).trim();t.symbols.push(r)}n.atomListInfo=t;var w=p[t.atomIndex].atomListInfo;if(!w){p[t.atomIndex].atomListInfo=t}else{if(w.isAllowList!==t.isAllowList){p[t.atomIndex].atomListInfo=t}else{w.symbols=Kekule.ArrayUtils.pushUnique(w.symbols,t.symbols)}}break;case"STY":var c=o.substr(14,3);if(c=="SUP"){j[h]={sgType:"SUP"}}break;case"SLB":if(u){u.labelId=o.substr(14).trim()}break;case"SAL":if(u){var z=parseInt(o.substr(10,3));if(!u.atomIndexes){u.atomIndexes=[]}for(var v=0;v<z;++v){var r=o.substr(14+v*4,3);var A=parseInt(r)-1;u.atomIndexes.push(A)}}break;case"SBL":if(u&&(u.sgType=="SUP")){var g=parseInt(o.substr(10,3));if(!u.crossBondIndexes){u.crossBondIndexes=[]}for(var v=0;v<g;++v){var r=o.substr(14+v*4,3);var f=parseInt(r)-1;u.crossBondIndexes.push(f)}}break;case"SMT":if(u){if(u.sgType=="SUP"){u.label=o.substr(11).trim()}else{u.subscript=o.substr(11).trim()}}break;case"SCL":if(u){u.sgClass=o.substr(11).trim()}break;case"SBV":if(u){var b=parseInt(o.substr(11,3),10)-1;vectorX=parseFloat(o.substr(14,10));vectorY=parseFloat(o.substr(24,10));if(!u.bondVectors){u.bondVectors=[]}u.bondVectors[b]={bondIndex:b,x:vectorX,y:vectorY};var q=o.substr(34,10).trim();if(q){vectorZ=parseFloat(q)||0;u.bondVectors[b].z=vectorZ}}break}}else{if(x==="A"){var m=3;var A=parseInt(o.substr(m,3).trim(),10)-1;n.atomIndex=A}else{if(x==="V"){}else{if(x==="G"){}else{if(x==="S"){var y=o.substr(3,3).trim();n.prop=y;n.count=parseInt(o.substr(6,3),10)}}}}}return n}});Kekule.IO.Mdl2kCTabWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.Mdl2kCTabWriter",initialize:function($super,a){$super();this.setCoordMode(a||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("coordMode",{dataType:DataType.INT,deaultValue:Kekule.CoordMode.UNKNOWN})},doWriteBlock:function(a,b){Kekule.IO.MdlUtils.assertIlegalForCtabOutput(a);return this.outputCtab(a,b)},outputCtab:function(d,f){var e=[];var c=Kekule.IO.MdlStructureUtils.getMoleculeCtabStructureInfo(d);if(this.getCoordMode()!=Kekule.CoordMode.UNKNOWN){c.coordMode=this.getCoordMode()}f.writeLine(this.generateCountLine(c));this.outputAtomBlock(d,c,f,e);this.outputBondBlock(d,c,f);if(e.length){for(var b=0,a=e.length;b<a;++b){f.writeLine(e[b])}}this.outputSubgroupsPropLines(d,c,f);f.writeLine(Kekule.IO.Mdl2kUtils.getCtabPropLineTag("END"))},generateCountLine:function(a){return Kekule.IO.MdlStructureUtils.generateClassicStyleCountLine(a,Kekule.IO.MdlVersion.V2000)},outputAtomBlock:function(f,d,h,g){for(var c=0,b=d.atoms.length;c<b;++c){var e=d.atoms[c];var a=this.generateAtomLine(c,d.coordMode,e,g);h.writeLine(a)}},generateAtomLine:function(j,b,h,o){var a=Kekule.IO.Mdl2kUtils.coordToStr;var q="";var l=(j+1).toString().lpad(3);var g=(b==Kekule.CoordMode.COORD3D)?h.getAbsCoord3D():h.getAbsCoord2D();q+=a(g.x).lpad(10)+a(g.y).lpad(10)+a(g.z).lpad(10);q+=" "+Kekule.IO.MdlStructureUtils.getAtomTypeStr(h,true).rpad(3);if(Kekule.IO.MdlStructureUtils.isNodeVariableAtom(h)){var n=Kekule.IO.Mdl2kUtils.getAtomListPropLineValue(h);if(n){var d=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("ALS")+" "+l+n;o.push(d)}}if(h.getMassNumber&&h.getMassNumber()){var k=Kekule.IO.Mdl2kUtils.getMassDiff(h.getIsotope())||0;q+=k.toString().lpad(2);var d=Kekule.IO.Mdl2kUtils.generateCtabPropLine([l,h.getMassNumber().toString().lpad(3)],"ISO",1);o.push(d)}else{q+="0".lpad(2)}q+=Kekule.IO.Mdl2kUtils.chargeOrRadicalToMdlAtomLineValue(h.getCharge?h.getCharge():null,h.getRadical?h.getRadical():null).toString().lpad(3);if(h.getCharge&&h.getCharge()){var d=Kekule.IO.Mdl2kUtils.generateCtabPropLine([l,h.getCharge().toString().lpad(3)],"CHG",1);o.push(d)}if(h.getRadical&&h.getRadical()){var d=Kekule.IO.Mdl2kUtils.generateCtabPropLine([l,Kekule.IO.MdlUtils.kekuleRadicalToMdl(h.getRadical()).toString().lpad(3)],"RAD",1);o.push(d)}var c=h.getParity?(h.getParity()||0):0;q+=c.toString().lpad(3);var f=h.getExplicitHydrogenCount?h.getExplicitHydrogenCount():null;var m=Kekule.ObjUtils.isUnset(f)?"0":(f+1).toString();q+=m.lpad(3);for(var e=0,p="0".lpad(3);e<8;++e){q+=p}return q},outputBondBlock:function(e,d,g){for(var c=0,b=d.bonds.length;c<b;++c){var f=d.bonds[c];var a=this.generateBondLine(c,f,d.atoms);g.writeLine(a)}},generateBondLine:function(a,e,d){var c="";var b=Kekule.IO.MdlStructureUtils.splitConnectedNodes(e);c+=(d.indexOf(b.primaryNodes[0])+1).toString().lpad(3);c+=(d.indexOf(b.primaryNodes[1])+1).toString().lpad(3);if(e.getBondOrder){c+=Kekule.IO.MdlUtils.kekuleBondOrderToMdlType(e.getBondOrder()).toString().lpad(3)}else{c+="0".lpad(3)}if(e.getStereo&&e.getBondOrder){c+=Kekule.IO.Mdl2kUtils.bondStereoToMdlBondLineValue(e.getStereo(),e.getBondOrder()).toString().lpad(3)}else{c+="0".lpad(3)}c+="0".lpad(3);c+="0".lpad(3);c+="0".lpad(3);return c},outputSubgroupsPropLines:function(g,f,h){for(var e=0,b=f.subGroups.length;e<b;++e){var a=this.generateSgroupLines(e,f.subGroups[e],f);for(var d=0,c=a.length;d<c;++d){h.writeLine(a[d])}}},generateSgroupLines:function(g,A,u){var k=[];var q=(g+1).toString().lpad(3);var o=Kekule.IO.Mdl2kUtils.generateCtabPropLine([q,"SUP"],"STY",1);k.push(o);o=Kekule.IO.Mdl2kUtils.generateCtabPropLine([q,q],"SLB",1);k.push(o);var m=(A.getAbbr&&A.getAbbr())||(A.getFormulaText&&A.getFormulaText())||(A.getName&&A.getName());if(m){o=Kekule.IO.Mdl2kUtils.generateCtabPropLine([q,m],"SMT");k.push(o)}var z=[];var d=A.getLeafNodes();for(var t=0,r=d.length;t<r;++t){var g=u.atoms.indexOf(d[t]);if(g>=0){z.push((g+1).toString().lpad(3))}}z=z.sort();var f=Kekule.ArrayUtils.divide(z,15);for(var t=0,r=f.length;t<r;++t){var y=f[t];o=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("SAL")+" "+q+y.length.toString().lpad(3)+" "+y.join(" ");k.push(o)}var e=A.getCrossConnectors();var b=[];var p=[];var n=Kekule.IO.Mdl2kUtils.coordToStr;for(var t=0,r=e.length;t<r;++t){var g=u.bonds.indexOf(e[t]);if(g>=0){b.push((g+1).toString().lpad(3));var x=[g+1];var w=Kekule.IO.MdlStructureUtils.splitConnectedNodes(e[t]);var d=w.primaryNodes;var c={};if(d.length==2){if(u.coordMode==Kekule.CoordMode.COORD2D){c=Kekule.CoordUtils.substract(d[0].getAbsCoord2D(),d[1].getAbsCoord2D());x=x.concat([n(c.x).lpad(10),n(c.y).lpad(10)])}else{c=Kekule.CoordUtils.substract(d[0].getAbsCoord3D(),d[1].getAbsCoord3D());x=x.concat([n(c.x),n(c.y),n(c.z)])}}p.push(x)}}b=b.sort();var j=Kekule.ArrayUtils.divide(b,15);for(var t=0,r=j.length;t<r;++t){var a=j[t];o=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("SBL")+" "+q+a.length.toString().lpad(3)+" "+a.join(" ");k.push(o)}for(var t=0,r=p.length;t<r;++t){var v=p[t].shift();var h=p[t].join("");o=Kekule.IO.Mdl2kUtils.getCtabPropLineTag("SBV")+" "+q+" "+v.toString().lpad(3)+h;k.push(o)}return k}});Kekule.IO.Mdl3kUtils={get3kBlockStartTag:function(a){return"BEGIN "+a.toUpperCase()},get3kBlockEndTag:function(a){return"END "+a.toUpperCase()},isAtomList:function(b){var a=/\[.+\]/;return b.search(a)>=0},analysisAtomList:function(g){var e=/\[(.+)\]/g;var f=e.exec(g);if(f&&(f.length>=2)){var d=f[1];f=d.split(",");var a={};a.isAllowList=!(g.trim().indexOf("NOT")==0);a.symbols=[];for(var c=0,b=f.length;c<b;++c){a.symbols.push(f[c].trim())}return a}else{return null}},bondCfgToKekule:function(a){switch(a){case 0:return Kekule.BondStereo.NONE;case 1:return Kekule.BondStereo.UP;case 2:return Kekule.BondStereo.UP_OR_DOWN;case 3:return Kekule.BondStereo.DOWN;default:return Kekule.BondStereo.NONE}},bondStereoToMdlCfg:function(a){switch(a){case Kekule.BondStereo.UP:return 1;case Kekule.BondStereo.UP_OR_DOWN:return 2;case Kekule.BondStereo.DOWN:return 3;default:return 0}},coordToStr:function(a){return(a||0).toFixed(6)}};Kekule.IO.Mdl3kValueUtils={SEPARATOR:" ",KEYVALUE_CONNECTOR:"=",STR_QUOTE:'"',ESC_QUOTE:'""',VALUELIST_PATTERN:/\(.+\)/g,split:function(j,g){var n=g||Kekule.IO.Mdl3kValueUtils.SEPARATOR;var d=Kekule.IO.Mdl3kValueUtils.STR_QUOTE;var o=[];var f=false;var a=false;var k=false;var m="";for(var e=0,b=j.length;e<b;++e){var h=j.charAt(e);if(h==d){if(((!f)&&(j.charAt(e+1)==d))||(f&&(j.charAt(e-1)==d))){}else{f=!f}}else{if(h=="["){a=true}else{if(h=="]"){a=false}else{if(h=="("){k=true}else{if(h==")"){k=false}}}}}if(h==n){if((!f)&&(!a)&&(!k)&&m){o.push(m);m=""}else{m+=h}}else{m+=h}}if(m){o.push(m)}return o},merge:function(b,c){var a=c||Kekule.IO.Mdl3kValueUtils.SEPARATOR;return b.join(a)},isKeyValuePair:function(a){return a.indexOf(Kekule.IO.Mdl3kValueUtils.KEYVALUE_CONNECTOR)>=0},splitKeyValue:function(d){var a={};var b=Kekule.IO.Mdl3kValueUtils.KEYVALUE_CONNECTOR;var c=d.indexOf(b);if(c<0){a.value=d}else{a.key=d.substr(0,c);a.value=d.substr(c+b.length)}return a},mergeKeyValue:function(b,a){if(!a){return b}else{return""+a+Kekule.IO.Mdl3kValueUtils.KEYVALUE_CONNECTOR+b}},isValueList:function(b){var a=b.search(Kekule.IO.Mdl3kValueUtils.VALUELIST_PATTERN);return(a>=0)},splitValueList:function(e){var c=/\((.+)\)/;var d=c.exec(e);if(d&&(d.length>1)){var b=d[1];var a=Kekule.IO.Mdl3kValueUtils.split(b);a.shift();return a}else{return[e]}},mergeValueList:function(b){var d="("+b.length;for(var c=0,a=b.length;c<a;++c){d+=Kekule.IO.Mdl3kValueUtils.SEPARATOR+b[c]}d+=")";return d},unquoteValue:function(d){var b=Kekule.IO.Mdl3kValueUtils.STR_QUOTE;var a=d.trim();if(a.substr(0,b.length)==b){a=a.substr(b.length)}if(a.substr(a.length-b.length)==b){a=a.substr(0,a.length-b.length)}var c=new RegExp(b+b,"g");a=a.replace(c,b);if(Kekule.IO.Mdl3kValueUtils.isValueList(a)){a=Kekule.IO.Mdl3kValueUtils.splitValueList(a)}return a},quoteValue:function(d){var b=Kekule.IO.Mdl3kValueUtils.STR_QUOTE;var a=""+d;var c=new RegExp(b,"g");a=a.replace(c,b+b);if(a.indexOf(Kekule.IO.Mdl3kValueUtils.SEPARATOR)>=0){a=b+a+b}return a},splitValues:function(f){var a=[];var d=Kekule.IO.Mdl3kValueUtils.split(f);for(var c=0,b=d.length;c<b;++c){var e=Kekule.IO.Mdl3kValueUtils.splitKeyValue(d[c]);if(e.value){e.value=Kekule.IO.Mdl3kValueUtils.unquoteValue(e.value)}a.push(e)}return a},mergeValues:function(g){var a;for(var d=0,b=g.length;d<b;++d){var h=g[d];var c,f;if((typeof(h)!="object")||Kekule.ArrayUtils.isArray(h)){f=h}else{c=h.key;f=h.value}var e;if(Kekule.ArrayUtils.isArray(f)){e=Kekule.IO.Mdl3kValueUtils.mergeValueList(f)}else{e=Kekule.IO.Mdl3kValueUtils.quoteValue(f)}if(c){e=Kekule.IO.Mdl3kValueUtils.mergeKeyValue(e,c)}a=Kekule.IO.Mdl3kValueUtils.appendToken(a,e)}return a},appendToken:function(a,c,e){var b=e||Kekule.IO.Mdl3kValueUtils.SEPARATOR;var d=a||"";if((!d)||(d.substr(d.length-b.length,b.length)==b)){d=c}else{d+=Kekule.IO.Mdl3kValueUtils.SEPARATOR+c}return d}};Kekule.IO.Mdl3kTextBuffer=Class.create(Kekule.TextLinesBuffer,{CLASS_NAME:"Kekule.Mdl3kTextBuffer",LEADING_TAG:"M  V30 ",LINE_CONTI_MARK:"-",MAX_COL_WIDTH:80,initialize:function($super,a){$super(a)},isStartWithLeadingTag:function(a){return(a.substr(0,this.LEADING_TAG.length)==this.LEADING_TAG)},isEndWithContinueMark:function(a){var b=a.trim();return(b.substr(b.length-this.LINE_CONTI_MARK.length)==this.LINE_CONTI_MARK)},getLineWithout3kTag:function(b){var a=this.LEADING_TAG.length;if(b.substr(0,a)==this.LEADING_TAG){return b.substr(a)}else{return b}},getLineAtEx:function(c){var b=this.getLineAt(c);var e=1;if(b&&this.isEndWithContinueMark(b)&&this.isStartWithLeadingTag(this.getLines()[c])){var f=b.lastIndexOf(this.LINE_CONTI_MARK);b=b.substr(0,f);var d=this.getLineAtEx(c+1);b+=d.line;e+=d.lineCount}var a={line:b,lineCount:e};return a},getLineAt:function($super,b){var a=$super(b);return this.getLineWithout3kTag(a)},readLine:function(){var a=this.getLineAtEx(this.getCurrLineNo());this.incCurrLineNo(a.lineCount);return a.line},writeLine:function($super,h,e){if(!e){var f=h;if(!this.isStartWithLeadingTag(h)){f=this.LEADING_TAG+f}var c;if(f.length>this.MAX_COL_WIDTH){var d=this.LINE_CONTI_MARK;var g=Kekule.IO.Mdl3kValueUtils.SEPARATOR;var b=this.MAX_COL_WIDTH-d.length;c=f.substr(b);f=f.substr(0,b);f+=d}var a=$super(f);if(c){a=this.writeLine(c,e)}return a}else{return $super(h)}},writeLines:function($super,b,d){for(var c=0,a=b.length;c<a;++c){this.writeLine(b[c],d)}},getBlockBuffer:function(d,f){var i;var e=Kekule.IO.Mdl3kUtils.get3kBlockStartTag(d);var b=Kekule.IO.Mdl3kUtils.get3kBlockEndTag(d);var a=this.getCurrLineNo();this.reset();var h=this.readLine().trim();while((h!=e)&&(!this.eof())){h=this.readLine().trim()}if(this.eof()){i=null}else{var c=this.getCurrLineNo();endPos=this.getCurrLineNo();h=this.readLine().trim();while((h!=b)&&(!this.eof())){endPos=this.getCurrLineNo();h=this.readLine().trim()}if(h==b){var g=this.getLines().slice(c,endPos)}else{var g=this.getLines().slice(c)}i=new Kekule.IO.Mdl3kTextBuffer(g)}if(f){this.setCurrLineNo(a)}return i}});Kekule.IO.Mdl3kBlockReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.Mdl3kBlockReader",createTextBuffer:function(){return(new Kekule.IO.Mdl3kTextBuffer())},doReadBlock:function(h,g){var c;var d=!(h instanceof Kekule.IO.Mdl3kTextBuffer);if(d){c=new Kekule.IO.Mdl3kTextBuffer();c.setLines(h.getUnreadLines());c.reset()}else{c=h}var b=c.getCurrLineNo();var a=this.doRead3kBlock(c,g);var f=c.getCurrLineNo();if(d){var e=f-b;h.incCurrLineNo(e)}return a},doRead3kBlock:function(b,a){}});Kekule.IO.Mdl3kBlockWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.Mdl3kBlockWriter",createTextBuffer:function(){return(new Kekule.IO.Mdl3kTextBuffer())},writeStartTag:function(a,b){b.writeLine(Kekule.IO.Mdl3kUtils.get3kBlockStartTag(a))},writeEndTag:function(a,b){b.writeLine(Kekule.IO.Mdl3kUtils.get3kBlockEndTag(a))},doWriteBlock:function(d,e){var b;var c=!(e instanceof Kekule.IO.Mdl3kTextBuffer);if(c){b=new Kekule.IO.Mdl3kTextBuffer();b.setLines(e.getUnreadLines());b.reset()}else{b=e}var a=this.doWrite3kBlock(d,b);if(c){e.appendLines(c.getLines())}return a},doWrite3kBlock:function(a,b){}});Kekule.IO.Mdl3kCTabReader=Class.create(Kekule.IO.Mdl3kBlockReader,{CLASS_NAME:"Kekule.IO.Mdl3kCTabReader",doRead3kBlock:function(c,b){var a=c.getBlockBuffer("CTAB");if(!a){a=c}return this.analysisCTab(a)},analysisCTab:function(d){var k={};var j=d.readLine();var g=this.analysisCountLine(j);if(!g){return null}var f=[];var h;var i=d.getBlockBuffer("ATOM");if(i){h=this.analysisAtomBlock(i,f)}else{Kekule.raise(Kekule.$L("ErrorMsg.MDL3000_ATOMBLOCK_NOT_FOUND"));return null}var b;var e=d.getBlockBuffer("BOND");if(e){b=this.analysisBondBlock(e,f)}var c;var a=d.getBlockBuffer("SGROUP");if(a){c=this.analysisSGroupBlock(a,f)}k.countInfo=g;k.atomInfos=h;k.atomIndexMap=f;if(b){k.bondInfos=b}if(c){k.sgInfos=c}return k},analysisCountLine:function(c){var b={};var d=Kekule.IO.Mdl3kValueUtils.splitValues(c);var a=d.shift().value;if(a!="COUNTS"){Kekule.raise(Kekule.$L("ErrorMsg.MALFORMED_MDL3000_COUNTLINE"));return}var e=d.shift().value;b.atomCount=parseInt(e,10);e=d.shift().value;b.bondCount=parseInt(e,10);e=d.shift().value;b.sgroupCount=parseInt(e,10);e=d.shift().value;b.isChiral=(parseInt(e,10)!=0);return b},analysisAtomBlock:function(f,b){var e=Kekule.CoordMode.COORD2D;var a=[];while(!f.eof()){line=f.readLine();var d=this.analysisAtomLine(line);var c=a.push(d)-1;b[d.index]=c;if(d.z){e=Kekule.CoordMode.COORD3D}}a.coordMode=e;a.isCoord3D=(e==Kekule.CoordMode.COORD3D);return a},analysisAtomLine:function(n,e){var o={};var k=Kekule.IO.Mdl3kValueUtils.splitValues(n);o.index=parseInt(k.shift().value,10);var m=k.shift().value.trim();if(Kekule.IO.Mdl3kUtils.isAtomList(m)){var b=Kekule.IO.Mdl3kUtils.analysisAtomList(m);if(b){o.atomListInfo=b;o.symbol="L"}}else{o.symbol=m}o.x=parseFloat(k.shift().value);o.y=parseFloat(k.shift().value);o.z=parseFloat(k.shift().value);k.shift();for(var f=0,a=k.length;f<a;++f){var d=k[f];var j=d.key;var h=d.value;switch(j){case"CHG":var g=parseInt(h,10);if(g){o.charge=g}break;case"RAD":var g=parseInt(h,10);if(g){o.radical=g}break;case"CFG":var g=parseInt(h,10);if(g){o.parity=g}break;case"MASS":o.massNumber=parseFloat(h);break;case"VAL":break;case"HCOUNT":var g=parseInt(h,10);if(g){o.hydrongenCount=(g==-1)?0:g-1}break;case"RGROUPS":var g=parseInt(h,10);if(g){o.rgroupCount=g}break}}return o},analysisBondBlock:function(d,b){var c=[];while(!d.eof()){line=d.readLine();var a=this.analysisBondLine(line,b);c[a.index]=a}return c},analysisBondLine:function(p,e){var q={};var n=Kekule.IO.Mdl3kValueUtils.splitValues(p);q.index=parseInt(n.shift().value,10);var o=n.shift().value;q.order=Kekule.IO.MdlUtils.bondTypeToKekuleOrder(parseInt(o,10));q.atomIndex1=e[parseInt(n.shift().value,10)];q.atomIndex2=e[parseInt(n.shift().value,10)];for(var f=0,a=n.length;f<a;++f){var m=n[f].key;var h=n[f].value;switch(m){case"CFG":var g=parseInt(h,10);q.stereo=Kekule.IO.Mdl3kUtils.bondCfgToKekule(g);break;case"ENDPTS":if(Kekule.ArrayUtils.isArray(h)){q.endAtomIndexes=[];for(var d=0,b=h.length;d<b;++d){q.endAtomIndexes.push(e[parseInt(h[d],10)])}}else{q.endAtomIndexes=[e[parseInt(h,10)]]}case"TOPO":case"RXCTR":case"STBOX":break}}return q},analysisSGroupBlock:function(g,d){var a=[];var e=null;var f=g.getCurrLineNo();line=g.readLine();var b=Kekule.IO.Mdl3kValueUtils.splitValues(line);if(b.shift().value=="DEFAULT"){e=this.fetchSGroupOptionalValues(line,d)}else{g.setCurrLineNo(f)}while(!g.eof()){line=g.readLine();var c=this.analysisSGroupLine(line,d,e);a[c.index]=c}return a},analysisSGroupLine:function(c,e,f){var b={};var d=Kekule.IO.Mdl3kValueUtils.splitValues(c);b.index=parseInt(d.shift().value,10);b.sgType=d.shift().value.trim();b.extIndex=parseInt(d.shift().value,10);var a=this.fetchSGroupOptionalValues(d,e);if(f){a=Object.extend(f,a)}b=Object.extend(b,a);return b},fetchSGroupOptionalValues:function(a,f){var q={};for(var g=0,c=a.length;g<c;++g){var p=a[g].key;var o=a[g].value;switch(p){case"ATOMS":q.atomIndexes=[];for(var e=0,d=o.length;e<d;e++){q.atomIndexes.push(f[o[e]])}break;case"XBONDS":q.crossBondIndexes=[].concat(o);break;case"SUBTYPE":q.subType=o;break;case"LABEL":q.label=o;break;case"CSTATE":if(!q.bondVectors){q.bondVectors=[]}var b=parseInt(o.shift(),10);var n=parseFloat(o.shift())||0;var m=parseFloat(o.shift())||0;var h=parseFloat(o.shift())||0;q.bondVectors[b]={bondIndex:b,x:n,y:m,z:h};break;case"CLASS":q.sgClass=o;break}}return q}});Kekule.IO.Mdl3kCTabWriter=Class.create(Kekule.IO.Mdl3kBlockWriter,{CLASS_NAME:"Kekule.IO.Mdl3kCTabWriter",initialize:function($super,a){$super();this.setCoordMode(a||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("coordMode",{dataType:DataType.INT,deaultValue:Kekule.CoordMode.UNKNOWN})},doWrite3kBlock:function(a,b){Kekule.IO.MdlUtils.assertIlegalForCtabOutput(a);return this.outputCtab(a,b)},outputCtab:function(b,c){var a=Kekule.IO.MdlStructureUtils.getMoleculeCtabStructureInfo(b);this.writeStartTag("CTAB",c);if(this.getCoordMode()!=Kekule.CoordMode.UNKNOWN){a.coordMode=this.getCoordMode()}c.writeLine(this.generateCountLine(a));this.outputAtomBlock(b,a,c);this.outputBondBlock(b,a,c);this.outputSgroupBlock(b,a,c);this.writeEndTag("CTAB",c)},generateCompatibilityCountLine:function(a){return Kekule.IO.MdlStructureUtils.generateClassicStyleCountLine(a,Kekule.IO.MdlVersion.V3000)},generateCountLine:function(b){var a=["COUNTS"];a.push(b.atoms.length);a.push(b.bonds.length);a.push(b.subGroups.length);a.push(0);a.push(0);return Kekule.IO.Mdl3kValueUtils.mergeValues(a)},outputAtomBlock:function(f,d,g){this.writeStartTag("ATOM",g);for(var c=0,b=d.atoms.length;c<b;++c){var e=d.atoms[c];var a=this.generateAtomLine(c,d.coordMode,e);g.writeLine(a)}this.writeEndTag("ATOM",g)},generateAtomLine:function(b,d,c){var e=Kekule.IO.Mdl3kUtils.coordToStr;var a=[b+1,Kekule.IO.MdlStructureUtils.getAtomTypeStr(c)];if(d==Kekule.CoordMode.COORD2D){var f=c.getAbsCoord2D();a=a.concat([e(f.x),e(f.y),e(0)])}else{var f=c.getAbsCoord3D();a=a.concat([e(f.x),e(f.y),e(f.z)])}a.push(0);if(c.getCharge&&c.getCharge()){a.push({key:"CHG",value:c.getCharge()})}if(c.getRadical&&c.getRadical()){a.push({key:"RAD",value:c.getRadical()})}if(c.getParity&&c.getParity()){a.push({key:"CFG",value:c.getParity()})}if(c.getMassNumber&&c.getMassNumber()){a.push({key:"MASS",value:c.getMassNumber()})}if(c.getExplicitHydrogenCount&&(!Kekule.ObjUtils.isUnset(c.getExplicitHydrogenCount()))){a.push({key:"HCOUNT",value:c.getExplicitHydrogenCount()+1})}return Kekule.IO.Mdl3kValueUtils.mergeValues(a)},outputBondBlock:function(e,d,g){if(d.bonds.length<=0){return}this.writeStartTag("BOND",g);for(var c=0,b=d.bonds.length;c<b;++c){var f=d.bonds[c];var a=this.generateBondLine(c,f,d.atoms);g.writeLine(a)}this.writeEndTag("BOND",g)},generateBondLine:function(g,k,a){var j=[g+1,Kekule.IO.MdlUtils.kekuleBondOrderToMdlType(k.getBondOrder?k.getBondOrder():Kekule.BondOrder.UNSET)];var f=0;var e=[];var b=[];var h=Kekule.IO.MdlStructureUtils.splitConnectedNodes(k);e=[a.indexOf(h.primaryNodes[0])+1,a.indexOf(h.primaryNodes[1])+1];if(h.remainNodes&&h.remainNodes.length){for(var d=0,c=h.remainNodes.length;d<c;++d){b.push(a.indexOf(h.remainNodes[d])+1)}}j=j.concat(e);if(k.getStereo&&k.getStereo()){j.push({key:"CFG",value:Kekule.IO.Mdl3kUtils.bondStereoToMdlCfg(k.getStereo())})}if(b.length>0){j.push({key:"ENDPTS",value:b});j.push({key:"ATTACH",value:"ALL"})}return Kekule.IO.Mdl3kValueUtils.mergeValues(j)},outputSgroupBlock:function(e,d,f){if(d.subGroups.length<=0){return}this.writeStartTag("SGROUP",f);for(var c=0,b=d.subGroups.length;c<b;++c){var a=this.generateSgroupLine(c,d.subGroups[c],d);f.writeLine(a)}this.writeEndTag("SGROUP",f)},generateSgroupLine:function(f,t,o){var s=o.atoms;var j=o.bonds;var c=[f+1,"SUP",f+1];var r=[];var d=t.getLeafNodes();for(var n=0,m=d.length;n<m;++n){var f=s.indexOf(d[n]);if(f>=0){r.push(f+1)}}r=r.sort();c.push({key:"ATOMS",value:r});var g=(t.getAbbr&&t.getAbbr())||(t.getFormulaText&&t.getFormulaText())||(t.getName&&t.getName());if(g){c.push({key:"LABEL",value:g})}var e=t.getCrossConnectors();var a=[];var k=[];var h=Kekule.IO.Mdl3kUtils.coordToStr;for(var n=0,m=e.length;n<m;++n){var f=j.indexOf(e[n]);if(f>=0){a.push(f+1);var q=[f+1];var p=Kekule.IO.MdlStructureUtils.splitConnectedNodes(e[n]);var d=p.primaryNodes;var b={};if(d.length==2){if(o.coordMode==Kekule.CoordMode.COORD2D){b=Kekule.CoordUtils.substract(d[0].getAbsCoord2D(),d[1].getAbsCoord2D());q=q.concat([h(b.x),h(b.y),0])}else{b=Kekule.CoordUtils.substract(d[0].getAbsCoord3D(),d[1].getAbsCoord3D());q=q.concat([h(b.x),h(b.y),h(b.z)])}}k.push(q)}}a=a.sort();c.push({key:"XBONDS",value:a});for(var n=0,m=k.length;n<m;++n){c.push({key:"CSTATE",value:k[n]})}return Kekule.IO.Mdl3kValueUtils.mergeValues(c)}});Kekule.globalOptions.add("IO.mdl",{mdlVersion:Kekule.IO.MdlVersion.V2000,coordMode:Kekule.CoordMode.UNKNOWN});Kekule.IO.MdlStructureFragmentReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlStructureFragmentReader",initialize:function($super,a){$super();this.setCoordMode(a||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},createFragment:function(a){},createCtabReader:function(a){if(a==Kekule.IO.MdlVersion.V3000){return new Kekule.IO.Mdl3kCTabReader()}else{return new Kekule.IO.Mdl2kCTabReader()}},getCtabVersion:function(d){var c=d.getCurrLineNo();var a=d.readLine();d.setCurrLineNo(c);var b=a.substr(33,6).trim();if(b=="V3000"){return Kekule.IO.MdlVersion.V3000}else{if(b=="V2000"){return Kekule.IO.MdlVersion.V2000}else{return Kekule.IO.MdlVersion.V2000}}},createStructureFromJson:function(c,b){var a=this.createFragment();if(a){Kekule.IO.MdlStructureUtils.fillFragment(a,c,this.getCoordMode())}return a},doReadBlock:function($super,f,d){var b=this.getCtabVersion(f);if(!b){return null}var e=this.createCtabReader(b);var c=e.doReadBlock(f,d);if(c.atomInfos.coordMode){this._forceCoordMode=c.atomInfos.coordMode}var a=this.createStructureFromJson(c,d);return a}});Kekule.IO.MdlStructureFragmentWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.MdlStructureFragmentWriter",initialize:function($super,a,b){$super();this.setMdlVersion(a||Kekule.IO.MdlVersion.V2000);this.setCoordMode(b||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000});this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},createCtabWriter:function(a){if(a==Kekule.IO.MdlVersion.V3000){return new Kekule.IO.Mdl3kCTabWriter(this.getCoordMode())}else{return new Kekule.IO.Mdl2kCTabWriter(this.getCoordMode())}},doWriteBlock:function($super,b,d){var a=this.createCtabWriter(this.getMdlVersion());var c=a.writeBlock(b);d.writeText(c)}});Kekule.IO.Mdl3kMoleculeCTabReader=Class.create(Kekule.IO.MdlStructureFragmentReader,{CLASS_NAME:"Kekule.IO.Mdl3kMoleculeCTabReader",createFragment:function(a){return new Kekule.Molecule()},doReadBlock:function($super,d,b){var c=this.createCtabReader(Kekule.IO.MdlVersion.V3000);var a=c.doReadBlock(d,b);return this.createStructureFromJson(a,b)}});Kekule.IO.Mdl3kMoleculeCTabWriter=Class.create(Kekule.IO.MdlStructureFragmentWriter,{CLASS_NAME:"Kekule.IO.Mdl3kMoleculeCTabWriter",initialize:function($super,a){$super(Kekule.IO.MdlVersion.V3000,a)},doWriteBlock:function($super,b,d){var a=new Kekule.IO.Mdl3kCTabWriter(this.getCoordMode());var c=a.writeBlock(b);d.writeText(c)}});Kekule.IO.MdlMoleculeReader=Class.create(Kekule.IO.MdlStructureFragmentReader,{CLASS_NAME:"Kekule.IO.MdlMoleculeReader",createFragment:function(b){var a=new Kekule.Molecule();return a},readHeaderInfo:function(g,d){var b={};var c=g.readLine();if(c){b.name=c}var a=g.readLine();var e=this.readInfoLine(a);if(e){b=Object.extend(b,e)}var f=g.readLine();if(f){b.comment=f}return b},readInfoLine:function(b){var a={};if(b.trim()){var c=b.substr(0,2).trim();if(c){a.userAbbr=c}c=b.substr(2,8).trim();if(c){a.programName=c}c=b.substr(10,10);if(c.trim()){a.date=Kekule.IO.MdlUtils.analysisMdlDateTimeStr(c,false)}c=b.substr(20,2);a.coordMode=(c=="3D")?Kekule.CoordMode.COORD3D:((c=="2D")?Kekule.CoordMode.COORD2D:Kekule.CoordMode.UNKNOWN)}return a},doReadBlock:function($super,e,d){var b=this.readHeaderInfo(e,d);if(b&&(typeof(b.coordMode)!="undefined")){this.setCoordMode(b.coordMode)}var c=$super(e,d);if(c&&b){b.name?c.setName(b.name):null;b.userAbbr?c.setInfoValue("author",b.userAbbr):null;b.programName?c.setInfoValue("generator",b.programName):null;b.date?c.setInfoValue("date",b.date):null;b.comment?c.setInfoValue("comment",b.comment):null}if(!e.eof()){var a=e.getCurrLine();if(a.trim().toUpperCase()==="M  END"){e.readLine()}}return c}});Kekule.IO.MdlMoleculeWriter=Class.create(Kekule.IO.MdlStructureFragmentWriter,{CLASS_NAME:"Kekule.IO.MdlMoleculeWriter",writeHeaderInfo:function(b,d){d.writeLine(b.getName()||Kekule.$L("Texts.UNNAMED")||"");var a=this.generateInfoLine(b);d.writeLine(a);var c=b.getInfoValue("comment");d.writeLine(c||"")},generateInfoLine:function(d){var c="";var b=d.getInfoValue("author");c+=b?b.toString().substr(0,2).rpad(2):"  ";var e=d.getInfoValue("generator");c+=e?e.toString().substr(0,8).rpad(8):Kekule.LIBNAME_CORE.rpad(8);var a=d.getInfoValue("date")||new Date();c+=Kekule.IO.MdlUtils.generateMdlDateTimeStr(a,false);c+=(this.getCoordMode()==Kekule.CoordMode.COORD3D)?"3D":"2D";return c},getMolecule:function(a){return Kekule.ChemStructureUtils.getTotalStructFragment(a)},doWriteBlock:function($super,c,d){var b=this.getMolecule(c);if(b){var a=Kekule.IO.MdlStructureUtils.getMoleculeCtabStructureInfo(b);this.setCoordMode(a.coordMode);this.writeHeaderInfo(b,d);if(this.getMdlVersion()==Kekule.IO.MdlVersion.V3000){d.writeLine(Kekule.IO.MdlStructureUtils.generateClassicStyleCountLine(a,this.getMdlVersion()))}$super(b,d);if(this.getMdlVersion()==Kekule.IO.MdlVersion.V3000){d.writeLine("M  END")}}else{}}});Kekule.IO.MdlStructDataReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlStructDataReader",DATA_HEAD_PREFIX:Kekule.IO.MDL.SD_DATA_HEAD_PREFIX,DATA_DBFIELD_PATTERN:/\bDT(\d+)\b/,DATA_KEY_NAME_PATTERN:/\<(.+)\>/,MOL_DELIMITER:Kekule.IO.MDL.MOL_DELIMITER,doReadBlock:function(c,g){var n=new Kekule.IO.MdlMoleculeReader();try{var o,f;var h;var b=[];while(!c.eof()){try{h=n.doReadBlock(c,null)}catch(m){h=null}if(h){b.push(h);o=null;f=null;while(!c.eof()){var a=this.analysisDataLine(c.readLine());if(a){var k=a.lineType;if(k==="dataheader"){o=a.key}else{if(k==="datavalue"){if(o){f=a.value;h.setInfoValue(o,f)}}else{if(k==="moldelimiter"){break}}}}}}else{break}}if(b.length>1){var p=new Kekule.ChemObjList();for(var j=0,d=b.length;j<d;++j){p.append(b[j])}return p}else{return b[0]}}finally{n.finalize()}},analysisDataLine:function(a){var e,b,d;var c=a.trim();if(c.startsWith(this.DATA_HEAD_PREFIX)){e="dataheader";b=this.getDataHeaderKey(a);if(b){return{lineType:e,key:b}}else{return null}}else{if(c.startsWith(this.MOL_DELIMITER)){return{lineType:"moldelimiter"}}else{if(!c){return null}else{return{lineType:"datavalue",value:a}}}}},getDataHeaderKey:function(b){var c=null;var a=this.DATA_KEY_NAME_PATTERN.exec(b);if(a&&(a.length>1)){c=a[1]}else{a=this.DATA_DBFIELD_PATTERN.exec(b);if(a&&(a.length>1)){c=a[1]}else{c=b}}return c},doReadDataBlock:function(c,b){var a=c.readLine()}});Kekule.IO.MdlStructDataWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.MdlStructDataWriter",IGNORED_INFO_FIELDS:["generator","author","date","comment"],initialize:function($super,a,b){$super();this.setMdlVersion(a||Kekule.IO.MdlVersion.V2000);this.setCoordMode(b||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000});this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},doWriteBlock:function(h,b){var a=this.getChildMols(h);var d=new Kekule.IO.MdlMoleculeWriter();d.setMdlVersion(this.getMdlVersion());d.setCoordMode(this.getCoordMode());for(var g=0,c=a.length;g<c;++g){var e=a[g];var j=d.writeBlock(e);b.writeText(j);var f=this.getMolData(e);this.doWriteDataBlock(f,b);b.writeLine(Kekule.IO.MDL.MOL_DELIMITER)}},doWriteDataBlock:function(f,h){var d=Kekule.ObjUtils.getOwnedFieldNames(f);for(var c=0,a=d.length;c<a;++c){var b=d[c];if(this.IGNORED_INFO_FIELDS.indexOf(b)<0){var g=Kekule.IO.MDL.SD_DATA_HEAD_PREFIX+" <"+b+">";var e=f[b];if(g&&e){h.writeLine(g);h.writeLine(e);h.writeLine("")}}}},getChildMols:function(f){var d=Kekule.ChemStructureUtils.getChildStructureObjs(f,true);var a=[];for(var c=0,b=d.length;c<b;++c){var e=d[c];if(e instanceof Kekule.StructureFragment){a.push(e)}}return a},getMolData:function(a){var b=a.getInfo?a.getInfo()||{}:null;return b}});Kekule.IO.MdlBaseReactionReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlBaseReactionReader",readHeaderBlock:function(e,d){var a={};var c;var b=e.readLine().trim();c=b.substr(0,4);if(c!="$RXN"){Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL_RXN_DATA"));return null}else{c=b.substr(4).trim();if(c=="V3000"){a.version=Kekule.IO.MdlVersion.V3000}else{a.version=Kekule.IO.MdlVersion.V2000}}b=e.readLine().trim();if(b){a.name=b}b=e.readLine();c=b.substr(0,6).trim();if(c){a.userAbbr=c}c=b.substr(6,9).trim();if(c){a.programName=c}c=b.substr(15,10);if(c.trim()){a.date=Kekule.IO.MdlUtils.analysisMdlDateTimeStr(c,true)}b=e.readLine().trim();if(b){a.comment=b}return a},readSubstanceCountLine:function(a){},readMolBlock:function(a){},doReadBlock:function($super,a,c){var f=this.readHeaderBlock(a,null);var e=this.readSubstanceCountLine(a.readLine());var h=new Kekule.Reaction();var g="";for(var d=0;d<e.reactantCount;++d){var b=this.readMolBlock(a);if(b){h.appendReactant(b)}}for(var d=0;d<e.productCount;++d){var b=this.readMolBlock(a);if(b){h.appendProduct(b)}}if(h&&f){f.name?h.setName(f.name):null;f.userAbbr?h.setInfoValue("author",f.userAbbr):null;f.programName?h.setInfoValue("generator",f.programName):null;f.date?h.setInfoValue("date",f.date):null;f.comment?h.setInfoValue("comment",f.comment):null}return h}});Kekule.IO.Mdl2kReactionReader=Class.create(Kekule.IO.MdlBaseReactionReader,{CLASS_NAME:"Kekule.IO.Mdl2kReactionReader",readHeaderBlock:function($super,c,b){var a=$super(c,b);if(a.version!=Kekule.IO.MdlVersion.V2000){Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL2000_RXN_DATA"));return null}else{return a}},readSubstanceCountLine:function(b){var a={};a.reactantCount=parseInt(b.substr(0,3),10)||0;a.productCount=parseInt(b.substr(3,3),10)||0;return a},readMolBlock:function(c){var b=c.readLine();while((b!=="$MOL")&&(!c.eof())){b=c.readLine()}if(c.eof()){return null}var a=[];var b=c.getCurrLine();while((b!=="$MOL")&&(!c.eof())){a.push(b);c.incCurrLineNo();b=c.getCurrLine()}return(new Kekule.IO.MdlMoleculeReader()).readBlock(a,null)}});Kekule.IO.Mdl3kReactionReader=Class.create(Kekule.IO.MdlBaseReactionReader,{CLASS_NAME:"Kekule.IO.Mdl3kReactionReader",createTextBuffer:function(){return(new Kekule.IO.Mdl3kTextBuffer())},readHeaderBlock:function($super,c,b){var a=$super(c,b);if(a.version!=Kekule.IO.MdlVersion.V3000){Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL3000_RXN_DATA"));return null}else{return a}},readSubstanceCountLine:function(b){var a={};var c=Kekule.IO.Mdl3kValueUtils.splitValues(b);if(c.shift().value.trim()!="COUNTS"){Kekule.error(Kekule.$L("ErrorMsg.NOT_MDL3000_RXN_COUNTLINE"));return null}a.reactantCount=parseInt(c.shift().value,10)||0;a.productCount=parseInt(c.shift().value,10)||0;return a},readMolBlock:function(b){if(b.getBlockBuffer){var a=b.getBlockBuffer("CTAB");return(new Kekule.IO.Mdl3kMoleculeCTabReader()).doReadBlock(a)}else{return null}}});Kekule.IO.MdlReactionReader=Class.create(Kekule.IO.MdlBlockReader,{CLASS_NAME:"Kekule.IO.MdlReactionReader",doReadBlock:function(d,c){var a;var b=Kekule.IO.MdlUtils.getRxnMarkVersion(d.getCurrLine());if(b==Kekule.IO.MdlVersion.V3000){a=new Kekule.IO.Mdl3kReactionReader()}else{a=new Kekule.IO.Mdl2kReactionReader()}return a.readBlock(d.getUnreadLines(),c)}});Kekule.IO.MdlReactionWriter=Class.create(Kekule.IO.MdlBlockWriter,{CLASS_NAME:"Kekule.IO.MdlReactionWriter",initialize:function($super,a,b){$super();this.setMdlVersion(a||Kekule.IO.MdlVersion.V2000);this.setCoordMode(b||Kekule.CoordMode.UNKNOWN)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000});this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},writeHeaderBlock:function(d,g){var c;c="$RXN"+((this.getMdlVersion()==Kekule.IO.MdlVersion.V3000)?" "+Kekule.IO.MDL.VER3000:"");g.writeLine(c);g.writeLine(d.getName()||"");var b=d.getInfoValue("author")||"";c=b.substr(0,6).rpad(6);var e=d.getInfoValue("generator")||"";c+=e.substr(0,9).rpad(9);var a=d.getInfoValue("date")||new Date();c+=Kekule.IO.MdlUtils.generateMdlDateTimeStr(a,true);g.writeLine(c);var f=d.getInfoValue("comment")||"";g.writeLine(f)},generateSubstanceCountLine:function(a){if(this.getMdlVersion()==Kekule.IO.MdlVersion.V3000){return"M  V30 COUNTS "+Kekule.IO.Mdl3kValueUtils.mergeValues([a.getReactantCount(),a.getProductCount()])}return a.getReactantCount().toString().lpad(3)+a.getProductCount().toString().lpad(3)},writeMolDelimiterLine:function(a){if(this.getMdlVersion()==Kekule.IO.MdlVersion.V2000){a.writeLine("$MOL")}},writeMolBlock:function(b,d){var a=this.getMdlVersion()==Kekule.IO.MdlVersion.V3000?new Kekule.IO.Mdl3kMoleculeCTabWriter(this.getCoordMode()):new Kekule.IO.MdlMoleculeWriter(this.getMdlVersion(),this.getCoordMode());var c=a.writeBlock(b);d.writeText(c)},doWriteBlock:function($super,c,e){var a=this.getMdlVersion()==Kekule.IO.MdlVersion.V3000;this.writeHeaderBlock(c,e);var d=this.generateSubstanceCountLine(c);e.writeLine(d);if(a){e.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockStartTag("REACTANT"))}for(var b=0;b<c.getReactantCount();++b){this.writeMolDelimiterLine(e);this.writeMolBlock(c.getReactantAt(b),e)}if(a){e.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockEndTag("REACTANT"))}if(a){e.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockStartTag("PRODUCT"))}for(var b=0;b<c.getProductCount();++b){this.writeMolDelimiterLine(e);this.writeMolBlock(c.getProductAt(b),e)}if(a){e.writeLine("M  V30 "+Kekule.IO.Mdl3kUtils.get3kBlockEndTag("PRODUCT"));e.writeLine("M  END")}}});Kekule.IO.BaseMdlReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.BaseMdlReader",doReadData:function(b,a,c){if(a!=Kekule.IO.ChemDataType.TEXT){Kekule.error(Kekule.$L("ErrorMsg.MDL_INPUT_DATATYPE_NOT_TEXT"));return null}else{return this.doReadMdlData(b)}},doReadMdlData:function(a){return null}});Kekule.IO.BaseMdlWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.BaseMdlWriter",initialize:function($super,a){$super(a);if(!a){a={}}this.setMdlVersion(a.mdlVersion||Kekule.globalOptions.IO.mdl.mdlVersion);this.setCoordMode(a.coordMode||Kekule.globalOptions.IO.mdl.coordMode)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000});this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},doWriteData:function($super,d,b,c){var a=b||Kekule.IO.ChemDataType.TEXT;if(a!=Kekule.IO.ChemDataType.TEXT){Kekule.error(Kekule.$L("ErrorMsg.MDL_OUTPUT_DATATYPE_NOT_TEXT"));return null}else{return $super(d,a,c)}}});Kekule.IO.MdlMolReader=Class.create(Kekule.IO.BaseMdlReader,{CLASS_NAME:"Kekule.IO.MdlMolReader",doReadMdlData:function(b){var a=new Kekule.IO.MdlMoleculeReader();return a.readBlock(b,null)}});Kekule.IO.MdlMolWriter=Class.create(Kekule.IO.BaseMdlWriter,{CLASS_NAME:"Kekule.IO.MdlMolWriter",doWriteData:function(d,a,c){var b=new Kekule.IO.MdlMoleculeWriter(this.getMdlVersion(),this.getCoordMode());return b.writeBlock(d)}});Kekule.IO.MdlSdReader=Class.create(Kekule.IO.BaseMdlReader,{CLASS_NAME:"Kekule.IO.MdlSdReader",doReadMdlData:function(b){var a=new Kekule.IO.MdlStructDataReader();return a.readBlock(b,null)}});Kekule.IO.MdlSdWriter=Class.create(Kekule.IO.BaseMdlWriter,{CLASS_NAME:"Kekule.IO.MdlSdWriter",doWriteData:function(d,a,c){var b=new Kekule.IO.MdlStructDataWriter(this.getMdlVersion(),this.getCoordMode());return b.writeBlock(d)}});Kekule.IO.MdlRxnReader=Class.create(Kekule.IO.BaseMdlReader,{CLASS_NAME:"Kekule.IO.MdlRxnReader",doReadMdlData:function(b){var a=new Kekule.IO.MdlReactionReader();return a.readBlock(b,null)}});Kekule.IO.MdlRxnWriter=Class.create(Kekule.IO.BaseMdlWriter,{CLASS_NAME:"Kekule.IO.MdlRxnWriter",doWriteData:function(d,a,c){var b=new Kekule.IO.MdlReactionWriter(this.getMdlVersion(),this.getCoordMode());return b.writeBlock(d)}});Kekule.IO.MdlReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.MdlReader",doReadData:function(d,c,e){if(c!=Kekule.IO.ChemDataType.TEXT){Kekule.error(Kekule.$L("ErrorMsg.MDL_INPUT_DATATYPE_NOT_TEXT"));return null}else{var b;var a=d.substr(0,4);if(a=="$RXN"){b=new Kekule.IO.MdlReactionReader()}else{b=new Kekule.IO.MdlMoleculeReader()}return b.readBlock(d,null)}}});Kekule.IO.MdlWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.MdlWriter",initialize:function($super,a){$super(a);var b=a||{};this.setMdlVersion(b.mdlVersion||Kekule.globalOptions.IO.mdl.mdlVersion);this.setCoordMode(b.coordMode||Kekule.globalOptions.IO.mdl.coordMode)},initProperties:function(){this.defineProp("mdlVersion",{dataType:DataType.INT,defaultValue:Kekule.IO.MdlVersion.V2000});this.defineProp("coordMode",{dataType:DataType.INT,defaultValue:Kekule.CoordMode.UNKNOWN})},doWriteData:function(e,a,d){var c;if(e instanceof Kekule.Reaction){c=new Kekule.IO.MdlRxnWriter(this.getMdlVersion(),this.getCoordMode())}else{if(e instanceof Kekule.StructureFragment){c=new Kekule.IO.MdlMolWriter(this.getMdlVersion(),this.getCoordMode())}else{var b=(e&&e.getClassName)?e.getClassName():typeof(e);Kekule.error(Kekule.$L("ErrorMsg.UNABLE_TO_OUTPUT_AS_MDL").format(b));return null}}if(c){return c.writeData(e)}}});(function(){var d="mol";var c="rxn";var f="sd";var b="mol3k";var a="rxn3k";Kekule.IO.DataFormat.MOL=d;Kekule.IO.DataFormat.RXN=c;Kekule.IO.DataFormat.SD=f;Kekule.IO.DataFormat.MOL3K=b;Kekule.IO.DataFormat.RXN3K=a;Kekule.IO.MimeType.MDL_MOL="chemical/x-mdl-molfile";Kekule.IO.MimeType.MDL_RXN="chemical/x-mdl-rxnfile";Kekule.IO.MimeType.MDL_SD="chemical/x-mdl-sdfile";Kekule.IO.DataFormatsManager.register(d,Kekule.IO.MimeType.MDL_MOL,"mol",Kekule.IO.ChemDataType.TEXT,"MDL Mol 2000 format");Kekule.IO.DataFormatsManager.register(c,Kekule.IO.MimeType.MDL_RXN,"rxn",Kekule.IO.ChemDataType.TEXT,"MDL Reaction 2000 format");Kekule.IO.DataFormatsManager.register(f,Kekule.IO.MimeType.MDL_SD,["sd","sdf"],Kekule.IO.ChemDataType.TEXT,"MDL Structure-Data format");Kekule.IO.DataFormatsManager.register(b,Kekule.IO.MimeType.MDL_MOL,"mol",Kekule.IO.ChemDataType.TEXT,"MDL Mol 3000 format");Kekule.IO.DataFormatsManager.register(a,Kekule.IO.MimeType.MDL_RXN,"rxn",Kekule.IO.ChemDataType.TEXT,"MDL Reaction 3000 format");Kekule.IO.ChemDataReaderManager.register("MDL-mol",Kekule.IO.MdlMolReader,[d,b]);Kekule.IO.ChemDataReaderManager.register("MDL-rxn",Kekule.IO.MdlRxnReader,[c,a]);Kekule.IO.ChemDataReaderManager.register("MDL-general",Kekule.IO.MdlReader,[d,b,c,a]);Kekule.IO.ChemDataReaderManager.register("MDL-sd",Kekule.IO.MdlSdReader,f);var e=[Kekule.StructureFragment,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace];Kekule.IO.ChemDataWriterManager.register("MDL-mol",Kekule.IO.MdlMolWriter,e,d);Kekule.IO.ChemDataWriterManager.register("MDL-mol3k",Kekule.IO.MdlMolWriter,e,b,{createOptions:{mdlVersion:Kekule.IO.MdlVersion.V3000}});Kekule.IO.ChemDataWriterManager.register("MDL-rxn",Kekule.IO.MdlRxnWriter,[Kekule.Reaction],c);Kekule.IO.ChemDataWriterManager.register("MDL-rxn3k",Kekule.IO.MdlRxnWriter,[Kekule.Reaction],a);Kekule.IO.ChemDataWriterManager.register("MDL-sd",Kekule.IO.MdlSdWriter,e,f)})();(function(){var a=Kekule.ArrayUtils;Kekule.IO.SMILES={ATOM_BRACKET_LEFT:"[",ATOM_BRACKET_RIGHT:"]",ATOM_WILDCARD:"*",ATOM_H:"H",ORGAN_SUBSET_ATOMS:["B","C","N","O","S","P","F","Cl","Br","I"],AROMATIC_SUBSET_ATOMS:["B","C","N","O","S","P"],BOND_SINGLE:"-",BOND_DOUBLE:"=",BOND_TRIPLE:"#",BOND_QUAD:"$",BOND_AROMATIC:":",BOND_FAKE:".",RING_BOND_TWO_DIGIT_NO_PREFIX:"%",BRANCH_BRACKET_LEFT:"(",BRANCH_BRACKET_RIGHT:")",ROTATION_DIR_CLOCKWISE:"@@",ROTATION_DIR_ANTICLOCKWISE:"@",DIRECTION_BOND_SYMBOLS:["/","\\"]};var b=Kekule.IO.SMILES;Kekule.IO.SmilesUtils={createGraphDepthSpanningTreesEx:function(m,e){var k="__$visitedEx__";var p=function(s){var B={vertexes:[],edges:[],longestPath:{vertexes:[],edges:[],length:0}};var x=s;if(!x.getData(k)){B.vertexes.push(x);x.setData(k,true)}var u=x.getEdges();var y=[];var z;for(var v=0,t=u.length;v<t;++v){var r=u[v];var A=x.getNeighborOnEdge(r);if(!A.getData(k)){B.vertexes.push(A);B.edges.push(r);A.setData(k,true);var w=p(A);B.vertexes=B.vertexes.concat(w.vertexes);B.edges=B.edges.concat(w.edges);if(w.longestPath.length>B.longestPath.length||!B.longestPath.length){B.longestPath.vertexes=w.longestPath.vertexes;B.longestPath.edges=w.longestPath.edges;B.longestPath.length=w.longestPath.length;z=r}}}if(z){B.longestPath.edges.unshift(z);B.longestPath.length=(B.longestPath.length||0)+1}B.longestPath.vertexes.unshift(x);return B};var j=a.clone(m.getVertexes());for(var h=0,f=j.length;h<f;++h){j[h].setData(k,false)}var q=[];while(j.length){var g;if(e&&(j.indexOf(e)>=0)){g=e}else{g=j[0]}var n={vertexes:[],edges:[],longestPath:{vertexes:[],edges:[],length:0}};var o=p(g);n.vertexes=n.vertexes.concat(o.vertexes);n.edges=n.edges.concat(o.edges);n.longestPath.length=(n.longestPath.length||0)+o.longestPath.length;n.longestPath.vertexes=n.longestPath.vertexes.concat(o.longestPath.vertexes);n.longestPath.edges=n.longestPath.edges.concat(o.longestPath.edges);j=a.exclude(j,o.vertexes);q.push(n)}return q}};Kekule.IO.SmilesMolWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.SmilesMolWriter",doWriteData:function(i,e,h,f){var g=this.getMolecule(i);return this.writeStructFragment(g,f)},getMolecule:function(e){return Kekule.ChemStructureUtils.getTotalStructFragment(e)},writeStructFragment:function(w,f){if(w.hasCtab()){var e=w.clone();if(e.standardize){e.standardize()}var z=[];var s=[];if(e.getAromaticRings){var t=e.getAromaticRings();for(var u=0,q=t.length;u<q;++u){var h=t[u];a.pushUnique(z,h.nodes);a.pushUnique(s,h.connectors)}}var k=Kekule.GraphAdaptUtils.ctabToGraph(e.getCtab(),null,{expandSubStructures:true,ignoreBondedHydrogen:true});var g=k.getVertexes();var v=k.getEdges();var y=g[g.length-1];var j=Kekule.IO.SmilesUtils.createGraphDepthSpanningTreesEx(k,y);var o=[];var m;for(var u=0,q=j.length;u<q;++u){var p=j[u];var r=p.longestPath;var x="";var n=r.vertexes[0];x=this._writeMolVertex(n,null,r.edges,p.edges,o,z,s,f);if(u===0){m=x}else{m+=b.BOND_FAKE+x}}return m}else{return""}},_writeMolVertex:function(t,O,g,k,u,G,m,z){var D=t.getData("object");var p=t.getEdges();var j;var F=[];var H;var e=[];var Q=[];var f=[];var n;var w="";var B=z.ignoreStereoBond;if(Kekule.ObjUtils.isUnset(B)){B=z.ignoreStereo||false}for(var K=p.length-1;K>=0;--K){var o=p[K];if(o===O){continue}var h=o.getData("object");if(!B&&h.getParity&&h.getParity()){var C=Kekule.MolStereoUtils.getStereoBondKeyNodes(h);if(C){var x=t.getNeighborOnEdge(o);var A=x.getData("object");var y=this._getStereoDoubleBondInitialDirectionSymbols(h);var J=y[0];if(C.indexOf(A)<0){J=this._getInvertBondDirectionSymbol(J)}}w=J}if(k.indexOf(o)>=0){var x=t.getNeighborOnEdge(o);var E=this._writeMolVertex(x,o,g,k,u,G,m,z);if(g.indexOf(o)>=0){H=x;j=E}else{e.push(x);F.push(E)}}else{var L=u.indexOf(o);if(L<0){L=u.length;u.push(o)}f.push(t.getNeighborOnEdge(o));var P=this._outputConnectorStr(h,o.getVertexes()[0].getData("object"),o.getVertexes()[1].getData("object"),G,m);L=L+1;P+=(L<10)?L:b.RING_BOND_TWO_DIGIT_NO_PREFIX+L;Q.push(P)}}var s="";var r;var q="";if(O){if(w){s+=w}var M=t.getNeighborOnEdge(O);r=M.getData("object");var N=O.getData("object");if(!B&&N.getParity&&N.getParity()){var C=Kekule.MolStereoUtils.getStereoBondKeyNodes(N);if(C){var y=this._getStereoDoubleBondInitialDirectionSymbols(N);var J=y[1];if(C.indexOf(r)<0){J=this._getInvertBondDirectionSymbol(J)}}q+=J}s+=this._outputConnectorStr(N,O.getVertexes()[0].getData("object"),O.getVertexes()[1].getData("object"),G,m)}var v=[];for(var K=0,I=f.length;K<I;++K){v.push(f[K].getData("object"))}for(var K=0,I=e.length;K<I;++K){v.push(e[K].getData("object"))}if(H){v.push(H.getData("object"))}s+=this._outputNodeStr(D,G.indexOf(D)>=0,r,v,z);for(var K=0,I=Q.length;K<I;++K){s+=Q[K]}if(!j&&F.length){j=F.shift()}for(var K=0,I=F.length;K<I;++K){s+=b.BRANCH_BRACKET_LEFT+F[K]+b.BRANCH_BRACKET_RIGHT}s+=q;if(j){s+=j}return s},_outputNodeStr:function(h,n,e,r,s){var t;var j;if(h instanceof Kekule.Atom){j=h.getSymbol();t=j;if(n){t=t.toLowerCase()}}else{t=b.ATOM_WILDCARD}var p=s.ignoreStereoAtom;if(Kekule.ObjUtils.isUnset(p)){p=s.ignoreStereo||false}var q;if(!p&&h.getParity&&h.getParity()){if(r&&r.length){var l=h.getHydrogenCount?(h.getHydrogenCount(true)||0):0;var g=Kekule.MolStereoUtils.calcTetrahedronChiralCenterRotationDirection(null,h,e,r,!!l,false);var q=(g===Kekule.RotationDir.CLOCKWISE)?b.ROTATION_DIR_CLOCKWISE:(g===Kekule.RotationDir.ANTICLOCKWISE)?b.ROTATION_DIR_ANTICLOCKWISE:"";if(q){t+=q}}}var i;if(q){i=h.getHydrogenCount?(h.getHydrogenCount(true)||0):0}else{i=h.getExplicitHydrogenCount?h.getExplicitHydrogenCount():0;if(!i&&n&&(j!=="C")&&h.getImplicitHydrogenCount){i=h.getImplicitHydrogenCount()}}if(i){t+=b.ATOM_H;var l=Math.round(i);if(l>1){t+=l}}var m=Math.round(h.getCharge());if(m){var f=(m>0)?"+":"-";if(m>1||m<-1){f=Math.abs(m)+f}t+=f}var k=h.getMassNumber?h.getMassNumber():null;if(k){t=Math.abs(k)+t}var o=false;if(!i&&!m&&!k&&!q){if((!n&&b.ORGAN_SUBSET_ATOMS.indexOf(j)>=0)||(n&&b.AROMATIC_SUBSET_ATOMS.indexOf(j)>=0)){o=true}}if(!o){t=b.ATOM_BRACKET_LEFT+t+b.ATOM_BRACKET_RIGHT}return t},_outputConnectorStr:function(h,i,g,j,l){if(h instanceof Kekule.Bond){if(h.getBondType()===Kekule.BondType.COVALENT){if(l.indexOf(h)>=0){return""}else{var f=(j.indexOf(i)>=0)&&(j.indexOf(g)>=0);var e=h.getBondOrder();var k=Kekule.BondOrder;return(e===k.DOUBLE)?b.BOND_DOUBLE:(e===k.TRIPLE)?b.BOND_TRIPLE:(e===k.QUAD)?b.BOND_QUAD:f?b.BOND_SINGLE:""}}}return b.BOND_FAKE},_getStereoDoubleBondInitialDirectionSymbols:function(f){var e=f.getParity();if(e===Kekule.StereoParity.EVEN){return[b.DIRECTION_BOND_SYMBOLS[0],b.DIRECTION_BOND_SYMBOLS[0]]}else{return[b.DIRECTION_BOND_SYMBOLS[0],b.DIRECTION_BOND_SYMBOLS[1]]}},_getInvertBondDirectionSymbol:function(e){if(e===b.DIRECTION_BOND_SYMBOLS[1]){return b.DIRECTION_BOND_SYMBOLS[0]}else{return b.DIRECTION_BOND_SYMBOLS[1]}}});Kekule.IO.MimeType.SMILES="chemical/x-daylight-smiles";Kekule.IO.DataFormat.SMILES="smi";var d="smi";Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.SMILES,Kekule.IO.MimeType.SMILES,["smi","smiles"],Kekule.IO.ChemDataType.TEXT,"SMILES format");var c=[Kekule.StructureFragment,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace];Kekule.IO.ChemDataWriterManager.register("SMILES",Kekule.IO.SmilesMolWriter,c,[Kekule.IO.DataFormat.SMILES])})();Kekule.globalOptions.add("IO.kekuleNative",{prettyPrint:true});Kekule.IO.KcjReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.KcjReader",readData:function($super,c,b){var a=b||Kekule.IO.ChemDataType.TEXT;var d;if(a==Kekule.IO.ChemDataType.JSON){d=c}if(a==Kekule.IO.ChemDataType.TEXT){d=JsonUtility.parse(c)}else{Kekule.error(Kekule.$L("ErrorMsg.KCJ_INPUT_DATATYPE_NOT_JSON_OR_TEXT"));return null}return $super(d,Kekule.IO.ChemDataType.JSON)},doReadData:function(c,a){var b=ObjSerializerFactory.getSerializer("json");if(!b){Kekule.error(Kekule.$L("ErrorMsg.JSON_SERIALIZER_NOT_EXISTS"));return null}return b.load(null,c)}});Kekule.IO.KcjWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.KcjWriter",initialize:function($super,a){$super(a);var b=a||{};this.setPrettyPrint(Kekule.ObjUtils.isUnset(b.prettyPrint)?Kekule.globalOptions.IO.kekuleNative.prettyPrint:b.prettyPrint)},initProperties:function(){this.defineProp("prettyPrint",{dataType:DataType.BOOL,defaultValue:true})},writeData:function($super,f,c,e,d){var b=c||Kekule.IO.ChemDataType.TEXT;if((b!=Kekule.IO.ChemDataType.JSON)&&(b!=Kekule.IO.ChemDataType.TEXT)){Kekule.error(Kekule.$L("ErrorMsg.KCJ_OUTPUT_DATATYPE_NOT_JSON_OR_TEXT"));return null}var a=$super(f,Kekule.IO.ChemDataType.JSON);if(b==Kekule.IO.ChemDataType.JSON){return a}if(b==Kekule.IO.ChemDataType.TEXT){var g=(d&&Kekule.ObjUtils.notUnset(d.prettyPrint))?d.prettyPrint:this.getPrettyPrint();return JsonUtility.serializeToStr(a,{prettyPrint:g})}},doWriteData:function(e,a,d,b){var c=ObjSerializerFactory.getSerializer("json");if(!c){Kekule.error(Kekule.$L("ErrorMsg.JSON_SERIALIZER_NOT_EXISTS"));return null}var f={};c.save(e,f);return f}});Kekule.IO.KcxReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.KcxReader",readData:function($super,c,b){var a=b||Kekule.IO.ChemDataType.TEXT;var e;if(a==Kekule.IO.ChemDataType.DOM){e=c}if(a==Kekule.IO.ChemDataType.TEXT){var d=XmlUtility.parse(c);e=d.documentElement}else{Kekule.error(Kekule.$L("ErrorMsg.KCX_INPUT_DATATYPE_NOT_DOM_OR_TEXT"));return null}return $super(e,Kekule.IO.ChemDataType.DOM)},doReadData:function(c,a){var b=ObjSerializerFactory.getSerializer("xml");if(!b){Kekule.error(Kekule.$L("ErrorMsg.XML_SERIALIZER_NOT_EXISTS"));return null}return b.load(null,c)}});Kekule.IO.KcxWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.KcxWriter",initialize:function($super,a){$super(a);var b=a||{};this.setPrettyPrint(Kekule.ObjUtils.isUnset(b.prettyPrint)?Kekule.globalOptions.IO.kekuleNative.prettyPrint:b.prettyPrint);this.setRootTag(b.rootTag||"kcx")},initProperties:function(){this.defineProp("prettyPrint",{dataType:DataType.BOOL,defaultValue:true});this.defineProp("rootTag",{dataType:DataType.STRING})},writeData:function($super,e,c){var b=c||Kekule.IO.ChemDataType.TEXT;if((b!=Kekule.IO.ChemDataType.DOM)&&(b!=Kekule.IO.ChemDataType.TEXT)){Kekule.error(Kekule.$L("ErrorMsg.KCX_OUTPUT_DATATYPE_NOT_DOM_OR_TEXT"));return null}var a=$super(e,Kekule.IO.ChemDataType.DOM);if(b==Kekule.IO.ChemDataType.DOM){return a}if(b==Kekule.IO.ChemDataType.TEXT){var d={prettyPrint:this.getPrettyPrint()};return XmlUtility.serializeNode(a,d)}},doWriteData:function(d,a){var b=ObjSerializerFactory.getSerializer("xml");if(!b){Kekule.error(Kekule.$L("ErrorMsg.XML_SERIALIZER_NOT_EXISTS"));return null}var c=XmlUtility.newDocument(this.getRootTag());b.save(d,c.documentElement);return c.documentElement}});(function(){Kekule.IO.MimeType.KEKULE_JSON="chemical/x-kekule-json";Kekule.IO.MimeType.KEKULE_XML="chemical/x-kekule-xml";Kekule.IO.DataFormat.KEKULE_JSON="Kekule-JSON";Kekule.IO.DataFormat.KEKULE_XML="Kekule-XML";Kekule.IO.DataFormatsManager.register("JSON",Kekule.IO.MimeType.JSON,"json",Kekule.IO.ChemDataType.TEXT,"JSON format");Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.KEKULE_JSON,Kekule.IO.MimeType.KEKULE_JSON,"kcj",Kekule.IO.ChemDataType.TEXT,"Kekule Chemical JSON format");Kekule.IO.DataFormatsManager.register(Kekule.IO.DataFormat.KEKULE_XML,Kekule.IO.MimeType.KEKULE_XML,"kcx",Kekule.IO.ChemDataType.TEXT,"Kekule Chemical XML format");var b=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.JSON);var c=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.KEKULE_JSON);var a=Kekule.IO.DataFormatsManager.findFormatId(Kekule.IO.MimeType.KEKULE_XML);Kekule.IO.ChemDataReaderManager.register("json",Kekule.IO.KcjReader,b);Kekule.IO.ChemDataReaderManager.register("kcj",Kekule.IO.KcjReader,c);Kekule.IO.ChemDataReaderManager.register("kcx",Kekule.IO.KcxReader,a);Kekule.IO.ChemDataWriterManager.register("kcj",Kekule.IO.KcjWriter,[Kekule.ChemObject],c,{createOptions:{prettyPrint:!true}});Kekule.IO.ChemDataWriterManager.register("kcx",Kekule.IO.KcxWriter,[Kekule.ChemObject],a,{createOptions:{prettyPrint:true}})})();