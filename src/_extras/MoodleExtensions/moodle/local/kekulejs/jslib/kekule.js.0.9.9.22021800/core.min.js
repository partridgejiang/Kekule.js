Kekule.AbstractConfigs=Class.create(ObjectEx,{CLASS_NAME:"Kekule.AbstractConfigs",CONFIG_PROP_FLAG:"__$config_prop__",initialize:function(e){this.tryApplySuper("initialize"),void 0===e&&(e=!0),e&&this.initPropDefValues()},addConfigProp:function(e,t,r,n){var o={dataType:t};n&&(o=Object.extend(o,n)),void 0!==r&&(o.defaultValue=r);var i=this.defineProp(e,o);return i[this.CONFIG_PROP_FLAG]=!0,i},addHashConfigProp:function(e,t,r){return this.addConfigProp(e,DataType.HASH,t,r)},addStrConfigProp:function(e,t,r){return this.addConfigProp(e,DataType.STRING,t,r)},addNumConfigProp:function(e,t,r){return this.addConfigProp(e,DataType.NUM,t,r)},addIntConfigProp:function(e,t,r){return this.addConfigProp(e,DataType.INT,t,r)},addFloatConfigProp:function(e,t,r){return this.addConfigProp(e,DataType.FLOAT,t,r)},addBoolConfigProp:function(e,t,r){return this.addConfigProp(e,DataType.BOOL,t,r)},initPropDefValues:function(){this.beginUpdate();try{for(var e=this.getAllPropList(),t=0,r=e.getLength();t<r;++t){var n=e.getPropInfoAt(t),o=n.name,i=n.defaultValue;void 0!==i&&this.setPropValue(o,i)}}finally{this.endUpdate()}},isConfigProp:function(e){return!!e[this.CONFIG_PROP_FLAG]},assign:function(e){e.copyPropsTo(this)},doTransformPropNameToHash:function(e){return this.doGetPropNameToHashPrefix()+e},doGetPropNameToHashPrefix:function(){return""},toHash:function(e){var t={},r=this.CONFIG_PROP_FLAG;this.saveObj(t,"json",{saveDefaultValues:!0,propFilter:function(e,t){return e[r]}});for(var n=e||this.doTransformPropNameToHash.bind(this),o={},i=Kekule.ObjUtils.getOwnedFieldNames(t,!1),a=0,s=i.length;a<s;++a){o[n(i[a])]=t[i[a]]}return o}}),Kekule.ConfigPresetMap=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ConfigPresetMap",initialize:function(){this.tryApplySuper("initialize"),this.map=new Kekule.MapEx(!0)},doFinalize:function(){this.map=null,this.tryApplySuper("doFinalize")},set:function(e,t){this.map.set(e,t)},get:function(e){return this.map.get(e)},getHash:function(e){var t=this.get(e);return t?t.toHash?t.toHash():t:null},remove:function(e){this.map.remove(e)},has:function(e){return this.map.has(e)},clear:function(){this.map.clear()}}),Kekule.ElementSeries={NONMETAL:"Nonmetals",METAL:"Metals",ALKALI_METAL:"Alkali Metals",ALKALI_EARTH_METAL:"Alkali Earth Metals",TRANSITION_METAL:"Transition Metals",METALLOID:"Metalloids",HALOGEN:"Halogens",NOBLE_GAS:"Noble Gases",LANTHANIDE:"Lanthanides",ACTINIDE:"Actinides"},Kekule.ElementCategory={NONMETAL:1,METAL:21,ALKALI_METAL:22,ALKALI_EARTH_METAL:23,TRANSITION_METAL:24,METALLOID:11,HALOGEN:3,NOBLE_GAS:2,LANTHANIDE:25,ACTINIDE:26},Kekule.Element=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Element",initialize:function(e){if(this.tryApplySuper("initialize"),e!=Kekule.Element.UNSET_ELEMENT){var t=this.getElementInfo(e);t?(this.setPropStoreFieldValue("symbol",t.symbol),this.setPropStoreFieldValue("atomicNumber",t.atomicNumber),this.setPropStoreFieldValue("group",t.group),this.setPropStoreFieldValue("period",t.period),this.setPropStoreFieldValue("series",t.chemicalSerie),this.setPropStoreFieldValue("naturalMass",t.naturalMass),this.setPropStoreFieldValue("categories",this._getElementCategoriesFromSeries(t.chemicalSerie)),t.name&&this.setPropStoreFieldValue("name",t.name)):Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_CHEMELEMENT")+": "+e:"Invalid chemical element: "+e)}else this.setPropStoreFieldValue("symbol",Kekule.Element.UNSET_ELEMENT),this.setPropStoreFieldValue("atomicNumber",Kekule.Element.UNSET_ELEMENT)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING,serializable:!1,setter:null}),this.defineProp("atomicNumber",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("symbol",{dataType:DataType.STRING,serializable:!1,setter:null}),this.defineProp("group",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("period",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("series",{dataType:DataType.STRING,serializable:!1,setter:null}),this.defineProp("categories",{dataType:DataType.ARRAY,serializable:!1,setter:null}),this.defineProp("naturalMass",{dataType:DataType.FLOAT,serializable:!1,setter:null})},getElementInfo:function(e){return e==Kekule.Element.UNSET_ELEMENT?{symbol:Kekule.Element.UNSET_ELEMENT,atomicNumber:Kekule.Element.UNSET_ELEMENT}:Kekule.Element.isDummyElement(e)?{symbol:Kekule.Element.DUMMY_ELEMENT,atomicNumber:Kekule.Element.DUMMY_ELEMENT_ATOMICNUM}:Kekule.Element.isRGroup(e)?{symbol:Kekule.Element.RGROUP_ELEMENT,atomicNumber:Kekule.Element.RGROUP_ELEMENT_ATMOICNUM}:Kekule.ChemicalElementsDataUtil.getElementInfo(e)},_getElementCategoriesFromSeries:function(e){var t=Kekule.ElementSeries,r=Kekule.ElementCategory,n=[];switch(e){case t.NONMETAL:n=[r.NONMETAL];break;case t.METAL:n=[r.METAL];break;case t.ALKALI_METAL:n=[r.METAL,r.ALKALI_METAL];break;case t.ALKALI_EARTH_METAL:n=[r.METAL,r.ALKALI_EARTH_METAL];break;case t.TRANSITION_METAL:n=[r.METAL,r.TRANSITION_METAL];break;case t.METALLOID:n=[r.METALLOID];break;case t.HALOGEN:n=[r.NONMETAL,r.HALOGEN];break;case t.NOBLE_GAS:n=[r.NONMETAL,r.NOBLE_GAS];break;case t.LANTHANIDE:n=[r.METAL,r.LANTHANIDE];break;case t.ACTINIDE:n=[r.METAL,r.ACTINIDE]}return n},getTheoreticValence:function(){return this.getGroup()?Kekule.Element.getTheoreticValenceOfGroup(this.getGroup()):null},isDummyElement:function(){return this.getAtomicNumber()==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM},isRGroupElement:function(){return this.getAtomicNumber()==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM},isNormalElement:function(){return Kekule.Element.isNormalElement(this.getAtomicNumber())},isSameElement:function(e){return e==Kekule.Element.UNSET_ELEMENT?this.getAtomicNumber()==Kekule.Element.UNSET_ELEMENT:"number"==typeof e?this.getAtomicNumber()==e:this.getSymbol()==e},isHetero:function(){return(this.getSeries()===Kekule.ElementSeries.NONMETAL||this.getSeries()===Kekule.ElementSeries.HALOGEN)&&6!==this.getAtomicNumber()&&1!==this.getAtomicNumber()},belongToCategory:function(e){return(this.getCategories()||[]).indexOf(e)>=0},getLabel:function(){return this.getSymbol()}}),Object.extend(Kekule.Element,Kekule.ChemicalElementsDataUtil),Kekule.Element.UNSET_ELEMENT=void 0,Kekule.Element.DUMMY_ELEMENT="DU",Kekule.Element.DUMMY_ELEMENT_ATOMICNUM=-1,Kekule.Element.RGROUP_ELEMENT="R",Kekule.Element.RGROUP_ELEMENT_ATOMICNUM=-2,Kekule.Element.DEUTERIUM="D",Kekule.Element.isNormalElement=function(e){return e!=Kekule.Element.UNSET_ELEMENT&&!Kekule.Element.isPseudoElement(e)},Kekule.Element.isPseudoElement=function(e){return"string"==typeof e?e==Kekule.Element.DUMMY_ELEMENT||e==Kekule.Element.RGROUP_ELEMENT:e==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM||e==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM},Kekule.Element.isDummyElement=function(e){return e===Kekule.Element.DUMMY_ELEMENT||e===Kekule.Element.DUMMY_ELEMENT_ATOMICNUM},Kekule.Element.isRGroup=function(e){return e===Kekule.Element.RGROUP_ELEMENT||e===Kekule.Element.RGROUP_ELEMENT_ATOMICNUM},Kekule.Element.getTheoreticValenceOfGroup=function(e){return e<=2?e:e<=12?null:e<=17?e-10:0},Kekule.Element.getTheoreticValence=function(e){var t=Kekule.ChemicalElementsDataUtil.getElementInfo(e);return t.group?Kekule.Element.getTheoreticValenceOfGroup(t.group):null},Object.extend(Kekule.Element,{isAtomicNumberAvailable:function(e){return Kekule.ChemicalElementsDataUtil.isAtomicNumberAvailable(e)},isElementSymbolAvailable:function(e){return Kekule.ChemicalElementsDataUtil.isElementSymbolAvailable(e)}}),Kekule.Isotope=Class.create(Kekule.Element,{CLASS_NAME:"Kekule.Isotope",initialize:function(e,t){var r=e,n=t,o=Kekule.IsotopesDataUtil.getIsotopeInfo(e,t);if(o&&(o.atomicNumber&&(r=o.atomicNumber),n=o.massNumber),this.tryApplySuper("initialize",[r]),this.setPropStoreFieldValue("massNumber",n),o&&o.isotopeAlias&&this.setPropStoreFieldValue("isotopeAlias",o.isotopeAlias),Kekule.Element.isNormalElement(r)&&n!==Kekule.Isotope.UNSET_MASSNUMBER){var i=Kekule.IsotopesDataUtil.getIsotopeInfo(this.getAtomicNumber(),n);i?(this.setPropStoreFieldValue("exactMass",i.exactMass),this.setPropStoreFieldValue("naturalAbundance",i.naturalAbundance)):Kekule.chemError((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_ISOTOPE"):"Invalid isotope")+": "+this.getSymbol()+"/"+t)}},initProperties:function(){this.defineProp("massNumber",{dataType:DataType.INTEGER,serializable:!1,setter:null}),this.defineProp("exactMass",{dataType:DataType.FLOAT,serializable:!1,setter:null}),this.defineProp("naturalAbundance",{dataType:DataType.FLOAT,serializable:!1,setter:null}),this.defineProp("isotopeAlias",{dataType:DataType.STRING,serializable:!1,setter:null})},isSame:function(e){return e instanceof Kekule.Isotope&&(e===this||e.getAtomicNumber()==this.getAtomicNumber()&&e.getMassNumber()==this.getMassNumber())},getIsotopeId:function(){return Kekule.IsotopesDataUtil.getIsotopeId(this.getAtomicNumber(),this.getMassNumber())},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()}}),Object.extend(Kekule.Isotope,Kekule.IsotopesDataUtil),Kekule.Isotope.UNSET_MASSNUMBER=void 0,Kekule.Isotope.getIsotopeId=function(e,t){return Kekule.IsotopesDataUtil.getIsotopeId(e,t)},Object.extend(Kekule.Isotope,{isMassNumberAvailable:function(e,t){return Kekule.IsotopesDataUtil.isMassNumberAvailable(e,t)}}),Kekule.IsotopeFactory={GENERIC_ELEMENT_ID:"__GENERIC__",_isotopes:{},getIsotopeId:function(e,t){return e?Kekule.IsotopesDataUtil.getIsotopeId(e,t):Kekule.IsotopeFactory.GENERIC_ELEMENT_ID},getIsotope:function(e,t){var r=Kekule.IsotopeFactory.getIsotopeId(e,t);if(!Kekule.IsotopeFactory._isotopes[r]){var n=new Kekule.Isotope(e,t);Kekule.IsotopeFactory._isotopes[r]=n}return Kekule.IsotopeFactory._isotopes[r]},getIsotopeById:function(e){if(Kekule.IsotopeFactory._isotopes[e])return Kekule.IsotopeFactory._isotopes[e];var t=Kekule.IsotopesDataUtil.getIsotopeIdDetail(e);return t?Kekule.IsotopeFactory.getIsotope(t.symbol,t.massNumber):null}},Kekule.AtomType={UNSET_ATOMTYPE:void 0},Kekule.ElectronSet=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ElectronSet",initialize:function(e){this.tryApplySuper("initialize"),this.setElectronCount(e||Kekule.ElectronSet.UNSET_ELECTRONCOUNT)},initProperties:function(){this.defineProp("electronCount",{dataType:DataType.FLOAT})}}),Kekule.ElectronSet.UNSET_ELECTRONCOUNT=null,Kekule.UnbondedElectronSet=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.UnBondedElectronSet",initialize:function(e){this.tryApplySuper("initialize",[e])},initProperties:function(){}}),Kekule.BondType={COVALENT:"covalent",IONIC:"ionic",COORDINATE:"coordinate",METALLIC:"metallic",HYDROGEN:"hydrogen",UNKNOWN:null,DEFAULT:"covalent"},Kekule.BondOrder={SINGLE:1,DOUBLE:2,TRIPLE:3,QUAD:4,EXPLICIT_AROMATIC:10,OTHER:20,UNSET:null,DEFAULT:1,getBondValence:function(e){return e===Kekule.BondOrder.UNSET?0:e==Kekule.BondOrder.EXPLICIT_AROMATIC?1.5:e}},Kekule.BondForm=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.BondForm",initialize:function(e,t,r){this.tryApplySuper("initialize",[t]),this.setBondOrder(e||Kekule.BondOrder.DEFAULT),Kekule.ObjUtils.notUnset(r)&&this.setBondType(r),Kekule.ObjUtils.notUnset(t)&&this.setElectronCount(t)},initProperties:function(){this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var e=this.getPropStoreFieldValue("bondType");return e||Kekule.BondType.DEFAULT}}),this.defineProp("bondOrder",{dataType:DataType.FLOAT,enumSource:Kekule.BondOrder,setter:function(e){this.getPropStoreFieldValue("bondOrder")!=e&&(this.setPropStoreFieldValue("bondOrder",e),e?this.getBondType()==Kekule.BondType.COVALENT&&this.setElectronCount(2*this.getBondValence()):e===Kekule.BondOrder.UNSET&&this.setElectronCount(Kekule.ElectronSet.UNSET_ELECTRONCOUNT))}}),this.defineProp("electronCount",{dataType:DataType.FLOAT}),this.defineProp("bondValence",{dataType:DataType.FLOAT,serializable:!1,getter:function(){return Kekule.BondOrder.getBondValence(this.getBondOrder())},setter:null})}}),Kekule.BondFormFactory={_bondForms:{},getBondFormId:function(e,t,r){var n="";return r&&(n+=r+"_"),e&&(n+=Number(e).toString()),t&&(n+="_"+Number(t).toString()),n},getBondForm:function(e,t,r){if(e||t||r){if(r||(r=Kekule.BondType.DEFAULT),!t&&e&&r===Kekule.BondType.COVALENT)t=2*Kekule.BondOrder.getBondValence(e);var n=Kekule.BondFormFactory.getBondFormId(e,t,r);return Kekule.BondFormFactory._bondForms[n]||(Kekule.BondFormFactory._bondForms[n]=new Kekule.BondForm(e,t,r)),Kekule.BondFormFactory._bondForms[n]}}},Kekule.RadicalOrder={NONE:0,SINGLET:1,DOUBLET:2,TRIPLET:3,DEFAULT:0,getRadicalElectronCount:function(e){var t=Kekule.RadicalOrder;return Kekule.ObjUtils.isUnset(e)||e===t.NONE?0:e===t.DOUBLET?1:2}},Kekule.HybridizationType={UNKNOWN:null,SP:1,SP2:2,SP3:3,NONE:0},Kekule.ValenceUtils={getPossibleMdlValenceInfo:function(e,t){var r=Math.round(t),n=[],o=0,i=!1;switch(e){case 1:case 3:case 11:case 19:case 37:case 55:case 87:0===r?n=[1]:1===r?n=[0]:i=!0,o=1;break;case 4:case 12:case 20:case 38:case 56:case 88:switch(r){case 0:n=[2];break;case 1:n=[1];break;case 2:n=[0];break;default:i=!0}o=2;break;case 5:switch(r){case-4:n=[1];break;case-3:n=[2];break;case-2:n=[3,5];break;case-1:n=[4];break;case 0:n=[3];break;case 1:n=[2];break;case 2:n=[1];break;case 3:n=[0];break;default:i=!0}o=3;break;case 6:switch(r){case-4:n=[0];break;case-3:n=[1];break;case-2:n=[2];break;case-1:n=[3,5];break;case 0:n=[4];break;case 1:n=[3];break;case 2:n=[2];break;case 3:n=[1];break;case 4:n=[0];break;default:i=!0}o=4;break;case 7:switch(r){case-3:n=[0];break;case-2:n=[1];break;case-1:n=[2];break;case 0:n=[3,5];break;case 1:n=[4];break;case 2:n=[3];break;case 3:n=[2];break;case 4:n=[1];break;case 5:n=[0];break;default:i=!0}o=5;break;case 8:switch(r){case-2:n=[0];break;case-1:n=[1];break;case 0:n=[2];break;case 1:n=[3,5];break;case 2:n=[4];break;case 3:n=[3];break;case 4:n=[2];break;case 5:n=[1];break;case 6:n=[0];break;default:i=!0}o=6;break;case 9:switch(r){case-1:n=[0];break;case 0:n=[1];break;case 1:n=[2];break;case 2:n=[3,5];break;case 3:n=[4];break;case 4:n=[3];break;case 5:n=[2];break;case 6:n=[1];break;case 7:n=[0];break;default:i=!0}o=7;break;case 13:switch(r){case-4:n=[1,3,5,7];break;case-3:n=[2,4,6];break;case-2:n=[3,5];break;case-1:n=[4];break;case 0:n=[3];break;case 1:n=[2];break;case 2:n=[1];break;case 3:n=[0];break;default:i=!0}o=3;break;case 14:switch(r){case-4:n=[0];break;case-3:n=[1,3,5,7];break;case-2:n=[2,4,6];break;case-1:n=[3,5];break;case 0:n=[4];break;case 1:n=[3];break;case 2:n=[2];break;case 3:n=[1];break;case 4:n=[0]}o=4;break;case 15:switch(r){case-3:n=[0];break;case-2:n=[1,3,5,7];break;case-1:n=[2,4,6];break;case 0:n=[3,5];break;case 1:n=[4];break;case 2:n=[3];break;case 3:n=[2];break;case 4:n=[1];break;case 5:n=[0]}o=5;break;case 16:switch(r){case-2:n=[0];break;case-1:n=[1,3,5,7];break;case 0:n=[2,4,6];break;case 1:n=[3,5];break;case 2:n=[4];break;case 3:n=[3];break;case 4:n=[2];break;case 5:n=[1];break;case 6:n=[0]}o=6;break;case 17:switch(r){case-1:n=[0];break;case 0:n=[1,3,5,7];break;case 1:n=[2,4,6];break;case 2:n=[3,5];break;case 3:n=[4];break;case 4:n=[3];break;case 5:n=[2];break;case 6:n=[1];break;case 7:n=[0]}o=7;break;case 31:switch(r){case-4:n=[1,3,5,7];break;case-3:n=[2,4,6];break;case-2:n=[3,5];break;case-1:n=[4];break;case 0:n=[3];break;case 2:n=[1];break;case 3:n=[0];break;default:i=!0}o=3;break;case 32:switch(r){case-4:n=[0];break;case-3:n=[1,3,5,7];break;case-2:n=[2,4,6];break;case-1:n=[3,5];break;case 0:n=[4];break;case 1:n=[3];break;case 3:n=[1];break;case 4:n=[0]}o=4;break;case 33:switch(r){case-3:n=[0];break;case-2:n=[1,3,5,7];break;case-1:n=[2,4,6];break;case 0:n=[3,5];break;case 1:n=[4];break;case 2:n=[3];break;case 4:n=[1];break;case 5:n=[0]}o=5;break;case 34:switch(r){case-2:n=[0];break;case-1:n=[1,3,5,7];break;case 0:n=[2,4,6];break;case 1:n=[3,5];break;case 2:n=[4];break;case 3:n=[3];break;case 5:n=[1];break;case 6:n=[0]}o=6;break;case 35:switch(r){case-1:n=[0];break;case 0:n=[1,3,5,7];break;case 1:n=[2,4,6];break;case 2:n=[3,5];break;case 3:n=[4];break;case 4:n=[3];break;case 6:n=[1];break;case 7:n=[0]}o=7;break;case 49:switch(r){case-4:n=[1,3,5,7];break;case-3:n=[2,4,6];break;case-2:n=[3,5];break;case-1:n=[4];break;case 0:n=[3];break;case 2:n=[1];break;case 3:n=[0];break;default:i=!0}o=3;break;case 50:case 82:switch(r){case-4:n=[0];break;case-3:n=[1,3,5,7];break;case-2:n=[2,4,6];break;case-1:n=[3,5];break;case 0:n=[2,4];break;case 1:n=[3];break;case 3:n=[1];break;case 4:n=[0]}o=4;break;case 51:case 83:switch(r){case-3:n=[0];break;case-2:n=[1,3,5,7];break;case-1:n=[2,4,6];break;case 0:n=[3,5];break;case 1:n=[2,4];break;case 2:n=[3];break;case 4:n=[1];break;case 5:n=[0]}o=5;break;case 52:case 84:switch(r){case-2:n=[0];break;case-1:n=[1,3,5,7];break;case 0:n=[2,4,6];break;case 1:n=[3,5];break;case 2:n=[2,4];break;case 3:n=[3];break;case 5:n=[1];break;case 6:n=[0]}o=6;break;case 53:case 85:switch(r){case-1:n=[0];break;case 0:n=[1,3,5,7];break;case 1:n=[2,4,6];break;case 2:n=[3,5];break;case 3:n=[2,4];break;case 4:n=[3];break;case 6:n=[1];break;case 7:n=[0]}o=7;break;case 81:switch(r){case-4:n=[1,3,5,7];break;case-3:n=[2,4,6];break;case-2:n=[3,5];break;case-1:n=[2,4];break;case 0:n=[1,3];break;case 3:n=[0];break;default:i=!0}o=3}if(i){var a=o-t;(a<0||a>8)&&(n=[])}return{valences:n,valenceElectronCount:o,unexpectedCharge:i}},getMaxPossibleMdlValence:function(e,t){var r=Kekule.ValenceUtils.getPossibleMdlValenceInfo(e,t).valences;return r.length?r[r.length-1]:0},getImplicitMdlValence:function(e,t,r){var n=t,o=r;switch(e){case 1:case 3:case 11:case 19:case 37:case 55:case 87:if(0==n&&o<=1)return 1;break;case 4:case 12:case 20:case 38:case 56:case 88:switch(n){case 0:if(o<=2)return 2;break;case 1:if(o<=1)return 1}break;case 5:switch(n){case-4:if(o<=1)return 1;break;case-3:if(o<=2)return 2;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 1:if(o<=2)return 2;break;case 2:if(o<=1)return 1}break;case 6:switch(n){case-3:if(o<=1)return 1;break;case-2:if(o<=2)return 2;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 2:if(o<=2)return 2;break;case 3:if(o<=1)return 1}break;case 7:switch(n){case-2:if(o<=1)return 1;break;case-1:if(o<=2)return 2;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 3:if(o<=2)return 2;break;case 4:if(o<=1)return 1}break;case 8:switch(n){case-1:if(o<=1)return 1;break;case 0:if(o<=2)return 2;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 4:if(o<=2)return 2;break;case 5:if(o<=1)return 1}break;case 9:switch(n){case 0:if(o<=1)return 1;break;case 1:if(o<=2)return 2;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 5:if(o<=2)return 2;break;case 6:if(o<=1)return 1}break;case 13:switch(n){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 1:if(o<=2)return 2;break;case 2:if(o<=1)return 1}break;case 14:switch(n){case-3:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-2:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 2:if(o<=2)return 2;break;case 3:if(o<=1)return 1}break;case 15:switch(n){case-2:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 3:if(o<=2)return 2;break;case 4:if(o<=1)return 1}break;case 16:switch(n){case-1:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 0:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 4:if(o<=2)return 2;break;case 5:if(o<=1)return 1}break;case 17:switch(n){case 0:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 5:if(o<=2)return 2;break;case 6:if(o<=1)return 1}break;case 31:switch(n){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 2:if(o<=1)return 1}break;case 32:switch(n){case-3:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-2:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 3:if(o<=1)return 1}break;case 33:switch(n){case-2:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 4:if(o<=1)return 1}break;case 34:switch(n){case-1:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 0:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 5:if(o<=1)return 1}break;case 35:switch(n){case 0:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 6:if(o<=1)return 1}break;case 49:switch(n){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=2)return 2;if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 2:if(o<=1)return 1}break;case 50:case 82:switch(n){case-3:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-2:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=2)return 2;if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 3:if(o<=1)return 1}break;case 51:case 83:switch(n){case-2:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=2)return 2;if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 4:if(o<=1)return 1}break;case 52:case 84:switch(n){case-1:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 0:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=2)return 2;if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 5:if(o<=1)return 1}break;case 53:case 85:switch(n){case 0:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=2)return 2;if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 6:if(o<=1)return 1}break;case 81:switch(n){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=2)return 2;if(o<=4)return 4;break;case 0:if(o<=1)return 1;if(o<=3)return 3}}return o},getImplicitHydValence:function(e,t,r){var n=e,o=t,i=r,a=0;return 6==n?a=4-Math.abs(o):7==n||15==n?a=3+o:8!=n&&16!=n||(a=2+o),a<0&&(a=0),i>a&&(a=i),a}},Kekule.ValenceUtils.getImplicitValence=Kekule.ValenceUtils.getImplicitMdlValence,Kekule.ValenceUtils.getMaxPossibleValence=Kekule.ValenceUtils.getMaxPossibleMdlValence,function(){"use strict";var e=Kekule.ArrayUtils;Kekule.StructureComparationLevel={SKELETAL:1,CONSTITUTION:2,CONFIGURATION:3,EXACT:4,DEFAULT:4},Kekule.globalOptions.add("structure",{defaultBondLength2D:.8,defaultBondLength3D:1.5}),Kekule.globalOptions.add("algorithm.structureComparation",{structureComparationLevel:Kekule.StructureComparationLevel.DEFAULT}),Kekule.globalOptions.add("algorithm.structureClean",{structureCleanOptions:{orphanChemNode:!0,hangingChemConnector:!0}}),Kekule.globalOptions.add("structure.implicitHydrogenEstimationStrategy",{targetElementCategories:{},targetElements:{},targetOrphanAtomElementCategories:{},targetOrphanAtomElements:{}}),Kekule.globalOptions.structure.implicitHydrogenEstimationStrategy.targetOrphanAtomElementCategories[Kekule.ElementCategory.METAL]=!1,Kekule.ObjComparer.compareStructure=function(e,t,r){var n=Object.create(r||{});return n.method=Kekule.ComparisonMethod.CHEM_STRUCTURE,Kekule.ObjComparer.compare(e,t,n)},Kekule.ObjComparer.equalStructure=function(e,t,r){return 0===Kekule.ObjComparer.compareStructure(e,t,r)},Kekule.ObjComparer.getStructureComparisonDetailOptions=function(e){var t=Object.extend({},e);if(e){var r,n=Kekule.StructureComparationLevel,o=e.structureLevel||e.level||Kekule.globalOptions.algorithm.structureComparation.structureComparationLevel,i=["atom","mass","linkedConnectorCount","charge","radical","stereo","hydrogenCount","connectedObjCount","bondType","bondOrder"];o===n.SKELETAL?r={atom:!1,mass:!1,linkedConnectorCount:!0,charge:!1,radical:!1,stereo:!1,hydrogenCount:!1,connectedObjCount:!0,bondType:!1,bondOrder:!1}:o===n.CONSTITUTION?r={atom:!0,mass:!1,linkedConnectorCount:!0,charge:!1,radical:!1,stereo:!1,hydrogenCount:!0,connectedObjCount:!0,bondType:!0,bondOrder:!0}:o===n.CONFIGURATION?r={atom:!0,mass:!1,linkedConnectorCount:!0,charge:!1,radical:!1,stereo:!0,hydrogenCount:!0,connectedObjCount:!0,bondType:!0,bondOrder:!0}:o===n.EXACT&&(r={atom:!0,mass:!0,linkedConnectorCount:!0,charge:!0,radical:!0,stereo:!0,hydrogenCount:!0,connectedObjCount:!0,bondType:!0,bondOrder:!0});for(var a=0,s=i.length;a<s;++a){var u=i[a],l="compare"+u.capitalizeFirst(),c=t[u];Kekule.ObjUtils.isUnset(c)&&(c=t[l]),Kekule.ObjUtils.isUnset(c)?(t[u]=r[u],t[l]=r[u]):(t[u]=c,t[l]=c)}}return t},Kekule.ChemStructureObject=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemStructureObject",initialize:function(e){this.setPropStoreFieldValue("autoClearStructureCache",!0),this.tryApplySuper("initialize",[e])},doFinalize:function(){this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("linkedConnectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null}),this.defineProp("linkedObjs",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t)for(var n=this.getLinkedConnectorAt(t).getConnectedObjs(),o=0,i=n.length;o<i;++o){var a=n[o];a===this||this.hasChildObj&&this.hasChildObj(a)||Kekule.ArrayUtils.pushUnique(e,n[o])}return e}}),this.defineProp("linkedSiblings",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=this.getParent(),r=0,n=this.getLinkedConnectorCount();r<n;++r)for(var o=this.getLinkedConnectorAt(r).getConnectedObjs(),i=0,a=o.length;i<a;++i){var s=o[i];s!==this&&e.indexOf(s)<0&&(s.getParent()!==t&&(s=t.getDirectChildOfNestedNode(s)),s&&e.push(s))}return e}}),this.defineProp("structureCache",{dataType:DataType.HASH,serializable:!1,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("structureCache");return!t&&e&&(t={},this.setPropStoreFieldValue("structureCache",t)),t}}),this.defineProp("autoClearStructureCache",{dataType:DataType.BOOL,serializable:!1})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setPropStoreFieldValue("linkedConnectors",[]),this.setSuppressChildChangeEventInUpdating(!0)},getAutoIdPrefix:function(){return"o"},getAcceptCoordStickFrom:function(e){return!1},doGetActualCompareOptions:function(e){if(e&&e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var t=Kekule.ObjComparer.getStructureComparisonDetailOptions(e);return e.customMethod&&(t.customMethod=e.customMethod),e.extraComparisonProperties&&(t.extraComparisonProperties=e.extraComparisonProperties),t}return this.tryApplySuper("doGetActualCompareOptions",[e])},_getComparisonOptionFlagValue:function(e,t){var r=e["compare"+t.capitalizeFirst()];return Kekule.ObjUtils.isUnset(r)&&(r=e[t]),r},doGetComparisonPropNames:function(e){return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE?[]:this.tryApplySuper("doGetComparisonPropNames",[e])},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"linkedConnectorCount")){var n=this.getLinkedNonHydrogenConnectors(),o=e.getLinkedNonHydrogenConnectors&&e.getLinkedNonHydrogenConnectors();r=this.doCompareOnValue(n.length,o&&o.length,t)}return r},compareStructure:function(e,t){var r=Object.create(t||{});return r.method=Kekule.ComparisonMethod.CHEM_STRUCTURE,this.compare(e,r)},equalStructure:function(e,t){return 0===this.compareStructure(e,t)},getParentFragment:function(){var e=this.getParent();return e instanceof Kekule.StructureFragment?e:null},getRootFragment:function(){var e=this.getParentFragment();return e&&e.getRootFragment()||e},getStructureCacheData:function(e){var t=this.getStructureCache();return t&&t[e]},setStructureCacheData:function(e,t){return this.getStructureCache(!0)[e]=t,this},clearStructureCache:function(){return this.setPropStoreFieldValue("structureCache",null),this},needAutoClearStructureCache:function(){var e=this.getParent();return this.getAutoClearStructureCache()&&(!e||!e.needAutoClearStructureCache||e.needAutoClearStructureCache())},notifyLinkedConnectorsChanged:function(){this.notifyPropSet("linkedConnectors",this.getPropStoreFieldValue("linkedConnectors"))},getCurrConnectableObj:function(){return this},getActualConnectedObjToConnector:function(e){return this},getLinkedConnectorCount:function(){return this.getLinkedConnectors().length},getLinkedConnectorAt:function(e){return this.getLinkedConnectors()[e]},indexOfLinkedConnector:function(e){return this.getLinkedConnectors().indexOf(e)},appendLinkedConnector:function(e){var t=this._doAppendLinkedConnector(e);return e&&e._doAppendConnectedObj(this),t},_doAppendLinkedConnector:function(e){if(!e)return-1;var t=this.getPropStoreFieldValue("linkedConnectors"),r=Kekule.ArrayUtils.pushUniqueEx(t,e);return r.isPushed&&this.notifyLinkedConnectorsChanged(),r.index},insertLinkedConnectorAt:function(e,t){t||(t=0);var r=this.indexOfLinkedConnector(e),n=this.getLinkedConnectors();r>=0?(n.splice(r,1),n.splice(t,0,e),this.notifyLinkedConnectorsChanged()):(n.splice(t,0,e),e&&e._doAppendConnectedObj(this),this.notifyLinkedConnectorsChanged())},insertLinkedConnectorBefore:function(e,t){var r=t?this.indexOfLinkedConnector(t):-1;return r<0?this.appendLinkedConnector(e):this.insertLinkedConnectorAt(e,r)},removeLinkedConnectorAt:function(e){var t=this.getLinkedConnectorAt(e);return t&&t._doRemoveConnectedObjAt(t.indexOfConnectedObj(this)),this._doRemoveLinkedConnectorAt(e)},_doRemoveLinkedConnectorAt:function(e){var t=Kekule.ArrayUtils.removeAt(this.getLinkedConnectors(),e);return t&&this.notifyLinkedConnectorsChanged(),t},removeLinkedConnector:function(e){var t=this.getLinkedConnectors().indexOf(e);t>=0&&this.removeLinkedConnectorAt(t)},getConnectorTo:function(e){for(var t=0,r=this.getLinkedConnectorCount();t<r;++t){var n=this.getLinkedConnectorAt(t);if(n.hasConnectedObj(e))return n}return null},removeThisFromLinkedConnector:function(){for(var e=this.getLinkedConnectorCount()-1;e>=0;--e){this.getLinkedConnectorAt(e).removeConnectedObj(this)}},getLinkedObjsOnConnector:function(e){for(var t=[],r=e.getConnectedObjs(),n=0,o=r.length;n<o;++n)r[n]!==this&&Kekule.ArrayUtils.pushUnique(t,r[n]);return t},filterConnector:function(e){for(var t=[],r=0,n=this.getLinkedConnectorCount();r<n;++r){var o=this.getLinkedConnectorAt(r);e(o)&&Kekule.ArrayUtils.pushUnique(t,o)}return t},getLinkedNonHydrogenConnectors:function(){var e=this;return this.filterConnector(function(t){var r=e.getLinkedObjsOnConnector(t);return r.length>1||!(r[0].isHydrogenAtom&&r[0].isHydrogenAtom())})},getLinkedHydrogenConnectors:function(){var e=this;return this.filterConnector(function(t){var r=e.getLinkedObjsOnConnector(t);return 1===r.length&&r[0].isHydrogenAtom&&r[0].isHydrogenAtom()})},getLinkedNonHydrogenObjs:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t)for(var n=this.getLinkedConnectorAt(t).getConnectedObjs(),o=0,i=n.length;o<i;++o)n[o]===this||n[o].isHydrogenAtom&&n[o].isHydrogenAtom()||Kekule.ArrayUtils.pushUnique(e,n[o]);return e},getLinkedHydrogenAtoms:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t){var n=this.getLinkedConnectorAt(t);if(n instanceof Kekule.Bond)for(var o=n.getConnectedObjs(),i=0,a=o.length;i<a;++i)o[i]!==this&&o[i].isHydrogenAtom&&o[i].isHydrogenAtom()&&Kekule.ArrayUtils.pushUnique(e,o[i])}return e},getLinkedHydrogenAtomsWithSingleBond:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t){var n=this.getLinkedConnectorAt(t);if(n instanceof Kekule.Bond&&n.isSingleBond()){var o=n.getConnectedObjs();if(2===o.length)for(var i=0,a=o.length;i<a;++i)o[i]!==this&&o[i].isHydrogenAtom&&o[i].isHydrogenAtom()&&Kekule.ArrayUtils.pushUnique(e,o[i])}}return e},getLinkedHydrogenAtomsWithSingleBondCount:function(e){var t=this.getLinkedHydrogenAtomsWithSingleBond().length||0;e&&(t+=this.getStructureCacheData("omittedBondHydrogenAtomCount")||0);return t},getPathesToDest:function(e){return this._doGetPathesToDest(e,[])},_doGetPathesToDest:function(t,r){if(t===this)return[];for(var n,o=[],i=e.clone(r),a=0,s=this.getLinkedConnectorCount();a<s;++a){var u=this.getLinkedConnectorAt(a);if(!(i.indexOf(u)>=0)){i.push(u);for(var l=u.getConnectedObjs(),c=0,d=l.length;c<d;++c){var h=l[c];if(h===t)n=[[]];else{if(h===this)continue;n=h&&h._doGetPathesToDest&&h._doGetPathesToDest(t,i)}if(n){for(var p={connector:u,object:h},C=0,f=n.length;C<f;++C)n[C].unshift(p);o=o.concat(n)}}}}return o.length||(o=null),o},getStructureRelatedPropNames:function(){return["linkedConnectors"]},structureChange:function(e){this.needAutoClearStructureCache()&&(this.clearStructureFlags(),this.clearStructureCache()),this.invokeEvent("structureChange",{origin:e||this})},clearStructureFlags:function(){},relayEvent:function(e,t){"structureChange"===e?this.structureChange(t.origin):this.tryApplySuper("relayEvent",[e,t])},doObjectChange:function(e){Kekule.ArrayUtils.intersect(e||[],this.getStructureRelatedPropNames()).length&&this.structureChange()}}),Kekule.SimpleStructureNode=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.SimpleStructureNode",initialize:function(e,t,r){this.tryApplySuper("initialize",[e]),t&&this.setCoord2D(t),r&&this.setCoord3D(r)},initProperties:function(){this.defineProp("zIndex2D",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED})},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["coord2D","coord3D"])},getAutoIdPrefix:function(){return"n"},getContainerBox:function(e,t){var r=this.getAbsCoordOfMode(e,t);return Kekule.BoxUtils.createBox(r,r)},getContainerBox2D:function(e){return this.getContainerBox(Kekule.CoordMode.COORD2D,e)},getContainerBox3D:function(e){return this.getContainerBox(Kekule.CoordMode.COORD3D,e)}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.SimpleStructureNode),Kekule.BaseStructureNode=Class.create(Kekule.SimpleStructureNode,{CLASS_NAME:"Kekule.BaseStructureNode",initProperties:function(){this.defineProp("coordStickTarget",{dataType:"Kekule.ChemStructureObject",objRef:!0,autoUpdate:!0,getter:function(){return this.getPropStoreFieldValue("coordStickTarget")},setter:function(e){if(e){if(!this.getAllowCoordStickTo(e))return void Kekule.chemError(Kekule.$L("ErrorMsg.COORD_STICK_NOT_ALLOWED_ON_CLASS"));var t=this.getOwner(),r=e.getOwner&&e.getOwner();if(r&&t!==r)return void Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_TO_STICK_TO_OTHER_OWNER_OBJ"));if(!e.getAcceptCoordStickFrom&&!e.getAcceptCoordStickFrom(this))return void Kekule.chemError(Kekule.$L("ErrorMsg.INVALID_STICK_TARGET_OBJ"));if(!e.getAbsCoordOfMode)return void Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_TO_STICK_TO_OBJ_WITHOUT_ABS_COORD"));if(e.getCoordStickTarget&&e.getCoordStickTarget()===this)return void Kekule.chemError(Kekule.$L("ErrorMsg.STICK_RECURSION_NOT_ALLOWED"))}var n=this.getCoordStickTarget();this.setPropStoreFieldValue("coordStickTarget",e),this._coordStickTargetChanged(n,e)}})},getAllowCoordStickTo:function(e){return!1},notifyCoordStickTargetChanged:function(e,t){},_getParentAbsCoord:function(e,t){var r=this.getCoordParent();return r&&r.getAbsCoordOfMode&&r.getAbsCoordOfMode(e,t)},_coordStickTargetChanged:function(e,t){e&&!t?this._copyAbsCoordFromStickedTarget(e,this.getCoordParent()):t&&this._copyAbsCoordFromStickedTarget(t,this.getCoordParent()),e&&e.detachCoordStickNodes&&e.detachCoordStickNodes(this),t&&t.attachCoordStickNodes&&t.attachCoordStickNodes(this),this.notifyCoordStickTargetChanged(e,t)},_copyAbsCoordFromStickedTarget:function(e,t,r){var n=Kekule.CoordUtils,o=Kekule.CoordMode;t||(t=this.getCoordParent());var i=r&&r!==o.COORD2D?null:e.getAbsCoord2D(),a=r&&r!==o.COORD2D?null:e.getAbsCoord3D();if(t){if(i){var s=t.getAbsCoord2D&&t.getAbsCoord2D();s&&(i=n.substract(i,s))}if(a){var u=t.getAbsCoord3D&&t.getAbsCoord3D();u&&(a=n.substract(a,u))}}i&&this.setPropStoreFieldValue("coord2D",i),a&&this.setPropStoreFieldValue("coord3D",a)},doGetCoord2D:function(e,t){var r=this.getCoordStickTarget();if(r&&r.getAbsCoord2D){var n=r.getAbsCoord2D(e,t),o=this._getParentAbsCoord(Kekule.CoordMode.COORD2D,e);return o&&(n=Kekule.CoordUtils.substract(n,o)),n}return this.tryApplySuper("doGetCoord2D",[e,t])},doGetCoord3D:function(e,t){var r=this.getCoordStickTarget();if(r&&r.getAbsCoord3D){var n=r.getAbsCoord3D(e,t),o=this._getParentAbsCoord(Kekule.CoordMode.COORD3D,e);return o&&(n=Kekule.CoordUtils.substract(n,o)),n}return this.tryApplySuper("doGetCoord3D",[e,t])},isOrphan:function(){var e=this.getParent();return!e||e.getChildCount()<=1}}),Kekule.StereoParity={NONE:null,ODD:1,EVEN:2,UNKNOWN:0},Kekule.ChemStructureNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.ChemStructureNode",initialize:function(e,t,r){this.tryApplySuper("initialize",[e]),t&&this.setCoord2D(t),r&&this.setCoord3D(r)},initProperties:function(){this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}}),this.defineProp("radical",{dataType:DataType.INT}),this.defineProp("parity",{dataType:DataType.INT}),this.defineProp("isAnchor",{dataType:DataType.BOOL,serializable:!1,getter:function(){var e=this.getParent();return!(!e||!e.indexOfAnchorNode)&&e.indexOfAnchorNode(this)>=0},setter:function(e){if(e!==this.getIsAnchor()){var t=this.getParent();t&&(e&&t.appendAnchorNode()?t.appendAnchorNode(this):!e&&t.removeAnchorNode&&t.removeAnchorNode(this))}}})},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["charge","radical"])},getLabel:function(){return null},getAcceptCoordStickFrom:function(e){return!(this.isSiblingWith(e)||e instanceof Kekule.ChemStructureNode)},doGetComparisonPropNames:function(e){var t=this.tryApplySuper("doGetComparisonPropNames",[e]);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(this._getComparisonOptionFlagValue(e,"charge")&&t.push("charge"),this._getComparisonOptionFlagValue(e,"radical")&&t.push("radical")),t},doCompareProperty:function(e,t,r){if(r.method!==Kekule.ComparisonMethod.CHEM_STRUCTURE||"charge"!==t&&"radical"!==t)return this.tryApplySuper("doCompareProperty",[e,t,r]);var n=e.getPropValue&&e.getPropValue(t)||0;return(this.getPropValue(t)||0)-n},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"stereo")){var n=this.getParity()||Kekule.StereoParity.UNKNOWN,o=e.getParity&&e.getParity()||Kekule.StereoParity.UNKNOWN;r=this.doCompareOnValue(n,o,t)}return r},getPrimaryIsotope:function(){return null},getLinkedChemNodes:function(e){for(var t=this.getLinkedObjs(),r=[],n=0,o=t.length;n<o;++n){var i=t[n];!(i instanceof Kekule.ChemStructureNode)||e&&i.isHydrogenAtom&&i.isHydrogenAtom()||r.push(i)}return r},getLinkedBonds:function(e){for(var t=[],r=0,n=this.getLinkedConnectorCount();r<n;++r){var o=this.getLinkedConnectorAt(r);o instanceof Kekule.Bond&&(!e||o.getBondType()===e)&&t.push(o)}return t},getLinkedMultiCenterBonds:function(){for(var e=[],t=0,r=this.getLinkedConnectorCount();t<r;++t){var n=this.getLinkedConnectorAt(t);n instanceof Kekule.Bond&&n.getConnectedObjCount()>2&&e.push(n)}return e},getLinkedMultipleBonds:function(){for(var e=Kekule.BondOrder,t=[],r=0,n=this.getLinkedConnectorCount();r<n;++r){var o=this.getLinkedConnectorAt(r);if(o instanceof Kekule.Bond&&o.getBondType()===Kekule.BondType.COVALENT){var i=o.getBondOrder();i!==e.DOUBLE&&i!==e.TRIPLE&&i!==e.QUAD&&i!==e.EXPLICIT_AROMATIC||t.push(o)}}return t},getLinkedDoubleBonds:function(){for(var e=Kekule.BondOrder,t=[],r=0,n=this.getLinkedConnectorCount();r<n;++r){var o=this.getLinkedConnectorAt(r);if(o instanceof Kekule.Bond&&o.getBondType()===Kekule.BondType.COVALENT)o.getBondOrder()===e.DOUBLE&&t.push(o)}return t},clearStructureFlags:function(){this.setPropStoreFieldValue("parity",Kekule.StereoParity.NONE)},isHydrogenAtom:function(){return!1},_getBondsValenceInfo:function(e){for(var t=0,r=0,n=this.getStructureCacheData("piElectronCount")||null,o=0,i=e.length;o<i;++o){var a,s=e[o];if(s instanceof Kekule.Bond)t+=a=s.getBondType()==Kekule.BondType.COVALENT&&s.getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC&&n>=2?1:s.getBondValence(),a>r&&(r=a)}return{valenceSum:t,maxValence:r}},_getCurrCovalentBondsInfo:function(){return this._getBondsValenceInfo(this.filterConnector(function(e){return e instanceof Kekule.Bond&&e.getBondType()==Kekule.BondType.COVALENT}))},_getCurrIonicBondsInfo:function(e){return this._getBondsValenceInfo(this.filterConnector(function(e){return e instanceof Kekule.Bond&&e.getBondType()==Kekule.BondType.IONIC}))}}),Kekule.RadicalType=Kekule.RadicalOrder,Kekule.AbstractAtom=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.AbstractAtom",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r])},initProperties:function(){this.defineProp("explicitHydrogenCount",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED,setter:function(e){var t=parseFloat(e),r=isNaN(t)||t<0?void 0:t;this.setPropStoreFieldValue("explicitHydrogenCount",r)}})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["explicitHydrogenCount"])},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"hydrogenCount")){var n=this.getHydrogenCount(!0),o=e.getHydrogenCount&&e.getHydrogenCount(!0);r=this.doCompareOnValue(n,o,t)}return r},getHydrogenCount:function(e){var t=this.getExplicitHydrogenCount()||0;return e&&(t+=this.getLinkedHydrogenAtomsWithSingleBondCount(!1)),t+=this.getStructureCacheData("omittedBondHydrogenAtomCount")||0},setHydrogenCount:function(e){return this.setExplicitHydrogenCount(e)},hasExplicitHydrogens:function(){return Kekule.ObjUtils.notUnset(this.getExplicitHydrogenCount())},isSaturated:function(){return!this.getLinkedMultipleBonds().length},mayContainElement:function(e){var t;return t="string"==typeof e?Kekule.ChemicalElementsDataUtil.getAtomicNumber(e):e,this.doMayContainElement(t)},doMayContainElement:function(e){return!1}}),Kekule.Atom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Atom",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,n,o]),(t||r)&&this.changeIsotope(t,r)},initProperties:function(){this.defineProp("isotope",{dataType:"Kekule.Isotope",serializable:!1}),this.defineProp("isotopeId",{dataType:DataType.STRING,serializable:!0,getter:function(){var e=this.getIsotope();return e?e.getIsotopeId():Kekule.Element.UNSET_ELEMENT},setter:function(e){var t=Kekule.IsotopeFactory.getIsotopeById(e);t&&this.setIsotope(t)}}),this.defineProp("symbol",{dataType:DataType.STRING,serializable:!1,getter:function(){var e=this.getIsotope();return e?e.getSymbol():Kekule.Element.UNSET_ELEMENT},setter:function(e){this.changeElement(e)}}),this.defineProp("atomicNumber",{dataType:DataType.INTEGER,serializable:!1,getter:function(){var e=this.getIsotope();return e?e.getAtomicNumber():0},setter:function(e){this.changeElement(e)}}),this.defineProp("massNumber",{dataType:DataType.INTEGER,getter:function(){var e=this.getIsotope();return e?e.getMassNumber():Kekule.Isotope.UNSET_MASSNUMBER},setter:function(e){this.changeMassNumber(e)}}),this.defineProp("isotopeAlias",{dataType:DataType.STRING,getter:function(){var e=this.getIsotope();return e?e.getIsotopeAlias():void 0},setter:function(e){this.changeElement(e)}}),this.defineProp("atomType",{dataType:DataType.OBJECT,serializable:!1,scope:Class.PropertyScope.PUBLIC}),this.defineProp("atomTypeId",{dataType:DataType.STRING,getter:function(){var e=this.getPropStoreFieldValue("atomType");return e?e.id:Kekule.AtomType.UNSET_ATOMTYPE},setter:function(e){if(this.isNormalAtom()){var t=Kekule.AtomTypeDataUtil.getAtomTypeFromId(this.getAtomicNumber(),e);this.setAtomType(t)}}}),this.defineProp("hybridizationType",{dataType:DataType.INT,enumSource:Kekule.HybridizationType}),this.defineProp("disableImplicitHydrogenEstimation",{dataType:DataType.BOOL})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["isotope","atomType"])},doGetComparisonPropNames:function(e){var t=this.tryApplySuper("doGetComparisonPropNames",[e]);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(this._getComparisonOptionFlagValue(e,"mass")&&t.unshift("massNumber"),this._getComparisonOptionFlagValue(e,"atom")&&t.unshift("atomicNumber")),t},getPrimaryIsotope:function(){return this.getIsotope()},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()},doMayContainElement:function(e){return this.getAtomicNumber()===e},changeIsotope:function(e,t){e===Kekule.Element.UNSET_ELEMENT?t=Kekule.Isotope.UNSET_MASSNUMBER:e||(e=this.getAtomicNumber()),t||(t=Kekule.Isotope.UNSET_MASSNUMBER),this.getAtomicNumber()!==e&&this.setAtomType(Kekule.AtomType.UNSET_ATOMTYPE);var r=Kekule.IsotopeFactory.getIsotope(e,t);this.setIsotope(r)},changeElement:function(e){return this.changeIsotope(e,Kekule.Isotope.UNSET_MASSNUMBER)},changeMassNumber:function(e){return this.changeIsotope(null,e)},isElement:function(e){return this.getSymbol()===e||this.getAtomicNumber()===e},getElementSeries:function(){var e=this.getIsotope();return e&&e.getSeries()},isNormalAtom:function(){var e=this.getIsotope();return!!e&&e.isNormalElement()},isHydrogenAtom:function(){return this.isElement(1)&&(!this.getMassNumber()||this.getMassNumber()<=1)},guessAtomType:function(){if(this.isNormalAtom()){var e=null,t=null,r=this._getCurrCovalentBondsInfo(),n=Kekule.AtomTypeDataUtil.getAllAtomTypes(this.getAtomicNumber());if(n){for(var o=0,i=n.length;o<i;++o){var a=n[o];if(t=a,a.bondOrderSum>=r.valenceSum&&(e=a,a.maxBondOrder>=r.maxValence))return a}return e||t}}return null},getProximalAtomType:function(){return this.getAtomType()||this.guessAtomType()},getImplicitValence:function(){if(this.isNormalAtom()){var e=this._getCurrCovalentBondsInfo().valenceSum,t=Math.round(this.getCharge()||0);return Kekule.ValenceUtils.getImplicitValence(this.getAtomicNumber(),t,e)}return 0},getExplicitValence:function(e){var t=e||{};if(this.isNormalAtom()){var r=this._getCurrCovalentBondsInfo().valenceSum;if(t.ignoreBondHydrogens)r-=(this.getLinkedHydrogenAtomsWithSingleBond()||[]).length;else r+=this.getStructureCacheData("omittedBondHydrogenAtomCount")||0;if(t.ignoreExplicitHydrogens);else r+=this.getExplicitHydrogenCount()||0;return r}return 0},getValence:function(e){var t=e||{};if(this.isNormalAtom()){var r,n=this.getExplicitValence(t);if(this.hasExplicitHydrogens())r=n;else{var o=t.ignoreCharge?0:Math.round(this.getCharge()||0);r=Kekule.ValenceUtils.getImplicitValence(this.getAtomicNumber(),o,n)}return r}return 0},getImplicitHydrogenCount:function(e){if(this.isNormalAtom()&&this._needToEsitmateImplicityHydrogens()){var t=this._getCurrCovalentBondsInfo(),r=this._getCurrIonicBondsInfo(),n=Math.round(this.getCharge()||0),o=Kekule.RadicalOrder.getRadicalElectronCount(this.getRadical()),i=this.getStructureCacheData("omittedBondHydrogenAtomCount")||0;return Kekule.ChemStructureUtils.getImplicitHydrogenCount(this.getAtomicNumber()||0,{coValenceBondValenceSum:(t.valenceSum||0)+i,otherBondValenceSum:r.valenceSum||0,charge:n,radicalECount:o})}return 0},_needToEsitmateImplicityHydrogens:function(){var e=!this.getDisableImplicitHydrogenEstimation();if(e){var t=this.isOrphan(),r=this.getSymbol(),n=Kekule.globalOptions.get("structure.implicitHydrogenEstimationStrategy")||{};if((n.targetElements&&!1===n.targetElements[r]||t&&n.targetOrphanAtomElements&&!1===n.targetOrphanAtomElements[r])&&(e=!1),e)for(var o=n.targetElementCategories,i=n.targetOrphanAtomElementCategories,a=this.getIsotope().getCategories(),s=0,u=a.length;s<u;++s){var l=a[s];if(o&&!1===o[l]||t&&i&&!1===i[l]){e=!1;break}}}return e},getHydrogenCount:function(e){var t=this.tryApplySuper("getHydrogenCount",[e]);return Kekule.ObjUtils.isUnset(this.getExplicitHydrogenCount())&&(t+=this.getImplicitHydrogenCount()||0),t},getAtomicMass:function(){var e=null,t=this.getIsotope();return t&&(e=t.getExactMass()||t.getNaturalMass()),e}}),Kekule.PseudoatomType={DUMMY:"dummy",ANY:"any",HETERO:"hetero",CUSTOM:"custom"},Kekule.Pseudoatom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Pseudoatom",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,n,o]),t&&this.setAtomType(t),r&&t==Kekule.PseudoatomType.CUSTOM&&this.setSymbol(r)},initProperties:function(){this.defineProp("atomType",{dataType:DataType.STRING,enumSource:Kekule.PseudoatomType}),this.defineProp("symbol",{dataType:DataType.STRING,getter:function(){var e=this.getAtomType(),t=Kekule.PseudoatomType,r=Kekule.ChemStructureNodeLabels;return e===t.DUMMY?r.DUMMY_ATOM:e===t.ANY?r.ANY_ATOM:e===t.HETERO?r.HETERO_ATOM:this.getPropStoreFieldValue("symbol")||r.CUSTOM_ATOM},setter:function(e){var t=Kekule.PseudoatomType,r=Kekule.ChemStructureNodeLabels;if(e){var n=e===r.DUMMY_ATOM?t.DUMMY:e===r.ANY_ATOM?t.ANY:e===r.HETERO_ATOM?t.HETERO:t.CUSTOM;this.setAtomType(n)}this.setPropStoreFieldValue("symbol",e)}})},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["atomType","symbol"])},getPrimaryIsotope:function(){return null},getLabel:function(){return this.getSymbol()},doGetComparisonPropNames:function(e){var t=this.tryApplySuper("doGetComparisonPropNames",[e]);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(e,"atom")&&t.push("atomType"),t},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"atom")&&this.getAtomType()===Kekule.PseudoatomType.CUSTOM){var n=this.getSymbol(),o=e.getSymbol&&e.getSymbol();r=this.doCompareOnValue(n,o,t)}return r},doMayContainElement:function(e){var t=Kekule.PseudoatomType,r=this.getAtomType();return r===t.ANY||r===t.HETERO&&(!([1,6].indexOf(e)>=0)&&"Nonmetals"===Kekule.ChemicalElementsDataUtil.getElementInfo(e).chemicalSerie)}}),Kekule.VariableAtom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.VariableAtom",initProperties:function(){this.defineProp("allowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(e){var t=this.getPropStoreFieldValue("allowedIsotopeIds");return!t&&e&&(t=[],this.setPropStoreFieldValue("allowedIsotopeIds",t)),t}}),this.defineProp("disallowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(e){var t=this.getPropStoreFieldValue("disallowedIsotopeIds");return!t&&e&&(t=[],this.setPropStoreFieldValue("disallowedIsotopeIds",t)),t}}),this.defineProp("allowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getAllowedIsotopeIds())}}),this.defineProp("disallowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getDisallowedIsotopeIds())}})},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["allowedIsotopeIds","disallowedIsotopeIds"])},getPrimaryIsotope:function(){if(this.isDisallowedList())return null;var e=this.getAllowedIsotopeIds(),t=e?e[0]:null;return t?Kekule.IsotopeFactory.getIsotopeById(t):null},getLabel:function(){return Kekule.ChemStructureNodeLabels.VARIABLE_ATOM},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"atom")){var n=Kekule.ArrayUtils,o=this.getAllowedIsotopeIds(),i=e.getAllowedIsotopeIds&&e.getAllowedIsotopeIds();if(o)o=n.clone(o).sort(),i&&i.length&&(i=n.clone(i).sort()),r=this.doCompareOnValue(o,i,t);else if(i)r=1;else{var a=this.getDisallowedIsotopeIds(),s=e.getDisallowedIsotopeIds&&e.getDisallowedIsotopeIds();a&&a.length&&(a=n.clone(a).sort()),s&&s.length&&(s=n.clone(s).sort()),r=this.doCompareOnValue(a,s,t)}}return r},doMayContainElement:function(e){var t=function(e,t){if(!t)return!1;for(var r=0,n=t.length;r<n;++r){var o=t[r],i=Kekule.IsotopesDataUtil.getIsotopeIdDetail(o).symbol;if(Kekule.ChemicalElementsDataUtil.getAtomicNumber(i)===e)return!0}return!1},r=this.getAllowedIsotopeIds();return r?t(e,r):(r=this.getDisallowedIsotopeIds())?!t(e,r):void 0},isDisallowedList:function(){return this.getDisallowedIsotopeIds()&&!this.getAllowedIsotopeIds()},isListEmpty:function(){var e=this.getAllowedIsotopeIds(),t=!e||!e.length;return t&&(t=!(e=this.getDisallowedIsotopeIds())||!e.length),t},fetchAllowedIsotopeIds:function(){return this.doGetAllowedIsotopeIds(!0)},fetchDisallowedIsotopeIds:function(){return this.doGetDisallowedIsotopeIds(!0)},_getIsotopesFromIds:function(e){if(!e)return null;for(var t=[],r=0,n=e.length;r<n;++r){var o=e[r],i=Kekule.IsotopeFactory.getIsotopeById(o);i&&t.push(i)}return t}}),Kekule.MolecularFormula=Class.create(ObjectEx,{CLASS_NAME:"Kekule.MolecularFormula",initialize:function(e){this.tryApplySuper("initialize"),this.setPropStoreFieldValue("sections",[]),e&&this.setPropStoreFieldValue("parent",e),this.setBubbleEvent(!0)},initProperties:function(){this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:!1,setter:null,scope:Class.PropertyScope.PUBLIC}),this.defineProp("sections",{dataType:DataType.ARRAY,setter:null}),this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}}),this.defineProp("radical",{dataType:DataType.INT,getter:function(){return this.getPropStoreFieldValue("radical")||0}})},getHigherLevelObj:function(){return this.getParent()},isEmpty:function(){return this.getSectionCount()<=0},notifySectionsChanged:function(){this.notifyPropSet("sections",this.getPropStoreFieldValue("sections"))},createSectionItem:function(e,t,r){var n={obj:e,count:t||1};return r&&e.setCharge(r),e.setParent&&e.setParent(this.getParent()),n},getTotalCharge:function(){for(var e=0,t=this.getSections(),r=0,n=t.length;r<n;++r)t[r].obj.getCharge&&(e+=t[r].obj.getCharge()*(t.count||1));return this.getCharge()&&(e+=this.getCharge()),e},indexOfObj:function(e){for(var t=this.getSections(),r=0,n=t.length;r<n;++r)if(t[r].obj==e)return r;return-1},getSectionCount:function(){return this.getSections().length},getSectionAt:function(e){return this.getSections()[e]},getSectionCharge:function(e){var t,r=0;return(t="object"!=typeof e?this.getSectionAt(e):e).obj.getCharge&&(r+=t.obj.getCharge()||0),r},appendSection:function(e,t,r){var n=this.createSectionItem(e,t,r);return this.getSections().push(n),this.notifySectionsChanged(),n},insertSection:function(e,t,r,n){var o=this.createSectionItem(t,r,n);return this.getSections().splice(e,0,o),this.notifySectionsChanged(),o},removeSectionAt:function(e){var t=this.getSections().splice(e,1);return t&&this.notifySectionsChanged(),t},clear:function(){this.beginUpdate();try{this.setCharge(null),this.setRadical(null),this.setPropStoreFieldValue("sections",[]),this.notifySectionsChanged()}finally{this.endUpdate()}},removeObj:function(e){var t=this.indexOfObj(e);if(!(t>=0))return null;this.removeSectionAt(t);this.notifySectionsChanged()},getMaxNestedLevel:function(){for(var e=0,t=0,r=this.getSectionCount();t<r;++t){var n=this.getSectionAt(t);if(n.obj instanceof Kekule.MolecularFormula){var o=n.obj.getMaxNestedLevel()+1;o>e&&(e=o)}}return e},getSimpleIsotopeMaps:function(){}}),Kekule.StructureConnectionTable=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureConnectionTable",TRAVERS_VISITED_KEY:"__$ctabTraversVisited__",initialize:function(e,t){this.tryApplySuper("initialize"),e&&this.setOwner(e),t&&this.setPropStoreFieldValue("parent",t)},initProperties:function(){this.defineProp("owner",{dataType:"Kekule.ChemSpace",serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:function(e){e!=this.getPropStoreFieldValue("owner")&&(this.setPropStoreFieldValue("owner",e),this.ownerChanged(e))}}),this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:function(e){e!=this.getPropStoreFieldValue("parent")&&(this.setPropStoreFieldValue("parent",e),this.parentChanged(e))}}),this.defineProp("nodes",{dataType:DataType.ARRAY}),this.defineProp("anchorNodes",{dataType:DataType.ARRAY,setter:null}),this.defineProp("connectors",{dataType:DataType.ARRAY}),this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){for(var e=[],t=0,r=this.getNodeCount();t<r;++t){var n=this.getNodeAt(t);n instanceof Kekule.ChemStructureNode&&(n.isHydrogenAtom&&n.isHydrogenAtom()||e.push(n))}return e}}),this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){for(var e=[],t=0,r=this.getConnectorCount();t<r;++t){var n=this.getConnectorAt(t);n.isNormalConnectorToHydrogen&&n.isNormalConnectorToHydrogen()||e.push(n)}return e}}),this.defineProp("structureCache",{dataType:DataType.HASH,serializable:!1,setter:null,getter:function(e){var t=this.getParent();return t&&t.getStructureCache(e)}})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setPropStoreFieldValue("nodes",[]),this.setPropStoreFieldValue("anchorNodes",[]),this.setPropStoreFieldValue("connectors",[])},getHigherLevelObj:function(){return this.getParent()||this.getOwner()},doSaveProp:function(e,t,r,n,o,i,a,s){var u=t.name;switch(u){case"anchorNodes":for(var l=[],c=0,d=e.getAnchorNodeCount();c<d;++c){var h=e.getAnchorNodeAt(c),p=e.indexOfNode(h);l.push(p)}var C=o.createChildStorageNode(r,o.propNameToStorageName(u),!0);return o.saveObj(l,C,n,i,a,s),!0;case"connectors":for(C=o.createChildStorageNode(r,o.propNameToStorageName(u),!0),c=0,d=e.getConnectorCount();c<d;++c){var f=e.getConnectorAt(c),g=o.getNameForArrayItemStorageNode(f),k=o.appendArrayItemStorageNode(C,o.propNameToStorageName(g),o.isArray(f));o.setStorageNodeExplicitType(k,o.getValueExplicitType(f)),o.saveObj(f,k,n,i,a,s);for(var m=[],A=0,S=f.getConnectedObjCount();A<S;++A){var y=f.getConnectedObjAt(A);if((p=e.indexOfChild(y))>=0)m.push(p);else{var b=e.indexStackOfChild(y);null!=b&&m.push(b)}}if(m.length){var O=o.createChildStorageNode(k,o.propNameToStorageName("connectedObjs"),!0);o.saveObj(m,O,n,i,a,s)}}return!0;default:return!1}},doLoadProp:function(e,t,r,n,o,i,a){var s=t.name;switch(s){case"anchorNodes":var u=[],l=n.getChildStorageNode(r,n.propNameToStorageName(s));return n.loadObj(u,l,o,i,a),e.__load_anchorNodes_indexes=u,!0;case"connectors":l=n.getChildStorageNode(r,n.propNameToStorageName(s));for(var c,d=n.getAllArrayItemStorageNodes(l),h=0,p=d.length;h<p;++h){var C=d[h],f=n.getStorageNodeExplicitType(C)||n.getStorageNodeName(C);if(f){c=DataType.createInstance(f),n.loadObj(c,C,o,i,a);var g=n.getChildStorageNode(C,n.propNameToStorageName("connectedObjs"));if(g){var k=[];n.loadObj(k,g,o,i,a),c.__load_connectedObj_indexes=k}var m=n.getChildStorageNode(C,n.propNameToStorageName("connectedNodes"));if(m){var A=[];n.loadObj(A,m,o,i,a),c.__load_connectedNode_indexes=A}var S=n.getChildStorageNode(C,n.propNameToStorageName("connectedConnectors"));if(S){var y=[];n.loadObj(y,S,o,i,a),c.__load_connectedConnector_indexes=y}e.appendConnector(c)}}return!0;default:return!1}},loaded:function(e){if(this.__load_anchorNodes_indexes){for(var t=0,r=this.__load_anchorNodes_indexes.length;t<r;++t){var n=this.__load_anchorNodes_indexes[t];this.appendAnchorNode(this.getNodeAt(n))}delete this.__load_anchorNodes_indexes}for(t=0,r=this.getConnectorCount();t<r;++t){var o=this.getConnectorAt(t);if(o.__load_connectedObj_indexes){for(var i=0,a=o.__load_connectedObj_indexes.length;i<a;++i){var s;(s="object"==typeof(n=o.__load_connectedObj_indexes[i])?this.getChildAtIndexStack(n):this.getChildAt(n))&&o.appendConnectedObj(s)}delete o.__load_connectedObj_indexes}if(o.__load_connectedNode_indexes){for(i=0,a=o.__load_connectedNode_indexes.length;i<a;++i){"object"==typeof(n=o.__load_connectedNode_indexes[i])?o.appendConnectedObj(this.getNodeAtIndexStack(n)):o.appendConnectedObj(this.getNodeAt(n))}delete o.__load_connectedNode_indexes}if(o.__load_connectedConnector_indexes){for(i=0,a=o.__load_connectedConnector_indexes.length;i<a;++i){n=o.__load_connectedConnector_indexes[i];o.appendConnectedObj(this.getConnectorAt(n))}delete o.__load_connectedConnector_indexes}}this.ownerChanged(this.getOwner()),this.parentChanged(this.getParent()),this.tryApplySuper("loaded",[e])},notifyNodesChanged:function(){this.notifyPropSet("nodes",this.getPropStoreFieldValue("nodes"))},notifyAnchorNodesChanged:function(){this.notifyPropSet("anchorNodes",this.getPropStoreFieldValue("anchorNodes"))},notifyConnectorsChanged:function(){this.notifyPropSet("connectors",this.getPropStoreFieldValue("connectors"))},ownerChanged:function(e){for(var t=0,r=this.getNodeCount();t<r;++t)this.getNodeAt(t).setOwner(e);for(t=0,r=this.getConnectorCount();t<r;++t)this.getConnectorAt(t).setOwner(e)},parentChanged:function(e,t){for(var r=0,n=this.getNodeCount();r<n;++r)this.getNodeAt(r).setParent(e);for(r=0,n=this.getConnectorCount();r<n;++r)this.getConnectorAt(r).setParent(e)},isEmpty:function(){return this.getNodeCount()<=0&&this.getConnectorCount()<=0},getStructureCacheData:function(e){var t=this.getStructureCache();return t&&t[e]},setStructureCacheData:function(e,t){var r=this.getParent();return r&&r.setStructureCacheData&&r.setStructureCacheData(e,t),this},clearStructureCache:function(){var e=this.getParent();return e&&e.clearStructureCache(),this},getNodeById:function(e){for(var t=this.getNodes(),r=0,n=t.length;r<n;++r)if(t[r].getId()==e)return t[r];return null},getConnectorById:function(e){for(var t=this.getConnectors(),r=0,n=t.length;r<n;++r)if(t[r].getId()==e)return t[r];return null},getObjectById:function(e){var t=this.getNodeById(e);return t||this.getConnectorById(e)},getNodeCount:function(){return this.getNodes().length},getNodeAt:function(e){return this.getNodes()[e]},indexOfNode:function(e){return this.getNodes().indexOf(e)},hasNode:function(e,t){var r=this.indexOfNode(e)>=0;if(!r&&t)for(var n=0,o=this.getNodeCount();n<o;++n){var i=this.getNodeAt(n);if(i.hasNode&&(r=i.hasNode(e,!0)),r)break}return r},indexStackOfNode:function(e){var t=this.indexOfNode(e);if(t>=0)return t;for(var r=null,n=0,o=this.getNodeCount();n<o;++n){var i=this.getNodeAt(n);if(i.indexStackOfNode&&(r=i.indexStackOfNode(e),!Kekule.ObjUtils.isUnset(r)))return"object"!=typeof r&&(r=[r]),r.unshift(n),r}return r},getNodeAtIndexStack:function(e){if((e=Kekule.ArrayUtils.toArray(e)).length<=0)return null;for(var t=this.getNodeAt(e[0]),r=1,n=e.length;r<n;++r){if(!t||!t.getNodeAt)return null;t=t.getNodeAt(e[r])}return t},insertNodeBefore:function(e,t){var r=this.indexOfNode(t);r?this.insertNodeAt(e,r):this.appendNode(e)},appendNode:function(e){var t=Kekule.ArrayUtils.pushUniqueEx(this.getNodes(),e);return t.isPushed&&(e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent()),this.notifyNodesChanged()),t.index},insertNodeAt:function(e,t){var r=this.indexOfNode(e),n=this.getNodes();return(Kekule.ObjUtils.isUnset(t)||t<0)&&(t=n.length),r>=0?(n.splice(r,1),n.splice(t,0,e)):(n.splice(t,0,e),e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent())),this.notifyNodesChanged(),t},setNodeIndex:function(e,t){var r=this.getNodes(),n=this.indexOfNode(e);n>=0&&(r.splice(n,1),r.splice(t,0,e))},removeNodeAt:function(e,t){var r=this.getNodes()[e];r&&(t||r.removeThisFromLinkedConnector(),this.getNodes().splice(e,1),r.setOwner&&r.setOwner(null),r.setParent&&r.setParent(null),this.notifyNodesChanged())},removeNode:function(e,t){var r=this.getNodes().indexOf(e);r>=0&&this.removeNodeAt(r,t)},replaceNode:function(e,t){if(!this.hasNode(e))return this;this.insertBefore(t,e);var r=this.getAnchorNodes(),n=r.indexOf(e);n>=0&&r.splice(n,1,[t]);for(var o=Kekule.ArrayUtils.clone(e.getLinkedConnectors()),i=0,a=o.length;i<a;++i){(u=o[i]).replaceConnectedObj(e,t)}if(e.getNodes&&e.getCrossConnectors){var s=Kekule.ArrayUtils.clone(e.getCrossConnectors());for(i=0,a=s.length;i<a;++i){var u=s[i];if(this.indexOfConnector(u)>=0)for(var l=0,c=u.getConnectedObjCount();l<c;++l){var d=u.getConnectedObjAt(l);e.indexOfChild(d)>=0&&u.replaceConnectedObj(d,t)}u.replaceConnectedObj(e,t)}}this.removeNode(e)},clearNodes:function(){this.clearAnchorNodes(),this.setPropStoreFieldValue("nodes",[]),this.notifyAnchorNodesChanged(),this.notifyNodesChanged()},sortNodes:function(e){e?(this.getNodes().sort(e),this.notifyNodesChanged()):Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))},nodesHasCoord2D:function(e,t){return this.nodesHasCoordOfMode(Kekule.CoordMode.COORD2D,e,t)},nodesHasCoord3D:function(e,t){return this.nodesHasCoordOfMode(Kekule.CoordMode.COORD3D,e,t)},nodesHasCoordOfMode:function(e,t,r){for(var n=Kekule.CoordUtils.isZero,o=0,i=this.getNodes(),a=0,s=i.length;a<s;++a)if(i[a].hasCoordOfMode(e,t)){if(!r)return!0;if(!n(i[a].getCoordOfMode(e,t)))return!0;++o}return!!(r&&o===i.length&&o<=1)},_createAtom:function(e,t,r,n){return new Kekule.Atom(null,e,t,r,n)},appendAtom:function(e,t,r,n){var o=this._createAtom(e,t,r,n);return o&&this.appendNode(o),o},getAnchorNodeCount:function(){return this.getAnchorNodes().length},indexOfAnchorNode:function(e){return this.getAnchorNodes().indexOf(e)},getAnchorNodeAt:function(e){return this.getAnchorNodes()[e]},appendAnchorNode:function(e){if(!e)return-1;if(this.getNodes().indexOf(e)>=0){var t=Kekule.ArrayUtils.pushUniqueEx(this.getAnchorNodes(),e);return t.isPushed&&this.notifyAnchorNodesChanged(),t.index}return-1},removeAnchorNodeAt:function(e){this.getAnchorNodes()[e]&&(this.getAnchorNodes().splice(e,1),this.notifyAnchorNodesChanged())},removeAnchorNode:function(e){var t=this.getAnchorNodes().indexOf(e);t>=0&&this.removeAnchorNodeAt(t)},clearAnchorNodes:function(){this.setPropStoreFieldValue("anchorNodes",[]),this.notifyAnchorNodesChanged()},getConnectorCount:function(){return this.getConnectors().length},indexOfConnector:function(e){return this.getConnectors().indexOf(e)},getConnectorAt:function(e){return this.getConnectors()[e]},indexStackOfConnector:function(e){var t=this.indexOfConnector(e);if(t>=0)return t;for(var r=null,n=0,o=this.getNodeCount();n<o;++n){var i=this.getNodeAt(n);if(i.indexStackOfConnector&&(r=i.indexStackOfConnector(e),!Kekule.ObjUtils.isUnset(r)))return"object"!=typeof r&&(r=[r]),r.unshift(n),r}return r},getConnectorAtIndexStack:function(e){if((e=Kekule.ArrayUtils.toArray(e)).length<=0)return null;if(1===e.length)return this.getConnectorAt(e[0]);for(var t=e.length-1,r=this.getNodeAt(e[0]),n=1;n<t;++n){if(!r||!r.getNodeAt)return null;r=r.getNodeAt(e[n])}return r?r.getConnectorAt(e[t]):null},insertConnectorBefore:function(e,t){var r=this.indexOfConnector(t);r?this.insertConnectorAt(e,r):this.appendConnector(e)},appendConnector:function(e){var t=Kekule.ArrayUtils.pushUniqueEx(this.getConnectors(),e);return t.isPushed&&(e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent()),this.notifyConnectorsChanged()),t.index},insertConnectorAt:function(e,t){var r=this.indexOfConnector(e),n=this.getConnectors();(Kekule.ObjUtils.isUnset(t)||t<0)&&(t=n.length),r>=0?(n.splice(r,1),n.splice(t,0,e)):(n.splice(t,0,e),e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent())),this.notifyConnectorsChanged()},setConnectorIndex:function(e,t){var r=this.getConnectors(),n=this.indexOfConnector(e);n>=0&&(r.splice(n,1),r.splice(t,0,e))},removeConnectorAt:function(e,t){var r=this.getConnectors()[e];r&&(t||r.removeThisFromConnectedObjs(),this.getConnectors().splice(e,1),r.setOwner&&r.setOwner(null),r.setParent&&r.setParent(null),this.notifyConnectorsChanged())},removeConnector:function(e,t){var r=this.getConnectors().indexOf(e);r>=0&&this.removeConnectorAt(r,t)},clearConnectors:function(){this.setPropStoreFieldValue("connectors",[]),this.notifyConnectorsChanged()},hasConnector:function(e,t){var r=this.indexOfConnector(e)>=0;if(!r&&t)for(var n=0,o=this.getNodeCount();n<o;++n){var i=this.getNodeAt(n);if(i.hasConnector&&(r=i.hasConnector(e,!0)),r)break}return r},sortConnectors:function(e){e?(this.getConnectors().sort(e),this.notifyConnectorsChanged()):Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))},_createBond:function(e,t,r){for(var n=[],o=0,i=e.length;o<i;++o){var a=e[o];DataType.isSimpleValue(a)&&(a=this.getNodeAt(a)),n.push(a)}return new Kekule.Bond(null,n,t,null,r)},appendBond:function(e,t,r){var n=this._createBond(e,t,r);return n&&this.appendConnector(n),n},_getObjsNeedToBeCascadeRemoved:function(e,t){for(var r=[],n=e.getLinkedConnectors?e.getLinkedConnectors():[],o=0,i=n.length;o<i;++o){var a=n[o];(!t||t.indexOf(a)<0)&&a.getConnectedObjs().length<=2&&Kekule.ArrayUtils.pushUnique(r,a)}if(e instanceof Kekule.ChemStructureNode);else if(e instanceof Kekule.ChemStructureConnector){var s=e.getConnectedObjs();for(o=0,i=s.length;o<i;++o){var u=s[o];(!t||t.indexOf(u)<0)&&u instanceof Kekule.ChemStructureNode&&u.getLinkedConnectors().length<=1&&Kekule.ArrayUtils.pushUnique(r,u)}}var l=[].concat(r);l.push(e);var c=[];for(o=0,i=r.length;o<i;++o){if((u=r[o])!==e)var d=this._getObjsNeedToBeCascadeRemoved(u,l);Kekule.ArrayUtils.pushUnique(c,d)}return Kekule.ArrayUtils.pushUnique(r,c),r},removeChildObj:function(e,t,r){var n;t?(n=this._getObjsNeedToBeCascadeRemoved(e),Kekule.ArrayUtils.pushUnique(n,e)):n=[e];for(var o=0,i=n.length;o<i;++o){(a=n[o])instanceof Kekule.BaseStructureConnector?this.removeConnector(a):a instanceof Kekule.BaseStructureNode&&this.removeNode(a)}if(r)for(o=n.length-1;o>=0;--o){var a;(a=n[o]).finalize&&a.finalize()}},removeChild:function(e){return this.removeChildObj(e)||this.tryApplySuper("removeChild",[e])},deleteChildObj:function(e,t){return this.removeChildObj(e,t,!0)},hasChildObj:function(e){return this.hasNode(e)||this.hasConnector(e)},getNextSiblingOfChild:function(e){if(e instanceof Kekule.SimpleStructureNode){if((t=this.indexOfNode(e))>=0)return this.getNodeAt(t+1)}else if(e instanceof Kekule.BaseStructureConnector){var t;if((t=this.indexOfConnector(e))>=0)return this.getConnectorAt(t+1)}return null},insertBefore:function(e,t){if(e instanceof Kekule.SimpleStructureNode){var r=this.indexOfNode(t);return this.insertNodeAt(e,r)}if(e instanceof Kekule.BaseStructureConnector){r=this.indexOfConnector(t);return this.insertConnectorAt(e,r)}return-1},clear:function(){this.clearNodes(),this.clearConnectors()},getChildCount:function(){return this.getNodeCount()+this.getConnectorCount()},getChildAt:function(e){var t=this.getNodeCount();return e<t?this.getNodeAt(e):e<t+this.getConnectorCount()?this.getConnectorAt(e-t):null},indexOfChild:function(e){var t;if(e instanceof Kekule.BaseStructureNode)t=this.indexOfNode(e);else if(e instanceof Kekule.BaseStructureConnector){if((t=this.indexOfConnector(e))>=0)t+=this.getNodeCount()}else t=-1;return t},indexStackOfChild:function(e){var t;if(e instanceof Kekule.BaseStructureNode)t=this.indexStackOfNode(e);else if(e instanceof Kekule.BaseStructureConnector){var r=this.getNodeCount();(t=this.indexStackOfConnector(e)).length?t[t.length-1]+=r:t+=r}else t=-1;return t},getChildAtIndexStack:function(e){if((e=Kekule.ArrayUtils.toArray(e)).length<=0)return null;for(var t=this.getChildAt(e[0]),r=1,n=e.length;r<n;++r){if(!t||!t.getChildAt)return null;t=t.getChildAt(e[r])}return t},isSubFragment:function(e){return e.getNodeCount&&e.getNodeCount()>0},getSubFragments:function(){for(var e=[],t=0,r=this.getNodeCount();t<r;++t){var n=this.getNodeAt(t);this.isSubFragment(n)&&e.push(n)}return e},hasSubFragments:function(){var e=this.getSubFragments();return e&&e.length},getLeafNodes:function(){for(var e=[],t=0,r=this.getNodeCount();t<r;++t){var n=this.getNodeAt(t);if(this.isSubFragment(n)){if(n.getLeafNodes){var o=n.getLeafNodes();e=e.concat(o)}}else e.push(n)}return e},findDirectChildOfObj:function(e){for(var t=e;t&&this.indexOfChild(t)<0;)t=t.getParent?t.getParent():null;return t},getAllChildConnectors:function(){for(var e=[].concat(this.getConnectors()),t=this.getSubFragments(),r=0,n=t.length;r<n;++r)t[r].getAllChildConnectors&&(e=e.concat(t[r].getAllChildConnectors()));return e},getAllContainingConnectors:function(){return this.getAllChildConnectors()},getIsotopeMaps:function(){var e=this.getNodes();if(e.length<=0)return[];for(var t=function(e,t,r,n){for(var o=!1,a=0,s=e.length;a<s;++a)t.isSame(e[a].isotope)&&(o=!0,e[a].count+=r,e[a].charge+=n||0);if(!o){var u={isotope:t,count:r,charge:i.getCharge()||0};e.push(u)}return e},r=[],n=0,o=e.length;n<o;++n){var i=e[n];if(i instanceof Kekule.StructureFragment){var a=i.getIsotopeMaps();for(n=0,o=a.length;n<o;++n)r=t(r,a[n].isotope,a[n].count,a[n].charge||0)}else if(i instanceof Kekule.Atom){i.getIsotope();r=t(r,i.getIsotope(),1,i.getCharge()||0);var s=i.getHydrogenCount();if(s>0)r=t(r,Kekule.IsotopeFactory.getIsotope(1),s,0)}}return r},calcFormula:function(){var e=this.getIsotopeMaps();if(e.length<=0)return null;for(var t=new Kekule.MolecularFormula,r=0,n=e.length;r<n;++r){var o=new Kekule.Atom;o.setIsotope(e[r].isotope),t.appendSection(o,e[r].count,e[r].charge)}return t},getNodesContainBox:function(e,t,r){for(var n=t===Kekule.CoordMode.COORD3D,o={},i=0,a=e.length;i<a;++i){var s=e[i].getAbsCoordOfMode(t,r);0==i?(o.x1=o.x2=s.x,o.y1=o.y2=s.y,n&&(o.z1=o.z2=s.z)):(s.x<o.x1?o.x1=s.x:s.x>o.x2&&(o.x2=s.x),s.y<o.y1?o.y1=s.y:s.y>o.y2&&(o.y2=s.y),n&&(s.z<o.z1?o.z1=s.z:s.z>o.z2&&(o.z2=s.z)))}return o},getContainerBox:function(e,t){return this.getNodesContainBox(this.getNodes(),e,t)},getContainerBox2D:function(e){var t=this.getContainerBox(Kekule.CoordMode.COORD2D,e);return t.width=t.x2-t.x1,t.height=t.y2-t.y1,t},getContainerBox3D:function(e){var t=this.getContainerBox(Kekule.CoordMode.COORD3D,e);return t.deltaX=t.x2-t.x1,t.deltaY=t.y2-t.y1,t.deltaZ=t.z2-t.z1,t},traverse:function(t,r,n,o){for(var i={nodes:[],connectors:[]},a=e.clone(o||this.getNodes()),s=0,u=a.length;s<u;++s)a[s][this.TRAVERS_VISITED_KEY]=!1;for(;a.length;){var l;l=r&&a.indexOf(r)>=0?r:a[0];var c=this._doTravers(t,l,n,o);i.nodes=i.nodes.concat(c.nodes),i.connectors=i.connectors.concat(c.connectors),a=e.exclude(a,c.nodes)}return i},_doTravers:function(t,r,n,o){var i={nodes:[],connectors:[]},a=r;a[this.TRAVERS_VISITED_KEY]||(i.nodes.push(a),a[this.TRAVERS_VISITED_KEY]=!0,t&&t(a,!1));var s=e.clone(a.getLinkedConnectors()),u=this.getConnectors();s.sort(function(e,t){return u.indexOf(e)-u.indexOf(t)});for(var l=[],c=0,d=s.length;c<d;++c){var h=s[c],p=a.getLinkedObjsOnConnector(h);o&&(p=e.intersect(p,o));for(var C=0,f=p.length;C<f;++C){var g=p[C];if(g instanceof Kekule.BaseStructureNode)break}if(g&&!g[this.TRAVERS_VISITED_KEY])if(i.nodes.push(g),i.connectors.push(h),g[this.TRAVERS_VISITED_KEY]=!0,t&&(t(h,!0),t(g,!1)),n)l.push(g);else{var k=this._doTravers(t,g,n,o);i.nodes=i.nodes.concat(k.nodes),i.connectors=i.connectors.concat(k.connectors)}}if(n)for(c=0,d=l.length;c<d;++c){var m=l[c];k=this._doTravers(t,m,n,o);i.nodes=i.nodes.concat(k.nodes),i.connectors=i.connectors.concat(k.connectors)}return i}}),Kekule.StructureFragment=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.StructureFragment",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r])},doFinalize:function(){this.hasFormula()&&this.getFormula().finalize(),this.hasCtab()&&this.getCtab().finalize(),this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("formula",{dataType:"Kekule.MolecularFormula",getter:function(e){return this.getPropStoreFieldValue("formula")||e&&this.createFormula(),this.getPropStoreFieldValue("formula")},setter:function(e){var t=this.getPropStoreFieldValue("formula");t&&(t.finalize(),t=null),e&&(e.setPropValue("parent",this,!0),e.addEventListener("change",function(e){this.notifyPropSet("formula",this.getFormula())},this)),this.setPropStoreFieldValue("formula",e)}}),this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",getter:function(e){return this.getPropStoreFieldValue("ctab")||e&&this.createCtab(),this.getPropStoreFieldValue("ctab")},setter:function(e){var t=this.getPropStoreFieldValue("ctab");t&&(t.finalize(),t=null),e&&(e.setPropValue("parent",this,!0),e.setOwner(this.getOwner()),e.addEventListener("propValueSet",function(e){"nodes"!=e.propName&&"anchorNodes"!=e.propName&&"connectors"!=e.propName||this.notifyPropSet(e.propName,e.propValue)},this),e.setEnablePropValueSetEvent(!0)),this.setPropStoreFieldValue("ctab",e)}}),this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}}),this.defineProp("anchorNodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getAnchorNodes():[]}}),this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}}),this.defineProp("crossConnectors",{dataType:DataType.ARRAY,serializable:!1,setter:null,scope:Class.PropertyScope.PUBLIC,getter:function(){for(var e=[].concat(this.getPropStoreFieldValue("linkedConnectors")),t=0,r=this.getNodeCount();t<r;++t)for(var n=this.getNodeAt(t).getLinkedConnectors()||[],o=0,i=n.length;o<i;++o)this.indexOfConnector(n[o])<0&&Kekule.ArrayUtils.pushUnique(e,n[o]);return e}}),this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenNodes():[]}}),this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenConnectors():[]}}),this.defineProp("canonicalizationInfo",{dataType:DataType.OBJECT,serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getStructureCacheData("canonicalizationInfo")},setter:function(e){this.setStructureCacheData("canonicalizationInfo",e)}}),this.defineProp("aromaticRings",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){var e=this.getStructureCacheData("aromaticRings");return e||(e=[],this.setStructureCacheData("aromaticRings",e)),e},setter:function(e){this.setStructureCacheData("aromaticRings",e)}}),this.defineProp("flattenedShadow",{dataType:"Kekule.StructureFragmentShadow",serializable:!1,scope:Class.PropertyScope.PRIVATE,getter:function(e){var t=null;if(Kekule.ObjUtils.isUnset(e)&&(e=!0),this.getFlattenedShadowOnSelf())return null;if(!(t=this.getPropStoreFieldValue("flattenedShadow"))&&e){var r=(t=new Kekule.StructureFragmentShadow(this)).getShadowFragment();r.unmarshalAllSubFragments(!0),this._copyAdditionalInfoToShadowFragment(r,t.getSourceToShadowMap(),t.getShadowToSourceMap()),this.setPropStoreFieldValue("flattenedShadow",t)}return t}}),this.defineProp("flattenedShadowOnSelf",{dataType:DataType.BOOL,serializable:!1,scope:Class.PropertyScope.PROVATE,setter:null,getter:function(){var e=this.setPropStoreFieldValue("flattenedShadowOnSelf");return Kekule.ObjUtils.isUnset(e)&&(e=!this.hasSubFragments(),this.setPropStoreFieldValue("flattenedShadowOnSelf",e)),e}})},getAutoIdPrefix:function(){return"f"},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["ctab","formula","nodes","anchorNodes","connectors"])},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var n=this.hasCtab(),o=e.hasCtab&&e.hasCtab();if(!(r=n?o?0:1:o?-1:0)){var i=this.hasFormula(),a=e.hasFormula&&e.hasFormula();r=i?a?0:1:a?-1:0}if(!r&&this.hasCtab()){if(0===r&&this.getNonHydrogenNodes&&e.getNonHydrogenNodes){var s=function(e,t){var r;e instanceof Kekule.ChemStructureConnector?r=e.getConnectedNonHydrogenObjs():e instanceof Kekule.ChemStructureNode&&(r=e.getLinkedNonHydrogenObjs());for(var n=[],o=0,i=r.length;o<i;++o){var a=r[o],s=t.indexOfNode(a);s>=0&&n.push(s)}return n.sort(),n},u=this.getNonHydrogenNodes(),l=e.getNonHydrogenNodes();if(0===(r=u.length-l.length))for(var c=0,d=u.length;c<d&&0===(r=this.doCompareOnValue(u[c],l[c],t));++c){var h=s(u[c],this),p=s(l[c],e);if(0!==(r=Kekule.ArrayUtils.compare(h,p)))break}}if(0===r&&this.getConnectors&&e.getConnectors){var C=this.getNonHydrogenConnectors(),f=e.getNonHydrogenConnectors();if(0===(r=C.length-f.length))for(c=0,d=C.length;c<d&&0===(r=this.doCompareOnValue(C[c],f[c],t));++c){h=s(C[c],this),p=s(f[c],e);if(0!==(r=Kekule.ArrayUtils.compare(h,p)))break}}if(0===r){var g=this.getNonHydrogenNodes(),k=e.getNonHydrogenNodes(),m=this.traverse(null,g[g.length-1],!0,g),A=e.traverse(null,k[k.length-1],!0,k);for(c=0,d=m.nodes.length;c<d;++c){var S=m.nodes[c],y=A.nodes[c];if(0!==(r=this.doCompareOnValue(S,y,t)))break}if(0===r)for(c=0,d=m.connectors.length;c<d;++c){var b=m.connectors[c],O=A.connectors[c];if(0!==(r=this.doCompareOnValue(b,O,t)))break}}}}return r},structureChange:function(e){this.setPropStoreFieldValue("flattenedShadowOnSelf",null);var t=this.getFlattenedShadow(!1);t&&(t.finalize(),this.setPropStoreFieldValue("flattenedShadow",null)),this.tryApplySuper("structureChange",[e])},clearStructureFlags:function(){this.tryApplySuper("clearStructureFlags");for(var e=0,t=this.getChildCount();e<t;++e){var r=this.getChildAt(e);r.clearStructureFlags&&r.clearStructureFlags()}},ownerChanged:function(e,t){this.hasCtab()&&this.getCtab().setOwner(e),this.tryApplySuper("ownerChanged",[e,t])},_removeChildObj:function(e){if(this.hasFormula())this.getFormula()===e&&this.removeFormula();else if(this.hasCtab()){var t=this.getCtab();t===e?this.removeCtab():t.hasChildObj(e)&&t.removeChildObj(e)}this.tryApplySuper("_removeChildObj",[e])},isEmpty:function(){var e;return(e=!this.hasFormula())&&((e=!this.hasCtab())||(e=this.getCtab().isEmpty())),e},isCtabEmpty:function(){return!this.hasCtab()||this.getCtab().isEmpty()},doGetLinkedConnectors:function(){return this.getCrossConnectors()},appendLinkedConnector:function(e){var t=this.getCurrConnectableObj();return t&&t!==this?t.appendLinkedConnector(e):this.tryApplySuper("appendLinkedConnector",[e])},getCurrConnectableObj:function(){var e=this.getAnchorNodeCount()>0?this.getAnchorNodes():this.getNodes();if(e.length<=0)return this;for(var t=this.getCrossConnectors(),r=null,n=null,o=0,i=e.length;o<i;++o){var a=e[o],s=a.getLinkedConnectors(),u=Kekule.ArrayUtils.intersect(s,t).length;(null===r||r>u)&&(r=u,n=a)}return n},getActualConnectedObjToConnector:function(e){if(this.indexOfConnector(e)>=0)return null;if(e.indexOfConnectedObj(this)>=0)return this;for(var t=0,r=e.getConnectedObjCount();t<r;++t){var n=e.getConnectedObjAt(t);if(n.isChildOf(this))return n}return null},createCtab:function(){var e=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setCtab(e)},createFormula:function(){var e=new Kekule.MolecularFormula(this);this.setFormula(e)},hasCtab:function(){return!!this.getPropStoreFieldValue("ctab")},hasFormula:function(){return!!this.getPropStoreFieldValue("formula")},removeFormula:function(){var e=this.getPropStoreFieldValue("formula");return e&&(e.finalize(),e=null,this.setPropStoreFieldValue("formula",null)),this},removeCtab:function(){var e=this.getPropStoreFieldValue("ctab");return e&&(e.finalize(),e=null,this.setPropStoreFieldValue("ctab",null)),this},getContainerBox:function(e,t){return this.hasCtab()?this.getCtab().getContainerBox(e,t):this.tryApplySuper("getContainerBox",[e])},getNodeById:function(e){return this.hasCtab()?this.getCtab().getNodeById(e):null},getConnectorById:function(e){return this.hasCtab()?this.getCtab().getConnectorById(e):null},getObjectById:function(e){var t=this.getNodeById(e);return t||this.getConnectorById(e)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(e){return this.hasCtab()?this.getCtab().getNodeAt(e):null},indexOfNode:function(e){return this.hasCtab()?this.getCtab().indexOfNode(e):-1},hasNode:function(e,t){return this.hasCtab()?this.getCtab().hasNode(e,t):null},indexStackOfNode:function(e){return this.hasCtab()?this.getCtab().indexStackOfNode(e):-1},getNodeAtIndexStack:function(e){return this.hasCtab()?this.getCtab().getNodeAtIndexStack(e):null},getDirectChildOfNestedNode:function(e){var t=e.getParent();if(t){if(t===this)return t;for(var r=e;t&&t.getParent&&t!==this;)r=t,t=t.getParent();return t===this?r:null}return null},insertNodeBefore:function(e,t){return this.doGetCtab(!0).insertNodeBefore(e,t)},appendNode:function(e){return this.doGetCtab(!0).appendNode(e)},insertNodeAt:function(e,t){return this.doGetCtab(!0).insertNodeAt(e,t)},removeNodeAt:function(e,t){return this.hasCtab()?this.getCtab().removeNodeAt(e,t):null},removeNode:function(e,t){return this.hasCtab()?this.getCtab().removeNode(e,t):null},replaceNode:function(e,t){return this.hasCtab()?this.getCtab().replaceNode(e,t):null},clearNodes:function(){if(this.hasCtab())return this.getCtab().clearNodes()},sortNodes:function(e){if(this.hasCtab())return this.getCtab().sortNodes(e)},nodesHasCoord2D:function(e,t){return!!this.hasCtab()&&this.getCtab().nodesHasCoord2D(e,t)},nodesHasCoord3D:function(e,t){return!!this.hasCtab()&&this.getCtab().nodesHasCoord3D(e,t)},nodesHasCoordOfMode:function(e,t,r){return!!this.hasCtab()&&this.getCtab().nodesHasCoordOfMode(e,t,r)},isNodeInAromaticRing:function(e){for(var t=this.getAromaticRings(),r=0,n=t.length;r<n;++r){if(t[r].nodes.indexOf(e)>=0)return!0}return!1},appendAtom:function(e,t,r,n){return this.doGetCtab(!0).appendAtom(e,t,r,n)},getAnchorNodeCount:function(){return this.hasCtab()?this.getCtab().getAnchorNodeCount():0},getAnchorNodeAt:function(e){return this.hasCtab()?this.getCtab().getAnchorNodeAt(e):null},indexOfAnchorNode:function(e){return this.hasCtab()?this.getCtab().indexOfAnchorNode(e):-1},appendAnchorNode:function(e){return this.doGetCtab(!0).appendAnchorNode(e)},removeAnchorNodeAt:function(e){return this.hasCtab()?this.getCtab().removeAnchorNodeAt(e):null},removeAnchorNode:function(e){return this.hasCtab()?this.getCtab().removeAnchorNode(e):null},clearAnchorNodes:function(){if(this.hasCtab())return this.getCtab().clearAnchorNodes()},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(e){return this.hasCtab()?this.getCtab().getConnectorAt(e):null},indexOfConnector:function(e){return this.hasCtab()?this.getCtab().indexOfConnector(e):-1},hasConnector:function(e,t){return this.hasCtab()?this.getCtab().hasConnector(e,t):null},insertConnectorBefore:function(e,t){return this.doGetCtab(!0).insertConnectorBefore(e,t)},appendConnector:function(e){return this.doGetCtab(!0).appendConnector(e)},insertConnectorAt:function(e,t){return this.doGetCtab(!0).insertConnectorAt(e,t)},removeConnectorAt:function(e,t){return this.hasCtab()?this.getCtab().removeConnectorAt(e,t):null},removeConnector:function(e,t){return this.hasCtab()?this.getCtab().removeConnector(e,t):null},clearConnectors:function(){if(this.hasCtab())return this.getCtab().clearConnectors()},sortConnectors:function(e){if(this.hasCtab())return this.getCtab().sortConnectors(e)},isConnectorInAromaticRing:function(e){for(var t=this.getAromaticRings(),r=0,n=t.length;r<n;++r){if(t[r].connectors.indexOf(e)>=0)return!0}return!1},appendBond:function(e,t,r){return this.doGetCtab(!0).appendBond(e,t,r)},_getObjsNeedToBeCascadeRemoved:function(e,t){return this.hasCtab()?this.getCtab()._getObjsNeedToBeCascadeRemoved(e,t):[]},removeChildObj:function(e,t,r){this.hasCtab()&&this.getCtab().removeChildObj(e,t,r)},hasChildObj:function(e){return!!this.hasCtab()&&this.getCtab().hasChildObj(e)},getNextSiblingOfChild:function(e){return this.hasCtab()&&this.getCtab().getNextSiblingOfChild(e)||this.tryApplySuper("getNextSiblingOfChild",[e])},getChildSubgroupNames:function(){return["node","connector"].concat(this.tryApplySuper("getChildSubgroupNames"))},getBelongChildSubGroupName:function(e){return e instanceof Kekule.SimpleStructureNode?"node":e instanceof Kekule.BaseStructureConnector?"connector":this.tryApplySuper("getBelongChildSubGroupName",[e])},isSubFragment:function(e){return e.getNodeCount&&e.getNodeCount()>0},getSubFragments:function(){return this.hasCtab()?this.getCtab().getSubFragments():[]},hasSubFragments:function(){return!!this.hasCtab()&&this.getCtab().hasSubFragments()},getLeafNodes:function(){return this.hasCtab()?this.getCtab().getLeafNodes():[]},findDirectChildOfObj:function(e){return this.hasCtab()?this.getCtab().findDirectChildOfObj(e):null},getAllChildConnectors:function(){return this.hasCtab()?this.getCtab().getAllChildConnectors():[]},getAllContainingConnectors:function(){return this.hasCtab()?this.getCtab().getAllContainingConnectors():[]},getIsotopeMaps:function(){return this.hasCtab()?this.getCtab().getIsotopeMaps():[]},clear:function(){this.hasCtab()&&this.setCtab(void 0),this.hasFormula()&&this.setFormula(void 0)},clean:function(e){var t=Object.extend({},Kekule.globalOptions.algorithm.structureClean.structureCleanOptions);return t=Object.extend(t,e||{}),this.doClean(t)},doClean:function(e){if(e.hangingChemConnector)for(var t=this.getConnectorCount()-1;t>=0;--t){var r=this.getConnectorAt(t);r instanceof Kekule.ChemStructureConnector&&r.getConnectedObjCount()<2&&this.removeConnectorAt(t)}var n=this.getNodeCount();for(t=n-1;t>=0;--t){var o=this.getNodeAt(t);o instanceof Kekule.ChemStructureNode&&(this.isSubFragment(o)&&o.doClean?o.doClean(e):e.orphanChemNode&&o.getLinkedConnectorCount()<1&&n>1&&this.removeNodeAt(t))}return this},clearExplicitBondHydrogens:function(e,t){var r=this,n=function(e){var t=e.getLinkedConnectors(),r=1===t.length;if(r){var n=t[0];r=n.isSingleBond&&n.isSingleBond()&&n.getStereo&&(!n.getStereo()||n.getStereo()===Kekule.BondStereo.NONE)}return r},o=function(e,t){for(var n=e.getLinkedConnectors(),o=n.length;o>=0;--o){var i=n[o];r.hasConnector(i,!0)&&r.removeConnector(i,!1)}r.removeNodeAt(t,!1)},i=function(e,t,n){for(var o=e.getLinkedConnectors(),i=o.length;i>=0;--i){var a=o[i];if(r.hasConnector(a,!0)){if(n){var s=e.getLinkedObjsOnConnector(a)[0],u=s.getStructureCacheData("omittedBondHydrogenAtomCount")||0;s.setStructureCacheData("omittedBondHydrogenAtomCount",u+1)}r.removeConnector(a,!1)}}r.removeNodeAt(t,!1)};if(e){var a=this.getAutoClearStructureCache();this.setAutoClearStructureCache(!1)}this.beginUpdate();try{for(var s=this.getNodeCount()-1;s>=0;--s){var u=this.getNodeAt(s);u instanceof Kekule.ChemStructureNode&&(this.isSubFragment(u)&&u.clearExplicitBondHydrogens?(u.clearExplicitBondHydrogens(e,t),u.getNodeCount()<=0&&o(u,s)):u.isHydrogenAtom()&&(t||n(u))&&i(u,s,!0))}}finally{this.endUpdate(),e&&this.setAutoClearStructureCache(a)}return this},calcFormula:function(){return this.hasCtab()?this.getCtab().calcFormula():this.hasFormula()?this.getFormula():null},marshalSubFragment:function(e,t){if(this.hasCtab()){this.beginUpdate();try{this.appendNode(t);for(var r=[],n=[],o=[],i=[],a=0,s=e.length;a<s;++a){var u=e[a];if(!(this.indexOfNode(u)<0)){for(var l=!1,c=u.getLinkedConnectors(),d=0,h=c.length;d<h;++d){for(var p=c[d],C=!1,f=p.getConnectedObjs(),g=0,k=f.length;g<k;++g){var m=f[g];m!=u&&e.indexOf(m)<0&&(l=!0,C=!0)}C?Kekule.ArrayUtils.pushUnique(i,p):Kekule.ArrayUtils.pushUnique(o,p)}Kekule.ArrayUtils.pushUnique(r,u),l&&Kekule.ArrayUtils.pushUnique(n,u)}}for(a=o.length-1;a>=0;--a)this.removeConnector(o[a],!0);for(a=r.length-1;a>=0;--a)this.removeNode(r[a],!0);t.beginUpdate();try{for(a=0,s=r.length;a<s;++a)t.appendNode(r[a]);for(a=0,s=n.length;a<s;++a)t.appendAnchorNode(n[a]);for(a=0,s=o.length;a<s;++a)t.appendConnector(o[a])}finally{t.endUpdate()}}finally{this.endUpdate()}return t}return null},unmarshalSubFragment:function(e,t){if(this.hasCtab()){this.beginUpdate();try{e.beginUpdate();try{t&&e.unmarshalAllSubFragments&&e.unmarshalAllSubFragments(t);var r=this.getCtab();Kekule.StructureFragment.moveChildBetweenStructFragment(e,this,e.getNodes(),e.getConnectors(),!0),e.clear(),r.removeNode(e)}finally{e.endUpdate(),e.finalize()}}finally{this.endUpdate()}}},unmarshalAllSubFragments:function(e){var t=this.getSubFragments();if(t)for(var r=0,n=t.length;r<n;++r)this.unmarshalSubFragment(t[r],e)},recalcCoords:function(){if(this.hasCtab()){this.beginUpdate();try{for(var e={},t={},r=this.getAnchorNodeCount(),n=0,o=r;n<o;++n){var i=this.getAnchorNodeAt(n);e=Kekule.CoordUtils.add(e,i.getCoord2D()||{}),t=Kekule.CoordUtils.add(t,i.getCoord3D()||{})}var a=Kekule.ObjUtils.notUnset,s=a(e.x)||a(e.y),u=a(t.x)||a(t.y)||a(t.z);if(s){var l=Kekule.CoordUtils.substract({},e);this.setCoord2D(Kekule.CoordUtils.substract(this.fetchCoord2D(),l))}if(u){var c=Kekule.CoordUtils.substract({},t);this.setCoord3D(Kekule.CoordUtils.substract(this.fetchCoord3D(),c))}for(n=0,o=this.getNodeCount();n<o;++n){i=this.getNodeAt(n);s&&i.setCoord2D(Kekule.CoordUtils.add(i.fetchCoord2D(),l)),u&&i.setCoord3D(Kekule.CoordUtils.add(i.fetchCoord3D(),c))}}finally{this.endUpdate()}}},_copyAdditionalInfoToShadowFragment:function(e,t,r){var n=this.getAromaticRings();if(n&&n.length){for(var o=[],i=0,a=n.length;i<a;++i){for(var s=n[i],u=[],l=[],c=0,d=s.nodes.length;c<d;++c){(h=t.get(s.nodes[c]))&&u.push(h)}for(c=0,d=s.connectors.length;c<d;++c){var h;(h=t.get(s.connectors[c]))&&l.push(h)}var p=Object.extend({},s);p.nodes=u,p.connectors=l,o.push(p)}e.setAromaticRings(o)}},getFlattenedShadowFragment:function(e){if(this.getFlattenedShadowOnSelf())return this;var t=this.getFlattenedShadow(e);return t?t.getShadowFragment():null},getFlatternedShadowShadowObj:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var r=this.getFlattenedShadow(t);return r?r.getShadowObj(e):null},getFlatternedShadowSourceObj:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var r=this.getFlattenedShadow(t);return r?r.getSourceObj(e):null},getFlatternedShadowShadowObjs:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var r=this.getFlattenedShadow(t),n=[];if(r)for(var o=0,i=e.length;o<i;++o)n.push(r.getShadowObj(e[o]));return n},getFlatternedShadowSourceObjs:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var r=this.getFlattenedShadow(t),n=[];if(r)for(var o=0,i=e.length;o<i;++o)n.push(r.getSourceObj(e[o]));return n},createShadow:function(){var e=new Kekule.StructureFragmentShadow(this);return this._copyAdditionalInfoToShadowFragment(e.getShadowFragment(),e.getSourceToShadowMap(),e.getShadowToSourceMap()),e},traverse:function(e,t,r,n){return this.hasCtab()?this.getCtab().traverse(e,t,r,n):null}}),Kekule.StructureFragment.moveChildBetweenStructFragment=function(e,t,r,n,o){var i=Kekule.CoordUtils;e.beginUpdate(),t.beginUpdate();var a=e.getAnchorNodes();try{for(var s=e.getAbsCoord2D(),u=e.getAbsCoord3D(),l=t.getAbsCoord2D(),c=t.getAbsCoord3D(),d=i.substract(s,l),h=i.substract(u,c),p=Kekule.ArrayUtils.clone(r),C=Kekule.ArrayUtils.clone(n),f=0,g=p.length;f<g;++f){var k=p[f];if((b=e.indexOfNode(k))>=0){e.removeNodeAt(b,!0);var m=k.getCoord2D();if(m){var A=i.add(m,d);k.setCoord2D(A)}var S=k.getCoord3D();if(S){var y=i.add(S,h);k.setCoord2D(y)}t.appendNode(k),a.indexOf(k)>=0&&(e.removeAnchorNode(k),o||t.appendAnchorNode(k))}}for(f=0,g=C.length;f<g;++f){var b,O=C[f];(b=e.indexOfConnector(O))>=0&&(e.removeConnectorAt(b,!0),t.appendConnector(O))}}finally{t.endUpdate(),e.endUpdate()}},Kekule.StructureFragmentShadow=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureFragmentShadow",initialize:function(e){if(e){this.tryApplySuper("initialize"),this.setPropStoreFieldValue("shadowToSourceMap",new Kekule.MapEx),this.setPropStoreFieldValue("sourceToShadowMap",new Kekule.MapEx);var t=this._createShadowFragment(e,this.getSourceToShadowMap(),this.getShadowToSourceMap());this.setPropStoreFieldValue("shadowFragment",t)}else Kekule.error(Kekule.$L("ErrorMsg.SOURCE_FRAGMENT_NOT_SET"))},doFinalize:function(){this.getShadowToSourceMap().finalize(),this.getSourceToShadowMap().finalize(),this.getShadowFragment().finalize(),this.setPropStoreFieldValue("shadowToSourceMap",null),this.setPropStoreFieldValue("sourceToShadowMap",null),this.setPropStoreFieldValue("shadowFragment",null),this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("shadowFragment",{dataType:"Kekule.StructureFragment",setter:null}),this.defineProp("sourceToShadowMap",{dataType:"Kekule.MapEx",setter:null}),this.defineProp("shadowToSourceMap",{dataType:"Kekule.MapEx",setter:null})},_createShadowFragment:function(e,t,r){var n=e.clone();return this._mapFragmentChildren(e,n,t,r),n},_mapFragmentChildren:function(e,t,r,n){for(var o=0,i=e.getChildCount();o<i;++o){var a=e.getChildAt(o),s=t.getChildAt(o);r.set(a,s),n.set(s,a),a.getChildCount&&s.getChildCount&&this._mapFragmentChildren(a,s,r,n)}},getShadowObj:function(e){return this.getSourceToShadowMap().get(e)},getSourceObj:function(e){return this.getShadowToSourceMap().get(e)}}),Kekule.SubGroup=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.SubGroup",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,n,o]),this.setPropStoreFieldValue("abbr",t),this.setPropStoreFieldValue("name",r)},initProperties:function(){this.defineProp("abbr",{dataType:DataType.STRING}),this.defineProp("formulaText",{dataType:DataType.STRING}),this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"g"},doPropChanged:function(e,t){return"anchorNodes"==e&&this.recalcCoords(),this.tryApplySuper("doPropChanged",[e,t])},getLabel:function(){return this.getName()||this.getAbbr()||this.getFormulaText()||Kekule.ChemStructureNodeLabels.SUBGROUP}}),Kekule.RGroup=Kekule.SubGroup,Kekule.Molecule=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.Molecule",initialize:function(e,t,r){this.tryApplySuper("initialize",[e]),this.setPropStoreFieldValue("name",t),r&&this.setCtab(new Kekule.StructureConnectionTable)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"m"}}),Kekule.BaseStructureConnector=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.BaseStructureConnector",initialize:function(e,t){this.tryApplySuper("initialize",[e]),this.setConnectedObjs(t||[])},initProperties:function(){this.defineProp("connectedObjs",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:function(e){var t=this.getPropStoreFieldValue("connectedObjs");t||(this.setPropStoreFieldValue("connectedObjs",[]),t=this.getPropStoreFieldValue("connectedObjs"));for(var r=0,n=t.length;r<n;++r)t[r].removeLinkedConnector(this);if(e){for(r=0,n=e.length;r<n;++r)this.assertConnectedObjLegal(e[r]);for(r=0,n=e.length;r<n;++r){var o=e[r],i=o.getCurrConnectableObj?o.getCurrConnectableObj():o;Kekule.ArrayUtils.pushUnique(t,i)}}else this.setPropStoreFieldValue("connectedObjs",[]);for(r=0,n=(t=this.getPropStoreFieldValue("connectedObjs")).length;r<n;++r)t[r].appendLinkedConnector(this);this.notifyConnectedObjsChanged()}}),this.defineProp("neighboringConnectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=this.getConnectedObjs(),r=0,n=t.length;r<n;++r){var o=t[r];o.getLinkedConnectors&&Kekule.ArrayUtils.pushUnique(e,o.getLinkedConnectors()||[])}return Kekule.ArrayUtils.remove(e,this),e}})},getAutoIdPrefix:function(){return"c"},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["connectedObjs"])},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"connectedObjCount")){var n=this.getConnectedObjCount(),o=e.getConnectedObjCount&&e.getConnectedObjCount();r=this.doCompareOnValue(n,o,t)}return r},notifyConnectedObjsChanged:function(){this.notifyPropSet("connectedObjs",this.getPropStoreFieldValue("connectedObjs"))},assertConnectedObjLegal:function(e){if(e&&e.getOwner)return!e.getOwner()||e.getOwner()==this.getOwner()||(Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_DIFF_OWNER_OBJ"):"Object with different owner can not be linked to connector"),!1);Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_MISTYPED_NODE"):"Unable to link mistyped node to connector")},connectedObjAdded:function(e){this.notifyConnectedObjsChanged()},getConnectedObjCount:function(){return this.getConnectedObjs().length},indexOfConnectedObj:function(e){return this.getConnectedObjs().indexOf(e)},getConnectedObjAt:function(e){return this.getConnectedObjs()[e]},setConnectedObjAt:function(e,t){this.assertConnectedObjLegal(t);var r=this.getConnectedObjs()[e];r&&r.removeLinkedConnector(this),this.insertConnectedObjAt(t,e),this.connectedObjAdded(t)},appendConnectedObj:function(e){this.assertConnectedObjLegal(e);var t=e.getCurrConnectableObj?e.getCurrConnectableObj():e,r=this._doAppendConnectedObj(t);return t&&t.appendLinkedConnector(this),r},_doAppendConnectedObj:function(e){var t=Kekule.ArrayUtils.pushUniqueEx(this.getConnectedObjs(),e);return t.isPushed&&this.connectedObjAdded(e),t.index},insertConnectedObjBefore:function(e,t){this.assertConnectedObjLegal(e);var r=t?t.getCurrConnectableObj?t.getCurrConnectableObj():t:null,n=r?this.indexOfConnectedObj(r):-1;return n<0?this.appendConnectedObj(e):this.insertConnectedObjAt(e,n)},insertConnectedObjAt:function(e,t){t||(t=0),this.assertConnectedObjLegal(e);var r=e.getCurrConnectableObj?e.getCurrConnectableObj():e,n=this.indexOfConnectedObj(r),o=this.getConnectedObjs();n>=0?(o.splice(n,1),o.splice(t,0,r),this.notifyConnectedObjsChanged()):(o.splice(t,0,r),r&&r.appendLinkedConnector(this),this.connectedObjAdded(r))},removeConnectedObjAt:function(e){var t=this.getConnectedObjs()[e];t&&(this._doRemoveConnectedObjAt(e),t._doRemoveLinkedConnectorAt(t.indexOfLinkedConnector(this)),this.notifyConnectedObjsChanged())},_doRemoveConnectedObjAt:function(e){this.getConnectedObjs().splice(e,1)},removeConnectedObj:function(e){var t=this.getConnectedObjs().indexOf(e);t>=0&&this.removeConnectedObjAt(t)},replaceConnectedObj:function(e,t){var r=this.indexOfConnectedObj(e);r>=0&&this.setConnectedObjAt(r,t)},clearConnectedObjs:function(){this.setConnectedObjs([])},hasConnectedObj:function(e){return this.getConnectedObjs().indexOf(e)>=0},isConnectingWithObj:function(e){return this.hasConnectedObj(e)},sortConnectedObjs:function(e){this.getConnectedObjs().sort(e)},reverseConnectedObjOrder:function(){this.setPropStoreFieldValue("connectedObjs",Kekule.ArrayUtils.reverse(this.getConnectedObjs())),this.notifyConnectedObjsChanged()},removeThisFromConnectedObjs:function(){for(var e=this.getConnectedObjCount()-1;e>=0;--e){this.getConnectedObjAt(e).removeLinkedConnector(this)}},getConnectedSiblings:function(){for(var e=this.getConnectedObjs(),t=[],r=this.getParent(),n=function(e){if(e.getParent){var t=e.getParent();return t===r?t:n(t)}return e},o=0,i=e.length;o<i;++o){var a=e[o];if(a.getParent&&a.getParent()!==r){var s=n(a);s&&t.push(s)}else t.push(a)}return t},isConnectingConnector:function(){for(var e=0,t=this.getConnectedObjCount();e<t;++e){if(this.getConnectedObjAt(e)instanceof Kekule.ChemStructureConnector)return!0}return!1}}),Kekule.ChemStructureConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.ChemStructureConnector",initProperties:function(){this.defineProp("parity",{dataType:DataType.INT}),this.defineProp("connectedChemNodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=0,r=this.getConnectedObjCount();t<r;++t){var n=this.getConnectedObjAt(t);n instanceof Kekule.ChemStructureNode&&e.push(n)}return e}})},getAcceptCoordStickFrom:function(e){return!(this.isSiblingWith(e)||e instanceof Kekule.ChemStructureNode||e instanceof Kekule.BaseStructureConnector)},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"stereo")){var n=this.getParity()||Kekule.StereoParity.UNKNOWN,o=e.getParity&&e.getParity()||Kekule.StereoParity.UNKNOWN;r=this.doCompareOnValue(n,o,t)}return r},clearStructureFlags:function(){this.setParity(Kekule.StereoParity.NONE)},getConnectedChemNodeCount:function(){return this.getConnectedChemNodes().length},getConnectedNonHydrogenObjs:function(){for(var e=[],t=this.getConnectedObjs(),r=0,n=t.length;r<n;++r){var o=t[r];o.isHydrogenAtom&&o.isHydrogenAtom()||e.push(o)}return e},isNormalConnectorToHydrogen:function(){return this.getConnectedNonHydrogenObjs().length<=1}}),Kekule.BondStereo={NONE:0,UP:1,UP_INVERTED:2,DOWN:3,DOWN_INVERTED:4,UP_OR_DOWN:8,UP_OR_DOWN_INVERTED:9,CLOSER:10,E_OR_Z:20,E:21,Z:22,E_Z_BY_COORDINATES:23,CIS_OR_TRANS:30,CIS:31,TRANS:32,getInvertedDirection:function(e){var t=Kekule.BondStereo;switch(e){case t.UP:return t.UP_INVERTED;case t.UP_INVERTED:return t.UP;case t.DOWN:return t.DOWN_INVERTED;case t.DOWN_INVERTED:return t.DOWN;case t.UP_OR_DOWN:return t.UP_OR_DOWN_INVERTED;default:return e}}},Kekule.Bond=Class.create(Kekule.ChemStructureConnector,{CLASS_NAME:"Kekule.Bond",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,t||[]]),(r||n||o)&&this.setBondForm(Kekule.BondFormFactory.getBondForm(r,n,o))},initProperties:function(){this.defineProp("bondForm",{dataType:"Kekule.BondForm",serializable:!1,scope:Class.PropertyScope.PUBLIC}),this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var e=this.getBondForm();return e?e.getBondType():Kekule.BondType.DEFAULT},setter:function(e){this.changeBondForm(this.getBondOrder(),Kekule.ElectronSet.UNSET_ELECTRONCOUNT,e)}}),this.defineProp("bondOrder",{dataType:DataType.INT,enumSource:Kekule.BondOrder,getter:function(){var e=this.getBondForm();return e?e.getBondOrder():Kekule.BondOrder.UNSET},setter:function(e){this.changeBondForm(e,Kekule.ElectronSet.UNSET_ELECTRONCOUNT,this.getBondType())}}),this.defineProp("bondValence",{dataType:DataType.INT,serializable:!1,getter:function(){var e=this.getBondForm();return e?e.getBondValence():0},setter:null}),this.defineProp("electronCount",{dataType:DataType.FLOAT,getter:function(){if(this.isAromatic())return 3;var e=this.getBondForm();return e?e.getElectronCount():Kekule.ElectronSet.UNSET_ELECTRONCOUNT},setter:function(e){var t=this.getBondOrder();this.changeBondForm(t,e,this.getBondType())}}),this.defineProp("stereo",{dataType:DataType.INT,enumSource:Kekule.BondStereo,defaultValue:Kekule.BondStereo.NONE}),this.defineProp("isInAromaticRing",{dataType:DataType.BOOL,setter:null,getter:function(){var e=this.getParent();return!(!e||!e.isConnectorInAromaticRing)&&e.isConnectorInAromaticRing(this)}}),this.defineProp("neighboringBonds",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=this.getNeighboringConnectors()||[],t=[],r=0,n=e.length;r<n;++r)e[r]instanceof Kekule.Bond&&t.push(e[r]);return t}})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setPropStoreFieldValue("stereo",Kekule.BondStereo.NONE)},getAutoIdPrefix:function(){return"b"},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["bondForm","stereo"])},clearStructureFlags:function(){this.setPropStoreFieldValue("isInAromaticRing",null)},doGetParity:function(){return this.isDoubleBond()?this.tryApplySuper("doGetParity"):null},doGetComparisonPropNames:function(e){var t=this.tryApplySuper("doGetComparisonPropNames",[e]);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(e,"bondType")&&t.push("bondType"),t},doCompare:function(e,t){var r=this.tryApplySuper("doCompare",[e,t]);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(t,"connectedObjCount")){var n=this.getConnectedObjCount(),o=e.getConnectedObjCount&&e.getConnectedObjCount();r=this.doCompareOnValue(n,o,t)}if(!r&&this._getComparisonOptionFlagValue(t,"bondOrder")){var i=Math.round(this.getElectronCount()),a=Math.round(e.getElectronCount());r=this.doCompareOnValue(i,a,t)}}return r},changeBondForm:function(e,t,r){this.setBondForm(Kekule.BondFormFactory.getBondForm(e,t,r))},canInvertBondDirection:function(){var e=Kekule.BondType,t=this.getBondType();return[e.COVALENT,e.IONIC,e.METALLIC,e.HYDROGEN,e.UNKNOWN].indexOf(t)>=0},invertBondDirection:function(){this.setStereo(Kekule.BondStereo.getInvertedDirection(this.getStereo()))},reverseConnectedObjOrder:function(){this.canInvertBondDirection()&&(this.tryApplySuper("reverseConnectedObjOrder"),this.invertBondDirection())},normalizeDirection:function(){var e=Kekule.BondStereo,t=[e.UP_INVERTED,e.DOWN_INVERTED,e.UP_OR_DOWN_INVERTED],r=this.getBondStereo();t.indexOf(r)>=0&&this.reverseConnectedObjOrder()},isCovalentBond:function(){return this.getBondType()===Kekule.BondType.COVALENT},isSingleBond:function(){return this.getBondType()===Kekule.BondType.COVALENT&&this.getBondOrder()===Kekule.BondOrder.SINGLE&&!this.getIsInAromaticRing()},isDoubleBond:function(){return this.getBondType()===Kekule.BondType.COVALENT&&this.getBondOrder()===Kekule.BondOrder.DOUBLE&&!this.getIsInAromaticRing()},isTripleBond:function(){return this.getBondType()===Kekule.BondType.COVALENT&&this.getBondOrder()===Kekule.BondOrder.TRIPLE},isAromatic:function(){return(!!this.getIsInAromaticRing()||this.getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC)&&this.getBondType()===Kekule.BondType.COVALENT},isBondBetween:function(e,t){var r,n,o=this.getConnectedObjs();if(2!==o.length)return!1;for(var i=0,a=o.length;i<a;++i){var s=o[i];if(s instanceof Kekule.Atom&&(s.isElement(e)?r=!0:s.isElement(t)&&(n=!0),r&&n))return!0}return!1}}),Kekule.ChemStructureObjectGroup=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.ChemStructureObject","Kekule.ChemStructureObjectGroup"],initialize:function(e){this.tryApplySuper("initialize",[e]),this.setPropStoreFieldValue("items",[]),this.setPropStoreFieldValue("raiseExceptionOnTypeMismatch",[])},initProperties:function(){this.defineProp("items",{dataType:DataType.ARRAY}),this.defineProp("raiseExceptionOnTypeMismatch",{dataType:DataType.BOOL,defaultValue:!0,scope:Class.PropertyScope.PUBLIC})},getAutoIdPrefix:function(){return"sg"},getStructureRelatedPropNames:function(){return this.tryApplySuper("getStructureRelatedPropNames").concat(["items"])},doGetComparisonPropNames:function(e){var t=this.tryApplySuper("doGetComparisonPropNames",[e]);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&t.push("items"),t},ownerChanged:function(e,t){for(var r=this.getItems(),n=0,o=r.length;n<o;++n){var i=r[n].obj;i&&i.setOwner&&i.setOwner(e)}this.tryApplySuper("ownerChanged",[e,t])},_removeChildObj:function(e){var t=this.indexOfObj(e);t<0&&(t=this.indexOfItem(e)),t>=0&&this.removeObjAt(t),this.tryApplySuper("_removeChildObj",[e])},getObjectBaseClasses:function(){return this.getPrototype().ITEM_BASE_CLASSES},ensureItemClass:function(e){var t=this.getObjectBaseClasses();if(t.length>0){for(var r=0,n=t.length;r<n;++r)if(e instanceof ClassEx.findClass(t[r]))return!0;if(this.getRaiseExceptionOnTypeMismatch()){var o=Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.CHEMSTRUCTUREOBJECTGROUP_ITEMCLASS_MISMATCH"):"Mismatched group item class";Kekule.raise(o)}return!1}return!0},notifyItemsChanged:function(){this.notifyPropSet("items",this.getPropStoreFieldValue("items"))},indexOfItem:function(e){return this.getItems().indexOf(e)},indexOfObj:function(e){for(var t=this.getItems(),r=0,n=t.length;r<n;++r)if(t[r].obj==e)return r;return-1},hasObj:function(e){return this.indexOfObj(e)>=0},setAttributesAt:function(e,t){var r=this.getItems()[e];if(r)for(var n=Kekule.ObjUtils.getOwnedFieldNames(t),o=0,i=n.length;o<i;++o)r[n[o]]=t[n[o]]},getItemCount:function(){return this.getItems().length},getItemAt:function(e){return this.getItems()[e]},appendItem:function(e){return this.getItems().push(e),this},insertItem:function(e,t){return this.insertItemAt(e,t)},insertItemAt:function(e,t){return Kekule.ArrayUtils.insertUniqueEx(this.getItems(),e,t).index},removeItemAt:function(e){this.getItems()[e]&&(this.getItems().splice(e,1),this.notifyItemsChanged())},removeItem:function(e){var t=this.getItems().indexOf(e);t>=0&&this.removeItemAt(t)},getObjAt:function(e){var t=this.getItemAt(e);return t?t.obj:null},insertObj:function(e,t,r){return this.insertObjAt(e,t,r)},insertObjAt:function(e,t,r){if(e)if(this.indexOfObj(e)>=0);else if(this.ensureItemClass(e)){var n={obj:e};this.beginUpdate();try{var o=this.insertItem(n,t);r&&this.setAttributesAt(o,r),this.notifyItemsChanged()}finally{this.endUpdate()}return o}},appendObj:function(e,t){return this.insertObj(e,null,t)},removeObjAt:function(e){this.getItems()[e]&&(this.getItems().splice(e,1),this.notifyItemsChanged())},removeObj:function(e){var t=this.indexOfObj(e);t>=0&&this.removeObjAt(t)},getAllObjs:function(){for(var e=[],t=0,r=this.getItemCount();t<r;++t)e.push(this.getObjAt(t));return e},getChildSubgroupNames:function(){return["item"].concat(this.tryApplySuper("getChildSubgroupNames"))},getBelongChildSubGroupName:function(e){return"item"},getNextSiblingOfChild:function(e){var t=this.indexOfItem(e);return t<0&&(t=this.indexOfObj(e)),t>=0?this.getChildAt(t+1):null},appendChild:function(e){return e instanceof Kekule.ChemObject?this.appendObj(e):this.appendItem(e)},insertChild:function(e,t){return e instanceof Kekule.ChemObject?this.insertObj(e,t):this.insertItem(e,t)},insertBefore:function(e,t){var r=this.indexOfItem(t);return r<0&&(r=this.indexOfObj(t)),this.insertChild(e,r)}}),Kekule.StructureFragmentGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.StructureFragment","Kekule.StructureFragmentGroup"]}),Kekule.MoleculeGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.MoleculeGroup",ITEM_BASE_CLASSES:["Kekule.Molecule","Kekule.MoleculeGroup"]}),Kekule.CompositeMolecule=Class.create(Kekule.Molecule,{CLASS_NAME:"Kekule.CompositeMolecule",initialize:function(e,t){this.tryApplySuper("initialize",[e,t])},initProperties:function(){this.defineProp("subMolecules",{dataType:"Kekule.MoleculeGroup",getter:function(){return this.getPropStoreFieldValue("subMolecules")||this.setPropStoreFieldValue("subMolecules",new Kekule.MoleculeGroup),this.getPropStoreFieldValue("subMolecules")}})},doGetComparisonPropNames:function(e){var t=this.tryApplySuper("doGetComparisonPropNames",[e]);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&t.push("subMolecules"),t},ownerChanged:function(e,t){var r=this.getPropStoreFieldValue("subMolecules");r&&r.setOwner(e),this.tryApplySuper("ownerChanged",[e,t])},getSubMoleculeCount:function(){var e=this.getPropStoreFieldValue("subMolecules");return e?e.length:0},hasCtab:function(){return!1},hasFormula:function(){return!1},getAllContainingConnectors:function(){for(var e=this.getSubMolecules(),t=[],r=0,n=e.getItemCount();r<n;++r){var o=e.getObjAt(r);if(o.getAllContainingConnectors){var i=o.getAllContainingConnectors();i&&i.length&&(t=t.concat(i))}}return t},getContainerBox:function(e){var t=null,r=this.getPropStoreFieldValue("subMolecules");if(r)for(var n=0,o=r.getItemCount();n<o;++n){var i=r.getObjAt(n).getContainerBox(e);i&&(t=t?Kekule.BoxUtils.getContainerBox(t,i):Kekule.BoxUtils.clone(i))}return t},doGetCtab:function(){return null},doSetCtab:function(){},doGetFormula:function(){return null},doSetFormula:function(){},getChildSubgroupNames:function(){return["subMolecule"].concat(this.tryApplySuper("getChildSubgroupNames"))},getBelongChildSubGroupName:function(e){return e instanceof Kekule.Molecule?"subMolecule":this.tryApplySuper("getBelongChildSubGroupName",[e])},getNextSiblingOfChild:function(e){return this.getSubMolecules().getNextSiblingOfChild(e)},insertChild:function(e,t){return this.insertChildAt(e,t)}}),Kekule.MoleculeList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.MoleculeList",initialize:function(e){this.tryApplySuper("initialize",[e,Kekule.Molecule])}}),Kekule.ChemStructureNodeLabels={ENABLE_ISOTOPE_ALIAS:!0,UNSET_ELEMENT:"?",DUMMY_ATOM:"Du",HETERO_ATOM:"Q",ANY_ATOM:"A",CUSTOM_ATOM:"@",VARIABLE_ATOM:"L",SUBGROUP:"R",ISO_LIST_LEADING_BRACKET:"[",ISO_LIST_TAILING_BRACKET:"]",ISO_LIST_DELIMITER:",",ISO_LIST_DISALLOW_PREFIX:"NOT"},Kekule.ChemStructureNodeFactory={CANDIDATE_CLASSES:[Kekule.SubGroup,Kekule.VariableAtom,Kekule.Pseudoatom],getClassByLabel:function(e,t){void 0===t&&(t=Kekule.Pseudoatom);for(var r,n=Kekule.ChemStructureNodeLabels,o=[[n.SUBGROUP],[n.VARIABLE_ATOM],[n.DUMMY_ATOM,n.HETERO_ATOM,n.ANY_ATOM,n.CUSTOM_ATOM]],i=Kekule.ChemStructureNodeFactory.CANDIDATE_CLASSES,a=0,s=i.length;a<s;++a){var u=i[a];if(o[a].indexOf(e)>=0){r=u;break}}return r||(r=Kekule.IsotopesDataUtil.isIsotopeIdAvailable(e)?Kekule.Atom:t),r},createByLabel:function(e){var t=new(Kekule.ChemStructureNodeFactory.getClassByLabel(e));return t instanceof Kekule.Pseudoatom?t.setSymbol(e):t instanceof Kekule.Atom&&t.setIsotopeId(e),t}}}(),Kekule.ChemStructureBuilder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemStructureBuilder",initialize:function(e){this.tryApplySuper("initialize"),e&&this.setTarget(e)},initProperties:function(){this.defineProp("target",{dataType:"Kekule.StructureFragment"})},setNodeCoord:function(){for(var e=Array.prototype.slice.call(arguments),t=e.shift(),r=e,n=0,o=r.length;n<o&&n<2;++n){var i=r[n];void 0!==i.z?t.setCoordOfMode(i,Kekule.CoordMode.COORD3D):t.setCoordOfMode(i,Kekule.CoordMode.COORD2D)}},createNode:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),r=e.shift(),n=e,o=new t(r);return this.setNodeCoord(o,n),this.appendNode(o),o},createConnector:function(e,t,r){var n=new e(t);return n.setConnectedObjs(r),n},appendNode:function(e){return e&&this.getTarget()?this.getTarget().appendNode(e):null},appendConnector:function(e){return e&&this.getTarget()?this.getTarget().appendConnector(e):null},createAtom:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),r=e.shift(),n=e.shift(),o=new Kekule.Atom(t,r,n);return e.unshift(o),this.setNodeCoord.apply(this,e),this.appendNode(o),o},createBond:function(e,t,r,n,o){var i=new Kekule.Bond(e,t,r);return i.changeBondForm(r,null,o),n&&i.setStereo(n),this.appendConnector(i),i},deleteNode:function(){},marshalSubGroup:function(e,t){var r=this.getTarget();if(r&&r.hasCtab()){var n=new Kekule.SubGroup(t);return r.marshalSubFragment(e,n),n}return null}}),Kekule.ReactionComponent={REACTANT:"reactant",PRODUCT:"product",SUBSTANCE:"substance",CONDITION:"condition"},Kekule.ReactionRole={REAGENT:"reagent",CATALYST:"catalyst",SOLVENT:"solvent",TEMPERATURE:"temperature",DURATION:"duration"},Kekule.ReactionDirection={FORWARD:1,BACKWARD:-1,BIDIRECTION:0},Kekule.Reaction=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Reaction",initialize:function(e){this.tryApplySuper("initialize",[e]),this.setDirection(Kekule.ReactionDirection.FORWARD)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING}),this.defineProp("title",{dataType:DataType.STRING}),this.defineProp("reactionType",{dataType:DataType.STRING}),this.defineProp("yield",{dataType:DataType.FLOAT}),this.defineProp("direction",{dataType:DataType.INT,defaultValue:Kekule.ReactionDirection.FORWARD,enumSource:Kekule.ReactionDirection}),this.defineProp("reactants",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("reactants");return!t&&e&&(t=[],this.setPropStoreFieldValue("reactants",t)),t}}),this.defineProp("products",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("products");return!t&&e&&(t=[],this.setPropStoreFieldValue("products",t)),t}}),this.defineProp("substances",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("substances");return!t&&e&&(t=[],this.setPropStoreFieldValue("substances",t)),t}}),this.defineProp("conditions",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("conditions");return!t&&e&&(t=[],this.setPropStoreFieldValue("conditions",t)),t}})},ownerChanged:function(e,t){for(var r=["reactants","products","substances","conditions"],n=0,o=r.length;n<o;++n){var i=r[n],a=this.getComponentArray(i);if(a)for(var s=0,u=a.length;s<u;++s){var l=a[s].item;l.setOwner&&l.setOwner(e)}}this.tryApplySuper("ownerChanged",[e,t])},assertAddingMolecule:function(e){e instanceof Kekule.Molecule||Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_ADD_NONMOLECULE_MAP"))},notifyReactantsChange:function(){this.notifyPropSet("reactants",this.getPropStoreFieldValue("reactants"))},notifyProductsChange:function(){this.notifyPropSet("products",this.getPropStoreFieldValue("products"))},notifySubstancesChange:function(){this.notifyPropSet("substances",this.getPropStoreFieldValue("substances"))},notifyConditionsChange:function(){this.notifyPropSet("conditions",this.getPropStoreFieldValue("conditions"))},notifyComponentChange:function(e){var t=this.componentToPropName(e);t&&this.notifyPropSet(t,this.getPropStoreFieldValue(t))},componentToPropName:function(e){return e+"s"},getComponentArray:function(e,t){var r=this.componentToPropName(e);if(!r)return null;switch(r){case"reactants":return this.doGetReactants(t);case"products":return this.doGetProducts(t);case"substances":return this.doGetSubstances(t);case"conditions":return this.doGetConditions(t);default:return null}},getComponentItemCount:function(e){var t=this.getComponentArray(e);return t?t.length:0},getMapAt:function(e,t){var r=this.getComponentArray(e);return r?r[t]:null},getMapItemAt:function(e,t){var r=this.getMapAt(e,t);return r?r.item:null},indexOfMap:function(e,t){var r=this.getComponentArray(e);return r?r.indexOf(t):-1},indexOfItem:function(e,t,r){var n=this.getComponentArray(e);if(n)for(var o=0,i=n.length;o<i;++o)if(n[o].item==t){if(void 0===r)return o;if(r===n[o].role)return o}return-1},appendMap:function(e,t){e!=Kekule.ReactionComponent.PRODUCT&&e!=Kekule.ReactionComponent.REACTANT||this.assertAddingMolecule(t.item);var r=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(e,!0),t);return r.isPushed&&this.notifyComponentChange(e),r.index},appendItem:function(e,t,r,n){var o=this.indexOfItem(e,t,r);if(o<0){e!=Kekule.ReactionComponent.PRODUCT&&e!=Kekule.ReactionComponent.REACTANT||this.assertAddingMolecule(t);var i=Kekule.RoleMapUtils.createMap(t,r);n&&Object.extend(i,n);var a=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(e,!0),i);return this.notifyComponentChange(e),a.index}return o},removeMapAt:function(e,t){var r=null,n=this.getComponentArray(e);return n&&(r=Kekule.ArrayUtils.removeAt(n,t))&&this.notifyComponentChange(e),r},removeMap:function(e,t){var r=null,n=this.getComponentArray(e);return n&&(r=Kekule.ArrayUtils.remove(n,t))&&this.notifyComponentChange(e),r},removeItem:function(e,t,r){var n=this.indexOfItem(e,t,r);return n>=0?this.removeMapAt(e,n):null},clearComponent:function(e){this.getComponentArray(e);this.notifyComponentChange(e)},getReactantCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.REACTANT)},getProductCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.PRODUCT)},getSubstancesCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.SUBSTANCE)},getConditionCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.CONDITION)},getReactantMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.REACTANT,e)},getProductMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.PRODUCT,e)},getSubstanceMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.SUBSTANCE,e)},getConditionMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.CONDITION,e)},getReactantItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,e)},getReactantAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,e)},getProductItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,e)},getProductAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,e)},getSubstanceItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,e)},getSubstanceAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,e)},getConditionItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.CONDITION,e)},indexOfReactantMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.REACTANT,e)},indexOfProductMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.PRODUCT,e)},indexOfSubstanceMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.SUBSTANCE,e)},indexOfConditionMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.CONDITION,e)},indexOfReactant:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.REACTANT,e,t)},indexOfProduct:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.PRODUCT,e,t)},indexOfSubstance:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.SUBSTANCE,e,t)},indexOfCondition:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.CONDITION,e,t)},appendReactantMap:function(e){return this.appendMap(Kekule.ReactionComponent.REACTANT,e)},appendProductMap:function(e){return this.appendMap(Kekule.ReactionComponent.PRODUCT,e)},appendSubstanceMap:function(e){return this.appendMap(Kekule.ReactionComponent.SUBSTANCE,e)},appendConditionMap:function(e){return this.appendMap(Kekule.ReactionComponent.CONDITION,e)},appendReactant:function(e,t,r,n){var o=n||{};return r&&(o.amount=r),this.appendItem(Kekule.ReactionComponent.REACTANT,e,t,o)},appendProduct:function(e,t,r,n){var o=n||{};return r&&(o.amount=r),this.appendItem(Kekule.ReactionComponent.PRODUCT,e,t,o)},appendSubstance:function(e,t,r,n){var o=n||{};return r&&(o.amount=r),this.appendItem(Kekule.ReactionComponent.SUBSTANCE,e,t,o)},appendCondition:function(e,t,r){return this.appendItem(Kekule.ReactionComponent.CONDITION,e,t,r)},removeReactantAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.REACTANT,e)},removeProductAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.PRODUCT,e)},removeSubstanceAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.SUBSTANCE,e)},removeConditionAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.CONDITION,e)},removeReactantMap:function(e){return this.removeMap(Kekule.ReactionComponent.REACTANT,e)},removeProductMap:function(e){return this.removeMap(Kekule.ReactionComponent.PRODUCT,e)},removeSubstanceMap:function(e){return this.removeMap(Kekule.ReactionComponent.SUBSTANCE,e)},removeConditionMap:function(e){return this.removeMap(Kekule.ReactionComponent.CONDITION,e)},removeReactant:function(e,t){return this.removeItem(Kekule.ReactionComponent.REACTANT,e,t)},removeProduct:function(e,t){return this.removeItem(Kekule.ReactionComponent.PRODUCT,e,t)},removeSubstance:function(e,t){return this.removeItem(Kekule.ReactionComponent.SUBSTANCE,e,t)},removeCondition:function(e,t){return this.removeItem(Kekule.ReactionComponent.CONDITION,e,t)},clearReactants:function(){return this.clearComponent(Kekule.ReactionComponent.REACTANT)},clearProducts:function(){return this.clearComponent(Kekule.ReactionComponent.PRODUCT)},clearSubstance:function(){return this.clearComponent(Kekule.ReactionComponent.SUBSTANCE)},clearConditions:function(){return this.clearComponent(Kekule.ReactionComponent.CONDITION)},clearAll:function(){this.clearProducts(),this.clearProducts(),this.clearSubstance(),this.clearConditions()},getAllContainingConnectors:function(){for(var e=Kekule.ReactionComponent,t=[e.REACTANT,e.PRODUCT,e.SUBSTANCE],r=[],n=0,o=t.length;n<o;++n)for(var i=t[n],a=0,s=this.getComponentItemCount(i);a<s;++a){var u=this.getMapItemAt(i,a);if(u.getAllContainingConnectors){var l=u.getAllContainingConnectors();l&&l.length&&(r=r.concat(l))}}return r}}),Kekule.ReactionList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.ReactionList",initialize:function(e){this.tryApplySuper("initialize",[e,Kekule.Reaction])}}),function(){"use strict";var e=Kekule.ArrayUtils;Kekule.ChemStructureUtils={getConnectorLengthMedian:function(e,t,r){for(var n=[],o=0,i=e.length;o<i;++o){var a=e[o];if(a&&a.getLength){var s=a.getLength(t,r);s&&n.push(s)}}if(0===i)return 1;if(i<=1)return n[0];n.sort();var u=n.length;return u%2?n[u+1>>1]:(n[u>>1]+n[(u>>1)-1])/2},getChildStructureObjs:function(e,t){var r,n=!0;if(e instanceof Kekule.CompositeMolecule)r=e.getSubMolecules().getAllObjs();else if(e instanceof Kekule.ChemStructureObjectGroup)r=e.getAllObjs();else if(e instanceof Kekule.ChemObjList)r=e.getItems();else if(e instanceof Kekule.ChemSpaceElement)r=e.getChildren().getItems();else{if(!(e instanceof Kekule.ChemSpace))return n=!1,[e];r=e.getChildren()}if(r=[].concat(r),t&&n){for(var o=[],i=0,a=r.length;i<a;++i){var s=r[i],u=Kekule.ChemStructureUtils.getChildStructureObjs(s,t);!u.length||1===u.length&&u[0]===s?Kekule.ArrayUtils.pushUnique(o,s):Kekule.ArrayUtils.pushUnique(o,u)}r=o}return r},getAllStructFragments:function(e,t){if(e instanceof Kekule.StructureFragment)return[e];for(var r=Kekule.ChemStructureUtils.getChildStructureObjs(e,t),n=[],o=0,i=r.length;o<i;++o)r[o]instanceof Kekule.StructureFragment&&Kekule.ArrayUtils.pushUnique(n,r[o]);return n},getTotalStructFragment:function(e,t){var r=Kekule.ChemStructureUtils.getAllStructFragments(e,!0),n=r.length;return n<=0?null:1===n?r[0]:Kekule.ChemStructureUtils.mergeStructFragments(r,t)},getCascadeDeleteObjs:function(e){for(var t=[],r=e.getLinkedConnectors?e.getLinkedConnectors():[],n=0,o=r.length;n<o;++n){var i=r[n];if(i.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(t,i);var a=Kekule.ChemStructureUtils.getCascadeDeleteObjs(i);Kekule.ArrayUtils.pushUnique(t,a)}}if(e instanceof Kekule.ChemStructureNode);else if(e instanceof Kekule.ChemStructureConnector){var s=e.getConnectedObjs();for(n=0,o=s.length;n<o;++n){var u=s[n];u instanceof Kekule.ChemStructureNode&&u.getLinkedConnectors().length<=1&&Kekule.ArrayUtils.pushUnique(t,u)}}return t},moveChildBetweenStructFragment:function(e,t,r,n,o){return Kekule.StructureFragment.moveChildBetweenStructFragment(e,t,r,n,o)},_getCascadeConnectedNodesAndConnectors:function(e,t){for(var r=[],n=[],o=e.getConnectedObjs(),i=0,a=o.length;i<a;++i){var s=o[i];if(s!==e)if(t&&(s=t.findDirectChildOfObj(s)),s instanceof Kekule.ChemStructureNode)Kekule.ArrayUtils.pushUnique(n,s);else if(s instanceof Kekule.ChemStructureConnector){Kekule.ArrayUtils.pushUnique(r,s);var u=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(s);Kekule.ArrayUtils.pushUnique(r,u.connectors),Kekule.ArrayUtils.pushUnique(n,u.nodes)}}return{connectors:r,nodes:n}},mergeStructFragments:function(e,t){if(e.length<=1)return e[0];for(var r=new(t||Kekule.Molecule),n=0,o=e.length;n<o;++n){var i=e[n].clone();Kekule.ChemStructureUtils.moveChildBetweenStructFragment(i,r,i.getNodes(),i.getConnectors())}return r},splitStructFragment:function(e){if(!e.hasCtab())return[e];var t=e.getNodes();if(t.length<=0)return[e];var r=e.getConnectors(),n=[],o=[t[0]],i=[],a=0;do{var s=o[a],u=s.getLinkedConnectors();s.getCrossConnectors&&u.concat(s.getCrossConnectors()||[]),Kekule.ArrayUtils.pushUnique(i,u);for(var l=0,c=u.length;l<c;++l){var d=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(u[l],e);Kekule.ArrayUtils.pushUnique(i,d.connectors),Kekule.ArrayUtils.pushUnique(o,d.nodes)}++a}while(a<o.length);n.push(e);var h=Kekule.ArrayUtils.exclude(t,o),p=Kekule.ArrayUtils.exclude(r,i);if(h.length>0){var C=new(e.getClass());Kekule.ChemStructureUtils.moveChildBetweenStructFragment(e,C,h,p);var f=Kekule.ChemStructureUtils.splitStructFragment(C);n=n.concat(f)}return n},getAbsCoordVectorBetweenObjs:function(e,t,r,n){var o=e.getAbsCoordOfMode(r,n),i=t.getAbsCoordOfMode(r,n);return Kekule.CoordUtils.substract(i,o)},_getRef2DCoordOfObj:function(e,t){return e.getAbsBaseCoord2D?e.getAbsBaseCoord2D(t):e.getAbsCoord2D?e.getAbsCoord2D(t):e.getCoord2D(t)},_getStandardizedLinkedObj2DRelCoords:function(t,r,n,o,i){var a=[],s=Kekule.ChemStructureUtils._getRef2DCoordOfObj(t,n),u=i?t.getLinkedObjs():t.getLinkedExposedObjs();o&&t.getAttachedMarkers&&(u=u.concat(t.getAttachedMarkers()||[])),r&&r.length&&(u=e.exclude(u,r));for(var l=0,c=u.length;l<c;++l){var d=u[l],h=Kekule.ChemStructureUtils._getRef2DCoordOfObj(d,n),p=Kekule.CoordUtils.substract(h,s);p=Kekule.CoordUtils.standardize(p),a.push(p)}return a},_calcLinkedObj2DAnglesOfObj:function(e,t,r,n,o){for(var i=[],a=Kekule.ChemStructureUtils._getStandardizedLinkedObj2DRelCoords(e,t,r,n,o),s=0,u=a.length;s<u;++s){var l=a[s];if(0!==l.x||0!==l.y){var c=Math.atan2(l.y,l.x);c<0&&(c=2*Math.PI+c),i.push(c)}}return i.sort(),i},_getMostEmptyDirectionOfExistingAngles:function(e){var t=e.length;if(0===t)return 0;if(1===t)return Kekule.GeometryUtils.standardizeAngle(Math.PI+e[0]);for(var r=0,n=0,o=0;o<t;++o){var i=e[o],a=e[(o+1)%t]-i;a<0&&(a+=2*Math.PI),a>r&&(r=a,n=o)}return e[n]+r/2},getMostEmptyDirection2DAngleOfObj:function(e,t,r,n,o,i){var a=Kekule.ChemStructureUtils._calcLinkedObj2DAnglesOfObj(e,t,r,n,o);return i&&(a=a.concat(i)).sort(),Kekule.ChemStructureUtils._getMostEmptyDirectionOfExistingAngles(a)},isSameRing:function(t,r){return t.nodes.length===r.nodes.length&&(t.connectors.length===r.connectors.length&&(!(e.exclude(t.nodes,r.nodes).length>0)&&!(e.exclude(t.connectors,r.connectors).length>0)))},isInRings:function(e,t){for(var r=0,n=t.length;r<n;++r){var o=t[r];if(e===o)return!0;if(Kekule.ChemStructureUtils.isSameRing(e,o))return!0}return!1},getImplicitHydrogenCount:function(e,t){var r=Object.extend({coValenceBondValenceSum:0,otherBondValenceSum:0,charge:0,radicalECount:0},t||{},!0),n=Kekule.ValenceUtils.getImplicitValence(e,r.charge,r.coValenceBondValenceSum),o=(n-=r.radicalECount)-r.coValenceBondValenceSum-r.otherBondValenceSum;return r.allowNegative||(o=Math.max(n-r.coValenceBondValenceSum-r.otherBondValenceSum,0)),o}},Kekule.TokenAnalyzer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.TokenAnalyzer",initialize:function(e){this.tryApplySuper("initialize"),this.setSrcText(e)},initProperties:function(){this.defineProp("srcText",{dataType:DataType.STRING,setter:function(e){var t=e||"";this.setPropStoreFieldValue("srcText",t),this.setPropStoreFieldValue("srcLength",t.length),this.setCurrPos(0)}}),this.defineProp("srcLength",{dataType:DataType.INT,setter:null,serializable:!1}),this.defineProp("currPos",{dataType:DataType.INT,serializable:!1})},getCharType:function(e){return 0},isCharTypeMatched:function(e,t){return e===t},nextCharInfo:function(){var e=this.getCurrPos();if(e>=this.getSrcLength())return null;var t=this.getSrcText().charAt(e);return this.setCurrPos(e+1),{char:t,charType:this.getCharType(t)}},nextTokenInfo:function(){var e=this.nextCharInfo();if(e){for(var t=e.char,r=e.charType,n=this.nextCharInfo();n&&this.isCharTypeMatched(n.charType,e.charType);)t+=n.char,e=n,n=this.nextCharInfo();return n&&this.setCurrPos(this.getCurrPos()-1),{token:t,tokenType:r}}return null},getAllTokenInfos:function(){for(var e=[],t=this.nextTokenInfo();t;)e.push(t),t=this.nextTokenInfo();return e}}),Kekule.ChemTextTypes={CT_ATOM_SYMBOL_LEADING:1,CT_ATOM_SYMBOL_FOLLOWING:2,CT_CHARGE_SYMBOL:3,CT_NUMBER:4,CT_BRACKET_LEADING:10,CT_BRACKET_TAILING:11,CT_SEPARATOR:20,CT_UNKNOWN:0};var t=Kekule.ChemTextTypes;Kekule.ChemTextAnalyzer=Class.create(Kekule.TokenAnalyzer,{CLASS_NAME:"Kekule.ChemTextAnalyzer",getCharType:function(e){return" "===e?t.CT_SEPARATOR:e>="0"&&e<="9"?t.CT_NUMBER:["+","-"].indexOf(e)>=0?t.CT_CHARGE_SYMBOL:["(","[","{"].indexOf(e)>=0?t.CT_BRACKET_LEADING:[")","]","}"].indexOf(e)>=0?t.CT_BRACKET_TAILING:e>="A"&&e<="Z"?t.CT_ATOM_SYMBOL_LEADING:e>="a"&&e<="z"?t.CT_ATOM_SYMBOL_FOLLOWING:t.CT_UNKNOWN},isCharTypeMatched:function(e,r){return!Kekule.ArrayUtils.intersect([t.CT_BRACKET_LEADING,t.CT_BRACKET_TAILING],[e,r]).length&&(e===r&&r!==t.CT_ATOM_SYMBOL_LEADING||r===t.CT_ATOM_SYMBOL_LEADING&&e===t.CT_ATOM_SYMBOL_FOLLOWING)}}),Kekule.FormulaUtils={FORMULA_BRACKETS:[["(",")"],["[","]"],["{","}"]],FORMULA_BRACKET_TYPE_COUNT:3,textToFormula:function(e,r,n){var o=n||null;o&&o.clear();var i=new Kekule.ChemTextAnalyzer(e);try{var a=i.getAllTokenInfos();o||(o=new Kekule.MolecularFormula(r));var s=a.length;if(s){var u,l,c=null,d=o;u={};for(var h=function(){u={}},p=function(){u&&u.obj&&d.appendSection(u.obj,u.count,u.charge)},C=0;C<s;++C){var f=a[C],g=f.tokenType,k=f.token,m=!1;if(g===t.CT_BRACKET_LEADING){p();var A=new Kekule.MolecularFormula(r);A._parentFormula=d,d=A,h(),m=!0}else if(g===t.CT_BRACKET_TAILING)p(),h(),u.obj=d,d=d._parentFormula,f.asSymbol=!0,m=!0;else if([t.CT_ATOM_SYMBOL_LEADING,t.CT_ATOM_SYMBOL_FOLLOWING].indexOf(g)>=0){u.obj&&(p(),h());var S=u.massNum;S||c&&!c.handled&&c.tokenType===t.CT_NUMBER&&(S=parseInt(c.token,10)||null);var y=""+(S||"")+k;u.obj=Kekule.ChemStructureNodeFactory.createByLabel(y),f.asSymbol=!0,m=!0}else if(g===t.CT_CHARGE_SYMBOL){if(l="+"===k?1:-1,f.asCharge=!0,c.tokenType===t.CT_NUMBER){var b;if(c.asCount)if(c.token.length>1){var O=c.token;b=O.substr(O.length-1),c.asCount&&(u.count=parseInt(O.substring(0,O.length-1),10))}else b=c.token,c.asCount&&(u.count=1);else b=c.token,c.asChargeCount=!0;l*=parseInt(b,10)}u.charge=l,m=!0}else if(g===t.CT_NUMBER){var T=parseInt(k,10);l&&c.tokenType===t.CT_CHARGE_SYMBOL&&c.asCharge?(l*=T,u.charge=l,f.asChargeCount=!0,m=!0):u.obj&&c.asSymbol?(u.count=T,f.asCount=!0,m=!0):u.obj||(u.massNum=T,m=!0)}f.handled=m,c=f}u&&u.obj&&p()}return o}finally{i.finalize()}},formulaToText:function(e,t,n){return Kekule.ObjUtils.isUnset(t)&&(t=!0),r._convFormulaToText(e,!1,t,n)},_convFormulaToText:function(e,t,n,o){var i="",a=e.getSections();if(t){var s=e.getMaxNestedLevel()%r.FORMULA_BRACKET_TYPE_COUNT,u=r.FORMULA_BRACKETS[s][0],l=r.FORMULA_BRACKETS[s][1];i+=u}for(var c=0,d=a.length;c<d;++c){var h=a[c].obj,p=e.getSectionCharge(a[c]),C=null;if(h instanceof Kekule.MolecularFormula)C=r._convFormulaToText(h,!0,!1,!1,o);else if(h.getLabel){C=h.getLabel();h.getMassNumber&&h.getMassNumber()&&(C=(i?" ":"")+C)}if(C){var f=!1;if(1!=a[c].count&&(C+=a[c].count,f=!0),n&&p)C+=(f?" ":"")+r._convChargeToText(p,o);i+=C}}(t&&(i+=l),n)&&((p=e.getCharge())&&(i+=r._convChargeToText(p,o)));return i},_convChargeToText:function(e,t){if(!e)return null;var r=e>0?"+":"-",n=Math.abs(e),o=r;return 1!=n&&(o=(t?Kekule.NumUtils.toDecimals(n,t):n.toString())+r),o}};var r=Kekule.FormulaUtils;ClassEx.defineProp(Kekule.MolecularFormula,"text",{dataType:DataType.STRING,serializable:!1,getter:function(){return r.formulaToText(this)},setter:function(e){r.textToFormula(e,this.getParent(),this)}})}(),function(){"use strict";Kekule.Glyph={},Kekule.Glyph.Base=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Glyph.Base",initialize:function(e,t,r){this.tryApplySuper("initialize",[e]),t&&this.setCoord2D(t),r&&this.setCoord3D(r)},initProperties:function(){},getAutoIdPrefix:function(){return"g"},getAllowChildCoordStickTo:function(e,t){return!1},getChildAcceptCoordStickFrom:function(e,t){return!1},getChildUseCoordStickOffset:function(e,t){return null}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.Glyph.Base)}(),function(){"use strict";Kekule.Glyph.ElectronArrowGlyphUtils={isValidChemNodeOrConnectorStickTarget:function(e){var t=e instanceof Kekule.ChemStructureNode||e instanceof Kekule.ChemStructureConnector;if(!t&&e instanceof Kekule.ChemMarker.BaseMarker){var r=e.getParent&&e.getParent();r&&(t=r instanceof Kekule.ChemStructureNode||r instanceof Kekule.ChemStructureConnector)}return t},isValidElectronTarget:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.isValidChemNodeOrConnectorStickTarget(e)},getValidElectronTarget:function(e){var t=e&&e.getCoordStickTarget&&e.getCoordStickTarget();return t&&Kekule.Glyph.ElectronArrowGlyphUtils.isValidElectronTarget(t)?t:null},setValidElectronTarget:function(e,t){e.getAllowCoordStickTo&&e.getAllowCoordStickTo(t)&&(t?Kekule.Glyph.ElectronArrowGlyphUtils.isValidElectronTarget(t)&&e.setCoordStickTarget(t):e.setCoordStickTarget(null))},getValidElectronTargetNodeOrConnector:function(e){var t=null,r=Kekule.Glyph.ElectronArrowGlyphUtils.getValidElectronTarget(e);return r&&(t=r instanceof Kekule.ChemMarker.BaseMarker?r.getParent():r),t}}}(),function(){"use strict";var e=Kekule.CoordUtils,t=Kekule.CoordMode;Kekule.Glyph.PathGlyphNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphNode",initialize:function(e,t,r,n){this.tryApplySuper("initialize",[e]),r&&this.setCoord2D(r),n&&this.setCoord3D(n),this.setNodeType(t||Kekule.Glyph.NodeType.LOCATION)},initProperties:function(){this.defineProp("nodeType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLIC}),this.defineProp("pathNodeParams",{dataType:DataType.HASH,scope:Class.PropertyScope.PUBLISHED,getter:function(){var e=this.getPropStoreFieldValue("pathNodeParams");return e||(e={},this.setPropStoreFieldValue("pathNodeParams",e)),e},setter:function(e){e?this.setPropStoreFieldValue("pathNodeParams",Object.extend({},e,!0)):this.setPropStoreFieldValue("pathNodeParams",null)}})},initPropValues:function(){this.tryApplySuper("initPropValues")},getAllowCoordStickTo:function(e){if(!e||!this.isSiblingWith(e)){var t=this.getParent();if(t&&t.getAllowChildCoordStickTo)return t.getAllowChildCoordStickTo(this,e)}return!1},getAcceptCoordStickFrom:function(e){var t=this.getParent();return!(!t||!t.getChildAcceptCoordStickFrom)&&t.getChildAcceptCoordStickFrom(this,e)},notifyCoordStickTargetChanged:function(e,t){this.tryApplySuper("notifyCoordStickTargetChanged",[e,t]);var r=this.getParent();if(Kekule.ObjUtils.isUnset(this.getPathNodeParams().useStickingOffset)&&r.getChildUseCoordStickOffset){var n=r.getChildUseCoordStickOffset(this,t);Kekule.ObjUtils.notUnset(n)&&(this.getPathNodeParams().useStickingOffset=n)}r.notifyChildCoordStickTargetChanged&&r.notifyChildCoordStickTargetChanged(this.oldTarget,t)}}),Kekule.Glyph.NodeType={LOCATION:"location",CONTROLLER:"controller",HIDDEN:"hidden"},Kekule.Glyph.PathGlyphConnectorControlNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphConnectorControlNode",initialize:function(e,t,r){this.tryApplySuper("initialize",[e]),t&&this.setCoord2D(t),r&&this.setCoord3D(r)},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setInteractMode(Kekule.ChemObjInteractMode.UNSELECTABLE)},getAutoIdPrefix:function(){return"cn"},getAcceptCoordStickFrom:function(e){return!1},getParentConnector:function(){var e=this.getParent();return e&&e instanceof Kekule.Glyph.PathGlyphConnector?e:null},isPositioned:function(e,r){return e||(e=t.COORD2D),this.doCheckIsPositioned(e,r)},doCheckIsPositioned:function(e,t){return!0},resetPosition:function(e){return e?this.doResetPosition(e):(this.doResetPosition(t.COORD2D),this.doResetPosition(t.COORD3D)),this},doResetPosition:function(e){}}),Kekule.Glyph.PathType={LINE:"L",ARC:"A"},Kekule.Glyph.ArrowType={NONE:null,OPEN:"open",TRIANGLE:"triangle"},Kekule.Glyph.ArrowSide={DEFAULT:0,BOTH:0,SINGLE:1,REVERSED:-1},Kekule.Glyph.PathGlyphConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.Glyph.PathGlyphConnector",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,r]),this.setPathType(t)},initProperties:function(){this.defineProp("pathType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,enumSource:Kekule.Glyph.PathType}),this.defineProp("pathParams",{dataType:DataType.HASH,scope:Class.PropertyScope.PUBLISHED,getter:function(){var e=this.getPropStoreFieldValue("pathParams");return e||(e={},this.setPropStoreFieldValue("pathParams",e)),e},setter:function(e){e?this.setPropStoreFieldValue("pathParams",Object.extend({},e,!0)):this.setPropStoreFieldValue("pathParams",null)}}),this.defineProp("controlPoints",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLISHED,getter:function(e){var t=this.getPropStoreFieldValue("controlPoints");return!t&&e&&(t=[],this.setPropStoreFieldValue("controlPoints",t)),t&&!t.length&&this.doFillDefaultControlPoints(t),t},setter:function(e){this.clearControlPoints(),this.setPropStoreFieldValue("controlPoints",e),this._controlPointsChanged()}})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setInteractMode(Kekule.ChemObjInteractMode.UNSELECTABLE)},_appendChildObj:function(e){var t=this.tryApplySuper("_appendChildObj",[e]);return e instanceof Kekule.Glyph.PathGlyphConnectorControlNode&&this.tryResetControlPointPosition(e),t},doPropChanged:function(e,t){return"connectedObjs"===e&&this.tryResetAllControlPointPositions(),this.tryApplySuper("doPropChanged",[e,t])},getAbsCoord2D:function(e){return this.getAbsCoordOfMode(Kekule.CoordMode.COORD2D,e)},getAbsCoord3D:function(e){return this.getAbsCoordOfMode(Kekule.CoordMode.COORD2D,e)},getAbsCoordOfMode:function(e,t){for(var r=Kekule.CoordUtils,n={x:0,y:0},o=0,i=0,a=this.getConnectedObjCount();i<a;++i){var s=this.getConnectedObjAt(i);if(s&&s.getAbsCoordOfMode){var u=s.getAbsCoordOfMode(e,t);u&&(++o,n=r.add(n,u))}}return r.divide(n,o)},getChildSubgroupNames:function(){return["controlPoint"].concat(this.tryApplySuper("getChildSubgroupNames"))},getBelongChildSubGroupName:function(e){return e instanceof Kekule.Glyph.PathGlyphArcConnectorControlNode?"controlPoint":this.tryApplySuper("getBelongChildSubGroupName",[e])},getControlPointCount:function(){var e=this.getControlPoints();return e&&e.length||0},getControlPointAt:function(e){return(this.getControlPoints()||[])[e]},indexOfControlPoint:function(e){var t=this.getControlPoints();return t?t.indexOf(e):-1},removeControlPointAt:function(e){var t=null,r=this.getControlPoints();return r&&e>=0&&e<r.length&&((t=r.splice(e,1)).setOwner&&t.setOwner(null),t.setParent&&t.setParent(null),this.notifyPropSet("controlPoints",this.getControlPoints())),t},removeControlPoint:function(e){var t=null,r=this.getControlPoints();if(r){var n=r.indexOf(e);n>=0&&(r.splice(n,1),e.setOwner&&e.setOwner(null),e.setParent&&e.setParent(null),t=e,this.notifyPropSet("controlPoints",this.getControlPoints()))}return t},insertControlPointAt:function(e,t){var r=this.getControlPoints();if(r&&t<r.length){var n=Kekule.ArrayUtils.insertUniqueEx(r,e,t);return n.isInserted&&(e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this),this.notifyPropSet("controlPoints",this.getControlPoints())),n.index}return-1},insertControlPointBefore:function(e,t){var r=this.getControlPoints();if(r){var n=t?this.indexOfControlPoint(t):-1;return n<0&&(n=r.length),this.insertControlPointAt(e,n)}return-1},tryResetControlPointPosition:function(e){if(e.isPositioned&&e.resetPosition)for(var r=[t.COORD2D,t.COORD3D],n=0,o=r.length;n<o;++n){var i=r[n];e.isPositioned(i,!0)||e.resetPosition(i)}},tryResetAllControlPointPositions:function(){for(var e=0,t=this.getControlPointCount();e<t;++e){var r=this.getControlPointAt(e);this.tryResetControlPointPosition(r)}},doFillDefaultControlPoints:function(e){},removeChildObj:function(e){return this.removeControlPoint(e)},hasChildObj:function(e){return this.hasChild(e)},getNextSiblingOfChild:function(e){var t=this.indexOfChild(e);return++t,this.getChildAt(t)},_controlPointsChanged:function(){this._updateControlPointsOwner(),this._updateControlPointsParent()},_updateControlPointsOwner:function(e){e||(e=this.getOwner());var t=this.getControlPoints();if(t)for(var r=0,n=t.length;r<n;++r){var o=t[r];o.setOwner&&o.setOwner(e)}},_updateControlPointsParent:function(e){e||(e=this);var t=this.getControlPoints();if(t)for(var r=0,n=t.length;r<n;++r){var o=t[r];o.setParent&&o.setParent(e)}},clearControlPoints:function(){var e=this.getControlPoints();if(e&&(e=Kekule.ArrayUtils.clone(e)),this.setPropStoreFieldValue("controlPoints",null),e)for(var t=0,r=e.length;t<r;++t){var n=e[t];n.setOwner&&n.setOwner(null),n.setParent&&n.setParent(null)}return this.notifyPropSet("controlPoints",null),this},modifyPathParams:function(e){if(e){var t=this.getPathParams();return t=Object.extend(t,e||{}),this.setPathParams(t),t}return null}}),Kekule.Glyph.PathGlyphArcConnectorControlNode=Class.create(Kekule.Glyph.PathGlyphConnectorControlNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphArcConnectorControlNode",initProperties:function(){this.defineProp("distanceToChord",{dataType:DataType.FLOAT})},doCheckIsPositioned:function(e,t){return this.getIndirectCoordRefCoords(e,t)&&Kekule.ObjUtils.notUnset(this.getDistanceToChord())},doResetPosition:function(r){if(r===t.COORD2D){var n=this.getIndirectCoordRefCoords(r,!0);if(n&&n[0]&&n[1]){var o=e.getDistance(n[0],n[1]);this.setDistanceToChord(.5*o),this.notifyPropSet("coord2D",this.getCoord2D())}}},doGetEnableIndirectCoord:function(){return!0},getIndirectCoordRefCoords:function(e,t){var r=this.getParentConnector();return r&&r.getConnectedObjCount()>=2?[r.getConnectedObjAt(0).getAbsCoordOfMode(t),r.getConnectedObjAt(1).getAbsCoordOfMode(t)]:this.tryApplySuper("getIndirectCoordRefCoords",[e])},calcIndirectCoordValue:function(r,n){if(r===t.COORD2D){var o=this.getDistanceToChord();if(Kekule.ObjUtils.notUnset(o)){var i=this.getIndirectCoordRefCoords();if(i){var a=i[0],s=i[1];if(a&&s){var u=e.substract(s,a),l=Math.sign(u.x),c=Math.sign(u.y);if(Kekule.NumUtils.isFloatEqual(u.x,0,1e-10))h={x:-o*c,y:0};else if(Kekule.NumUtils.isFloatEqual(u.y,0,1e-10))h={x:0,y:o*l};else{var d=-1/(u.y/u.x),h={x:-c*o/Math.sqrt(1+Math.sqr(d))};h.y=h.x*d}return h}}}}return this.tryApplySuper("calcIndirectCoordValue",[r,n])},saveIndirectCoordValue:function(r,n,o,i){if(r===t.COORD2D){var a=o,s=this.getIndirectCoordRefCoords();if(s){var u=s[0],l=s[1],c=e.substract(l,u),d=Math.atan2(c.y,c.x),h=(e.getDistance(u,l),e.substract(n,a)),p=Math.atan2(h.y,h.x),C=e.getDistance(n,a)*Math.sin(p-d),f=(this.getDistanceToChord()||0)+C;return this.setDistanceToChord(f),f}}return this.tryApplySuper("saveIndirectCoordValue",[r,n])}}),Kekule.Glyph.PathGlyphArcConnector=Class.create(Kekule.Glyph.PathGlyphConnector,{CLASS_NAME:"Kekule.Glyph.PathGlyphArcConnector",initialize:function(e,t){this.tryApplySuper("initialize",[e,Kekule.Glyph.PathType.ARC,t]);var r=this._createDefaultControlPoints();this.setControlPoints(r)},getControlPoint:function(){return(this.getControlPoints()||[])[0]},doFillDefaultControlPoints:function(e){var t=this._createDefaultControlPoints();Kekule.ArrayUtils.pushUnique(e,t)},_createDefaultControlPoints:function(){return[new Kekule.Glyph.PathGlyphArcConnectorControlNode(null,{x:0,y:0})]}}),Kekule.Glyph.PathGlyph=Class.create(Kekule.Glyph.Base,{CLASS_NAME:"Kekule.Glyph.PathGlyph",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,n,o]),this.createDefaultStructure(t||1,r||{})},doFinalize:function(){this.hasCtab()&&this.getCtab().finalize(),this.tryApplySuper("doFinalize")},initProperties:function(){this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",scope:Class.PropertyScope.PUBLIC,getter:function(e){return this.getPropStoreFieldValue("ctab")||e&&this.createCtab(),this.getPropStoreFieldValue("ctab")},setter:function(e){var t=this.getPropStoreFieldValue("ctab");t&&(t.finalize(),t=null),e&&(e.setPropValue("parent",this,!0),e.setOwner(this.getOwner())),this.setPropStoreFieldValue("ctab",e)}}),this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}}),this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}})},createDefaultStructure:function(e,t){e||(e=1);var r={},n=["startArrowLength","startArrowWidth","endArrowLength","endArrowWidth"];for(var o in t)n.indexOf(o)>=0?r[o]=t[o]*e:r[o]=t[o];return this.doCreateDefaultStructure(e,r)},doCreateDefaultStructure:function(e,t){},getAutoIdPrefix:function(){return"p"},ownerChanged:function(e,t){this.hasCtab()&&this.getCtab().setOwner(e),this.tryApplySuper("ownerChanged",[e,t])},_removeChildObj:function(e){if(this.hasCtab()){var t=this.getCtab();t===e?this.removeCtab():t.hasChildObj(e)&&t.removeChildObj(e)}this.tryApplySuper("_removeChildObj",[e])},isEmpty:function(){return this.getCtab().isEmpty()},createCtab:function(){var e=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setPropStoreFieldValue("ctab",e),e.addEventListener("propValueSet",function(e){"nodes"==e.propName&&this.notifyPropSet(e.propName,e.propValue)},this),e.setEnablePropValueSetEvent(!0)},hasCtab:function(){return!!this.getPropStoreFieldValue("ctab")},getContainerBox:function(e,t){return this.hasCtab()?this.getCtab().getContainerBox(e,t):this.tryApplySuper("getContainerBox",[e])},getNodeById:function(e){return this.hasCtab()?this.getCtab().getNodeById(e):null},getConnectorById:function(e){return this.hasCtab()?this.getCtab().getConnectorById(e):null},getObjectById:function(e){var t=this.getNodeById(e);return t||this.getConnectorById(e)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(e){return this.hasCtab()?this.getCtab().getNodeAt(e):null},indexOfNode:function(e){return this.hasCtab()?this.getCtab().indexOfNode(e):-1},hasNode:function(e,t){return this.hasCtab()?this.getCtab().hasNode(e,t):null},appendNode:function(e){return this.doGetCtab(!0).appendNode(e)},insertNodeAt:function(e,t){return this.doGetCtab(!0).insertNodeAt(e,t)},insertNodeBefore:function(e,t){var r=t?this.indexOfNode(t):-1;return r<0?this.appendNode(e):this.doGetCtab(!0).insertNodeAt(e,r)},removeNodeAt:function(e,t){return this.hasCtab()?this.getCtab().removeNodeAt(e,t):null},removeNode:function(e,t){return this.hasCtab()?this.getCtab().removeNode(e,t):null},replaceNode:function(e,t){return this.hasCtab()?this.getCtab().replaceNode(e,t):null},clearNodes:function(){if(this.hasCtab())return this.getCtab().clearNodes()},nodesHasCoord2D:function(e){return!!this.hasCtab()&&this.getCtab().nodesHasCoord2D(e)},nodesHasCoord3D:function(e){return!!this.hasCtab()&&this.getCtab().nodesHasCoord3D(e)},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(e){return this.hasCtab()?this.getCtab().getConnectorAt(e):null},indexOfConnector:function(e){return this.hasCtab()?this.getCtab().indexOfConnector(e):-1},hasConnector:function(e,t){return this.hasCtab()?this.getCtab().hasConnector(e,t):null},appendConnector:function(e){return this.doGetCtab(!0).appendConnector(e)},insertConnectorAt:function(e,t){return this.doGetCtab(!0).insertConnectorAt(e,t)},insertConnectorBefore:function(e,t){var r=t?this.indexOfConnector(t):-1;return r<0?this.appendConnector(e):this.doGetCtab(!0).insertConnectorAt(e,r)},removeConnectorAt:function(e,t){return this.hasCtab()?this.getCtab().removeConnectorAt(e,t):null},removeConnector:function(e,t){return this.hasCtab()?this.getCtab().removeConnector(e,t):null},clearConnectors:function(){if(this.hasCtab())return this.getCtab().clearConnectors()},_getObjsNeedToBeCascadeRemoved:function(e,t){return this.hasCtab()?this.getCtab()._getObjsNeedToBeCascadeRemoved(e,t):[]},getChildSubgroupNames:function(){return["node","connector"].concat(this.tryApplySuper("getChildSubgroupNames"))},getBelongChildSubGroupName:function(e){return e instanceof Kekule.Glyph.PathGlyphNode?"node":e instanceof Kekule.Glyph.PathGlyphConnector?"connector":this.tryApplySuper("getBelongChildSubGroupName",[e])},removeChildObj:function(e,t,r){this.hasCtab()&&this.getCtab().removeChildObj(e,t,r)},hasChildObj:function(e){return!!this.hasCtab()&&this.getCtab().hasChildObj(e)},getNextSiblingOfChild:function(e){return this.hasCtab()?this.getCtab().getNextSiblingOfChild(e):null},getDirectManipulationTarget:function(){return null}})}(),function(){"use strict";var e=Kekule.ObjUtils,t=(Kekule.Glyph.NodeType,Kekule.Glyph.PathType),r=Kekule.CoordUtils,n=Kekule.CoordMode;Kekule.Glyph.StraightLine=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.StraightLine",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,t,r,n,o])},doCreateDefaultStructure:function(e,r){var n=Kekule.CoordUtils,o={x:0,y:0},i={x:0,y:0,z:0},a={x:e*(r.lineLength||1)},s=new Kekule.Glyph.PathGlyphNode(null,null,o,i),u=new Kekule.Glyph.PathGlyphNode(null,null,n.add(o,a),n.add(i,a)),l=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[s,u]);this._applyParamsToConnector(l,r),this.appendNode(s),this.appendNode(u),this.appendConnector(l)},_applyParamsToConnector:function(e,t){var r=Object.create(t);Kekule.ObjUtils.isUnset(t.autoOffset)&&(r.autoOffset=!1),e.setPathParams(r)},getDirectManipulationTarget:function(){return this.getNodeAt(this.getNodeCount()-1)}}),Kekule.Glyph.Polygon=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.Polygon",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,t,r,n,o])},getRefLengthRatio:function(){return 1},doCreateDefaultStructure:function(e,r){for(var n,o,i=Kekule.CoordUtils,a={x:0,y:0},s={x:0,y:0,z:0},u=r.nodeProps,l=r.connectorProps,c=e*(r.lineLength||1)*this.getRefLengthRatio(),d=r.edgeCount||3,h=2*Math.PI/d,p=d%2?0:-h/2,C=0;C<d;++C){var f={x:c*Math.sin(p),y:c*Math.cos(p)},g=new Kekule.Glyph.PathGlyphNode(null,null,i.add(a,f),i.add(s,f));if(u&&g.setPropValues(u),this.appendNode(g),0===C&&(n=g),o){var k=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[o,g]);l&&k.setPropValues(l),this._applyParamsToConnector(k,r),this.appendConnector(k)}o=g,p+=h}k=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[g,n]);l&&k.setPropValues(l),this._applyParamsToConnector(k,r),this.appendConnector(k)},_applyParamsToConnector:function(e,t){e.setPathParams(t)}}),Kekule.Glyph.BaseArc=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.BaseArc",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,t,r,n,o])},doCreateDefaultStructure:function(e,t){var r=Kekule.CoordUtils,n={x:0,y:0},o={x:0,y:0,z:0},i={x:e*(t.lineLength||1)},a=new Kekule.Glyph.PathGlyphNode(null,null,n,o),s=new Kekule.Glyph.PathGlyphNode(null,null,r.add(n,i),r.add(o,i));this.appendNode(a),this.appendNode(s);var u=new Kekule.Glyph.PathGlyphArcConnector(null,[a,s]);this._applyParamsToConnector(u,t),this.appendConnector(u),u.setInteractMode(Kekule.ChemObjInteractMode.HIDDEN)},getDirectManipulationTarget:function(){return this.getNodeAt(this.getNodeCount()-1)},_isValidChemNodeOrConnectorStickTarget:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.isValidChemNodeOrConnectorStickTarget(e)},_applyParamsToConnector:function(e,t){e.setPathParams(t)},getAllowChildCoordStickTo:function(e,t){return!t||this._isValidChemNodeOrConnectorStickTarget(t,e)&&!this._isChildrenStickingTo(t,[e])},getChildUseCoordStickOffset:function(e,t){return t instanceof Kekule.ChemStructureNode||t instanceof Kekule.ChemStructureConnector},_isChildrenStickingTo:function(e,t){for(var r=this.getNodes(),n=0,o=(r=Kekule.ArrayUtils.exclude(r,t||[])).length;n<o;++n){if(r[n].getCoordStickTarget()===e)return!0}return!1}}),Kekule.Glyph.BaseTwinArc=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.BaseTwinArc",DEF_MIN_PATH_END_DISTANCE_RATIO:.05,DEF_INIT_PATH_END_GAP_RATIO:.2,FIELD_ARC_END_NODE_FLAG:"__$arcEndNode$__",initialize:function(e,t,r,n,o){this.setPropStoreFieldValue("minPathEndDistanceRatio",this.DEF_MIN_PATH_END_DISTANCE_RATIO),this.tryApplySuper("initialize",[e,t,r,n,o])},initProperties:function(){this.defineProp("minPathEndDistanceRatio",{dataType:DataType.FLOAT}),this.defineProp("oppositePathEndArrowSides",{dataType:DataType.BOOL,serializable:!1,getter:function(){return this._isPathArrowSideOpposite("end")},setter:function(e){this._setPathArrowSideOpposite("end",!!e)}}),this.defineProp("oppositePathStartArrowSides",{dataType:DataType.BOOL,serializable:!1,getter:function(){return this._isPathArrowSideOpposite("start")},setter:function(e){this._setPathArrowSideOpposite("start",!!e)}})},loaded:function(e){var t=this.tryApplySuper("loaded",[e]);return this._isTwinArcSetup()&&(this._setupArcEndNode(this.getNodeAt(1)),this._setupArcEndNode(this.getNodeAt(2))),t},_isPathArrowSideOpposite:function(t){var r=this.getConnectorCount();if(r<2)return null;for(var n,o=null,i=0;i<r;++i){var a=this.getConnectorAt(i).getPathParams();if(a[t+"ArrowType"]===Kekule.Glyph.ArrowType.NONE)return null;var s=a[t+"ArrowSide"];if(s===Kekule.Glyph.ArrowSide.BOTH)return null;if(0===i)n=s;else{var u=n!==s;if(e.isUnset(o))o=u;else if(o!==u)return null;n=s}}return o},_setPathArrowSideOpposite:function(t,r){var n=this.getConnectorCount();if(n<2)return null;for(var o,i=Kekule.Glyph.ArrowSide,a=!0,s=0;s<n;++s){var u=this.getConnectorAt(s).getPathParams();u[t+"ArrowType"]===Kekule.Glyph.ArrowType.NONE&&(a=!1);var l,c=u[t+"ArrowSide"];if(c===Kekule.Glyph.ArrowSide.BOTH&&(a=!1),a)if(e.isUnset(o))o=c;else l=r?o===i.SINGLE?i.REVERSED:i.SINGLE:o,u[t+"ArrowSide"]=l,o=l;else o=null}return null},_isTwinArcSetup:function(){return 2===this.getConnectorCount()&&4===this.getNodeCount()},getDirectManipulationTarget:function(){return this.getNodeAt(this.getNodeCount()-1)},doCreateDefaultStructure:function(e,t){var n=Kekule.CoordUtils,o={x:0,y:0},i={x:0,y:0,z:0},a=t.lineLength||1,s=t.minPathEndDistanceRatio||this.getMinPathEndDistanceRatio()||this.DEF_MIN_PATH_END_DISTANCE_RATIO,u=a*s;this.setMinPathEndDistanceRatio(s);var l=t.pathEndGap||a*this.DEF_INIT_PATH_END_GAP_RATIO,c={x:e*((a-(l=Math.max(l,u)))/2)},d={x:e*l},h={x:e*a},p=new Kekule.Glyph.PathGlyphNode(null,null,o,i),C=new Kekule.Glyph.PathGlyphNode(null,null);this._setupArcEndNode(C);var f=new Kekule.Glyph.PathGlyphNode(null,null),g=new Kekule.Glyph.PathGlyphNode(null,null,n.add(o,h),n.add(i,h));this._setupArcEndNode(f),this.appendNode(p),this.appendNode(C),this.appendNode(f),this.appendNode(g),C.setCoord2D(n.add(o,c)).setCoord3D(n.add(i,c)),f.setCoord2D(n.add(o,r.add(c,d))).setCoord3D(n.add(i,r.add(c,d)));var k=new Kekule.Glyph.PathGlyphArcConnector(null,[p,C]),m=new Kekule.Glyph.PathGlyphArcConnector(null,[g,f]);this._applyParamsToConnector(k,t),this._applyParamsToConnector(m,t),m.getControlPointAt(0).setDistanceToChord(-m.getControlPointAt(0).getDistanceToChord()),this.appendConnector(k),this.appendConnector(m),k.setInteractMode(Kekule.ChemObjInteractMode.HIDDEN),m.setInteractMode(Kekule.ChemObjInteractMode.HIDDEN)},_applyParamsToConnector:function(e,t){e.setPathParams(t)},_setupArcEndNode:function(e){e[this.FIELD_ARC_END_NODE_FLAG]||(this._overwriteChildPathNodeMethods(e),e.setEnableIndirectCoord(!0),e[this.FIELD_ARC_END_NODE_FLAG]=!0)},_overwriteChildPathNodeMethods:function(e){e.overwriteMethod("getIndirectCoordRefLengths",this._insideNodeGetIndirectCoordRefLengths).overwriteMethod("getIndirectCoordRefCoords",this._insideNodeGetIndirectCoordRefCoords).overwriteMethod("calcIndirectCoordStorage",this._insideNodeCalcIndirectCoordStorage).overwriteMethod("calcIndirectCoordValue",this._insideNodeCalcIndirectCoordValue).overwriteMethod("_childPathNodeGetParentGlyph",this._childPathNodeGetParentGlyph).overwriteMethod("_childPathNodeGetGlyphMinPathEndDistanceRatio",this._childPathNodeGetGlyphMinPathEndDistanceRatio)},_getArrowStartingNodes:function(){var e=[];if(this._isTwinArcSetup())for(var t=0,r=this.getConnectorCount();t<r;++t){var n=this.getConnectorAt(t).getConnectedObjAt(0);n&&e.push(n)}return e},_childPathNodeGetParentGlyph:function(e){var t=this.getParent();return t instanceof Kekule.Glyph.BaseTwinArc?t:null},_childPathNodeGetGlyphMinPathEndDistanceRatio:function(e){var t=this._childPathNodeGetParentGlyph();return t&&t.getMinPathEndDistanceRatio()},_insideNodeGetIndirectCoordRefLengths:function(e,t,r){var n=this.getParent();if(!n||t!==Kekule.CoordMode.COORD2D)return e(t,r);var o=n.getNodeAt(0),i=n.getNodeAt(n.getNodeCount()-1);if(o&&i){var a=o.getAbsCoordOfMode(t),s=i.getAbsCoordOfMode(t),u=Kekule.CoordUtils.getDistance(s,a);return{x:u,y:u,length:u}}},_insideNodeGetIndirectCoordRefCoords:function(e,t,r){var o=this.getParent();if(!o||t!==n.COORD2D)return e(t,r);var i=o.getNodeAt(0),a=o.getNodeAt(o.getNodeCount()-1);return i&&a?[i.getCoordOfMode(t),a.getCoordOfMode(t)]:void 0},_insideNodeCalcIndirectCoordStorage:function(e,t,o,i,a){var s=this.getParent();if(s&&t===n.COORD2D){var u=this.getIndirectCoordRefCoords(t,a);if(u){var l=s.getNodeAt(0).getCoordOfMode(t),c=Kekule.GeometryUtils.getPerpendicularCrossPointFromCoordToLine(o,u[0],u[1],!1);if(!c)c=r.getDistance(o,u[0])<r.getDistance(o,u[1])?u[0]:u[1];var d=r.getDistance(l,c),h=r.getDistance(u[1],u[0]),p=h?d/h:0,C=this._childPathNodeGetGlyphMinPathEndDistanceRatio()||0;return p<C?p=C:p>1-C&&(p=1-C),{x:p,y:p,ratio:p}}}return e(t,o,i,a)},_insideNodeCalcIndirectCoordValue:function(e,t,o){var i=this.getParent();if(i&&t===n.COORD2D){var a=this.getIndirectCoordRefCoords(t,o);if(a){var s=r.substract(a[1],a[0]),u=i.getNodeAt(0).getCoordOfMode(t),l=this.getIndirectCoordStorageOfMode(t).ratio;if(Kekule.ObjUtils.notUnset(l)){var c=r.multiply(s,l);return r.add(u,c)}}}return e(t,o)},_isValidChemNodeOrConnectorStickTarget:function(e){var t=e instanceof Kekule.ChemStructureNode||e instanceof Kekule.ChemStructureConnector;if(!t&&e instanceof Kekule.ChemMarker.BaseMarker){var r=e.getParent&&e.getParent();r&&(t=r instanceof Kekule.ChemStructureNode||r instanceof Kekule.ChemStructureConnector)}return t},getAllowChildCoordStickTo:function(e,t){var r=this.indexOfNode(e);return(0===r||r===this.getNodeCount()-1)&&(!t||this._isValidChemNodeOrConnectorStickTarget(t,e)&&!this._isChildrenStickingTo(t,[e]))},getChildUseCoordStickOffset:function(e,t){return t instanceof Kekule.ChemStructureNode||t instanceof Kekule.ChemStructureConnector},_isChildrenStickingTo:function(e,t){for(var r=this._getArrowStartingNodes(),n=0,o=(r=Kekule.ArrayUtils.exclude(r,t||[])).length;n<o;++n){if(r[n].getCoordStickTarget()===e)return!0}return!1}}),Kekule.Glyph.Arc=Class.create(Kekule.Glyph.BaseArc,{CLASS_NAME:"Kekule.Glyph.Arc"}),Kekule.Glyph.TwinArc=Class.create(Kekule.Glyph.BaseTwinArc,{CLASS_NAME:"Kekule.Glyph.TwinArc"})}(),function(){"use strict";var e=Kekule.ObjUtils,t=(Kekule.Glyph.NodeType,Kekule.Glyph.PathType),r=Kekule.Glyph.ElectronArrowGlyphUtils;Kekule.Glyph.HeatSymbol=Class.create(Kekule.Glyph.Polygon,{CLASS_NAME:"Kekule.Glyph.HeatSymbol",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,t,r,n,o]),this.setRenderOption&&this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return.25},doCreateDefaultStructure:function(e,t){return t.edgeCount=3,t.nodeProps=Object.extend(t.nodeProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN}),t.connectorProps=Object.extend(t.connectorProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN}),this.tryApplySuper("doCreateDefaultStructure",[e,t])},_applyParamsToConnector:function(e,t){return this.tryApplySuper("_applyParamsToConnector",[e,t])}}),Kekule.Glyph.AddSymbol=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.AddSymbol",initialize:function(e,t,r,n,o){this.tryApplySuper("initialize",[e,t,r,n,o]),this.setRenderOption&&this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return.5},doCreateDefaultStructure:function(e,r){var n={interactMode:Kekule.ChemObjInteractMode.HIDDEN},o={interactMode:Kekule.ChemObjInteractMode.HIDDEN},i=Kekule.CoordUtils,a={x:0,y:0},s={x:0,y:0,z:0},u=e*this.getRefLengthRatio()*(r.lineLength||1)/2,l=new Kekule.Glyph.PathGlyphNode(null,null,a,s);l.setPropValues(n),this.appendNode(l);for(var c=[{x:-u,y:0},{x:0,y:-u},{x:u,y:0},{x:0,y:u}],d=0,h=c.length;d<h;++d){var p=c[d],C=new Kekule.Glyph.PathGlyphNode(null,null,i.add(a,p),i.add(s,p));C.setPropValues(n);var f=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[l,C]);f.setPropValues(o),this._applyParamsToConnector(f,r),this.appendNode(C),this.appendConnector(f)}},_applyParamsToConnector:function(e,t){e.setPathParams(t)}}),Kekule.Glyph.Segment=Class.create(Kekule.Glyph.StraightLine,{CLASS_NAME:"Kekule.Glyph.Segment"}),Kekule.Glyph.ReactionArrowType={NORMAL:"normal",REVERSIBLE:"reversible",RESONANCE:"resonance",RETROSYNTHESIS:"retrosynthesis",CUSTOM:"custom"},Kekule.Glyph.ReactionArrowType.getDefPathParamOfArrowType=function(e){var t,r=Kekule.Glyph.ReactionArrowType,n=Kekule.Glyph.ArrowType,o=Kekule.Glyph.ArrowSide;switch(e){case r.NORMAL:t={startArrowType:n.NONE,endArrowType:n.OPEN,endArrowSide:o.BOTH,lineCount:1};break;case r.REVERSIBLE:t={startArrowType:n.OPEN,startArrowSide:o.REVERSED,endArrowType:n.OPEN,endArrowSide:o.SINGLE,lineGap:.1,lineCount:2};break;case r.RESONANCE:t={startArrowType:n.OPEN,startArrowSide:o.BOTH,endArrowType:n.OPEN,endArrowSide:o.BOTH,lineCount:1};break;case r.RETROSYNTHESIS:t={startArrowType:n.NONE,endArrowType:n.OPEN,endArrowSide:o.BOTH,lineGap:.1,lineCount:2};break;default:t=null}return t},Kekule.Glyph.ReactionArrow=Class.create(Kekule.Glyph.StraightLine,{CLASS_NAME:"Kekule.Glyph.ReactionArrow",initProperties:function(){this.defineProp("reactionType",{dataType:DataType.STRING,enumSource:Kekule.Glyph.ReactionArrowType,setter:function(e){this.setPropStoreFieldValue("reactionType",e),this.reactionTypeChanged(e)}})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setReactionType(Kekule.Glyph.ReactionArrowType.NORMAL)},doCreateDefaultStructure:function(e,t){var r=t,n=t.reactionType||this.getReactionType();if(n){var o=this._getPathParamOfArrowType(n);r=Object.extend(o,t)}var i=this.tryApplySuper("doCreateDefaultStructure",[e,r]);return n&&this.setReactionType(n),i},reactionTypeChanged:function(e){var t=this._getPathParamOfArrowType(e);if(t){var r=this.getConnectorAt(0);r&&r.modifyPathParams(t)}},_getPathParamOfArrowType:function(e){return Kekule.Glyph.ReactionArrowType.getDefPathParamOfArrowType(e)}}),Kekule.Glyph.ElectronPushingArrow=Class.create(Kekule.Glyph.BaseArc,{CLASS_NAME:"Kekule.Glyph.ElectronPushingArrow",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.INT,getter:function(){var e=this._getValidArrowSide(),t=Kekule.Glyph.ArrowSide;return e===t.BOTH?2:[t.SINGLE,t.REVERSED].indexOf(e)>=0?1:null},setter:function(e){var t=Kekule.Glyph.ArrowSide,r=this._getValidArrowPos(),n=this.getConnectorAt(0);r||(n.getPathParams().endArrowType=Kekule.Glyph.ArrowType.OPEN,r="end");var o=n.getPathParams();e>=2?o[r+"ArrowSide"]=t.BOTH:1===e&&(o[r+"ArrowSide"]=t.SINGLE),n.setPathParams(o)}}),this.defineProp("directReceptor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(1);return this._getValidElectronTarget(e)},setter:function(e){var t=this.getNodeAt(1);this._setValidElectronTarget(t,e)}}),this.defineProp("directDonor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(0);return this._getValidElectronTarget(e)},setter:function(e){var t=this.getNodeAt(0);this._setValidElectronTarget(t,e)}}),this.defineProp("receptor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(1);return this._getValidElectronTargetNodeOrConnector(e)},setter:function(e){var t=this.getNodeAt(1);this._setValidElectronTarget(t,e)}}),this.defineProp("donor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(0);return this._getValidElectronTargetNodeOrConnector(e)},setter:function(e){var t=this.getNodeAt(0);this._setValidElectronTarget(t,e)}})},doCreateDefaultStructure:function(e,t){var r=this.tryApplySuper("doCreateDefaultStructure",[e,t]);return t.electronCount&&this.setElectronCount(t.electronCount),r},_isValidElectronTarget:function(e){return this._isValidChemNodeOrConnectorStickTarget(e)},_getValidElectronTarget:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.getValidElectronTarget(e)},_setValidElectronTarget:function(e,t){return Kekule.Glyph.ElectronArrowGlyphUtils.setValidElectronTarget(e,t),this},_getValidElectronTargetNodeOrConnector:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.getValidElectronTargetNodeOrConnector(e)},_getValidArrowPos:function(){var e=this.getConnectorAt(0),t=e&&e.getPathParams();if(t){if(t.endArrowType)return"end";if(t.startArrowType)return"start"}return null},_getValidArrowSide:function(){var e=this.getConnectorAt(0),t=e&&e.getPathParams();if(t){if(t.endArrowType)return t.endArrowSide||Kekule.Glyph.ArrowSide.DEFAULT;if(t.startArrowType)return t.startArrowSide||Kekule.Glyph.ArrowSide.DEFAULT}return null},_applyParamsToConnector:function(e,t){var r=Object.create(t);Kekule.ObjUtils.isUnset(t.autoOffset)&&(r.autoOffset=!0),e.setPathParams(r)}}),Kekule.Glyph.BondFormingElectronPushingArrow=Class.create(Kekule.Glyph.BaseTwinArc,{CLASS_NAME:"Kekule.Glyph.BondFormingElectronPushingArrow",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.INT,getter:function(){for(var t=null,r=0,n=this.getConnectorCount();r<n;++r){var o=this._getConnectorElectronCount(this.getConnectorAt(r));if(e.notUnset(o))if(e.isUnset(t))t=o;else if(t!==o)return null}return t*this.getConnectorCount()},setter:function(e){if(e!==this.getElectronCount()){var t=this.getConnectorCount()?e/this.getConnectorCount():e;(t=Math.round(t))<=0&&(t=1);for(var r=Kekule.Glyph.ArrowSide,n=this.getConnectors(),o=0,i=n.length;o<i;++o){var a=n[o];a.getPathParams().endArrowType=Kekule.Glyph.ArrowType.OPEN,"end";var s=a.getPathParams();t>=2?s.endArrowSide=r.BOTH:1===t&&(s.endArrowSide=o%2?r.SINGLE:r.REVERSED),a.setPathParams(s)}}}}),this.defineProp("directDonors",{dataType:DataType.ARRAY,getter:function(){for(var e=this._getArrowStartingNodes(),t=[],n=0,o=e.length;n<o;++n){var i=r.getValidElectronTarget(e[n]);i&&t.push(i)}return t},setter:function(e){var t=this._getArrowStartingNodes();if(t.length)for(var n=0,o=t.length;n<o;++n){var i=t[n];e[n];r.setValidElectronTarget(i,e)}}}),this.defineProp("donors",{dataType:DataType.ARRAY,getter:function(){for(var e=this._getArrowStartingNodes(),t=[],n=0,o=e.length;n<o;++n){var i=r.getValidElectronTargetNodeOrConnector(e[n]);i&&t.push(i)}return t},setter:function(e){this.setDirectDonors(e)}})},_getConnectorElectronCount:function(e){var t=e&&e.getPathParams();if(t){var r=Kekule.Glyph.ArrowSide,n=t.endArrowType?t.endArrowSide||Kekule.Glyph.ArrowSide.DEFAULT:null;if(n===r.BOTH)return 2;if([r.SINGLE,r.REVERSED].indexOf(n)>=0)return 1}return null},doCreateDefaultStructure:function(e,t){var r=this.tryApplySuper("doCreateDefaultStructure",[e,t]);return this.setElectronCount(t.electronCount||1),r}})}(),function(){"use strict";Kekule.CoordMode,Kekule.CoordUtils;Kekule.ContentBlock=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ContentBlock",initialize:function(e,t,r){this.tryApplySuper("initialize",[e]),t&&this.setCoord2D(t),r&&this.setCoord3D(r)},initProperties:function(){this.defineProp("needRecalcSize",{dataType:DataType.BOOL})},getAutoIdPrefix:function(){return"b"},getCornerCoord1:function(e,t){return this.getCoordOfMode(e,t)},getCornerCoord2:function(e,t){var r=this.getCornerCoord1(e,t),n=this.getSizeOfMode(e,t);return Kekule.CoordUtils.add(r,n)}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ContentBlock),Kekule.ClassDefineUtils.addStandardSizeSupport(Kekule.ContentBlock),Kekule.TextBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.TextBlock",initialize:function(e,t,r,n){this.tryApplySuper("initialize",[e,r,n]),this.setText(t||"")},initProperties:function(){this.defineProp("text",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"t"},doObjectChange:function(e){Kekule.ArrayUtils.intersect(["text","renderOptions"],e).length&&this.setNeedRecalcSize(!0)}}),Kekule.ImageBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.ImageBlock",initialize:function(e,t,r,n){this.tryApplySuper("initialize",[e,r,n]),t&&this.setSrc(t)},initProperties:function(){this.defineProp("src",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,setter:function(e){e!==this.getSrc()&&(this.setPropStoreFieldValue("src",e),this._clearCacheImg())}}),this.defineProp("cacheImg",{dataType:DataType.OBJECT,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){var e=this.getPropStoreFieldValue("cacheImg");return!e&&Kekule.$document&&(e=this._createCacheImg(this.getSrc())),e}})},getAutoIdPrefix:function(){return"g"},_createCacheImg:function(e){var t,r=Kekule.$document;return r&&r.body&&r.createElement&&((t=r.createElement("img")).src=e),t},_clearCacheImg:function(){var e=this.getPropStoreFieldValue("cacheImg");if(e){e.src="";try{delete e.width,delete e.height}catch(e){}}}})}(),function(){"use strict";var e=Kekule.ArrayUtils;Kekule.ChemMarker={},ClassEx.extend(Kekule.ChemObject,{isAttachedMarker:function(){var e=this.getParent();return e&&e.hasMarker(this)},notifyAttachedMarkersChanged:function(){this.notifyPropSet("attachedMarkers",this.getPropStoreFieldValue("attachedMarkers"))},_attachedMarkerAdded:function(e){},_attachedMarkerRemoved:function(e){},getMarkerCount:function(){var e=this.getPropStoreFieldValue("attachedMarkers");return e?e.length:0},getMarkerAt:function(e){var t=this.getPropStoreFieldValue("attachedMarkers");return t?t[e]:null},getMarkerOfType:function(e,t){for(var r=0,n=this.getMarkerCount();r<n;++r){var o=this.getMarkerAt(r);if(t&&o.getClass()===e||o instanceof e)return o}return null},getMarkersOfType:function(e,t){for(var r=[],n=0,o=this.getMarkerCount();n<o;++n){var i=this.getMarkerAt(n);(t&&i.getClass()===e||i instanceof e)&&r.push(i)}return r},fetchMarkerOfType:function(e,t,r,n){var o=this.getMarkerOfType(e,r);if(!o&&t){(o=new e).beginUpdate();try{n&&o.setPropValues(n),this.appendMarker(o)}finally{o.endUpdate()}}return o},getUnplacedMarkers:function(e){for(var t=[],r=0,n=this.getMarkerCount();r<n;++r){var o=this.getMarkerAt(r);o.getCoordOfMode(e)||t.push(o)}return t},indexOfMarker:function(e){var t=this.getPropStoreFieldValue("attachedMarkers");return t?t.indexOf(e):-1},hasMarker:function(e){return this.indexOfMarker(e)>=0},hasMarkerOfType:function(e,t){return!!this.getMarkerOfType(e,t)},appendMarker:function(e){var t=this.indexOfMarker(e);if(t>=0)return t;var r=this.getAttachedMarkers(!0).push(e);e.beginUpdate();try{e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this),this._attachedMarkerAdded(e)}finally{e.endUpdate()}return this.notifyAttachedMarkersChanged(),r},insertMarkerBefore:function(e,t){var r=this.indexOfMarker(t);return this.insertMarkerAt(e,r)},insertMarkerAt:function(t,r){this.indexOfMarker(t);var n=this.getAttachedMarkers(!0);(Kekule.ObjUtils.isUnset(r)||r<0)&&(r=n.length);var o=e.insertUniqueEx(n,t,r);return o.isInserted&&(t.setOwner&&t.setOwner(this.getOwner()),t.setParent&&t.setParent(this),this._attachedMarkerAdded(t)),this.notifyAttachedMarkersChanged(),o.index},setMarkerIndex:function(e,t){var r=this.indexOfMarker(e);if(r>=0){var n=this.getPropStoreFieldValue("attachedMarkers");n.splice(r,1),n.splice(t,0,e)}},removeMarkerAt:function(e){var t=this.getMarkerAt(e);if(t){var r=this.getAttachedMarkers(!0).splice(e,1);return t.setOwner&&t.setOwner(null),t.setParent&&t.setParent(null),this._attachedMarkerRemoved(t),this.notifyAttachedMarkersChanged(),r}},removeMarker:function(e){var t=this.indexOfMarker(e);if(t>=0)return this.removeMarkerAt(t)},replaceMarker:function(e,t){var r=this.indexOfMarker(e);return r<0?this:(this.removeMarkerAt(r),this.insertMarkerAt(t,r),this)},clearMarkers:function(){var t=this.getPropStoreFieldValue("attachedMarkers");if(t&&(t=e.clone(t)),this.setPropStoreFieldValue("attachedMarkers",null),t)for(var r=0,n=t.length;r<n;++r){var o=t[r];o.setOwner&&o.setOwner(null),o.setParent&&o.setParent(null),this._attachedMarkerRemoved(o)}return this.notifyAttachedMarkersChanged(),this},autoSetMarker2DPos:function(e,t,r,n){if(this.hasMarker(e)){var o=Kekule.ChemStructureUtils.getMostEmptyDirection2DAngleOfObj(this,[e],r,!0,!1,n),i={x:t*Math.cos(o),y:t*Math.sin(o)};e.setCoord2D(i)}},_updateAttachedMarkersOwner:function(e){e||(e=this.getOwner());for(var t=0,r=this.getMarkerCount();t<r;++t){var n=this.getMarkerAt(t);n.setOwner&&n.setOwner(e)}},_updateAttachedMarkersParent:function(e){e||(e=this);for(var t=0,r=this.getMarkerCount();t<r;++t){var n=this.getMarkerAt(t);n.setParent&&n.setParent(e)}}}),ClassEx.extendMethod(Kekule.ChemObject,"ownerChanged",function($origin,e){$origin(e),this._updateAttachedMarkersOwner(e)}),ClassEx.extendMethod(Kekule.ChemObject,"removeChild",function($origin,e){var t=$origin(e);return t||(t=this.removeMarker(e)),t}),ClassEx.extendMethod(Kekule.ChemObject,"insertBefore",function($origin,e,t){var r=$origin(e,t);return r<0&&(t&&this.hasMarker(t)||e instanceof Kekule.ChemMarker.BaseMarker)&&(r=this.insertMarkerBefore(e,t)),r}),ClassEx.extendMethod(Kekule.ChemObject,"getChildSubgroupNames",function($origin){return $origin().concat("marker")}),ClassEx.defineProp(Kekule.ChemObject,"attachedMarkers",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLISHED,getter:function(e){var t=this.getPropStoreFieldValue("attachedMarkers");return!t&&e&&(t=[],this.setPropStoreFieldValue("attachedMarkers",t)),t},setter:function(e){this.clearMarkers(),this.setPropStoreFieldValue("attachedMarkers",e),this._updateAttachedMarkersOwner(),this._updateAttachedMarkersParent()}})}(),function(){"use strict";Kekule.ChemMarker.BaseMarker=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemMarker.BaseMarker",initialize:function(e,t,r){this.tryApplySuper("initialize",[e,t,r])},getAutoIdPrefix:function(){return"marker"},getAcceptCoordStickFrom:function(e){return!(this.isSiblingWith(e)||e instanceof Kekule.ChemStructureNode||e instanceof Kekule.BaseStructureConnector)}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ChemMarker.BaseMarker),Kekule.ChemMarker.UnbondedElectronSet=Class.create(Kekule.ChemMarker.BaseMarker,{CLASS_NAME:"Kekule.ChemMarker.UnbondedElectronSet",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.VARIANT})},initPropValues:function(){this.tryApplySuper("initPropValues"),this.setElectronCount(2)},getAutoIdPrefix:function(){return"electron"}}),Kekule.ChemMarker.ChemPropertyMarker=Class.create(Kekule.ChemMarker.BaseMarker,{CLASS_NAME:"Kekule.ChemMarker.ChemPropertyMarker",initProperties:function(){this.defineProp("value",{dataType:DataType.VARIANT,serializable:!1,getter:function(){var e,t=this.getParent(),r=this.getPropertyName();return t&&r?(e=t.getPropValue(r),this.setPropStoreFieldValue("value",e)):e=this.getPropStoreFieldValue("value"),e},setter:function(e){this.setPropStoreFieldValue("value",e),this.setParentPropValue(e)}})},initPropValues:function(){this.tryApplySuper("initPropValues")},setParentPropValue:function(e){var t=this.getParent();if(t){var r=this.getPropertyName();r&&t&&t.setPropValue(r,e)}return this},resetParentPropValue:function(){return this.setParentPropValue(void 0)},getPropertyName:function(){return null},beforAddingByEditor:function(e,t){if(e){var r=this.getPropStoreFieldValue("value");Kekule.ObjUtils.notUnset(r)&&this.setParentPropValue(r)}this.tryApplySuper("beforAddingByEditor")},beforeRemovingByEditor:function(e){this.setPropStoreFieldValue("value",this.getValue()),this.resetParentPropValue()}}),Kekule.ChemMarker.Charge=Class.create(Kekule.ChemMarker.ChemPropertyMarker,{CLASS_NAME:"Kekule.ChemMarker.Charge",getPropertyName:function(){return"charge"},getAutoIdPrefix:function(){return"charge"}}),Kekule.ChemMarker.Radical=Class.create(Kekule.ChemMarker.ChemPropertyMarker,{CLASS_NAME:"Kekule.ChemMarker.Radical",getPropertyName:function(){return"radical"},getAutoIdPrefix:function(){return"radical"}}),ClassEx.extend(Kekule.ChemStructureNode,{fetchChargeMarker:function(e,t){return this.fetchMarkerOfType(Kekule.ChemMarker.Charge,e,!1,t)},fetchRadicalMarker:function(e,t){return this.fetchMarkerOfType(Kekule.ChemMarker.Radical,e,!1,t)}}),ClassEx.defineProp(Kekule.AbstractAtom,"lonePairCount",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED,serializable:!1,setter:null,getter:function(){for(var e=0,t=this.getMarkersOfType(Kekule.ChemMarker.UnbondedElectronSet),r=0,n=t.length;r<n;++r){2===t[r].getElectronCount()&&++e}return e}}),ClassEx.extendMethod(Kekule.AbstractAtom,"doCompare",function($origin,e,t){var r=$origin(e,t);if(!r&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(this._getComparisonOptionFlagValue(t,"lonePair")||this._getComparisonOptionFlagValue(t,"unbondedElectron"))){var n=function(e){var t=[];if(e.getMarkersOfType)for(var r=e.getMarkersOfType(Kekule.ChemMarker.UnbondedElectronSet),n=0,o=r.length;n<o;++n){var i=r[n];t.push(i.getElectronCount())}return t.sort(),t},o=n(this),i=n(e);return Kekule.ArrayUtils.compare(o,i)}return r})}();