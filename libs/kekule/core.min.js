Kekule.AbstractConfigs=Class.create(ObjectEx,{CLASS_NAME:"Kekule.AbstractConfigs",CONFIG_PROP_FLAG:"__$config_prop__",initialize:function($super,e){$super(),void 0===e&&(e=!0),e&&this.initPropDefValues()},addConfigProp:function(e,t,n,r){var o={dataType:t};r&&(o=Object.extend(o,r)),void 0!==n&&(o.defaultValue=n);var i=this.defineProp(e,o);return i[this.CONFIG_PROP_FLAG]=!0,i},addHashConfigProp:function(e,t,n){return this.addConfigProp(e,DataType.HASH,t,n)},addStrConfigProp:function(e,t,n){return this.addConfigProp(e,DataType.STRING,t,n)},addNumConfigProp:function(e,t,n){return this.addConfigProp(e,DataType.NUM,t,n)},addIntConfigProp:function(e,t,n){return this.addConfigProp(e,DataType.INT,t,n)},addFloatConfigProp:function(e,t,n){return this.addConfigProp(e,DataType.FLOAT,t,n)},addBoolConfigProp:function(e,t,n){return this.addConfigProp(e,DataType.BOOL,t,n)},initPropDefValues:function(){this.beginUpdate();try{for(var e=this.getAllPropList(),t=0,n=e.getLength();t<n;++t){var r=e.getPropInfoAt(t),o=r.name,i=r.defaultValue;void 0!==i&&this.setPropValue(o,i)}}finally{this.endUpdate()}},assign:function(e){e.copyPropsTo(this)},toHash:function(){var e={},t=this.CONFIG_PROP_FLAG;return this.saveObj(e,"json",{saveDefaultValues:!0,propFilter:function(e,n){return e[t]}}),e}}),Kekule.ConfigPresetMap=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ConfigPresetMap",initialize:function($super){$super(),this.map=new Kekule.MapEx(!0)},doFinalize:function($super){this.map=null,$super()},set:function(e,t){this.map.set(e,t)},get:function(e){return this.map.get(e)},getHash:function(e){var t=this.get(e);return t?t.toHash?t.toHash():t:null},remove:function(e){this.map.remove(e)},has:function(e){return this.map.has(e)},clear:function(){this.map.clear()}}),Kekule.ElementSeries={NONMETAL:"Nonmetals",METAL:"Metals",ALKALI_METAL:"Alkali Metals",ALKALI_EARTH_METAL:"Alkali Earth Metals",TRANSITION_METAL:"Transition Metals",METALLOID:"Metalloids",HALOGEN:"Halogens",NOBLE_GAS:"Noble Gases",LANTHANIDE:"Lanthanides",ACTINIDE:"Actinides"},Kekule.Element=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Element",initialize:function($super,e){if($super(),e!=Kekule.Element.UNSET_ELEMENT){var t=this.getElementInfo(e);t?(this.setPropStoreFieldValue("symbol",t.symbol),this.setPropStoreFieldValue("atomicNumber",t.atomicNumber),this.setPropStoreFieldValue("group",t.group),this.setPropStoreFieldValue("period",t.period),this.setPropStoreFieldValue("series",t.chemicalSerie),this.setPropStoreFieldValue("naturalMass",t.naturalMass),t.name&&this.setPropStoreFieldValue("name",t.name)):Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_CHEMELEMENT")+": "+e:"Invalid chemical element: "+e)}else this.setPropStoreFieldValue("symbol",Kekule.Element.UNSET_ELEMENT),this.setPropStoreFieldValue("atomicNumber",Kekule.Element.UNSET_ELEMENT)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING,serializable:!1,setter:null}),this.defineProp("atomicNumber",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("symbol",{dataType:DataType.STRING,serializable:!1,setter:null}),this.defineProp("group",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("period",{dataType:DataType.INT,serializable:!1,setter:null}),this.defineProp("series",{dataType:DataType.STRING,serializable:!1,setter:null}),this.defineProp("naturalMass",{dataType:DataType.FLOAT,serializable:!1,setter:null})},getElementInfo:function(e){return e==Kekule.Element.UNSET_ELEMENT?{symbol:Kekule.Element.UNSET_ELEMENT,atomicNumber:Kekule.Element.UNSET_ELEMENT}:Kekule.Element.isDummyElement(e)?{symbol:Kekule.Element.DUMMY_ELEMENT,atomicNumber:Kekule.Element.DUMMY_ELEMENT_ATOMICNUM}:Kekule.Element.isRGroup(e)?{symbol:Kekule.Element.RGROUP_ELEMENT,atomicNumber:Kekule.Element.RGROUP_ELEMENT_ATMOICNUM}:Kekule.ChemicalElementsDataUtil.getElementInfo(e)},getTheoreticValence:function(){return this.getGroup()?Kekule.Element.getTheoreticValenceOfGroup(this.getGroup()):null},isDummyElement:function(){return this.getAtomicNumber()==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM},isRGroupElement:function(){return this.getAtomicNumber()==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM},isNormalElement:function(){return Kekule.Element.isNormalElement(this.getAtomicNumber())},isSameElement:function(e){return e==Kekule.Element.UNSET_ELEMENT?this.getAtomicNumber()==Kekule.Element.UNSET_ELEMENT:"number"==typeof e?this.getAtomicNumber()==e:this.getSymbol()==e},isHetero:function(){return(this.getSeries()===Kekule.ElementSeries.NONMETAL||this.getSeries()===Kekule.ElementSeries.HALOGEN)&&6!==this.getAtomicNumber()&&1!==this.getAtomicNumber()},getLabel:function(){return this.getSymbol()}}),Object.extend(Kekule.Element,Kekule.ChemicalElementsDataUtil),Kekule.Element.UNSET_ELEMENT=void 0,Kekule.Element.DUMMY_ELEMENT="DU",Kekule.Element.DUMMY_ELEMENT_ATOMICNUM=-1,Kekule.Element.RGROUP_ELEMENT="R",Kekule.Element.RGROUP_ELEMENT_ATOMICNUM=-2,Kekule.Element.DEUTERIUM="D",Kekule.Element.isNormalElement=function(e){return e!=Kekule.Element.UNSET_ELEMENT&&!Kekule.Element.isPseudoElement(e)},Kekule.Element.isPseudoElement=function(e){return"string"==typeof e?e==Kekule.Element.DUMMY_ELEMENT||e==Kekule.Element.RGROUP_ELEMENT:e==Kekule.Element.DUMMY_ELEMENT_ATOMICNUM||e==Kekule.Element.RGROUP_ELEMENT_ATMOICNUM},Kekule.Element.isDummyElement=function(e){return e===Kekule.Element.DUMMY_ELEMENT||e===Kekule.Element.DUMMY_ELEMENT_ATOMICNUM},Kekule.Element.isRGroup=function(e){return e===Kekule.Element.RGROUP_ELEMENT||e===Kekule.Element.RGROUP_ELEMENT_ATOMICNUM},Kekule.Element.getTheoreticValenceOfGroup=function(e){return e<=2?e:e<=12?null:e<=17?e-10:0},Kekule.Element.getTheoreticValence=function(e){var t=Kekule.ChemicalElementsDataUtil.getElementInfo(e);return t.group?Kekule.Element.getTheoreticValenceOfGroup(t.group):null},Object.extend(Kekule.Element,{isAtomicNumberAvailable:function(e){return Kekule.ChemicalElementsDataUtil.isAtomicNumberAvailable(e)},isElementSymbolAvailable:function(e){return Kekule.ChemicalElementsDataUtil.isElementSymbolAvailable(e)}}),Kekule.Isotope=Class.create(Kekule.Element,{CLASS_NAME:"Kekule.Isotope",initialize:function($super,e,t){var n=e,r=t,o=Kekule.IsotopesDataUtil.getIsotopeInfo(e,t);if(o&&(o.atomicNumber&&(n=o.atomicNumber),r=o.massNumber),$super(n),this.setPropStoreFieldValue("massNumber",r),o&&o.isotopeAlias&&this.setPropStoreFieldValue("isotopeAlias",o.isotopeAlias),Kekule.Element.isNormalElement(n)&&r!==Kekule.Isotope.UNSET_MASSNUMBER){var i=Kekule.IsotopesDataUtil.getIsotopeInfo(this.getAtomicNumber(),r);i?(this.setPropStoreFieldValue("exactMass",i.exactMass),this.setPropStoreFieldValue("naturalAbundance",i.naturalAbundance)):Kekule.chemError((Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.INVALID_ISOTOPE"):"Invalid isotope")+": "+this.getSymbol()+"/"+t)}},initProperties:function(){this.defineProp("massNumber",{dataType:DataType.INTEGER,serializable:!1,setter:null}),this.defineProp("exactMass",{dataType:DataType.FLOAT,serializable:!1,setter:null}),this.defineProp("naturalAbundance",{dataType:DataType.FLOAT,serializable:!1,setter:null}),this.defineProp("isotopeAlias",{dataType:DataType.STRING,serializable:!1,setter:null})},isSame:function(e){return e instanceof Kekule.Isotope&&(e===this||e.getAtomicNumber()==this.getAtomicNumber()&&e.getMassNumber()==this.getMassNumber())},getIsotopeId:function(){return Kekule.IsotopesDataUtil.getIsotopeId(this.getAtomicNumber(),this.getMassNumber())},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()}}),Object.extend(Kekule.Isotope,Kekule.IsotopesDataUtil),Kekule.Isotope.UNSET_MASSNUMBER=void 0,Kekule.Isotope.getIsotopeId=function(e,t){return Kekule.IsotopesDataUtil.getIsotopeId(e,t)},Object.extend(Kekule.Isotope,{isMassNumberAvailable:function(e,t){return Kekule.IsotopesDataUtil.isMassNumberAvailable(e,t)}}),Kekule.IsotopeFactory={GENERIC_ELEMENT_ID:"__GENERIC__",_isotopes:{},getIsotopeId:function(e,t){return e?Kekule.IsotopesDataUtil.getIsotopeId(e,t):Kekule.IsotopeFactory.GENERIC_ELEMENT_ID},getIsotope:function(e,t){var n=Kekule.IsotopeFactory.getIsotopeId(e,t);if(!Kekule.IsotopeFactory._isotopes[n]){var r=new Kekule.Isotope(e,t);Kekule.IsotopeFactory._isotopes[n]=r}return Kekule.IsotopeFactory._isotopes[n]},getIsotopeById:function(e){if(Kekule.IsotopeFactory._isotopes[e])return Kekule.IsotopeFactory._isotopes[e];var t=Kekule.IsotopesDataUtil.getIsotopeIdDetail(e);return t?Kekule.IsotopeFactory.getIsotope(t.symbol,t.massNumber):null}},Kekule.AtomType={UNSET_ATOMTYPE:void 0},Kekule.ElectronSet=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ElectronSet",initialize:function($super,e){$super(),this.setElectronCount(e||Kekule.ElectronSet.UNSET_ELECTRONCOUNT)},initProperties:function(){this.defineProp("electronCount",{dataType:DataType.FLOAT})}}),Kekule.ElectronSet.UNSET_ELECTRONCOUNT=null,Kekule.UnbondedElectronSet=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.UnBondedElectronSet",initialize:function($super,e){$super(e)},initProperties:function(){}}),Kekule.BondType={COVALENT:"covalent",IONIC:"ionic",COORDINATE:"coordinate",METALLIC:"metallic",HYDROGEN:"hydrogen",UNKNOWN:null,DEFAULT:"covalent"},Kekule.BondOrder={SINGLE:1,DOUBLE:2,TRIPLE:3,QUAD:4,EXPLICIT_AROMATIC:10,OTHER:20,UNSET:null,DEFAULT:1,getBondValence:function(e){return e===Kekule.BondOrder.UNSET?0:e==Kekule.BondOrder.EXPLICIT_AROMATIC?1.5:e}},Kekule.BondForm=Class.create(Kekule.ElectronSet,{CLASS_NAME:"Kekule.BondForm",initialize:function($super,e,t,n){$super(t),this.setBondOrder(e||Kekule.BondOrder.DEFAULT),Kekule.ObjUtils.notUnset(n)&&this.setBondType(n),Kekule.ObjUtils.notUnset(t)&&this.setElectronCount(t)},initProperties:function(){this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var e=this.getPropStoreFieldValue("bondType");return e||Kekule.BondType.DEFAULT}}),this.defineProp("bondOrder",{dataType:DataType.FLOAT,enumSource:Kekule.BondOrder,setter:function(e){this.getPropStoreFieldValue("bondOrder")!=e&&(this.setPropStoreFieldValue("bondOrder",e),e?this.getBondType()==Kekule.BondType.COVALENT&&this.setElectronCount(2*this.getBondValence()):e===Kekule.BondOrder.UNSET&&this.setElectronCount(Kekule.ElectronSet.UNSET_ELECTRONCOUNT))}}),this.defineProp("electronCount",{dataType:DataType.FLOAT}),this.defineProp("bondValence",{dataType:DataType.FLOAT,serializable:!1,getter:function(){return Kekule.BondOrder.getBondValence(this.getBondOrder())},setter:null})}}),Kekule.BondFormFactory={_bondForms:{},getBondFormId:function(e,t,n){var r="";return n&&(r+=n+"_"),e&&(r+=Number(e).toString()),t&&(r+="_"+Number(t).toString()),r},getBondForm:function(e,t,n){if(e||t||n){if(n||(n=Kekule.BondType.DEFAULT),!t&&e&&n===Kekule.BondType.COVALENT)t=2*Kekule.BondOrder.getBondValence(e);var r=Kekule.BondFormFactory.getBondFormId(e,t,n);return Kekule.BondFormFactory._bondForms[r]||(Kekule.BondFormFactory._bondForms[r]=new Kekule.BondForm(e,t,n)),Kekule.BondFormFactory._bondForms[r]}}},Kekule.RadicalOrder={NONE:0,SINGLET:1,DOUBLET:2,TRIPLET:3,DEFAULT:0,getRadicalElectronCount:function(e){var t=Kekule.RadicalOrder;return Kekule.ObjUtils.isUnset(e)||e===t.NONE?0:e===t.DOUBLET?1:2}},Kekule.HybridizationType={UNKNOWN:null,SP:1,SP2:2,SP3:3,NONE:0},Kekule.ValenceUtils={getImplicitMdlValence:function(e,t,n){var r=t,o=n;switch(e){case 1:case 3:case 11:case 19:case 37:case 55:case 87:if(0==r&&o<=1)return 1;break;case 4:case 12:case 20:case 38:case 56:case 88:switch(r){case 0:if(o<=2)return 2;break;case 1:if(o<=1)return 1}break;case 5:switch(r){case-4:if(o<=1)return 1;break;case-3:if(o<=2)return 2;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 1:if(o<=2)return 2;break;case 2:if(o<=1)return 1}break;case 6:switch(r){case-3:if(o<=1)return 1;break;case-2:if(o<=2)return 2;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 2:if(o<=2)return 2;break;case 3:if(o<=1)return 1}break;case 7:switch(r){case-2:if(o<=1)return 1;break;case-1:if(o<=2)return 2;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 3:if(o<=2)return 2;break;case 4:if(o<=1)return 1}break;case 8:switch(r){case-1:if(o<=1)return 1;break;case 0:if(o<=2)return 2;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 4:if(o<=2)return 2;break;case 5:if(o<=1)return 1}break;case 9:switch(r){case 0:if(o<=1)return 1;break;case 1:if(o<=2)return 2;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 5:if(o<=2)return 2;break;case 6:if(o<=1)return 1}break;case 13:switch(r){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 1:if(o<=2)return 2;break;case 2:if(o<=1)return 1}break;case 14:switch(r){case-3:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-2:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 2:if(o<=2)return 2;break;case 3:if(o<=1)return 1}break;case 15:switch(r){case-2:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 3:if(o<=2)return 2;break;case 4:if(o<=1)return 1}break;case 16:switch(r){case-1:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 0:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 4:if(o<=2)return 2;break;case 5:if(o<=1)return 1}break;case 17:switch(r){case 0:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 5:if(o<=2)return 2;break;case 6:if(o<=1)return 1}break;case 31:switch(r){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 2:if(o<=1)return 1}break;case 32:switch(r){case-3:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-2:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 3:if(o<=1)return 1}break;case 33:switch(r){case-2:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 4:if(o<=1)return 1}break;case 34:switch(r){case-1:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 0:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 5:if(o<=1)return 1}break;case 35:switch(r){case 0:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 6:if(o<=1)return 1}break;case 49:switch(r){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=2)return 2;if(o<=4)return 4;break;case 0:if(o<=3)return 3;break;case 2:if(o<=1)return 1}break;case 50:case 82:switch(r){case-3:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-2:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-1:if(o<=3)return 3;if(o<=5)return 5;break;case 0:if(o<=2)return 2;if(o<=4)return 4;break;case 1:if(o<=3)return 3;break;case 3:if(o<=1)return 1}break;case 51:case 83:switch(r){case-2:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 0:if(o<=3)return 3;if(o<=5)return 5;break;case 1:if(o<=2)return 2;if(o<=4)return 4;break;case 2:if(o<=3)return 3;break;case 4:if(o<=1)return 1}break;case 52:case 84:switch(r){case-1:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 0:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 1:if(o<=3)return 3;if(o<=5)return 5;break;case 2:if(o<=2)return 2;if(o<=4)return 4;break;case 3:if(o<=3)return 3;break;case 5:if(o<=1)return 1}break;case 53:case 85:switch(r){case 0:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case 1:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case 2:if(o<=3)return 3;if(o<=5)return 5;break;case 3:if(o<=2)return 2;if(o<=4)return 4;break;case 4:if(o<=3)return 3;break;case 6:if(o<=1)return 1}break;case 81:switch(r){case-4:if(o<=1)return 1;if(o<=3)return 3;if(o<=5)return 5;if(o<=7)return 7;break;case-3:if(o<=2)return 2;if(o<=4)return 4;if(o<=6)return 6;break;case-2:if(o<=3)return 3;if(o<=5)return 5;break;case-1:if(o<=2)return 2;if(o<=4)return 4;break;case 0:if(o<=1)return 1;if(o<=3)return 3}}return o},getImplicitHydValence:function(e,t,n){var r=e,o=t,i=n,a=0;return 6==r?a=4-Math.abs(o):7==r||15==r?a=3+o:8!=r&&16!=r||(a=2+o),a<0&&(a=0),i>a&&(a=i),a}},Kekule.ValenceUtils.getImplicitValence=Kekule.ValenceUtils.getImplicitMdlValence,function(){"use strict";var e=Kekule.ArrayUtils;Kekule.StructureComparationLevel={SKELETAL:1,CONSTITUTION:2,CONFIGURATION:3,EXACT:4,DEFAULT:4},Kekule.globalOptions.add("algorithm.structureComparation",{structureComparationLevel:Kekule.StructureComparationLevel.DEFAULT}),Kekule.globalOptions.add("algorithm.structureClean",{structureCleanOptions:{orphanChemNode:!0,hangingChemConnector:!0}}),Kekule.ObjComparer.compareStructure=function(e,t,n){var r=Object.create(n||{});return r.method=Kekule.ComparisonMethod.CHEM_STRUCTURE,Kekule.ObjComparer.compare(e,t,r)},Kekule.ObjComparer.equalStructure=function(e,t,n){return 0===Kekule.ObjComparer.compareStructure(e,t,n)},Kekule.ObjComparer.getStructureComparisonDetailOptions=function(e){var t=Object.extend({},e);if(e){var n,r=Kekule.StructureComparationLevel,o=e.structureLevel||e.level||Kekule.globalOptions.algorithm.structureComparation.structureComparationLevel,i=["atom","mass","linkedConnectorCount","charge","radical","stereo","hydrogenCount","connectedObjCount","bondType","bondOrder"];o===r.SKELETAL?n={atom:!1,mass:!1,linkedConnectorCount:!0,charge:!1,radical:!1,stereo:!1,hydrogenCount:!1,connectedObjCount:!0,bondType:!1,bondOrder:!1}:o===r.CONSTITUTION?n={atom:!0,mass:!1,linkedConnectorCount:!0,charge:!1,radical:!1,stereo:!1,hydrogenCount:!0,connectedObjCount:!0,bondType:!0,bondOrder:!0}:o===r.CONFIGURATION?n={atom:!0,mass:!1,linkedConnectorCount:!0,charge:!1,radical:!1,stereo:!0,hydrogenCount:!0,connectedObjCount:!0,bondType:!0,bondOrder:!0}:o===r.EXACT&&(n={atom:!0,mass:!0,linkedConnectorCount:!0,charge:!0,radical:!0,stereo:!0,hydrogenCount:!0,connectedObjCount:!0,bondType:!0,bondOrder:!0});for(var a=0,s=i.length;a<s;++a){var u=i[a],l="compare"+u.capitalizeFirst(),c=t[u];Kekule.ObjUtils.isUnset(c)&&(c=t[l]),Kekule.ObjUtils.isUnset(c)?(t[u]=n[u],t[l]=n[u]):(t[u]=c,t[l]=c)}}return t},Kekule.ChemStructureObject=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemStructureObject",initialize:function($super,e){this.setPropStoreFieldValue("autoClearStructureCache",!0),$super(e)},doFinalize:function($super){$super()},initProperties:function(){this.defineProp("linkedConnectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null}),this.defineProp("linkedObjs",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=0,n=this.getLinkedConnectorCount();t<n;++t)for(var r=this.getLinkedConnectorAt(t).getConnectedObjs(),o=0,i=r.length;o<i;++o){var a=r[o];a===this||this.hasChildObj&&this.hasChildObj(a)||Kekule.ArrayUtils.pushUnique(e,r[o])}return e}}),this.defineProp("linkedSiblings",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=this.getParent(),n=0,r=this.getLinkedConnectorCount();n<r;++n)for(var o=this.getLinkedConnectorAt(n).getConnectedObjs(),i=0,a=o.length;i<a;++i){var s=o[i];s!==this&&e.indexOf(s)<0&&(s.getParent()!==t&&(s=t.getDirectChildOfNestedNode(s)),s&&e.push(s))}return e}}),this.defineProp("structureCache",{dataType:DataType.HASH,serializable:!1,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("structureCache");return!t&&e&&(t={},this.setPropStoreFieldValue("structureCache",t)),t}}),this.defineProp("autoClearStructureCache",{dataType:DataType.BOOL,serializable:!1})},initPropValues:function($super){$super(),this.setPropStoreFieldValue("linkedConnectors",[]),this.setSuppressChildChangeEventInUpdating(!0)},getAutoIdPrefix:function(){return"o"},getAcceptCoordStickFrom:function(e){return!1},doGetActualCompareOptions:function($super,e){if(e&&e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var t=Kekule.ObjComparer.getStructureComparisonDetailOptions(e);return e.customMethod&&(t.customMethod=e.customMethod),e.extraComparisonProperties&&(t.extraComparisonProperties=e.extraComparisonProperties),t}return $super(e)},_getComparisonOptionFlagValue:function(e,t){var n=e["compare"+t.capitalizeFirst()];return Kekule.ObjUtils.isUnset(n)&&(n=e[t]),n},doGetComparisonPropNames:function($super,e){return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE?[]:$super(e)},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"linkedConnectorCount")){var r=this.getLinkedNonHydrogenConnectors(),o=e.getLinkedNonHydrogenConnectors&&e.getLinkedNonHydrogenConnectors();n=this.doCompareOnValue(r.length,o&&o.length,t)}return n},compareStructure:function(e,t){var n=Object.create(t||{});return n.method=Kekule.ComparisonMethod.CHEM_STRUCTURE,this.compare(e,n)},equalStructure:function(e,t){return 0===this.compareStructure(e,t)},getParentFragment:function(){var e=this.getParent();return e instanceof Kekule.StructureFragment?e:null},getRootFragment:function(){var e=this.getParentFragment();return e&&e.getRootFragment()||e},getStructureCacheData:function(e){var t=this.getStructureCache();return t&&t[e]},setStructureCacheData:function(e,t){return this.getStructureCache(!0)[e]=t,this},clearStructureCache:function(){return this.setPropStoreFieldValue("structureCache",null),this},needAutoClearStructureCache:function(){var e=this.getParent();return this.getAutoClearStructureCache()&&(!e||!e.needAutoClearStructureCache||e.needAutoClearStructureCache())},notifyLinkedConnectorsChanged:function(){this.notifyPropSet("linkedConnectors",this.getPropStoreFieldValue("linkedConnectors"))},getCurrConnectableObj:function(){return this},getLinkedConnectorCount:function(){return this.getLinkedConnectors().length},getLinkedConnectorAt:function(e){return this.getLinkedConnectors()[e]},indexOfLinkedConnector:function(e){return this.getLinkedConnectors().indexOf(e)},appendLinkedConnector:function(e){var t=this._doAppendLinkedConnector(e);return e&&e._doAppendConnectedObj(this),t},_doAppendLinkedConnector:function(e){if(!e)return-1;var t=this.getPropStoreFieldValue("linkedConnectors"),n=Kekule.ArrayUtils.pushUniqueEx(t,e);return n.isPushed&&this.notifyLinkedConnectorsChanged(),n.index},insertLinkedConnectorAt:function(e,t){t||(t=0);var n=this.indexOfLinkedConnector(e),r=this.getLinkedConnectors();n>=0?(r.splice(n,1),r.splice(t,0,e),this.notifyLinkedConnectorsChanged()):(r.splice(t,0,e),e&&e._doAppendConnectedObj(this),this.notifyLinkedConnectorsChanged())},insertLinkedConnectorBefore:function(e,t){var n=t?this.indexOfLinkedConnector(t):-1;return n<0?this.appendLinkedConnector(e):this.insertLinkedConnectorAt(e,n)},removeLinkedConnectorAt:function(e){var t=this.getLinkedConnectorAt(e);return t&&t._doRemoveConnectedObjAt(t.indexOfConnectedObj(this)),this._doRemoveLinkedConnectorAt(e)},_doRemoveLinkedConnectorAt:function(e){var t=Kekule.ArrayUtils.removeAt(this.getLinkedConnectors(),e);return t&&this.notifyLinkedConnectorsChanged(),t},removeLinkedConnector:function(e){var t=this.getLinkedConnectors().indexOf(e);t>=0&&this.removeLinkedConnectorAt(t)},getConnectorTo:function(e){for(var t=0,n=this.getLinkedConnectorCount();t<n;++t){var r=this.getLinkedConnectorAt(t);if(r.hasConnectedObj(e))return r}return null},removeThisFromLinkedConnector:function(){for(var e=this.getLinkedConnectorCount()-1;e>=0;--e){this.getLinkedConnectorAt(e).removeConnectedObj(this)}},getLinkedObjsOnConnector:function(e){for(var t=[],n=e.getConnectedObjs(),r=0,o=n.length;r<o;++r)n[r]!==this&&Kekule.ArrayUtils.pushUnique(t,n[r]);return t},getLinkedNonHydrogenConnectors:function(){for(var e=[],t=0,n=this.getLinkedConnectorCount();t<n;++t){var r=this.getLinkedConnectorAt(t);r.isNormalConnectorToHydrogen&&r.isNormalConnectorToHydrogen()||Kekule.ArrayUtils.pushUnique(e,r)}return e},getLinkedNonHydrogenObjs:function(){for(var e=[],t=0,n=this.getLinkedConnectorCount();t<n;++t)for(var r=this.getLinkedConnectorAt(t).getConnectedObjs(),o=0,i=r.length;o<i;++o)r[o]===this||r[o].isHydrogenAtom&&r[o].isHydrogenAtom()||Kekule.ArrayUtils.pushUnique(e,r[o]);return e},getLinkedHydrogenAtoms:function(){for(var e=[],t=0,n=this.getLinkedConnectorCount();t<n;++t)for(var r=this.getLinkedConnectorAt(t).getConnectedObjs(),o=0,i=r.length;o<i;++o)r[o]!==this&&r[o].isHydrogenAtom&&r[o].isHydrogenAtom()&&Kekule.ArrayUtils.pushUnique(e,r[o]);return e},getPathesToDest:function(e){return this._doGetPathesToDest(e,[])},_doGetPathesToDest:function(t,n){if(t===this)return[];for(var r,o=[],i=e.clone(n),a=0,s=this.getLinkedConnectorCount();a<s;++a){var u=this.getLinkedConnectorAt(a);if(!(i.indexOf(u)>=0)){i.push(u);for(var l=u.getConnectedObjs(),c=0,d=l.length;c<d;++c){var h=l[c];if(h===t)r=[[]];else{if(h===this)continue;r=h&&h._doGetPathesToDest&&h._doGetPathesToDest(t,i)}if(r){for(var C={connector:u,object:h},f=0,g=r.length;f<g;++f)r[f].unshift(C);o=o.concat(r)}}}}return o.length||(o=null),o},getStructureRelatedPropNames:function(){return["linkedConnectors"]},structureChange:function(e){this.needAutoClearStructureCache()&&(this.clearStructureFlags(),this.clearStructureCache()),this.invokeEvent("structureChange",{origin:e||this})},clearStructureFlags:function(){},relayEvent:function($super,e,t){"structureChange"===e?this.structureChange(t.origin):$super(e,t)},doObjectChange:function($super,e){Kekule.ArrayUtils.intersect(e||[],this.getStructureRelatedPropNames()).length&&this.structureChange()}}),Kekule.SimpleStructureNode=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.SimpleStructureNode",initialize:function($super,e,t,n){$super(e),t&&this.setCoord2D(t),n&&this.setCoord3D(n)},initProperties:function(){this.defineProp("zIndex2D",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED})},getStructureRelatedPropNames:function($super){return $super().concat(["coord2D","coord3D"])},getAutoIdPrefix:function(){return"n"},getContainerBox:function(e,t){var n=this.getAbsCoordOfMode(e,t);return Kekule.BoxUtils.createBox(n,n)},getContainerBox2D:function(e){return this.getContainerBox(Kekule.CoordMode.COORD2D,e)},getContainerBox3D:function(e){return this.getContainerBox(Kekule.CoordMode.COORD3D,e)}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.SimpleStructureNode),Kekule.BaseStructureNode=Class.create(Kekule.SimpleStructureNode,{CLASS_NAME:"Kekule.BaseStructureNode",initProperties:function(){this.defineProp("coordStickTarget",{dataType:"Kekule.ChemStructureObject",objRef:!0,autoUpdate:!0,getter:function(){return this.getPropStoreFieldValue("coordStickTarget")},setter:function(e){if(e){if(!this.getAllowCoordStickTo(e))return void Kekule.chemError(Kekule.$L("ErrorMsg.COORD_STICK_NOT_ALLOWED_ON_CLASS"));var t=this.getOwner(),n=e.getOwner&&e.getOwner();if(n&&t!==n)return void Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_TO_STICK_TO_OTHER_OWNER_OBJ"));if(!e.getAcceptCoordStickFrom&&!e.getAcceptCoordStickFrom(this))return void Kekule.chemError(Kekule.$L("ErrorMsg.INVALID_STICK_TARGET_OBJ"));if(!e.getAbsCoordOfMode)return void Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_TO_STICK_TO_OBJ_WITHOUT_ABS_COORD"));if(e.getCoordStickTarget&&e.getCoordStickTarget()===this)return void Kekule.chemError(Kekule.$L("ErrorMsg.STICK_RECURSION_NOT_ALLOWED"))}var r=this.getCoordStickTarget();this.setPropStoreFieldValue("coordStickTarget",e),this._coordStickTargetChanged(r,e)}})},getAllowCoordStickTo:function(e){return!1},notifyCoordStickTargetChanged:function(e,t){},_getParentAbsCoord:function(e,t){var n=this.getCoordParent();return n&&n.getAbsCoordOfMode&&n.getAbsCoordOfMode(e,t)},_coordStickTargetChanged:function(e,t){e&&!t?this._copyAbsCoordFromStickedTarget(e,this.getCoordParent()):t&&this._copyAbsCoordFromStickedTarget(t,this.getCoordParent()),e&&e.detachCoordStickNodes&&e.detachCoordStickNodes(this),t&&t.attachCoordStickNodes&&t.attachCoordStickNodes(this),this.notifyCoordStickTargetChanged(e,t)},_copyAbsCoordFromStickedTarget:function(e,t,n){var r=Kekule.CoordUtils,o=Kekule.CoordMode;t||(t=this.getCoordParent());var i=n&&n!==o.COORD2D?null:e.getAbsCoord2D(),a=n&&n!==o.COORD2D?null:e.getAbsCoord3D();if(t){if(i){var s=t.getAbsCoord2D&&t.getAbsCoord2D();s&&(i=r.substract(i,s))}if(a){var u=t.getAbsCoord3D&&t.getAbsCoord3D();u&&(a=r.substract(a,u))}}i&&this.setPropStoreFieldValue("coord2D",i),a&&this.setPropStoreFieldValue("coord3D",a)},doGetCoord2D:function($super,e,t){var n=this.getCoordStickTarget();if(n&&n.getAbsCoord2D){var r=n.getAbsCoord2D(e,t),o=this._getParentAbsCoord(Kekule.CoordMode.COORD2D,e);return o&&(r=Kekule.CoordUtils.substract(r,o)),r}return $super(e,t)},doGetCoord3D:function($super,e,t){var n=this.getCoordStickTarget();if(n&&n.getAbsCoord3D){var r=n.getAbsCoord3D(e,t),o=this._getParentAbsCoord(Kekule.CoordMode.COORD3D,e);return o&&(r=Kekule.CoordUtils.substract(r,o)),r}return $super(e,t)}}),Kekule.StereoParity={NONE:null,ODD:1,EVEN:2,UNKNOWN:0},Kekule.ChemStructureNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.ChemStructureNode",initialize:function($super,e,t,n){$super(e),t&&this.setCoord2D(t),n&&this.setCoord3D(n)},initProperties:function(){this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}}),this.defineProp("radical",{dataType:DataType.INT}),this.defineProp("parity",{dataType:DataType.INT}),this.defineProp("isAnchor",{dataType:DataType.BOOL,serializable:!1,getter:function(){var e=this.getParent();return!(!e||!e.indexOfAnchorNode)&&e.indexOfAnchorNode(this)>=0},setter:function(e){if(e!==this.getIsAnchor()){var t=this.getParent();t&&(e&&t.appendAnchorNode()?t.appendAnchorNode(this):!e&&t.removeAnchorNode&&t.removeAnchorNode(this))}}})},getStructureRelatedPropNames:function($super){return $super().concat(["charge","radical"])},getLabel:function(){return null},getAcceptCoordStickFrom:function(e){return!(this.isSiblingWith(e)||e instanceof Kekule.ChemStructureNode)},doGetComparisonPropNames:function($super,e){var t=$super(e);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(this._getComparisonOptionFlagValue(e,"charge")&&t.push("charge"),this._getComparisonOptionFlagValue(e,"radical")&&t.push("radical")),t},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"stereo")){var r=this.getParity()||Kekule.StereoParity.UNKNOWN,o=e.getParity&&e.getParity()||Kekule.StereoParity.UNKNOWN;n=this.doCompareOnValue(r,o,t)}return n},getPrimaryIsotope:function(){return null},getLinkedChemNodes:function(e){for(var t=this.getLinkedObjs(),n=[],r=0,o=t.length;r<o;++r){var i=t[r];!(i instanceof Kekule.ChemStructureNode)||e&&i.isHydrogenAtom&&i.isHydrogenAtom()||n.push(i)}return n},getLinkedBonds:function(e){for(var t=[],n=0,r=this.getLinkedConnectorCount();n<r;++n){var o=this.getLinkedConnectorAt(n);o instanceof Kekule.Bond&&(!e||o.getBondType()===e)&&t.push(o)}return t},getLinkedMultiCenterBonds:function(){for(var e=[],t=0,n=this.getLinkedConnectorCount();t<n;++t){var r=this.getLinkedConnectorAt(t);r instanceof Kekule.Bond&&r.getConnectedObjCount()>2&&e.push(r)}return e},getLinkedMultipleBonds:function(){for(var e=Kekule.BondOrder,t=[],n=0,r=this.getLinkedConnectorCount();n<r;++n){var o=this.getLinkedConnectorAt(n);if(o instanceof Kekule.Bond&&o.getBondType()===Kekule.BondType.COVALENT){var i=o.getBondOrder();i!==e.DOUBLE&&i!==e.TRIPLE&&i!==e.QUAD&&i!==e.EXPLICIT_AROMATIC||t.push(o)}}return t},getLinkedDoubleBonds:function(){for(var e=Kekule.BondOrder,t=[],n=0,r=this.getLinkedConnectorCount();n<r;++n){var o=this.getLinkedConnectorAt(n);if(o instanceof Kekule.Bond&&o.getBondType()===Kekule.BondType.COVALENT)o.getBondOrder()===e.DOUBLE&&t.push(o)}return t},clearStructureFlags:function(){this.setPropStoreFieldValue("parity",Kekule.StereoParity.NONE)},isHydrogenAtom:function(){return!1}}),Kekule.RadicalType=Kekule.RadicalOrder,Kekule.AbstractAtom=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.AbstractAtom",initialize:function($super,e,t,n){$super(e,t,n)},initProperties:function(){this.defineProp("explicitHydrogenCount",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function($super){return $super().concat(["explicitHydrogenCount"])},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"hydrogenCount")){var r=this.getHydrogenCount(!0),o=e.getHydrogenCount&&e.getHydrogenCount(!0);n=this.doCompareOnValue(r,o,t)}return n},getHydrogenCount:function(e){var t=this.getExplicitHydrogenCount()||0;e&&(t+=this.getLinkedHydrogenAtoms().length||0);return t},setHydrogenCount:function(e){return this.setExplicitHydrogenCount(e)},isSaturated:function(){return!this.getLinkedMultipleBonds().length},mayContainElement:function(e){var t;return t="string"==typeof e?Kekule.ChemicalElementsDataUtil.getAtomicNumber(e):e,this.doMayContainElement(t)},doMayContainElement:function(e){return!1}}),Kekule.Atom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Atom",initialize:function($super,e,t,n,r,o){$super(e,r,o),(t||n)&&this.changeIsotope(t,n)},initProperties:function(){this.defineProp("isotope",{dataType:"Kekule.Isotope",serializable:!1}),this.defineProp("isotopeId",{dataType:DataType.STRING,serializable:!0,getter:function(){var e=this.getIsotope();return e?e.getIsotopeId():Kekule.Element.UNSET_ELEMENT},setter:function(e){var t=Kekule.IsotopeFactory.getIsotopeById(e);t&&this.setIsotope(t)}}),this.defineProp("symbol",{dataType:DataType.STRING,serializable:!1,getter:function(){var e=this.getIsotope();return e?e.getSymbol():Kekule.Element.UNSET_ELEMENT},setter:function(e){this.changeElement(e)}}),this.defineProp("atomicNumber",{dataType:DataType.INTEGER,serializable:!1,getter:function(){var e=this.getIsotope();return e?e.getAtomicNumber():0},setter:function(e){this.changeElement(e)}}),this.defineProp("massNumber",{dataType:DataType.INTEGER,getter:function(){var e=this.getIsotope();return e?e.getMassNumber():Kekule.Isotope.UNSET_MASSNUMBER},setter:function(e){this.changeMassNumber(e)}}),this.defineProp("isotopeAlias",{dataType:DataType.STRING,getter:function(){var e=this.getIsotope();return e?e.getIsotopeAlias():void 0},setter:function(e){this.changeElement(e)}}),this.defineProp("atomType",{dataType:DataType.OBJECT,serializable:!1,scope:Class.PropertyScope.PUBLIC}),this.defineProp("atomTypeId",{dataType:DataType.STRING,getter:function(){var e=this.getPropStoreFieldValue("atomType");return e?e.id:Kekule.AtomType.UNSET_ATOMTYPE},setter:function(e){if(this.isNormalAtom()){var t=Kekule.AtomTypeDataUtil.getAtomTypeFromId(this.getAtomicNumber(),e);this.setAtomType(t)}}}),this.defineProp("hybridizationType",{dataType:DataType.INT,enumSource:Kekule.HybridizationType})},getAutoIdPrefix:function(){return"a"},getStructureRelatedPropNames:function($super){return $super().concat(["isotope","atomType"])},doGetComparisonPropNames:function($super,e){var t=$super(e);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(this._getComparisonOptionFlagValue(e,"atom")&&t.push("atomicNumber"),this._getComparisonOptionFlagValue(e,"mass")&&t.push("massNumber")),t},getPrimaryIsotope:function(){return this.getIsotope()},getLabel:function(){return""+(this.getMassNumber()||"")+this.getSymbol()},doMayContainElement:function(e){return this.getAtomicNumber()===e},changeIsotope:function(e,t){e===Kekule.Element.UNSET_ELEMENT?t=Kekule.Isotope.UNSET_MASSNUMBER:e||(e=this.getAtomicNumber()),t||(t=Kekule.Isotope.UNSET_MASSNUMBER),this.getAtomicNumber()!==e&&this.setAtomType(Kekule.AtomType.UNSET_ATOMTYPE);var n=Kekule.IsotopeFactory.getIsotope(e,t);this.setIsotope(n)},changeElement:function(e){return this.changeIsotope(e,Kekule.Isotope.UNSET_MASSNUMBER)},changeMassNumber:function(e){return this.changeIsotope(null,e)},isElement:function(e){return this.getSymbol()===e||this.getAtomicNumber()===e},isNormalAtom:function(){var e=this.getIsotope();return!!e&&e.isNormalElement()},isHydrogenAtom:function(){return this.isElement(1)&&(!this.getMassNumber()||this.getMassNumber()<=1)},_getCurrCovalentBondsInfo:function(){for(var e=0,t=0,n=this.getStructureCacheData("piElectronCount")||null,r=0,o=this.getLinkedConnectorCount();r<o;++r){var i,a=this.getLinkedConnectorAt(r);if(a instanceof Kekule.Bond&&a.getBondType()==Kekule.BondType.COVALENT)e+=i=a.getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC&&n>=2?1:a.getBondValence(),i>t&&(t=i)}return{valenceSum:e,maxValence:t}},_getCurrIonicBondsInfo:function(){for(var e=0,t=0,n=0,r=this.getLinkedConnectorCount();n<r;++n){var o=this.getLinkedConnectorAt(n);if(o instanceof Kekule.Bond&&o.getBondType()==Kekule.BondType.IONIC){var i=o.getBondValence();e+=i,i>t&&(t=i)}}return{valenceSum:e,maxValence:t}},guessAtomType:function(){if(this.isNormalAtom()){var e=null,t=null,n=this._getCurrCovalentBondsInfo(),r=Kekule.AtomTypeDataUtil.getAllAtomTypes(this.getAtomicNumber());if(r){for(var o=0,i=r.length;o<i;++o){var a=r[o];if(t=a,a.bondOrderSum>=n.valenceSum&&(e=a,a.maxBondOrder>=n.maxValence))return a}return e||t}}return null},getProximalAtomType:function(){return this.getAtomType()||this.guessAtomType()},getImplicitValence:function(){if(this.isNormalAtom()){var e=this._getCurrCovalentBondsInfo().valenceSum,t=Math.round(this.getCharge()||0);return Kekule.ValenceUtils.getImplicitValence(this.getAtomicNumber(),t,e)}return 0},getImplicitHydrogenCount:function(){if(this.isNormalAtom()){var e=this._getCurrCovalentBondsInfo(),t=this._getCurrIonicBondsInfo(),n=this.getImplicitValence();return n-=Kekule.RadicalOrder.getRadicalElectronCount(this.getRadical()),Math.max(n-e.valenceSum-t.valenceSum,0)}return 0},getHydrogenCount:function(e){var t;return t=Kekule.ObjUtils.isUnset(this.getExplicitHydrogenCount())?this.getImplicitHydrogenCount()||0:this.getExplicitHydrogenCount()||0,e&&(t+=this.getLinkedHydrogenAtoms().length||0),t},getAtomicMass:function(){var e=null,t=this.getIsotope();return t&&(e=t.getExactMass()||t.getNaturalMass()),e}}),Kekule.PseudoatomType={DUMMY:"dummy",ANY:"any",HETERO:"hetero",CUSTOM:"custom"},Kekule.Pseudoatom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.Pseudoatom",initialize:function($super,e,t,n,r,o){$super(e,r,o),t&&this.setAtomType(t),n&&t==Kekule.PseudoatomType.CUSTOM&&this.setSymbol(n)},initProperties:function(){this.defineProp("atomType",{dataType:DataType.STRING,enumSource:Kekule.PseudoatomType}),this.defineProp("symbol",{dataType:DataType.STRING,getter:function(){var e=this.getAtomType(),t=Kekule.PseudoatomType,n=Kekule.ChemStructureNodeLabels;return e===t.DUMMY?n.DUMMY_ATOM:e===t.ANY?n.ANY_ATOM:e===t.HETERO?n.HETERO_ATOM:this.getPropStoreFieldValue("symbol")||n.CUSTOM_ATOM},setter:function(e){var t=Kekule.PseudoatomType,n=Kekule.ChemStructureNodeLabels;if(e){var r=e===n.DUMMY_ATOM?t.DUMMY:e===n.ANY_ATOM?t.ANY:e===n.HETERO_ATOM?t.HETERO:t.CUSTOM;this.setAtomType(r)}this.setPropStoreFieldValue("symbol",e)}})},getStructureRelatedPropNames:function($super){return $super().concat(["atomType","symbol"])},getPrimaryIsotope:function(){return null},getLabel:function(){return this.getSymbol()},doGetComparisonPropNames:function($super,e){var t=$super(e);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(e,"atom")&&t.push("atomType"),t},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"atom")&&this.getAtomType()===Kekule.PseudoatomType.CUSTOM){var r=this.getSymbol(),o=e.getSymbol&&e.getSymbol();n=this.doCompareOnValue(r,o,t)}return n},doMayContainElement:function(e){var t=Kekule.PseudoatomType,n=this.getAtomType();return n===t.ANY||n===t.HETERO&&(!([1,6].indexOf(e)>=0)&&"Nonmetals"===Kekule.ChemicalElementsDataUtil.getElementInfo(e).chemicalSerie)}}),Kekule.VariableAtom=Class.create(Kekule.AbstractAtom,{CLASS_NAME:"Kekule.VariableAtom",initProperties:function(){this.defineProp("allowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(e){var t=this.getPropStoreFieldValue("allowedIsotopeIds");return!t&&e&&(t=[],this.setPropStoreFieldValue("allowedIsotopeIds",t)),t}}),this.defineProp("disallowedIsotopeIds",{dataType:DataType.ARRAY,getter:function(e){var t=this.getPropStoreFieldValue("disallowedIsotopeIds");return!t&&e&&(t=[],this.setPropStoreFieldValue("disallowedIsotopeIds",t)),t}}),this.defineProp("allowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getAllowedIsotopeIds())}}),this.defineProp("disallowedIsotopes",{dataType:DataType.ARRAY,setter:null,getter:function(){return this._getIsotopesFromIds(this.getDisallowedIsotopeIds())}})},getStructureRelatedPropNames:function($super){return $super().concat(["allowedIsotopeIds","disallowedIsotopeIds"])},getPrimaryIsotope:function(){if(this.isDisallowedList())return null;var e=this.getAllowedIsotopeIds(),t=e?e[0]:null;return t?Kekule.IsotopeFactory.getIsotopeById(t):null},getLabel:function(){return Kekule.ChemStructureNodeLabels.VARIABLE_ATOM},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"atom")){var r=Kekule.ArrayUtils,o=this.getAllowedIsotopeIds(),i=e.getAllowedIsotopeIds&&e.getAllowedIsotopeIds();if(o)o=r.clone(o).sort(),i&&i.length&&(i=r.clone(i).sort()),n=this.doCompareOnValue(o,i,t);else if(i)n=1;else{var a=this.getDisallowedIsotopeIds(),s=e.getDisallowedIsotopeIds&&e.getDisallowedIsotopeIds();a&&a.length&&(a=r.clone(a).sort()),s&&s.length&&(s=r.clone(s).sort()),n=this.doCompareOnValue(a,s,t)}}return n},doMayContainElement:function(e){var t=function(e,t){if(!t)return!1;for(var n=0,r=t.length;n<r;++n){var o=t[n],i=Kekule.IsotopesDataUtil.getIsotopeIdDetail(o).symbol;if(Kekule.ChemicalElementsDataUtil.getAtomicNumber(i)===e)return!0}return!1},n=this.getAllowedIsotopeIds();return n?t(e,n):(n=this.getDisallowedIsotopeIds())?!t(e,n):void 0},isDisallowedList:function(){return this.getDisallowedIsotopeIds()&&!this.getAllowedIsotopeIds()},isListEmpty:function(){var e=this.getAllowedIsotopeIds(),t=!e||!e.length;return t&&(t=!(e=this.getDisallowedIsotopeIds())||!e.length),t},fetchAllowedIsotopeIds:function(){return this.doGetAllowedIsotopeIds(!0)},fetchDisallowedIsotopeIds:function(){return this.doGetDisallowedIsotopeIds(!0)},_getIsotopesFromIds:function(e){if(!e)return null;for(var t=[],n=0,r=e.length;n<r;++n){var o=e[n],i=Kekule.IsotopeFactory.getIsotopeById(o);i&&t.push(i)}return t}}),Kekule.MolecularFormula=Class.create(ObjectEx,{CLASS_NAME:"Kekule.MolecularFormula",initialize:function($super,e){$super(),this.setPropStoreFieldValue("sections",[]),e&&this.setPropStoreFieldValue("parent",e),this.setBubbleEvent(!0)},initProperties:function(){this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:!1,setter:null,scope:Class.PropertyScope.PUBLIC}),this.defineProp("sections",{dataType:DataType.ARRAY,setter:null}),this.defineProp("charge",{dataType:DataType.FLOAT,getter:function(){return this.getPropStoreFieldValue("charge")||0}}),this.defineProp("radical",{dataType:DataType.INT,getter:function(){return this.getPropStoreFieldValue("radical")||0}})},getHigherLevelObj:function(){return this.getParent()},isEmpty:function(){return this.getSectionCount()<=0},notifySectionsChanged:function(){this.notifyPropSet("sections",this.getPropStoreFieldValue("sections"))},createSectionItem:function(e,t,n){var r={obj:e,count:t||1};return n&&e.setCharge(n),e.setParent&&e.setParent(this.getParent()),r},getTotalCharge:function(){for(var e=0,t=this.getSections(),n=0,r=t.length;n<r;++n)t[n].obj.getCharge&&(e+=t[n].obj.getCharge()*(t.count||1));return this.getCharge()&&(e+=this.getCharge()),e},indexOfObj:function(e){for(var t=this.getSections(),n=0,r=t.length;n<r;++n)if(t[n].obj==e)return n;return-1},getSectionCount:function(){return this.getSections().length},getSectionAt:function(e){return this.getSections()[e]},getSectionCharge:function(e){var t,n=0;return(t="object"!=typeof e?this.getSectionAt(e):e).obj.getCharge&&(n+=t.obj.getCharge()||0),n},appendSection:function(e,t,n){var r=this.createSectionItem(e,t,n);return this.getSections().push(r),this.notifySectionsChanged(),r},insertSection:function(e,t,n,r){var o=this.createSectionItem(t,n,r);return this.getSections().splice(e,0,o),this.notifySectionsChanged(),o},removeSectionAt:function(e){var t=this.getSections().splice(e,1);return t&&this.notifySectionsChanged(),t},clear:function(){this.beginUpdate();try{this.setCharge(null),this.setRadical(null),this.setPropStoreFieldValue("sections",[]),this.notifySectionsChanged()}finally{this.endUpdate()}},removeObj:function(e){var t=this.indexOfObj(e);if(!(t>=0))return null;this.removeSectionAt(t);this.notifySectionsChanged()},getMaxNestedLevel:function(){for(var e=0,t=0,n=this.getSectionCount();t<n;++t){var r=this.getSectionAt(t);if(r.obj instanceof Kekule.MolecularFormula){var o=r.obj.getMaxNestedLevel()+1;o>e&&(e=o)}}return e},getSimpleIsotopeMaps:function(){}}),Kekule.StructureConnectionTable=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureConnectionTable",TRAVERS_VISITED_KEY:"__$ctabTraversVisited__",initialize:function($super,e,t){$super(),e&&this.setOwner(e),t&&this.setPropStoreFieldValue("parent",t)},initProperties:function(){this.defineProp("owner",{dataType:"Kekule.ChemSpace",serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:function(e){e!=this.getPropStoreFieldValue("owner")&&(this.setPropStoreFieldValue("owner",e),this.ownerChanged(e))}}),this.defineProp("parent",{dataType:"Kekule.StructureFragment",serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:function(e){e!=this.getPropStoreFieldValue("parent")&&(this.setPropStoreFieldValue("parent",e),this.parentChanged(e))}}),this.defineProp("nodes",{dataType:DataType.ARRAY}),this.defineProp("anchorNodes",{dataType:DataType.ARRAY,setter:null}),this.defineProp("connectors",{dataType:DataType.ARRAY}),this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){for(var e=[],t=0,n=this.getNodeCount();t<n;++t){var r=this.getNodeAt(t);r instanceof Kekule.ChemStructureNode&&(r.isHydrogenAtom&&r.isHydrogenAtom()||e.push(r))}return e}}),this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){for(var e=[],t=0,n=this.getConnectorCount();t<n;++t){var r=this.getConnectorAt(t);r.isNormalConnectorToHydrogen&&r.isNormalConnectorToHydrogen()||e.push(r)}return e}}),this.defineProp("structureCache",{dataType:DataType.HASH,serializable:!1,setter:null,getter:function(e){var t=this.getParent();return t&&t.getStructureCache(e)}})},initPropValues:function($super){$super(),this.setPropStoreFieldValue("nodes",[]),this.setPropStoreFieldValue("anchorNodes",[]),this.setPropStoreFieldValue("connectors",[])},getHigherLevelObj:function(){return this.getParent()||this.getOwner()},doSaveProp:function(e,t,n,r){var o=t.name;switch(o){case"anchorNodes":for(var i=[],a=0,s=e.getAnchorNodeCount();a<s;++a){var u=e.getAnchorNodeAt(a),l=e.indexOfNode(u);i.push(l)}var c=r.createChildStorageNode(n,r.propNameToStorageName(o),!0);return r.save(i,c),!0;case"connectors":for(c=r.createChildStorageNode(n,r.propNameToStorageName(o),!0),a=0,s=e.getConnectorCount();a<s;++a){var d=e.getConnectorAt(a),h=r.getNameForArrayItemStorageNode(d),C=r.appendArrayItemStorageNode(c,r.propNameToStorageName(h),r.isArray(d));r.setStorageNodeExplicitType(C,r.getValueExplicitType(d)),r.save(d,C);for(var f=[],g=0,p=d.getConnectedObjCount();g<p;++g){var m=d.getConnectedObjAt(g);if((l=e.indexOfChild(m))>=0)f.push(l);else{var k=e.indexStackOfChild(m);null!=k&&f.push(k)}}if(f.length){var A=r.createChildStorageNode(C,r.propNameToStorageName("connectedObjs"),!0);r.save(f,A)}}return!0;default:return!1}},doLoadProp:function(e,t,n,r){var o=t.name;switch(o){case"anchorNodes":var i=[],a=r.getChildStorageNode(n,r.propNameToStorageName(o));return r.load(i,a),e.__load_anchorNodes_indexes=i,!0;case"connectors":a=r.getChildStorageNode(n,r.propNameToStorageName(o));for(var s,u=r.getAllArrayItemStorageNodes(a),l=0,c=u.length;l<c;++l){var d=u[l],h=r.getStorageNodeExplicitType(d)||r.getStorageNodeName(d);if(h){s=DataType.createInstance(h),r.load(s,d);var C=r.getChildStorageNode(d,r.propNameToStorageName("connectedObjs"));if(C){var f=[];r.load(f,C),s.__load_connectedObj_indexes=f}var g=r.getChildStorageNode(d,r.propNameToStorageName("connectedNodes"));if(g){var p=[];r.load(p,g),s.__load_connectedNode_indexes=p}var m=r.getChildStorageNode(d,r.propNameToStorageName("connectedConnectors"));if(m){var k=[];r.load(k,m),s.__load_connectedConnector_indexes=k}e.appendConnector(s)}}return!0;default:return!1}},loaded:function($super){if(this.__load_anchorNodes_indexes){for(var e=0,t=this.__load_anchorNodes_indexes.length;e<t;++e){var n=this.__load_anchorNodes_indexes[e];this.appendAnchorNode(this.getNodeAt(n))}delete this.__load_anchorNodes_indexes}for(e=0,t=this.getConnectorCount();e<t;++e){var r=this.getConnectorAt(e);if(r.__load_connectedObj_indexes){for(var o=0,i=r.__load_connectedObj_indexes.length;o<i;++o){var a;(a="object"==typeof(n=r.__load_connectedObj_indexes[o])?this.getChildAtIndexStack(n):this.getChildAt(n))&&r.appendConnectedObj(a)}delete r.__load_connectedObj_indexes}if(r.__load_connectedNode_indexes){for(o=0,i=r.__load_connectedNode_indexes.length;o<i;++o){"object"==typeof(n=r.__load_connectedNode_indexes[o])?r.appendConnectedObj(this.getNodeAtIndexStack(n)):r.appendConnectedObj(this.getNodeAt(n))}delete r.__load_connectedNode_indexes}if(r.__load_connectedConnector_indexes){for(o=0,i=r.__load_connectedConnector_indexes.length;o<i;++o){n=r.__load_connectedConnector_indexes[o];r.appendConnectedObj(this.getConnectorAt(n))}delete r.__load_connectedConnector_indexes}}this.ownerChanged(this.getOwner()),this.parentChanged(this.getParent()),$super()},notifyNodesChanged:function(){this.notifyPropSet("nodes",this.getPropStoreFieldValue("nodes"))},notifyAnchorNodesChanged:function(){this.notifyPropSet("anchorNodes",this.getPropStoreFieldValue("anchorNodes"))},notifyConnectorsChanged:function(){this.notifyPropSet("connectors",this.getPropStoreFieldValue("connectors"))},ownerChanged:function(e){for(var t=0,n=this.getNodeCount();t<n;++t)this.getNodeAt(t).setOwner(e);for(t=0,n=this.getConnectorCount();t<n;++t)this.getConnectorAt(t).setOwner(e)},parentChanged:function($super,e,t){for(var n=0,r=this.getNodeCount();n<r;++n)this.getNodeAt(n).setParent(e);for(n=0,r=this.getConnectorCount();n<r;++n)this.getConnectorAt(n).setParent(e)},isEmpty:function(){return this.getNodeCount()<=0&&this.getConnectorCount()<=0},getStructureCacheData:function(e){var t=this.getStructureCache();return t&&t[e]},setStructureCacheData:function(e,t){var n=this.getParent();return n&&n.setStructureCacheData&&n.setStructureCacheData(e,t),this},clearStructureCache:function(){var e=this.getParent();return e&&e.clearStructureCache(),this},getNodeById:function(e){for(var t=this.getNodes(),n=0,r=t.length;n<r;++n)if(t[n].getId()==e)return t[n];return null},getConnectorById:function(e){for(var t=this.getConnectors(),n=0,r=t.length;n<r;++n)if(t[n].getId()==e)return t[n];return null},getObjectById:function(e){var t=this.getNodeById(e);return t||this.getConnectorById(e)},getNodeCount:function(){return this.getNodes().length},getNodeAt:function(e){return this.getNodes()[e]},indexOfNode:function(e){return this.getNodes().indexOf(e)},hasNode:function(e,t){var n=this.indexOfNode(e)>=0;if(!n&&t)for(var r=0,o=this.getNodeCount();r<o;++r){var i=this.getNodeAt(r);if(i.hasNode&&(n=i.hasNode(e,!0)),n)break}return n},indexStackOfNode:function(e){var t=this.indexOfNode(e);if(t>=0)return t;for(var n=null,r=0,o=this.getNodeCount();r<o;++r){var i=this.getNodeAt(r);if(i.indexStackOfNode&&(n=i.indexStackOfNode(e),!Kekule.ObjUtils.isUnset(n)))return"object"!=typeof n&&(n=[n]),n.unshift(r),n}return n},getNodeAtIndexStack:function(e){if((e=Kekule.ArrayUtils.toArray(e)).length<=0)return null;for(var t=this.getNodeAt(e[0]),n=1,r=e.length;n<r;++n){if(!t||!t.getNodeAt)return null;t=t.getNodeAt(e[n])}return t},insertNodeBefore:function(e,t){var n=this.indexOfNode(t);n?this.insertNodeAt(e,n):this.appendNode(e)},appendNode:function(e){var t=Kekule.ArrayUtils.pushUniqueEx(this.getNodes(),e);return t.isPushed&&(e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent()),this.notifyNodesChanged()),t.index},insertNodeAt:function(e,t){var n=this.indexOfNode(e),r=this.getNodes();return(Kekule.ObjUtils.isUnset(t)||t<0)&&(t=r.length),n>=0?(r.splice(n,1),r.splice(t,0,e)):(r.splice(t,0,e),e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent())),this.notifyNodesChanged(),t},setNodeIndex:function(e,t){var n=this.getNodes(),r=this.indexOfNode(e);r>=0&&(n.splice(r,1),n.splice(t,0,e))},removeNodeAt:function(e,t){var n=this.getNodes()[e];n&&(t||n.removeThisFromLinkedConnector(),this.getNodes().splice(e,1),n.setOwner&&n.setOwner(null),n.setParent&&n.setParent(null),this.notifyNodesChanged())},removeNode:function(e,t){var n=this.getNodes().indexOf(e);n>=0&&this.removeNodeAt(n,t)},replaceNode:function(e,t){if(!this.hasNode(e))return this;this.insertBefore(t,e);var n=this.getAnchorNodes(),r=n.indexOf(e);r>=0&&n.splice(r,1,[t]);for(var o=Kekule.ArrayUtils.clone(e.getLinkedConnectors()),i=0,a=o.length;i<a;++i){(u=o[i]).replaceConnectedObj(e,t)}if(e.getNodes&&e.getCrossConnectors){var s=Kekule.ArrayUtils.clone(e.getCrossConnectors());for(i=0,a=s.length;i<a;++i){var u=s[i];if(this.indexOfConnector(u)>=0)for(var l=0,c=u.getConnectedObjCount();l<c;++l){var d=u.getConnectedObjAt(l);e.indexOfChild(d)>=0&&u.replaceConnectedObj(d,t)}u.replaceConnectedObj(e,t)}}this.removeNode(e)},clearNodes:function(){this.clearAnchorNodes(),this.setPropStoreFieldValue("nodes",[]),this.notifyAnchorNodesChanged(),this.notifyNodesChanged()},sortNodes:function(e){e?(this.getNodes().sort(e),this.notifyNodesChanged()):Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))},nodesHasCoord2D:function(e){for(var t=this.getNodes(),n=0,r=t.length;n<r;++n)if(t[n].hasCoord2D(e))return!0;return!1},nodesHasCoord3D:function(e){for(var t=this.getNodes(),n=0,r=t.length;n<r;++n)if(t[n].hasCoord3D(e))return!0;return!1},_createAtom:function(e,t,n,r){return new Kekule.Atom(null,e,t,n,r)},appendAtom:function(e,t,n,r){var o=this._createAtom(e,t,n,r);return o&&this.appendNode(o),o},getAnchorNodeCount:function(){return this.getAnchorNodes().length},indexOfAnchorNode:function(e){return this.getAnchorNodes().indexOf(e)},getAnchorNodeAt:function(e){return this.getAnchorNodes()[e]},appendAnchorNode:function(e){if(!e)return-1;if(this.getNodes().indexOf(e)>=0){var t=Kekule.ArrayUtils.pushUniqueEx(this.getAnchorNodes(),e);return t.isPushed&&this.notifyAnchorNodesChanged(),t.index}return-1},removeAnchorNodeAt:function(e){this.getAnchorNodes()[e]&&(this.getAnchorNodes().splice(e,1),this.notifyAnchorNodesChanged())},removeAnchorNode:function(e){var t=this.getAnchorNodes().indexOf(e);t>=0&&this.removeAnchorNodeAt(t)},clearAnchorNodes:function(){this.setPropStoreFieldValue("anchorNodes",[]),this.notifyAnchorNodesChanged()},getConnectorCount:function(){return this.getConnectors().length},indexOfConnector:function(e){return this.getConnectors().indexOf(e)},getConnectorAt:function(e){return this.getConnectors()[e]},indexStackOfConnector:function(e){var t=this.indexOfConnector(e);if(t>=0)return t;for(var n=null,r=0,o=this.getNodeCount();r<o;++r){var i=this.getNodeAt(r);if(i.indexStackOfConnector&&(n=i.indexStackOfConnector(e),!Kekule.ObjUtils.isUnset(n)))return"object"!=typeof n&&(n=[n]),n.unshift(r),n}return n},getConnectorAtIndexStack:function(e){if((e=Kekule.ArrayUtils.toArray(e)).length<=0)return null;if(1===e.length)return this.getConnectorAt(e[0]);for(var t=e.length-1,n=this.getNodeAt(e[0]),r=1;r<t;++r){if(!n||!n.getNodeAt)return null;n=n.getNodeAt(e[r])}return n?n.getConnectorAt(e[t]):null},insertConnectorBefore:function(e,t){var n=this.indexOfConnector(t);n?this.insertConnectorAt(e,n):this.appendConnector(e)},appendConnector:function(e){var t=Kekule.ArrayUtils.pushUniqueEx(this.getConnectors(),e);return t.isPushed&&(e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent()),this.notifyConnectorsChanged()),t.index},insertConnectorAt:function(e,t){var n=this.indexOfConnector(e),r=this.getConnectors();(Kekule.ObjUtils.isUnset(t)||t<0)&&(t=r.length),n>=0?(r.splice(n,1),r.splice(t,0,e)):(r.splice(t,0,e),e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this.getParent())),this.notifyConnectorsChanged()},setConnectorIndex:function(e,t){var n=this.getConnectors(),r=this.indexOfConnector(e);r>=0&&(n.splice(r,1),n.splice(t,0,e))},removeConnectorAt:function(e,t){var n=this.getConnectors()[e];n&&(t||n.removeThisFromConnectedObjs(),this.getConnectors().splice(e,1),n.setOwner&&n.setOwner(null),n.setParent&&n.setParent(null),this.notifyConnectorsChanged())},removeConnector:function(e,t){var n=this.getConnectors().indexOf(e);n>=0&&this.removeConnectorAt(n,t)},clearConnectors:function(){this.setPropStoreFieldValue("connectors",[]),this.notifyConnectorsChanged()},hasConnector:function(e,t){var n=this.indexOfConnector(e)>=0;if(!n&&t)for(var r=0,o=this.getNodeCount();r<o;++r){var i=this.getNodeAt(r);if(i.hasConnector&&(n=i.hasConnector(e,!0)),n)break}return n},sortConnectors:function(e){e?(this.getConnectors().sort(e),this.notifyConnectorsChanged()):Kekule.error(Kekule.$L("ErrorMsg.SORT_FUNC_UNSET"))},_createBond:function(e,t,n){for(var r=[],o=0,i=e.length;o<i;++o){var a=e[o];DataType.isSimpleValue(a)&&(a=this.getNodeAt(a)),r.push(a)}return new Kekule.Bond(null,r,t,null,n)},appendBond:function(e,t,n){var r=this._createBond(e,t,n);return r&&this.appendConnector(r),r},_getObjsNeedToBeCascadeRemoved:function(e,t){for(var n=[],r=e.getLinkedConnectors?e.getLinkedConnectors():[],o=0,i=r.length;o<i;++o){var a=r[o];(!t||t.indexOf(a)<0)&&a.getConnectedObjs().length<=2&&Kekule.ArrayUtils.pushUnique(n,a)}if(e instanceof Kekule.ChemStructureNode);else if(e instanceof Kekule.ChemStructureConnector){var s=e.getConnectedObjs();for(o=0,i=s.length;o<i;++o){var u=s[o];(!t||t.indexOf(u)<0)&&u instanceof Kekule.ChemStructureNode&&u.getLinkedConnectors().length<=1&&Kekule.ArrayUtils.pushUnique(n,u)}}var l=[].concat(n);l.push(e);var c=[];for(o=0,i=n.length;o<i;++o){if((u=n[o])!==e)var d=this._getObjsNeedToBeCascadeRemoved(u,l);Kekule.ArrayUtils.pushUnique(c,d)}return Kekule.ArrayUtils.pushUnique(n,c),n},removeChildObj:function(e,t,n){var r;t?(r=this._getObjsNeedToBeCascadeRemoved(e),Kekule.ArrayUtils.pushUnique(r,e)):r=[e];for(var o=0,i=r.length;o<i;++o){(a=r[o])instanceof Kekule.BaseStructureConnector?this.removeConnector(a):a instanceof Kekule.BaseStructureNode&&this.removeNode(a)}if(n)for(o=r.length-1;o>=0;--o){var a;(a=r[o]).finalize&&a.finalize()}},removeChild:function($super,e){return this.removeChildObj(e)||$super(e)},deleteChildObj:function(e,t){return this.removeChildObj(e,t,!0)},hasChildObj:function(e){return this.hasNode(e)||this.hasConnector(e)},getNextSiblingOfChild:function(e){if(e instanceof Kekule.SimpleStructureNode){if((t=this.indexOfNode(e))>=0)return this.getNodeAt(t+1)}else if(e instanceof Kekule.BaseStructureConnector){var t;if((t=this.indexOfConnector(e))>=0)return this.getConnectorAt(t+1)}return null},insertBefore:function(e,t){if(e instanceof Kekule.SimpleStructureNode){var n=this.indexOfNode(t);return this.insertNodeAt(e,n)}if(e instanceof Kekule.BaseStructureConnector){n=this.indexOfConnector(t);return this.insertConnectorAt(e,n)}return-1},clear:function(){this.clearNodes(),this.clearConnectors()},getChildCount:function(){return this.getNodeCount()+this.getConnectorCount()},getChildAt:function(e){var t=this.getNodeCount();return e<t?this.getNodeAt(e):e<t+this.getConnectorCount()?this.getConnectorAt(e-t):null},indexOfChild:function(e){var t;if(e instanceof Kekule.BaseStructureNode)t=this.indexOfNode(e);else if(e instanceof Kekule.BaseStructureConnector){if((t=this.indexOfConnector(e))>=0)t+=this.getNodeCount()}else t=-1;return t},indexStackOfChild:function(e){var t;if(e instanceof Kekule.BaseStructureNode)t=this.indexStackOfNode(e);else if(e instanceof Kekule.BaseStructureConnector){var n=this.getNodeCount();(t=this.indexStackOfConnector(e)).length?t[t.length-1]+=n:t+=n}else t=-1;return t},getChildAtIndexStack:function(e){if((e=Kekule.ArrayUtils.toArray(e)).length<=0)return null;for(var t=this.getChildAt(e[0]),n=1,r=e.length;n<r;++n){if(!t||!t.getChildAt)return null;t=t.getChildAt(e[n])}return t},isSubFragment:function(e){return e.getNodeCount&&e.getNodeCount()>0},getSubFragments:function(){for(var e=[],t=0,n=this.getNodeCount();t<n;++t){var r=this.getNodeAt(t);this.isSubFragment(r)&&e.push(r)}return e},hasSubFragments:function(){var e=this.getSubFragments();return e&&e.length},getLeafNodes:function(){for(var e=[],t=0,n=this.getNodeCount();t<n;++t){var r=this.getNodeAt(t);if(this.isSubFragment(r)){if(r.getLeafNodes){var o=r.getLeafNodes();e=e.concat(o)}}else e.push(r)}return e},findDirectChildOfObj:function(e){for(var t=e;t&&this.indexOfChild(t)<0;)t=t.getParent?t.getParent():null;return t},getAllChildConnectors:function(){for(var e=[].concat(this.getConnectors()),t=this.getSubFragments(),n=0,r=t.length;n<r;++n)t[n].getAllChildConnectors&&(e=e.concat(t[n].getAllChildConnectors()));return e},getAllContainingConnectors:function(){return this.getAllChildConnectors()},getIsotopeMaps:function(){var e=this.getNodes();if(e.length<=0)return[];for(var t=function(e,t,n,r){for(var o=!1,a=0,s=e.length;a<s;++a)t.isSame(e[a].isotope)&&(o=!0,e[a].count+=n,e[a].charge+=r||0);if(!o){var u={isotope:t,count:n,charge:i.getCharge()||0};e.push(u)}return e},n=[],r=0,o=e.length;r<o;++r){var i=e[r];if(i instanceof Kekule.StructureFragment){var a=i.getIsotopeMaps();for(r=0,o=a.length;r<o;++r)n=t(n,a[r].isotope,a[r].count,a[r].charge||0)}else if(i instanceof Kekule.Atom){i.getIsotope();n=t(n,i.getIsotope(),1,i.getCharge()||0);var s=i.getHydrogenCount();if(s>0)n=t(n,Kekule.IsotopeFactory.getIsotope(1),s,0)}}return n},calcFormula:function(){var e=this.getIsotopeMaps();if(e.length<=0)return null;for(var t=new Kekule.MolecularFormula,n=0,r=e.length;n<r;++n){var o=new Kekule.Atom;o.setIsotope(e[n].isotope),t.appendSection(o,e[n].count,e[n].charge)}return t},getNodesContainBox:function(e,t,n){for(var r=t===Kekule.CoordMode.COORD3D,o={},i=0,a=e.length;i<a;++i){var s=e[i].getAbsCoordOfMode(t,n);0==i?(o.x1=o.x2=s.x,o.y1=o.y2=s.y,r&&(o.z1=o.z2=s.z)):(s.x<o.x1?o.x1=s.x:s.x>o.x2&&(o.x2=s.x),s.y<o.y1?o.y1=s.y:s.y>o.y2&&(o.y2=s.y),r&&(s.z<o.z1?o.z1=s.z:s.z>o.z2&&(o.z2=s.z)))}return o},getContainerBox:function(e,t){return this.getNodesContainBox(this.getNodes(),e,t)},getContainerBox2D:function(e){var t=this.getContainerBox(Kekule.CoordMode.COORD2D,e);return t.width=t.x2-t.x1,t.height=t.y2-t.y1,t},getContainerBox3D:function(e){var t=this.getContainerBox(Kekule.CoordMode.COORD3D,e);return t.deltaX=t.x2-t.x1,t.deltaY=t.y2-t.y1,t.deltaZ=t.z2-t.z1,t},traverse:function(t,n,r,o){for(var i={nodes:[],connectors:[]},a=e.clone(o||this.getNodes()),s=0,u=a.length;s<u;++s)a[s][this.TRAVERS_VISITED_KEY]=!1;for(;a.length;){var l;l=n&&a.indexOf(n)>=0?n:a[0];var c=this._doTravers(t,l,r,o);i.nodes=i.nodes.concat(c.nodes),i.connectors=i.connectors.concat(c.connectors),a=e.exclude(a,c.nodes)}return i},_doTravers:function(t,n,r,o){var i={nodes:[],connectors:[]},a=n;a[this.TRAVERS_VISITED_KEY]||(i.nodes.push(a),a[this.TRAVERS_VISITED_KEY]=!0,t&&t(a,!1));var s=e.clone(a.getLinkedConnectors()),u=this.getConnectors();s.sort(function(e,t){return u.indexOf(e)-u.indexOf(t)});for(var l=[],c=0,d=s.length;c<d;++c){var h=s[c],C=a.getLinkedObjsOnConnector(h);o&&(C=e.intersect(C,o));for(var f=0,g=C.length;f<g;++f){var p=C[f];if(p instanceof Kekule.BaseStructureNode)break}if(p&&!p[this.TRAVERS_VISITED_KEY])if(i.nodes.push(p),i.connectors.push(h),p[this.TRAVERS_VISITED_KEY]=!0,t&&(t(h,!0),t(p,!1)),r)l.push(p);else{var m=this._doTravers(t,p,r,o);i.nodes=i.nodes.concat(m.nodes),i.connectors=i.connectors.concat(m.connectors)}}if(r)for(c=0,d=l.length;c<d;++c){var k=l[c];m=this._doTravers(t,k,r,o);i.nodes=i.nodes.concat(m.nodes),i.connectors=i.connectors.concat(m.connectors)}return i}}),Kekule.StructureFragment=Class.create(Kekule.ChemStructureNode,{CLASS_NAME:"Kekule.StructureFragment",initialize:function($super,e,t,n){$super(e,t,n)},doFinalize:function($super){this.hasFormula()&&this.getFormula().finalize(),this.hasCtab()&&this.getCtab().finalize(),$super()},initProperties:function(){this.defineProp("formula",{dataType:"Kekule.MolecularFormula",getter:function(e){return this.getPropStoreFieldValue("formula")||e&&this.createFormula(),this.getPropStoreFieldValue("formula")},setter:function(e){var t=this.getPropStoreFieldValue("formula");t&&(t.finalize(),t=null),e&&(e.setPropValue("parent",this,!0),e.addEventListener("change",function(e){this.notifyPropSet("formula",this.getFormula())},this)),this.setPropStoreFieldValue("formula",e)}}),this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",getter:function(e){return this.getPropStoreFieldValue("ctab")||e&&this.createCtab(),this.getPropStoreFieldValue("ctab")},setter:function(e){var t=this.getPropStoreFieldValue("ctab");t&&(t.finalize(),t=null),e&&(e.setPropValue("parent",this,!0),e.setOwner(this.getOwner()),e.addEventListener("propValueSet",function(e){"nodes"!=e.propName&&"anchorNodes"!=e.propName&&"connectors"!=e.propName||this.notifyPropSet(e.propName,e.propValue)},this),e.setEnablePropValueSetEvent(!0)),this.setPropStoreFieldValue("ctab",e)}}),this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}}),this.defineProp("anchorNodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getAnchorNodes():[]}}),this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}}),this.defineProp("crossConnectors",{dataType:DataType.ARRAY,serializable:!1,setter:null,scope:Class.PropertyScope.PUBLIC,getter:function(){for(var e=[].concat(this.getPropStoreFieldValue("linkedConnectors")),t=0,n=this.getNodeCount();t<n;++t)for(var r=this.getNodeAt(t).getLinkedConnectors()||[],o=0,i=r.length;o<i;++o)this.indexOfConnector(r[o])<0&&Kekule.ArrayUtils.pushUnique(e,r[o]);return e}}),this.defineProp("nonHydrogenNodes",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenNodes():[]}}),this.defineProp("nonHydrogenConnectors",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNonHydrogenConnectors():[]}}),this.defineProp("canonicalizationInfo",{dataType:DataType.OBJECT,serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getStructureCacheData("canonicalizationInfo")},setter:function(e){this.setStructureCacheData("canonicalizationInfo",e)}}),this.defineProp("aromaticRings",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,getter:function(){var e=this.getStructureCacheData("aromaticRings");return e||(e=[],this.setStructureCacheData("aromaticRings",e)),e},setter:function(e){this.setStructureCacheData("aromaticRings",e)}}),this.defineProp("flattenedShadow",{dataType:"Kekule.StructureFragmentShadow",serializable:!1,scope:Class.PropertyScope.PRIVATE,getter:function(e){var t=null;if(Kekule.ObjUtils.isUnset(e)&&(e=!0),this.getFlattenedShadowOnSelf())return null;if(!(t=this.getPropStoreFieldValue("flattenedShadow"))&&e){var n=(t=new Kekule.StructureFragmentShadow(this)).getShadowFragment();n.unmarshalAllSubFragments(!0),this._copyAdditionalInfoToShadowFragment(n,t.getSourceToShadowMap(),t.getShadowToSourceMap()),this.setPropStoreFieldValue("flattenedShadow",t)}return t}}),this.defineProp("flattenedShadowOnSelf",{dataType:DataType.BOOL,serializable:!1,scope:Class.PropertyScope.PROVATE,setter:null,getter:function(){var e=this.setPropStoreFieldValue("flattenedShadowOnSelf");return Kekule.ObjUtils.isUnset(e)&&(e=!this.hasSubFragments(),this.setPropStoreFieldValue("flattenedShadowOnSelf",e)),e}})},getAutoIdPrefix:function(){return"f"},getStructureRelatedPropNames:function($super){return $super().concat(["ctab","formula","nodes","anchorNodes","connectors"])},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){var r=this.hasCtab(),o=e.hasCtab&&e.hasCtab();if(!(n=r?o?0:1:o?-1:0)){var i=this.hasFormula(),a=e.hasFormula&&e.hasFormula();n=i?a?0:1:a?-1:0}if(!n&&this.hasCtab()){if(0===n&&this.getNonHydrogenNodes&&e.getNonHydrogenNodes){var s=function(e,t){var n;e instanceof Kekule.ChemStructureConnector?n=e.getConnectedNonHydrogenObjs():e instanceof Kekule.ChemStructureNode&&(n=e.getLinkedNonHydrogenObjs());for(var r=[],o=0,i=n.length;o<i;++o){var a=n[o],s=t.indexOfNode(a);s>=0&&r.push(s)}return r.sort(),r},u=this.getNonHydrogenNodes(),l=e.getNonHydrogenNodes();if(0===(n=u.length-l.length))for(var c=0,d=u.length;c<d&&0===(n=this.doCompareOnValue(u[c],l[c],t));++c){var h=s(u[c],this),C=s(l[c],e);if(0!==(n=Kekule.ArrayUtils.compare(h,C)))break}}if(0===n&&this.getConnectors&&e.getConnectors){var f=this.getNonHydrogenConnectors(),g=e.getNonHydrogenConnectors();if(0===(n=f.length-g.length))for(c=0,d=f.length;c<d&&0===(n=this.doCompareOnValue(f[c],g[c],t));++c){h=s(f[c],this),C=s(g[c],e);if(0!==(n=Kekule.ArrayUtils.compare(h,C)))break}}if(0===n){var p=this.getNonHydrogenNodes(),m=e.getNonHydrogenNodes(),k=this.traverse(null,p[p.length-1],!0,p),A=e.traverse(null,m[m.length-1],!0,m);for(c=0,d=k.nodes.length;c<d;++c){var S=k.nodes[c],O=A.nodes[c];if(0!==(n=this.doCompareOnValue(S,O,t)))break}if(0===n)for(c=0,d=k.connectors.length;c<d;++c){var T=k.connectors[c],b=A.connectors[c];if(0!==(n=this.doCompareOnValue(T,b,t)))break}}}}return n},structureChange:function($super,e){this.setPropStoreFieldValue("flattenedShadowOnSelf",null);var t=this.getFlattenedShadow(!1);t&&(t.finalize(),this.setPropStoreFieldValue("flattenedShadow",null)),$super(e)},clearStructureFlags:function($super){$super();for(var e=0,t=this.getChildCount();e<t;++e){var n=this.getChildAt(e);n.clearStructureFlags&&n.clearStructureFlags()}},ownerChanged:function($super,e,t){this.hasCtab()&&this.getCtab().setOwner(e),$super(e,t)},_removeChildObj:function($super,e){if(this.hasFormula())this.getFormula()===e&&this.removeFormula();else if(this.hasCtab()){var t=this.getCtab();t===e?this.removeCtab():t.hasChildObj(e)&&t.removeChildObj(e)}$super(e)},isEmpty:function(){var e;return(e=!this.hasFormula())&&((e=!this.hasCtab())||(e=this.getCtab().isEmpty())),e},isCtabEmpty:function(){return!this.hasCtab()||this.getCtab().isEmpty()},doGetLinkedConnectors:function(){return this.getCrossConnectors()},appendLinkedConnector:function($super,e){var t=this.getCurrConnectableObj();return t&&t!==this?t.appendLinkedConnector(e):$super(e)},getCurrConnectableObj:function(){var e=this.getAnchorNodeCount()>0?this.getAnchorNodes():this.getNodes();if(e.length<=0)return this;for(var t=this.getCrossConnectors(),n=null,r=null,o=0,i=e.length;o<i;++o){var a=e[o],s=a.getLinkedConnectors(),u=Kekule.ArrayUtils.intersect(s,t).length;(null===n||n>u)&&(n=u,r=a)}return r},createCtab:function(){var e=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setCtab(e)},createFormula:function(){var e=new Kekule.MolecularFormula(this);this.setFormula(e)},hasCtab:function(){return!!this.getPropStoreFieldValue("ctab")},hasFormula:function(){return!!this.getPropStoreFieldValue("formula")},removeFormula:function(){var e=this.getPropStoreFieldValue("formula");return e&&(e.finalize(),e=null,this.setPropStoreFieldValue("formula",null)),this},removeCtab:function(){var e=this.getPropStoreFieldValue("ctab");return e&&(e.finalize(),e=null,this.setPropStoreFieldValue("ctab",null)),this},getContainerBox:function($super,e,t){return this.hasCtab()?this.getCtab().getContainerBox(e,t):$super(e)},getNodeById:function(e){return this.hasCtab()?this.getCtab().getNodeById(e):null},getConnectorById:function(e){return this.hasCtab()?this.getCtab().getConnectorById(e):null},getObjectById:function(e){var t=this.getNodeById(e);return t||this.getConnectorById(e)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(e){return this.hasCtab()?this.getCtab().getNodeAt(e):null},indexOfNode:function(e){return this.hasCtab()?this.getCtab().indexOfNode(e):-1},hasNode:function(e,t){return this.hasCtab()?this.getCtab().hasNode(e,t):null},indexStackOfNode:function(e){return this.hasCtab()?this.getCtab().indexStackOfNode(e):-1},getNodeAtIndexStack:function(e){return this.hasCtab()?this.getCtab().getNodeAtIndexStack(e):null},getDirectChildOfNestedNode:function(e){var t=e.getParent();if(t){if(t===this)return t;for(var n=e;t&&t.getParent&&t!==this;)n=t,t=t.getParent();return t===this?n:null}return null},insertNodeBefore:function(e,t){return this.doGetCtab(!0).insertNodeBefore(e,t)},appendNode:function(e){return this.doGetCtab(!0).appendNode(e)},insertNodeAt:function(e,t){return this.doGetCtab(!0).insertNodeAt(e,t)},removeNodeAt:function(e,t){return this.hasCtab()?this.getCtab().removeNodeAt(e,t):null},removeNode:function(e,t){return this.hasCtab()?this.getCtab().removeNode(e,t):null},replaceNode:function(e,t){return this.hasCtab()?this.getCtab().replaceNode(e,t):null},clearNodes:function(){if(this.hasCtab())return this.getCtab().clearNodes()},sortNodes:function(e){if(this.hasCtab())return this.getCtab().sortNodes(e)},nodesHasCoord2D:function(e){return!!this.hasCtab()&&this.getCtab().nodesHasCoord2D(e)},nodesHasCoord3D:function(e){return!!this.hasCtab()&&this.getCtab().nodesHasCoord3D(e)},isNodeInAromaticRing:function(e){for(var t=this.getAromaticRings(),n=0,r=t.length;n<r;++n){if(t[n].nodes.indexOf(e)>=0)return!0}return!1},appendAtom:function(e,t,n,r){return this.doGetCtab(!0).appendAtom(e,t,n,r)},getAnchorNodeCount:function(){return this.hasCtab()?this.getCtab().getAnchorNodeCount():0},getAnchorNodeAt:function(e){return this.hasCtab()?this.getCtab().getAnchorNodeAt(e):null},indexOfAnchorNode:function(e){return this.hasCtab()?this.getCtab().indexOfAnchorNode(e):-1},appendAnchorNode:function(e){return this.doGetCtab(!0).appendAnchorNode(e)},removeAnchorNodeAt:function(e){return this.hasCtab()?this.getCtab().removeAnchorNodeAt(e):null},removeAnchorNode:function(e){return this.hasCtab()?this.getCtab().removeAnchorNode(e):null},clearAnchorNodes:function(){if(this.hasCtab())return this.getCtab().clearAnchorNodes()},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(e){return this.hasCtab()?this.getCtab().getConnectorAt(e):null},indexOfConnector:function(e){return this.hasCtab()?this.getCtab().indexOfConnector(e):-1},hasConnector:function(e,t){return this.hasCtab()?this.getCtab().hasConnector(e,t):null},insertConnectorBefore:function(e,t){return this.doGetCtab(!0).insertConnectorBefore(e,t)},appendConnector:function(e){return this.doGetCtab(!0).appendConnector(e)},insertConnectorAt:function(e,t){return this.doGetCtab(!0).insertConnectorAt(e,t)},removeConnectorAt:function(e,t){return this.hasCtab()?this.getCtab().removeConnectorAt(e,t):null},removeConnector:function(e,t){return this.hasCtab()?this.getCtab().removeConnector(e,t):null},clearConnectors:function(){if(this.hasCtab())return this.getCtab().clearConnectors()},sortConnectors:function(e){if(this.hasCtab())return this.getCtab().sortConnectors(e)},isConnectorInAromaticRing:function(e){for(var t=this.getAromaticRings(),n=0,r=t.length;n<r;++n){if(t[n].connectors.indexOf(e)>=0)return!0}return!1},appendBond:function(e,t,n){return this.doGetCtab(!0).appendBond(e,t,n)},_getObjsNeedToBeCascadeRemoved:function(e,t){return this.hasCtab()?this.getCtab()._getObjsNeedToBeCascadeRemoved(e,t):[]},removeChildObj:function(e,t,n){this.hasCtab()&&this.getCtab().removeChildObj(e,t,n)},hasChildObj:function(e){return!!this.hasCtab()&&this.getCtab().hasChildObj(e)},getNextSiblingOfChild:function($super,e){return this.hasCtab()&&this.getCtab().getNextSiblingOfChild(e)||$super(e)},getChildSubgroupNames:function($super){return["node","connector"].concat($super())},getBelongChildSubGroupName:function($super,e){return e instanceof Kekule.SimpleStructureNode?"node":e instanceof Kekule.BaseStructureConnector?"connector":$super(e)},isSubFragment:function(e){return e.getNodeCount&&e.getNodeCount()>0},getSubFragments:function(){return this.hasCtab()?this.getCtab().getSubFragments():[]},hasSubFragments:function(){return!!this.hasCtab()&&this.getCtab().hasSubFragments()},getLeafNodes:function(){return this.hasCtab()?this.getCtab().getLeafNodes():[]},findDirectChildOfObj:function(e){return this.hasCtab()?this.getCtab().findDirectChildOfObj(e):null},getAllChildConnectors:function(){return this.hasCtab()?this.getCtab().getAllChildConnectors():[]},getAllContainingConnectors:function(){return this.hasCtab()?this.getCtab().getAllContainingConnectors():[]},getIsotopeMaps:function(){return this.hasCtab()?this.getCtab().getIsotopeMaps():[]},clear:function(){this.hasCtab()&&this.setCtab(void 0),this.hasFormula()&&this.setFormula(void 0)},clean:function(e){var t=Object.extend({},Kekule.globalOptions.algorithm.structureClean.structureCleanOptions);return t=Object.extend(t,e||{}),this.doClean(t)},doClean:function(e){if(e.hangingChemConnector)for(var t=this.getConnectorCount()-1;t>=0;--t){var n=this.getConnectorAt(t);n instanceof Kekule.ChemStructureConnector&&n.getConnectedObjCount()<2&&this.removeConnectorAt(t)}var r=this.getNodeCount();for(t=r-1;t>=0;--t){var o=this.getNodeAt(t);o instanceof Kekule.ChemStructureNode&&(this.isSubFragment(o)&&o.doClean?o.doClean(e):e.orphanChemNode&&o.getLinkedConnectorCount()<1&&r>1&&this.removeNodeAt(t))}return this},clearExplicitHydrogens:function(){for(var e=this,t=function(t,n){for(var r=t.getLinkedConnectors(),o=r.length;o>=0;--o){var i=r[o];e.hasConnector(i,!0)&&e.removeConnector(i,!1)}e.removeNodeAt(n,!1)},n=this.getNodeCount()-1;n>=0;--n){var r=this.getNodeAt(n);r instanceof Kekule.ChemStructureNode&&(this.isSubFragment(r)&&r.clearExplicitHydrogens?(r.clearExplicitHydrogens(),r.getNodeCount()<=0&&t(r,n)):r.isHydrogenAtom()&&t(r,n))}return this},calcFormula:function(){return this.hasCtab()?this.getCtab().calcFormula():this.hasFormula()?this.getFormula():null},marshalSubFragment:function(e,t){if(this.hasCtab()){this.beginUpdate();try{this.appendNode(t);for(var n=[],r=[],o=[],i=[],a=0,s=e.length;a<s;++a){var u=e[a];if(!(this.indexOfNode(u)<0)){for(var l=!1,c=u.getLinkedConnectors(),d=0,h=c.length;d<h;++d){for(var C=c[d],f=!1,g=C.getConnectedObjs(),p=0,m=g.length;p<m;++p){var k=g[p];k!=u&&e.indexOf(k)<0&&(l=!0,f=!0)}f?Kekule.ArrayUtils.pushUnique(i,C):Kekule.ArrayUtils.pushUnique(o,C)}Kekule.ArrayUtils.pushUnique(n,u),l&&Kekule.ArrayUtils.pushUnique(r,u)}}for(a=o.length-1;a>=0;--a)this.removeConnector(o[a],!0);for(a=n.length-1;a>=0;--a)this.removeNode(n[a],!0);t.beginUpdate();try{for(a=0,s=n.length;a<s;++a)t.appendNode(n[a]);for(a=0,s=r.length;a<s;++a)t.appendAnchorNode(r[a]);for(a=0,s=o.length;a<s;++a)t.appendConnector(o[a])}finally{t.endUpdate()}}finally{this.endUpdate()}return t}return null},unmarshalSubFragment:function(e,t){if(this.hasCtab()){this.beginUpdate();try{e.beginUpdate();try{t&&e.unmarshalAllSubFragments&&e.unmarshalAllSubFragments(t);var n=this.getCtab();Kekule.StructureFragment.moveChildBetweenStructFragment(e,this,e.getNodes(),e.getConnectors(),!0),e.clear(),n.removeNode(e)}finally{e.endUpdate(),e.finalize()}}finally{this.endUpdate()}}},unmarshalAllSubFragments:function(e){var t=this.getSubFragments();if(t)for(var n=0,r=t.length;n<r;++n)this.unmarshalSubFragment(t[n],e)},recalcCoords:function(){if(this.hasCtab()){this.beginUpdate();try{for(var e={},t={},n=this.getAnchorNodeCount(),r=0,o=n;r<o;++r){var i=this.getAnchorNodeAt(r);e=Kekule.CoordUtils.add(e,i.getCoord2D()||{}),t=Kekule.CoordUtils.add(t,i.getCoord3D()||{})}var a=Kekule.ObjUtils.notUnset,s=a(e.x)||a(e.y),u=a(t.x)||a(t.y)||a(t.z);if(s){var l=Kekule.CoordUtils.substract({},e);this.setCoord2D(Kekule.CoordUtils.substract(this.fetchCoord2D(),l))}if(u){var c=Kekule.CoordUtils.substract({},t);this.setCoord3D(Kekule.CoordUtils.substract(this.fetchCoord3D(),c))}for(r=0,o=this.getNodeCount();r<o;++r){i=this.getNodeAt(r);s&&i.setCoord2D(Kekule.CoordUtils.add(i.fetchCoord2D(),l)),u&&i.setCoord3D(Kekule.CoordUtils.add(i.fetchCoord3D(),c))}}finally{this.endUpdate()}}},_copyAdditionalInfoToShadowFragment:function(e,t,n){var r=this.getAromaticRings();if(r&&r.length){for(var o=[],i=0,a=r.length;i<a;++i){for(var s=r[i],u=[],l=[],c=0,d=s.nodes.length;c<d;++c){(h=t.get(s.nodes[c]))&&u.push(h)}for(c=0,d=s.connectors.length;c<d;++c){var h;(h=t.get(s.connectors[c]))&&l.push(h)}var C=Object.extend({},s);C.nodes=u,C.connectors=l,o.push(C)}e.setAromaticRings(o)}},getFlattenedShadowFragment:function(e){if(this.getFlattenedShadowOnSelf())return this;var t=this.getFlattenedShadow(e);return t?t.getShadowFragment():null},getFlatternedShadowShadowObj:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var n=this.getFlattenedShadow(t);return n?n.getShadowObj(e):null},getFlatternedShadowSourceObj:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var n=this.getFlattenedShadow(t);return n?n.getSourceObj(e):null},getFlatternedShadowShadowObjs:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var n=this.getFlattenedShadow(t),r=[];if(n)for(var o=0,i=e.length;o<i;++o)r.push(n.getShadowObj(e[o]));return r},getFlatternedShadowSourceObjs:function(e,t){if(this.getFlattenedShadowOnSelf())return e;var n=this.getFlattenedShadow(t),r=[];if(n)for(var o=0,i=e.length;o<i;++o)r.push(n.getSourceObj(e[o]));return r},createShadow:function(){var e=new Kekule.StructureFragmentShadow(this);return this._copyAdditionalInfoToShadowFragment(e.getShadowFragment(),e.getSourceToShadowMap(),e.getShadowToSourceMap()),e},traverse:function(e,t,n,r){return this.hasCtab()?this.getCtab().traverse(e,t,n):null}}),Kekule.StructureFragment.moveChildBetweenStructFragment=function(e,t,n,r,o){var i=Kekule.CoordUtils;e.beginUpdate(),t.beginUpdate();var a=e.getAnchorNodes();try{for(var s=e.getAbsCoord2D(),u=e.getAbsCoord3D(),l=t.getAbsCoord2D(),c=t.getAbsCoord3D(),d=i.substract(s,l),h=i.substract(u,c),C=Kekule.ArrayUtils.clone(n),f=Kekule.ArrayUtils.clone(r),g=0,p=C.length;g<p;++g){var m=C[g];if((T=e.indexOfNode(m))>=0){e.removeNodeAt(T,!0);var k=m.getCoord2D();if(k){var A=i.add(k,d);m.setCoord2D(A)}var S=m.getCoord3D();if(S){var O=i.add(S,h);m.setCoord2D(O)}t.appendNode(m),a.indexOf(m)>=0&&(e.removeAnchorNode(m),o||t.appendAnchorNode(m))}}for(g=0,p=f.length;g<p;++g){var T,b=f[g];(T=e.indexOfConnector(b))>=0&&(e.removeConnectorAt(T,!0),t.appendConnector(b))}}finally{t.endUpdate(),e.endUpdate()}},Kekule.StructureFragmentShadow=Class.create(ObjectEx,{CLASS_NAME:"Kekule.StructureFragmentShadow",initialize:function($super,e){if(e){$super(),this.setPropStoreFieldValue("shadowToSourceMap",new Kekule.MapEx),this.setPropStoreFieldValue("sourceToShadowMap",new Kekule.MapEx);var t=this._createShadowFragment(e,this.getSourceToShadowMap(),this.getShadowToSourceMap());this.setPropStoreFieldValue("shadowFragment",t)}else Kekule.error(Kekule.$L("ErrorMsg.SOURCE_FRAGMENT_NOT_SET"))},doFinalize:function($super){this.getShadowToSourceMap().finalize(),this.getSourceToShadowMap().finalize(),this.getShadowFragment().finalize(),this.setPropStoreFieldValue("shadowToSourceMap",null),this.setPropStoreFieldValue("sourceToShadowMap",null),this.setPropStoreFieldValue("shadowFragment",null),$super()},initProperties:function(){this.defineProp("shadowFragment",{dataType:"Kekule.StructureFragment",setter:null}),this.defineProp("sourceToShadowMap",{dataType:"Kekule.MapEx",setter:null}),this.defineProp("shadowToSourceMap",{dataType:"Kekule.MapEx",setter:null})},_createShadowFragment:function(e,t,n){var r=e.clone();return this._mapFragmentChildren(e,r,t,n),r},_mapFragmentChildren:function(e,t,n,r){for(var o=0,i=e.getChildCount();o<i;++o){var a=e.getChildAt(o),s=t.getChildAt(o);n.set(a,s),r.set(s,a),a.getChildCount&&s.getChildCount&&this._mapFragmentChildren(a,s,n,r)}},getShadowObj:function(e){return this.getSourceToShadowMap().get(e)},getSourceObj:function(e){return this.getShadowToSourceMap().get(e)}}),Kekule.SubGroup=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.SubGroup",initialize:function($super,e,t,n,r,o){$super(e,r,o),this.setPropStoreFieldValue("abbr",t),this.setPropStoreFieldValue("name",n)},initProperties:function(){this.defineProp("abbr",{dataType:DataType.STRING}),this.defineProp("formulaText",{dataType:DataType.STRING}),this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"g"},doPropChanged:function($super,e,t){return"anchorNodes"==e&&this.recalcCoords(),$super(e,t)},getLabel:function(){return Kekule.ChemStructureNodeLabels.SUBGROUP}}),Kekule.RGroup=Kekule.SubGroup,Kekule.Molecule=Class.create(Kekule.StructureFragment,{CLASS_NAME:"Kekule.Molecule",initialize:function($super,e,t,n){$super(e),this.setPropStoreFieldValue("name",t),n&&this.setCtab(new Kekule.StructureConnectionTable)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"m"}}),Kekule.BaseStructureConnector=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.BaseStructureConnector",initialize:function($super,e,t){$super(e),this.setConnectedObjs(t||[])},initProperties:function(){this.defineProp("connectedObjs",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLISHED,setter:function(e){var t=this.getPropStoreFieldValue("connectedObjs");t||(this.setPropStoreFieldValue("connectedObjs",[]),t=this.getPropStoreFieldValue("connectedObjs"));for(var n=0,r=t.length;n<r;++n)t[n].removeLinkedConnector(this);if(e){for(n=0,r=e.length;n<r;++n)this.assertConnectedObjLegal(e[n]);for(n=0,r=e.length;n<r;++n){var o=e[n],i=o.getCurrConnectableObj?o.getCurrConnectableObj():o;Kekule.ArrayUtils.pushUnique(t,i)}}else this.setPropStoreFieldValue("connectedObjs",[]);for(n=0,r=(t=this.getPropStoreFieldValue("connectedObjs")).length;n<r;++n)t[n].appendLinkedConnector(this);this.notifyConnectedObjsChanged()}}),this.defineProp("neighboringConnectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=this.getConnectedObjs(),n=0,r=t.length;n<r;++n){var o=t[n];o.getLinkedConnectors&&Kekule.ArrayUtils.pushUnique(e,o.getLinkedConnectors()||[])}return Kekule.ArrayUtils.remove(e,this),e}})},getAutoIdPrefix:function(){return"c"},getStructureRelatedPropNames:function($super){return $super().concat(["connectedObjs"])},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"connectedObjCount")){var r=this.getConnectedObjCount(),o=e.getConnectedObjCount&&e.getConnectedObjCount();n=this.doCompareOnValue(r,o,t)}return n},notifyConnectedObjsChanged:function(){this.notifyPropSet("connectedObjs",this.getPropStoreFieldValue("connectedObjs"))},assertConnectedObjLegal:function(e){if(e&&e.getOwner)return!e.getOwner()||e.getOwner()==this.getOwner()||(Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_DIFF_OWNER_OBJ"):"Object with different owner can not be linked to connector"),!1);Kekule.chemError(Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.UNABLE_ADD_MISTYPED_NODE"):"Unable to link mistyped node to connector")},connectedObjAdded:function(e){this.notifyConnectedObjsChanged()},getConnectedObjCount:function(){return this.getConnectedObjs().length},indexOfConnectedObj:function(e){return this.getConnectedObjs().indexOf(e)},getConnectedObjAt:function(e){return this.getConnectedObjs()[e]},setConnectedObjAt:function(e,t){this.assertConnectedObjLegal(t);var n=this.getConnectedObjs()[e];n&&n.removeLinkedConnector(this),this.insertConnectedObjAt(t,e),this.connectedObjAdded(t)},appendConnectedObj:function(e){this.assertConnectedObjLegal(e);var t=e.getCurrConnectableObj?e.getCurrConnectableObj():e,n=this._doAppendConnectedObj(t);return t&&t.appendLinkedConnector(this),n},_doAppendConnectedObj:function(e){var t=Kekule.ArrayUtils.pushUniqueEx(this.getConnectedObjs(),e);return t.isPushed&&this.connectedObjAdded(e),t.index},insertConnectedObjBefore:function(e,t){this.assertConnectedObjLegal(e);var n=t?t.getCurrConnectableObj?t.getCurrConnectableObj():t:null,r=n?this.indexOfConnectedObj(n):-1;return r<0?this.appendConnectedObj(e):this.insertConnectedObjAt(e,r)},insertConnectedObjAt:function(e,t){t||(t=0),this.assertConnectedObjLegal(e);var n=e.getCurrConnectableObj?e.getCurrConnectableObj():e,r=this.indexOfConnectedObj(n),o=this.getConnectedObjs();r>=0?(o.splice(r,1),o.splice(t,0,n),this.notifyConnectedObjsChanged()):(o.splice(t,0,n),n&&n.appendLinkedConnector(this),this.connectedObjAdded(n))},removeConnectedObjAt:function(e){var t=this.getConnectedObjs()[e];t&&(this._doRemoveConnectedObjAt(e),t._doRemoveLinkedConnectorAt(t.indexOfLinkedConnector(this)),this.notifyConnectedObjsChanged())},_doRemoveConnectedObjAt:function(e){this.getConnectedObjs().splice(e,1)},removeConnectedObj:function(e){var t=this.getConnectedObjs().indexOf(e);t>=0&&this.removeConnectedObjAt(t)},replaceConnectedObj:function(e,t){var n=this.indexOfConnectedObj(e);n>=0&&this.setConnectedObjAt(n,t)},clearConnectedObjs:function(){this.setConnectedObjs([])},hasConnectedObj:function(e){return this.getConnectedObjs().indexOf(e)>=0},isConnectingWithObj:function(e){return this.hasConnectedObj(e)},sortConnectedObjs:function(e){this.getConnectedObjs().sort(e)},reverseConnectedObjOrder:function(){this.setPropStoreFieldValue("connectedObjs",Kekule.ArrayUtils.reverse(this.getConnectedObjs())),this.notifyConnectedObjsChanged()},removeThisFromConnectedObjs:function(){for(var e=this.getConnectedObjCount()-1;e>=0;--e){this.getConnectedObjAt(e).removeLinkedConnector(this)}},getConnectedSiblings:function(){for(var e=this.getConnectedObjs(),t=[],n=this.getParent(),r=function(e){if(e.getParent){var t=e.getParent();return t===n?t:r(t)}return e},o=0,i=e.length;o<i;++o){var a=e[o];if(a.getParent&&a.getParent()!==n){var s=r(a);s&&t.push(s)}else t.push(a)}return t},isConnectingConnector:function(){for(var e=0,t=this.getConnectedObjCount();e<t;++e){if(this.getConnectedObjAt(e)instanceof Kekule.ChemStructureConnector)return!0}return!1}}),Kekule.ChemStructureConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.ChemStructureConnector",initProperties:function(){this.defineProp("parity",{dataType:DataType.INT}),this.defineProp("connectedChemNodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=[],t=0,n=this.getConnectedObjCount();t<n;++t){var r=this.getConnectedObjAt(t);r instanceof Kekule.ChemStructureNode&&e.push(r)}return e}})},getAcceptCoordStickFrom:function(e){return!(this.isSiblingWith(e)||e instanceof Kekule.ChemStructureNode||e instanceof Kekule.BaseStructureConnector)},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(t,"stereo")){var r=this.getParity()||Kekule.StereoParity.UNKNOWN,o=e.getParity&&e.getParity()||Kekule.StereoParity.UNKNOWN;n=this.doCompareOnValue(r,o,t)}return n},clearStructureFlags:function(){this.setParity(Kekule.StereoParity.NONE)},getConnectedChemNodeCount:function(){return this.getConnectedChemNodes().length},getConnectedNonHydrogenObjs:function(){for(var e=[],t=this.getConnectedObjs(),n=0,r=t.length;n<r;++n){var o=t[n];o.isHydrogenAtom&&o.isHydrogenAtom()||e.push(o)}return e},isNormalConnectorToHydrogen:function(){return this.getConnectedNonHydrogenObjs().length<=1}}),Kekule.BondStereo={NONE:0,UP:1,UP_INVERTED:2,DOWN:3,DOWN_INVERTED:4,UP_OR_DOWN:8,UP_OR_DOWN_INVERTED:9,CLOSER:10,E_OR_Z:20,E:21,Z:22,E_Z_BY_COORDINATES:23,CIS_OR_TRANS:30,CIS:31,TRANS:32,getInvertedDirection:function(e){var t=Kekule.BondStereo;switch(e){case t.UP:return t.UP_INVERTED;case t.UP_INVERTED:return t.UP;case t.DOWN:return t.DOWN_INVERTED;case t.DOWN_INVERTED:return t.DOWN;case t.UP_OR_DOWN:return t.UP_OR_DOWN_INVERTED;default:return e}}},Kekule.Bond=Class.create(Kekule.ChemStructureConnector,{CLASS_NAME:"Kekule.Bond",initialize:function($super,e,t,n,r,o){$super(e,t||[]),(n||r||o)&&this.setBondForm(Kekule.BondFormFactory.getBondForm(n,r,o))},initProperties:function(){this.defineProp("bondForm",{dataType:"Kekule.BondForm",serializable:!1,scope:Class.PropertyScope.PUBLIC}),this.defineProp("bondType",{dataType:DataType.STRING,enumSource:Kekule.BondType,getter:function(){var e=this.getBondForm();return e?e.getBondType():Kekule.BondType.DEFAULT},setter:function(e){this.changeBondForm(this.getBondOrder(),Kekule.ElectronSet.UNSET_ELECTRONCOUNT,e)}}),this.defineProp("bondOrder",{dataType:DataType.INT,enumSource:Kekule.BondOrder,getter:function(){var e=this.getBondForm();return e?e.getBondOrder():Kekule.BondOrder.UNSET},setter:function(e){this.changeBondForm(e,Kekule.ElectronSet.UNSET_ELECTRONCOUNT,this.getBondType())}}),this.defineProp("bondValence",{dataType:DataType.INT,serializable:!1,getter:function(){var e=this.getBondForm();return e?e.getBondValence():0},setter:null}),this.defineProp("electronCount",{dataType:DataType.FLOAT,getter:function(){if(this.isAromatic())return 3;var e=this.getBondForm();return e?e.getElectronCount():Kekule.ElectronSet.UNSET_ELECTRONCOUNT},setter:function(e){var t=this.getBondOrder();this.changeBondForm(t,e,this.getBondType())}}),this.defineProp("stereo",{dataType:DataType.INT,enumSource:Kekule.BondStereo,defaultValue:Kekule.BondStereo.NONE}),this.defineProp("isInAromaticRing",{dataType:DataType.BOOL,setter:null,getter:function(){var e=this.getParent();return!(!e||!e.isConnectorInAromaticRing)&&e.isConnectorInAromaticRing(this)}}),this.defineProp("neighboringBonds",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){for(var e=this.getNeighboringConnectors()||[],t=[],n=0,r=e.length;n<r;++n)e[n]instanceof Kekule.Bond&&t.push(e[n]);return t}})},initPropValues:function($super){$super(),this.setPropStoreFieldValue("stereo",Kekule.BondStereo.NONE)},getAutoIdPrefix:function(){return"b"},getStructureRelatedPropNames:function($super){return $super().concat(["bondForm","stereo"])},clearStructureFlags:function(){this.setPropStoreFieldValue("isInAromaticRing",null)},doGetParity:function($super){return this.isDoubleBond()?$super():null},doGetComparisonPropNames:function($super,e){var t=$super(e);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&this._getComparisonOptionFlagValue(e,"bondType")&&t.push("bondType"),t},doCompare:function($super,e,t){var n=$super(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE){if(this._getComparisonOptionFlagValue(t,"connectedObjCount")){var r=this.getConnectedObjCount(),o=e.getConnectedObjCount&&e.getConnectedObjCount();n=this.doCompareOnValue(r,o,t)}if(!n&&this._getComparisonOptionFlagValue(t,"bondOrder")){var i=Math.round(this.getElectronCount()),a=Math.round(e.getElectronCount());n=this.doCompareOnValue(i,a,t)}}return n},changeBondForm:function(e,t,n){this.setBondForm(Kekule.BondFormFactory.getBondForm(e,t,n))},canInvertBondDirection:function(){var e=Kekule.BondType,t=this.getBondType();return[e.COVALENT,e.IONIC,e.METALLIC,e.HYDROGEN,e.UNKNOWN].indexOf(t)>=0},invertBondDirection:function(){this.setStereo(Kekule.BondStereo.getInvertedDirection(this.getStereo()))},reverseConnectedObjOrder:function($super){this.canInvertBondDirection()&&($super(),this.invertBondDirection())},normalizeDirection:function(){var e=Kekule.BondStereo,t=[e.UP_INVERTED,e.DOWN_INVERTED,e.UP_OR_DOWN_INVERTED],n=this.getBondStereo();t.indexOf(n)>=0&&this.reverseConnectedObjOrder()},isCovalentBond:function(){return this.getBondType()===Kekule.BondType.COVALENT},isSingleBond:function(){return this.getBondType()===Kekule.BondType.COVALENT&&this.getBondOrder()===Kekule.BondOrder.SINGLE&&!this.getIsInAromaticRing()},isDoubleBond:function(){return this.getBondType()===Kekule.BondType.COVALENT&&this.getBondOrder()===Kekule.BondOrder.DOUBLE&&!this.getIsInAromaticRing()},isTripleBond:function(){return this.getBondType()===Kekule.BondType.COVALENT&&this.getBondOrder()===Kekule.BondOrder.TRIPLE},isAromatic:function(){return(!!this.getIsInAromaticRing()||this.getBondOrder()===Kekule.BondOrder.EXPLICIT_AROMATIC)&&this.getBondType()===Kekule.BondType.COVALENT},isBondBetween:function(e,t){var n,r,o=this.getConnectedObjs();if(2!==o.length)return!1;for(var i=0,a=o.length;i<a;++i){var s=o[i];if(s instanceof Kekule.Atom&&(s.isElement(e)?n=!0:s.isElement(t)&&(r=!0),n&&r))return!0}return!1}}),Kekule.ChemStructureObjectGroup=Class.create(Kekule.ChemStructureObject,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.ChemStructureObject","Kekule.ChemStructureObjectGroup"],initialize:function($super,e){$super(e),this.setPropStoreFieldValue("items",[]),this.setPropStoreFieldValue("raiseExceptionOnTypeMismatch",[])},initProperties:function(){this.defineProp("items",{dataType:DataType.ARRAY}),this.defineProp("raiseExceptionOnTypeMismatch",{dataType:DataType.BOOL,defaultValue:!0,scope:Class.PropertyScope.PUBLIC})},getAutoIdPrefix:function(){return"sg"},getStructureRelatedPropNames:function($super){return $super().concat(["items"])},doGetComparisonPropNames:function($super,e){var t=$super(e);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&t.push("items"),t},ownerChanged:function($super,e,t){for(var n=this.getItems(),r=0,o=n.length;r<o;++r){var i=n[r].obj;i&&i.setOwner&&i.setOwner(e)}$super(e,t)},_removeChildObj:function($super,e){var t=this.indexOfObj(e);t<0&&(t=this.indexOfItem(e)),t>=0&&this.removeObjAt(t),$super(e)},getObjectBaseClasses:function(){return this.getPrototype().ITEM_BASE_CLASSES},ensureItemClass:function(e){var t=this.getObjectBaseClasses();if(t.length>0){for(var n=0,r=t.length;n<r;++n)if(e instanceof ClassEx.findClass(t[n]))return!0;if(this.getRaiseExceptionOnTypeMismatch()){var o=Kekule.hasLocalRes()?Kekule.$L("ErrorMsg.CHEMSTRUCTUREOBJECTGROUP_ITEMCLASS_MISMATCH"):"Mismatched group item class";Kekule.raise(o)}return!1}return!0},notifyItemsChanged:function(){this.notifyPropSet("items",this.getPropStoreFieldValue("items"))},indexOfItem:function(e){return this.getItems().indexOf(e)},indexOfObj:function(e){for(var t=this.getItems(),n=0,r=t.length;n<r;++n)if(t[n].obj==e)return n;return-1},hasObj:function(e){return this.indexOfObj(e)>=0},setAttributesAt:function(e,t){var n=this.getItems()[e];if(n)for(var r=Kekule.ObjUtils.getOwnedFieldNames(t),o=0,i=r.length;o<i;++o)n[r[o]]=t[r[o]]},getItemCount:function(){return this.getItems().length},getItemAt:function(e){return this.getItems()[e]},appendItem:function(e){return this.getItems().push(e),this},insertItem:function(e,t){return this.insertItemAt(e,t)},insertItemAt:function(e,t){return Kekule.ArrayUtils.insertUniqueEx(this.getItems(),e,t).index},removeItemAt:function(e){this.getItems()[e]&&(this.getItems().splice(e,1),this.notifyItemsChanged())},removeItem:function(e){var t=this.getItems().indexOf(e);t>=0&&this.removeItemAt(t)},getObjAt:function(e){var t=this.getItemAt(e);return t?t.obj:null},insertObj:function(e,t,n){return this.insertObjAt(e,t,n)},insertObjAt:function(e,t,n){if(e)if(this.indexOfObj(e)>=0);else if(this.ensureItemClass(e)){var r={obj:e};this.beginUpdate();try{var o=this.insertItem(r,t);n&&this.setAttributesAt(o,n),this.notifyItemsChanged()}finally{this.endUpdate()}return o}},appendObj:function(e,t){return this.insertObj(e,null,t)},removeObjAt:function(e){this.getItems()[e]&&(this.getItems().splice(e,1),this.notifyItemsChanged())},removeObj:function(e){var t=this.indexOfObj(e);t>=0&&this.removeObjAt(t)},getAllObjs:function(){for(var e=[],t=0,n=this.getItemCount();t<n;++t)e.push(this.getObjAt(t));return e},getChildSubgroupNames:function($super){return["item"].concat($super())},getBelongChildSubGroupName:function(e){return"item"},getNextSiblingOfChild:function(e){var t=this.indexOfItem(e);return t<0&&(t=this.indexOfObj(e)),t>=0?this.getChildAt(t+1):null},appendChild:function(e){return e instanceof Kekule.ChemObject?this.appendObj(e):this.appendItem(e)},insertChild:function(e,t){return e instanceof Kekule.ChemObject?this.insertObj(e,t):this.insertItem(e,t)},insertBefore:function(e,t){var n=this.indexOfItem(t);return n<0&&(n=this.indexOfObj(t)),this.insertChild(e,n)}}),Kekule.StructureFragmentGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.ChemStructureObjectGroup",ITEM_BASE_CLASSES:["Kekule.StructureFragment","Kekule.StructureFragmentGroup"]}),Kekule.MoleculeGroup=Class.create(Kekule.ChemStructureObjectGroup,{CLASS_NAME:"Kekule.MoleculeGroup",ITEM_BASE_CLASSES:["Kekule.Molecule","Kekule.MoleculeGroup"]}),Kekule.CompositeMolecule=Class.create(Kekule.Molecule,{CLASS_NAME:"Kekule.CompositeMolecule",initialize:function($super,e,t){$super(e,t)},initProperties:function(){this.defineProp("subMolecules",{dataType:"Kekule.MoleculeGroup",getter:function(){return this.getPropStoreFieldValue("subMolecules")||this.setPropStoreFieldValue("subMolecules",new Kekule.MoleculeGroup),this.getPropStoreFieldValue("subMolecules")}})},doGetComparisonPropNames:function($super,e){var t=$super(e);return e.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&t.push("subMolecules"),t},ownerChanged:function($super,e,t){var n=this.getPropStoreFieldValue("subMolecules");n&&n.setOwner(e),$super(e,t)},getSubMoleculeCount:function(){var e=this.getPropStoreFieldValue("subMolecules");return e?e.length:0},hasCtab:function(){return!1},hasFormula:function(){return!1},getAllContainingConnectors:function(){for(var e=this.getSubMolecules(),t=[],n=0,r=e.getItemCount();n<r;++n){var o=e.getObjAt(n);if(o.getAllContainingConnectors){var i=o.getAllContainingConnectors();i&&i.length&&(t=t.concat(i))}}return t},getContainerBox:function(e){var t=null,n=this.getPropStoreFieldValue("subMolecules");if(n)for(var r=0,o=n.getItemCount();r<o;++r){var i=n.getObjAt(r).getContainerBox(e);i&&(t=t?Kekule.BoxUtils.getContainerBox(t,i):Kekule.BoxUtils.clone(i))}return t},doGetCtab:function(){return null},doSetCtab:function(){},doGetFormula:function(){return null},doSetFormula:function(){},getChildSubgroupNames:function($super){return["subMolecule"].concat($super())},getBelongChildSubGroupName:function($super,e){return e instanceof Kekule.Molecule?"subMolecule":$super(e)},getNextSiblingOfChild:function(e){return this.getSubMolecules().getNextSiblingOfChild(e)},insertChild:function(e,t){return this.insertChildAt(e,t)}}),Kekule.MoleculeList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.MoleculeList",initialize:function($super,e){$super(e,Kekule.Molecule)}}),Kekule.ChemStructureNodeLabels={ENABLE_ISOTOPE_ALIAS:!0,UNSET_ELEMENT:"?",DUMMY_ATOM:"Du",HETERO_ATOM:"Q",ANY_ATOM:"A",CUSTOM_ATOM:"@",VARIABLE_ATOM:"L",SUBGROUP:"R",ISO_LIST_LEADING_BRACKET:"[",ISO_LIST_TAILING_BRACKET:"]",ISO_LIST_DELIMITER:",",ISO_LIST_DISALLOW_PREFIX:"NOT"},Kekule.ChemStructureNodeFactory={CANDIDATE_CLASSES:[Kekule.SubGroup,Kekule.VariableAtom,Kekule.Pseudoatom],getClassByLabel:function(e,t){void 0===t&&(t=Kekule.Pseudoatom);for(var n,r=Kekule.ChemStructureNodeLabels,o=[[r.SUBGROUP],[r.VARIABLE_ATOM],[r.DUMMY_ATOM,r.HETERO_ATOM,r.ANY_ATOM,r.CUSTOM_ATOM]],i=Kekule.ChemStructureNodeFactory.CANDIDATE_CLASSES,a=0,s=i.length;a<s;++a){var u=i[a];if(o[a].indexOf(e)>=0){n=u;break}}return n||(n=Kekule.IsotopesDataUtil.isIsotopeIdAvailable(e)?Kekule.Atom:t),n},createByLabel:function(e){var t=new(Kekule.ChemStructureNodeFactory.getClassByLabel(e));return t instanceof Kekule.Pseudoatom?t.setSymbol(e):t instanceof Kekule.Atom&&t.setIsotopeId(e),t}}}(),Kekule.ChemStructureBuilder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.ChemStructureBuilder",initialize:function($super,e){$super(),e&&this.setTarget(e)},initProperties:function(){this.defineProp("target",{dataType:"Kekule.StructureFragment"})},setNodeCoord:function(){for(var e=Array.prototype.slice.call(arguments),t=e.shift(),n=e,r=0,o=n.length;r<o&&r<2;++r){var i=n[r];void 0!==i.z?t.setCoordOfMode(i,Kekule.CoordMode.COORD3D):t.setCoordOfMode(i,Kekule.CoordMode.COORD2D)}},createNode:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift(),r=e,o=new t(n);return this.setNodeCoord(o,r),this.appendNode(o),o},createConnector:function(e,t,n){var r=new e(t);return r.setConnectedObjs(n),r},appendNode:function(e){return e&&this.getTarget()?this.getTarget().appendNode(e):null},appendConnector:function(e){return e&&this.getTarget()?this.getTarget().appendConnector(e):null},createAtom:function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift(),r=e.shift(),o=new Kekule.Atom(t,n,r);return e.unshift(o),this.setNodeCoord.apply(this,e),this.appendNode(o),o},createBond:function(e,t,n,r,o){var i=new Kekule.Bond(e,t,n);return i.changeBondForm(n,null,o),r&&i.setStereo(r),this.appendConnector(i),i},deleteNode:function(){},marshalSubGroup:function(e,t){var n=this.getTarget();if(n&&n.hasCtab()){var r=new Kekule.SubGroup(t);return n.marshalSubFragment(e,r),r}return null}}),Kekule.ReactionComponent={REACTANT:"reactant",PRODUCT:"product",SUBSTANCE:"substance",CONDITION:"condition"},Kekule.ReactionRole={REAGENT:"reagent",CATALYST:"catalyst",SOLVENT:"solvent",TEMPERATURE:"temperature",DURATION:"duration"},Kekule.ReactionDirection={FORWARD:1,BACKWARD:-1,BIDIRECTION:0},Kekule.Reaction=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Reaction",initialize:function($super,e){$super(e),this.setDirection(Kekule.ReactionDirection.FORWARD)},initProperties:function(){this.defineProp("name",{dataType:DataType.STRING}),this.defineProp("title",{dataType:DataType.STRING}),this.defineProp("reactionType",{dataType:DataType.STRING}),this.defineProp("yield",{dataType:DataType.FLOAT}),this.defineProp("direction",{dataType:DataType.INT,defaultValue:Kekule.ReactionDirection.FORWARD,enumSource:Kekule.ReactionDirection}),this.defineProp("reactants",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("reactants");return!t&&e&&(t=[],this.setPropStoreFieldValue("reactants",t)),t}}),this.defineProp("products",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("products");return!t&&e&&(t=[],this.setPropStoreFieldValue("products",t)),t}}),this.defineProp("substances",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("substances");return!t&&e&&(t=[],this.setPropStoreFieldValue("substances",t)),t}}),this.defineProp("conditions",{dataType:DataType.ARRAY,setter:null,getter:function(e){var t=this.getPropStoreFieldValue("conditions");return!t&&e&&(t=[],this.setPropStoreFieldValue("conditions",t)),t}})},ownerChanged:function($super,e,t){for(var n=["reactants","products","substances","conditions"],r=0,o=n.length;r<o;++r){var i=n[r],a=this.getComponentArray(i);if(a)for(var s=0,u=a.length;s<u;++s){var l=a[s].item;l.setOwner&&l.setOwner(e)}}$super(e,t)},assertAddingMolecule:function(e){e instanceof Kekule.Molecule||Kekule.chemError(Kekule.$L("ErrorMsg.UNABLE_ADD_NONMOLECULE_MAP"))},notifyReactantsChange:function(){this.notifyPropSet("reactants",this.getPropStoreFieldValue("reactants"))},notifyProductsChange:function(){this.notifyPropSet("products",this.getPropStoreFieldValue("products"))},notifySubstancesChange:function(){this.notifyPropSet("substances",this.getPropStoreFieldValue("substances"))},notifyConditionsChange:function(){this.notifyPropSet("conditions",this.getPropStoreFieldValue("conditions"))},notifyComponentChange:function(e){var t=this.componentToPropName(e);t&&this.notifyPropSet(t,this.getPropStoreFieldValue(t))},componentToPropName:function(e){return e+"s"},getComponentArray:function(e,t){var n=this.componentToPropName(e);if(!n)return null;switch(n){case"reactants":return this.doGetReactants(t);case"products":return this.doGetProducts(t);case"substances":return this.doGetSubstances(t);case"conditions":return this.doGetConditions(t);default:return null}},getComponentItemCount:function(e){var t=this.getComponentArray(e);return t?t.length:0},getMapAt:function(e,t){var n=this.getComponentArray(e);return n?n[t]:null},getMapItemAt:function(e,t){var n=this.getMapAt(e,t);return n?n.item:null},indexOfMap:function(e,t){var n=this.getComponentArray(e);return n?n.indexOf(t):-1},indexOfItem:function(e,t,n){var r=this.getComponentArray(e);if(r)for(var o=0,i=r.length;o<i;++o)if(r[o].item==t){if(void 0===n)return o;if(n===r[o].role)return o}return-1},appendMap:function(e,t){e!=Kekule.ReactionComponent.PRODUCT&&e!=Kekule.ReactionComponent.REACTANT||this.assertAddingMolecule(t.item);var n=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(e,!0),t);return n.isPushed&&this.notifyComponentChange(e),n.index},appendItem:function(e,t,n,r){var o=this.indexOfItem(e,t,n);if(o<0){e!=Kekule.ReactionComponent.PRODUCT&&e!=Kekule.ReactionComponent.REACTANT||this.assertAddingMolecule(t);var i=Kekule.RoleMapUtils.createMap(t,n);r&&Object.extend(i,r);var a=Kekule.ArrayUtils.pushUniqueEx(this.getComponentArray(e,!0),i);return this.notifyComponentChange(e),a.index}return o},removeMapAt:function(e,t){var n=null,r=this.getComponentArray(e);return r&&(n=Kekule.ArrayUtils.removeAt(r,t))&&this.notifyComponentChange(e),n},removeMap:function(e,t){var n=null,r=this.getComponentArray(e);return r&&(n=Kekule.ArrayUtils.remove(r,t))&&this.notifyComponentChange(e),n},removeItem:function(e,t,n){var r=this.indexOfItem(e,t,n);return r>=0?this.removeMapAt(e,r):null},clearComponent:function(e){this.getComponentArray(e);this.notifyComponentChange(e)},getReactantCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.REACTANT)},getProductCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.PRODUCT)},getSubstancesCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.SUBSTANCE)},getConditionCount:function(){return this.getComponentItemCount(Kekule.ReactionComponent.CONDITION)},getReactantMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.REACTANT,e)},getProductMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.PRODUCT,e)},getSubstanceMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.SUBSTANCE,e)},getConditionMapAt:function(e){return this.getMapAt(Kekule.ReactionComponent.CONDITION,e)},getReactantItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,e)},getReactantAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.REACTANT,e)},getProductItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,e)},getProductAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.PRODUCT,e)},getSubstanceItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,e)},getSubstanceAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.SUBSTANCE,e)},getConditionItemAt:function(e){return this.getMapItemAt(Kekule.ReactionComponent.CONDITION,e)},indexOfReactantMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.REACTANT,e)},indexOfProductMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.PRODUCT,e)},indexOfSubstanceMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.SUBSTANCE,e)},indexOfConditionMap:function(e){return this.indexOfMap(Kekule.ReactionComponent.CONDITION,e)},indexOfReactant:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.REACTANT,e,t)},indexOfProduct:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.PRODUCT,e,t)},indexOfSubstance:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.SUBSTANCE,e,t)},indexOfCondition:function(e,t){return this.indexOfItem(Kekule.ReactionComponent.CONDITION,e,t)},appendReactantMap:function(e){return this.appendMap(Kekule.ReactionComponent.REACTANT,e)},appendProductMap:function(e){return this.appendMap(Kekule.ReactionComponent.PRODUCT,e)},appendSubstanceMap:function(e){return this.appendMap(Kekule.ReactionComponent.SUBSTANCE,e)},appendConditionMap:function(e){return this.appendMap(Kekule.ReactionComponent.CONDITION,e)},appendReactant:function(e,t,n,r){var o=r||{};return n&&(o.amount=n),this.appendItem(Kekule.ReactionComponent.REACTANT,e,t,o)},appendProduct:function(e,t,n,r){var o=r||{};return n&&(o.amount=n),this.appendItem(Kekule.ReactionComponent.PRODUCT,e,t,o)},appendSubstance:function(e,t,n,r){var o=r||{};return n&&(o.amount=n),this.appendItem(Kekule.ReactionComponent.SUBSTANCE,e,t,o)},appendCondition:function(e,t,n){return this.appendItem(Kekule.ReactionComponent.CONDITION,e,t,n)},removeReactantAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.REACTANT,e)},removeProductAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.PRODUCT,e)},removeSubstanceAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.SUBSTANCE,e)},removeConditionAt:function(e){return this.removeMapAt(Kekule.ReactionComponent.CONDITION,e)},removeReactantMap:function(e){return this.removeMap(Kekule.ReactionComponent.REACTANT,e)},removeProductMap:function(e){return this.removeMap(Kekule.ReactionComponent.PRODUCT,e)},removeSubstanceMap:function(e){return this.removeMap(Kekule.ReactionComponent.SUBSTANCE,e)},removeConditionMap:function(e){return this.removeMap(Kekule.ReactionComponent.CONDITION,e)},removeReactant:function(e,t){return this.removeItem(Kekule.ReactionComponent.REACTANT,e,t)},removeProduct:function(e,t){return this.removeItem(Kekule.ReactionComponent.PRODUCT,e,t)},removeSubstance:function(e,t){return this.removeItem(Kekule.ReactionComponent.SUBSTANCE,e,t)},removeCondition:function(e,t){return this.removeItem(Kekule.ReactionComponent.CONDITION,e,t)},clearReactants:function(){return this.clearComponent(Kekule.ReactionComponent.REACTANT)},clearProducts:function(){return this.clearComponent(Kekule.ReactionComponent.PRODUCT)},clearSubstance:function(){return this.clearComponent(Kekule.ReactionComponent.SUBSTANCE)},clearConditions:function(){return this.clearComponent(Kekule.ReactionComponent.CONDITION)},clearAll:function(){this.clearProducts(),this.clearProducts(),this.clearSubstance(),this.clearConditions()},getAllContainingConnectors:function(){for(var e=Kekule.ReactionComponent,t=[e.REACTANT,e.PRODUCT,e.SUBSTANCE],n=[],r=0,o=t.length;r<o;++r)for(var i=t[r],a=0,s=this.getComponentItemCount(i);a<s;++a){var u=this.getMapItemAt(i,a);if(u.getAllContainingConnectors){var l=u.getAllContainingConnectors();l&&l.length&&(n=n.concat(l))}}return n}}),Kekule.ReactionList=Class.create(Kekule.ChemObjList,{CLASS_NAME:"Kekule.ReactionList",initialize:function($super,e){$super(e,Kekule.Reaction)}}),function(){"use strict";var e=Kekule.ArrayUtils;Kekule.ChemStructureUtils={getConnectorLengthMedian:function(e,t,n){for(var r=[],o=0,i=e.length;o<i;++o){var a=e[o];if(a&&a.getLength){var s=a.getLength(t,n);s&&r.push(s)}}if(0===i)return 1;if(i<=1)return r[0];r.sort();var u=r.length;return u%2?r[u+1>>1]:(r[u>>1]+r[(u>>1)-1])/2},getChildStructureObjs:function(e,t){var n;if(e instanceof Kekule.CompositeMolecule)n=e.getSubMolecules().getAllObjs();else if(e instanceof Kekule.ChemStructureObjectGroup)n=e.getAllObjs();else if(e instanceof Kekule.ChemObjList)n=e.getItems();else if(e instanceof Kekule.ChemSpaceElement)n=e.getChildren().getItems();else{if(!(e instanceof Kekule.ChemSpace))return[e];n=e.getChildren()}if(n=[].concat(n),t){for(var r=[],o=0,i=n.length;o<i;++o){var a=n[o],s=Kekule.ChemStructureUtils.getChildStructureObjs(a,t);s.length<=1?Kekule.ArrayUtils.pushUnique(r,a):Kekule.ArrayUtils.pushUnique(r,s)}n=r}return n},getAllStructFragments:function(e,t){if(e instanceof Kekule.StructureFragment)return[e];for(var n=Kekule.ChemStructureUtils.getChildStructureObjs(e,t),r=[],o=0,i=n.length;o<i;++o)n[o]instanceof Kekule.StructureFragment&&Kekule.ArrayUtils.pushUnique(r,n[o]);return r},getTotalStructFragment:function(e,t){var n=Kekule.ChemStructureUtils.getAllStructFragments(e,!0),r=n.length;return r<=0?null:1===r?n[0]:Kekule.ChemStructureUtils.mergeStructFragments(n,t)},getCascadeDeleteObjs:function(e){for(var t=[],n=e.getLinkedConnectors?e.getLinkedConnectors():[],r=0,o=n.length;r<o;++r){var i=n[r];if(i.getConnectedObjs().length<=2){Kekule.ArrayUtils.pushUnique(t,i);var a=Kekule.ChemStructureUtils.getCascadeDeleteObjs(i);Kekule.ArrayUtils.pushUnique(t,a)}}if(e instanceof Kekule.ChemStructureNode);else if(e instanceof Kekule.ChemStructureConnector){var s=e.getConnectedObjs();for(r=0,o=s.length;r<o;++r){var u=s[r];u instanceof Kekule.ChemStructureNode&&u.getLinkedConnectors().length<=1&&Kekule.ArrayUtils.pushUnique(t,u)}}return t},moveChildBetweenStructFragment:function(e,t,n,r,o){return Kekule.StructureFragment.moveChildBetweenStructFragment(e,t,n,r,o)},_getCascadeConnectedNodesAndConnectors:function(e,t){for(var n=[],r=[],o=e.getConnectedObjs(),i=0,a=o.length;i<a;++i){var s=o[i];if(s!==e)if(t&&(s=t.findDirectChildOfObj(s)),s instanceof Kekule.ChemStructureNode)Kekule.ArrayUtils.pushUnique(r,s);else if(s instanceof Kekule.ChemStructureConnector){Kekule.ArrayUtils.pushUnique(n,s);var u=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(s);Kekule.ArrayUtils.pushUnique(n,u.connectors),Kekule.ArrayUtils.pushUnique(r,u.nodes)}}return{connectors:n,nodes:r}},mergeStructFragments:function(e,t){if(e.length<=1)return e[0];for(var n=new(t||Kekule.Molecule),r=0,o=e.length;r<o;++r){var i=e[r].clone();Kekule.ChemStructureUtils.moveChildBetweenStructFragment(i,n,i.getNodes(),i.getConnectors())}return n},splitStructFragment:function(e){if(!e.hasCtab())return[e];var t=e.getNodes();if(t.length<=0)return[e];var n=e.getConnectors(),r=[],o=[t[0]],i=[],a=0;do{var s=o[a],u=s.getLinkedConnectors();s.getCrossConnectors&&u.concat(s.getCrossConnectors()||[]),Kekule.ArrayUtils.pushUnique(i,u);for(var l=0,c=u.length;l<c;++l){var d=Kekule.ChemStructureUtils._getCascadeConnectedNodesAndConnectors(u[l],e);Kekule.ArrayUtils.pushUnique(i,d.connectors),Kekule.ArrayUtils.pushUnique(o,d.nodes)}++a}while(a<o.length);r.push(e);var h=Kekule.ArrayUtils.exclude(t,o),C=Kekule.ArrayUtils.exclude(n,i);if(h.length>0){var f=new(e.getClass());Kekule.ChemStructureUtils.moveChildBetweenStructFragment(e,f,h,C);var g=Kekule.ChemStructureUtils.splitStructFragment(f);r=r.concat(g)}return r},getAbsCoordVectorBetweenObjs:function(e,t,n,r){var o=e.getAbsCoordOfMode(n,r),i=t.getAbsCoordOfMode(n,r);return Kekule.CoordUtils.substract(i,o)},_getRef2DCoordOfObj:function(e,t){return e.getAbsBaseCoord2D?e.getAbsBaseCoord2D(t):e.getAbsCoord2D?e.getAbsCoord2D(t):e.getCoord2D(t)},_getStandardizedLinkedObj2DRelCoords:function(t,n,r,o,i){var a=[],s=Kekule.ChemStructureUtils._getRef2DCoordOfObj(t,r),u=i?t.getLinkedObjs():t.getLinkedExposedObjs();o&&t.getAttachedMarkers&&(u=u.concat(t.getAttachedMarkers()||[])),n&&n.length&&(u=e.exclude(u,n));for(var l=0,c=u.length;l<c;++l){var d=u[l],h=Kekule.ChemStructureUtils._getRef2DCoordOfObj(d,r),C=Kekule.CoordUtils.substract(h,s);C=Kekule.CoordUtils.standardize(C),a.push(C)}return a},_calcLinkedObj2DAnglesOfObj:function(e,t,n,r,o){for(var i=[],a=Kekule.ChemStructureUtils._getStandardizedLinkedObj2DRelCoords(e,t,n,r,o),s=0,u=a.length;s<u;++s){var l=a[s];if(0!==l.x||0!==l.y){var c=Math.atan2(l.y,l.x);c<0&&(c=2*Math.PI+c),i.push(c)}}return i.sort(),i},_getMostEmptyDirectionOfExistingAngles:function(e){var t=e.length;if(0===t)return 0;if(1===t)return Kekule.GeometryUtils.standardizeAngle(Math.PI+e[0]);for(var n=0,r=0,o=0;o<t;++o){var i=e[o],a=e[(o+1)%t]-i;a<0&&(a+=2*Math.PI),a>n&&(n=a,r=o)}return e[r]+n/2},getMostEmptyDirection2DAngleOfObj:function(e,t,n,r,o,i){var a=Kekule.ChemStructureUtils._calcLinkedObj2DAnglesOfObj(e,t,n,r,o);return i&&(a=a.concat(i)).sort(),Kekule.ChemStructureUtils._getMostEmptyDirectionOfExistingAngles(a)},isSameRing:function(t,n){return t.nodes.length===n.nodes.length&&(t.connectors.length===n.connectors.length&&(!(e.exclude(t.nodes,n.nodes).length>0)&&!(e.exclude(t.connectors,n.connectors).length>0)))},isInRings:function(e,t){for(var n=0,r=t.length;n<r;++n){var o=t[n];if(e===o)return!0;if(Kekule.ChemStructureUtils.isSameRing(e,o))return!0}return!1}},Kekule.TokenAnalyzer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.TokenAnalyzer",initialize:function($super,e){$super(),this.setSrcText(e)},initProperties:function(){this.defineProp("srcText",{dataType:DataType.STRING,setter:function(e){var t=e||"";this.setPropStoreFieldValue("srcText",t),this.setPropStoreFieldValue("srcLength",t.length),this.setCurrPos(0)}}),this.defineProp("srcLength",{dataType:DataType.INT,setter:null,serializable:!1}),this.defineProp("currPos",{dataType:DataType.INT,serializable:!1})},getCharType:function(e){return 0},isCharTypeMatched:function(e,t){return e===t},nextCharInfo:function(){var e=this.getCurrPos();if(e>=this.getSrcLength())return null;var t=this.getSrcText().charAt(e);return this.setCurrPos(e+1),{char:t,charType:this.getCharType(t)}},nextTokenInfo:function(){var e=this.nextCharInfo();if(e){for(var t=e.char,n=e.charType,r=this.nextCharInfo();r&&this.isCharTypeMatched(r.charType,e.charType);)t+=r.char,e=r,r=this.nextCharInfo();return r&&this.setCurrPos(this.getCurrPos()-1),{token:t,tokenType:n}}return null},getAllTokenInfos:function(){for(var e=[],t=this.nextTokenInfo();t;)e.push(t),t=this.nextTokenInfo();return e}}),Kekule.ChemTextTypes={CT_ATOM_SYMBOL_LEADING:1,CT_ATOM_SYMBOL_FOLLOWING:2,CT_CHARGE_SYMBOL:3,CT_NUMBER:4,CT_BRACKET_LEADING:10,CT_BRACKET_TAILING:11,CT_SEPARATOR:20,CT_UNKNOWN:0};var t=Kekule.ChemTextTypes;Kekule.ChemTextAnalyzer=Class.create(Kekule.TokenAnalyzer,{CLASS_NAME:"Kekule.ChemTextAnalyzer",getCharType:function(e){return" "===e?t.CT_SEPARATOR:e>="0"&&e<="9"?t.CT_NUMBER:["+","-"].indexOf(e)>=0?t.CT_CHARGE_SYMBOL:["(","[","{"].indexOf(e)>=0?t.CT_BRACKET_LEADING:[")","]","}"].indexOf(e)>=0?t.CT_BRACKET_TAILING:e>="A"&&e<="Z"?t.CT_ATOM_SYMBOL_LEADING:e>="a"&&e<="z"?t.CT_ATOM_SYMBOL_FOLLOWING:t.CT_UNKNOWN},isCharTypeMatched:function(e,n){return!Kekule.ArrayUtils.intersect([t.CT_BRACKET_LEADING,t.CT_BRACKET_TAILING],[e,n]).length&&(e===n&&n!==t.CT_ATOM_SYMBOL_LEADING||n===t.CT_ATOM_SYMBOL_LEADING&&e===t.CT_ATOM_SYMBOL_FOLLOWING)}}),Kekule.FormulaUtils={FORMULA_BRACKETS:[["(",")"],["[","]"],["{","}"]],FORMULA_BRACKET_TYPE_COUNT:3,textToFormula:function(e,n,r){var o=r||null;o&&o.clear();var i=new Kekule.ChemTextAnalyzer(e);try{var a=i.getAllTokenInfos();o||(o=new Kekule.MolecularFormula(n));var s=a.length;if(s){var u,l,c=null,d=o;u={};for(var h=function(){u={}},C=function(){u&&u.obj&&d.appendSection(u.obj,u.count,u.charge)},f=0;f<s;++f){var g=a[f],p=g.tokenType,m=g.token,k=!1;if(p===t.CT_BRACKET_LEADING){C();var A=new Kekule.MolecularFormula(n);A._parentFormula=d,d=A,h(),k=!0}else if(p===t.CT_BRACKET_TAILING)C(),h(),u.obj=d,d=d._parentFormula,g.asSymbol=!0,k=!0;else if([t.CT_ATOM_SYMBOL_LEADING,t.CT_ATOM_SYMBOL_FOLLOWING].indexOf(p)>=0){u.obj&&(C(),h());var S=u.massNum;S||c&&!c.handled&&c.tokenType===t.CT_NUMBER&&(S=parseInt(c.token,10)||null);var O=""+(S||"")+m;u.obj=Kekule.ChemStructureNodeFactory.createByLabel(O),g.asSymbol=!0,k=!0}else if(p===t.CT_CHARGE_SYMBOL){if(l="+"===m?1:-1,g.asCharge=!0,c.tokenType===t.CT_NUMBER){var T;if(c.asCount)if(c.token.length>1){var b=c.token;T=b.substr(b.length-1),c.asCount&&(u.count=parseInt(b.substring(0,b.length-1),10))}else T=c.token,c.asCount&&(u.count=1);else T=c.token,c.asChargeCount=!0;l*=parseInt(T,10)}u.charge=l,k=!0}else if(p===t.CT_NUMBER){var N=parseInt(m,10);l&&c.tokenType===t.CT_CHARGE_SYMBOL&&c.asCharge?(l*=N,u.charge=l,g.asChargeCount=!0,k=!0):u.obj&&c.asSymbol?(u.count=N,g.asCount=!0,k=!0):u.obj||(u.massNum=N,k=!0)}g.handled=k,c=g}u&&u.obj&&C()}return o}finally{i.finalize()}},formulaToText:function(e,t,r){return Kekule.ObjUtils.isUnset(t)&&(t=!0),n._convFormulaToText(e,!1,t,r)},_convFormulaToText:function(e,t,r,o){var i="",a=e.getSections();if(t){var s=e.getMaxNestedLevel()%n.FORMULA_BRACKET_TYPE_COUNT,u=n.FORMULA_BRACKETS[s][0],l=n.FORMULA_BRACKETS[s][1];i+=u}for(var c=0,d=a.length;c<d;++c){var h=a[c].obj,C=e.getSectionCharge(a[c]),f=null;if(h instanceof Kekule.MolecularFormula)f=n._convFormulaToText(h,!0,!1,!1,o);else if(h.getLabel){f=h.getLabel();h.getMassNumber&&h.getMassNumber()&&(f=(i?" ":"")+f)}if(f){var g=!1;if(1!=a[c].count&&(f+=a[c].count,g=!0),r&&C)f+=(g?" ":"")+n._convChargeToText(C,o);i+=f}}(t&&(i+=l),r)&&((C=e.getCharge())&&(i+=n._convChargeToText(C,o)));return i},_convChargeToText:function(e,t){if(!e)return null;var n=e>0?"+":"-",r=Math.abs(e),o=n;return 1!=r&&(o=(t?Kekule.NumUtils.toDecimals(r,t):r.toString())+n),o}};var n=Kekule.FormulaUtils;ClassEx.defineProp(Kekule.MolecularFormula,"text",{dataType:DataType.STRING,serializable:!1,getter:function(){return n.formulaToText(this)},setter:function(e){n.textToFormula(e,this.getParent(),this)}})}(),function(){"use strict";Kekule.Glyph={},Kekule.Glyph.Base=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.Glyph.Base",initialize:function($super,e,t,n){$super(e),t&&this.setCoord2D(t),n&&this.setCoord3D(n)},initProperties:function(){},getAutoIdPrefix:function(){return"g"},getAllowChildCoordStickTo:function(e,t){return!1},getChildAcceptCoordStickFrom:function(e,t){return!1},getChildUseCoordStickOffset:function(e,t){return null}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.Glyph.Base)}(),function(){"use strict";Kekule.Glyph.ElectronArrowGlyphUtils={isValidChemNodeOrConnectorStickTarget:function(e){var t=e instanceof Kekule.ChemStructureNode||e instanceof Kekule.ChemStructureConnector;if(!t&&e instanceof Kekule.ChemMarker.BaseMarker){var n=e.getParent&&e.getParent();n&&(t=n instanceof Kekule.ChemStructureNode||n instanceof Kekule.ChemStructureConnector)}return t},isValidElectronTarget:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.isValidChemNodeOrConnectorStickTarget(e)},getValidElectronTarget:function(e){var t=e&&e.getCoordStickTarget&&e.getCoordStickTarget();return t&&Kekule.Glyph.ElectronArrowGlyphUtils.isValidElectronTarget(t)?t:null},setValidElectronTarget:function(e,t){e.getAllowCoordStickTo&&e.getAllowCoordStickTo(t)&&(t?Kekule.Glyph.ElectronArrowGlyphUtils.isValidElectronTarget(t)&&e.setCoordStickTarget(t):e.setCoordStickTarget(null))},getValidElectronTargetNodeOrConnector:function(e){var t=null,n=Kekule.Glyph.ElectronArrowGlyphUtils.getValidElectronTarget(e);return n&&(t=n instanceof Kekule.ChemMarker.BaseMarker?n.getParent():n),t}}}(),function(){"use strict";var e=Kekule.CoordUtils,t=Kekule.CoordMode;Kekule.Glyph.PathGlyphNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphNode",initialize:function($super,e,t,n,r){$super(e),n&&this.setCoord2D(n),r&&this.setCoord3D(r),this.setNodeType(t||Kekule.Glyph.NodeType.LOCATION)},initProperties:function(){this.defineProp("nodeType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLIC}),this.defineProp("pathNodeParams",{dataType:DataType.HASH,scope:Class.PropertyScope.PUBLISHED,getter:function(){var e=this.getPropStoreFieldValue("pathNodeParams");return e||(e={},this.setPropStoreFieldValue("pathNodeParams",e)),e},setter:function(e){e?this.setPropStoreFieldValue("pathNodeParams",Object.extend({},e,!0)):this.setPropStoreFieldValue("pathNodeParams",null)}})},initPropValues:function($super){$super()},getAllowCoordStickTo:function(e){if(!e||!this.isSiblingWith(e)){var t=this.getParent();if(t&&t.getAllowChildCoordStickTo)return t.getAllowChildCoordStickTo(this,e)}return!1},getAcceptCoordStickFrom:function(e){var t=this.getParent();return!(!t||!t.getChildAcceptCoordStickFrom)&&t.getChildAcceptCoordStickFrom(this,e)},notifyCoordStickTargetChanged:function($super,e,t){$super(e,t);var n=this.getParent();if(Kekule.ObjUtils.isUnset(this.getPathNodeParams().useStickingOffset)&&n.getChildUseCoordStickOffset){var r=n.getChildUseCoordStickOffset(this,t);Kekule.ObjUtils.notUnset(r)&&(this.getPathNodeParams().useStickingOffset=r)}n.notifyChildCoordStickTargetChanged&&n.notifyChildCoordStickTargetChanged(this.oldTarget,t)}}),Kekule.Glyph.NodeType={LOCATION:"location",CONTROLLER:"controller",HIDDEN:"hidden"},Kekule.Glyph.PathGlyphConnectorControlNode=Class.create(Kekule.BaseStructureNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphConnectorControlNode",initialize:function($super,e,t,n){$super(e),t&&this.setCoord2D(t),n&&this.setCoord3D(n)},initPropValues:function($super){$super(),this.setInteractMode(Kekule.ChemObjInteractMode.UNSELECTABLE)},getAutoIdPrefix:function(){return"cn"},getAcceptCoordStickFrom:function(e){return!1},getParentConnector:function(){var e=this.getParent();return e&&e instanceof Kekule.Glyph.PathGlyphConnector?e:null},isPositioned:function(e,n){return e||(e=t.COORD2D),this.doCheckIsPositioned(e,n)},doCheckIsPositioned:function(e,t){return!0},resetPosition:function(e){return e?this.doResetPosition(e):(this.doResetPosition(t.COORD2D),this.doResetPosition(t.COORD3D)),this},doResetPosition:function(e){}}),Kekule.Glyph.PathType={LINE:"L",ARC:"A"},Kekule.Glyph.ArrowType={NONE:null,OPEN:"open",TRIANGLE:"triangle"},Kekule.Glyph.ArrowSide={DEFAULT:0,BOTH:0,SINGLE:1,REVERSED:-1},Kekule.Glyph.PathGlyphConnector=Class.create(Kekule.BaseStructureConnector,{CLASS_NAME:"Kekule.Glyph.PathGlyphConnector",initialize:function($super,e,t,n){$super(e,n),this.setPathType(t)},initProperties:function(){this.defineProp("pathType",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,enumSource:Kekule.Glyph.PathType}),this.defineProp("pathParams",{dataType:DataType.HASH,scope:Class.PropertyScope.PUBLISHED,getter:function(){var e=this.getPropStoreFieldValue("pathParams");return e||(e={},this.setPropStoreFieldValue("pathParams",e)),e},setter:function(e){e?this.setPropStoreFieldValue("pathParams",Object.extend({},e,!0)):this.setPropStoreFieldValue("pathParams",null)}}),this.defineProp("controlPoints",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLISHED,getter:function(e){var t=this.getPropStoreFieldValue("controlPoints");return!t&&e&&(t=[],this.setPropStoreFieldValue("controlPoints",t)),t},setter:function(e){this.clearControlPoints(),this.setPropStoreFieldValue("controlPoints",e),this._updateControlPointsOwner(),this._updateControlPointsParent()}})},initPropValues:function($super){$super(),this.setInteractMode(Kekule.ChemObjInteractMode.UNSELECTABLE)},_appendChildObj:function($super,e){var t=$super(e);return e instanceof Kekule.Glyph.PathGlyphConnectorControlNode&&this.tryResetControlPointPosition(e),t},doPropChanged:function($super,e,t){return"connectedObjs"===e&&this.tryResetAllControlPointPositions(),$super(e,t)},getAbsCoord2D:function(e){return this.getAbsCoordOfMode(Kekule.CoordMode.COORD2D,e)},getAbsCoord3D:function(e){return this.getAbsCoordOfMode(Kekule.CoordMode.COORD2D,e)},getAbsCoordOfMode:function(e,t){for(var n=Kekule.CoordUtils,r={x:0,y:0},o=0,i=0,a=this.getConnectedObjCount();i<a;++i){var s=this.getConnectedObjAt(i);if(s&&s.getAbsCoordOfMode){var u=s.getAbsCoordOfMode(e,t);u&&(++o,r=n.add(r,u))}}return n.divide(r,o)},getChildSubgroupNames:function($super){return["controlPoint"].concat($super())},getBelongChildSubGroupName:function($super,e){return e instanceof Kekule.Glyph.PathGlyphArcConnectorControlNode?"controlPoint":$super(e)},getControlPointCount:function(){var e=this.getControlPoints();return e&&e.length||0},getControlPointAt:function(e){return(this.getControlPoints()||[])[e]},indexOfControlPoint:function(e){var t=this.getControlPoints();return t?t.indexOf(e):-1},removeControlPointAt:function(e){var t=null,n=this.getControlPoints();return n&&e>=0&&e<n.length&&((t=n.splice(e,1)).setOwner&&t.setOwner(null),t.setParent&&t.setParent(null),this.notifyPropSet("controlPoints",this.getControlPoints())),t},removeControlPoint:function(e){var t=null,n=this.getControlPoints();if(n){var r=n.indexOf(e);r>=0&&(n.splice(r,1),e.setOwner&&e.setOwner(null),e.setParent&&e.setParent(null),t=e,this.notifyPropSet("controlPoints",this.getControlPoints()))}return t},insertControlPointAt:function(e,t){var n=this.getControlPoints();if(n&&t<n.length){var r=Kekule.ArrayUtils.insertUniqueEx(n,e,t);return r.isInserted&&(e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this),this.notifyPropSet("controlPoints",this.getControlPoints())),r.index}return-1},insertControlPointBefore:function(e,t){var n=this.getControlPoints();if(n){var r=t?this.indexOfControlPoint(t):-1;return r<0&&(r=n.length),this.insertControlPointAt(e,r)}return-1},tryResetControlPointPosition:function(e){if(e.isPositioned&&e.resetPosition)for(var n=[t.COORD2D,t.COORD3D],r=0,o=n.length;r<o;++r){var i=n[r];e.isPositioned(i,!0)||e.resetPosition(i)}},tryResetAllControlPointPositions:function(){for(var e=0,t=this.getControlPointCount();e<t;++e){var n=this.getControlPointAt(e);this.tryResetControlPointPosition(n)}},removeChildObj:function(e){return this.removeControlPoint(e)},hasChildObj:function(e){return this.hasChild(e)},getNextSiblingOfChild:function(e){var t=this.indexOfChild(e);return++t,this.getChildAt(t)},_updateControlPointsOwner:function(e){e||(e=this.getOwner());var t=this.getControlPoints();if(t)for(var n=0,r=t.length;n<r;++n){var o=t[n];o.setOwner&&o.setOwner(e)}},_updateControlPointsParent:function(e){e||(e=this);var t=this.getControlPoints();if(t)for(var n=0,r=t.length;n<r;++n){var o=t[n];o.setParent&&o.setParent(e)}},clearControlPoints:function(){var e=this.getControlPoints();if(e&&(e=Kekule.ArrayUtils.clone(e)),this.setPropStoreFieldValue("controlPoints",null),e)for(var t=0,n=e.length;t<n;++t){var r=e[t];r.setOwner&&r.setOwner(null),r.setParent&&r.setParent(null)}return this.notifyPropSet("controlPoints",null),this},modifyPathParams:function(e){if(e){var t=this.getPathParams();return t=Object.extend(t,e||{}),this.setPathParams(t),t}return null}}),Kekule.Glyph.PathGlyphArcConnectorControlNode=Class.create(Kekule.Glyph.PathGlyphConnectorControlNode,{CLASS_NAME:"Kekule.Glyph.PathGlyphArcConnectorControlNode",initProperties:function(){this.defineProp("distanceToChord",{dataType:DataType.FLOAT})},doCheckIsPositioned:function(e,t){return this.getIndirectCoordRefCoords(e,t)&&Kekule.ObjUtils.notUnset(this.getDistanceToChord())},doResetPosition:function(n){if(n===t.COORD2D){var r=this.getIndirectCoordRefCoords(n,!0);if(r&&r[0]&&r[1]){var o=e.getDistance(r[0],r[1]);this.setDistanceToChord(.5*o),this.notifyPropSet("coord2D",this.getCoord2D())}}},doGetEnableIndirectCoord:function(){return!0},getIndirectCoordRefCoords:function($super,e,t){var n=this.getParentConnector();return n&&n.getConnectedObjCount()>=2?[n.getConnectedObjAt(0).getAbsCoordOfMode(t),n.getConnectedObjAt(1).getAbsCoordOfMode(t)]:$super(e)},calcIndirectCoordValue:function($super,n,r){if(n===t.COORD2D){var o=this.getDistanceToChord();if(Kekule.ObjUtils.notUnset(o)){var i=this.getIndirectCoordRefCoords();if(i){var a=i[0],s=i[1];if(a&&s){var u=e.substract(s,a),l=Math.sign(u.x),c=Math.sign(u.y);if(Kekule.NumUtils.isFloatEqual(u.x,0,1e-10))h={x:-o*c,y:0};else if(Kekule.NumUtils.isFloatEqual(u.y,0,1e-10))h={x:0,y:o*l};else{var d=-1/(u.y/u.x),h={x:-c*o/Math.sqrt(1+Math.sqr(d))};h.y=h.x*d}return h}}}}return $super(n,r)},saveIndirectCoordValue:function($super,n,r,o,i){if(n===t.COORD2D){var a=o,s=this.getIndirectCoordRefCoords();if(s){var u=s[0],l=s[1],c=e.substract(l,u),d=Math.atan2(c.y,c.x),h=(e.getDistance(u,l),e.substract(r,a)),C=Math.atan2(h.y,h.x),f=e.getDistance(r,a)*Math.sin(C-d),g=(this.getDistanceToChord()||0)+f;return this.setDistanceToChord(g),g}}return $super(n,r)}}),Kekule.Glyph.PathGlyphArcConnector=Class.create(Kekule.Glyph.PathGlyphConnector,{CLASS_NAME:"Kekule.Glyph.PathGlyphArcConnector",initialize:function($super,e,t){$super(e,Kekule.Glyph.PathType.ARC,t);var n=new Kekule.Glyph.PathGlyphArcConnectorControlNode(null,{x:0,y:0});this.setControlPoints([n])},getControlPoint:function(){return(this.getControlPoints()||[])[0]}}),Kekule.Glyph.PathGlyph=Class.create(Kekule.Glyph.Base,{CLASS_NAME:"Kekule.Glyph.PathGlyph",initialize:function($super,e,t,n,r,o){$super(e,r,o),this.createDefaultStructure(t||1,n||{})},doFinalize:function($super){this.hasCtab()&&this.getCtab().finalize(),$super()},initProperties:function(){this.defineProp("ctab",{dataType:"Kekule.StructureConnectionTable",scope:Class.PropertyScope.PUBLIC,getter:function(e){return this.getPropStoreFieldValue("ctab")||e&&this.createCtab(),this.getPropStoreFieldValue("ctab")},setter:function(e){var t=this.getPropStoreFieldValue("ctab");t&&(t.finalize(),t=null),e&&(e.setPropValue("parent",this,!0),e.setOwner(this.getOwner())),this.setPropStoreFieldValue("ctab",e)}}),this.defineProp("nodes",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getNodes():[]}}),this.defineProp("connectors",{dataType:DataType.ARRAY,serializable:!1,scope:Class.PropertyScope.PUBLIC,setter:null,getter:function(){return this.hasCtab()?this.getCtab().getConnectors():[]}})},createDefaultStructure:function(e,t){e||(e=1);var n={},r=["startArrowLength","startArrowWidth","endArrowLength","endArrowWidth"];for(var o in t)r.indexOf(o)>=0?n[o]=t[o]*e:n[o]=t[o];return this.doCreateDefaultStructure(e,n)},doCreateDefaultStructure:function(e,t){},getAutoIdPrefix:function(){return"p"},ownerChanged:function($super,e,t){this.hasCtab()&&this.getCtab().setOwner(e),$super(e,t)},_removeChildObj:function($super,e){if(this.hasCtab()){var t=this.getCtab();t===e?this.removeCtab():t.hasChildObj(e)&&t.removeChildObj(e)}$super(e)},isEmpty:function(){return this.getCtab().isEmpty()},createCtab:function(){var e=new Kekule.StructureConnectionTable(this.getOwner(),this);this.setPropStoreFieldValue("ctab",e),e.addEventListener("propValueSet",function(e){"nodes"==e.propName&&this.notifyPropSet(e.propName,e.propValue)},this),e.setEnablePropValueSetEvent(!0)},hasCtab:function(){return!!this.getPropStoreFieldValue("ctab")},getContainerBox:function($super,e,t){return this.hasCtab()?this.getCtab().getContainerBox(e,t):$super(e)},getNodeById:function(e){return this.hasCtab()?this.getCtab().getNodeById(e):null},getConnectorById:function(e){return this.hasCtab()?this.getCtab().getConnectorById(e):null},getObjectById:function(e){var t=this.getNodeById(e);return t||this.getConnectorById(e)},getNodeCount:function(){return this.hasCtab()?this.getCtab().getNodeCount():0},getNodeAt:function(e){return this.hasCtab()?this.getCtab().getNodeAt(e):null},indexOfNode:function(e){return this.hasCtab()?this.getCtab().indexOfNode(e):-1},hasNode:function(e,t){return this.hasCtab()?this.getCtab().hasNode(e,t):null},appendNode:function(e){return this.doGetCtab(!0).appendNode(e)},insertNodeAt:function(e,t){return this.doGetCtab(!0).insertNodeAt(e,t)},insertNodeBefore:function(e,t){var n=t?this.indexOfNode(t):-1;return n<0?this.appendNode(e):this.doGetCtab(!0).insertNodeAt(e,n)},removeNodeAt:function(e,t){return this.hasCtab()?this.getCtab().removeNodeAt(e,t):null},removeNode:function(e,t){return this.hasCtab()?this.getCtab().removeNode(e,t):null},replaceNode:function(e,t){return this.hasCtab()?this.getCtab().replaceNode(e,t):null},clearNodes:function(){if(this.hasCtab())return this.getCtab().clearNodes()},nodesHasCoord2D:function(e){return!!this.hasCtab()&&this.getCtab().nodesHasCoord2D(e)},nodesHasCoord3D:function(e){return!!this.hasCtab()&&this.getCtab().nodesHasCoord3D(e)},getConnectorCount:function(){return this.hasCtab()?this.getCtab().getConnectorCount():0},getConnectorAt:function(e){return this.hasCtab()?this.getCtab().getConnectorAt(e):null},indexOfConnector:function(e){return this.hasCtab()?this.getCtab().indexOfConnector(e):-1},hasConnector:function(e,t){return this.hasCtab()?this.getCtab().hasConnector(e,t):null},appendConnector:function(e){return this.doGetCtab(!0).appendConnector(e)},insertConnectorAt:function(e,t){return this.doGetCtab(!0).insertConnectorAt(e,t)},insertConnectorBefore:function(e,t){var n=t?this.indexOfConnector(t):-1;return n<0?this.appendConnector(e):this.doGetCtab(!0).insertConnectorAt(e,n)},removeConnectorAt:function(e,t){return this.hasCtab()?this.getCtab().removeConnectorAt(e,t):null},removeConnector:function(e,t){return this.hasCtab()?this.getCtab().removeConnector(e,t):null},clearConnectors:function(){if(this.hasCtab())return this.getCtab().clearConnectors()},_getObjsNeedToBeCascadeRemoved:function(e,t){return this.hasCtab()?this.getCtab()._getObjsNeedToBeCascadeRemoved(e,t):[]},getChildSubgroupNames:function($super){return["node","connector"].concat($super())},getBelongChildSubGroupName:function($super,e){return e instanceof Kekule.Glyph.PathGlyphNode?"node":e instanceof Kekule.Glyph.PathGlyphConnector?"connector":$super(e)},removeChildObj:function(e,t,n){this.hasCtab()&&this.getCtab().removeChildObj(e,t,n)},hasChildObj:function(e){return!!this.hasCtab()&&this.getCtab().hasChildObj(e)},getNextSiblingOfChild:function(e){return this.hasCtab()?this.getCtab().getNextSiblingOfChild(e):null},getDirectManipulationTarget:function(){return null}})}(),function(){"use strict";var e=Kekule.ObjUtils,t=(Kekule.Glyph.NodeType,Kekule.Glyph.PathType),n=Kekule.CoordUtils,r=Kekule.CoordMode;Kekule.Glyph.StraightLine=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.StraightLine",initialize:function($super,e,t,n,r,o){$super(e,t,n,r,o)},doCreateDefaultStructure:function(e,n){var r=Kekule.CoordUtils,o={x:0,y:0},i={x:0,y:0,z:0},a={x:e*(n.lineLength||1)},s=new Kekule.Glyph.PathGlyphNode(null,null,o,i),u=new Kekule.Glyph.PathGlyphNode(null,null,r.add(o,a),r.add(i,a)),l=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[s,u]);this._applyParamsToConnector(l,n),this.appendNode(s),this.appendNode(u),this.appendConnector(l)},_applyParamsToConnector:function(e,t){var n=Object.create(t);Kekule.ObjUtils.isUnset(t.autoOffset)&&(n.autoOffset=!1),e.setPathParams(n)},getDirectManipulationTarget:function(){return this.getNodeAt(this.getNodeCount()-1)}}),Kekule.Glyph.Polygon=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.Polygon",initialize:function($super,e,t,n,r,o){$super(e,t,n,r,o)},getRefLengthRatio:function(){return 1},doCreateDefaultStructure:function(e,n){for(var r,o,i=Kekule.CoordUtils,a={x:0,y:0},s={x:0,y:0,z:0},u=n.nodeProps,l=n.connectorProps,c=e*(n.lineLength||1)*this.getRefLengthRatio(),d=n.edgeCount||3,h=2*Math.PI/d,C=d%2?0:-h/2,f=0;f<d;++f){var g={x:c*Math.sin(C),y:c*Math.cos(C)},p=new Kekule.Glyph.PathGlyphNode(null,null,i.add(a,g),i.add(s,g));if(u&&p.setPropValues(u),this.appendNode(p),0===f&&(r=p),o){var m=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[o,p]);l&&m.setPropValues(l),this._applyParamsToConnector(m,n),this.appendConnector(m)}o=p,C+=h}m=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[p,r]);l&&m.setPropValues(l),this._applyParamsToConnector(m,n),this.appendConnector(m)},_applyParamsToConnector:function(e,t){e.setPathParams(t)}}),Kekule.Glyph.BaseArc=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.BaseArc",initialize:function($super,e,t,n,r,o){$super(e,t,n,r,o)},doCreateDefaultStructure:function(e,t){var n=Kekule.CoordUtils,r={x:0,y:0},o={x:0,y:0,z:0},i={x:e*(t.lineLength||1)},a=new Kekule.Glyph.PathGlyphNode(null,null,r,o),s=new Kekule.Glyph.PathGlyphNode(null,null,n.add(r,i),n.add(o,i));this.appendNode(a),this.appendNode(s);var u=new Kekule.Glyph.PathGlyphArcConnector(null,[a,s]);this._applyParamsToConnector(u,t),this.appendConnector(u),u.setInteractMode(Kekule.ChemObjInteractMode.HIDDEN)},getDirectManipulationTarget:function(){return this.getNodeAt(this.getNodeCount()-1)},_isValidChemNodeOrConnectorStickTarget:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.isValidChemNodeOrConnectorStickTarget(e)},_applyParamsToConnector:function(e,t){e.setPathParams(t)},getAllowChildCoordStickTo:function(e,t){return!t||this._isValidChemNodeOrConnectorStickTarget(t,e)&&!this._isChildrenStickingTo(t,[e])},getChildUseCoordStickOffset:function($super,e,t){return t instanceof Kekule.ChemStructureNode||t instanceof Kekule.ChemStructureConnector},_isChildrenStickingTo:function(e,t){for(var n=this.getNodes(),r=0,o=(n=Kekule.ArrayUtils.exclude(n,t||[])).length;r<o;++r){if(n[r].getCoordStickTarget()===e)return!0}return!1}}),Kekule.Glyph.BaseTwinArc=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.BaseTwinArc",DEF_MIN_PATH_END_DISTANCE_RATIO:.05,DEF_INIT_PATH_END_GAP_RATIO:.2,FIELD_ARC_END_NODE_FLAG:"__$arcEndNode$__",initialize:function($super,e,t,n,r,o){this.setPropStoreFieldValue("minPathEndDistanceRatio",this.DEF_MIN_PATH_END_DISTANCE_RATIO),$super(e,t,n,r,o)},initProperties:function(){this.defineProp("minPathEndDistanceRatio",{dataType:DataType.FLOAT}),this.defineProp("oppositePathEndArrowSides",{dataType:DataType.BOOL,serializable:!1,getter:function(){return this._isPathArrowSideOpposite("end")},setter:function(e){this._setPathArrowSideOpposite("end",!!e)}}),this.defineProp("oppositePathStartArrowSides",{dataType:DataType.BOOL,serializable:!1,getter:function(){return this._isPathArrowSideOpposite("start")},setter:function(e){this._setPathArrowSideOpposite("start",!!e)}})},loaded:function($super){var e=$super();return this._isTwinArcSetup()&&(this._setupArcEndNode(this.getNodeAt(1)),this._setupArcEndNode(this.getNodeAt(2))),e},_isPathArrowSideOpposite:function(t){var n=this.getConnectorCount();if(n<2)return null;for(var r,o=null,i=0;i<n;++i){var a=this.getConnectorAt(i).getPathParams();if(a[t+"ArrowType"]===Kekule.Glyph.ArrowType.NONE)return null;var s=a[t+"ArrowSide"];if(s===Kekule.Glyph.ArrowSide.BOTH)return null;if(0===i)r=s;else{var u=r!==s;if(e.isUnset(o))o=u;else if(o!==u)return null;r=s}}return o},_setPathArrowSideOpposite:function(t,n){var r=this.getConnectorCount();if(r<2)return null;for(var o,i=Kekule.Glyph.ArrowSide,a=!0,s=0;s<r;++s){var u=this.getConnectorAt(s).getPathParams();u[t+"ArrowType"]===Kekule.Glyph.ArrowType.NONE&&(a=!1);var l,c=u[t+"ArrowSide"];if(c===Kekule.Glyph.ArrowSide.BOTH&&(a=!1),a)if(e.isUnset(o))o=c;else l=n?o===i.SINGLE?i.REVERSED:i.SINGLE:o,u[t+"ArrowSide"]=l,o=l;else o=null}return null},_isTwinArcSetup:function(){return 2===this.getConnectorCount()&&4===this.getNodeCount()},getDirectManipulationTarget:function(){return this.getNodeAt(this.getNodeCount()-1)},doCreateDefaultStructure:function(e,t){var r=Kekule.CoordUtils,o={x:0,y:0},i={x:0,y:0,z:0},a=t.lineLength||1,s=t.minPathEndDistanceRatio||this.getMinPathEndDistanceRatio()||this.DEF_MIN_PATH_END_DISTANCE_RATIO,u=a*s;this.setMinPathEndDistanceRatio(s);var l=t.pathEndGap||a*this.DEF_INIT_PATH_END_GAP_RATIO,c={x:e*((a-(l=Math.max(l,u)))/2)},d={x:e*l},h={x:e*a},C=new Kekule.Glyph.PathGlyphNode(null,null,o,i),f=new Kekule.Glyph.PathGlyphNode(null,null);this._setupArcEndNode(f);var g=new Kekule.Glyph.PathGlyphNode(null,null),p=new Kekule.Glyph.PathGlyphNode(null,null,r.add(o,h),r.add(i,h));this._setupArcEndNode(g),this.appendNode(C),this.appendNode(f),this.appendNode(g),this.appendNode(p),f.setCoord2D(r.add(o,c)).setCoord3D(r.add(i,c)),g.setCoord2D(r.add(o,n.add(c,d))).setCoord3D(r.add(i,n.add(c,d)));var m=new Kekule.Glyph.PathGlyphArcConnector(null,[C,f]),k=new Kekule.Glyph.PathGlyphArcConnector(null,[p,g]);this._applyParamsToConnector(m,t),this._applyParamsToConnector(k,t),k.getControlPointAt(0).setDistanceToChord(-k.getControlPointAt(0).getDistanceToChord()),this.appendConnector(m),this.appendConnector(k),m.setInteractMode(Kekule.ChemObjInteractMode.HIDDEN),k.setInteractMode(Kekule.ChemObjInteractMode.HIDDEN)},_applyParamsToConnector:function(e,t){e.setPathParams(t)},_setupArcEndNode:function(e){e[this.FIELD_ARC_END_NODE_FLAG]||(this._overwriteChildPathNodeMethods(e),e.setEnableIndirectCoord(!0),e[this.FIELD_ARC_END_NODE_FLAG]=!0)},_overwriteChildPathNodeMethods:function(e){e.overwriteMethod("getIndirectCoordRefLengths",this._insideNodeGetIndirectCoordRefLengths).overwriteMethod("getIndirectCoordRefCoords",this._insideNodeGetIndirectCoordRefCoords).overwriteMethod("calcIndirectCoordStorage",this._insideNodeCalcIndirectCoordStorage).overwriteMethod("calcIndirectCoordValue",this._insideNodeCalcIndirectCoordValue).overwriteMethod("_childPathNodeGetParentGlyph",this._childPathNodeGetParentGlyph).overwriteMethod("_childPathNodeGetGlyphMinPathEndDistanceRatio",this._childPathNodeGetGlyphMinPathEndDistanceRatio)},_getArrowStartingNodes:function(){var e=[];if(this._isTwinArcSetup())for(var t=0,n=this.getConnectorCount();t<n;++t){var r=this.getConnectorAt(t).getConnectedObjAt(0);r&&e.push(r)}return e},_childPathNodeGetParentGlyph:function(e){var t=this.getParent();return t instanceof Kekule.Glyph.BaseTwinArc?t:null},_childPathNodeGetGlyphMinPathEndDistanceRatio:function(e){var t=this._childPathNodeGetParentGlyph();return t&&t.getMinPathEndDistanceRatio()},_insideNodeGetIndirectCoordRefLengths:function(e,t,n){var r=this.getParent();if(!r||t!==Kekule.CoordMode.COORD2D)return e(t,n);var o=r.getNodeAt(0),i=r.getNodeAt(r.getNodeCount()-1);if(o&&i){var a=o.getAbsCoordOfMode(t),s=i.getAbsCoordOfMode(t),u=Kekule.CoordUtils.getDistance(s,a);return{x:u,y:u,length:u}}},_insideNodeGetIndirectCoordRefCoords:function(e,t,n){var o=this.getParent();if(!o||t!==r.COORD2D)return e(t,n);var i=o.getNodeAt(0),a=o.getNodeAt(o.getNodeCount()-1);return i&&a?[i.getCoordOfMode(t),a.getCoordOfMode(t)]:void 0},_insideNodeCalcIndirectCoordStorage:function(e,t,o,i,a){var s=this.getParent();if(s&&t===r.COORD2D){var u=this.getIndirectCoordRefCoords(t,a);if(u){var l=s.getNodeAt(0).getCoordOfMode(t),c=Kekule.GeometryUtils.getPerpendicularCrossPointFromCoordToLine(o,u[0],u[1],!1);if(!c)c=n.getDistance(o,u[0])<n.getDistance(o,u[1])?u[0]:u[1];var d=n.getDistance(l,c),h=n.getDistance(u[1],u[0]),C=h?d/h:0,f=this._childPathNodeGetGlyphMinPathEndDistanceRatio()||0;return C<f?C=f:C>1-f&&(C=1-f),{x:C,y:C,ratio:C}}}return e(t,o,i,a)},_insideNodeCalcIndirectCoordValue:function(e,t,o){var i=this.getParent();if(i&&t===r.COORD2D){var a=this.getIndirectCoordRefCoords(t,o);if(a){var s=n.substract(a[1],a[0]),u=i.getNodeAt(0).getCoordOfMode(t),l=this.getIndirectCoordStorageOfMode(t).ratio;if(Kekule.ObjUtils.notUnset(l)){var c=n.multiply(s,l);return n.add(u,c)}}}return e(t,o)},_isValidChemNodeOrConnectorStickTarget:function(e){var t=e instanceof Kekule.ChemStructureNode||e instanceof Kekule.ChemStructureConnector;if(!t&&e instanceof Kekule.ChemMarker.BaseMarker){var n=e.getParent&&e.getParent();n&&(t=n instanceof Kekule.ChemStructureNode||n instanceof Kekule.ChemStructureConnector)}return t},getAllowChildCoordStickTo:function(e,t){var n=this.indexOfNode(e);return(0===n||n===this.getNodeCount()-1)&&(!t||this._isValidChemNodeOrConnectorStickTarget(t,e)&&!this._isChildrenStickingTo(t,[e]))},getChildUseCoordStickOffset:function($super,e,t){return t instanceof Kekule.ChemStructureNode||t instanceof Kekule.ChemStructureConnector},_isChildrenStickingTo:function(e,t){for(var n=this._getArrowStartingNodes(),r=0,o=(n=Kekule.ArrayUtils.exclude(n,t||[])).length;r<o;++r){if(n[r].getCoordStickTarget()===e)return!0}return!1}}),Kekule.Glyph.Arc=Class.create(Kekule.Glyph.BaseArc,{CLASS_NAME:"Kekule.Glyph.Arc"}),Kekule.Glyph.TwinArc=Class.create(Kekule.Glyph.BaseTwinArc,{CLASS_NAME:"Kekule.Glyph.TwinArc"})}(),function(){"use strict";var e=Kekule.ObjUtils,t=(Kekule.Glyph.NodeType,Kekule.Glyph.PathType),n=Kekule.Glyph.ElectronArrowGlyphUtils;Kekule.Glyph.HeatSymbol=Class.create(Kekule.Glyph.Polygon,{CLASS_NAME:"Kekule.Glyph.HeatSymbol",initialize:function($super,e,t,n,r,o){$super(e,t,n,r,o),this.setRenderOption&&this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return.25},doCreateDefaultStructure:function($super,e,t){return t.edgeCount=3,t.nodeProps=Object.extend(t.nodeProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN}),t.connectorProps=Object.extend(t.connectorProps||{},{interactMode:Kekule.ChemObjInteractMode.HIDDEN}),$super(e,t)},_applyParamsToConnector:function($super,e,t){return $super(e,t)}}),Kekule.Glyph.AddSymbol=Class.create(Kekule.Glyph.PathGlyph,{CLASS_NAME:"Kekule.Glyph.AddSymbol",initialize:function($super,e,t,n,r,o){$super(e,t,n,r,o),this.setRenderOption&&this.setRenderOption("strokeWidth",1.5)},getRefLengthRatio:function(){return.5},doCreateDefaultStructure:function(e,n){var r={interactMode:Kekule.ChemObjInteractMode.HIDDEN},o={interactMode:Kekule.ChemObjInteractMode.HIDDEN},i=Kekule.CoordUtils,a={x:0,y:0},s={x:0,y:0,z:0},u=e*this.getRefLengthRatio()*(n.lineLength||1)/2,l=new Kekule.Glyph.PathGlyphNode(null,null,a,s);l.setPropValues(r),this.appendNode(l);for(var c=[{x:-u,y:0},{x:0,y:-u},{x:u,y:0},{x:0,y:u}],d=0,h=c.length;d<h;++d){var C=c[d],f=new Kekule.Glyph.PathGlyphNode(null,null,i.add(a,C),i.add(s,C));f.setPropValues(r);var g=new Kekule.Glyph.PathGlyphConnector(null,t.LINE,[l,f]);g.setPropValues(o),this._applyParamsToConnector(g,n),this.appendNode(f),this.appendConnector(g)}},_applyParamsToConnector:function(e,t){e.setPathParams(t)}}),Kekule.Glyph.Segment=Class.create(Kekule.Glyph.StraightLine,{CLASS_NAME:"Kekule.Glyph.Segment"}),Kekule.Glyph.ReactionArrowType={NORMAL:"normal",REVERSIBLE:"reversible",RESONANCE:"resonance",RETROSYNTHESIS:"retrosynthesis",CUSTOM:"custom"},Kekule.Glyph.ReactionArrowType.getDefPathParamOfArrowType=function(e){var t,n=Kekule.Glyph.ReactionArrowType,r=Kekule.Glyph.ArrowType,o=Kekule.Glyph.ArrowSide;switch(e){case n.NORMAL:t={startArrowType:r.NONE,endArrowType:r.OPEN,endArrowSide:o.BOTH,lineCount:1};break;case n.REVERSIBLE:t={startArrowType:r.OPEN,startArrowSide:o.REVERSED,endArrowType:r.OPEN,endArrowSide:o.SINGLE,lineGap:.1,lineCount:2};break;case n.RESONANCE:t={startArrowType:r.OPEN,startArrowSide:o.BOTH,endArrowType:r.OPEN,endArrowSide:o.BOTH,lineCount:1};break;case n.RETROSYNTHESIS:t={startArrowType:r.NONE,endArrowType:r.OPEN,endArrowSide:o.BOTH,lineGap:.1,lineCount:2};break;default:t=null}return t},Kekule.Glyph.ReactionArrow=Class.create(Kekule.Glyph.StraightLine,{CLASS_NAME:"Kekule.Glyph.ReactionArrow",initProperties:function(){this.defineProp("reactionType",{dataType:DataType.STRING,enumSource:Kekule.Glyph.ReactionArrowType,setter:function(e){this.setPropStoreFieldValue("reactionType",e),this.reactionTypeChanged(e)}})},initPropValues:function($super){$super(),this.setReactionType(Kekule.Glyph.ReactionArrowType.NORMAL)},doCreateDefaultStructure:function($super,e,t){var n=t,r=t.reactionType||this.getReactionType();if(r){var o=this._getPathParamOfArrowType(r);n=Object.extend(o,t)}var i=$super(e,n);return r&&this.setReactionType(r),i},reactionTypeChanged:function(e){var t=this._getPathParamOfArrowType(e);if(t){var n=this.getConnectorAt(0);n&&n.modifyPathParams(t)}},_getPathParamOfArrowType:function(e){return Kekule.Glyph.ReactionArrowType.getDefPathParamOfArrowType(e)}}),Kekule.Glyph.ElectronPushingArrow=Class.create(Kekule.Glyph.BaseArc,{CLASS_NAME:"Kekule.Glyph.ElectronPushingArrow",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.INT,getter:function(){var e=this._getValidArrowSide(),t=Kekule.Glyph.ArrowSide;return e===t.BOTH?2:[t.SINGLE,t.REVERSED].indexOf(e)>=0?1:null},setter:function(e){var t=Kekule.Glyph.ArrowSide,n=this._getValidArrowPos(),r=this.getConnectorAt(0);n||(r.getPathParams().endArrowType=Kekule.Glyph.ArrowType.OPEN,n="end");var o=r.getPathParams();e>=2?o[n+"ArrowSide"]=t.BOTH:1===e&&(o[n+"ArrowSide"]=t.SINGLE),r.setPathParams(o)}}),this.defineProp("directReceptor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(1);return this._getValidElectronTarget(e)},setter:function(e){var t=this.getNodeAt(1);this._setValidElectronTarget(t,e)}}),this.defineProp("directDonor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(0);return this._getValidElectronTarget(e)},setter:function(e){var t=this.getNodeAt(0);this._setValidElectronTarget(t,e)}}),this.defineProp("receptor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(1);return this._getValidElectronTargetNodeOrConnector(e)},setter:function(e){var t=this.getNodeAt(1);this._setValidElectronTarget(t,e)}}),this.defineProp("donor",{dataType:"Kekule.ChemStructureObject",getter:function(){var e=this.getNodeAt(0);return this._getValidElectronTargetNodeOrConnector(e)},setter:function(e){var t=this.getNodeAt(0);this._setValidElectronTarget(t,e)}})},doCreateDefaultStructure:function($super,e,t){var n=$super(e,t);return t.electronCount&&this.setElectronCount(t.electronCount),n},_isValidElectronTarget:function(e){return this._isValidChemNodeOrConnectorStickTarget(e)},_getValidElectronTarget:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.getValidElectronTarget(e)},_setValidElectronTarget:function(e,t){return Kekule.Glyph.ElectronArrowGlyphUtils.setValidElectronTarget(e,t),this},_getValidElectronTargetNodeOrConnector:function(e){return Kekule.Glyph.ElectronArrowGlyphUtils.getValidElectronTargetNodeOrConnector(e)},_getValidArrowPos:function(){var e=this.getConnectorAt(0),t=e&&e.getPathParams();if(t){if(t.endArrowType)return"end";if(t.startArrowType)return"start"}return null},_getValidArrowSide:function(){var e=this.getConnectorAt(0),t=e&&e.getPathParams();if(t){if(t.endArrowType)return t.endArrowSide||Kekule.Glyph.ArrowSide.DEFAULT;if(t.startArrowType)return t.startArrowSide||Kekule.Glyph.ArrowSide.DEFAULT}return null},_applyParamsToConnector:function(e,t){var n=Object.create(t);Kekule.ObjUtils.isUnset(t.autoOffset)&&(n.autoOffset=!0),e.setPathParams(n)}}),Kekule.Glyph.BondFormingElectronPushingArrow=Class.create(Kekule.Glyph.BaseTwinArc,{CLASS_NAME:"Kekule.Glyph.BondFormingElectronPushingArrow",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.INT,getter:function(){for(var t=null,n=0,r=this.getConnectorCount();n<r;++n){var o=this._getConnectorElectronCount(this.getConnectorAt(n));if(e.notUnset(o))if(e.isUnset(t))t=o;else if(t!==o)return null}return t*this.getConnectorCount()},setter:function(e){if(e!==this.getElectronCount()){var t=this.getConnectorCount()?e/this.getConnectorCount():e;(t=Math.round(t))<=0&&(t=1);for(var n=Kekule.Glyph.ArrowSide,r=this.getConnectors(),o=0,i=r.length;o<i;++o){var a=r[o];a.getPathParams().endArrowType=Kekule.Glyph.ArrowType.OPEN,"end";var s=a.getPathParams();t>=2?s.endArrowSide=n.BOTH:1===t&&(s.endArrowSide=o%2?n.SINGLE:n.REVERSED),a.setPathParams(s)}}}}),this.defineProp("directDonors",{dataType:DataType.ARRAY,getter:function(){for(var e=this._getArrowStartingNodes(),t=[],r=0,o=e.length;r<o;++r){var i=n.getValidElectronTarget(e[r]);i&&t.push(i)}return t},setter:function(e){var t=this._getArrowStartingNodes();if(t.length)for(var r=0,o=t.length;r<o;++r){var i=t[r];e[r];n.setValidElectronTarget(i,e)}}}),this.defineProp("donors",{dataType:DataType.ARRAY,getter:function(){for(var e=this._getArrowStartingNodes(),t=[],r=0,o=e.length;r<o;++r){var i=n.getValidElectronTargetNodeOrConnector(e[r]);i&&t.push(i)}return t},setter:function(e){this.setDirectDonors(e)}})},_getConnectorElectronCount:function(e){var t=e&&e.getPathParams();if(t){var n=Kekule.Glyph.ArrowSide,r=t.endArrowType?t.endArrowSide||Kekule.Glyph.ArrowSide.DEFAULT:null;if(r===n.BOTH)return 2;if([n.SINGLE,n.REVERSED].indexOf(r)>=0)return 1}return null},doCreateDefaultStructure:function($super,e,t){var n=$super(e,t);return this.setElectronCount(t.electronCount||1),n}})}(),function(){"use strict";Kekule.CoordMode,Kekule.CoordUtils;Kekule.ContentBlock=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ContentBlock",initialize:function($super,e,t,n){$super(e),t&&this.setCoord2D(t),n&&this.setCoord3D(n)},initProperties:function(){this.defineProp("needRecalcSize",{dataType:DataType.BOOL})},getAutoIdPrefix:function(){return"b"},getCornerCoord1:function(e,t){return this.getCoordOfMode(e,t)},getCornerCoord2:function(e,t){var n=this.getCornerCoord1(e,t),r=this.getSizeOfMode(e,t);return Kekule.CoordUtils.add(n,r)},getContainerBox:function($super,e,t){var n=this.getAbsCoordOfMode(e,t)||{},r=this.getSizeOfMode(e,t)||{};if(e===Kekule.CoordMode.COORD3D)var o=Kekule.CoordUtils.add(n,this.getSizeOfMode(e,t)||{});else o={x:n.x+r.x,y:n.y-r.y};return Kekule.BoxUtils.createBox(n,o)}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ContentBlock),Kekule.ClassDefineUtils.addStandardSizeSupport(Kekule.ContentBlock),Kekule.TextBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.TextBlock",initialize:function($super,e,t,n,r){$super(e,n,r),this.setText(t||"")},initProperties:function(){this.defineProp("text",{dataType:DataType.STRING})},getAutoIdPrefix:function(){return"t"},doObjectChange:function($super,e){Kekule.ArrayUtils.intersect(["text","renderOptions"],e).length&&this.setNeedRecalcSize(!0)}}),Kekule.ImageBlock=Class.create(Kekule.ContentBlock,{CLASS_NAME:"Kekule.ImageBlock",initialize:function($super,e,t,n,r){$super(e,n,r),t&&this.setSrc(t)},initProperties:function(){this.defineProp("src",{dataType:DataType.STRING,scope:Class.PropertyScope.PUBLISHED,setter:function(e){e!==this.getSrc()&&(this.setPropStoreFieldValue("src",e),this._clearCacheImg())}}),this.defineProp("cacheImg",{dataType:DataType.OBJECT,scope:Class.PropertyScope.PUBLIC,serializable:!1,setter:null,getter:function(){var e=this.getPropStoreFieldValue("cacheImg");return!e&&Kekule.$document&&(e=this._createCacheImg(this.getSrc())),e}})},getAutoIdPrefix:function(){return"g"},_createCacheImg:function(e){var t,n=Kekule.$document;return n&&n.body&&n.createElement&&((t=n.createElement("img")).src=e),t},_clearCacheImg:function(){var e=this.getPropStoreFieldValue("cacheImg");if(e){e.src="";try{delete e.width,delete e.height}catch(e){}}}})}(),function(){"use strict";var e=Kekule.ArrayUtils;Kekule.ChemMarker={},ClassEx.extend(Kekule.ChemObject,{isAttachedMarker:function(){var e=this.getParent();return e&&e.hasMarker(this)},notifyAttachedMarkersChanged:function(){this.notifyPropSet("attachedMarkers",this.getPropStoreFieldValue("attachedMarkers"))},_attachedMarkerAdded:function(e){},_attachedMarkerRemoved:function(e){},getMarkerCount:function(){var e=this.getPropStoreFieldValue("attachedMarkers");return e?e.length:0},getMarkerAt:function(e){var t=this.getPropStoreFieldValue("attachedMarkers");return t?t[e]:null},getMarkerOfType:function(e,t){for(var n=0,r=this.getMarkerCount();n<r;++n){var o=this.getMarkerAt(n);if(t&&o.getClass()===e||o instanceof e)return o}return null},getMarkersOfType:function(e,t){for(var n=[],r=0,o=this.getMarkerCount();r<o;++r){var i=this.getMarkerAt(r);(t&&i.getClass()===e||i instanceof e)&&n.push(i)}return n},fetchMarkerOfType:function(e,t,n,r){var o=this.getMarkerOfType(e,n);if(!o&&t){(o=new e).beginUpdate();try{r&&o.setPropValues(r),this.appendMarker(o)}finally{o.endUpdate()}}return o},getUnplacedMarkers:function(e){for(var t=[],n=0,r=this.getMarkerCount();n<r;++n){var o=this.getMarkerAt(n);o.getCoordOfMode(e)||t.push(o)}return t},indexOfMarker:function(e){var t=this.getPropStoreFieldValue("attachedMarkers");return t?t.indexOf(e):-1},hasMarker:function(e){return this.indexOfMarker(e)>=0},hasMarkerOfType:function(e,t){return!!this.getMarkerOfType(e,t)},appendMarker:function(e){var t=this.indexOfMarker(e);if(t>=0)return t;var n=this.getAttachedMarkers(!0).push(e);e.beginUpdate();try{e.setOwner&&e.setOwner(this.getOwner()),e.setParent&&e.setParent(this),this._attachedMarkerAdded(e)}finally{e.endUpdate()}return this.notifyAttachedMarkersChanged(),n},insertMarkerBefore:function(e,t){var n=this.indexOfMarker(t);return this.insertMarkerAt(e,n)},insertMarkerAt:function(t,n){this.indexOfMarker(t);var r=this.getAttachedMarkers(!0);(Kekule.ObjUtils.isUnset(n)||n<0)&&(n=r.length);var o=e.insertUniqueEx(r,t,n);return o.isInserted&&(t.setOwner&&t.setOwner(this.getOwner()),t.setParent&&t.setParent(this),this._attachedMarkerAdded(t)),this.notifyAttachedMarkersChanged(),o.index},setMarkerIndex:function(e,t){var n=this.indexOfMarker(e);if(n>=0){var r=this.getPropStoreFieldValue("attachedMarkers");r.splice(n,1),r.splice(t,0,e)}},removeMarkerAt:function(e){var t=this.getMarkerAt(e);if(t){var n=this.getAttachedMarkers(!0).splice(e,1);return t.setOwner&&t.setOwner(null),t.setParent&&t.setParent(null),this._attachedMarkerRemoved(t),this.notifyAttachedMarkersChanged(),n}},removeMarker:function(e){var t=this.indexOfMarker(e);if(t>=0)return this.removeMarkerAt(t)},replaceMarker:function(e,t){var n=this.indexOfMarker(e);return n<0?this:(this.removeMarkerAt(n),this.insertMarkerAt(t,n),this)},clearMarkers:function(){var t=this.getPropStoreFieldValue("attachedMarkers");if(t&&(t=e.clone(t)),this.setPropStoreFieldValue("attachedMarkers",null),t)for(var n=0,r=t.length;n<r;++n){var o=t[n];o.setOwner&&o.setOwner(null),o.setParent&&o.setParent(null),this._attachedMarkerRemoved(o)}return this.notifyAttachedMarkersChanged(),this},autoSetMarker2DPos:function(e,t,n,r){if(this.hasMarker(e)){var o=Kekule.ChemStructureUtils.getMostEmptyDirection2DAngleOfObj(this,[e],n,!0,!1,r),i={x:t*Math.cos(o),y:t*Math.sin(o)};e.setCoord2D(i)}},_updateAttachedMarkersOwner:function(e){e||(e=this.getOwner());for(var t=0,n=this.getMarkerCount();t<n;++t){var r=this.getMarkerAt(t);r.setOwner&&r.setOwner(e)}},_updateAttachedMarkersParent:function(e){e||(e=this);for(var t=0,n=this.getMarkerCount();t<n;++t){var r=this.getMarkerAt(t);r.setParent&&r.setParent(e)}}}),ClassEx.extendMethod(Kekule.ChemObject,"ownerChanged",function($origin,e){$origin(e),this._updateAttachedMarkersOwner(e)}),ClassEx.extendMethod(Kekule.ChemObject,"removeChild",function($origin,e){var t=$origin(e);return t||(t=this.removeMarker(e)),t}),ClassEx.extendMethod(Kekule.ChemObject,"insertBefore",function($origin,e,t){var n=$origin(e,t);return n<0&&(t&&this.hasMarker(t)||e instanceof Kekule.ChemMarker.BaseMarker)&&(n=this.insertMarkerBefore(e,t)),n}),ClassEx.extendMethod(Kekule.ChemObject,"getChildSubgroupNames",function($origin){return $origin().concat("marker")}),ClassEx.defineProp(Kekule.ChemObject,"attachedMarkers",{dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLISHED,getter:function(e){var t=this.getPropStoreFieldValue("attachedMarkers");return!t&&e&&(t=[],this.setPropStoreFieldValue("attachedMarkers",t)),t},setter:function(e){this.clearMarkers(),this.setPropStoreFieldValue("attachedMarkers",e),this._updateAttachedMarkersOwner(),this._updateAttachedMarkersParent()}})}(),function(){"use strict";Kekule.ChemMarker.BaseMarker=Class.create(Kekule.ChemObject,{CLASS_NAME:"Kekule.ChemMarker.BaseMarker",initialize:function($super,e,t,n){$super(e,t,n)},getAutoIdPrefix:function(){return"marker"},getAcceptCoordStickFrom:function(e){return!(this.isSiblingWith(e)||e instanceof Kekule.ChemStructureNode||e instanceof Kekule.BaseStructureConnector)}}),Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ChemMarker.BaseMarker),Kekule.ChemMarker.UnbondedElectronSet=Class.create(Kekule.ChemMarker.BaseMarker,{CLASS_NAME:"Kekule.ChemMarker.UnbondedElectronSet",initProperties:function(){this.defineProp("electronCount",{dataType:DataType.VARIANT})},initPropValues:function($super){$super(),this.setElectronCount(2)},getAutoIdPrefix:function(){return"electron"}}),Kekule.ChemMarker.ChemPropertyMarker=Class.create(Kekule.ChemMarker.BaseMarker,{CLASS_NAME:"Kekule.ChemMarker.ChemPropertyMarker",initProperties:function(){this.defineProp("value",{dataType:DataType.VARIANT,serializable:!1,getter:function(){var e,t=this.getParent(),n=this.getPropertyName();return t&&n?(e=t.getPropValue(n),this.setPropStoreFieldValue("value",e)):e=this.getPropStoreFieldValue("value"),e},setter:function(e){this.setPropStoreFieldValue("value",e),this.setParentPropValue(e)}})},initPropValues:function($super){$super()},setParentPropValue:function(e){var t=this.getParent();if(t){var n=this.getPropertyName();n&&t&&t.setPropValue(n,e)}return this},resetParentPropValue:function(){return this.setParentPropValue(void 0)},getPropertyName:function(){return null},beforAddingByEditor:function($super,e,t){if(e){var n=this.getPropStoreFieldValue("value");Kekule.ObjUtils.notUnset(n)&&this.setParentPropValue(n)}$super()},beforeRemovingByEditor:function(e){this.setPropStoreFieldValue("value",this.getValue()),this.resetParentPropValue()}}),Kekule.ChemMarker.Charge=Class.create(Kekule.ChemMarker.ChemPropertyMarker,{CLASS_NAME:"Kekule.ChemMarker.Charge",getPropertyName:function(){return"charge"},getAutoIdPrefix:function(){return"charge"}}),Kekule.ChemMarker.Radical=Class.create(Kekule.ChemMarker.ChemPropertyMarker,{CLASS_NAME:"Kekule.ChemMarker.Radical",getPropertyName:function(){return"radical"},getAutoIdPrefix:function(){return"radical"}}),ClassEx.extend(Kekule.ChemStructureNode,{fetchChargeMarker:function(e,t){return this.fetchMarkerOfType(Kekule.ChemMarker.Charge,e,!1,t)},fetchRadicalMarker:function(e,t){return this.fetchMarkerOfType(Kekule.ChemMarker.Radical,e,!1,t)}}),ClassEx.defineProp(Kekule.AbstractAtom,"lonePairCount",{dataType:DataType.INT,scope:Class.PropertyScope.PUBLISHED,serializable:!1,setter:null,getter:function(){for(var e=0,t=this.getMarkersOfType(Kekule.ChemMarker.UnbondedElectronSet),n=0,r=t.length;n<r;++n){2===t[n].getElectronCount()&&++e}return e}}),ClassEx.extendMethod(Kekule.AbstractAtom,"doCompare",function($origin,e,t){var n=$origin(e,t);if(!n&&t.method===Kekule.ComparisonMethod.CHEM_STRUCTURE&&(this._getComparisonOptionFlagValue(t,"lonePair")||this._getComparisonOptionFlagValue(t,"unbondedElectron"))){var r=function(e){var t=[];if(e.getMarkersOfType)for(var n=e.getMarkersOfType(Kekule.ChemMarker.UnbondedElectronSet),r=0,o=n.length;r<o;++r){var i=n[r];t.push(i.getElectronCount())}return t.sort(),t},o=r(this),i=r(e);return Kekule.ArrayUtils.compare(o,i)}return n})}();