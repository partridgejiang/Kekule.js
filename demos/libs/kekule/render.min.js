(function(){var b=Kekule;var c=Kekule.ChemStructureNodeLabels;var a=Kekule.CoordMode;ClassEx.extend(Kekule.ChemObject,{getDefCoordPos:function(e){return Kekule.Render.CoordPos.CENTER},getCoordPos:function(f){var e=(f===Kekule.CoordMode.COORD3D)?this.getPropStoreFieldValue("coordPos3D"):this.getPropStoreFieldValue("coordPos2D");if(Kekule.ObjUtils.isUnset(e)){e=this.getDefCoordPos(f)}return e},getOverrideRenderOptions:function(h){if(h&&h.length){var e={};for(var g=0,f=h.length;g<f;++g){e=Object.extend(e,h[g])}return e}return null},_appendOverrideRenderOptionItem:function(g,e){var h=this.getPropStoreFieldValue(e);if(!h){h=[];this.setPropStoreFieldValue(e,h)}var f=h.indexOf(g);if(f>=0){h.splice(f,1)}h.push(g);this.notifyPropSet(e,h);return this},_deleteOverrideRenderOptionItem:function(g,e){var h=this.getPropStoreFieldValue(e);if(!h){return}var f=h.indexOf(g);if(f>=0){h.splice(f,1);this.notifyPropSet(e,h)}return this},addOverrideRenderOptionItem:function(e){return this._appendOverrideRenderOptionItem(e,"overrideRenderOptionItems")},addOverrideRender3DOptionItem:function(e){return this._appendOverrideRenderOptionItem(e,"overrideRender3DOptionItems")},removeOverrideRenderOptionItem:function(e){return this._deleteOverrideRenderOptionItem(e,"overrideRenderOptionItems")},removeOverrideRender3DOptionItem:function(e){return this._deleteOverrideRenderOptionItem(e,"overrideRender3DOptionItems")},getOverriddenRenderOptions:function(){var f=this.getRenderOptions()||{};var e=f;var g=this.getOverrideRenderOptions(this.getOverrideRenderOptionItems());if(g){e=Object.extend(e,g)}return e},getOverriddenRender3DOptions:function(){var e=Object.create(this.getRender3DOptions()||null);var f=this.getOverrideRenderOptions(this.getOverrideRender3DOptionItems());if(f){e=Object.extend(e,f)}return e},setRenderOption:function(g,e){var f=this.getRenderOptions();if(!f){this.setRenderOptions({})}var f=this.getRenderOptions();if(f[g]!==e){f[g]=e;this.notifyPropSet("renderOptions",f)}},setRender3DOption:function(g,e){var f=this.getRender3DOptions();if(!f){this.setRender3DOptions({})}var f=this.getRender3DOptions();if(f[g]!==e){f[g]=e;this.notifyPropSet("render3DOptions",f)}},getRenderOption:function(g){var f=this.getOverriddenRenderOptions();var e=(f?f[g]:undefined);return e},getRender3DOption:function(g){var f=this.getOverriddenRender3DOptions();var e=(f?f[g]:undefined);return e},getCascadedRenderOption:function(i){var h=this.getOverriddenRenderOptions();var e=(h?h[i]:undefined);if(Kekule.ObjUtils.isUnset(e)){var f=this.getParent?this.getParent():null;var g=f&&f.getCascadedRenderOption?f.getCascadedRenderOption(i):undefined;e=g}return e},getCascadedRender3DOption:function(i){var h=this.getOverriddenRender3DOptions();var e=(h?h[i]:undefined);if(Kekule.ObjUtils.isUnset(e)){var f=this.getParent?this.getParent():null;var g=f&&f.getCascadedRender3DOption?f.getCascadedRender3DOption(i):undefined;e=g}return e},getBaseCoord:function(h,f){var i=this.getCoordPos(h);var e=this.getCoordOfMode?this.getCoordOfMode(h,f):null;if(e&&i!==Kekule.Render.CoordPos.CENTER){if(i===Kekule.Render.CoordPos.CORNER_TL){var g=this.getExposedContainerBox(h,f);var j={x:(g.x2-g.x1)/2,y:(g.y2-g.y1)/2};if(h===a.COORD3D){j.z=(g.z2-g.z1)/2}if(h===a.COORD3D){e=Kekule.CoordUtils.add(e,j)}else{e.x+=j.x;e.y-=j.y}}}return e},getBaseCoord2D:function(e){return this.getBaseCoord(Kekule.CoordMode.COORD2D,e)},getBaseCoord3D:function(e){return this.getBaseCoord(Kekule.CoordMode.COORD3D,e)},getAbsBaseCoord:function(h,f){var i=this.getCoordPos(h);var e=this.getAbsCoordOfMode?this.getAbsCoordOfMode(h,f):null;if(e&&i!==Kekule.Render.CoordPos.CENTER){if(i===Kekule.Render.CoordPos.CORNER_TL){var g=this.getExposedContainerBox(h,f);var j={x:(g.x2-g.x1)/2,y:(g.y2-g.y1)/2};if(h===a.COORD3D){j.z=(g.z2-g.z1)/2}if(h===a.COORD3D){e=Kekule.CoordUtils.add(e,j)}else{e.x+=j.x;e.y-=j.y}}}return e},getAbsBaseCoord2D:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD2D,e)},getAbsBaseCoord3D:function(e){return this.getAbsBaseCoord(Kekule.CoordMode.COORD3D,e)},setAbsBaseCoord:function(i,g,e){var h=this.getCoordPos(g);var k=Kekule.CoordUtils.clone(i);if(i&&h!==Kekule.Render.CoordPos.CENTER){if(h===Kekule.Render.CoordPos.CORNER_TL){var f=this.getExposedContainerBox(g,e);var j={x:(f.x2-f.x1)/2,y:(f.y2-f.y1)/2};if(g===a.COORD3D){j.z=(f.z2-f.z1)/2}if(g===a.COORD3D){k=Kekule.CoordUtils.substract(k,j)}else{k.x-=j.x;k.y+=j.y}}}if(this.setAbsCoordOfMode){this.setAbsCoordOfMode(k,g)}else{if(this.setCoordOfMode){this.setCoordOfMode(k,g)}}return this},setAbsBaseCoord2D:function(f,e){return this.setAbsCoordOfMode(f,Kekule.CoordMode.COORD2D,e)},setAbsBaseCoord3D:function(f,e){return this.setAbsCoordOfMode(f,Kekule.CoordMode.COORD3D,e)},getExposedAncestor:function(){var e=this.getParent();if(!e){return this}else{if(e.isExpanded()){return this}else{return e.getExposedAncestor()}}},isExposed:function(){var e=this.getParent();return(!e)||(e.isExpanded())},isExpanded:function(){return true},setExpanded:function(e){},getLinkedExposedObjs:function(){var e=[];for(var n=0,g=this.getLinkedConnectorCount();n<g;++n){var f=this.getLinkedConnectorAt(n);if(!f.isExposed()){continue}var o=f.getConnectedExposedObjs();for(var m=0,h=o.length;m<h;++m){if(o[m]!==this){Kekule.ArrayUtils.pushUnique(e,o[m])}}}return e},getExposedContainerBox:function(g,f){var e=this.getContainerBox(g,f);return e},getAllAutoScaleRefLengths:function(f,e){return[]},getAllContainingConnectors:function(){if(this.getAllChildConnectors){return this.getAllChildConnectors()}else{return[]}},getConnectorLengthMedian:function(g,f){var e=this.getAllContainingConnectors();return Kekule.ChemStructureUtils.getConnectorLengthMedian(e,g,f)}});ClassEx.defineProps(Kekule.ChemObject,[{name:"coordPos2D",dataType:DataType.INT,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getCoordPos(Kekule.CoordMode.COORD2D)}},{name:"coordPos3D",dataType:DataType.INT,scope:Class.PropertyScope.PUBLIC,getter:function(){return this.getCoordPos(Kekule.CoordMode.COORD3D)}},{name:"renderOptions",dataType:DataType.OBJECT},{name:"render3DOptions",dataType:DataType.OBJECT},{name:"overrideRenderOptionItems",dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC},{name:"overrideRender3DOptionItems",dataType:DataType.ARRAY,scope:Class.PropertyScope.PUBLIC}]);ClassEx.extend(Kekule.ChemObjList,{getAllContainingConnectors:function(){var e=[];for(var g=0,f=this.getItemCount();g<f;++g){var h=this.getItemAt(g);if(h.getAllContainingConnectors){e=e.concat(h.getAllContainingConnectors())}}return e},getAllAutoScaleRefLengths:function(j,g){var e=[];for(var h=0,f=this.getItemCount();h<f;++h){var k=this.getItemAt(h);if(k.getAllAutoScaleRefLengths){e=e.concat(k.getAllAutoScaleRefLengths(j,g))}}return e},getExposedContainerBox:function(k,g){var e;var m=this.toArray();for(var h=0,f=m.length;h<f;++h){var n=m[h];if(!n.isExposed()){continue}var j=n.getExposedContainerBox?n.getExposedContainerBox(k,g):n.getContainerBox?n.getContainerBox(k,g):null;if(j){if(!e){e=Kekule.BoxUtils.clone(j)}else{e=Kekule.BoxUtils.getContainerBox(e,j)}}}return e}});Kekule.ClassDefineUtils.addStandardCoordSupport(Kekule.ChemObjList);ClassEx.extend(Kekule.ChemSpaceElement,{getAllContainingConnectors:function(){return this.getChildren().getAllContainingConnectors()},getAllAutoScaleRefLengths:function(f,e){return this.getChildren().getAllAutoScaleRefLengths(f,e)}});ClassEx.extend(Kekule.ChemSpace,{getAllContainingConnectors:function(){return this.getRoot().getAllContainingConnectors()},getAllAutoScaleRefLengths:function(g,f){var e;if(this.getDefAutoScaleRefLength()){e=[this.getDefAutoScaleRefLength()]}else{e=this.getRoot().getAllAutoScaleRefLengths(g,f)}return e}});ClassEx.defineProps(Kekule.ChemObject,[{name:"defAutoScaleRefLength",dataType:DataType.NUMBER,scope:Class.PropertyScope.PUBLIC}]);ClassEx.extend(Kekule.BaseStructureConnector,{getBaseCoord:function(g,e){var n=Kekule.CoordMode;var p=null;var o=0;var m=(g===n.COORD2D)?{x:0,y:0}:{x:0,y:0,z:0};for(var j=0,f=this.getConnectedObjCount();j<f;++j){var h=this.getConnectedObjAt(j);var k=h.getBaseCoord?h.getBaseCoord(g,e):null;if(k){m=Kekule.CoordUtils.add(m,k);++o}}if(o){p=Kekule.CoordUtils.divide(m,o)}return p},getAbsBaseCoord:function(g,e){var n=Kekule.CoordMode;var p=null;var o=0;var m=(g===n.COORD2D)?{x:0,y:0}:{x:0,y:0,z:0};for(var j=0,f=this.getConnectedObjCount();j<f;++j){var h=this.getConnectedObjAt(j);var k=h.getAbsBaseCoord?h.getAbsBaseCoord(g,e):null;if(k){m=Kekule.CoordUtils.add(m,k);++o}}if(o){p=Kekule.CoordUtils.divide(m,o)}return p},getConnectedExposedObjs:function(){var j=this.getConnectedObjs();var e=[];for(var g=0,f=j.length;g<f;++g){var h=j[g].getExposedAncestor();if(e.indexOf(h)<0){e.push(h)}}return e},getLength:function(g,e){var i=this.getConnectedObjs();if(i.length!==2){return null}else{var h=i[0].getAbsBaseCoord?i[0].getAbsBaseCoord(g,e):null;var f=i[1].getAbsBaseCoord?i[1].getAbsBaseCoord(g,e):null;return Kekule.CoordUtils.getDistance(h,f)}},getLength2D:function(e){return this.getLength(Kekule.CoordMode.COORD2D,e)},getLength3D:function(e){return this.getLength(Kekule.CoordMode.COORD3D,e)}});ClassEx.extend(Kekule.ChemStructureConnector,{getAllAutoScaleRefLengths:function(f,e){return[this.getLength(f,e)]}});ClassEx.extend(Kekule.BaseStructureNode,{getBaseCoord:function(f,e){return this.getCoordOfMode(f,e)},getAbsBaseCoord:function(f,e){return this.getAbsCoordOfMode(f,e)},getExposedContainerBox:function(g,f){var e=this.getContainerBox(g,f);return e},getExposedContainerBox2D:function(f){var e=this.getExposedContainerBox(Kekule.CoordMode.COORD2D,f);e.width=e.x2-e.x1;e.height=e.y2-e.y1;return e},getExposedContainerBox3D:function(f){var e=this.getExposedContainerBox(Kekule.CoordMode.COORD3D,f);e.deltaX=e.x2-e.x1;e.deltaY=e.y2-e.y1;e.deltaZ=e.z2-e.z1;return e}});ClassEx.extend(Kekule.ChemStructureNode,{getDisplayRichText:function(l,j,e,h,m,f){var i=Kekule.Render;if(Kekule.ObjUtils.isUnset(j)){j=true}var n=i.RichTextUtils.create();var k;var g=this.getRenderOption("customLabel");if(g){k=i.RichTextUtils.strToRichText(g)}else{k=this.getCoreDisplayRichTextItem(l,j,e,h)}if(k){if(j){k=this.appendElectronStateDisplayText(k,h,m,f)}if(k){i.RichTextUtils.append(n,k);n.anchorItem=k}}return n},getCoreDisplayRichTextItem:function(h,g,e,f){return null},appendElectronStateDisplayText:function(l,f,m,e){var g=Kekule.Render;var h=this.getCharge();var i=this.getRadical();var j=g.ChemDisplayTextUtils.createElectronStateDisplayTextSection(h,i,f,m,e);if(j){var k=g.RichTextUtils.createGroup();g.RichTextUtils.append(k,l);g.RichTextUtils.append(k,j);k.charDirection=Kekule.Render.TextDirection.LTR;k.anchorItem=l;return k}else{return l}}});ClassEx.extend(Kekule.AbstractAtom,{getDisplayRichText:function($super,k,j,e,g,l,f){var h=Kekule.Render;if(!k){k=h.HydrogenDisplayLevel.DEFAULT}var m=$super(k,j,e,g,l,f);var i=0;switch(k){case h.HydrogenDisplayLevel.NONE:i=0;break;case h.HydrogenDisplayLevel.ALL:i=this.getHydrogenCount();break;case h.HydrogenDisplayLevel.EXPLICIT:i=this.getExplicitHydrogenCount();break;case h.HydrogenDisplayLevel.UNMATCHED_EXPLICIT:if(this.getImplicitHydrogenCount&&(this.getImplicitHydrogenCount()!==this.getExplicitHydrogenCount())){i=this.getExplicitHydrogenCount()}break}if(i){m=this.appendHydrogenDisplayText(m,i)}return m},appendHydrogenDisplayText:function(h,e){var f=Kekule.Render;if(e){if(e>1){var i=f.RichTextUtils.createGroup();i.charDirection=Kekule.Render.TextDirection.LTR;var g=f.RichTextUtils.appendText2(i,"H");f.RichTextUtils.appendText(i,e.toString(),{textType:f.RichText.SUB,refItem:g});f.RichTextUtils.append(h,i)}else{f.RichTextUtils.appendText(h,"H")}}return h}});ClassEx.extend(Kekule.Atom,{getCoreDisplayRichTextItem:function(l,i,e,g){var h=Kekule.Render;var m=h.RichTextUtils.createGroup();var k=this.getIsotopeAlias();var f=this.getSymbol();if(k||this.getSymbol()!==b.Element.UNSET_ELEMENT){var j;if(k&&Kekule.ChemStructureNodeLabels.ENABLE_ISOTOPE_ALIAS){j=h.RichTextUtils.createSection(this.getIsotopeAlias(),{charDirection:Kekule.Render.TextDirection.LTR});m=h.RichTextUtils.append(m,j);m.anchorItem=j}else{j=h.RichTextUtils.createSection(this.getSymbol(),{charDirection:Kekule.Render.TextDirection.LTR});m=h.RichTextUtils.append(m,j);m.anchorItem=j;if(this.getMassNumber()!==Kekule.Isotope.UNSET_MASSNUMBER){m=h.RichTextUtils.insertText(m,0,this.getMassNumber().toString(),{textType:h.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR,refItem:m.anchorItem});m.charDirection=Kekule.Render.TextDirection.LTR}}}else{m=h.RichTextUtils.appendText(m,(e&&e.getUnsetElement())||c.UNSET_ELEMENT)}return m}});ClassEx.extend(Kekule.Pseudoatom,{getCoreDisplayRichTextItem:function(k,h,f,g){var j=Kekule.Render;var i;var l=f;i=this.getLabel();if(!i){i=(l&&l.getUnsetElement())||c.UNSET_ELEMENT}var e=j.RichTextUtils.createSection(i,{charDirection:Kekule.Render.TextDirection.LTR});return e}});var d=function(i,f,e){var h=Kekule.Render;var g=Kekule.IsotopesDataUtil.getIsotopeIdDetail(f);var j;if(g.massNumber){j=h.RichTextUtils.appendText2(i,g.massNumber.toString(),{textType:Kekule.Render.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR})}var k=h.RichTextUtils.appendText2(i,g.symbol,{charDirection:Kekule.Render.TextDirection.LTR},e);if(j){j.refItem=k}i.charDirection=Kekule.Render.TextDirection.LTR;return i};ClassEx.extend(Kekule.VariableAtom,{getCoreDisplayRichTextItem:function(q,p,g,m){var o=Kekule.Render;var e=g;var r;if(this.isListEmpty()){r=o.RichTextUtils.strToRichText((e&&e.getVariableAtom())||c.VARIABLE_ATOM);r.charDirection=Kekule.Render.TextDirection.LTR;return r}var f=this.getAllowedIsotopeIds()||this.getDisallowedIsotopeIds();var k=this.isDisallowedList();r=o.RichTextUtils.createGroup();r.charDirection=Kekule.Render.TextDirection.LTR;if(k){r=o.RichTextUtils.appendText(r,e.getIsoListDisallowPrefix())}r=o.RichTextUtils.appendText(r,e.getIsoListLeadingBracket());if(f&&f.length){for(var n=0,j=f.length;n<j;++n){var h=f[n];if(h){if(n!=0){r=o.RichTextUtils.appendText(r,e.getIsoListDelimiter())}r=d(r,h,n==0)}}}r=o.RichTextUtils.appendText(r,e.getIsoListTailingBracket());return r}});ClassEx.extend(Kekule.StructureConnectionTable,{exposedNodesHasCoord2D:function(g){var f=this.getExposedNodes();for(var h=0,e=f.length;h<e;++h){if(f[h].hasCoord2D(g)){return true}}return false},exposedNodesHasCoord3D:function(g){var f=this.getExposedNodes();for(var h=0,e=f.length;h<e;++h){if(f[h].hasCoord3D(g)){return true}}return false},getExposedNodes:function(){var e=[];var h=this.getNodes();for(var j=0,f=h.length;j<f;++j){var k=h[j];if(k.getExposedNodes&&k.isExpanded()){var g=k.getExposedNodes();e=e.concat(g)}else{if(k.isExposed()){e.push(k)}}}return e},getExposedConnectors:function(){var e=this.getConnectors();var g=this.getNodes();for(var h=0,f=g.length;h<f;++h){var k=g[h];if(k.getConnectors&&k.isExpanded()){var j=k.getExposedConnectors();e=e.concat(j)}}return e},getExposedContainerBox:function(g,f){var e=this.getExposedNodes();if(e.length){return this.getNodesContainBox(e,g,f)}else{return null}},getExposedContainerBox2D:function(f){var e=this.getExposedContainerBox(Kekule.CoordMode.COORD2D,f);e.width=e.x2-e.x1;e.height=e.y2-e.y1;return e},getExposedContainerBox3D:function(f){var e=this.getExposedContainerBox(Kekule.CoordMode.COORD3D,f);e.deltaX=e.x2-e.x1;e.deltaY=e.y2-e.y1;e.deltaZ=e.z2-e.z1;return e},getConnectorLengthMedian:function(g,f){var e=this.getAllContainingConnectors();return Kekule.ChemStructureUtils.getConnectorLengthMedian(e,g,f)},getAllAutoScaleRefLengths:function(m,j){var h=this.getAllContainingConnectors();var e=[];for(var k=0,g=h.length;k<g;++k){var f=h[k];if(f&&f.getAllAutoScaleRefLengths){var n=f.getAllAutoScaleRefLengths(m,j);if(n){e=e.concat(n)}}}return e}});ClassEx.extend(Kekule.ContentBlock,{getDefCoordPos:function($super,e){if(e!==a.COORD3D){return Kekule.Render.CoordPos.CORNER_TL}else{return $super(e)}}});ClassEx.extend(Kekule.ChemMarker.ChemPropertyMarker,{getDefCoordPos:function($super,e){if(e!==a.COORD3D){return Kekule.Render.CoordPos.CENTER}else{return $super(e)}}});ClassEx.extend(Kekule.StructureFragment,{isExpanded:function(){var e=this.getOverriddenRenderOptions();return e?(!!e.expanded):false},setExpanded:function(e){this.setRenderOption("expanded",e)},getExposedNodes:function(){if(this.hasCtab()){return this.getCtab().getExposedNodes()}else{return[]}},getExposedConnectors:function(){if(this.hasCtab()){return this.getCtab().getExposedConnectors()}else{return[]}},exposedNodesHasCoord2D:function(e){if(this.hasCtab()){return this.getCtab().exposedNodesHasCoord2D(e)}else{return false}},exposedNodesHasCoord3D:function(e){if(this.hasCtab()){return this.getCtab().exposedNodesHasCoord3D(e)}else{return false}},getExposedContainerBox:function(g,e){if(this.hasCtab()){var f=this.getCtab().getExposedContainerBox(g,e);if(!f){f=this.getContainerBox(g,e)}return f}else{return this.getContainerBox(g,e)}},getConnectorLengthMedian:function(f,e){if(this.hasCtab()){return this.getCtab().getConnectorLengthMedian(f,e)}else{return null}},getAutoScaleRefLength:function(f,e){return this.getConnectorLengthMedian(f,e)},getAllAutoScaleRefLengths:function(f,e){if(this.hasCtab()){return this.getCtab().getAllAutoScaleRefLengths(f,e)}else{return null}}});ClassEx.extend(Kekule.SubGroup,{getCoreDisplayRichTextItem:function(l,j,e,f){var g=Kekule.Render;var i=null;var m=this.getAbbr();if(!m){if(this.getFormulaText()){i=Kekule.FormulaUtils.textToFormula(this.getFormulaText())}else{i=this.getFormula(false)||this.calcFormula()}if(!i||i.isEmpty()){m=(e&&e.getRgroup())||c.SUBGROUP}}var n;if(m){if(m.length<=3){n=g.RichTextUtils.createSection(m);n.charDirection=Kekule.Render.TextDirection.LTR}else{var h=this._indexOfFirstUppercaseLetter(m);if(h<0){h=0}n=g.RichTextUtils.createGroup();n.charDirection=Kekule.Render.TextDirection.LTR;if(h>0){k=g.RichTextUtils.createSection(m.substring(0,h));k.charDirection=Kekule.Render.TextDirection.INHERIT;n=g.RichTextUtils.append(n,k)}var k=g.RichTextUtils.createSection(m.charAt(h));n=g.RichTextUtils.append(n,k);n.anchorItem=k;if(h<m.length-1){k=g.RichTextUtils.createSection(m.substring(h+1));k.charDirection=Kekule.Render.TextDirection.INHERIT;n=g.RichTextUtils.append(n,k)}}}else{if(i){n=i.getDisplayRichText(j,e,f);var k=g.RichTextUtils.getFirstNormalTextSection(n);if(!k){k=n.items[0]}n.anchorItem=k}}return n},_indexOfFirstUppercaseLetter:function(h){for(var f=0,e=h.length;f<e;++f){var g=h.charAt(f);if(g>="A"&&g<="Z"){return f}}return -1},_autoSetSelfCoord:function(j,h){if(this._isAutoSettingSelfCoord){return}if(this.getCoordOfMode(j,h)){return}var m=this.getAnchorNodeCount();if(m<=0){return}this.beginUpdate();try{this._isAutoSettingSelfCoord=true;var f={};for(var k=0;k<m;++k){var g=this.getAnchorNodeAt(k);if(g._autoSetSelfCoord){g._autoSetSelfCoord(j,h)}var l=g.getAbsCoordOfMode(j,h);if(l){f=Kekule.CoordUtils.add(f,l)}}var n=Kekule.CoordUtils.divide(f,m);this.setAbsCoordOfMode(n,j);var e=this.getCoordOfMode(j)||{};var m=this.getNodeCount();for(var k=0;k<m;++k){var g=this.getNodeAt(k);var l=g.getCoordOfMode(j,h);if(l){l=Kekule.CoordUtils.substract(l,e);g.setCoordOfMode(l,j)}}}finally{this._isAutoSettingSelfCoord=false;this.endUpdate()}},doGetAbsCoord2D:function($super,e){this._autoSetSelfCoord(Kekule.CoordMode.COORD2D,e);return $super(e)},doGetAbsCoord3D:function($super,e){this._autoSetSelfCoord(Kekule.CoordMode.COORD3D,e);return $super(e)},doSetAbsCoord2D:function($super,e){this._autoSetSelfCoord(Kekule.CoordMode.COORD2D);return $super(e)},doSetAbsCoord3D:function($super,e){this._autoSetSelfCoord(Kekule.CoordMode.COORD3D);return $super(e)}});ClassEx.extend(Kekule.MolecularFormula,{getDisplayRichText:function(i,e,h,g,f){var j=Kekule.Render;if(Kekule.ObjUtils.isUnset(i)){i=true}return j.ChemDisplayTextUtils.formulaToRichText(this,i,null,h,e,g,f)},getDisplayText:function(g,e,f){var h=this.getDisplayRichText();return Kekule.Render.RichTextUtils.toText(h)}});ClassEx.extend(Kekule.Molecule,{afterInitialization:function(){this.setExpanded(true)}});ClassEx.extend(Kekule.CompositeMolecule,{getExposedContainerBox:function(m,g){var e=null;var j=this.getPropStoreFieldValue("subMolecules");if(j){for(var h=0,f=j.length;h<f;++h){var n=j[h];var k=n.getExposedContainerBox(m,g);if(k){if(!e){e=Kekule.BoxUtils.clone(k)}else{e=Kekule.BoxUtils.getContainerBox(e,k)}}}}return e},getAllAutoScaleRefLengths:function(m,h){var e=[];var k=this.getPropStoreFieldValue("subMolecules");if(k){for(var j=0,f=k.getItemCount();j<f;++j){var n=k.getObjAt(j);var g=n.getAllAutoScaleRefLengths(m,h);if(g){e=e.concat(g)}}}return e}})})();"use strict";Kekule.Render={};Kekule.Render.CoordSystem={CHEM:0,CONTEXT:1,SCREEN:2};Kekule.Render.RendererType={R2D:2,R3D:3};Kekule.Render.CoordPos={CENTER:0,CORNER_TL:21,DEFAULT:0};Kekule.Render.DEF_ATOM_ATOMIC_NUM=6;Kekule.Render.MoleculeDisplayType={SKELETAL:1,CONDENSED:2,DEFAULT:1};Kekule.Render.Molecule2DDisplayType=Kekule.Render.MoleculeDisplayType;Kekule.Render.NodeLabelDisplayMode={HIDDEN:-1,SHOWN:1,SMART:0,DEFAULT:0};Kekule.Render.HydrogenDisplayLevel={NONE:0,EXPLICIT:1,UNMATCHED_EXPLICIT:2,ALL:10,DEFAULT:1};Kekule.Render.TextDirection={DEFAULT:0,LTR:1,RTL:3,TTB:2,BTT:4,INHERIT:10};Kekule.Render.TextAlign={DEFAULT:0,LEFT:1,RIGHT:2,TOP:3,BOTTOM:4,CENTER:5,LEADING:10,TRAILING:11,getAbsAlign:function(e,f){var c=e;var d=Kekule.Render.TextAlign;var b=Kekule.Render.TextDirection;if((e===d.LEADING)||(e===d.TRAILING)){var a=e==d.LEADING;switch(f){case b.RTL:c=a?d.RIGHT:d.LEFT;break;case b.TTB:c=a?d.TOP:d.BOTTOM;break;case b.BTT:c=a?d.BOTTOM:d.TOP;break;case b.LTR:default:c=a?d.LEFT:d.RIGHT;break}}return c}};Kekule.Render.BoxXAlignment={LEFT:0,RIGHT:1,CENTER:2};Kekule.Render.BoxYAlignment={TOP:0,BOTTOM:1,CENTER:2};Kekule.Render.TextBoxAlignmentMode={BOX:0,ANCHOR:1};Kekule.Render.BondRenderType={SINGLE:0,DOUBLE:1,TRIPLE:2,QUAD:3,DASHED:4,DASHED_DOUBLE:5,DASHED_TRIPLE:6,SOLID_DASH:7,ARROWED:8,ARROWED_INV:9,HASHED:10,BOLD:11,BOLD_DOUBLE:12,BOLD_TRIPLE:13,BOLD_QUAD:14,BOLD_DASH:16,WEDGED_SOLID:20,WEDGED_SOLID_INV:21,WEDGED_HOLLOW:22,WEDGED_HOLLOW_INV:23,WEDGED_HASHED:24,WEDGED_HASHED_INV:25,WEDGED_SOLID_BOTH:26,WEDGED_HOLLOW_BOTH:27,WAVY:30,SCISSORS_DOUBLE:40};Kekule.Render.ChargeMarkRenderType={NUM_WITH_SYMBOL:1,DEFAULT:1,CIRCLE_AROUND:3};Kekule.Render.Render3DGraphicQuality={EXTREME_LOW:1,LOW:2,MEDIUM:3,HIGH:4,EXTREME_HIGH:5};Kekule.Render.Molecule3DDisplayType={WIRE:31,STICKS:32,BALL_STICK:33,SPACE_FILL:34,DEFAULT:33};Kekule.Render.Bond3DRenderMode={NONE:0,WIRE:1,MULTI_WIRE:2,CYLINDER:3,MULTI_CYLINDER:4,isWireMode:function(a){var b=Kekule.Render.Bond3DRenderMode;return(a===b.WIRE)||(a===b.MULTI_WIRE)},isCylinderMode:function(a){var b=Kekule.Render.Bond3DRenderMode;return(a===b.CYLINDER)||(a===b.MULTI_CYLINDER)}};Kekule.Render.Bond3DSpliceMode={UNSPLIT:1,MID_SPLIT:2,WEIGHTING_SPLIT:3};Kekule.Render.Bond3DRenderType={SINGLE:1,DOUBLE:2,TRIPLE:3,DASH:-1,SOLID_DASH:-2};Kekule.Render.Node3DRenderMode={NONE:0,BALL:1,SPACE:2};Kekule.Render.MetaShapeType={POINT:0,CIRCLE:1,LINE:2,RECT:3,ARC:5,POLYLINE:11,POLYGON:10,SPHERE:101,CYLINDER:102,COMPOSITE:-1};Kekule.Render.BoundShapeType=Kekule.Render.MetaShapeType;Kekule.Render.ObjectUpdateType={MODIFY:0,ADD:1,REMOVE:2,CLEAR:3};Kekule.Render.AbstractRenderer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.AbstractRenderer",RENDER_CACHE_FIELD:"__$renderCache$__",initialize:function($super,c,a,b){$super();this.setPropValue("chemObj",c,true);if(b){this.setParent(b)}this.setDrawBridge(a);this.setBubbleEvent(true);this._suspendUpdateStatus=0;this._suspendUpdateInfos=[]},finalize:function($super){this.setPropValue("chemObj",null,true);this.setDrawBridge(null);$super()},initProperties:function(){this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:false,setter:null});this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:false});this.defineProp("parent",{dateType:DataType.OBJECT,serializable:false});this.defineProp("parentRenderer",{dateType:"Kekule.Render.AbstractRenderer",serializable:false,getter:function(){var a=this.getParent();return(a instanceof Kekule.Render.AbstractRenderer)?a:null},setter:function(a){this.setParent(a)}});this.defineProp("redirectContext",{dataType:DataType.OBJECT,serializable:false});this.defineProp("canModifyTargetObj",{dataType:DataType.BOOL,serializable:false,getter:function(){var a=this.getPropStoreFieldValue("canModifyTargetObj");if(Kekule.ObjUtils.isUnset(a)){var b=this.getParent();if(b&&b.getCanModifyTargetObj){a=b.getCanModifyTargetObj()}}return a}});this.defineEvent("clear");this.defineEvent("updateBasicDrawObject")},isRootRenderer:function(){return !this.getParentRenderer()},getHigherLevelObj:function(){return this.getParent()},getRendererType:function(){return Kekule.Render.RendererType.R2D},getCoordMode:function(){var a=this.getRendererType();return(a===Kekule.Render.RendererType.R3D)?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D},getRenderCache:function(b){var a=this.getExtraProp(b,this.RENDER_CACHE_FIELD);if(!a){a={};this.setExtraProp(b,this.RENDER_CACHE_FIELD,a)}return a},beginDraw:function(d,e,c){var a=this.getDrawBridge();if(a.prepareContext){a.prepareContext(d)}},endDraw:function(d,e,c){var a=this.getDrawBridge();if(a.renderContext){a.renderContext(d)}},updateDrawInfoInCache:function(f,c,d,b,a){var e=this.getRenderCache(c);if(c){e.context=c}if(d){e.baseCoord=d}if(f){e.chemObj=f}if(b){e.options=b}if(a){e.realDrawOptions=a}},_isCurrChemObjNeedToBeDrawn:function(d,c){var f=this.getChemObj();for(var b=0,a=d.length;b<a;++b){var e=d[b];if((e===f)||(e.isChildOf(f))){return true}}return false},getAutoBaseCoord:function(a){return this.doGetAutoBaseCoord(a)},doGetAutoBaseCoord:function(a){return null},getCachedDrawOptions:function(a){return this.getRenderCache(a).options},getCachedDrawnElem:function(a){return this.getRenderCache(a).drawnElem},draw:function(b,i,m){try{this.__isDrawing=true;var d={};var c;var j=this.getParentRenderer();if(j){var c=j.getRenderCache().options}if(c){d=Object.create(c);d=Object.extend(d,m)}else{d=Object.create(m||null)}var k=this.getChemObj();var a=d.partialDrawObjs;if(a&&(!this._isCurrChemObjNeedToBeDrawn(a,b))){return null}var g=(this.getRendererType()===Kekule.Render.RendererType.R3D)?"getRender3DOptions":"getRenderOptions";var h=k[g]?k[g]():null;g=(this.getRendererType()===Kekule.Render.RendererType.R3D)?"getOverriddenRender3DOptions":"getOverriddenRenderOptions";var e=k[g]?k[g]():null;d=Kekule.Render.RenderOptionUtils.mergeRenderOptions(h||{},d);this.getRenderCache().options=d;d=Kekule.Render.RenderOptionUtils.mergeRenderOptions(e||{},d);this.updateDrawInfoInCache(this.getChemObj(),b,i,m,d);var f=this.isRootRenderer();this.invokeEvent("prepareDrawing",{context:b,obj:this.getChemObj()});if(f){this.beginDraw(b,i,d)}var l=this.doDraw(b,i,d);this.getRenderCache(b).drawnElem=l;if(f){this.endDraw(b,i,d)}this.invokeEvent("draw",{context:b,obj:this.getChemObj()})}finally{this.__isDrawing=false}return l},doDraw:function(b,c,a){return this.doDrawSelf(b,c,a)},doDrawSelf:function(b,c,a){return null},redraw:function(d){var c=this.isRootRenderer();if(c){var b=this.getRenderCache(d)||{};this.beginDraw(d,b.baseCoord,b.options)}var a=this.doRedraw(d);this.getRenderCache(d).drawnElem=a;if(c){this.endDraw(d,b.baseCoord,b.options)}return a},doRedraw:function(a){var b=this.getRenderCache(a);return this.draw(a,b.baseCoord,b.options)},canModifyGraphic:function(c){var a=this.getDrawBridge();return a.canModifyGraphic?a.canModifyGraphic(c):false},beginUpdateRenderer:function(){++this._suspendUpdateStatus},endUpdateRenderer:function(){--this._suspendUpdateStatus;if(this._suspendUpdateStatus<=0){this._suspendUpdateStatus=0}if(!this.isUpdatingRenderer()){this.doEndUpdateRenderer()}},doEndUpdateRenderer:function(){this.updateEx(this._suspendUpdateInfos);this._suspendUpdateInfos=[]},isUpdatingRenderer:function(){return this._suspendUpdateStatus>0},updateEx:function(o){var q;var s=true;if(!this.isUpdatingRenderer()){q=this.canModifyGraphic(c);if(q){for(var n=0,f=o.length;n<f;++n){var d=o[n];var c=d.context;for(var h=0,g=d.items.length;h<g;++h){var r=d.items[h];s=s&&this.doUpdate(c,r.updatedObjDetails,r.updateType);if(!s){break}}if(!s){break}}}else{var e=this.isRootRenderer();if(e){var m=[];for(var n=0,f=o.length;n<f;++n){var d=o[n];var c=d.context;Kekule.ArrayUtils.pushUnique(m,c)}for(var n=0,f=m.length;n<f;++n){this.getDrawBridge().clearContext(c);var a=this.getRenderCache(c);this.draw(c,a.baseCoord,a.options)}return true}else{var b=this.getParentRenderer();return b.updateEx(o)}}return s}else{if(!this._suspendUpdateInfos){this._suspendUpdateInfos=[]}this._mergeRendererUpdateInfo(this._suspendUpdateInfos,o);return true}},_mergeRendererUpdateInfo:function(d,g){for(var e=0,b=g.length;e<b;++e){var f=g[e];var c=this._indexOfContextInRendererUpdateInfos(f.context,d);if(c<0){d.push(f)}else{var a=d[c];a.items=a.items.concat(f.items)}}return d},_indexOfContextInRendererUpdateInfos:function(c,e){for(var b=0,a=e.length;b<a;++b){var d=e[b];if(d.context===c){return b}}return -1},update:function(d,g,b){var e=[];for(var c=0,a=g.length;c<a;++c){var f=g[c].obj;if(this.isChemObjRenderedBySelf(d,f)){e.push(g[c])}}if(e.length){return this.updateEx([{context:d,items:[{updateType:b,updatedObjDetails:e}]}])}else{return true}},doUpdate:function(c,b,a){return this.doUpdateSelf(c,b,a)},doUpdateSelf:function(c,h,k){var a=false;if(this.canModifyGraphic(c)){var d=false;var j=this.getChemObj();for(var f=0,e=h.length;f<e;++f){var g=h[f];if(g.obj===j){d=true;break}}if(d){if(k===Kekule.Render.ObjectUpdateType.CLEAR){return this.doClear(c)}else{this.doClear(c);var b=this.getRenderCache(c);return this.draw(c,b.baseCoord,b.options)}}}return a},_extractObjsOfUpdateObjDetails:function(a){return Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(a)},_createUpdateObjDetailsFromObjs:function(a){return Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(a)},addNew:function(c,a){var b=this._createUpdateObjDetailsFromObjs(a);return this.update(c,b,Kekule.Render.ObjectUpdateType.ADD)},modify:function(a,b){return this.update(a,b,Kekule.Render.ObjectUpdateType.MODIFY)},remove:function(b,c){var a=this._createUpdateObjDetailsFromObjs(c);return this.update(b,a,Kekule.Render.ObjectUpdateType.REMOVE)},clear:function(b){var a=this.doClear(b);this.invokeEvent("clear",{context:b,obj:this.getChemObj()})},doClear:function(a){if(this.canModifyGraphic()){return this.doClearSelf(a)}else{return false}},doClearSelf:function(a){if(this.canModifyGraphic()){var b=this.getRenderCache(a).drawnElem;if(b){try{this.getDrawBridge().removeDrawnElem(a,b)}catch(c){}}this.getRenderCache(a).drawnElem=null}else{return false}},estimateObjBox:function(c,b,a){var d=this.doEstimateObjBox(c,b,a);if(d){d=this._fillBoxDefaultValue(d,this.getRendererType())}return d},doEstimateObjBox:function(c,b,a){return this.doEstimateSelfObjBox(c,b,a)},doEstimateSelfObjBox:function(c,b,a){return null},estimateRenderBox:function(c,e,b,a){var d=this.doEstimateRenderBox(c,e,b,a);if(d){d=this._fillBoxDefaultValue(d,this.getRendererType())}return d},doEstimateRenderBox:function(c,d,b,a){return null},_fillBoxDefaultValue:function(d,a){if(!d){d={}}var c=a===Kekule.Render.RendererType.R3D;var b={x1:d.x1||0,x2:d.x2||0,y1:d.y1||0,y2:d.y2||0};if(c){b.z1=d.z1||0;b.z2=d.z2||0}return b},transformCoordToObj:function(a,c,b){return this.doTransformCoordToObj(a,c,b)},doTransformCoordToObj:function(a,c,b){return b},transformCoordToContext:function(a,c,b){return this.doTransformCoordToContext(a,c,b)},doTransformCoordToContext:function(a,c,b){return b},transformContextCoordToScreen:function(a,b){return this.doTransformContextCoordToScreen(a,b)},doTransformContextCoordToScreen:function(c,d){var a=this.getDrawBridge();return(a&&a.transformContextCoordToScreen)?a.transformContextCoordToScreen(c,d):d},basicDrawObjectUpdated:function(c,e,d,b,a){this.invokeEvent("updateBasicDrawObject",{context:c,obj:e,parentObj:d,boundInfo:b,updateType:a})},isChemObjRenderedBySelf:function(a,b){return(b===this.getRenderCache(a).chemObj)},isChemObjRenderedDirectlyBySelf:function(a,b){if(b&&this.getRenderCache(a).chemObj){return(b===this.getRenderCache(a).chemObj)}else{return false}},createBoundInfo:function(a,c,b){return Kekule.Render.MetaShapeUtils.createShapeInfo(a,c,b)},createPointBoundInfo:function(a){return this.createBoundInfo(Kekule.Render.BoundShapeType.POINT,[a])},createCircleBoundInfo:function(b,a){return this.createBoundInfo(Kekule.Render.BoundShapeType.CIRCLE,[b],{radius:a})},createArcBoundInfo:function(f,a,c,b,e,d){return this.createBoundInfo(Kekule.Render.BoundShapeType.ARC,[f],{radius:a,startAngle:c,endAngle:b,anticlockwise:e,width:d})},createLineBoundInfo:function(c,b,a){return this.createBoundInfo(Kekule.Render.BoundShapeType.LINE,[c,b],{width:a})},createRectBoundInfo:function(b,a){return this.createBoundInfo(Kekule.Render.BoundShapeType.RECT,[b,a])},createSphereBoundInfo:function(b,a){return this.createBoundInfo(Kekule.Render.BoundShapeType.SPHERE,[b],{radius:a})},createCylinderBoundInfo:function(c,b,a){return this.createBoundInfo(Kekule.Render.BoundShapeType.CYLINDER,[c,b],{radius:a})}});Kekule.ClassDefineUtils.addExtraObjMapSupport(Kekule.Render.AbstractRenderer);Kekule.Render.DummyRenderer=Class.create(Kekule.Render.AbstractRenderer,{CLASS_NAME:"Kekule.Render.DummyRenderer",draw:function(b,c,a){return},redraw:function(a){return}});Kekule.Render.CompositeRenderer=Class.create(Kekule.Render.AbstractRenderer,{CLASS_NAME:"Kekule.Render.CompositeRenderer",initProperties:function(){this.defineProp("targetChildObjs",{dataType:DataType.ARRAY,serializable:false});this.defineProp("childRendererMap",{dataType:DataType.OBJECT,serializable:false,getter:function(){var a=this.getPropStoreFieldValue("childRendererMap");if(!a){a=new Kekule.MapEx(true);this.setPropStoreFieldValue("childRendererMap",a)}return a}})},finalize:function($super){this.reset();$super()},doEstimateObjBox:function($super,c,k,e){var m=$super(c,k,e);var d=this.prepareChildRenderers();var g=Kekule.BoxUtils;for(var h=0,f=d.length;h<f;++h){var a=d[h];if(a){var j=a.estimateObjBox(c,k,e);if(j){if(!m){m=g.clone(j)}else{m=g.getContainerBox(m,j)}}}}return m},isChemObjRenderedBySelf:function($super,b,d){var h=$super(b,d);if(!h){var g=this.getChildRenderers();for(var e=0,c=g.length;e<c;++e){var a=g[e];if(a.isChemObjRenderedBySelf(b,d)){return true}}}if(!h){this.refreshChildObjs();var f=this.getTargetChildObjs();h=(f&&f.indexOf(d)>=0)}return h},isChemObjRenderedDirectlyBySelf:function($super,a,b){return $super(a,b)},doSetRedirectContext:function($super,d){$super(d);var b=this.getChildRenderers();if(b&&b.length){for(var c=0,a=b.length;c<a;++c){b[c].setRedirectContext(d)}}},getChildObjs:function(){var a=this.getChemObj();if(a&&a.getAttachedMarkers){return[].concat(a.getAttachedMarkers()||[])}else{return[]}},prepareChildObjs:function(){var a=this.getTargetChildObjs();if(a){return a}this.setTargetChildObjs(this.getChildObjs());return this.getTargetChildObjs()},refreshChildObjs:function(){this.setTargetChildObjs(null);this.prepareChildObjs()},getChildRenderers:function(){return this.getChildRendererMap().getValues()},getRendererForChild:function(g,f){var b=(this.getRendererType()===Kekule.Render.RendererType.R3D)?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass;var e=this.getChildRendererMap();var a=e.get(g);if(!a&&f){var d=b(g)||Kekule.Render.DummyRenderer;var a=d?new d(g,this.getDrawBridge(),this):null;e.set(g,a);a.setRedirectContext(this.getRedirectContext())}return a},prepareChildRenderers:function(){var g=this.getChildRendererMap();var d=this.prepareChildObjs()||[];var c=g.getKeys();for(var b=0,a=c.length;b<a;++b){var e=c[b];if(d.indexOf(e)<0){g.remove(e)}}for(var b=0,a=d.length;b<a;++b){var f=d[b];this.getRendererForChild(f,true)}return g.getValues()},releaseChildRenderers:function(){var d=this.getChildRendererMap();var b=d.getValues();if(!b){return}for(var c=0,a=b.length;c<a;++c){b[c].finalize()}d.clear()},hasChildRenderers:function(){var b=this.getChildRendererMap().getValues();var a=b&&b.length;return a},prepare:function(){this.prepareChildObjs();this.prepareChildRenderers()},reset:function(){this.setTargetChildObjs(null);this.releaseChildRenderers()},_needWholelyDraw:function(b,a){var c=this.getChemObj();return !b||b.indexOf(c)>=0},doDraw:function($super,c,d,b){this.refreshChildObjs();this.prepareChildRenderers();var f=Object.create(b);if(b.partialDrawObjs&&this._needWholelyDraw(b.partialDrawObjs,c)){f.partialDrawObjs=null}if(!this.getTargetChildObjs().length){return $super(c,d,f)}else{var a=this.doDrawSelf(c,d,f);var e=this.doDrawChildren(c,d,f);if(a){this.addToDrawGroup(a,e)}return e}},doDrawChildren:function(b,g,k){var j=this.createDrawGroup(b);var h=this.getChildRenderers();var c=Object.create(k);this.getRenderCache(b).childDrawOptions=c;for(var f=0,e=h.length;f<e;++f){var a=h[f];var g=null;var d=a.draw(b,g,c);if(j&&d){this.addToDrawGroup(d,j)}}return j},doClear:function($super,a){$super(a);if(this.hasChildRenderers()){this.doClearChildren(a)}return true},doClearChildren:function(d){var b=this.getChildRendererMap().getValues();for(var c=0,a=b.length;c<a;++c){if(b[c]){b[c].clear(d)}}},doUpdate:function($super,c,b,a){this.refreshChildObjs();$super(c,b,a);if(this.getTargetChildObjs().length){this.doUpdateChildren(c,b,a)}return true},doUpdateChildren:function(b,A,g){var B=Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(A);var d=this.getTargetChildObjs()||[];var a=this.getChildRendererMap();var f=Kekule.ArrayUtils.toArray(B);var n=new Kekule.MapEx(false);var C=[];var D=false;for(var w=0,t=f.length;w<t;++w){var m=f[w];if(this.isChemObjRenderedDirectlyBySelf(b,m)){D=true}}if(D){this.doClear(b);this.redraw(b);return true}for(var w=0,t=f.length;w<t;++w){var m=f[w];var s=a.get(m);if(s){if(g===Kekule.Render.ObjectUpdateType.REMOVE){s.clear();a.remove(m)}else{Kekule.ArrayUtils.pushUnique(C,s);z=[m];n.set(s,z)}}else{var e=this._getRenderersForChildObj(b,m);if(!e.length){if(d.indexOf(m)>=0){var p=this.getRendererForChild(m,true);var c=p.draw(b,null,this.getRenderCache(b).childDrawOptions);if(c){var y=this.getCachedDrawnElem(b);if(y){this.addToDrawGroup(c,y)}}}}for(var v=0,u=e.length;v<u;++v){var s=e[v];var z=n.get(s);if(!z){C.push(s);z=[];n.set(s,z)}z.push(m)}}}var h=true;for(var w=0,t=C.length;w<t;++w){var s=C[w];var q=n.get(s);var x=Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(q);var p=s.update(b,x,g);h=h&&p}return h},_getRenderersForChildObj:function(e,g){var a=[];var c=this.getChildRenderers();for(var d=0,b=c.length;d<b;++d){var f=c[d];if(f.isChemObjRenderedBySelf(e,g)){a.push(f)}}return a}});Kekule.Render.Renderer2DFactory=Kekule.FactoryUtils.createSimpleFactory(Kekule.FactoryUtils.MATCH_BY_CLASS);Kekule.Render.get2DRendererClass=function(b){var a=(b instanceof ObjectEx)?b.getClass():b;return Kekule.Render.Renderer2DFactory.getClass(a)};Kekule.Render.Renderer3DFactory=Kekule.FactoryUtils.createSimpleFactory(Kekule.FactoryUtils.MATCH_BY_CLASS);Kekule.Render.get3DRendererClass=function(b){var a=(b instanceof ObjectEx)?b.getClass():b;return Kekule.Render.Renderer3DFactory.getClass(a)};Kekule.Render.DrawBridgeManager=Class.create({CLASS_NAME:"Kekule.Render.DrawBridgeManager",initialize:function(){this._items=[];this._preferredItem=null},_indexOfBridgeClass:function(d){for(var b=0,a=this._items.length;b<a;++b){var c=this._items[b];if(c.bridgeClass===d){return b}}return -1},_sortItems:function(){this._items.sort(function(b,a){return(b.priorityLevel||0)-(a.priorityLevel||0)})},_reselectPreferred:function(){this._sortItems();for(var a=this._items.length-1;a>=0;--a){var b=this._items[a];if(b.isSupported){this._preferredItem=b;return b}}this._preferredItem=null;return null},register:function(d,a){if(!a){a=0}var b=this._indexOfBridgeClass(d);var c;if(b>=0){c=this._items[b];c.priorityLevel=a}else{c={bridgeClass:d,priorityLevel:a};c.isSupported=d.isSupported?d.isSupported():false;this._items.push(c)}this._sortItems();if((!this._preferredItem)||(this._preferredItem.priorityLevel<a)){if(c.isSupported){this._preferredItem=c}}return c},unregister:function(c){var b=null;var a=this._indexOfBridgeClass(c);if(a>=0){b=this._items[a];this._items.splice(a,1);if(b===this._preferredItem){this._reselectPreferred()}}return b},getPreferredBridgeClass:function(){return(this._preferredItem)?this._preferredItem.bridgeClass:null},getPreferredBridgeInstance:function(){var a=this.getPreferredBridgeClass();if(a){return new a()}else{return null}}});Kekule.Render.DrawBridge2DMananger=new Kekule.Render.DrawBridgeManager();Kekule.Render.DrawBridge3DMananger=new Kekule.Render.DrawBridgeManager();(function(){var d=Kekule.Render;d.atomColorSets={jmol:["#000099","#FFFFFF","#D9FFFF","#CC80FF","#C2FF00","#FFB5B5","#909090","#3050F8","#FF0D0D","#90E050","#B3E3F5","#AB5CF2","#8AFF00","#BFA6A6","#F0C8A0","#FF8000","#FFFF30","#1FF01F","#80D1E3","#8F40D4","#3DFF00","#E6E6E6","#BFC2C7","#A6A6AB","#8A99C7","#9C7AC7","#E06633","#F090A0","#50D050","#C88033","#7D80B0","#C28F8F","#668F8F","#BD80E3","#FFA100","#A62929","#5CB8D1","#702EB0","#00FF00","#94FFFF","#94E0E0","#73C2C9","#54B5B5","#3B9E9E","#248F8F","#0A7D8C","#006985","#C0C0C0","#FFD98F","#A67573","#668080","#9E63B5","#D47A00","#940094","#429EB0","#57178F","#00C900","#70D4FF","#FFFFC7","#D9FFC7","#C7FFC7","#A3FFC7","#8FFFC7","#61FFC7","#45FFC7","#30FFC7","#1FFFC7","#00FF9C","#00E675","#00D452","#00BF38","#00AB24","#4DC2FF","#4DA6FF","#2194D6","#267DAB","#266696","#175487","#D0D0E0","#FFD123","#B8B8D0","#A6544D","#575961","#9E4FB5","#AB5C00","#754F45","#428296","#420066","#007D00","#70ABFA","#00BAFF","#00A1FF","#008FFF","#0080FF","#006BFF","#545CF2","#785CE3","#8A4FE3","#A136D4","#B31FD4","#B31FBA","#B30DA6","#BD0D87","#C70066","#CC0059","#D1004F","#D90045","#E00038","#E6002E","#EB0026","#000000","#000000"],cpk2D:["#000000","#000000","#FFC0CB","#B22222",null,"#00FF00","#000000","#8F8FFF","#F00000","#DAA520",null,"#0000FF","#228B22","#808090","#DAA520","#FFA500","#FFC832","#00FF00",null,"#0000FF","#808090","#808090","#808090","#808090","#808090","#808090","#FFA500","#A52A2A","#A52A2A","#A52A2A","#A52A2A"]};var b=d.atomColorSets.cpk2D;var c=d.atomColorSets.jmol;b[35]="#A52A2A";b[47]="#808090";b[53]="#A020F0";b[56]="#FFA500";b[79]="#DAA520";b.SubGroup=c.SubGroup="#0000CC";d.atom3DColors=Kekule.Render.atomColorSets.jmol;d.atom2DColors=Kekule.Render.atomColorSets.cpk2D;d.atomColors=[];d.atomColors[d.RendererType.R2D]=d.atom2DColors;d.atomColors[d.RendererType.R3D]=d.atom3DColors})();Kekule.Render.RichText={SECTION:"section",GROUP:"group",LINES:"lines",SUP:"superscript",SUB:"subscript",NORMAL:"normal"};Kekule.Render.RichTextUtils={STYLE_PROPS:["fontSize","fontFamily","fontWeight","fontStyle","color","opacity"],create:function(){return Kekule.Render.RichTextUtils.createGroup()},createGroup:function(d,b){var a={role:d||"group",items:[]};if(b){for(var c in b){if(b.hasOwnProperty(c)){a[c]=b[c]}}}return a},createSection:function(d,a){var c={text:d};if(a){for(var b in a){if(a.hasOwnProperty(b)){c[b]=a[b]}}}return c},strToRichText:function(h,f){if(!h){h=""}var g=Kekule.Render.RichTextUtils;var d=h.split("\n");if(d.length<=1){return Kekule.Render.RichTextUtils.appendText(g.create(),h,f)}else{var a=g.createGroup(Kekule.Render.RichText.LINES);for(var e=0,c=d.length;e<c;++e){var b=d[e]||"\u00a0";g.appendText(a,b,f)}return a}},insertText:function(e,b,f,c,a){var d=Kekule.Render.RichTextUtils.createSection(f,c);e.items.splice(b,0,d);if(a){e.anchorItem=d}return e},appendText:function(d,e,b,a){var c=Kekule.Render.RichTextUtils.createSection(e,b);d.items.push(c);if(a){d.anchorItem=c}return d},appendText2:function(d,e,b,a){var c=Kekule.Render.RichTextUtils.createSection(e,b);d.items.push(c);if(a){d.anchorItem=c}return c},insert:function(c,a,b){c.items.splice(a,0,b);return c},append:function(b,a){b.items.push(a);return b},appendItems:function(b,a){b.items=b.items.concat(Kekule.ArrayUtils.toArray(a));return b},getItemType:function(a){if(a.items){return a.role}else{return Kekule.Render.RichText.SECTION}},getItemRole:function(b){var a=Kekule.Render.RichText;return(Kekule.Render.RichTextUtils.getItemType(b)===a.GROUP)?a.GROUP:a.SECTION},getItemTextType:function(a){return a.textType||Kekule.Render.RichText.NORMAL},isSuperscript:function(a){return Kekule.Render.RichTextUtils.getItemTextType(a)==Kekule.Render.RichText.SUP},isSubscript:function(a){return Kekule.Render.RichTextUtils.getItemTextType(a)==Kekule.Render.RichText.SUB},isGroup:function(a){return Kekule.Render.RichTextUtils.getItemType(a)===Kekule.Render.RichText.GROUP},isSection:function(a){return Kekule.Render.RichTextUtils.getItemType(a)===Kekule.Render.RichText.SECTION},getFirstNormalTextSection:function(e){for(var b=0,a=e.items.length;b<a;++b){var c=e.items[b];var d=Kekule.Render.RichTextUtils.getItemTextType(c);if(d===Kekule.Render.RichText.NORMAL){return c}}return null},getActualRefItem:function(d,c){var a=d.refItem;if((!a)&&(c.items.length>1)){var b=c.items.indexOf(d);if(b>0){a=c.items[b-1]}else{if(b==0){a=c.items[1]}else{a=null}}}return a},getFinalAnchorItem:function(a){if(a.anchorItem){return Kekule.Render.RichTextUtils.getFinalAnchorItem(a.anchorItem)}else{return a}},tidy:function(b){var k=Kekule.Render.RichTextUtils.createGroup(b.role);var a=-1;for(var e=0,d=b.items.length;e<d;++e){var j=b.items[e];if(j.items){var c=Kekule.Render.RichTextUtils.tidy(j);if(c.items.length==1){var f=Object.extend({},c);delete f.items;delete f.role;f=Object.extend(f,c.items[0]);j=f}else{if(c.items.length>0){++a;k.items.push(c);continue}}}var h=false;if(a>=0){var g=k.items[a];if(!g.items){if(Kekule.ObjUtils.equal(j,g,["text"])){g.text+=j.text;h=true}}}if(!h){++a;k.items.push(Object.extend({},j))}}return k},clone:function(g){var b={};Object.extend(b,g);if(g.items){b.items=[];for(var e=0,c=g.items.length;e<c;++e){var f={};f=Kekule.Render.RichTextUtils.clone(g.items[e]);b.items.push(f)}}if(b.items){if(g.anchorItem){var d=g.items.indexOf(g.anchorItem);if(d>=0){b.anchorItem=b.items[d]}else{b.anchorItem=null}}for(var e=0,c=b.items.length;e<c;++e){var a=g.items[e];var f=b.items[e];if(a.refItem){var d=g.items.indexOf(a.refItem);if(d>=0){f.refItem=b.items[d]}else{f.refItem=null}}}}return b},toText:function(e){var a="";if(e.items){for(var c=0,b=e.items.length;c<b;++c){var d=e.items[c];if(d.items){a+=Kekule.Render.RichTextUtils.toText(d)}else{if(d.text){a+=d.text}}}}else{return e.text||""}return a},_toDebugHtml:function(e){if(!e.items){return e.text}var a="";for(var c=0,b=e.items.length;c<b;++c){var d=e.items[c];if(d.items){a+=Kekule.Render.RichTextUtils._toDebugHtml(d)}else{if(d.text){switch(d.textType){case Kekule.Render.RichText.SUB:a+="<sub>"+d.text+"</sub>";break;case Kekule.Render.RichText.SUP:a+="<sup>"+d.text+"</sup>";break;default:a+=d.text}}}}return a},toSimpleHtmlCode:function(a){return Kekule.Render.RichTextUtils._toDebugHtml(a)},toHtml:function(v,h,d){var c=Kekule.Render.RichText;var n;var b;if(h.charDirection){b=h.charDirection===Kekule.Render.TextDirection.RTL||h.charDirection===Kekule.Render.TextDirection.BTT}else{b=d}var w=h.role;if(w===c.SECTION||h.text){var g=h.textType;var e=(g===c.SUB)?"sub":(g===c.SUP)?"sup":"span";n=v.createElement(e);var o=h.text;if(b){o=o.reverse()}Kekule.DomUtils.setElementText(n,h.text||"")}else{var p=null;var k;if(w===c.LINES){n=v.createElement("div");p="p";k="margin:0.2em 0;padding:0"}else{n=v.createElement("span")}var j;for(var r=0,q=h.items.length;r<q;++r){var t=h.items[r];var m=Kekule.Render.RichTextUtils.toHtml(v,t,b);if(p){var s=v.createElement(p);if(k){s.style.cssText=k}s.appendChild(m);m=s}if(!b||!j){n.appendChild(m)}else{n.insertBefore(m,j)}j=m}}var u=n.style;var a=Kekule.Render.RichTextUtils.STYLE_PROPS;for(var r=0,q=a.length;r<q;++r){var f=a[r];if(h[f]){u[f]=h[f]}}return n},fromHtml:function(f){var a=Kekule.Render.RichText;var e=Kekule.Render.RichTextUtils;var d=Kekule.DomUtils;var b=Kekule.StyleUtils;function c(w,z){if(w.nodeType===Node.TEXT_NODE){var r=w.nodeValue;r=r.replace(/[\r\n]/g,"");return r.trim()?e.createSection(r):null}else{if(w.nodeType===Node.ELEMENT_NODE){var n=e.STYLE_PROPS;n.push("direction");var o={};for(var A=0,x=n.length;A<x;++A){var y=n[A];var v;if(z){v=b.getComputedStyle(w,y)}else{v=w.style[y]}if(v){o[y]=v}}if(!o.direction){o.charDirection=Kekule.Render.TextDirection.DEFAULT}else{o.charDirection=(o.direction==="ltr")?Kekule.Render.TextDirection.LTR:(o.direction==="rtl")?Kekule.Render.TextDirection.RTL:(o.direction==="inherit")?Kekule.Render.TextDirection.INHERIT:null;delete o.direction}if(!d.getFirstChildElem(w)){var r=d.getElementText(w);var h=w.tagName.toLowerCase();if(h==="sub"){o.textType=a.SUB}else{if(h==="sup"){o.textType=a.SUP}else{o.textType=a.NORMAL}}return r?e.createSection(r,o):null}else{var k=a.GROUP;var g=d.getChildNodesOfTypes(w,[Node.ELEMENT_NODE,Node.TEXT_NODE]);var u=[];var t=false;for(var A=0,x=g.length;A<x;++A){var m=g[A];var j=c(m,false);if(m.nodeType===Node.ELEMENT_NODE){if(m.tagName.toLowerCase()==="br"){u.push("br");t=true}var C=b.isBlockElem(m);if(C){t=true;j._isLine=true}}if(j){u.push(j)}}if(t){var B=[];var s=[];for(var A=0,x=u.length;A<x;++A){var j=u[A];if(j._isLine||j=="br"){if(s.length){if(s.length>1){var p=e.createGroup();e.appendItems(p,s);B.push(p)}else{B.push(s[0])}s=[]}if(j._isLine){delete j._isLine;B.push(j)}}else{s.push(j)}}if(s.length){if(s.length>1){var p=e.createGroup();e.appendItems(p,s);B.push(p)}else{B.push(s[0])}}u=B}if(t){k=a.LINES}var q=e.createGroup(k,o);for(var A=0,x=u.length;A<x;++A){e.append(q,u[A])}return q}}}}return c(f,true)}};Kekule.Render.ChemDisplayTextUtils={RADICAL_LABELS:["","\u2022\u2022","\u2022","\u2022\u2022"],RADICAL_TRIPLET_ALTER_LABEL:"^^",getRadicalDisplayText:function(a,b){if(b&&a===Kekule.RadicalOrder.TRIPLET){return Kekule.Render.ChemDisplayTextUtils.RADICAL_TRIPLET_ALTER_LABEL}else{return Kekule.Render.ChemDisplayTextUtils.RADICAL_LABELS[a]}},getChargeDisplayText:function(f,d,c){var a="";var b=(!!f)&&(!d||(Math.abs(f)>Math.pow(10,-d)/2));if(b){var g=(f>0)?"+":"-";var e=Math.abs(f);if(e!=1){a+=d?Kekule.NumUtils.toDecimals(e,d):e.toString()}else{if(c===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND){g=(f>0)?"\u2295":"\u2296"}}a+=g}return a},createElectronStateDisplayTextSection:function(g,e,d,c,f){var b=null;var a="";if(g){a=Kekule.Render.ChemDisplayTextUtils.getChargeDisplayText(g,d,c)}if(e){a+=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(e,f)||""}if(a){b=Kekule.Render.RichTextUtils.createSection(a,{textType:Kekule.Render.RichText.SUP,charDirection:Kekule.Render.TextDirection.LTR})}return b},formulaToRichText:function(h,e,g,d,f,c,b){var a=Kekule.Render.ChemDisplayTextUtils._convFormulaToRichTextGroup(h,false,e,g,d,f,c,b);return a},_convFormulaToRichTextGroup:function(b,t,e,p,u,s,a,v){var f=Kekule.Render.RichTextUtils.createGroup();var h=b.getSections();if(t){var o=b.getMaxNestedLevel()%Kekule.FormulaUtils.FORMULA_BRACKET_TYPE_COUNT;var j=Kekule.FormulaUtils.FORMULA_BRACKETS[o][0];var d=Kekule.FormulaUtils.FORMULA_BRACKETS[o][1];f=Kekule.Render.RichTextUtils.appendText(f,j)}for(var q=0,n=h.length;q<n;++q){var g=h[q].obj;var k=b.getSectionCharge(h[q]);var m=null;if(g instanceof Kekule.MolecularFormula){m=Kekule.Render.ChemDisplayTextUtils._convFormulaToRichTextGroup(g,true,false,false,u,s,a)}else{if(g.getDisplayRichText){var m=g.getDisplayRichText(Kekule.Render.HydrogenDisplayLevel.NONE,false,null,s,u,a)}}if(m){if(h[q].count!=1){m=Kekule.Render.RichTextUtils.appendText(m,h[q].count.toString(),{textType:Kekule.Render.RichText.SUB});m.charDirection=Kekule.Render.TextDirection.LTR}if(e&&k){var c=Kekule.Render.ChemDisplayTextUtils.createElectronStateDisplayTextSection(k,null,u,a,v);if(c){Kekule.Render.RichTextUtils.append(m,c)}}f=Kekule.Render.RichTextUtils.append(f,m)}}if(t){f=Kekule.Render.RichTextUtils.appendText(f,d)}if(e||p){var k=b.getCharge();var r=b.getRadical();var c=Kekule.Render.ChemDisplayTextUtils.createElectronStateDisplayTextSection(k,r,u,a);if(c){Kekule.Render.RichTextUtils.append(f,c)}}return f}};Kekule.Render.TextDrawUtils={isHorizontalLine:function(a){return((a==Kekule.Render.TextDirection.LTR)||(a==Kekule.Render.TextDirection.RTL)||(a==null))},isVerticalLine:function(a){return((a==Kekule.Render.TextDirection.TTB)||(a==Kekule.Render.TextDirection.BTT))},getOppositeDirection:function(b){var a=Kekule.Render.TextDirection;switch(b){case a.LTR:return a.RTL;case a.RTL:return a.LTR;case a.TTB:return a.BTT;case a.BTT:return a.TTB}},isOppositeDirection:function(b,a){return Kekule.Render.TextDrawUtils.getOppositeDirection(b)===a},getActualDirection:function(b,a){if(b===TD.LINE_BREAK){return((a===TD.TTB)||(a===TD.BTT))?TD.LTR:((a===TD.LTR)||(a===TD.RTL))?TD.TTB:b}else{return b}},getActualAlign:function(d,c){var a=Kekule.Render.TextAlgin;var b=Kekule.Render.TextDirection;switch(d){case a.LEFT:case a.RIGHT:case a.TOP:case a.BOTTOM:case a.CENTER:return d;break;case a.LEADING:switch(c){case b.TTB:return a.TOP;case b.BTT:return a.BOTTOM;case b.RTL:return a.RIGHT;case b.LTR:default:return a.LEFT}case a.TRAILING:switch(c){case b.BTT:return a.TOP;case b.TTB:return a.BOTTOM;case b.RTL:return a.LEFT;case b.LTR:default:return a.RIGHT}}}};Kekule.Render.DrawPathUtils={makePath:function(){var b=[];var d=null;var g=[];var f;for(var e=0,c=arguments.length;e<c;++e){var a=arguments[e];if(DataType.isArrayValue(a)){g=g.concat(a)}else{if(typeof(a)==="number"){g.push(a)}else{if(d){f={method:d,params:g};b.push(f);d=null;g=[]}d=a.toString()}}if(e===c-1){if(d){f={method:d,params:g};b.push(f)}}}return b}};Kekule.Render.ConnectorDrawUtils={getPossibleConnectorRenderTypes:function(a){if(a instanceof Kekule.Bond){return Kekule.Render.ConnectorDrawUtils.getPossibleBondRenderTypes(a)}else{var b=Kekule.Render.BondRenderType;return[b.SINGLE,b.DASHED,b.WAVY]}},getDefConnectorRenderType:function(c){var b=Kekule.Render.ConnectorDrawUtils.getPossibleConnectorRenderTypes(c);return b[0]},getPossibleBondRenderTypes:function(g){var b=Kekule.Render.BondRenderType;var c=Kekule.BondType;var h=g.getBondType();switch(h){case c.HYDROGEN:return[b.DASHED,b.ARROWED,b.WAVY];break;case c.COORDINATE:return[b.ARROWED,b.SINGLE,b.DASHED,b.WAVY];break;case c.IONIC:case c.METALLIC:case c.UNKNOWN:return[b.SINGLE,b.DASHED,b.WAVY];break;case c.COVALENT:break;default:return[b.SINGLE,b.DASHED,b.ARROWED,b.WAVY]}if(g.getConnectedObjCount()>2){return[b.DASHED,b.SINGLE]}var f=Kekule.BondOrder;switch(g.getBondOrder()){case f.DOUBLE:var e=[b.DOUBLE,b.DASHED_DOUBLE,b.BOLD_DOUBLE,b.WAVY];if(g.getStereo&&[Kekule.BondStereo.E_OR_Z,Kekule.BondStereo.CIS_OR_TRANS].indexOf(g.getStereo())>=0){e.unshift(b.SCISSORS_DOUBLE)}return e;break;case f.TRIPLE:return[b.TRIPLE,b.BOLD_TRIPLE,b.WAVY];break;case f.QUAD:return[b.QUAD,b.BOLD_QUAD,b.WAVY];break;case f.EXPLICIT_AROMATIC:return[b.SOLID_DASH,b.WAVY];break;case f.SINGLE:var d=Kekule.BondStereo;var a=[b.SINGLE,b.BOLD,b.WAVY];switch(g.getStereo()){case d.UP:a.unshift(b.WEDGED_SOLID,b.WEDGED_HOLLOW);break;case d.UP_INVERTED:a.unshift(b.WEDGED_SOLID_INV,b.WEDGED_HOLLOW_INV);break;case d.DOWN:a.unshift(b.WEDGED_HASHED,b.DASHED);break;case d.DOWN_INVERTED:a.unshift(b.WEDGED_HASHED_INV,b.DASHED);break;case d.UP_OR_DOWN:case d.UP_OR_DOWN_INVERTED:a=[b.WAVY,b.SINGLE];break;case d.CLOSER:a=[b.WEDGED_SOLID_BOTH,b.WEDGED_HOLLOW_BOTH];break;default:}return a;break;default:return[b.SINGLE,b.DASHED,b.ARROWED,b.WAVY]}},getDefBondRenderType:function(c){var b=Kekule.Render.ConnectorDrawUtils.getPossibleBondRenderTypes(c);return b[0]},getConnectorRender3DType:function(a,d){var b=Kekule.Render.Bond3DRenderType;var c=Kekule.Render.Bond3DRenderMode;if(d&&((d===c.WIRE)||(d===c.CYLINDER))){return b.SINGLE}else{if(a instanceof Kekule.Bond){return Kekule.Render.ConnectorDrawUtils.getBondRender3DTypes(a)}else{return b.SINGLE}}},getBondRender3DTypes:function(d){var a=Kekule.Render.Bond3DRenderType;var b=Kekule.BondType;var e=d.getBondType();switch(e){case b.HYDROGEN:return a.DASH;break;case b.COVALENT:break;default:return a.SINGLE}var c=Kekule.BondOrder;switch(d.getBondOrder()){case c.DOUBLE:return a.DOUBLE;break;case c.TRIPLE:return a.TRIPLE;break;case c.EXPLICIT_AROMATIC:return a.SOLID_DASH;break;default:return a.SINGLE}}};Kekule.Render.ObjUtils={getContainerBox:function(f,c,a){if(!c){c=Kekule.CoordMode.COORD2D}var b;var d=f;if(d.getExposedContainerBox){b=d.getExposedContainerBox(c,a)}else{if(d.getContainerBox){b=d.getContainerBox(c,a)}else{var e=d.getAbsCoordOfMode?d.getAbsCoordOfMode(c):null;b=e?Kekule.BoxUtils.createBox(e,e):null}}return b}};Kekule.Render.MetaShapeUtils={createShapeInfo:function(c,d,b){var a={shapeType:c,coords:d};if(b){a=Object.extend(a,b)}return a},isCompositeShape:function(a){return DataType.isArrayValue(a)},inflateShape:function(f,h){if(!f){return null}var c=Kekule.Render.MetaShapeType;var a=Kekule.Render.MetaShapeUtils;if(a.isCompositeShape(f)){var k=[];for(var e=0,b=f.length;e<b;++e){var j=f[e];var d=a.inflateShape(j,h);k.push(d)}return k}var g;switch(f.shapeType){case c.POINT:g=a._inflatePointShape(f,h);break;case c.CIRCLE:g=a._inflateCircleShape(f,h);break;case c.LINE:g=a._inflateLineShape(f,h);break;case c.RECT:g=a._inflateRectShape(f,h);break;case c.POLYGON:g=a._inflatePolygonShape(f,h);break;case c.ARC:g=a._inflateArcShape(f,h);break}return g},_inflatePointShape:function(b,c){var a=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.CIRCLE,[b.coords[0]],{radius:c});return a},_inflateCircleShape:function(b,c){var a=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.CIRCLE,[b.coords[0]],{radius:b.radius+c});return a},_inflateLineShape:function(b,c){var a=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.LINE,[b.coords[0],b.coords[1]],{width:(b.width||0)+c*2});return a},_inflateArcShape:function(b,c){var a=Object.extend({},b);a.width=(b.width||0)+c*2;return a},_inflateRectShape:function(b,d){var a=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.RECT,[]);var c=Kekule.Render.MetaShapeUtils._inflateCoords(b.coords,d);a.coords=c;return a},_inflatePolygonShape:function(b,d){var a=Kekule.Render.MetaShapeUtils.createShapeInfo(Kekule.Render.BoundShapeType.POLYGON,[]);var c=Kekule.Render.MetaShapeUtils._inflateCoords(b.coords,d);a.coords=c;return a},_inflateCoords:function(h,m){var c=Kekule.CoordUtils;var n=[];var a=c.getCenter(h);for(var f=0,e=h.length;f<e;++f){var g=h[f];var d=c.substract(g,a);var b=c.getDistance(g);var k=c.multiply(d,m/b);var j=c.add(g,k);n.push(j)}return n},getDistance:function(g,k,m){if(Kekule.Render.MetaShapeUtils.isCompositeShape(k)){var n=null;for(var f=0,c=k.length;f<c;++f){var b=k[f];var j=Kekule.Render.MetaShapeUtils.getDistance(g,b,m);if(n===null||n>j){n=j}}return n}else{var e=Kekule.Render.MetaShapeType;var a=Kekule.Render.MetaShapeUtils;var h=m?a.inflateShape(k,m):k;switch(k.shapeType){case e.POINT:return(m?a._getDistanceToCircle(g,h):a._getDistanceToPoint(g,h));case e.CIRCLE:return a._getDistanceToCircle(g,h);case e.LINE:return a._getDistanceToLine(g,h);case e.RECT:return a._getDistanceToRect(g,h);case e.POLYGON:return a._getDistanceToPolygon(g,h);case e.ARC:return a._getDistanceToArc(g,h);default:return false}}},_getDistanceToPoint:function(b,a){return Kekule.CoordUtils.getDistance(b,a.coords[0])},_getDistanceToCircle:function(e,c){var b=Kekule.CoordUtils;var a=b.getDistance(e,c.coords[0]);return a-c.radius},_getDistanceToArc:function(k,t){var b=Kekule.CoordUtils;var p=b.substract(k,t.coords[0]);var q=Math.atan2(p.y,p.x);if(Kekule.Render.MetaShapeUtils.isAngleInArcRange(q,t.startAngle,t.endAngle,t.anticlockwise)){var o=b.getDistance(k,t.coords[0]);var o=Math.abs(o-t.radius);if(t.width&&t.width>1){o=o-t.width/2}return Math.max(0,o)}else{var g=t.coords[0];var f;if(t.width&&t.width>1){f=[t.radius-t.width/2,t.radius+t.width/2]}else{f=[t.radius]}var n=[];var m=t.startAngle;var c=t.endAngle;for(var h=0,e=f.length;h<e;++h){var a=f[h];var s=CU.add(g,{x:a*Math.cos(m),y:a*Math.sin(m)});var j=CU.add(g,{x:a*Math.cos(c),y:a*Math.sin(c)});n.push(s);n.push(j)}var u=null;for(var h=0,e=n.length;h<e;++h){var o=b.getDistance(n[h],k);if(u===null||u>o){u=o}}return u}},_getDistanceToLine:function(i,n){var h=Kekule.Render.MetaShapeUtils;var l=n.coords;var g=Kekule.Render.MetaShapeUtils._calcVerticalLineCrossPoint(i,l[0],l[1]);var m;var d=Kekule.NumUtils;if(d.isFloatEqual(l[0].x,l[1].x)&&d.isFloatEqual(l[0].y,l[1].y)){var f={coords:[n.coords[0]],radius:n.width};var o=h._getDistanceToCircle(i,f);return o}else{var e=Kekule.CoordUtils.substract(l[1],l[0]);if(Math.abs(e.y)>Math.abs(e.x)){m=(Math.sign(g.y-l[0].y)*Math.sign(g.y-l[1].y)<=0)}else{m=(Math.sign(g.x-l[0].x)*Math.sign(g.x-l[1].x)<=0)}}if(!m){var k={coords:[n.coords[0]],radius:n.width||0};var j={coords:[n.coords[1]],radius:n.width||0};var c=h._getDistanceToCircle(i,k);var b=h._getDistanceToCircle(i,j);return Math.min(c,b)}else{var a=Kekule.CoordUtils.getDistance(i,g)-(n.width||0)/2;return a}},_getDistanceToRect:function(c,g){var e=g.coords;var h=(c.x-e[0].x);var f=(c.x-e[1].x);var d=(c.y-e[0].y);var b=(c.y-e[1].y);var a=(h*f<=0)&&(d*b<=0);if(a){return -Math.min(Math.abs(h),Math.abs(f),Math.abs(d),Math.abs(b))}else{var i=Kekule.CoordUtils;return Math.min(i.getDistance(c,e[0]),i.getDistance(c,e[1]),i.getDistance(c,{x:e[0].x,y:e[1].y}),i.getDistance(c,{x:e[1].x,y:e[0].y}))}},_getDistanceToPolygon:function(j,p){var b=Kekule.CoordUtils;var h=Kekule.Render.MetaShapeUtils;var f=Kekule.Render.MetaShapeType;var e=h._isInsidePolygon(j,p);var o=p.coords;var a=null;for(var g=0,c=o.length;g<c;++g){var n=o[g];var k=o[(g+1)%c];var q=h.createShapeInfo(f.LINE,[n,k],{width:0});var m=h._getDistanceToLine(j,q);if(a===null){a=m}else{if(a>m){a=m}}}if(e){a=-a}return a},_getDistanceOfTwoLines:function(h,g){var b=Kekule.Render.MetaShapeUtils;var a=Kekule.GeometryUtils;if(a.getCrossPointOfLines(h[0],h[1],g[0],g[1])){return 0}var f=a.getDistanceFromPointToLine(h[0],g[0],g[1]);var e=a.getDistanceFromPointToLine(h[1],g[0],g[1]);var d=a.getDistanceFromPointToLine(g[0],h[0],h[1]);var c=a.getDistanceFromPointToLine(g[1],h[0],h[1]);return Math.min(f,e,d,c)},isCoordInside:function(f,h,j){if(!f){return false}if(Kekule.Render.MetaShapeUtils.isCompositeShape(h)){for(var e=0,c=h.length;e<c;++e){var b=h[e];if(Kekule.Render.MetaShapeUtils.isCoordInside(f,b,j)){return true}}return false}else{var d=Kekule.Render.MetaShapeType;var a=Kekule.Render.MetaShapeUtils;var g=j?a.inflateShape(h,j):h;if(!g){return false}switch(h.shapeType){case d.POINT:return(j?a._isInsideCircle(f,g):a._isInsidePoint(f,g));case d.CIRCLE:return a._isInsideCircle(f,g);case d.LINE:return a._isInsideLine(f,g);case d.RECT:return a._isInsideRect(f,g);case d.POLYGON:return a._isInsidePolygon(f,g);case d.ARC:return a._isInsideArc(f,g);default:return false}}},_isInsidePoint:function(b,a){return Kekule.CoordUtils.isEqual(b,a.coords[0])},_isInsideCircle:function(e,c){var b=Kekule.CoordUtils;var a=b.getDistance(e,c.coords[0]);return(a<=c.radius)},_isInsideLine:function(f,i){var g=i.coords;var e=Kekule.Render.MetaShapeUtils._calcVerticalLineCrossPoint(f,g[0],g[1]);var h;var b=Kekule.NumUtils;if(b.isFloatEqual(g[0].x,g[1].x)&&b.isFloatEqual(g[0].y,g[1].y)){var d={coords:[i.coords[0]],radius:i.width};var j=Kekule.Render.MetaShapeUtils._isInsideCircle(f,d);return j}else{var c=Kekule.CoordUtils.substract(g[1],g[0]);if(Math.abs(c.y)>Math.abs(c.x)){h=(Math.sign(e.y-g[0].y)*Math.sign(e.y-g[1].y)<=0)}else{h=(Math.sign(e.x-g[0].x)*Math.sign(e.x-g[1].x)<=0)}}if(!h){return false}else{var a=Kekule.CoordUtils.getDistance(f,e);return(a<=i.width/2)}},_isInsideArc:function(i,h){var g=Kekule.CoordUtils;var e=Kekule.GeometryUtils;var f=g.getDistance(i,h.coords[0]);var a=(Math.abs(f-h.radius)<h.width/2);if(a){var c=g.substract(i,h.coords[0]);var b=e.standardizeAngle(Math.atan2(c.y,c.x),0);a=Kekule.Render.MetaShapeUtils.isAngleInArcRange(b,h.startAngle,h.endAngle,h.anticlockwise)}return a},_isInsideRect:function(c,b){var a=b.coords;return Kekule.CoordUtils.insideRect(c,a[0],a[1])},_isInsidePolygon:function(f,m){var a=Kekule.CoordUtils;var j=m.coords;var c=0;for(var e=0,d=j.length;e<d;++e){var h=j[e];var g=j[(e+1)%d];var k=a.substract(g,h);if(k.x===0){continue}else{var b={x:f.x};b.y=((b.x-h.x)/k.x)*k.y+h.y;if(a.insideRect(b,h,g)){++c}}}return(c%2===0)},_calcVerticalLineCrossPoint:function(e,c,b){var a={};if(Math.abs(c.x-b.x)<1e-10){a.x=c.x;a.y=e.y}else{var d=(b.y-c.y)/(b.x-c.x);a.x=(d*d*c.x+d*(e.y-c.y)+e.x)/(d*d+1);a.y=d*(a.x-c.x)+c.y}return a},getContainerBox:function(n,m){var d=Kekule.Render.MetaShapeType;var c=Kekule.Render.MetaShapeUtils;var a=Kekule.BoxUtils;if(!n){return null}var j=n.coords;m=m||0;var o;if(c.isCompositeShape(n)){o=null;for(var f=0,b=n.length;f<b;++f){var e=n[f];var k=c.getContainerBox(e);if(!o){o=k}else{o=a.getContainerBox(o,k)}}}else{switch(n.shapeType){case d.POINT:case d.CIRCLE:var h=(n.shapeType===d.POINT)?0:(n.radius||0);var g=j[0];o=a.createBox({x:g.x-h,y:g.y-h},{x:g.x+h,y:g.y+h});break;case d.LINE:o=a.createBox(j[0],j[1]);o=Kekule.BoxUtils.inflateBox(o,(n.width||0)/2);break;case d.ARC:o=Kekule.Render.MetaShapeUtils._getArcContainerBox(n);break;case d.RECT:o=a.createBox(j[0],j[1]);break;case d.POLYGON:o=a.createBox(j[0],j[0]);for(var f=1,b=j.length;f<b;++f){var g=j[f];o={x1:Math.min(o.x1,g.x),y1:Math.min(o.y1,g.y),x2:Math.max(o.x2,g.x),y2:Math.max(o.y2,g.y)}}break}}if(m){o=Kekule.BoxUtils.inflateBox(o,m)}return o},_getArcContainerBox:function(s){var e=Kekule.Render.MetaShapeUtils;var t=Kekule.CoordUtils;var p;if(s.width&&s.width>1){p=[s.radius+s.width/2,s.radius-s.width/2]}else{p=[s.radius]}var h=s.coords[0];var b=Math.PI/2;var d=function(j,i){return t.add(h,{x:i*Math.cos(j),y:i*Math.sin(j)})};var q=[];for(var n=0,c=p.length;n<c;++n){var o=p[n];var a=d(s.startAngle,o);var r=d(s.endAngle,o);q=q.concat([a,r]);var m=[0,b,b*2,b*3];for(var g=0,f=m.length;g<f;++g){if(e.isAngleInArcRange(m[g],s.startAngle,s.endAngle,s.anticlockwise)){q.push(d(m[g],o))}}}return t.getContainerBox(q)},isAngleInArcRange:function(a,g,c,d){var i=Kekule.GeometryUtils.standardizeAngle;var h=i(g);var e=i(c);var f=i(a);var b=Math.sign(f-h)*Math.sign(f-e)*Math.sign(e-h);return d?(b>=0):b<=0},isIntersectingLine:function(s,o,m){var e=Kekule.Render.MetaShapeType;var b=Kekule.Render.MetaShapeUtils;if(b.isCompositeShape(s)){for(var k=0,c=s.length;k<c;++k){var h=s[k];if(b.isIntersectingLine(h,o,m)){return true}}return false}else{var t=b.createShapeInfo(e.LINE,o);var g=m/2;var a=s.coords;switch(s.shapeType){case e.POINT:var n=b._getDistanceToLine(a[0],t);return n<=g;case e.CIRCLE:var n=b._getDistanceToLine(a[0],t);return n<=g+(t.radius||0);case e.LINE:var n=b._getDistanceOfTwoLines(a,o);return n<=g+(t.width||0);case e.RECT:case e.POLYGON:var p=b._getCoordsForShapeInComparingWithPolygon(s);var n=null;var f=p.length-1;for(var k=0,c=p.length;k<c;++k){var r=[p[k],p[f]];var q=b._getDistanceOfTwoLines(r,o);if(n===null||q<n){n=q}f=k}return n<=g}return false}},isInsideBox:function(c,b){var a=Kekule.Render.MetaShapeUtils.getContainerBox(c);return Kekule.BoxUtils.isInside(a,b)},isIntersectingBox:function(g,d){if(U.isCompositeShape(g)){for(var c=0,b=g.length;c<b;++c){var f=g[c];var a=Kekule.Render.MetaShapeUtils.isIntersectingBox(f,d);if(a){return true}}}else{var e=g.coords;for(var c=0,b=e.length;c<b;++c){var h=e[c];if(Kekule.CoordUtils.isInsideBox(h,d)){return true}}return false}},isPointInsidePolygon:function(c,b){var a=false;var f=b.length;var d=f-1;for(var e=0;e<f;++e){if(((b[e].y>c.y)!==(b[d].y>c.y))&&(c.x<(b[d].x-b[e].x)*(c.y-b[e].y)/(b[d].y-b[e].y)+b[e].x)){a=!a}d=e}return a},isInsidePolygon:function(g,d){var b=Kekule.Render.MetaShapeUtils;var f=b._getCoordsForShapeInComparingWithPolygon(g);if(!f){return false}for(var e=0,a=f.length;e<a;++e){var h=f[e];if(!b.isPointInsidePolygon(h,d)){return false}}return true},isIntersectingPolygon:function(g,d){var b=Kekule.Render.MetaShapeUtils;var f=b._getCoordsForShapeInComparingWithPolygon(g);if(!f){return false}for(var e=0,a=f.length;e<a;++e){var h=f[e];if(b.isPointInsidePolygon(h,d)){return true}}return false},isIntersectingPolyline:function(g,e,a){var d=Kekule.Render.MetaShapeUtils;for(var f=0,c=e.length-1;f<c;++f){var b=[e[f],e[f+1]];if(d.isIntersectingLine(g,b,a)){return true}}return false},_getCoordsForShapeInComparingWithPolygon:function(p){var f=Kekule.Render.MetaShapeType;var d=Kekule.Render.MetaShapeUtils;var q;if(d.isCompositeShape(p)){q=[];for(var j=0,e=p.length;j<e;++j){var h=p[j];var c=d._getCoordsForShapeInComparingWithPolygon(h);q=q.concat(c)}return q}else{var o=p.coords;switch(p.shapeType){case f.POINT:q=[o[0]];break;case f.CIRCLE:var m=p.radius||0;if(!m){q=[o[0]]}else{var b=m;var n=b/Math.sqrt(2);q=[{x:b,y:0},{x:n,y:n},{x:0,y:b},{x:-n,y:n},{x:-b,y:0},{x:-n,y:-n},{x:0,y:-b},{x:n,y:-n}]}break;case f.LINE:q=[o[0],o[1]];break;case f.RECT:var k=o[0],g=o[1];q=[k,{x:g.x,y:k.y},g,{x:k.x,y:g.y}];break;case f.POLYGON:q=o;break}return q}}};Kekule.Render.RenderOptionUtils={mergeObjLocalRenderOptions:function(c,a){var b=(c&&c.getOverriddenRenderOptions)?c.getOverriddenRenderOptions():null;return Kekule.Render.RenderOptionUtils.mergeRenderOptions(b||{},a)},mergeObjLocalRender3DOptions:function(c,a){var b=(c&&c.getOverriddenRender3DOptions)?c.getOverriddenRender3DOptions():null;return Kekule.Render.RenderOptionUtils.mergeRenderOptions(b||{},a)},mergeRenderOptions:function(c,b){var a=Object.create(b);a=Object.extend(a,c,true,true);return a},getColor:function(a){return a?a.color:null},getMoleculeDisplayType:function(a){return a?a.moleculeDisplayType:null},getNodeDisplayMode:function(a){return a?a.nodeDisplayMode:null},getHydrogenDisplayLevel:function(a){return a?a.hydrogenDisplayLevel:null},getShowCharge:function(a){return a?a.showCharge:null},getChargeDrawOptions:function(b){if(!b){return null}else{var c=["showCharge","chargeMarkType","chargeMarkFontSize","chargeMarkMargin","chargeMarkCircleWidth","color","opacity"];var a=Object.copyValues({},b,c);return a}},getNodeLabelDrawOptions:function(b){if(!b){return null}else{var c=["fontSize","fontFamily","supFontSizeRatio","subFontSizeRatio","superscriptOverhang","subscriptOversink","textBoxXAlignment","textBoxYAlignment","color","opacity"];var a=Object.copyValues({},b,c);return a}},getConnectorRenderType:function(a){return a?renderOption.renderType:null},getConnectorDrawParams:function(b){if(!b){return null}else{var c=["bondLineWidth","boldBondLineWidth","hashSpacing","multipleBondSpacingRatio","multipleBondSpacingAbs","multipleBondMaxAbsSpacing","bondArrowLength","bondArrowWidth","bondWedgeWidth","bondWedgeHashMinWidth","color","opacity"];var a=Object.copyValues({},b,c);return a}},convertConfigsToPlainHash:function(b){var a=Kekule.Render.RenderOptionUtils;if(b instanceof Kekule.Render.Render3DConfigs){return a.convert3DConfigsToPlainHash(b)}else{return a.convert2DConfigsToPlainHash(b)}},convert2DConfigsToPlainHash:function(b){var d=Kekule.ObjUtils;var a={};a._configs=b;var c=b.getGeneralConfigs().toHash();d.replacePropName(c,"drawOpacity","opacity");a=Object.extend(a,c);c=b.getMoleculeDisplayConfigs().toHash();d.replacePropName(c,"defMoleculeDisplayType","moleculeDisplayType");d.replacePropName(c,"defNodeDisplayMode","nodeDisplayMode");d.replacePropName(c,"defHydrogenDisplayLevel","hydrogenDisplayLevel");d.replacePropName(c,"defChargeMarkType","chargeMarkType");a=Object.extend(a,c);a.displayLabelConfigs=b.getDisplayLabelConfigs();c=b.getTextFontConfigs().toHash();a=Object.extend(a,c);c=b.getLengthConfigs().toHash();a=Object.extend(a,c);a.unitLength=a.unitLength||1;c=b.getColorConfigs().toHash();a=Object.extend(a,c);return a},convert3DConfigsToPlainHash:function(b){var d=Kekule.ObjUtils;var a={};a._configs=b;var c=b.getGeneralConfigs().toHash();d.replacePropName(c,"drawOpacity","opacity");a=Object.extend(a,c);var c=b.getEnvironmentConfigs().toHash();a=Object.extend(a,c);var c=b.getMoleculeDisplayConfigs().toHash();d.replacePropName(c,"defMoleculeDisplayType","moleculeDisplayType");d.replacePropName(c,"defBondSpliceMode","bondSpliceMode");d.replacePropName(c,"defDisplayMultipleBond","displayMultipleBond");d.replacePropName(c,"defBondColor","bondColor");d.replacePropName(c,"defAtomColor","atomColor");a=Object.extend(a,c);var c=b.getModelConfigs().toHash();a=Object.extend(a,c);var c=b.getLengthConfigs().toHash();a=Object.extend(a,c);return a},getCascadeRenderOptionValueOfObjs:function(k,g,c){var m;var h=false;var f=Kekule.ArrayUtils.toArray(k);var a=c?"getCascadedRender3DOption":"getCascadedRenderOption";for(var e=0,b=f.length;e<b;++e){var d=f[e];if(d[a]){var j=d[a](g);if(!h){m=j;h=true}else{if(m!=j){return null}}}}return m},setRenderOptionValueOfObjs:function(m,o,c){var g=Kekule.ArrayUtils.toArray(m);var h=c?"setRenderOption":"setRenderOption";for(var f=0,a=g.length;f<a;++f){var e=g[f];if(e[h]){var n=Kekule.ObjUtils.getOwnedFieldNames(o);for(var d=0,b=n.length;d<b;++d){e[h](n[d],o[n[d]])}}}}};Kekule.Render.Render3DOptionUtils={getConnectorRenderType:function(a){return a?a.renderType:null},convertConfigsToPlainHash:function(a){}};Kekule.Render.RenderColorUtils={getActiveAtomColorSet:function(a){return Kekule.Render.atomColors[a]},setActiveAtomColorSet:function(b,a){var c=Kekule.Render.AtomColorSets[b];if(c){Kekule.Render.atomColorSet[a]=c}return c},getColor:function(a,b){var c=Kekule.Render.RenderColorUtils.getActiveAtomColorSet(b);var d=c[a];if(!d){d=c[0]}return d}};Kekule.Render.UpdateObjUtils={_extractObjsOfUpdateObjDetails:function(e){var a=[];for(var c=0,b=e.length;c<b;++c){var d=e[c];if(d.obj){Kekule.ArrayUtils.pushUnique(a,d.obj)}}return a},_createUpdateObjDetailsFromObjs:function(b){var a=[];for(var d=0,c=b.length;d<c;++d){a.push({obj:b[d]})}return a}};Kekule.Render.RendererDefineUtils={CompositeObjRendererMethods:{finalize:function($super){this.reset();$super()},doEstimateObjBox:function(c,k,e){var m=null;var d=this.prepareChildRenderers();var g=Kekule.BoxUtils;for(var h=0,f=d.length;h<f;++h){var a=d[h];if(a){var j=a.estimateObjBox(c,k,e);if(j){if(!m){m=g.clone(j)}else{m=g.getContainerBox(m,j)}}}}return m},isChemObjRenderedBySelf:function($super,b,d){var h=$super(b,d);if(!h){var g=this.getChildRenderers();for(var e=0,c=g.length;e<c;++e){var a=g[e];if(a.isChemObjRenderedBySelf(b,d)){return true}}}if(!h){this.refreshChildObjs();var f=this.getTargetChildObjs();h=(f&&f.indexOf(d)>=0)}return h},isChemObjRenderedDirectlyBySelf:function($super,a,b){return $super(a,b)},getChildObjs:function(){return null},prepareChildObjs:function(){var a=this.getTargetChildObjs();if(a){return a}this.setTargetChildObjs(this.getChildObjs());return this.getTargetChildObjs()},refreshChildObjs:function(){this.setTargetChildObjs(null);this.prepareChildObjs()},getChildRenderers:function(){return this.getChildRendererMap().getValues()},getRendererForChild:function(g,f){var b=(this.getRendererType()===Kekule.Render.RendererType.R3D)?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass;var e=this.getChildRendererMap();var a=e.get(g);if(!a&&f){var d=b(g)||Kekule.Render.DummyRenderer;var a=d?new d(g,this.getDrawBridge(),this):null;e.set(g,a);a.setRedirectContext(this.getRedirectContext())}return a},prepareChildRenderers:function(){var g=this.getChildRendererMap();var d=this.prepareChildObjs()||[];var c=g.getKeys();for(var b=0,a=c.length;b<a;++b){var e=c[b];if(d.indexOf(e)<0){g.remove(e)}}for(var b=0,a=d.length;b<a;++b){var f=d[b];this.getRendererForChild(f,true)}return g.getValues()},releaseChildRenderers:function(){var d=this.getChildRendererMap();var b=d.getValues();if(!b){return}for(var c=0,a=b.length;c<a;++c){b[c].finalize()}d.clear()},hasChild:function(){return !!(this.getTargetChildObjs()||[]).length},prepare:function(){this.prepareChildObjs();this.prepareChildRenderers()},reset:function(){this.setTargetChildObjs(null);this.releaseChildRenderers()},doDraw:function($super,b,c,a){this.prepare();if(!this.hasChild()){return $super(b,c,a)}else{return this.doDrawChildrenAndSelf(b,c,a)}},doDrawChildrenAndSelf:function(b,g,m){var j=this.createDrawGroup(b);var h=this.getChildRenderers();var c=Object.create(m);this.getRenderCache(b).childDrawOptions=c;for(var f=0,e=h.length;f<e;++f){var a=h[f];var g=null;var d=a.draw(b,g,c);if(j&&d){this.addToDrawGroup(d,j)}}var k=this.doDrawSelf(b,g,m);if(k){this.addToDrawGroup(k,j)}return j},doDrawSelf:function($super,b,c,a){return $super(b,c,a)},doClear:function($super,d){if(this.hasChild()){var b=this.getChildRendererMap().getValues();for(var c=0,a=b.length;c<a;++c){if(b[c]){b[c].clear(d)}}}$super(d);return true},doClearSelf:function($super,a){return $super(a)},doUpdate:function($super,b,A,g){return $super(b,A,g);var B=Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(A);var d=this.getTargetChildObjs()||[];var a=this.getChildRendererMap();var f=Kekule.ArrayUtils.toArray(B);var n=new Kekule.MapEx(false);var C=[];var D=false;for(var w=0,t=f.length;w<t;++w){var m=f[w];if(this.isChemObjRenderedDirectlyBySelf(b,m)){D=true}}if(D){this.doClear(b);this.redraw(b);return true}for(var w=0,t=f.length;w<t;++w){var m=f[w];var s=a.get(m);if(s){if(g===Kekule.Render.ObjectUpdateType.REMOVE){s.clear();a.remove(m)}else{Kekule.ArrayUtils.pushUnique(C,s);z=[m];n.set(s,z)}}else{var e=this._getRenderersForChildObj(b,m);if(!e.length){if(d.indexOf(m)>=0){var p=this.getRendererForChild(m,true);var c=p.draw(b,null,this.getRenderCache(b).childDrawOptions);if(c){var y=this.getCachedDrawnElem(b);if(y){this.addToDrawGroup(c,y)}}}}for(var v=0,u=e.length;v<u;++v){var s=e[v];var z=n.get(s);if(!z){C.push(s);z=[];n.set(s,z)}z.push(m)}}}var h=true;for(var w=0,t=C.length;w<t;++w){var s=C[w];var q=n.get(s);var x=Kekule.Render.UpdateObjUtils._createUpdateObjDetailsFromObjs(q);var p=s.update(b,x,g);h=h&&p}var h=C&&C.length>0;if(!h){h=true}return h},doUpdateSelf:function($super,c,b,a){return $super(c,b,a)},_getRenderersForChildObj:function(e,g){var a=[];var c=this.getChildRenderers();for(var d=0,b=c.length;d<b;++d){var f=c[d];if(f.isChemObjRenderedBySelf(e,g)){a.push(f)}}return a}},addCompositeRenderSupport:function(a){ClassEx.defineProp(a,"targetChildObjs",{dataType:DataType.ARRAY,serializable:false});ClassEx.defineProp(a,"childRendererMap",{dataType:DataType.OBJECT,serializable:false,getter:function(){var b=this.getPropStoreFieldValue("childRendererMap");if(!b){b=new Kekule.MapEx(true);this.setPropStoreFieldValue("childRendererMap",b)}return b}});ClassEx.extend(a,Kekule.Render.RendererDefineUtils.CompositeObjRendererMethods)}};(function(){var a=Kekule.OBJDEF_TEXTS;var b=Class.PropertyScope;Kekule.Render.PredefinedConfigsMap=Class.create(Kekule.ConfigPresetMap,{CLASS_NAME:"Kekule.Render.PredefinedConfigsMap"});Kekule.Render.GeneralConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.GeneralConfigs",initProperties:function(){this.addBoolConfigProp("allowCoordBorrow",true,{scope:b.PUBLIC});this.addFloatConfigProp("drawOpacity",1,{title:a.TITLE_DRAWOPACITY,description:a.DES_DRAWOPACITY})}});Kekule.Render.Render2DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render2DConfigs",initProperties:function(){this.addConfigProp("generalConfigs","Kekule.Render.GeneralConfigs");this.addConfigProp("moleculeDisplayConfigs","Kekule.Render.MoleculeDisplayConfigs");this.addConfigProp("displayLabelConfigs","Kekule.Render.DisplayLabelConfigs");this.addConfigProp("textFontConfigs","Kekule.Render.TextFontConfigs");this.addConfigProp("lengthConfigs","Kekule.Render.LengthConfigs");this.addConfigProp("colorConfigs","Kekule.Render.ColorConfigs")},initPropValues:function($super){$super();this.setPropStoreFieldValue("generalConfigs",new Kekule.Render.GeneralConfigs());this.setPropStoreFieldValue("moleculeDisplayConfigs",new Kekule.Render.MoleculeDisplayConfigs());this.setPropStoreFieldValue("displayLabelConfigs",new Kekule.Render.DisplayLabelConfigs());this.setPropStoreFieldValue("textFontConfigs",new Kekule.Render.TextFontConfigs());this.setPropStoreFieldValue("lengthConfigs",new Kekule.Render.LengthConfigs());this.setPropStoreFieldValue("colorConfigs",new Kekule.Render.ColorConfigs())},initInteractStyleMap:function(){}});Kekule.ClassUtils.makeSingleton(Kekule.Render.Render2DConfigs);Kekule.Render.getRender2DConfigs=function(){return Kekule.Render.Render2DConfigs.getInstance()};Kekule.Render.MoleculeDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.MoleculeDisplayConfigs",initProperties:function(){this.addIntConfigProp("defMoleculeDisplayType",Kekule.Render.MoleculeDisplayType.SKELETAL,{enumSource:Kekule.Render.MoleculeDisplayType});this.addIntConfigProp("defNodeDisplayMode",Kekule.Render.NodeLabelDisplayMode.SMART,{enumSource:Kekule.Render.NodeLabelDisplayMode});this.addIntConfigProp("defHydrogenDisplayLevel",Kekule.Render.HydrogenDisplayLevel.EXPLICIT,{enumSource:Kekule.Render.HydrogenDisplayLevel});this.addIntConfigProp("defChargeMarkType",Kekule.Render.ChargeMarkRenderType.DEFAULT,{enumSource:Kekule.Render.ChargeMarkRenderType});this.addBoolConfigProp("distinguishSingletAndTripletRadical",false);this.addIntConfigProp("partialChargeDecimalsLength",2);this.addBoolConfigProp("autoCreateChargeAndRadicalMarker",true)}});Kekule.Render.DisplayLabelConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.DisplayLabelConfigs",DEF_UNSET_ELEMENT:"?",DEF_DUMMY_ATOM:"Du",DEF_HETERO_ATOM:"Q",DEF_ANY_ATOM:"A",DEF_VARIABLE_ATOM:"L",DEF_RGROUP:"R",DEF_ISO_LIST_LEADING_BRACKET:"[",DEF_ISO_LIST_TAILING_BRACKET:"]",DEF_ISO_LIST_DELIMITER:",",DEF_ISO_LIST_DISALLOW_PREFIX:"NOT",initProperties:function(){var c=Kekule.ChemStructureNodeLabels;this.addBoolConfigProp("enableIsotopeAlias",c.ENABLE_ISOTOPE_ALIAS,{getter:function(){return c.ENABLE_ISOTOPE_ALIAS},setter:function(d){c.ENABLE_ISOTOPE_ALIAS=d}});this.addStrConfigProp("unsetElement",c.UNSET_ELEMENT,{getter:function(){return c.UNSET_ELEMENT},setter:function(d){if(d){c.UNSET_ELEMENT=d}}});this.addStrConfigProp("dummyAtom",c.DUMMY_ATOM,{getter:function(){return c.DUMMY_ATOM},setter:function(d){if(d){c.DUMMY_ATOM=d}}});this.addStrConfigProp("heteroAtom",c.HETERO_ATOM,{getter:function(){return c.HETERO_ATOM},setter:function(d){if(d){c.HETERO_ATOM=d}}});this.addStrConfigProp("anyAtom",c.ANY_ATOM,{getter:function(){return c.ANY_ATOM},setter:function(d){if(d){c.ANY_ATOM=d}}});this.addStrConfigProp("variableAtom",c.VARIABLE_ATOM,{getter:function(){return c.VARIABLE_ATOM},setter:function(d){if(d){c.VARIABLE_ATOM=d}}});this.addStrConfigProp("rgroup",c.SUBGROUP,{getter:function(){return c.SUBGROUP},setter:function(d){if(d){c.SUBGROUP=d}}});this.addStrConfigProp("isoListLeadingBracket",c.ISO_LIST_LEADING_BRACKET,{getter:function(){return c.ISO_LIST_LEADING_BRACKET},setter:function(d){if(d){c.ISO_LIST_LEADING_BRACKET=d}}});this.addStrConfigProp("isoListTailingBracket",c.ISO_LIST_TAILING_BRACKET,{getter:function(){return c.ISO_LIST_TAILING_BRACKET},setter:function(d){if(d){c.ISO_LIST_TAILING_BRACKET=d}}});this.addStrConfigProp("isoListDelimiter",c.ISO_LIST_DELIMITER,{getter:function(){return c.ISO_LIST_DELIMITER},setter:function(d){if(d){c.ISO_LIST_DELIMITER=d}}});this.addStrConfigProp("isoListDisallowPrefix",c.ISO_LIST_DISALLOW_PREFIX,{getter:function(){return c.ISO_LIST_DISALLOW_PREFIX},setter:function(d){if(d){c.ISO_LIST_DISALLOW_PREFIX=d}}})}});Kekule.Render.TextFontConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.TextFontConfigs",DEF_LABEL_FONT_FAMILY:"",initProperties:function(){this.addStrConfigProp("labelFontFamily","Arial, Helvetica, sans-serif");this.addStrConfigProp("atomFontFamily","Arial, Helvetica, sans-serif");this.addFloatConfigProp("supFontSizeRatio",0.66);this.addFloatConfigProp("subFontSizeRatio",0.66);this.addFloatConfigProp("superscriptOverhang",0.2);this.addFloatConfigProp("subscriptOversink",0.2);this.addIntConfigProp("textCharDirection",Kekule.Render.TextDirection.LTR,{enumSource:Kekule.Render.TextDirection});this.addIntConfigProp("textHorizontalAlign",Kekule.Render.TextAlign.LEADING,{enumSource:Kekule.Render.TextAlign});this.addIntConfigProp("textVerticalAlign",Kekule.Render.TextAlign.LEADING,{enumSource:Kekule.Render.TextAlign});this.addIntConfigProp("textBoxXAlignment",Kekule.Render.BoxXAlignment.LEFT,{enumSource:Kekule.Render.BoxXAlignment,scope:b.PUBLIC});this.addIntConfigProp("textBoxYAlignment",Kekule.Render.BoxYAlignment.TOP,{enumSource:Kekule.Render.BoxYAlignment,scope:b.PUBLIC});this.addIntConfigProp("textBoxAlignmentMode",Kekule.Render.TextBoxAlignmentMode.ANCHOR,{enumSource:Kekule.Render.TextBoxAlignmentMode,scope:b.PUBLIC})}});Kekule.Render.LengthConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.LengthConfigs",initProperties:function(){this.addFloatConfigProp("unitLength",1,{scope:b.PUBLIC});this.addFloatConfigProp("labelFontSize",14);this.addFloatConfigProp("atomFontSize",14);this.addFloatConfigProp("atomLabelBoxExpandRatio",1.2,{scope:b.PUBLIC});this.addFloatConfigProp("chargeMarkFontSize",10);this.addFloatConfigProp("chargeMarkMargin",5);this.addFloatConfigProp("chemMarkerFontSize",10);this.addFloatConfigProp("chemMarkerMargin",5);this.addFloatConfigProp("allenCenterAtomRadius",3);this.addFloatConfigProp("defBondLength",25);this.addFloatConfigProp("bondLineWidth",1);this.addFloatConfigProp("boldBondLineWidthRatio",2,{scope:b.PUBLIC});this.addFloatConfigProp("hashSpacing",3);this.addFloatConfigProp("multipleBondSpacingRatio",0.18);this.addFloatConfigProp("multipleBondSpacingAbs",null,{scope:b.PUBLIC});this.addFloatConfigProp("multipleBondMaxAbsSpacing",5);this.addFloatConfigProp("bondArrowLength",6);this.addFloatConfigProp("bondArrowWidth",6);this.addFloatConfigProp("bondWedgeWidth",6);this.addFloatConfigProp("bondWedgeHashMinWidth",2);this.addFloatConfigProp("bondWavyRadius",5);this.addFloatConfigProp("glyphStrokeWidth",1);this.addFloatConfigProp("rxnMolMargin",10,{scope:b.PUBLIC});this.addFloatConfigProp("defScaleRefLength",0.8);this.addFloatConfigProp("autofitContextPadding",45)},getActualLength:function(d){var c=this.getPropValue(d);if((c!==null)&&(c!==undefined)){return c*this.getUnitLength()}else{return null}}});Kekule.Render.ColorConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.ColorConfigs",initProperties:function(){this.addBoolConfigProp("useAtomSpecifiedColor",false);this.addStrConfigProp("labelColor","#000000");this.addStrConfigProp("atomColor","#000000");this.addStrConfigProp("bondColor","#000000");this.addStrConfigProp("glyphStrokeColor","#999999");this.addStrConfigProp("glyphFillColor","#999999")}});Kekule.Render.Render3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render3DConfigs",initProperties:function(){this.addConfigProp("generalConfigs","Kekule.Render.GeneralConfigs");this.addConfigProp("moleculeDisplayConfigs","Kekule.Render.Molecule3DDisplayConfigs");this.addConfigProp("lengthConfigs","Kekule.Render.Length3DConfigs");this.addConfigProp("environmentConfigs","Kekule.Render.Render3DEnvironmentConfigs");this.addConfigProp("modelConfigs","Kekule.Render.Model3DConfigs")},initPropValues:function($super){$super();this.setPropStoreFieldValue("generalConfigs",new Kekule.Render.GeneralConfigs());this.setPropStoreFieldValue("environmentConfigs",new Kekule.Render.Render3DEnvironmentConfigs());this.setPropStoreFieldValue("moleculeDisplayConfigs",new Kekule.Render.Molecule3DDisplayConfigs());this.setPropStoreFieldValue("modelConfigs",new Kekule.Render.Model3DConfigs());this.setPropStoreFieldValue("lengthConfigs",new Kekule.Render.Length3DConfigs())}});Kekule.ClassUtils.makeSingleton(Kekule.Render.Render3DConfigs);Kekule.Render.getRender3DConfigs=function(){return Kekule.Render.Render3DConfigs.getInstance()};Kekule.Render.Render3DEnvironmentConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Render3DEnvironmentConfigs",initProperties:function(){this.addIntConfigProp("graphicQuality",Kekule.Render.Render3DGraphicQuality.MEDIUM,{enumSource:Kekule.Render.Render3DGraphicQuality})}});Kekule.Render.Molecule3DDisplayConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Molecule3DDisplayConfigs",initProperties:function(){this.addIntConfigProp("defMoleculeDisplayType",Kekule.Render.Molecule3DDisplayType.BALL_STICK,{enumSource:Kekule.Render.Molecule3DDisplayType});this.addIntConfigProp("defBondSpliceMode",Kekule.Render.Bond3DSpliceMode.WEIGHTING_SPLIT,{enumSource:Kekule.Render.Bond3DSpliceMode});this.addBoolConfigProp("defDisplayMultipleBond",true);this.addStrConfigProp("defBondColor","#FFFFFF");this.addStrConfigProp("defAtomColor","#000099");this.addBoolConfigProp("useAtomSpecifiedColor",true)}});Kekule.Render.Model3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Model3DConfigs",initProperties:function(){this.addBoolConfigProp("showNodeLabel",true,{scope:b.PUBLIC});this.addBoolConfigProp("hideHydrogens",false);this.addBoolConfigProp("useVdWRadius",true);this.addFloatConfigProp("nodeRadiusRatio",0.25,{scope:b.PUBLIC});this.addFloatConfigProp("connectorRadiusRatio",0.25,{scope:b.PUBLIC});this.addFloatConfigProp("multiConnectorRadiusRatio",0.5);this.addFloatConfigProp("multiConnectorMarginRatio",1)}});Kekule.Render.Length3DConfigs=Class.create(Kekule.AbstractConfigs,{CLASS_NAME:"Kekule.Render.Length3DConfigs",initProperties:function(){this.addFloatConfigProp("unitLength",1,{scope:b.PUBLIC});this.addFloatConfigProp("fixedNodeRadius",1.7);this.addFloatConfigProp("connectorRadius",0.6);this.addFloatConfigProp("connectorLineWidth",2);this.addFloatConfigProp("defBondLength",100,{scope:b.PUBLIC})},getActualLength:function(d){var c=this.getPropValue(d);if((c!==null)&&(c!==undefined)){return c*this.getUnitLength()}else{return null}}})})();(function(){var c=Kekule.Render.RichText;var e=Kekule.Render.RichTextUtils;var b=Kekule.Render.TextDirection;var a=Kekule.Render.TextDrawUtils;var d=Kekule.Render.TextAlign;Kekule.Render.AbstractTextDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.AbstractTextDrawBridge",drawText:function(g,i,h,f){return null},canMeasureText:function(f){return false},measureText:function(g,h,f){return{}},canMeasureDrawnText:function(f){return false},measureDrawnText:function(g,h,f){return{}},canModifyText:function(f){return false},modifyDrawnTextCoord:function(g,h,f){},createGroup:function(f){},addToGroup:function(f,g){},removeFromGroup:function(f,g){}});Kekule.Render.BaseRichTextDrawer=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.BaseRichTextDrawer",ITEM_PARENT_FIELD:"__$parent__",initialize:function($super,h,g,f){$super();this.options=g||{};if(h){this.setDrawBridge(h)}if(f){this.setDrawConfigs(f)}},initProperties:function(){this.defineProp("drawBridge",{dataType:"Kekule.Render.AbstractTextDrawBridge",serializable:false});this.defineProp("drawConfigs",{dataType:"Kekule.Render.Render2DConfigs",serializable:false})},fillOptions:function(f){if(f){var h=f.getTextFontConfigs();var g=this.options;g.supFontSizeRatio=h.getSupFontSizeRatio();g.subFontSizeRatio=h.getSubFontSizeRatio();g.superscriptOverhang=h.getSuperscriptOverhang();g.subscriptOversink=h.getSubscriptOversink();g.textCharDirection=h.getTextCharDirection();g.textLineDirection=h.getTextLineDirection();g.textHorizontalAlign=h.getTextHorizontalAlign();g.textVerticalAlign=h.getTextVerticalAlign();g.textBoxXAlignment=h.getTextBoxXAlignment();g.textBoxYAlignment=h.getTextBoxYAlignment();g.textBoxAlignmentMode=h.getTextBoxAlignmentMode()}},cloneRichText:function(f){return Kekule.Render.RichTextUtils.clone(f)},_FONT_OPTION_FIELDS:["fontSize","fontFamily","fontWeight","fontStyle","color","overhang","oversink","opacity","zoom"],_DRAW_OPTIONS_FIELDS:["textType","charDirection","defaultCharDirection","fontSize","fontFamily","fontWeight","fontStyle","color","horizontalAlign","verticalAlign","zoom"],_fillLocalDrawOptions:function(h,j){var f=j||{};var m=0;for(var k=0,g=this._DRAW_OPTIONS_FIELDS.length;k<g;++k){var o=this._DRAW_OPTIONS_FIELDS[k];var n=h[o];if(Kekule.ObjUtils.notUnset(n)){f[o]=n;++m}}if(Kekule.ObjUtils.isUnset(h.charDirection)){f.charDirection=b.DEFAULT}else{if(h.charDirection===b.INHERIT){f.charDirection=j.charDirection}}return f},RECT_INFO_FIELD:"__rectInfo__",ACTUAL_FONT_FIELD:"__drawFont__",RENDER_TEXT_FIELD:"__renderText__",RENDER_ELEM_FIELD:"__renderElem__",LOCAL_DRAW_OPTIONS_FIELD:"__drawOptions__",_setItemRectInfo:function(g,f,h){g[this.RECT_INFO_FIELD]={boundRect:Object.extend({},f),alignRect:Object.extend({},h)}},_getItemRectInfo:function(f){return f[this.RECT_INFO_FIELD]},_setActualFontInfo:function(f,g){f[this.ACTUAL_FONT_FIELD]=g},_getActualFontInfo:function(f){return f[this.ACTUAL_FONT_FIELD]},_setRenderText:function(f,g){f[this.RENDER_TEXT_FIELD]=g},_getRenderText:function(f){return f[this.RENDER_TEXT_FIELD]||f.text},_setRenderElem:function(f,g){f[this.RENDER_ELEM_FIELD]=g},_getRenderElem:function(f){return f[this.RENDER_ELEM_FIELD]},_itemHasNoAlignRect:function(g){var f=Kekule.ObjUtils.notUnset(g._noAlignRect)?(!!g._noAlignRect):(e.isSubscript(g)||e.isSuperscript(g));return f},drawEx:function(i,m,h,q,n){var j;if(!q){j=this.options}else{j=Object.create(this.options||{});j=Object.extend(j,q)}if(!j.defaultCharDirection){j.defaultCharDirection=j.charDirection}var k=this.cloneRichText(h);var l=this.getDrawBridge();var g={delayDrawing:l.canMeasureText(),adjustDrawing:l.canModifyText()};this.doPrepare(i,m,k,j,g);var f=this.doRenderRichText(i,k,j,g);var o=this._getItemRectInfo(k).boundRect;var p={drawnObj:f,boundRect:o};return p},draw:function(h,j,i,g,f){return this.drawEx(h,j,i,g,f).drawnObj},doPrepare:function(j,n,i,q,h){var r=this.doPrepareItem(j,i,q,h);var k=null;if(q.textBoxAlignmentMode===Kekule.Render.TextBoxAlignmentMode.ANCHOR){k=this.doGetRootAnchorItemAbsAlignRect(i)}var g=this._getItemRectInfo(i);var p;if(k){var o=this.doAlignRectToCoord(n,k,q.textBoxXAlignment,q.textBoxYAlignment);p={x:o.left-k.left,y:o.top-k.top}}else{var l=this.doAlignRectToCoord(n,g.alignRect,q.textBoxXAlignment,q.textBoxYAlignment);p={x:l.left-g.alignRect.left,y:l.top-g.alignRect.top}}var m=Kekule.RectUtils.shiftRect(g.alignRect,p.x,p.y);var f=Kekule.RectUtils.shiftRect(g.boundRect,p.x,p.y);this._setItemRectInfo(i,f,m);return r},doAlignRectToCoord:function(i,m,f,l){var k=Kekule.Render.BoxXAlignment;var g=Kekule.Render.BoxYAlignment;var j=(f===k.RIGHT)?-1:(f===k.CENTER)?-0.5:0;var h=(l===g.TOP)?0:(l===g.CENTER)?-0.5:-1;var n=Object.extend({},m);n.left=i.x+n.width*j;n.top=i.y+n.height*h;return n},doGetRootAnchorItemAbsAlignRect:function(g){var h=g;if(h.anchorItem){var f=this._getItemRectInfo(h).alignRect;var i={x:f.left,y:f.top};while(h.anchorItem){h=h.anchorItem;f=this._getItemRectInfo(h).alignRect;i.x+=f.left;i.y+=f.top}return Kekule.RectUtils.createRect(i.x,i.y,f.width,f.height)}else{return null}},doCalcActualDrawFontInfo:function(h,m){function j(l,o){if(typeof(l)==="string"){var i=Kekule.StyleUtils.analysisUnitsValue(l);i.value=Math.round(Math.max(i.value*o,1));return""+i.value+i.units}else{return l*o}}var f={sizeScale:1};for(var k=0,g=this._FONT_OPTION_FIELDS.length;k<g;++k){var n=this._FONT_OPTION_FIELDS[k];if(Kekule.ObjUtils.notUnset(m[n])){f[n]=m[n]}}if(Kekule.ObjUtils.notUnset(m.zoom)){f.fontSize=j(f.fontSize,m.zoom||1)}if(e.isSuperscript(h)){f.sizeScale=m.supFontSizeRatio;f.fontSize=j(f.fontSize,m.supFontSizeRatio);f.isSup=true;if(Kekule.ObjUtils.isUnset(f.overhang)){f.overhang=m.superscriptOverhang||0}}else{if(e.isSubscript(h)){f.sizeScale=m.subFontSizeRatio;f.fontSize=j(f.fontSize,m.subFontSizeRatio);f.isSub=true;if(Kekule.ObjUtils.isUnset(f.oversink)){f.oversink=m.subscriptOversink||0}}}return f},doPrepareItem:function(h,j,g,k){var l=e.getItemType(j);var i=Object.create(g);i=this._fillLocalDrawOptions(j,i);if(i.charDirection===b.DEFAULT||Kekule.ObjUtils.isUnset(i.charDirection)){i.charDirection=i.defaultCharDirection}var f;switch(l){case c.SECTION:f=this.doPrepareSection(h,j,i,k);break;case c.LINES:f=this.doPrepareLines(h,j,i,k);break;default:f=this.doPrepareGroup(h,j,i,k);break}return f},doPrepareSection:function(g,q,v,f){var j=this.getDrawBridge();var k=this.doCalcActualDrawFontInfo(q,v);this._setActualFontInfo(q,k);var t=q.text;if(a.isVerticalLine(v.charDirection)&&(t.length>1)){var s=q;s.role="group";delete s.text;s.charDirection=v.charDirection;var p=Object.create(v);p=Object.extend(p,k);s.items=[];for(var n=0,h=t.length;n<h;++n){e.appendText(s,t.charAt(n))}return this.doPrepareItem(g,s,p,f)}if(v.charDirection===b.RTL){t=t.reverse()}this._setRenderText(q,t);var o;if(f.delayDrawing){o=j.measureText(g,t,k)}else{var m={x:-10000,y:-10000};var r=this.getDrawBridge().drawText(g,m,t,k);this._setRenderElem(q,r);o=j.measureDrawnText(g,r,k)}var u={left:0,top:0,width:o.width||0,height:o.height||0};this._setItemRectInfo(q,u,u)},doPrepareLines:function(g,o,q,f){var h=q.charDirection||b.DEFAULT;var n=o.items;var k=(h===b.TTB)?b.RTL:(h===b.BTT)?b.LTR:b.TTB;for(var m=0,j=n.length;m<j;++m){var p=n[m];if(!p.charDirection){p.charDirection=h}}o.charDirection=k;q.charDirection=k;q._originCharDirection=h;return this.doPrepareGroup(g,o,q,f)},doPrepareGroup:function(j,u,m,B){var z=u.items;for(var F=0,C=z.length;F<C;++F){var L=z[F];this.doPrepareItem(j,L,m,B)}var P=m.charDirection||b.DEFAULT;var t=m._originCharDirection||P;var q=a.isHorizontalLine(P);var n=q?"x":"y";var h=q?"y":"x";var g;var D=d.getAbsAlign(m.horizontalAlign,t);var x=d.getAbsAlign(m.verticalAlign,t);if(q){g=(x==d.TOP)?0:(x==d.CENTER)?-0.5:-1}else{g=(D==d.RIGHT)?-1:(D==d.CENTER)?-0.5:0}var o={x:0,y:0};var s=((P===b.RTL)||(P===b.BTT))?-1:1;var H=q?"left":"top";var N=q?"top":"left";var w=[];for(var F=0,C=z.length;F<C;++F){var L=z[F];var k=this._getItemRectInfo(L);var f=k.boundRect;var A=k.alignRect;if(s>0){var G=o[n]-f[H];f[H]=o[n];A[H]+=G}var K={x:f.width,y:f.height};o[n]+=K[n]*s;if(s<0){var G=o[n]-f[H];f[H]=o[n];A[H]+=G}var K={x:A.width,y:A.height};var v=this._getActualFontInfo(L);if(v){isSupSub=v.isSup||v.isSub}else{isSupSub=false}if(isSupSub&&e.getActualRefItem(L,u)){w.push(L)}else{var J=v?(v.oversink||(-(v.overhang||0))):0;if(!q){J=-J}var I=K[h]*(g+J);var O=A[N]-I;A[N]=I;f[N]-=O}}for(var F=0,C=w.length;F<C;++F){var L=w[F];var y=e.getActualRefItem(L,u);var v=this._getActualFontInfo(L);var k=this._getItemRectInfo(L);var E=this._getItemRectInfo(y).alignRect;var f=k.boundRect;var A=k.alignRect;if(v.isSup){var M=v.overhang;if(q){A.top=E.top;A.height=E.height;f.top=E.top-E.height*M}else{A.left=E.left;A.width=E.width;f.left=E.lefy+E.width-f.left+E.width*M}}else{var J=v.oversink;if(q){A.top=E.top;A.height=E.height;f.top=E.top+E.height-f.height+E.height*J}else{A.left=E.left;A.width=E.width;f.left=E.left-E.width*J}}}var z=u.items;var r=null;var p=null;for(var F=0,C=z.length;F<C;++F){var L=z[F];k=this._getItemRectInfo(L);if((!this._itemHasNoAlignRect(L))||((!r)&&(F==C-1))){if(!r){r=Object.extend({},k.alignRect)}else{r=Kekule.RectUtils.getContainerRect(r,k.alignRect)}}if(!p){p=Object.extend({},k.boundRect)}else{p=Kekule.RectUtils.getContainerRect(p,k.boundRect)}}if(z.length<=0){r=Kekule.RectUtils.createRect(0,0,0,0);p=Kekule.RectUtils.createRect(0,0,0,0)}var O={x:-r.left,y:-r.top};if((O.x!==0)||(O.y!==0)){for(var F=0,C=z.length;F<C;++F){k=this._getItemRectInfo(z[F]);k.alignRect=Kekule.RectUtils.shiftRect(k.alignRect,O.x,O.y);k.boundRect=Kekule.RectUtils.shiftRect(k.boundRect,O.x,O.y)}r.left=0;r.top=0;p.left+=O.x;p.top+=O.y}this._setItemRectInfo(u,p,r)},doRenderRichText:function(g,i,f,j){var k=this.getDrawBridge();var h=k.createGroup(g);this.doRenderItem(g,{x:0,y:0},i,j,h);return h},doRenderItem:function(g,k,i,j,h){var l=e.getItemType(i);var f;switch(l){case c.SECTION:f=this.doRenderSection(g,k,i,j,h);break;default:f=this.doRenderGroup(g,k,i,j,h);break}return f},doRenderGroup:function(g,o,p,f,n){var m=p.items;if(m.length<=0){return null}var q=this._getItemRectInfo(p);var k={x:o.x+q.alignRect.left,y:o.y+q.alignRect.top};for(var j=0,h=m.length;j<h;++j){this.doRenderItem(g,k,m[j],f,n)}},doRenderSection:function(i,o,q,h,n){var g=this._getItemRectInfo(q);var f=g.boundRect;var m={x:f.left,y:f.top};m=Kekule.CoordUtils.add(m,o);var p=this._getRenderText(q);var j=this._getActualFontInfo(q);var l=this.getDrawBridge();var k;if(h.delayDrawing){k=l.drawText(i,m,p,j)}else{if(h.adjustDrawing){k=this._getRenderElem(q);l.modifyDrawnTextCoord(i,k,m)}}l.addToGroup(k,n)}})})();Kekule.Render.BoundInfoRecorder=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.BoundInfoRecorder",initialize:function($super,a){$super();this.setPropStoreFieldValue("boundInfos",new Kekule.TwoTupleMapEx(true));this._renderer=a;this.installEventListener(a)},finalize:function($super){var a=this.getPropStoreFieldValue("boundInfos");if(a){a.clear()}$super()},initProperties:function(){this.defineProp("boundInfos",{dataType:"Kekule.TwoTupleMapEx",serializable:false,setter:null});this.defineProp("targetContext",{dataType:DataType.OBJECT,serializable:false})},needRecordOnContext:function(a){var b=this.getTargetContext();return(!b)||(b===a)},installEventListener:function(a){a.addEventListener("updateBasicDrawObject",function(d){var c=Kekule.Render.ObjectUpdateType;if(this.needRecordOnContext(d.context)){var b=d.updateType;if(b===c.ADD){this.add(d.context,d.obj,d.parentObj,d.boundInfo,d.target)}else{if(b===c.MODIFY){this.modify(d.context,d.obj,d.parentObj,d.boundInfo,d.target)}else{if(b===c.REMOVE){this.remove(d.context,d.obj)}else{if(b===c.CLEAR){this.clear(d.context)}}}}this.invokeEvent("updateBasicDrawObject",d)}},this);a.addEventListener("clear",function(b){if(this.needRecordOnContext(b.context)){this.clearOnRenderer(b.context,b.target)}var c=this.getAllRecordedInfoOfContext(b.context)},this)},getInfo:function(a,b){return this.getBoundInfos().get(a,b)},getBelongedInfos:function(e,b){var g=this.getInfo(e,b);if(g){return[g]}else{var a=[];var h=this.getAllRecordedInfoOfContext(e);for(var d=0,c=h.length;d<c;++d){var g=h[d];var f=g.obj;if(f.isChildOf(b)){a.push(g)}}return a}},getBound:function(b,g){var c=this.getInfo(b,g);var m=c?c.boundInfo:null;if(!m){var e=Kekule.BoxUtils;var j=Kekule.Render.MetaShapeUtils;var k=this.getBelongedInfos(b,g);var a=null;for(var f=0,d=k.length;f<d;++f){var c=k[f];var h=j.getContainerBox(c.boundInfo,0);a=a?e.getContainerBox(a,h):h}if(a){m=j.createShapeInfo(Kekule.Render.MetaShapeType.RECT,[{x:a.x1,y:a.y1},{x:a.x2,y:a.y2}])}}return m},clearOnRenderer:function(b,c){var h=this.getBoundInfos();var f=h.getSecondLevelMap(b);if(f){var g=f.getKeys();var h=f.getValues();for(var a=g.length-1;a>=0;--a){var e=g[a];var d=h[a];if(d.renderer===c){f.remove(e)}}}},clear:function(a){var c=this.getBoundInfos();var b=c.getSecondLevelMap(a);if(b){b.clear()}return this},clearAll:function(){this.getBoundInfos().clear();return this},add:function(b,e,d,a,c){this.getBoundInfos().set(b,e,{obj:e,parentObj:d,boundInfo:a,renderer:c});return this},modify:function(b,g,f,a,e){var c=this.getBoundInfos().get(b,g);if(!c){c={};this.getBoundInfos.set(b,g,c)}var d=Kekule.ObjUtils.notUnset;if(d(f)){c.parentObj=f}if(d(a)){c.boundInfo=a}if(d(e)){c.renderer=e}return this},remove:function(a,c,b){this.getBoundInfos().remove(a,c);return this},getAllRecordedInfoOfContext:function(a){var c=this.getBoundInfos();var b=c.getSecondLevelMap(a);if(!b){return[]}else{return b.getValues()}},getAllBoundInfosOfContext:function(e){var f=this.getAllRecordedInfoOfContext(e);var a=[];for(var d=0,b=f.length;d<b;++d){var c=f[d].boundInfo;if(c){a.push(c)}}return a},getContainerBox:function(f){var d=Kekule.BoxUtils;var c=Kekule.Render.MetaShapeUtils;var a=null;var h=this.getAllBoundInfosOfContext(f);for(var e=0,b=h.length;e<b;++e){var g=c.getContainerBox(info[e],0);a=d.getContainerBox(a,g)}return a},getIntersectionInfos:function(a,e,j,h,f){var k=[];var g=this.getAllRecordedInfoOfContext(a);for(var d=0,b=g.length;d<b;++d){var c=g[d].boundInfo;if(f&&!f(g[d])){continue}if(c){if(Kekule.Render.MetaShapeUtils.isCoordInside(e,c,h)){k.push(g[d])}}}return k}});(function(){var b=Kekule.Render.BondRenderType;var e=Kekule.Render.TextDirection;var a=Kekule.BoxUtils;var d=Kekule.BondOrder;var c=Kekule.CoordUtils;var f=Kekule.oneOf;Kekule.Render.Abstract2DDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.Abstract2DDrawBridge",createContext:function(h,i,g){return null},releaseContext:function(g){},getContextDimension:function(g){return{}},setContextDimension:function(h,i,g){return null},getContextElem:function(g){},setContextViewBox:function(k,g,m,j,l,i){},clearContext:function(g){return null},setClearColor:function(h,g){},transformContextCoordToScreen:function(g,h){return h},transformScreenCoordToContext:function(g,h){return h},canModifyGraphic:function(g){return false},drawPath:function(h,i,g){},drawLine:function(h,j,i,g){},drawTriangle:function(h,k,j,i,g){},drawRect:function(h,j,i,g){},drawRoundRect:function(i,k,j,g,h){},drawCircle:function(i,j,g,h){},drawArc:function(k,m,g,j,h,l,i){},drawImage:function(i,k,j,h,g,l){},drawImageElem:function(i,k,j,h,g){},createGroup:function(g){return null},addToGroup:function(g,h){},removeFromGroup:function(g,h){},removeDrawnElem:function(g,h){},exportToDataUri:function(i,g,h){}});Kekule.Render.Base2DRenderer=Class.create(Kekule.Render.CompositeRenderer,{CLASS_NAME:"Kekule.Render.Base2DRenderer",initialize:function($super,i,g,h){$super(i,g,h);this.__$redirectContextDebug__=false;this._richTextDrawer=null},initProperties:function(){this.defineProp("richTextDrawerClass",{dataType:DataType.CLASS,serializable:false})},getActualTargetContext:function(g){return this.getRedirectContext()||g},getRendererType:function(){return Kekule.Render.RendererType.R2D},canMeasureText:function(g){return this.getDrawBridge().canMeasureText(g)},getAutoScaleRefDrawLength:function(g){return g.defBondLength},getAutoScaleRefObjLength:function(j,g){var h=j||this.getChemObj();if(h.getAllAutoScaleRefLengths){var i=h.getAllAutoScaleRefLengths(Kekule.CoordMode.COORD2D,g);if(i&&i.length){return Kekule.ArrayUtils.getMedian(i)}}else{return null}},getRichTextDrawer:function(){if(!this._richTextDrawer){var g=this.getRichTextDrawerClass()||Kekule.Render.BaseRichTextDrawer;this._richTextDrawer=new g(this.getDrawBridge())}return this._richTextDrawer},drawPath:function(h,i,g){return this.getDrawBridge().drawPath(this.getActualTargetContext(h),i,g)},drawLine:function(h,j,i,g){if(this.__$redirectContextDebug__){var k=Object.create(g);if(this.getRedirectContext()){k.color=k.strokeColor="#ff0000"}return this.getDrawBridge().drawLine(this.getActualTargetContext(h),j,i,k)}else{return this.getDrawBridge().drawLine(this.getActualTargetContext(h),j,i,g)}},drawArrowLine:function(g,i,h,p,j){var v=this.getActualTargetContext(g);if(!p){return this.drawLine(v,i,h,j)}else{var q=this.createDrawGroup(v);var r=this.drawLine(v,i,h,j);this.addToDrawGroup(r,q);var t=h.x-i.x;var s=h.y-i.y;var n=Math.atan(s/t);var A=Math.sign(t)||1;var u=(p.width||6)/2;var k=p.length||3;var y=Math.atan(u/k);var w=Math.sqrt(Math.sqr(u)+Math.sqr(k))*A;var z=Math.cos(n-y)*w;var o=Math.sin(n-y)*w;var x=Math.cos(n+y)*w;var m=Math.sin(n+y)*w;r=this.drawLine(v,h,{x:h.x-z,y:h.y-o},j);this.addToDrawGroup(r,q);r=this.drawLine(v,h,{x:h.x-x,y:h.y-m},j);this.addToDrawGroup(r,q);return q}},drawTriangle:function(h,k,j,i,g){return this.getDrawBridge().drawTriangle(this.getActualTargetContext(h),k,j,i,g)},drawRect:function(i,l,k,g){var j={x:Math.min(l.x,k.x),y:Math.min(l.y,k.y)};var h={x:Math.max(l.x,k.x),y:Math.max(l.y,k.y)};return this.getDrawBridge().drawRect(this.getActualTargetContext(i),j,h,g)},drawRoundRect:function(j,m,l,g,h){var k={x:Math.min(m.x,l.x),y:Math.min(m.y,l.y)};var i={x:Math.max(m.x,l.x),y:Math.max(m.y,l.y)};return this.getDrawBridge().drawRoundRect(this.getActualTargetContext(j),k,i,g,h)},drawCircle:function(i,j,g,h){return this.getDrawBridge().drawCircle(this.getActualTargetContext(i),j,g,h)},drawArc:function(k,m,g,j,h,l,i){return this.getDrawBridge().drawArc(this.getActualTargetContext(k),m,g,j,h,l,i)},drawText:function(i,m,k,h){var j=this.getRichTextDrawer();var g=Kekule.Render.RichTextUtils.strToRichText(k,h);if(this.__$redirectContextDebug__){var l=Object.create(h||{});if(this.getRedirectContext()){l.color=l.strokeColor="#ff0000"}return j.drawEx(this.getActualTargetContext(i),m,g,l)}else{return j.drawEx(this.getActualTargetContext(i),m,g,h)}},drawRichText:function(h,l,j,g){var i=this.getRichTextDrawer();if(this.__$redirectContextDebug__){var k=Object.create(g||{});if(this.getRedirectContext()){k.color=k.strokeColor="#ff0000"}return i.drawEx(this.getActualTargetContext(h),l,j,k)}else{return i.drawEx(this.getActualTargetContext(h),l,j,g)}},drawImage:function(j,l,k,i,h,m){var g=this;return this.getDrawBridge().drawImage(this.getActualTargetContext(j),l,k,i,h,m,function(){return g.getActualTargetContext(j)})},drawImageElem:function(g,l,j,n,o){if(l.complete){return this.getDrawBridge().drawImageElem(this.getActualTargetContext(g),l,j,n,o)}else{var k=Kekule.X.Event;if(k){var m=this;var i=function(){k.removeListener(l,"load",h)};var h=function(){i(l,h);m.update(m.getActualTargetContext(g),[{obj:m.getChemObj()}],Kekule.Render.ObjectUpdateType.MODIFY)};k.addListener(l,"load",h);k.addListener(l,"error",i)}}},createDrawGroup:function(g){return this.getDrawBridge().createGroup(this.getActualTargetContext(g))},addToDrawGroup:function(g,h){return this.getDrawBridge().addToGroup(g,h)},removeFromDrawGroup:function(g,h){return this.getDrawBridge().removeFromGroup(g,h)},removeDrawnElem:function(g,h){return this.getDrawBridge().removeDrawnElem(this.getActualTargetContext(g),h)},transformScreenCoordToContext:function(g,h){return this.doTransformScreenCoordToContext(this.getActualTargetContext(g),h)},doTransformScreenCoordToContext:function(h,i){var g=this.getDrawBridge();return(g&&g.transformScreenCoordToContext)?g.transformScreenCoordToContext(this.getActualTargetContext(h),i):i}});Kekule.Render.ChemObj2DRenderer=Class.create(Kekule.Render.Base2DRenderer,{CLASS_NAME:"Kekule.Render.ChemObj2DRenderer",doEstimateSelfObjBox:function(i,h,g){return Kekule.Render.ObjUtils.getContainerBox(this.getChemObj(),this.getCoordMode(),g)},doEstimateRenderBox:function(i,j,h,g){var l=this.estimateObjBox(i,h,g);if(l){var k=this.prepareTransformParams(i,j,h,l);var m=k;return a.transform2D(l,m)}else{return null}},doGetAutoBaseCoord:function(i){var j=i.transformParams;if(j){var h=this.getChemObj();var g=h.getAbsBaseCoord?h.getAbsBaseCoord(Kekule.CoordMode.COORD2D):h.getAbsBaseCoord2D?h.getAbsBaseCoord2D():null;if(g){return Kekule.CoordUtils.transform2D(g,j)}}return null},doDraw:function($super,i,j,h){var g=this.getAutoScaleRefObjLength(this.getChemObj(),h.allowCoordBorrow);h.medianObjRefLength=g||h.defScaleRefLength;this.prepareTransformParams(i,j,h);this.prepareGeneralOptions(i,h);return $super(i,j,h)},prepareGeneralOptions:function(h,g){},prepareTransformParams:function(i,j,m,n){var g;if(m.transformParams){g=m.transformParams}else{var l=this.generateTransformParams(i,j,m,n);m.transformParams=l;g=l}var h=Kekule.CoordUtils.calcTransform2DMatrix(g);var k=Kekule.CoordUtils.calcInverseTransform2DMatrix(g);m.transformParams.transformMatrix=h;m.transformParams.invTransformMtrix=k;this.getRenderCache(i).transformParams=g;this.getRenderCache(i).transformMatrix=h;this.getRenderCache(i).invTransformMatrix=k;return g},calcPreferedTransformOptions:function(g,o,r,h){var s={};s.allowCoordBorrow=f(r.allowCoordBorrow,false);s.unitLength=r.unitLength||1;if(!h){h=this.estimateObjBox(g,r,s.allowCoordBorrow)}var p={x:(h.x1+h.x2)/2,y:(h.y1+h.y2)/2};var i=Kekule.ObjUtils;if(i.isUnset(r.translateX)&&i.isUnset(r.translateY)){if(o){s.translateX=o.x-p.x;s.translateY=o.y-p.y}}else{s.translateX=r.translateX||0;s.translateY=r.translateY||0}s.zoom=r.zoom||1;if((!r.scale)&&(!r.scaleX)&&(!r.scaleY)){if(r.autofit){var n=this.getDrawBridge().getContextDimension(g);n.x=n.width;n.y=n.height;n=this.getDrawBridge().transformScreenCoordToContext(g,n);n.width=n.x;n.height=n.y;var m=r.autofitContextPadding;m*=s.unitLength*2;h.width=h.x2-h.x1;h.height=h.y2-h.y1;var l=Math.max(n.width-m,0)/(h.width||1);var k=Math.max(n.height-m,0)/(h.height||1);if(i.isUnset(r.retainAspect)||(r.retainAspect)){s.scaleX=s.scaleY=Math.min(l,k)}else{s.scaleX=l;s.scaleY=k}}else{var q=f(r.refDrawLength,this.getAutoScaleRefDrawLength(r))||1;var j=r.medianObjRefLength;if(Kekule.ObjUtils.isUnset(j)){j=r.defScaleRefLength}s.scaleX=s.scaleY=(q/j)||1}}else{s.scaleX=f(r.scaleX,r.scale,1);s.scaleY=f(r.scaleY,r.scale,1)}if(i.notUnset(r.rotateAngle)){s.rotateAngle=r.rotateAngle}if(i.isUnset(r.center)){s.center=p}else{s.center=r.center}if(o){s.drawBaseCoord=o}else{s.drawBaseCoord=Kekule.CoordUtils.transform2D(p,s)}return s},generateTransformParams:function(h,i,k,l){var g=this.calcPreferedTransformOptions(h,i,k,l);var j=Object.extend({},g);g=this.getFinalTransformParams(h,g);g.initialTransformOptions=j;return g},getFinalTransformParams:function(h,i){var g=Object.create(i);if(g.zoom){g.scaleX*=g.zoom;g.scaleY*=g.zoom}g.scaleY=-g.scaleY;if(g.unitLength){g.translateX*=g.unitLength;g.translateY*=g.unitLength;g.drawBaseCoord.x*=g.unitLength;g.drawBaseCoord.y*=g.unitLength}return g},getRenderFinalTransformParams:function(g){return this.getRenderCache(g).transformParams},getRenderInitialTransformOptions:function(g){var h=this.getRenderFinalTransformParams(g);return h?h.initialTransformOptions:null},doTransformCoordToObj:function(h,j,i){var g=this.getRenderCache(h).invTransformMatrix;return Kekule.CoordUtils.transform2DByMatrix(i,g)},doTransformCoordToContext:function(h,j,i){var g=this.getRenderCache(h).transformMatrix;return Kekule.CoordUtils.transform2DByMatrix(i,g)}});Kekule.Render.RichTextBased2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.RichTextBased2DRenderer",DRAWN_OBJ_FIELD:"__$drawnObj__",initialize:function($super,i,g,h){$super(i,g,h);this.__$alwaysRecalcSize__=false;this.__$isRecalculatingSize=false},getDrawnObj:function(g){return this.getExtraProp(g,this.DRAWN_OBJ_FIELD)},setDrawnObj:function(g,h){this.setExtraProp(g,this.DRAWN_OBJ_FIELD,h)},getRichText:function(h,g){return null},extractRichTextDrawOptions:function(h){var g=Object.create(h||{});g.horizontalAlign=f(g.horizontalAlign,g.textHorizontalAlign);g.verticalAlign=f(g.verticalAlign,g.textVerticalAlign);g.charDirection=f(g.charDirection,g.textCharDirection);return g},getDrawTextCoord:function(g,h){return h},doDrawSelf:function($super,i,m,p){$super(i,m,p);var n=this.getChemObj();var j=p.transformParams;var h=this.getRichText(this.getChemObj(),p);if(!h){return null}if(!m){m=this.getAutoBaseCoord(p)}var g=this.getDrawTextCoord(i,m);var o=this.drawRichText(i,g,h,this.extractRichTextDrawOptions(p));var l=o.boundRect;var k=this.createRectBoundInfo({x:l.left,y:l.top},{x:l.left+l.width,y:l.top+l.height});this.basicDrawObjectUpdated(i,n,n,k,Kekule.Render.ObjectUpdateType.ADD);this.getRenderCache(i).drawnObj=o.drawnObj;this.setDrawnObj(i,o.drawnObj);if(this.getCanModifyTargetObj()&&(n.getNeedRecalcSize&&n.getNeedRecalcSize())||(this.__$alwaysRecalcSize__)){this._autosetObjSize(i,n,k)}return o.drawnObj},_autosetObjSize:function(i,m,j){if(this.__$isRecalculatingSize){return}if(m.hasProperty("size2D")&&m.setNeedRecalcSize){this.__$isRecalculatingSize=true;try{var k=j.coords;var h=this.transformCoordToObj(i,m,k[0]);var g=this.transformCoordToObj(i,m,k[1]);var l=Kekule.CoordUtils.substract(g,h);m.setPropStoreFieldValue("size2D",{x:Math.abs(l.x),y:Math.abs(l.y)});m.setNeedRecalcSize(false)}finally{this.__$isRecalculatingSize=false}}}});Kekule.Render.TextBlock2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.TextBlock2DRenderer",getRichText:function(i,h){var g=Kekule.Render.RichTextUtils.strToRichText(i.getText());return g},doEstimateSelfObjBox:function(i,h,g){return this.getChemObj().getBox2D(g)},getDrawTextCoord:function(g,m){var n=this.getChemObj();var h=n.getExposedContainerBox();var j={x:h.x1,y:h.y2};var i={x:h.x2,y:h.y1};var l=this.transformCoordToContext(g,n,j);var k=this.transformCoordToContext(g,n,i);var p=Kekule.CoordUtils.substract(k,l);var o={x:m.x-p.x/2,y:m.y-p.y/2};return o},extractRichTextDrawOptions:function($super,g){var h=$super(g);h.fontSize=f(h.fontSize,h.labelFontSize);h.fontFamily=f(h.fontFamily,h.labelFontFamily);h.color=f(h.color,h.labelColor);h.textBoxXAlignment=Kekule.Render.BoxXAlignment.LEFT;h.textBoxYAlignment=Kekule.Render.BoxYAlignment.TOP;return h}});Kekule.Render.Formula2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.Formula2DRenderer",basicDrawObjectUpdated:function($super,i,k,j,h,g){if(k===this.getChemObj()){return $super(i,k.getParent(),k.getParent(),h,g)}else{return $super(i,k,j,h,g)}},getRichText:function(h,g){return h.getDisplayRichText(true,g.displayLabelConfigs,g.partialChargeDecimalsLength,g.chargeMarkType)},doEstimateSelfObjBox:function(i,h,g){var j=this.getChemObj()?this.getChemObj().getParent():null;if(j){var k=(j)?j.getAbsBaseCoord2D(g):{x:0,y:0};return a.createBox(k,k)}else{return null}},extractRichTextDrawOptions:function($super,g){var h=$super(g);h.fontSize=f(h.fontSize,h.atomFontSize);h.fontFamily=f(h.fontFamily,h.atomFontFamily);h.color=f(h.color,h.labelColor,h.atomColor);h.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER;h.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER;return h}});Kekule.Render.TextBasedChemMarker2DRenderer=Class.create(Kekule.Render.RichTextBased2DRenderer,{CLASS_NAME:"Kekule.Render.TextBasedChemMarker2DRenderer",initialize:function($super,i,g,h){$super(i,g,h)},doDrawSelf:function($super,h,i,g){return $super(h,i,g)},getRichText:function(l,j){var i=this.getChemObj();var k;if(i instanceof Kekule.ChemMarker.Charge){var h=i.getValue();k=Kekule.Render.ChemDisplayTextUtils.getChargeDisplayText(h,j.partialChargeDecimalsLength,j.chargeMarkType);if(k){return Kekule.Render.RichTextUtils.createSection(k,{charDirection:Kekule.Render.TextDirection.LTR})}}else{if(i instanceof Kekule.ChemMarker.Radical){var g=i.getValue();k=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(g,j.distinguishSingletAndTripletRadical);if(k){return Kekule.Render.RichTextUtils.createSection(k,{charDirection:Kekule.Render.TextDirection.LTR})}}}return null},doEstimateSelfObjBox:function($super,i,h,g){return $super(i,h,g)},extractRichTextDrawOptions:function($super,g){var h=$super(g);var i=this.getChemObj();h.fontSize=f(i.getRenderOption("fontSize"),h.chemMarkerFontSize,h.fontSize,h.atomFontSize);h.fontFamily=f(h.fontFamily,h.atomFontFamily);h.color=f(h.color,h.atomColor,h.labelColor);h.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER;h.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER;return h}});Kekule.Render.ImageBlock2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.ImageBlock2DRenderer",initialize:function($super,i,g,h){$super(i,g,h)},doDrawSelf:function($super,g,o,t){$super(g,o,t);var p=this.getChemObj();var h=t.transformParams;if(!p||!p.getSrc||!p.getSrc()){return null}if(!o){o=this.getAutoBaseCoord(t)}var j=p.getExposedContainerBox();var l={x:j.x1,y:j.y2};var k={x:j.x2,y:j.y1};var n=this.transformCoordToContext(g,p,l);var m=this.transformCoordToContext(g,p,k);var s=Kekule.CoordUtils.substract(m,n);var i={x:o.x-s.x/2,y:o.y-s.y/2};var r;var q=p.getCacheImg();if(q){r=this.drawImageElem(g,q,i,s,t)}else{r=this.drawImage(g,p.getSrc(),i,s,t)}this.basicDrawObjectUpdated(g,p,p,this.createRectBoundInfo(i,Kekule.CoordUtils.add(i,s)),Kekule.Render.ObjectUpdateType.ADD);return r}});Kekule.Render.UnbondedElectronSetRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.UnbondedElectronSetRenderer",_extractActualDrawOptions:function(g){var h=Object.create(g);var i=this.getChemObj();h.fontSize=f(i.getRenderOption("fontSize"),h.chargeMarkFontSize,h.fontSize,h.atomFontSize);h.color=f(h.color,h.atomColor,h.labelColor);h.strokeColor=h.color;h.fillColor=h.color;h.electronGap=h.fontSize/3*(h.unitLength||1)*(h.zoom||1);h.electronRadius=h.fontSize/12*(h.unitLength||1)*(h.zoom||1);return h},_drawSingleElectron:function(i,j,g,h){return this.drawCircle(i,j,g,h)},_drawElectrons:function(j,h,B,x,m){var w=c.substract(B,x);var n=c.getDistance(w);var C;var o;if(n===0){var C=0;var o=1}else{var C=w.x/n;var o=w.y/n}var s=m.electronGap;var l=m.electronRadius;var p={x:s*o,y:-s*C};var g=(h-1)/2;var k=c.substract(B,c.multiply(p,g));var v=[];var q=(h>1)?this.createDrawGroup(j):null;var A;for(var y=0;y<h;++y){v.push(k);A=this._drawSingleElectron(j,k,l,m);if(q){this.addToDrawGroup(A,q)}k=c.add(k,p)}var z;if(v.length<=1){z=this.createCircleBoundInfo(v[0],l)}else{var r=c.multiply(p,l*2/s);var u=c.substract(v[0],r);var t=c.add(v[h-1],r);z=this.createLineBoundInfo(u,t,l)}return{electronCoords:v,drawnElem:q||A,electronRadius:l,boundInfo:z}},_doGetParentCoord:function(h,j,g){var l=g.transformParams;if(l){var k=j;var i=k.getAbsBaseCoord?k.getAbsBaseCoord(Kekule.CoordMode.COORD2D):k.getAbsBaseCoord2D?k.getAbsBaseCoord2D():null;if(i){return c.transform2D(i,l)}}return null},doDrawSelf:function($super,h,p,r){$super(h,p,r);var i=this._extractActualDrawOptions(r);var q=this.getChemObj();var l=q.getParent();var j=r.transformParams;if(!q||!l||!q.getElectronCount||(q.getElectronCount()||0)<=0){return null}if(!p){p=this.getAutoBaseCoord(r)}var k=this._doGetParentCoord(h,l,r);if(!p||!k){return null}var n=this._drawElectrons(h,q.getElectronCount(),p,k,i);var o=n.electronCoords;var m=n.electronRadius;this.basicDrawObjectUpdated(h,q,l,n.boundInfo,Kekule.Render.ObjectUpdateType.ADD);var g=n.drawnElem;return g}});Kekule.Render.Ctab2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.Ctab2DRenderer",DRAW_ELEM_FIELD:"__$drawElem__",TRANSFORM_COORD_FIELD:"__$transCoord2D__",TRANSFORM_MATRIX_FIELD:"__$transMatrix__",RENDERED_OBJS_FIELD:"__$renderedObjs__",INV_TRANSFORM_MATRIX_FIELD:"__$inverseTransMatrix__",CHILD_TRANSFORM_MATRIX_FIELD:"__$childTransMatrix__",doEstimateSelfObjBox:function(i,h,g){var j=this.getChemObj().getExposedContainerBox2D(g);return j},getObjDrawElem:function(g,h){return this.getExtraProp2(g,h,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(g,i,h){this.setExtraProp2(g,i,this.DRAW_ELEM_FIELD,h)},getRenderedObjs:function(g){return this.getExtraProp(g,this.RENDERED_OBJS_FIELD)},addRenderedObj:function(g,h){var i=this.getRenderedObjs(g);if(!i){i=[h];this.setExtraProp(g,this.RENDERED_OBJS_FIELD,i)}else{Kekule.ArrayUtils.pushUnique(i,h)}},removeRenderedObj:function(g,h){var i=this.getRenderedObjs(g);if(i){Kekule.ArrayUtils.remove(i,h)}},clearRenderedObj:function(g){this.setExtraProp(g,this.RENDERED_OBJS_FIELD,null)},prepareGeneralOptions:function($super,h,g){return $super(h,g)},doPrepare:function($super,h,j,i,g){$super(h,j,i,g)},handleNodeSpecifiedRenderOptions:function(i,h){var j=(i.getOverriddenRenderOptions?i.getOverriddenRenderOptions():null)||{};var g=Object.create(h);g=Object.extend(g,j);return g},handleConnectorSpecifiedRenderOptions:function($super,i,h){var j=(i.getOverriddenRenderOptions?i.getOverriddenRenderOptions():null)||{};var g=Object.create(h||null);g=Object.extend(g,j);return g},isChemObjRenderedBySelf:function($super,i,j){var h=this.getRenderedObjs(i);var g=$super(i,j)||(h&&(h.indexOf(j)>=0))||(this.getChemObj().hasChildObj(j)&&(!j.isExposed||j.isExposed()));return g},isChemObjRenderedDirectlyBySelf:function($super,h,i){var g=this.getRenderedObjs(h);return $super(h,i)||(g&&(g.indexOf(i)>=0))},doDrawSelf:function($super,i,k,h){$super(i,k,h);var l=this.getChemObj();this._ctab=l;var j=h.transformParams;this.getRenderCache(i).transformOptions=j;this.transformCtabCoords2DToContext(i,l,j);this.doPrepare(i,l,k,h);this.getRenderCache(i).appliedOptions=h;var g=this.doDrawCore(i,l,h,j);return g},doRedraw:function(g){var h=this.getRenderCache(g);return this.doDrawCore(g,this.getChemObj(),h.appliedOptions,h.transformOptions)},doDrawCore:function(h,k,g,i){this.clearRenderedObj(h);var j=this.createDrawGroup(h);this.doDrawConnectors(h,j,k,g,i);this.doDrawNodes(h,j,k,g,i);this.setObjDrawElem(h,k,j);return j},doUpdateSelf:function($super,i,k,g){if(this.canModifyGraphic(i)){var j=false;var h=Kekule.Render.ObjectUpdateType;switch(g){case h.ADD:j=this.doAddNew(i,k);break;case h.MODIFY:j=this.doModify(i,k);break;case h.REMOVE:j=this.doRemove(i,Kekule.Render.UpdateObjUtils._extractObjsOfUpdateObjDetails(k));break;default:return $super(i,k,g)}return j}else{return $super(i,updatedObjs,g)}},doAddNew:function(g,h){if(this.canModifyGraphic()){return this.doModify(g,h)}else{return false}},doModify:function(h,p){if(this.canModifyGraphic()){var o=this._extractObjsOfUpdateObjDetails(p);this.remove(h,o);var r=this.getChemObj();var q=this.getObjDrawElem(h,r);var g=this.getRenderCache(h);var s=g.appliedOptions;if(o.indexOf(r)>=0){this.draw(h,g.baseCoord,s)}for(var n=0,k=o.length;n<k;++n){var m=o[n];if(!m.isExposed||m.isExposed()){if(r.hasConnector(m)){var j=this.handleConnectorSpecifiedRenderOptions(m,s);this.doDrawConnector(h,q,m,this.getChemObj(),j,g.transformParams||{})}else{if(r.hasNode(m)){var j=this.handleNodeSpecifiedRenderOptions(m,s);this.doDrawNode(h,q,m,this.getChemObj(),j,g.transformParams)}}}}return true}else{return false}},doRemove:function(j,o){if(this.canModifyGraphic()){var p=Kekule.ArrayUtils.toArray(o);for(var h=0,g=p.length;h<g;++h){var n=p[h];var k=this.getObjDrawElem(j,n);if(k){var m=this.getObjDrawElem(j,this.getChemObj());this.removeFromDrawGroup(k,m);this.removeDrawnElem(j,k)}this.removeRenderedObj(j,n);this.removeExtraProp2(j,n);this.basicDrawObjectUpdated(j,n,this.getChemObj(),null,Kekule.Render.ObjectUpdateType.REMOVE)}return true}else{return false}},getCoordTransformOptions:function(g){return this.getRenderCache(g).transformOptions},transformCtabCoords2DToContext:function(g,q,n){var k=n.allowCoordBorrow;var o=Object.extend({},n);o.centerX=0;o.centerY=0;var t;var p=n.transformMatrix;this.setExtraProp2(g,q,this.TRANSFORM_MATRIX_FIELD,p);var h=p;this.setExtraProp2(g,q,this.CHILD_TRANSFORM_MATRIX_FIELD,p);var s=n.invTransformMatrix;this.setExtraProp2(g,q,this.INV_TRANSFORM_MATRIX_FIELD,s);for(var r=0,m=q.getNodeCount();r<m;++r){var j=q.getNodeAt(r);this.transformObjCoord2DToContext(g,j,p,h,k)}},transformObjCoord2DToContext:function(g,n,k,o,h){var r;if(n&&n.getAbsBaseCoord2D){var p=n.getAbsBaseCoord2D(h);if(p){var q=Kekule.CoordUtils.transform2DByMatrix(p,k);this.setTransformedCoord2D(g,n,q);r=q}if(n.getNodes){for(var m=0,j=n.getNodeCount();m<j;++m){this.transformObjCoord2DToContext(g,n.getNodeAt(m),o,o,h)}}}return r},getTransformedCoord2D:function(h,l,i){if(Kekule.ObjUtils.isUnset(i)){i=this.getRenderCache(h).options.transformParams.allowCoordBorrow}var o=l instanceof Kekule.BaseStructureNode;var g=l.getParent();var n=o&&g&&g instanceof Kekule.BaseStructureConnector;var p=o&&!n&&this.getExtraProp2(h,l,this.TRANSFORM_COORD_FIELD);if(!p){var k=this.getChemObj();var j=this.getExtraProp2(h,k,this.TRANSFORM_MATRIX_FIELD);var m=this.getExtraProp2(h,k,this.CHILD_TRANSFORM_MATRIX_FIELD);if(k&&(k.hasNode(l,false)||k.hasConnector(l,false))){p=this.transformObjCoord2DToContext(h,l,j,m,i)}else{p=this.transformObjCoord2DToContext(h,l,m,m,i)}}return p},setTransformedCoord2D:function(g,h,i){this.setExtraProp2(g,h,this.TRANSFORM_COORD_FIELD,i)},doTransformCoordToObj:function($super,h,j,i){var g=this.getExtraProp2(h,j,this.INV_TRANSFORM_MATRIX_FIELD);if(g){return Kekule.CoordUtils.transform2DByMatrix(i,g)}else{return $super(h,j,i)}},doTransformCoordToContext:function($super,h,j,i){var g=this.getExtraProp2(h,j,this.TRANSFORM_MATRIX_FIELD);if(g){return Kekule.CoordUtils.transform2DByMatrix(i,g)}else{return $super(h,j,i)}},doDrawNodes:function(h,r,p,s,k){var g=p.getExposedNodes();for(var q=0,o=g.length;q<o;++q){var n=g[q];var j=this.handleNodeSpecifiedRenderOptions(n,s);var m=this.doDrawNode(h,r,n,p,j,k)}},doDrawNode:function(h,l,j,k,g,i){},doDrawConnectors:function(g,r,p,s,j){var k=p.getExposedConnectors();for(var q=0,o=k.length;q<o;++q){var n=k[q];var h=this.handleConnectorSpecifiedRenderOptions(n,s);var m=this.doDrawConnector(g,r,n,p,h,j)}},doDrawConnector:function(h,r,g,p,m,u){var t;var s=g.getConnectedExposedObjs();var v=s.length;if(v<2){return null}var A,y;var l,k;var B;var C=(v>2)?this.createDrawGroup(h):null;var o;var n=(v>2)?[]:null;var q=m;for(var x=0;x<v;++x){A=s[x];l=this.getTransformedCoord2D(h,A,u.allowCoordBorrow);if(l){for(var w=x+1;w<v;++w){y=s[w];k=this.getTransformedCoord2D(h,y,u.allowCoordBorrow);if(k){o=this.doDrawConnectorShape(h,g,[A,y],q,u);if(o){B=o.element;if(B&&C){this.addToDrawGroup(B,C)}var z=o.boundInfo;if(n&&z){n.push(z)}}}}}}t=C||B;if(t&&r){this.addToDrawGroup(t,r)}if(t){this.setObjDrawElem(h,g,t)}else{this.setObjDrawElem(h,g,null)}this.addRenderedObj(h,g);if(z||n){this.basicDrawObjectUpdated(h,g,p,n||z,Kekule.Render.ObjectUpdateType.ADD)}return t},doDrawConnectorShape:function(j,g,i,h,k){}});Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.Render.Ctab2DRenderer);Kekule.Render.ChemCtab2DRenderer=Class.create(Kekule.Render.Ctab2DRenderer,{CLASS_NAME:"Kekule.Render.ChemCtab2DRenderer",OBJ_NEED_LABEL_FIELD:"__$needDrawLabel__",OBJ_NEED_DOT_FIELD:"__$needDrawDot__",getObjNeedDrawLabel:function(h,j){var g=this.getExtraProp2(h,j,this.OBJ_NEED_LABEL_FIELD);if(Kekule.ObjUtils.isUnset(g)){var i=this.getRenderCache(h).appliedOptions;g=(j instanceof Kekule.ChemStructureConnector)?false:this._needNodeDrawLabel(j,i);this.setObjNeedDrawLabel(h,j,g)}return g},setObjNeedDrawLabel:function(g,i,h){this.setExtraProp2(g,i,this.OBJ_NEED_LABEL_FIELD,h)},getObjNeedDrawDot:function(h,j){var i=this.getRenderCache(h).appliedOptions;var g=(j instanceof Kekule.ChemStructureConnector)?false:this._needNodeDrawDot(h,j,i);return g},doPrepare:function($super,h,p,o,q){$super(h,p,o,q);if(!q.fontSize){q.fontSize=q.atomFontSize}q.textBoxXAlignment=Kekule.Render.BoxXAlignment.CENTER;q.textBoxYAlignment=Kekule.Render.BoxYAlignment.CENTER;var g=p.getExposedNodes();for(var n=0,k=g.length;n<k;++n){var j=g[n];var m=this._needNodeDrawLabel(j,q);this.setObjNeedDrawLabel(h,j,m)}},handleNodeSpecifiedRenderOptions:function($super,i,h){var g=$super(i,h);if(!g.color&&g.atomColor){g.color=g.atomColor}if(!g.fontFamily&&g.atomFontFamily){g.fontFamily=g.atomFontFamily}if(!g.fontSize&&g.atomFontSize){g.fontSize=g.atomFontSize}return g},handleConnectorSpecifiedRenderOptions:function($super,i,h){var g=$super(i,h);if(!g.color&&g.bondColor){g.color=g.bondColor}return g},doDrawNode:function(V,x,F,m,A,R){var u;var Q;var s=this.getTransformedCoord2D(V,F,R.allowCoordBorrow);var o=A;var r=F.getAtomicNumber?F.getAtomicNumber():0;var w=F.getOverriddenRenderOptions()||{};var I=w.color||w.atomColor;if(I){o.color=I}else{if(o.useAtomSpecifiedColor){var E;if(r<=0){var C=F.getClassLocalName();E=Kekule.Render.RenderColorUtils.getColor(C,this.getRendererType())}else{E=Kekule.Render.RenderColorUtils.getColor(r,this.getRendererType())}o.color=E}}var g=F.getCharge()||F.getRadical();var J=(F.getCharge()&&!F.fetchChargeMarker(false));var t=(F.getRadical()&&!F.fetchRadicalMarker(false));var v=false;if(this.getObjNeedDrawLabel(V,F)){v=true;var p=Kekule.Render.HydrogenDisplayLevel.ALL;var M=!!(J||t);var N=F.getDisplayRichText(p,M,o.displayLabelConfigs,o.partialChargeDecimalsLength,o.chargeMarkType,o.distinguishSingletAndTripletRadical);var j=!o.charDirection?this._decideNodeLabelCharDirection(V,F):o.charDirection;o.fontSize*=o.unitLength;var z=Object.create(o);z.charDirection=j;var G=this.drawRichText(V,s,N,z);var P=G.drawnObj;var B=G.boundRect;Q=this.createRectBoundInfo({x:B.left,y:B.top},{x:B.left+B.width,y:B.top+B.height});u=P}else{var T,S;if(this.getObjNeedDrawDot(V,F)&&Kekule.ObjUtils.isUnset(o.atomRadius)){o.atomRadius=o.allenCenterAtomRadius}if(o.atomRadius){var L=o.atomRadius*o.unitLength;o.strokeColor=o.color;o.fillColor=o.color;T=this.drawCircle(V,s,L,o);Q=this.createCircleBoundInfo(s,L)}else{Q=this.createPointBoundInfo(s)}if(J||t){var G=this.doDrawElectronStateMark(V,x,F,o.chargeMarkType,o.partialChargeDecimalsLength,o.distinguishSingletAndTripletRadical,o.fontFamily,o.chargeMarkFontSize*o.unitLength,o.chargeMarkMargin*o.unitLength,o.chargeMarkCircleWidth*o.unitLength,o.color,o.opacity,o.zoom||1);if(G){S=G.drawnObj}}if(T&&S){u=this.createDrawGroup(V);this.addToDrawGroup(u,T);this.addToDrawGroup(u,S)}else{u=T||S}}if(F.getUnplacedMarkers(this.getCoordMode()).length>=0){var h;var l=o.chemMarkerMargin;if(v){var H=1;var k=this._getNodeFontSize(V,F)*(R.zoom||1);var y=k*o.unitLength*H/2;l+=y-l/2;var q=Kekule.Render.TextDirection;var n=[q.LTR,q.RTL,q.TTB,q.BTT];var K=(j===q.LTR)?{x:1,y:0}:(j===q.RTL)?{x:-1,y:0}:(j===q.TTB)?{x:0,y:1}:(j===q.BTT)?{x:0,y:-1}:{x:0,y:0};var i={x:K.x*R.scaleX,y:K.y*R.scaleY};h=(i.x>0)?0:(i.x<0)?Math.PI:(i.y>0)?Math.PI/2:(i.y<0)?Math.PI*3/2:null}var O=l/o.defBondLength*o.medianObjRefLength;this.doAdjustChemPropMarkerPos(F,O,R.allowCoordBorrow,Kekule.ObjUtils.notUnset(h)?[h]:[])}if(u){this.setObjDrawElem(V,F,u);if(x){this.addToDrawGroup(u,x)}}else{this.setObjDrawElem(V,F,null)}this.addRenderedObj(V,F);this.basicDrawObjectUpdated(V,F,m,Q,Kekule.Render.ObjectUpdateType.ADD);return u},_getNodeFontSize:function(g,h,i){if(!i){i=this.getRenderCache(g).appliedOptions||this.getRenderCache(g).options}var j=Kekule.Render.RenderOptionUtils.getNodeLabelDrawOptions(h.getOverriddenRenderOptions())||{};return f(j.fontSize,i.fontSize,i.atomFontSize)},_getNodeHydrogenDisplayLevel:function(i,j){var k=i.getOverriddenRenderOptions();var h=Kekule.Render.RenderOptionUtils.getHydrogenDisplayLevel(k);var g=Kekule.ObjUtils.notUnset(h)?h:((j.moleculeDisplayType===Kekule.Render.MoleculeDisplayType.CONDENSED)?Kekule.Render.HydrogenDisplayLevel.ALL:j.hydrogenDisplayLevel);return g},_needNodeDrawDot:function(i,j,k){var m=j.getOverriddenRenderOptions();if(!(j instanceof Kekule.Atom)){return false}else{if(j.getAtomicNumber()!==Kekule.Render.DEF_ATOM_ATOMIC_NUM){return false}else{if(this.getObjNeedDrawLabel(i,j)){return false}var h=j.getLinkedBonds();if(h.length===2){var l=j.getLinkedMultipleBonds();if(l.length===2){if(l[0].getBondOrder()===l[1].getBondOrder()){var g=l[0].getBondOrder();return g>=d.DOUBLE&&g<d.EXPLICIT_AROMATIC}}}return false}}},_needNodeDrawLabel:function(i,p){var k=Kekule.Render.RenderOptionUtils;var m=Kekule.Render.NodeLabelDisplayMode;var g=i.getOverriddenRenderOptions();var l=k.getNodeDisplayMode(g)||p.nodeDisplayMode;if(!(i instanceof Kekule.ChemStructureNode)){return false}if(l===m.HIDDEN){return false}else{if(l===m.SHOWN){return true}else{var j=p.moleculeDisplayType;if(j===Kekule.Render.MoleculeDisplayType.CONDENSED){return true}else{var h=i.getLinkedConnectors();if(h.length<=0){return true}if((i instanceof Kekule.Atom)&&(i.getAtomicNumber()===Kekule.Render.DEF_ATOM_ATOMIC_NUM)&&(!i.getMassNumber())){if(i.getRenderOption("customLabel")){return true}var n=this._getNodeHydrogenDisplayLevel(i,p);var o=Kekule.Render.HydrogenDisplayLevel;if((n===o.ALL)||(n===o.NONE)){return true}else{if(n===o.UNMATCHED_EXPLICIT){return(i.getImplicitHydrogenCount()!==i.getExplicitHydrogenCount())}else{return Kekule.ObjUtils.notUnset(i.getExplicitHydrogenCount())}}}else{return true}}}}},_isNodeHasConnectorToDirection:function(n,k,g){if(Kekule.ObjUtils.isUnset(g)){g=1/5}for(var j=0,h=n.length;j<h;++j){var m=n[j];if((k===e.LTR)&&(m.x>g)){return true}else{if((k===e.RTL)&&(m.x<-g)){return true}}if((k===e.TTB)&&(m.y>g)){return true}else{if((k===e.BTT)&&(m.y<-g)){return true}}}return false},_calcConnectorVectorWeight:function(j){var p=0;var n=0;var m=function(i,q){var l=100;if(q==0){return l}else{return Math.min(l,Math.pow(i/q,2))}};var o=1;var k=1;for(var h=0,g=j.length;h<g;++h){p+=j[h].x*m(j[h].x,j[h].y)*o;n+=j[h].y*m(j[h].y,j[h].x)*k}return{x:p,y:n}},_calcConnectorVectorOfNode:function(k,m){var g={x:0,y:0};var n=this._getStandardizedLinkedObjRelCoords(k,m,null);for(var j=0,h=n.length;j<h;++j){g.x+=n[j].x;g.y+=n[j].y}if(g.x===g.y===0){g={x:1,y:0}}return g},_calcVectorAxisDirection:function(g){var i=Math.abs(g.x);var h=Math.abs(g.y);if(i>=h){return(g.x>0)?e.LTR:e.RTL}else{return(g.y>0)?e.TTB:e.BTT}},_decideNodeLabelCharDirection:function(h,j){var k=this._getStandardizedLinkedObjRelCoords(h,j,null);var g=Kekule.Render.TextDirection;var p=[g.LTR,g.RTL,g.TTB,g.BTT];var q;for(var n=0,m=p.length;n<m;++n){if(!this._isNodeHasConnectorToDirection(k,p[n])){return p[n]}}var o=this._calcConnectorVectorWeight(k);if(Math.abs(o.x)>Math.abs(o.y)){if(o.x<=0){q=g.LTR}else{q=g.RTL}}else{if(o.y<=0){q=g.TTB}else{q=g.BTT}}return q},_calcConnectorAnglesOfNode:function(k,m){var g=[];var p=this._getStandardizedLinkedObjRelCoords(k,m,null);for(var j=0,h=p.length;j<h;++j){var o=p[j];var n=Math.atan2(o.y,o.x);if(n<0){n=Math.PI*2+n}g.push(n)}g.sort();return g},_getMostEmptyDirectionAngleOfNode:function(j,k){var s;var p=this._calcConnectorAnglesOfNode(j,k);var m=p.length;if(m===0){s=0}else{if(m===1){s=-p[0]}else{var q=0;var o=0;for(var n=0;n<m;++n){var h=p[n];var g=p[(n+1)%m];var r=g-h;if(r<0){r+=Math.PI*2}if(r>q){q=r;o=n}}s=p[o]+q/2}}return s},doAutoAdjustAttachedMarkerPos:function(k,g,i,h,j){if(g&&!g.getCoordOfMode(this.getCoordMode())){k.autoSetMarker2DPos(g,i,h,j)}},doAdjustChemPropMarkerPos:function(k,p,g,o){k.beginUpdate();try{var n=k.getMarkerOfType(Kekule.ChemMarker.Charge);this.doAutoAdjustAttachedMarkerPos(k,n,p,g,o);var q=k.getMarkerOfType(Kekule.ChemMarker.Radical);this.doAutoAdjustAttachedMarkerPos(k,q,p,g,o);var j=k.getUnplacedMarkers(this.getCoordMode());for(var m=0,h=j.length;m<h;++m){this.doAutoAdjustAttachedMarkerPos(k,j[m],p,g,o)}}finally{k.endUpdate()}},doDrawElectronStateMark:function(k,r,z,w,H,J,o,C,F,n,E,m,h){var y=z.getCharge();var G=z.getRadical();var u="";if((!H)||(Math.abs(y)>Math.pow(10,-H)/2)){var p=w===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND;var g=(w===Kekule.Render.ChargeMarkRenderType.CIRCLE_AROUND);if(y===1){u=g?"\u2295":"+"}else{if(y===-1){u=g?"\u2296":"\u2212"}else{var B=H?Kekule.NumUtils.toDecimals(Math.abs(y),H):Math.abs(y).toString();u=B+((y>0)?"+":"\u2212")}}}if(G){u+=Kekule.Render.ChemDisplayTextUtils.getRadicalDisplayText(G,J)}if(!u){return null}var A=this.getTransformedCoord2D(k,z);var D=this._getMostEmptyDirectionAngleOfNode(k,z);var j={x:Math.cos(D),y:Math.sin(D)};var l=1;var q=F/l;var v={x:j.x*q,y:j.y*q};v=Kekule.CoordUtils.add(A,v);var i=Kekule.Render.BoxXAlignment;var s=Kekule.Render.BoxYAlignment;var t,x;t=i.CENTER;x=s.CENTER;var I=this.drawText(k,v,u,{fontFamily:o,fontSize:C,color:E,opacity:m,textBoxXAlignment:t,textBoxYAlignment:x,zoom:h||1});return I},doDrawConnectorShape:function(ab,h,N,D,X){var p=Kekule.CoordUtils;var B=N[0];var A=N[1];var o=this.getTransformedCoord2D(ab,B,X.allowCoordBorrow);var n=this.getTransformedCoord2D(ab,A,X.allowCoordBorrow);var Z={x:o.x,y:o.y};var Y={x:n.x,y:n.y};var N=[B,A];var q=[Z,Y];var ac=p.getDistance(Z,Y);var v=0;var E=D.unitLength||1;var T=Math.sqrt(Math.sqr(Y.x-Z.x)+Math.sqr(Y.y-Z.y));var t=[];var F=false,H;var C=D.bondLengthScaleRatio;if(Kekule.ObjUtils.notUnset(C)){var G=p.substract(Y,Z);F=true;H=(C>0)?0:1;var K=1-(Math.abs(C||1));var r=(H===1)?-1:1;t[H]=p.multiply(G,r*K)}if(this.getObjNeedDrawLabel(ab,B)||this.getObjNeedDrawLabel(ab,A)){var O=D.atomLabelBoxExpandRatio;var k,I;var L;var y=Y.x-Z.x;var Q=Y.y-Z.y;var s=(y>=0)?1:-1;var g=(Q>=0)?1:-1;var P=(y===0);if(!P){var aa=Math.abs(Q/y)}if(Math.abs(y)>=Math.abs(Q)){L=true}else{L=false}for(var V=0,S=N.length;V<S;++V){var J=N[V];var w=q[V];var W=null;if(this.getObjNeedDrawLabel(ab,J)){var m=this._getNodeFontSize(ab,J)*(X.zoom||1);k=I=m*E*O/2;if(L){W={x:k*s,y:k*aa*g}}else{if(!P){W={x:I/aa*s,y:I*g}}else{W={x:0,y:I*g}}}if(W){var j=t[V];if(j&&(Math.abs(C)<=1)){if(Math.abs(W.x)>Math.abs(j.x)||Math.abs(W.y)>Math.abs(j.y)){t[V]=W}}else{t[V]=W}}}s*=-1;g*=-1}}for(var V=0,S=q.length;V<S;++V){var w=q[V];var W=t[V];if(W){v+=p.getDistance(W,{x:0,y:0});var z=p.add(w,W);w.x=z.x;w.y=z.y}}if(v>=ac){return null}var M=(D.bondLineWidth||D.strokeWidth||1)*(D.unitLength||1);D.strokeWidth=M;var u=D.renderType;var R=Kekule.Render.ConnectorDrawUtils.getPossibleConnectorRenderTypes(h);if(Kekule.ObjUtils.isUnset(u)||(R.indexOf(u)<0)){u=R[0]}var x;if(this.isLineBasedConnector(u)){x=this.doDrawLineBasedConnector(ab,u,B,A,Z,Y,T,D)}else{if(this.isTriangleBasedConnector(u)){x=this.doDrawTriangleBasedConnector(ab,u,B,A,Z,Y,T,D)}else{if(this.isTriangleHashBasedConnector(u)){x=this.doDrawTriangleHashBasedConnector(ab,u,B,A,Z,Y,T,D)}else{if(this.isRectangleBasedConnector(u)){x=this.doDrawRectangleBasedConnector(ab,u,B,A,Z,Y,T,D)}else{if(this.isWavyBasedConnector(u)){x=this.doDrawWavyBasedConnector(ab,u,B,A,Z,Y,T,D)}}}}}return x},_lineBasedConnectorTypes:[b.SINGLE,b.DOUBLE,b.TRIPLE,b.QUAD,b.SCISSORS_DOUBLE,b.BOLD,b.BOLD_DOUBLE,b.BOLD_TRIPLE,b.DASHED,b.DASHED_DOUBLE,b.DASHED_TRIPLE,b.SOLID_DASH,b.BOLD_DASH,b.ARROWED],_triangleBasedConnectorTypes:[b.WEDGED_SOLID,b.WEDGED_SOLID_INV,b.WEDGED_HOLLOW,b.WEDGED_HOLLOW_INV],_triangleHashBasedConnectorTypes:[b.WEDGED_HASHED,b.WEDGED_HASHED_INV,b.HASHED],_rectangleBasedConnectorTypes:[b.WEDGED_SOLID_BOTH,b.WEDGED_HOLLOW_BOTH],isLineBasedConnector:function(g){return(this._lineBasedConnectorTypes.indexOf(g)>=0)},isTriangleBasedConnector:function(g){return(this._triangleBasedConnectorTypes.indexOf(g)>=0)},isTriangleHashBasedConnector:function(g){return(this._triangleHashBasedConnectorTypes.indexOf(g)>=0)},isRectangleBasedConnector:function(g){return(this._rectangleBasedConnectorTypes.indexOf(g)>=0)},isWavyBasedConnector:function(g){return g=b.WAVY},doDrawLineBasedConnector:function(j,h,t,s,p,o,g,u){var m=[];var l={isBold:false,isDash:false};var r={isBold:true,isDash:false};var k={isBold:false,isDash:true};switch(h){case b.DOUBLE:case b.SCISSORS_DOUBLE:for(var n=0;n<2;++n,m.push(l)){}break;case b.TRIPLE:for(var n=0;n<3;++n,m.push(l)){}break;case b.QUAD:for(var n=0;n<4;++n,m.push(l)){}break;case b.BOLD:m.push(r);break;case b.BOLD_DOUBLE:m.push(r);m.push(l);break;case b.BOLD_TRIPLE:m.push(r);for(var n=0;n<2;++n,m.push(l)){}break;case b.BOLD_QUAD:m.push(r);for(var n=0;n<3;++n,m.push(l)){}break;case b.DASHED:m.push(k);break;case b.DASHED_DOUBLE:for(var n=0;n<2;++n,m.push(k)){}break;case b.DASHED_TRIPLE:for(var n=0;n<3;++n,m.push(k)){}break;case b.SOLID_DASH:m.push(l);m.push(k);break;case b.BOLD_DASH:m.push(r);m.push(k);break;case b.ARROWED:l.isArrow=true;m.push(l);break;case b.SINGLE:default:m.push(l)}var q=h===b.SCISSORS_DOUBLE;return this.doDrawSymmetryLineConnector(j,t,s,p,o,g,m,q,u)},doDrawSymmetryLineConnector:function(Z,A,z,Y,X,Q,I,D,G){var o=I.length;var y=null,p=null;if(o===1){var L=G.strokeWidth;if(I[0].isBold){L*=G.boldBondLineWidthRatio}var l=null;if(I[0].isArrow){l={width:G.bondArrowWidth*G.unitLength,length:G.bondArrowLength*G.unitLength}}var x={strokeWidth:L,strokeColor:Kekule.Render.RenderOptionUtils.getColor(G),strokeDash:I[0].isDash,opacity:G.opacity};var p=this.drawArrowLine(Z,Y,X,l,x);var W=this.createLineBoundInfo(Y,X,L)}else{if(o>1){y=this.createDrawGroup(Z);var P=G.multipleBondSpacingAbs?G.multipleBondSpacingAbs:G.multipleBondSpacingRatio*Q;if(G.multipleBondMaxAbsSpacing){P=Math.min(P,G.multipleBondMaxAbsSpacing)}P*=G.unitLength;var O=X.x-Y.x;var T=X.y-Y.y;var k=Math.sqrt(Math.sqr(O)+Math.sqr(T));var S=T/k;var M=O/k;var j=0;var H=[];var N=1;if(!(o&1)){if(D){N=0}else{N=Kekule.ObjUtils.isUnset(I.bondAlign)?this._decideEvenBondAlign(Z,A,z):I.bondAlign}}for(var R=0;R<o;++R){if(Kekule.ObjUtils.notUnset(I[R].offsetAdjust)){H.push(I[R].offsetAdjust)}else{if((R===0)&&(N!==0)){H.push(0)}else{var r=(R&1)?1:-1;if(N!==0){var m=N*r*((R+1)>>1)}else{var m=((R>>1)*1+0.5)*r}H.push(m)}}}var n=P;if(n>V){V=n}if(n<J){J=n}var g={x:0,y:0};var aa={x:0,y:0};var V=0,J=0;var C=[];for(var R=0;R<o;++R){var v=Object.create(G);var s=n*S;var q=n*M;var F={x:Y.x-s*H[R],y:Y.y+q*H[R]};var B={x:X.x-s*H[R],y:X.y+q*H[R]};g=Kekule.CoordUtils.add(g,F);aa=Kekule.CoordUtils.add(aa,B);var l=null;if(I[R].isArrow){l={width:G.bondArrowWidth*G.unitLength,length:G.bondArrowLength*G.unitLength}}var L=G.strokeWidth;if(I[R].isBold){L*=G.boldBondLineWidthRatio}v.strokeColor=G.color;v.strokeDash=I[R].isDash;C.push({coord1:F,coord2:B,arrowParams:l,drawOptions:v});if(I[R].isBold){n=P+Math.floor(L/2)}else{n=P}}if(D){for(var R=0;R<o;++R){var K=C[R];var E=C[o-R-1];var p=this.drawArrowLine(Z,K.coord1,E.coord2,K.arrowParams,K.drawOptions);this.addToDrawGroup(p,y)}}else{for(var R=0;R<o;++R){var t=C[R];var p=this.drawArrowLine(Z,t.coord1,t.coord2,t.arrowParams,t.drawOptions);this.addToDrawGroup(p,y)}}g=Kekule.CoordUtils.divide(g,o);aa=Kekule.CoordUtils.divide(aa,o);var W=this.createLineBoundInfo(g,aa,V-J)}}var u={element:y||p,boundInfo:W};return u},_getStandardizedLinkedObjRelCoords:function(g,j,k){var s=[];var q=this.getTransformedCoord2D(g,j);var h=j.getLinkedExposedObjs();for(var o=0,m=h.length;o<m;++o){var n=h[o];if(n===k){continue}var p=this.getTransformedCoord2D(g,n);var r=Kekule.CoordUtils.substract(p,q);r=Kekule.CoordUtils.standardize(r);s.push(r)}return s},_decideEvenBondAlign:function(g,q,o){var h=Kekule.CoordUtils.substract(this.getTransformedCoord2D(g,o),this.getTransformedCoord2D(g,q));h=Kekule.CoordUtils.standardize(h);var r=this._getStandardizedLinkedObjRelCoords(g,q,o);var p=this._getStandardizedLinkedObjRelCoords(g,o,q);var n=0;var k={x:0,y:0};for(var m=0,j=r.length;m<j;++m){n+=this._calcSinglePointAlign(r[m],h);k.x+=r[m].x;k.y+=r[m].y}for(var m=0,j=p.length;m<j;++m){n+=this._calcSinglePointAlign(p[m],h);k.x+=p[m].x;k.y+=p[m].y}if(n!==0){return Math.sign(n)}else{return this._calcSinglePointAlign(k,h)}},_calcSinglePointAlign:function(l,h){var g;var i=0.0001;if(Math.abs(h.x)<i){if(Math.abs(l.x)<i){g=0}else{g=-Math.sign(l.x)*Math.sign(h.y)}return g}else{var k=h.y*l.x/h.x;var j=l.y-k;if(j>i){g=1}else{if(j<-i){g=-1}else{g=0}}g*=Math.sign(h.x);return g}},doDrawTriangleBasedConnector:function(i,h,t,s,o,n,g,v){var m=(h===b.WEDGED_SOLID)||(h===b.WEDGED_SOLID_INV);var q=(h===b.WEDGED_SOLID_INV)||(h===b.WEDGED_HOLLOW_INV);var k=q?[n,o]:[o,n];var r=v.bondWedgeWidth*v.unitLength;var p=this._calcTriangleBaselineCoords(k[0],k[1],r);var l=Object.create(v);l.strokeColor=v.color;l.fillColor=m?v.color:null;var j=this.drawTriangle(i,k[0],p[0],p[1],l);var u={element:j};u.boundInfo=this.createLineBoundInfo(k[0],k[1],r);return u},doDrawTriangleHashBasedConnector:function(j,D,h,g,m,k,B,o){var G=(D===b.WEDGED_HASHED_INV);var x=(D!==b.HASHED);var r=G?[k,m]:[m,k];var z=o.hashSpacing*o.unitLength;var E=o.bondWedgeWidth*o.unitLength;var y=(x)?o.bondWedgeHashMinWidth*o.unitLength:E;var I=E-y;var u=Kekule.CoordUtils.substract(r[1],r[0]);var w=Math.sqrt(Math.sqr(u.x)+Math.sqr(u.y));var p=Math.floor(w/z);var s=this.createDrawGroup(j);var n=Object.create(o);n.strokeColor=o.color;for(var C=0;C<p;++C){var A=z*C;var q=A/w;var t={x:u.x*q,y:u.y*q};t=Kekule.CoordUtils.add(t,r[0]);var H=this._calcTriangleBaselineCoords(r[0],t,I*q+y);var F=this.drawLine(j,H[0],H[1],n);this.addToDrawGroup(F,s)}var v={element:s};v.boundInfo=this.createLineBoundInfo(r[0],r[1],E);return v},_calcTriangleBaselineCoords:function(g,l,i){var j=Kekule.CoordUtils.substract(l,g);var k=Math.sqrt(Math.sqr(j.x)+Math.sqr(j.y));var m=j.y/k;var h=j.x/k;var n=i/2;var o=[];o.push({x:l.x+n*m,y:l.y-n*h});o.push({x:l.x-n*m,y:l.y+n*h});return o},doDrawRectangleBasedConnector:function(i,h,r,q,n,m,g,u){var l=(h===b.WEDGED_SOLID_BOTH);var p=u.bondWedgeWidth*u.unitLength;var o=this._calcRectangleCornerCoords(n,m,p);var k=Object.create(u);k.strokeColor=u.color;k.fillColor=l?u.color:null;var t=Kekule.Render.DrawPathUtils.makePath("M",[o[0].x,o[0].y],"L",[o[1].x,o[1].y],"L",[o[2].x,o[2].y],"L",[o[3].x,o[3].y],"Z");var j=this.drawPath(i,t,k);var s={element:j};s.boundInfo=this.createLineBoundInfo(n,m,p);return s},_calcRectangleCornerCoords:function(j,o,h){var i=Kekule.CoordUtils.substract(o,j);var k=Math.sqrt(Math.sqr(i.x)+Math.sqr(i.y));var l=i.y/k;var g=i.x/k;var m=h/2;var p=[];var n={x:m*l,y:m*g};p.push({x:j.x+n.x,y:j.y-n.y});p.push({x:j.x-n.x,y:j.y+n.y});p.push({x:o.x-n.x,y:o.y+n.y});p.push({x:o.x+n.x,y:o.y-n.y});return p},doDrawWavyBasedConnector:function(j,B,h,g,l,k,z,n){var I=Kekule.CoordUtils;var q=n.bondWavyRadius*n.unitLength;var x=I.getDistance(l,k);var o=Math.round(x/q);var D=I.divide(I.substract(k,l),o);var t=x/o;var v=[];var p;var w=l;var C=Math.atan2(D.y,D.x)+Math.PI;var H={x:t/1.5*Math.sin(C),y:-t/1.5*Math.cos(C)};var G=1;for(var A=0;A<o;++A){G=-G;p=w;w=I.add(p,D);var F=I.multiply(H,G);var s=I.add(p,F);var r=I.add(w,F);if(A===0){v.push("M");v.push([p.x,p.y])}v.push("C");v.push([s.x,s.y,r.x,r.y,w.x,w.y])}var y=Kekule.Render.DrawPathUtils.makePath.apply(Kekule.Render.DrawPathUtils,v);var m=Object.create(n);m.strokeColor=n.color;m.fillColor=null;var E=this.drawPath(j,y,m);var u={element:E};u.boundInfo=this.createLineBoundInfo(l,k,t);return u}});Kekule.Render.StructFragment2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.StructFragment2DRenderer",initialize:function($super,i,g,h){$super(i,g,h);this._concreteRenderer=null;this._concreteChemObj=null;this.initConcreteRenderer()},finalize:function($super){$super();if(this._concreteRenderer){this._concreteRenderer.finalize();this._concreteRenderer=null}},initConcreteRenderer:function(){var h=this.getChemObj();var g=this.getDrawBridge();if(this._isRendererMismatch(this._concreteRenderer,h)&&this._concreteRenderer){this._concreteRenderer.finalize();this._concreteRenderer=null;this._concreteChemObj=null}if(!this._concreteRenderer&&h){if(h.hasCtab()){this._concreteChemObj=h.getCtab();this._concreteRenderer=new Kekule.Render.ChemCtab2DRenderer(h.getCtab(),g,this)}else{if(h.hasFormula()){this._concreteChemObj=h.getFormula();this._concreteRenderer=new Kekule.Render.Formula2DRenderer(h.getFormula(),g,this)}}}return this._concreteRenderer},_isRendererMismatch:function(g,h){return(g&&!h)||((g instanceof Kekule.Render.ChemCtab2DRenderer)&&!h.hasCtab())||((g instanceof Kekule.Render.Formula2DRenderer)&&!h.hasFormula())},getConcreteRenderer:function(){this.initConcreteRenderer();return this._concreteRenderer},_getConcreteRendererDrawOptions:function(g){return g},isChemObjRenderedBySelf:function($super,h,j){var i=this.getConcreteRenderer();var g=$super(h,j)||(j===this.getChemObj())||(i&&i.isChemObjRenderedBySelf(h,j));return g},isChemObjRenderedDirectlyBySelf:function($super,g,i){var h=this.getConcreteRenderer();return $super(g,i)||(i===this.getChemObj())||(i===this._concreteChemObj)},doSetRedirectContext:function($super,h){$super(h);var g=this.getConcreteRenderer();if(g){g.setRedirectContext(h)}},getChildObjs:function($super){var n=this.getChemObj();if(n){var j=[];var k=(n.getExposedNodes()||[]).concat(n.getExposedConnectors()||[]);for(var h=0,g=k.length;h<g;++h){var m=k[h];if(m.getAttachedMarkers){j=j.concat(m.getAttachedMarkers()||[])}}return j.concat($super())}else{return $super()}},_needWholelyDraw:function($super,g,h){var p=$super(g,h);if(!p){var o=this.getChemObj();var j=false;for(var n=0,m=g.length;n<m;++n){var k=g[n];if(k.isChildOf(o)){j=true;break}}p=j}return p},_createChargeAndRadicalMarkerOnStructFragment:function(m){m.beginUpdate();try{if(m.getCharge&&m.getCharge()){m.fetchChargeMarker(true)}var h=m.getNodes();for(var j=0,g=m.getNodeCount();j<g;++j){var k=m.getNodeAt(j);k.beginUpdate();try{if(k.getCharge()){k.fetchChargeMarker(true)}if(k.getRadical()){k.fetchRadicalMarker(true)}if(k.getNodeAt){this._createChargeAndRadicalMarkerOnStructFragment(k)}}finally{k.endUpdate()}}}finally{m.endUpdate()}},doDraw:function($super,h,j,g){var k=!!g.autoCreateChargeAndRadicalMarker;if(this.getCanModifyTargetObj()&&k){var i=this.getChemObj();this._createChargeAndRadicalMarkerOnStructFragment(i)}$super(h,j,g)},doDrawSelf:function($super,h,k,g){$super(h,k,g);var m=this.getChemObj();var j=k;var i=this.getConcreteRenderer();if((!j)&&(i instanceof Kekule.Render.Formula2DRenderer)){if(m.getAbsBaseCoord2D){var l=m.getAbsBaseCoord2D(g.allowCoordBorrow);j=Kekule.CoordUtils.transform2D(l,g.transformParams)}}if(!m.hasFormula()&&!m.hasCtab()){return null}else{if(i){return i.draw(h,j,this._getConcreteRendererDrawOptions(g))}}},doRedraw:function($super,g){return $super(g)},doUpdateSelf:function(h,l,g){var k=this._extractObjsOfUpdateObjDetails(l);if(k.indexOf(this.getChemObj())>=0){var j=this.getRenderCache(h);this.doClear(h);return this.draw(h,j.baseCoord,j.options)}var i=this.getConcreteRenderer();if(i){return i.doUpdate(h,l,g)}},doClearSelf:function(g){var h=this.getConcreteRenderer();if(h){return h.clear(g)}},estimateRenderBox:function(i,k,h,g){var j=this.getConcreteRenderer();if(j){return j.estimateRenderBox(i,k,this._getConcreteRendererDrawOptions(h),g)}else{return null}},transformCoordToObj:function($super,g,i,h){return $super(g,i,h)},transformCoordToContext:function($super,g,i,h){return $super(g,i,h)}});Kekule.Render.Mol2DRenderer=Kekule.Render.StructFragment2DRenderer;Kekule.Render.CompositeObj2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeObj2DRenderer"});Kekule.Render.CompositeMolecule2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule2DRenderer",getChildObjs:function($super){var j=[];var k=this.getChemObj().getSubMolecules();for(var h=0,g=k.getItemCount();h<g;++h){var m=k.getObjAt(h);j.push(m)}return j.concat($super())}});Kekule.Render.ChemObjGroupList2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule2DRenderer",getChildObjs:function($super){var k=this.getChemObj();if(k instanceof Kekule.ChemObjList){var j=[];for(var h=0,g=k.getItemCount();h<g;++h){j.push(k.getItemAt(h))}}else{if(k instanceof Kekule.ChemStructureObjectGroup){j=k.getAllObjs()}}return(j||[]).concat($super())}});Kekule.Render.Reaction2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.Reaction2DRenderer",getChildObjs:function($super){var j=[];var k=this.getChemObj();var j=[];for(var h=0,g=k.getReactantCount();h<g;++h){var m=k.getReactantAt(h);j.push(m)}for(var h=0,g=k.getProductCount();h<g;++h){var m=k.getProductAt(h);j.push(m)}return(j||[]).concat($super())}});Kekule.Render.ChemSpaceElement2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpaceElement2DRenderer",getChildObjs:function($super){var g=$super()||[];var h=this.getChemObj();g=(h.getChildren().toArray()||[]).concat(g);return g}});Kekule.Render.ChemSpace2DRenderer=Class.create(Kekule.Render.CompositeObj2DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpace2DRenderer",getChildObjs:function($super){return[this.getChemObj().getRoot()].concat($super()||[])},doEstimateSelfObjBox:function($super,k,i,h){var j=this.getChemObj().getSize2D();if(j.x&&j.y&&i.useExplicitSpaceSize){var g={x1:0,y1:0,x2:j.x,y2:j.y};return g}else{return $super(k,i,h)}}});Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.Charge,Kekule.Render.TextBasedChemMarker2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.Radical,Kekule.Render.TextBasedChemMarker2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemMarker.UnbondedElectronSet,Kekule.Render.UnbondedElectronSetRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.TextBlock,Kekule.Render.TextBlock2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ImageBlock,Kekule.Render.ImageBlock2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.StructureFragment,Kekule.Render.StructFragment2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.CompositeMolecule,Kekule.Render.CompositeMolecule2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.Reaction,Kekule.Render.Reaction2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemObjList,Kekule.Render.ChemObjGroupList2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemStructureObjectGroup,Kekule.Render.ChemObjGroupList2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemSpaceElement,Kekule.Render.ChemSpaceElement2DRenderer);Kekule.Render.Renderer2DFactory.register(Kekule.ChemSpace,Kekule.Render.ChemSpace2DRenderer)})();(function(){var c=Kekule.Render.DrawPathUtils;var a=Kekule.CoordUtils;var e=Kekule.oneOf;var b=Kekule.Glyph.NodeType;var d=Kekule.Glyph.PathType;Kekule.Render.BaseGlyph2DRenderer=Class.create(Kekule.Render.ChemObj2DRenderer,{CLASS_NAME:"Kekule.Render.BaseGlyph2DRenderer",doDraw:function($super,g,i,f){var h=Object.create(f);h.strokeColor=f.strokeColor||f.glyphStrokeColor;h.fillColor=f.fillColor||f.glyphFillColor;h.strokeWidth=f.strokeWidth||f.glyphStrokeWidth;return $super(g,i,h)}});Kekule.Render.PathGlyphCtab2DRenderer=Class.create(Kekule.Render.Ctab2DRenderer,{CLASS_NAME:"Kekule.Render.PathGlyphCtab2DRenderer",extractGlyphDrawOptions:function(f){var g=f.unitLength||1;return{strokeColor:f.strokeColor||f.color||f.glyphStrokeColor,fillColor:f.fillColor||f.color||f.glyphFillColor,strokeWidth:(f.strokeWidth||f.glyphStrokeWidth)*g}},doDraw:function($super,g,h,f){return $super(g,h,f)},doDrawNode:function(f,m,h,i,n,g){var l;var k=this.getTransformedCoord2D(f,h,g.allowCoordBorrow);var j=h.getNodeType();if(!j||j===b.LOCATION||j===b.CONTROLLER){l=this.createPointBoundInfo(k)}if(l){this.basicDrawObjectUpdated(f,h,i,l,Kekule.Render.ObjectUpdateType.ADD)}},doDrawConnector:function($super,f,p,j,k,r,g){var s=$super(f,p,j,k,r,g);var q=j.getControlPoints&&j.getControlPoints();if(q){for(var m=0,h=q.length;m<h;++m){var o=this.getTransformedCoord2D(f,q[m],g.allowCoordBorrow);var n=this.createPointBoundInfo(o);this.basicDrawObjectUpdated(f,q[m],j,n,Kekule.Render.ObjectUpdateType.ADD)}}return s},doDrawConnectorShape:function(p,j,G,z,A){var y=Kekule.Glyph.ArrowSide;var m=G[0];var h=G[1];var s=a.clone(this.getTransformedCoord2D(p,m,A.allowCoordBorrow));var q=a.clone(this.getTransformedCoord2D(p,h,A.allowCoordBorrow));var w=this.extractGlyphDrawOptions(z);var g=j.getPathType();var B=j.getPathParams()||{};var M=this.getChemObj();var t=B.lineGap||0;var H=t?(B.lineCount||1):1;var u,x;var o=[];if(!!B.startArrowType&&B.startArrowWidth){var J=this._transformArrowLength(p,B.startArrowLength,B.startArrowWidth);u={arrowLength:J.arrowLength,arrowWidth:J.arrowWidth,arrowType:B.startArrowType,arrowSide:B.startArrowSide,drawOnCenter:(!B.startArrowSide||B.startArrowSide===y.BOTH)}}if(!!B.endArrowType&&B.endArrowWidth){var J=this._transformArrowLength(p,B.endArrowLength,B.endArrowWidth);var x={arrowLength:J.arrowLength,arrowWidth:J.arrowWidth,arrowType:B.endArrowType,arrowSide:B.endArrowSide,drawOnCenter:(!B.endArrowSide||B.endArrowSide===y.BOTH)}}var r=[];var v=[];var F={y:0,x:t};var L=a.substract(this.transformCoordToContext(p,M,{x:0,y:0}),this.transformCoordToContext(p,M,F));var n=a.getDistance(L,{x:0,y:0});if(g===d.LINE){var f=this._doDrawLineConnectorShape(p,M,j,s,q,H,n,u,x,w,z);r=f.drawnElems;o=f.arrowElems;v=f.boundInfos}else{if(g===d.ARC){var E=j.getControlPoints&&j.getControlPoints();var k=E&&E[0];if(k){var C=a.clone(this.getTransformedCoord2D(p,k,A.allowCoordBorrow));var f=this._doDrawArcConnectorShape(p,M,j,s,q,C,H,n,u,x,w,z);r=f.drawnElems;o=f.arrowElems;v=f.boundInfos}}}if(!v.length){v=null}if((H<=1)&&!o.length){return{element:r&&r[0],boundInfo:v&&v[0]}}else{var D=this.createDrawGroup(p);for(var K=0;K<H;++K){if(r[K]){this.addToDrawGroup(r[K],D)}}for(var K=0,I=o.length;K<I;++K){if(o[K]){this.addToDrawGroup(o[K],D)}}return{element:D,boundInfo:v}}},_doDrawLineConnectorShape:function(S,s,f,N,M,o,C,A,B,n,Q){var K=Kekule.Glyph.ArrowSide;var R=[];var u=[];var q=[];var L,J;var I=a.substract(M,N);var z=I.x;var H=I.y;var D=a.getDistance(N,M);var G=H/D;var y=z/D;var r=D;var g=(o-1)/2;var p=C;var v={y:p*y,x:p*G};var P=a.multiply(v,(o-1)/2);var x=a.multiply(v,(o-1)/2);var m=a.substract(N,x);var j=a.substract(M,x);for(var F=0;F<o;++F){L=null;J=null;if(F!==0){m=a.add(m,v);j=a.add(j,v)}if(A||B){var t=F-g;var k=p*Math.abs(t);if(A){if(A.drawOnCenter&&(!A.arrowSide||(A.arrowSide===K.SINGLE&&t<0)||(A.arrowSide===K.REVERSED&&t>0))){var O=(A.arrowType===Kekule.Glyph.ArrowType.OPEN)?A.arrowLength*k/(A.arrowWidth/2):A.arrowLength;var L=a.add(m,a.multiply(I,O/r))}if(A.drawOnCenter&&F===0){Kekule.ArrayUtils.pushUnique(q,this.doDrawArrowShape(S,f,M,N,A,n,true))}if(!A.drawOnCenter&&((A.arrowSide===K.SINGLE&&F===0)||(A.arrowSide===K.REVERSED&&F===o-1))){Kekule.ArrayUtils.pushUnique(q,this.doDrawArrowShape(S,f,j,m,A,n,true))}}if(B){if(B.drawOnCenter&&(!B.arrowSide||(B.arrowSide===K.SINGLE&&t<0)||(B.arrowSide===K.REVERSED&&t>0))){var O=(B.arrowType===Kekule.Glyph.ArrowType.OPEN)?B.arrowLength*k/(B.arrowWidth/2):B.arrowLength;var J=a.substract(j,a.multiply(I,O/r))}if(B.drawOnCenter&&F===0){Kekule.ArrayUtils.pushUnique(q,this.doDrawArrowShape(S,f,N,M,B,n))}if(!B.drawOnCenter&&((B.arrowSide===K.SINGLE&&F===0)||(B.arrowSide===K.REVERSED&&F===o-1))){Kekule.ArrayUtils.pushUnique(q,this.doDrawArrowShape(S,f,m,j,B,n))}}}var E=this.doDrawLineShape(S,f,L||m,J||j,n,Q);R.push(E.element);u.push(E.boundInfo)}return{drawnElems:R,boundInfos:u,arrowElems:q}},_doDrawArcConnectorShape:function(Y,y,g,R,Q,C,o,K,I,J,m,V){var X=[],D=[],s=[];var q=a.divide(a.add(C,R),2);var p=a.divide(a.add(Q,C),2);var B=-(R.x-C.x)/(R.y-C.y);var A=-(Q.x-C.x)/(Q.y-C.y);var t={x:(p.y-q.y-A*p.x+B*q.x)/(B-A),y:q.y+B*(p.y-q.y-A*p.x+A*q.x)/(B-A)};var L=a.getDistance(t,R);var w=a.substract(R,t);var v=a.substract(Q,t);var x=a.substract(C,t);var l=Kekule.GeometryUtils.standardizeAngle(Math.atan2(w.y,w.x));var P=Kekule.GeometryUtils.standardizeAngle(Math.atan2(v.y,v.x));var E=Kekule.GeometryUtils.standardizeAngle(Math.atan2(x.y,x.x));var Z=P-l;var W=E-l;var T=E-P;var H=Math.sign(W)*Math.sign(T);var j=Math.sign(Z);var z=(H*j)>0;var G,f;var n=L+K*o;var k=10/L;if(I){var S=l-(z?k:-k);G={x:Math.cos(S),y:Math.sin(S)}}if(J){var S=P+(z?k:-k);f={x:Math.cos(S),y:Math.sin(S)}}var h=(o-1)/2;var F=L-K*h;for(var O=0;O<o;++O){var N=F+O*K;if(I||J&&o<=1){if(I){if(O===0){var u=a.add(t,a.multiply(G,N));Kekule.ArrayUtils.pushUnique(s,this.doDrawArrowShape(Y,g,u,R,J,m,true))}}if(J){if(O===0){var u=a.add(t,a.multiply(f,N));Kekule.ArrayUtils.pushUnique(s,this.doDrawArrowShape(Y,g,u,Q,J,m,true))}}}var M=this.doDrawArcShape(Y,t,N,l,P,z,m);if(M.element){X.push(M.element)}if(M.boundInfo){D.push(M.boundInfo)}}return{drawnElems:X,boundInfos:D,arrowElems:s}},_transformArrowLength:function(h,i,f){var j={x:i||0,y:f||0};var g=Kekule.CoordUtils.substract(this.transformCoordToContext(h,this.getChemObj(),j),this.transformCoordToContext(h,this.getChemObj(),{x:0,y:0}));return{arrowLength:Math.abs(g.x),arrowWidth:Math.abs(g.y)}},doDrawArrowShape:function(i,g,k,j,p,n,h){var r=Kekule.Glyph.ArrowSide;var q=Kekule.Glyph.ArrowType;var C=a.substract(j,k);var l=a.getDistance(j,k);var m=C.y/l;var E=C.x/l;var w=p.arrowLength;var B=p.arrowWidth;var D=B/2;var o=a.substract(j,a.multiply(C,w/l));var A={x:D*m,y:-D*E};var v;var u;var s=Kekule.Render.DrawPathUtils;var y=[];if(!p.arrowSide||(!h&&p.arrowSide===r.SINGLE)||(h&&p.arrowSide===r.REVERSED)){v=a.add(o,A);y.push("M");y.push([v.x,v.y]);y.push("L");y.push([j.x,j.y])}else{y.push("M");y.push([j.x,j.y])}if(!p.arrowSide||(!h&&p.arrowSide===r.REVERSED)||(h&&p.arrowSide===r.SINGLE)){u=a.substract(o,A);y.push("L");y.push([u.x,u.y])}var z=false;if(p.arrowType===q.TRIANGLE){var t=(v&&u)?null:o;if(t){y.push("L");y.push([t.x,t.y])}y.push("Z");z=true}var x=s.makePath.apply(this,y);var f=Object.create(n);if(!z){f.fillColor="transparent"}return this.drawPath(i,x,f)},doDrawLineShape:function(i,f,l,k,m,g){var j=this.drawLine(i,l,k,m);var h=this.createLineBoundInfo(l,k,m.strokeWidth);return{element:j,boundInfo:h}},doDrawArcShape:function(f,k,m,n,g,i,o){var j=Object.create(o);j.fillColor=null;var h=this.drawArc(f,k,m,n,g,i,j);var l=this.createArcBoundInfo(k,m,n,g,i,j.strokeWidth);return{element:h,boundInfo:l}}});Kekule.Render.PathGlyph2DRenderer=Class.create(Kekule.Render.BaseGlyph2DRenderer,{CLASS_NAME:"Kekule.Render.PathGlyph2DRenderer",initialize:function($super,h,f,g){$super(h,f,g);this._concreteChemObj=h.getCtab();this._concreteRenderer=new Kekule.Render.PathGlyphCtab2DRenderer(h.getCtab(),f,this)},finalize:function($super){$super();if(this._concreteRenderer){this._concreteRenderer.finalize();this._concreteRenderer=null}},getRenderCache:function(f){return this._concreteRenderer.getRenderCache(f)},_getConcreteRendererDrawOptions:function(f){return f},isChemObjRenderedBySelf:function($super,g,h){var f=$super(g,h)||(h===this.getChemObj())||this._concreteRenderer.isChemObjRenderedBySelf(g,h);return f},isChemObjRenderedDirectlyBySelf:function($super,f,g){return $super(f,g)||(g===this.getChemObj())},doSetRedirectContext:function($super,f){$super(f);this._concreteRenderer.setRedirectContext(f)},doDraw:function($super,g,h,f){$super(g,h,f);var j=this.getChemObj();var i=Object.create(f);if(i.partialDrawObjs){i.partialDrawObjs=null}return this._concreteRenderer.draw(g,h,this._getConcreteRendererDrawOptions(i))},doRedraw:function(f){return this._concreteRenderer.redraw(f)},doUpdate:function(g,j,f){var i=this._extractObjsOfUpdateObjDetails(j);if(i.indexOf(this.getChemObj())>=0){var h=this.getRenderCache(g);this.doClear(g);return this.draw(g,h.baseCoord,h.options)}return this._concreteRenderer.doUpdate(g,j,f)},doClear:function(f){return this._concreteRenderer.clear(f)},estimateRenderBox:function(h,g,f){return this._concreteRenderer.estimateRenderBox(h,this._getConcreteRendererDrawOptions(g),f)},transformCoordToObj:function(f,i,h){var g=(this.getChemObj()===i)?this._concreteChemObj:i;return this._concreteRenderer.transformCoordToObj(f,g,h)},transformCoordToContext:function(f,i,h){var g=(this.getChemObj()===i)?this._concreteChemObj:i;return this._concreteRenderer.transformCoordToContext(f,g,h)}});Kekule.Render.Renderer2DFactory.register(Kekule.Glyph.PathGlyph,Kekule.Render.PathGlyph2DRenderer)})();"use strict";Kekule.Render.CanvasRendererBridge=Class.create({CLASS_NAME:"Kekule.Render.CanvasRendererBridge",DEF_DOUBLE_BUFFERED:false,SHADOW_CANVAS_FIELD:"__$shadow_canvas__",SHADOW_CONTEXT_FIELD:"__$shadow_context__",getShadowContext:function(a){return a[this.SHADOW_CONTEXT_FIELD]},getShadowCanvas:function(a){return a[this.SHADOW_CANVAS_FIELD]},getOperatingContext:function(a){return this.getShadowContext(a)||a},createContext:function(e,b,h,a,c){if(c===undefined){c=this.DEF_DOUBLE_BUFFERED}var g=e.ownerDocument;var d=document.createElement("canvas");if(a){d.id=a}e.appendChild(d);var i=d.getContext("2d");if(c){var f=document.createElement("canvas");f.style.position="absolute";f.style.display="none";e.appendChild(f);i[this.SHADOW_CANVAS_FIELD]=f;i[this.SHADOW_CONTEXT_FIELD]=f.getContext("2d")}this.setContextDimension(i,b,h);return i},releaseContext:function(b){var a=b.canvas;var d=this.getShadowCanvas(b);var c=a.parentNode;if(c){c.removeChild(a);if(d){c.removeChild(d)}}},getContextDimension:function(a){return{width:a.canvas.width,height:a.canvas.height}},setContextDimension:function(b,d,a){var c=this.getShadowCanvas(b);if(d){b.canvas.width=d;b.canvas.style.width=d+"px";if(c){c.width=d;c.style.width=d+"px"}}if(a){b.canvas.height=a;b.canvas.style.height=a+"px";if(c){c.height=a;c.style.height=a+"px"}}this.clearContext(b)},getContextElem:function(a){return a?a.canvas:null},setContextViewBox:function(d,a,f,c,e,b){},clearContext:function(a){var c=a.canvas;c.width=c.width;var b=this.getShadowCanvas(a);if(b){b.width=b.width}var d=a.__$clearColor__;if(d){a.save();try{var e=this.getContextDimension(a);this.drawRect(a,{x:0,y:0},{x:e.width,y:e.height},{fillColor:d,strokeColor:d})}finally{a.restore()}}},setClearColor:function(b,a){if(b){b.__$clearColor__=a}},renderContext:function(a){var b=this.getShadowCanvas(a);if(b){a.drawImage(b,0,0)}},transformContextCoordToScreen:function(a,b){return b},transformScreenCoordToContext:function(a,b){return b},canModifyGraphic:function(a){return false},_drawDashLine:function(c,h,g,f){if(f==undefined){f=5}c.moveTo(h.x,h.y);var e=g.x-h.x;var d=g.y-h.y;var i=Math.floor(Math.sqrt(e*e+d*d)/f);var l=e/i;var k=d/i;var a=0;var b=h.x;var j=h.y;while(a++<i){b+=l;j+=k;c[a%2==0?"moveTo":"lineTo"](b,j)}c[a%2==0?"moveTo":"lineTo"](g.x2,g.y)},drawLine:function(a,e,d,b){var c=this.getOperatingContext(a);c.beginPath();this.setDrawStyle(c,b);if(b.strokeDash&&(!this.isLineDashSupported(c))){this._drawDashLine(c,e,d,b.strokeDash)}else{c.moveTo(e.x,e.y);c.lineTo(d.x,d.y)}this.doneDraw(c,b)},drawTriangle:function(a,f,e,d,b){var c=this.getOperatingContext(a);c.beginPath();this.setDrawStyle(c,b);c.moveTo(f.x,f.y);c.lineTo(e.x,e.y);c.lineTo(d.x,d.y);c.closePath();this.doneDraw(c,b)},drawRect:function(a,e,d,b){var c=this.getOperatingContext(a);c.beginPath();this.setDrawStyle(c,b);c.rect(e.x,e.y,d.x-e.x,d.y-e.y);this.doneDraw(c,b)},drawRoundRect:function(b,e,d,a,c){return this.drawRect(b,e,d,c)},drawCircle:function(b,e,a,c){var d=this.getOperatingContext(b);d.beginPath();this.setDrawStyle(d,c);d.arc(e.x,e.y,a,0,2*Math.PI,false);this.doneDraw(d,c)},drawArc:function(b,h,a,f,c,g,d){var e=this.getOperatingContext(b);e.beginPath();this.setDrawStyle(e,d);e.arc(h.x,h.y,a,f,c,g);this.doneDraw(e,d)},_PATH_CMDS:["M","Z","L","C","Q"],_PATH_METHODS:["moveTo","closePath","lineTo","bezierCurveTo","quadraticCurveTo"],drawPath:function(k,m,n){var d=this.getOperatingContext(k);if(m.length<=0){return}d.beginPath();this.setDrawStyle(d,n);var b;for(var f=0,e=m.length;f<e;++f){b=[];var j=m[f];var h=j.method.toUpperCase();var g=this._PATH_CMDS.indexOf(h);var a;if(g>=0){var a=this._PATH_METHODS[g];b=j.params;d[a].apply(d,b)}}this.doneDraw(d,n)},drawImage:function(j,a,d,k,l,f,i){var b=this.getOperatingContext(j);var c=this.getContextElem(b);var e=c.ownerDocument;var h=e.createElement("img");h.src=a;var g=this;h.onload=function(){try{g.setDrawStyle(b,l);var m=j;if(i){m=i()}m=g.getOperatingContext(m);m.drawImage(h,d.x,d.y,k.x,k.y);if(f){f(true)}g.doneDraw(b,l)}catch(n){if(f){f(false)}throw n}};h.src=a},drawImageElem:function(a,f,e,d,b){var c=this.getOperatingContext(a);this.setDrawStyle(c,b);c.drawImage(f,e.x,e.y,d.x,d.y);this.doneDraw(c,b)},isLineDashSupported:function(a){if(Kekule.ObjUtils.isUnset(this.isLineDashSupported._cachedValue)){this.isLineDashSupported._cachedValue=(a.setLineDash&&(typeof(a.lineDashOffset)=="number"))}return this.isLineDashSupported._cachedValue},setDrawStyle:function(b,a){if(Kekule.ObjUtils.notUnset(a.strokeWidth)){b.lineWidth=a.strokeWidth}else{b.lineWidth=1}if(a.strokeColor){b.strokeStyle=a.strokeColor}b.lineCap=a.lineCap||"butt";b.lineJoin=a.lineJoin||"miter";if(this.isLineDashSupported(b)){if(a.strokeDash){var c=(a.strokeDash===true)?[5]:Kekule.ArrayUtils.isArray(a.strokeDash)?a.strokeDash:[a.strokeDash];b.setLineDash(c)}else{b.setLineDash([])}}if(a.fillColor){b.fillStyle=a.fillColor}else{b.fillStyle="transparent"}if(Kekule.ObjUtils.notUnset(a.opacity)){b.globalAlpha=a.opacity}else{b.globalAlpha=1}},doneDraw:function(b,a){b.stroke();if(a.fillColor){b.fill()}},getCanvasFontStyle:function(b){var a="";if(b.fontStyle){a+=b.fontStyle+" "}if(b.fontWeight){a+=b.fontWeight+" "}if(b.fontSize){if(typeof(b.fontSize)==="string"){a+=b.fontSize+" "}else{a+=b.fontSize+"px "}}if(b.fontFamily){a+=b.fontFamily+" "}return a},drawText:function(a,h,g,b){var c=this.getOperatingContext(a);var d=c.font;var f=c.fillStyle;var e=this.getCanvasFontStyle(b);this.setDrawStyle(c,b);c.font=e;if(b.color){c.fillStyle=b.color}c.textBaseline="top";c.fillText(g,h.x,h.y);c.fontStyle=d;c.fillStyle=f},canMeasureText:function(a){return true},measureText:function(d,g,c){var f=this.getCanvasFontStyle(c);d.font=f;var b=d.measureText(g);var e=c.fontSize;if(typeof(e)==="string"){e=Kekule.StyleUtils.analysisUnitsValue(e).value}var a={width:b.width,height:e};return a},canMeasureDrawnText:function(a){return false},canModifyText:function(a){return false},createGroup:function(a){},addToGroup:function(a,b){},removeFromGroup:function(a,b){},exportToDataUri:function(c,a,b){var d=this.getContextElem(c);return d?d.toDataURL(a,b):null}});Kekule.Render.CanvasRendererBridge.isSupported=function(){var a=false;if(document&&document.createElement){a=!!document.createElement("canvas").getContext}return a};Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.CanvasRendererBridge,20);if(this.Raphael){Raphael.fn.line=function(b,d,a,c){return this.path("M"+b+" "+d+" L"+a+" "+c)};Raphael.fn.arrowLine=function(c,h,a,g,j){if(!j){return this.line(c,h,a,g)}var n=this.set();var m=a-c;var k=g-h;var f=Math.atan(k/m);var b=(j.width||6)/2;var d=j.length||3;var i=Math.atan(b/d);var e=Math.sqrt(Math.sqr(b)+Math.sqr(d));n.push(this.path("M"+a+" "+g+" L"+(a-e*Math.cos(f-i))+" "+(g-e*Math.sin(f-i))+" M"+a+" "+g+" L"+(a-e*Math.cos(f+i))+" "+(g-e*Math.sin(f+i))),this.path("M"+c+" "+h+" L"+a+" "+g));return n};Raphael.fn.triangle=function(d,f,b,e,a,c){return this.path("M"+d+" "+f+" L"+b+" "+e+" L"+a+" "+c+" L"+d+" "+f)};Raphael.fn.polygon=function(d){var c="M"+d[0].x+" "+d[0].y;for(var b=1,a=d.length;b<a;++b){c+=" L"+d[b].x+" "+d[b].y}c+="L"+d[0].x+" "+d[0].y;return this.path(c)};Raphael.el.translateCoord=function(b){if(this.forEach){this.forEach(function(c){c.translateCoord(b)})}else{var a=this.attr(["x","y"]);if((typeof(a.x)!="undefined")&&(typeof(a.y)!="undefined")){this.attr({x:a.x+b.x,y:a.y+b.y})}}return this};Raphael.st.translateCoord=function(a){if(this.forEach){this.forEach(function(b){b.translateCoord(a)})}return this};Raphael.st.remove=function(a){this.forEach(function(b){b.remove()},this);this.clear()}}Kekule.Render.RaphaelRendererBridge=Class.create({CLASS_NAME:"Kekule.Render.RaphaelRendererBridge",createContext:function(b,c,a){return Raphael(b,c,a)},releaseContext:function(a){a.remove()},getContextDimension:function(a){return{width:a.width,height:a.height}},setContextDimension:function(b,c,a){b.setSize(c,a);this.clearContext(b)},clearContext:function(a){a.clear();var b=a.__$clearColor__;if(b){var c=this.getContextDimension(a);this.drawRect(a,{x:0,y:0},{x:c.width,y:c.height},{fillColor:b,strokeColor:b})}},setClearColor:function(b,a){if(b){b.__$clearColor__=a}},getContextElem:function(a){return a?a.canvas:null},transformContextCoordToScreen:function(a,b){return b},transformScreenCoordToContext:function(a,b){return b},canModifyGraphic:function(a){return true},drawPath:function(a,m,n){var d="";for(var f=0,b=m.length;f<b;++f){var g=m[f];d+=g.method;if(g.params&&g.params.length){for(var e=0,c=g.params.length;e<c;++e){d+=(e===0)?"":",";if(DataType.isArrayValue(g.params[e])){d+=g.params[e].join(",")}else{d+=g.params[e]}}}}var h=a.path(d);this.setBasicElemAttribs(h,n);return h},drawLine:function(c,e,d,b){var a=c.line(e.x,e.y,d.x,d.y);this.setBasicElemAttribs(a,b);return a},drawTriangle:function(c,f,e,d,b){var a=c.triangle(f.x,f.y,e.x,e.y,d.x,d.y);this.setBasicElemAttribs(a,b);return a},drawRect:function(c,e,d,b){var a=c.rect(e.x,e.y,d.x-e.x,d.y-e.y);this.setBasicElemAttribs(a,b);return a},drawRoundRect:function(d,f,e,b,c){var a=d.rect(f.x,f.y,e.x-f.x,e.y-f.y,b);this.setBasicElemAttribs(a,c);return a},drawCircle:function(d,e,b,c){var a=d.circle(e.x,e.y,b);this.setBasicElemAttribs(a,c);return a},drawArc:function(b,n,g,o,m,a,e){var l=Kekule.GeometryUtils.polarToCartesian;var q=Kekule.GeometryUtils.standardizeAngle;var t=Kekule.CoordUtils;var h=l(n.x,n.y,g,m);var f=l(n.x,n.y,g,o);var j=q(o,0);var s=q(m,0);var u=s-j;var r=((q(u)<=Math.PI)&&!a)||((q(u)>Math.PI)&&a);var i=r?"0":"1";var c=a?"1":"0";var p=["M",h.x,h.y,"A",g,g,0,i,c,f.x,f.y].join(" ");var k=b.path(p);this.setBasicElemAttribs(k,e);return k},drawImage:function(d,h,f,c,b,i){try{var a=d.image(h,f.x,f.y,c.x,c.y);this.setBasicElemAttribs(a,b);if(i){i(true)}}catch(g){if(i){i(false)}throw g}return a},drawImageElem:function(c,e,d,b,a){return this.drawImage(c,e.src,d,b,a)},setBasicElemAttribs:function(b,a){if(Kekule.ObjUtils.notUnset(a.strokeWidth)){b.attr("stroke-width",a.strokeWidth)}if(a.strokeColor){b.attr("stroke",a.strokeColor)}if(a.strokeDash){var c="- ";b.attr("stroke-dasharray",c)}if(a.fillColor){b.attr("fill",a.fillColor)}if(a.opacity){b.attr({"stroke-opacity":a.opacity,"fill-opacity":a.opacity})}if(a.lineCap){b.attr("stroke-linecap",a.linecap)}if(a.lineJoin){b.attr("stroke-linejoin",a.linejoin)}},getRaphaelFontStyle:function(b){var a={};if(b.fontStyle){a["font-style"]=b.fontStyle}if(b.fontWeight){a["font-weight"]=b.fontWeight}if(b.fontSize){a["font-size"]=b.fontSize+"px"}if(b.fontFamily){a["font-family"]=b.fontFamily}return a},drawText:function(b,f,e,a){if(e.endsWith(" ")){e=e.substring(0,e.length-1)+"\u00A0"}if(e.startsWith(" ")){e="\u00A0"+e.substr(1)}var d=this.getRaphaelFontStyle(a);var c=b.text(-10000,-10000,e);c.attr(d);if(a.color){c.attr({stroke:a.color,fill:a.color})}this.modifyDrawnTextCoord(b,c,f);this.setBasicElemAttribs(c,a);return c},canMeasureText:function(a){return false},canMeasureDrawnText:function(a){return true},canModifyText:function(a){return true},measureDrawnText:function(c,f,b){var e=Kekule.oneOf;var d=f.getBBox();var a={};a.width=e(d.width,(d.x2-d.x1));a.height=e(d.height,(d.y2-d.y1));return a},modifyDrawnTextCoord:function(b,d,a){var c=this.measureDrawnText(b,d,null);d.attr({x:a.x+c.width/2,y:a.y+c.height/2})},createGroup:function(a){return a.set()},addToGroup:function(a,b){return b.push(a)},removeFromGroup:function(a,b){if(a!==b){return b.exclude(a)}else{return false}},removeDrawnElem:function(a,b){b.remove()},exportToDataUri:function(d,b,c){if(d.toSVG){var a=d.toSVG();return"data:image/svg+xml;base64,"+btoa(a)}else{if(d.canvas&&(d.canvas.tagName.toLowerCase()==="svg")){var a=XmlUtility.serializeNode(d.canvas);return"data:image/svg+xml;base64,"+btoa(a)}}}});Kekule.Render.RaphaelRendererBridge.isSupported=function(){var a=false;if(Kekule.$jsRoot.Raphael){a=!!(Raphael.svg||Raphael.vml)}return a};Kekule.Render.DrawBridge2DMananger.register(Kekule.Render.RaphaelRendererBridge,10);(function(){var f=Kekule.ObjUtils;var c=Kekule.BoxUtils;var d=Kekule.Render.Molecule3DDisplayType;var h=Kekule.Render.Bond3DRenderMode;var b=Kekule.Render.Bond3DRenderType;var a=Kekule.Render.Bond3DSpliceMode;var e=Kekule.Render.Node3DRenderMode;var g=Kekule.oneOf;Kekule.Render.Abstract3DDrawBridge=Class.create({CLASS_NAME:"Kekule.Render.Abstract3DDrawBridge",getGraphicQualityLevel:function(){return null},setGraphicQualityLevel:function(i){},transformContextCoordToScreen:function(i,j){return{x:j.x,y:j.y}},canModifyGraphic:function(i){return false},createContext:function(j,k,i){return null},getContextDimension:function(i){return{}},setContextDimension:function(j,k,i){return null},clearContext:function(i){return null},setClearColor:function(j,i){},drawSphere:function(k,l,i,j){},drawCylinder:function(k,m,l,i,j){},drawLine:function(j,l,k,i){},createDrawGroup:function(i){},addToDrawGroup:function(i,j){},removeFromDrawGroup:function(i,j){},getCameraProps:function(i){},setCameraProps:function(i,j){},exportToDataUri:function(k,i,j){}});Kekule.Render.Base3DRenderer=Class.create(Kekule.Render.CompositeRenderer,{CLASS_NAME:"Kekule.Render.Base3DRenderer",initialize:function($super,k,i,j){$super(k,i,j)},getRendererType:function(){return Kekule.Render.RendererType.R3D},getActualTargetContext:function(i){return this.getRedirectContext()||i},getCameraProps:function(i){return this.getDrawBridge().getCameraProps(i)},setCameraProps:function(i,j){return this.getDrawBridge().setCameraProps(i,j)},getInitialLightPositions:function(i){return this.getDrawBridge().getInitialLightPositions&&this.getDrawBridge().getInitialLightPositions(i)},getLightCount:function(i){return this.getDrawBridge().getLightCount&&this.getDrawBridge().getLightCount(i)},getLightProps:function(j,i){return this.getDrawBridge().getLightProps&&this.getDrawBridge().getLightProps(j,i)},setLightProps:function(j,i,k){return this.getDrawBridge().setLightProps(j,i,k)},drawSphere:function(k,l,i,j){return this.getDrawBridge().drawSphere(this.getActualTargetContext(k),l,i,j)},drawCylinder:function(l,n,m,j,k){var i=this.getDrawBridge();return i?i.drawCylinder(this.getActualTargetContext(l),n,m,j,k):null},drawCylinderEx:function(m,p,o,j,k){var i=null;var n=this.drawCylinder(m,p,o,j,k);if(n&&k.withEndCaps){i=this.createDrawGroup(m);var l=this.drawSphere(m,p,j);this.addToDrawGroup(l,i);var l=this.drawSphere(m,o,j);this.addToDrawGroup(l,i)}return i||n},drawParallelCylinders:function(j,q,m){var r=this.getDrawBridge();if(r.drawParallelCylinders){return r.drawParallelCylinders(this.getActualTargetContext(j),q,m)}else{var s=this.createDrawGroup(j);for(var p=0,n=q.length;p<n;++p){var k=q[p];var o=this.drawCylinderEx(j,k.coord1,k.coord2,k.radius,{color:k.color,withEndCaps:m});if(o){this.addToDrawGroup(o,s)}}return s}},drawLine:function(k,m,l,j){var i=this.getDrawBridge();return i?i.drawLine(this.getActualTargetContext(k),m,l,j):null},drawParallelLines:function(j,k){var r=this.getDrawBridge();if(r.drawParallelLines){return r.drawParallelLines(this.getActualTargetContext(j),k,drawEndCaps)}else{if(r.drawLine){var q=k.length;var t=[];for(var p=0;p<q;++p){var m=k[p];var n=this.drawLine(j,m.coord1,m.coord2,{lineWidth:m.lineWidth,color:m.color,opacity:m.opacity});if(n){t.push(n)}}var s;if(t.length<=1){s=t[0]}else{s=this.createDrawGroup(j);for(var p=0,o=t.length;p<o;++p){this.addToDrawGroup(t[p],s)}}return s}}},createDrawGroup:function(i){return this.getDrawBridge().createGroup(this.getActualTargetContext(i))},addToDrawGroup:function(i,j){return this.getDrawBridge().addToGroup(i,j)},removeFromDrawGroup:function(i,j){return this.getDrawBridge().removeFromGroup(i,j)},removeDrawnElem:function(i,j){}});Kekule.Render.ChemObj3DRenderer=Class.create(Kekule.Render.Base3DRenderer,{CLASS_NAME:"Kekule.Render.ChemObj3DRenderer",initialize:function($super,k,i,j){$super(k,i,j);this._enableTransformByCamera=true},doEstimateSelfObjBox:function(k,j,i){return Kekule.Render.ObjUtils.getContainerBox(this.getChemObj(),this.getCoordMode(),i)},doEstimateRenderBox:function(k,l,j,i){var n=this.estimateObjBox(k,j,i);if(n){var m=this.prepareTransformParams(k,l,j,n);var o=m;return c.transform3D(n,o)}else{return null}},beginDraw:function($super,k,l,j){$super(k,l,j);if(this.isRootRenderer()){var i=this.getDrawBridge();if(i&&i.setGraphicQualityLevel){var m=j.graphicQuality;i.setGraphicQualityLevel(m)}}},endDraw:function($super,j,k,i){if(this.isRootRenderer()){this.adjustCamera(j,i.transformParams)}$super(j,k,i)},doDraw:function($super,k,l,j){this.prepareTransformParams(k,l,j);var i=$super(k,l,j);return i},changeGeometryOptions:function(i,k,m){var j=Object.create(m);var l=this.prepareTransformParams(i,k,j);if(l.pureCameraTransform){this.endDraw(i,k,j)}else{this.getDrawBridge().clearContext(i);this.draw(i,k,m)}},prepareTransformParams:function(k,l,o,q){var i;if(o.transformParams){i=o.transformParams}else{var n=this.generateTransformParams(k,l,o,q);o.transformParams=n;i=n}var j=Kekule.CoordUtils.calcTransform3DMatrix(i);var m=Kekule.CoordUtils.calcInverseTransform3DMatrix(i);o.transformParams.transformMatrix=j;o.transformParams.invTransformMtrix=m;this.getRenderCache(k).transformParams=i;this.getRenderCache(k).transformMatrix=j;this.getRenderCache(k).invTransformMatrix=m;this.getRenderCache(k).transformParams=i;return i},canDoPureCameraTransform:function(i,k){var j=this._enableTransformByCamera&&(k.scaleX===k.scaleY)&&(k.scaleY===k.scaleZ)&&(!k.rotateAngle)&&(!k.rotateX)&&(!k.rotateY)&&(!k.rotateZ);return j},generateTransformParams:function(n,Q,p,D){var y={};y.allowCoordBorrow=g(p.allowCoordBorrow,false);y.unitLength=p.unitLength||1;if(!D){D=this.estimateObjBox(n,p,y.allowCoordBorrow)}var G={x:(D.x1+D.x2)/2,y:(D.y1+D.y2)/2,z:(D.z1+D.z2)/2};var t=Kekule.ObjUtils;if(t.isUnset(p.translateX)&&t.isUnset(p.translateY)&&t.isUnset(p.translateZ)){if(Q){y.translateX=Q.x-G.x;y.translateY=Q.y-G.y;y.translateZ=Q.z||0-G.z||0}}else{y.translateX=p.translateX||0;y.translateY=p.translateY||0;y.translateZ=p.translateZ||0}y.zoom=p.zoom||1;y.scaleX=g(p.scaleX,p.scale,1);y.scaleY=g(p.scaleY,p.scale,1);y.scaleZ=g(p.scaleZ,p.scale,1);var P=!(p.scaleX||p.scaleY||p.scaleZ||p.scale);if(f.notUnset(p.rotateMatrix)){y.rotateMatrix=p.rotateMatrix}else{if(f.notUnset(p.rotateAngle)&&f.notUnset(p.rotateAxisVector)){y.rotateMatrix=Kekule.CoordUtils.calcRotate3DMatrix({rotateAngle:p.rotateAngle,rotateAxisVector:p.rotateAxisVector})}else{if(y.rotateX||y.rotateY||y.rotateZ){y.rotateMatrix=Kekule.CoordUtils.calcRotate3DMatrix({rotateX:p.rotateX||0,rotateY:p.rotateY||0,rotateZ:p.rotateZ||0})}}}if(t.isUnset(p.center)){y.center=G}if(Q){y.drawBaseCoord=Q}else{y.drawBaseCoord=Kekule.CoordUtils.transform3D(G,y)}var u=Object.extend({},y);y=this.getFinalTransformParams(n,y);y.initialTransformOptions=u;var A=this.canDoPureCameraTransform(n,y);y.pureCameraTransform=A;if(this.isRootRenderer()){if(p.autofit||(!p.cameraPos)){var I=this.getAutofitObjBoxInflation(n,this.getChemObj(),p);var R=Kekule.BoxUtils.inflateBox(D,I.x,I.y,I.z);var z=Math.max(R.x2-R.x1,R.y2-R.y1);var S=this.getCameraProps(n);var H=z/2/Math.tan(S.fov/2);var E=Math.sqrt(Math.sqr(H)-Math.sqr(z/2));if(A){E=E/y.scaleX;y.cameraWidth=z/y.scaleX;y.cameraHeight=y.cameraWidth;var L=Kekule.MatrixUtils.create(4,1,[0,0,1,1]);var N=Kekule.MatrixUtils.create(4,1,[0,1,1,1]);var F,C;var K,o;if(y.rotateMatrix){var x=Kekule.MatrixUtils.transpose(y.rotateMatrix);F=Kekule.MatrixUtils.multiply(x,L);K=Kekule.MatrixUtils.multiply(x,N);C={x:F[0],y:F[1],z:F[2]};o={x:K[0],y:K[1],z:K[2]}}else{C={x:0,y:0,z:1};o={x:0,y:1,z:1}}C=Kekule.CoordUtils.multiply(C,E);y.cameraPos={x:C.x,y:C.y,z:C.z};y.cameraPos=Kekule.CoordUtils.add(y.cameraPos,y.drawBaseCoord);y.cameraUp=o;y.scaleX=y.scaleY=y.scaleZ=1;var M=this.getInitialLightPositions(n);if(x){var q=this.getLightCount(n);if(M&&M.length&&q){var s=Math.min(M.length,q);var k=[];for(var J=0;J<s;++J){var r=M[J];if(r){var j=Kekule.MatrixUtils.create(4,1,[r.x,r.y,r.z,1]);var v=Kekule.MatrixUtils.multiply(x,j);var m={x:v[0],y:v[1],z:v[2]};k.push(m)}}}}y.lightPositions=k||M;y.rotateMatrix=null}else{y.cameraPos={x:y.drawBaseCoord.x,y:y.drawBaseCoord.y,z:E+y.drawBaseCoord.z};y.cameraUp={x:0,y:1,z:1}}y.cameraLookAtVector=y.drawBaseCoord||{x:0,y:0,z:0};var B={x:-y.translateX,y:-y.translateY,z:-y.translateZ};y.translateX=y.translateY=y.translateZ=0;y.cameraPos=Kekule.CoordUtils.add(y.cameraPos,B);y.cameraLookAtVector=Kekule.CoordUtils.add(y.cameraLookAtVector,B)}}return y},getFinalTransformParams:function(j,k){var i=Object.create(k);if(i.zoom){i.scaleX*=i.zoom;i.scaleY*=i.zoom;i.scaleZ*=i.zoom}if(i.unitLength!==1){i.translateX*=i.unitLength;i.translateY*=i.unitLength;i.translateZ*=i.unitLength;if(i.drawBaseCoord){i.drawBaseCoord=Kekule.CoordUtils.multiply(i.drawBaseCoord,i.unitLength)}}return i},getRenderFinalTransformParams:function(i){return this.getRenderCache(i).transformParams},getRenderInitialTransformOptions:function(i){var j=this.getRenderFinalTransformParams(i);return j?j.initialTransformOptions:null},getAutofitObjBoxInflation:function(i,l,k){var j=k.fixedNodeRadius||0;return{x:j,y:j,z:j}},adjustCamera:function(m,o){var j=o.cameraWidth;var n=o.cameraHeight;var k={position:o.cameraPos,upVector:o.cameraUp,lookAtVector:o.cameraLookAtVector};if(j&&n){var i=j/2;var l=n/2;k.left=-i;k.right=i;k.top=l;k.bottom=-l}this.setCameraProps(m,k);this.adjustLights(m,o)},adjustLights:function(n,p){var k=p.lightPositions||[];for(var m=0,j=k.length;m<j;++m){var o=k[m];if(o){this.setLightProps(n,m,{position:o})}}}});Kekule.Render.ChemCtab3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemCtab3DRenderer",TRANSFORM_COORD_FIELD:"__$transCoord3D__",DRAW_ELEM_FIELD:"__$drawElem__",DRAW_COLOR_FIELD:"__$drawColor__",BASE_RADIUS_FIELD:"__$baseRadius__",TRANSFORM_MATRIX_FIELD:"__$transMatrix__",INV_TRANSFORM_MATRIX_FIELD:"__$inverseTransMatrix__",CHILD_TRANSFORM_MATRIX_FIELD:"__$childTransMatrix__",HIDDEN_NODES_FIELD:"__$hiddenNodes__",HIDDEN_CONNECTORS_FIELD:"__$hiddenConnectors__",getObjDrawElem:function(i,j){return this.getExtraProp2(i,j,this.DRAW_ELEM_FIELD)},setObjDrawElem:function(i,k,j){this.setExtraProp2(i,k,this.DRAW_ELEM_FIELD,j)},getObjDrawColor:function(i,j){return this.getExtraProp2(i,j,this.DRAW_COLOR_FIELD)},setObjDrawColor:function(i,k,j){this.setExtraProp2(i,k,this.DRAW_COLOR_FIELD,j)},getNodeBaseRadius:function(i,j){return this.getExtraProp2(i,j,this.BASE_RADIUS_FIELD)},setNodeBaseRadius:function(i,k,j){this.setExtraProp2(i,k,this.BASE_RADIUS_FIELD,j)},getHiddenNodes:function(i){return this.getExtraProp(i,this.HIDDEN_NODES_FIELD)||[]},setHiddenNodes:function(i,j){return this.setExtraProp(i,this.HIDDEN_NODES_FIELD,j)},getHiddenConnectors:function(i){return this.getExtraProp(i,this.HIDDEN_CONNECTORS_FIELD)||[]},setHiddenConnectors:function(i,j){return this.setExtraProp(i,this.HIDDEN_CONNECTORS_FIELD,j)},doEstimateSelfObjBox:function(k,j,i){var l=this.getChemObj().getExposedContainerBox3D(i);return l},doPrepare:function(j,q,p,r){var n=r;var o=this.getRenderCache(j);var l,m;switch(n.moleculeDisplayType){case d.WIRE:l=e.NONE;m=n.displayMultipleBond?h.MULTI_WIRE:h.WIRE;break;case d.STICKS:l=e.NONE;m=n.displayMultipleBond?h.MULTI_CYLINDER:h.CYLINDER;break;case d.SPACE_FILL:l=e.SPACE;m=h.NONE;break;case d.BALL_STICK:default:l=e.BALL;m=n.displayMultipleBond?h.MULTI_CYLINDER:h.CYLINDER;break}o.nodeRenderMode=l;o.connectorRenderMode=m;o.options=n;var i=q.getExposedNodes();var k=q.getExposedConnectors();this.prepareHiddenObjects(j,i,k,n);this.prepareNodesDrawColor(j,i,n);this.prepareNodeBaseRadii(j,i,n);return n},prepareHiddenObjects:function(k,j,o,m){var u=[];this.setHiddenNodes(k,u);for(var t=0,r=j.length;t<r;++t){var p=j[t];if(m.hideHydrogens&&(p instanceof Kekule.Atom)&&(p.getAtomicNumber()===1)){u.push(p)}}var v=[];this.setHiddenConnectors(k,v);for(var t=0,r=o.length;t<r;++t){var q=o[t];var s=q.getConnectedExposedObjs();var n=Kekule.ArrayUtils.exclude(s,u);if(n<2){v.push(q)}}},prepareNodesDrawColor:function(m,k,n){var j=n.useAtomSpecifiedColor;for(var s=0,p=k.length;s<p;++s){var o=k[s];var r=o.getOverriddenRender3DOptions()||{};var q=r.color||r.atomColor;if(q&&(!r.useAtomSpecifiedColor)){}else{if(j||r.useAtomSpecifiedColor){var t=o.getAtomicNumber?o.getAtomicNumber():0;if(t>=0){q=Kekule.Render.RenderColorUtils.getColor(t,this.getRendererType())}else{q=Kekule.Render.RenderColorUtils.getColor(o.getClassLocalName(),this.getRendererType())}}else{q=g(r.color||n.atomColor)}}this.setObjDrawColor(m,o,q)}},prepareNodeBaseRadii:function(p,n,m){for(var o=0,k=n.length;o<k;++o){var j;var q=n[o];j=this.calcNodeBaseRadius(q,m);this.setNodeBaseRadius(p,q,j)}},calcNodeBaseRadius:function(l,j){var m=l.getOverriddenRender3DOptions()||{};var i=l.getAtomicNumber?l.getAtomicNumber():null;if(m.nodeRadius||j.nodeRadius){radius=m.nodeRadius||j.nodeRadius}else{if(g(m.useVdWRadius,j.useVdWRadius)&&i){var k=Kekule.ChemicalElementsDataUtil.getElementProp(i,"radiiVdw")||m.fixedNodeRadius||j.fixedNodeRadius;radius=k}else{radius=g(m.fixedNodeRadius,j.fixedNodeRadius)}}return radius},doDrawSelf:function($super,j,l,i){$super(j,l,i);var n=this.getChemObj();var k=i.transformParams;this.getRenderCache(j).transformOptions=k;this.transformCtabCoords3DToContext(j,n,k);var m=this.doPrepare(j,n,l,i);return this.doDrawCore(j,n,m,k)},doRedraw:function(i){var j=this.getRenderCache(i);return this.doDrawCore(i,this.getChemObj(),j.options,j.transformOptions)},doDrawCore:function(j,m,i,k){var l=this.createDrawGroup(j);this.doDrawConnectors(j,l,m,i,k);this.doDrawNodes(j,l,m,i,k);this.setObjDrawElem(j,m,l);return l},transformCtabCoords3DToContext:function(j,s,p){var n=p.allowCoordBorrow;p.scaleX=p.scaleX||p.scale;p.scaleY=(p.scaleY||p.scale);p.scaleZ=(p.scaleZ||p.scale);var q=Object.extend({},p);q.centerX=0;q.centerY=0;var v;var r=p.transformMatrix;this.setExtraProp2(j,s,this.TRANSFORM_MATRIX_FIELD,r);var k=r;this.setExtraProp2(j,s,this.CHILD_TRANSFORM_MATRIX_FIELD,r);var u=p.invTransformMatrix;this.setExtraProp2(j,s,this.INV_TRANSFORM_MATRIX_FIELD,u);for(var t=0,o=s.getNodeCount();t<o;++t){var m=s.getNodeAt(t);this.transformObjCoord3DToContext(j,m,r,k,n)}},transformObjCoord3DToContext:function(j,o,n,q,k){var s;if(o&&o.getAbsBaseCoord3D){coord=o.getAbsBaseCoord3D(k);if(coord){var r=Kekule.CoordUtils.transform3DByMatrix(coord,n);this.setTransformedCoord3D(j,o,r);s=r}if(o.getNodes){for(var p=0,m=o.getNodeCount();p<m;++p){this.transformObjCoord3DToContext(j,o.getNodeAt(p),q,q,k)}}}return s},getTransformedCoord3D:function(m,p,l){if(Kekule.ObjUtils.isUnset(l)){l=this.getRenderCache(m).options.transformParams.allowCoordBorrow}var o=p instanceof Kekule.BaseStructureNode;var j=o&&this.getExtraProp2(m,p,this.TRANSFORM_COORD_FIELD);if(!j){var n=this.getChemObj();var k=this.getExtraProp2(m,n,this.TRANSFORM_MATRIX_FIELD);var i=this.getExtraProp2(m,n,this.CHILD_TRANSFORM_MATRIX_FIELD);if(n&&(n.hasNode(p,false)||n.hasConnector(p,false))){j=this.transformObjCoord3DToContext(p,k,i,l)}else{j=this.transformObjCoord3DToContext(p,i,i,l)}}return j},setTransformedCoord3D:function(i,j,k){this.setExtraProp2(i,j,this.TRANSFORM_COORD_FIELD,k)},doTransformCoordToObj:function(j,l,k){var i=this.getExtraProp2(j,l,this.INV_TRANSFORM_MATRIX_FIELD);return Kekule.CoordUtils.transform3DByMatrix(k,i)},doTransformCoordToContext:function(j,l,k){var i=this.getExtraProp2(j,l,this.TRANSFORM_MATRIX_FIELD);return Kekule.CoordUtils.transform3DByMatrix(k,i)},doDrawNodes:function(k,t,q,u,m){var j=q.getExposedNodes();var s=this.getHiddenNodes(k);for(var r=0,p=j.length;r<p;++r){var o=j[r];if(s.indexOf(o)>=0){continue}var n=this.doDrawNode(k,t,o,q,u,m)}},doDrawNode:function(j,r,l,o,s,k){var t;var m=this.getRenderCache(j).nodeRenderMode;if(m===e.NONE){return null}else{op=Kekule.Render.RenderOptionUtils.mergeObjLocalRender3DOptions(l,s);var i;i=this.getNodeBaseRadius(j,l);if(Kekule.ObjUtils.isUnset(i)){i=this.calcNodeBaseRadius(l,s)}if(m===e.SPACE){i*=k.scaleX}else{i*=op.nodeRadiusRatio*k.scaleX}var n=this.getObjDrawColor(j,l);var q=this.getTransformedCoord3D(j,l,k.allowCoordBorrow);t=this.drawSphere(j,q,i,{color:n,opacity:op.opacity});var p=this.createSphereBoundInfo(q,i);this.basicDrawObjectUpdated(j,l,o,p,Kekule.Render.ObjectUpdateType.ADD)}if(t){this.setObjDrawElem(j,l,t);if(r){this.addToDrawGroup(t,r)}}},doDrawConnectors:function(j,t,q,u,k){if(this.getRenderCache(j).connectorRenderMode===h.NONE){return null}var m=q.getExposedConnectors();var s=this.getHiddenConnectors(j);for(var r=0,p=m.length;r<p;++r){var o=m[r];if(s.indexOf(o)>=0){continue}var n=this.doDrawConnector(j,t,o,q,u,k)}},doDrawConnector:function(l,q,k,p,o,t){var s=Object.create(o);s=Kekule.Render.RenderOptionUtils.mergeObjLocalRender3DOptions(k,o);var A=this.getHiddenNodes(l);var r=k.getConnectedExposedObjs();r=Kekule.ArrayUtils.exclude(r,A);var u=r.length;var y,x;var n,m;var B=(u>2)?this.createDrawGroup(l):null;var z;for(var w=0;w<u;++w){y=r[w];n=this.getTransformedCoord3D(l,y,t.allowCoordBorrow);if(n){for(var v=w+1;v<u;++v){x=r[v];m=this.getTransformedCoord3D(l,x,t.allowCoordBorrow);if(m){z=this.doDrawConnectorShape(l,k,[y,x],p,n,m,s,t);if(z&&B){this.addToDrawGroup(z,B)}}}}}if(B){this.addToDrawGroup(B,q)}else{this.addToDrawGroup(z,q)}return B||z},doDrawConnectorShape:function(am,o,X,u,aj,ai,P,ah){var B=Kekule.CoordUtils;var F=o.getOverriddenRender3DOptions()||{};var S=P.unitLength;var I=X[0];var H=X[1];var ab=g(F.bondSpliceMode,P.bondSpliceMode);var K=(ab===a.MID_SPLIT)?0.5:null;if(ab===a.WEIGHTING_SPLIT){var A=this.getNodeBaseRadius(am,I);var z=this.getNodeBaseRadius(am,H);if(A&&z){K=A/(A+z)}else{K=0.5}}var x=null;var af=false;var aa=[];if(K){var m=g(P.color||P.bondColor);var V=g(F.color||F.bondColor);af=false;if(V){aa.push(V)}else{var O=g(this.getObjDrawColor(am,I),m);var M=g(this.getObjDrawColor(am,H),m);if(O!==M){aa.push(O);aa.push(M);af=true}else{aa.push(g(O,P.color,P.bondColor,P.defBondColor))}}}else{aa.push(g(F.color,F.bondColor,P.color,P.bondColor,P.defBondColor))}if(K&&af){var t=ai.x-aj.x;var s=ai.y-aj.y;var q=ai.z-aj.z;x={};x.x=aj.x+t*K;x.y=aj.y+s*K;x.z=aj.z+q*K}var W=af?[[aj,x],[x,ai]]:[[aj,ai]];var ak=this.getRenderCache(am).connectorRenderMode;var E=this._getBondRenderType(o,ak);var p=false;var al=g(F.connectorRadius,P.connectorRadius)*g(F.connectorRadiusRatio,P.connectorRadiusRatio)*P.unitLength;al*=ah.scaleX;var J=g(F.connectorLineWidth,P.connectorLineWidth)*P.unitLength;if((E!==b.SINGLE)&&(E!==b.DASH)){al*=g(F.multiConnectorRadiusRatio,P.multiConnectorRadiusRatio);p=(ak===h.MULTI_CYLINDER)}else{p=false}var R=[];var Y=1,w=0;switch(E){case b.SINGLE:Y=1;break;case b.DOUBLE:Y=2;break;case b.TRIPLE:Y=3;break;case b.DASH:case b.SOLID_DASH:}w=Y;var N=null;if(w>1){var y=g(F.multiConnectorMarginRatio,P.multiConnectorMarginRatio)*al;if(p){y+=al*2}var Z=B.getDistance(aj,ai);var L=B.substract(ai,aj);var v=L.y/Z;var Q=L.x/Z;var G={x:-y*v,y:y*Q,z:0};N=((w%2)?0:0.5)-Math.floor(w/2);var r=B.multiply(G,N)}for(var ae=0,ac=W.length;ae<ac;++ae){if(w===1){var D={};D.coord1=W[ae][0];D.coord2=W[ae][1];if(af){D.jointCoordIndex=(ae===0)?2:1}D.color=aa[ae];D.radius=al;D.lineWidth=J;D.opacity=P.opacity;R.push(D)}else{var n=B.add(W[ae][0],r);var k=B.add(W[ae][1],r);for(var ad=0;ad<w;++ad){var D={};D.coord1=n;D.coord2=k;n=B.add(n,G);k=B.add(k,G);if(af){D.jointCoordIndex=(ae===0)?2:1}D.color=aa[ae];D.radius=al;D.lineWidth=J;D.opacity=P.opacity;R.push(D)}}}var T=ak;var ag;if((T===h.WIRE)||(T===h.MULTI_WIRE)){ag=this.createLineBoundInfo(aj,ai,{width:J})}else{ag=this.createCylinderBoundInfo(aj,ai,{radius:al})}this.basicDrawObjectUpdated(am,o,u,ag,Kekule.Render.ObjectUpdateType.ADD);return this.doDrawConnectorSet(am,R,T,E,P)},doDrawConnectorSet:function(k,m,n,l,j){if((n===h.WIRE)||(n===h.MULTI_WIRE)){return this.drawParallelLines(k,m)}else{var i=this.getRenderCache(k).nodeRenderMode===e.NONE;return this.drawParallelCylinders(k,m,i)}},_getBondRenderType:function(j,k){var l=j.getOverriddenRender3DOptions()||{};var i=Kekule.Render.Render3DOptionUtils.getConnectorRenderType(l);if(i){return i}else{return Kekule.Render.ConnectorDrawUtils.getConnectorRender3DType(j,k)}}});Kekule.ClassDefineUtils.addExtraTwoTupleObjMapSupport(Kekule.Render.ChemCtab3DRenderer);Kekule.Render.StructFragment3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.StructFragment3DRenderer",initialize:function($super,k,i,j){$super(k,i,j);this._concreteRenderer=null;if(k.hasCtab()){this._concreteRenderer=new Kekule.Render.ChemCtab3DRenderer(k.getCtab(),i,this)}else{this._concreteRenderer=null;Kekule.raise(Kekule.$L("ErrorMsg.FORMULA_RENDERER_3D_NOT_AVAILABLE"))}this._concreteRenderer.setParentRenderer(this)},finalize:function($super){$super();if(this._concreteRenderer){this._concreteRenderer.finalize()}},getRenderCache:function(i){return this._concreteRenderer.getRenderCache(i)},_getConcreteRendererDrawOptions:function(i){var j=Object.create(i);var l=this.getChemObj();var k=(this.getRendererType()===Kekule.Render.RendererType.R3D)?l.getOverriddenRender3DOptions():l.getOverriddenRenderOptions();j=Object.extend(j,k||{});return j},isChemObjRenderedBySelf:function($super,j,k){var i=$super(j,k)||(k===this.getChemObj())||this._concreteRenderer.isChemObjRenderedBySelf(j,k);return i},isChemObjRenderedDirectlyBySelf:function($super,i,j){return $super(i,j)||(j===this.getChemObj())},doSetRedirectContext:function($super,i){$super(i);this._concreteRenderer.setRedirectContext(i)},doDrawSelf:function($super,j,k,i){$super(j,k,i);return this._concreteRenderer.draw(j,k,this._getConcreteRendererDrawOptions(i))},doRedraw:function(i){return this._concreteRenderer.redraw(i)},doUpdateSelf:function(j,m,i){var l=this._extractObjsOfUpdateObjDetails(m);if(l.indexOf(this.getChemObj())>=0){var k=this.getRenderCache(j);this.doClear(j);return this.draw(j,k.baseCoord,k.options)}return this._concreteRenderer.doUpdate(j,m,i)},doClearSelf:function(i){var j=this._concreteRenderer;if(j){return j.clear(i)}},estimateRenderBox:function(k,j,i){return this._concreteRenderer.estimateRenderBox(k,this._getConcreteRendererDrawOptions(j),i)},getChildObjs:function($super){var p=this.getChemObj();if(p&&p.getAttachedMarkers){var m=[];var n=(p.getExposedNodes()||[]).concat(p.getExposedConnectors()||[]);for(var k=0,j=n.length;k<j;++k){var o=n[k];m=m.concat(o.getAttachedMarkers()||[])}return m.concat($super())}else{return $super()}},_needWholelyDraw:function($super,j,k){var r=$super(j,k);if(!r){var q=this.getChemObj();var m=false;for(var p=0,o=j.length;p<o;++p){var n=j[p];if(n.isChildOf(q)){m=true;break}}r=m}return r},transformCoordToObj:function(i,l,k){var j=(this.getChemObj()===l)?this._concreteChemObj:l;return this._concreteRenderer.transformCoordToObj(i,j,k)},transformCoordToContext:function(i,l,k){var j=(this.getChemObj()===l)?this._concreteChemObj:l;return this._concreteRenderer.transformCoordToContext(i,j,k)}});Kekule.Render.Mol3DRenderer=Kekule.Render.StructFragment3DRenderer;Kekule.Render.CompositeObj3DRenderer=Class.create(Kekule.Render.ChemObj3DRenderer,{CLASS_NAME:"Kekule.Render.CompositeObj3DRenderer"});Kekule.Render.CompositeMolecule3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.CompositeMolecule3DRenderer",getChildObjs:function($super){var m=[];var n=this.getChemObj().getSubMolecules();for(var k=0,j=n.getItemCount();k<j;++k){var p=n.getObjAt(k);m.push(p)}return m.concat($super())}});Kekule.Render.ChemObjGroupList3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemObjGroupList3DRenderer",getChildObjs:function($super){var n=this.getChemObj();if(n instanceof Kekule.ChemObjList){var m=[];for(var k=0,j=n.getItemCount();k<j;++k){m.push(n.getItemAt(k))}}else{if(n instanceof Kekule.ChemStructureObjectGroup){m=n.getAllObjs()}}return(m||[]).concat($super())}});Kekule.Render.ChemSpaceElement3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpaceElement3DRenderer",getChildObjs:function($super){return(this.getChemObj().getChildren().toArray()||[]).concat($super())}});Kekule.Render.ChemSpace3DRenderer=Class.create(Kekule.Render.CompositeObj3DRenderer,{CLASS_NAME:"Kekule.Render.ChemSpace3DRenderer",getChildObjs:function($super){return[this.getChemObj().getRoot()].concat($super())}});Kekule.Render.Renderer3DFactory.register(Kekule.StructureFragment,Kekule.Render.StructFragment3DRenderer);Kekule.Render.Renderer3DFactory.register(Kekule.CompositeMolecule,Kekule.Render.CompositeMolecule3DRenderer);Kekule.Render.Renderer3DFactory.register(Kekule.ChemObjList,Kekule.Render.ChemObjGroupList3DRenderer);Kekule.Render.Renderer3DFactory.register(Kekule.ChemStructureObjectGroup,Kekule.Render.ChemObjGroupList3DRenderer);Kekule.Render.Renderer3DFactory.register(Kekule.ChemSpaceElement,Kekule.Render.ChemSpaceElement3DRenderer);Kekule.Render.Renderer3DFactory.register(Kekule.ChemSpace,Kekule.Render.ChemSpace3DRenderer)})();if(Kekule.$jsRoot.THREE){THREE.Object3D.prototype.clear=function(){var b=this.children;for(var a=b.length-1;a>=0;a--){var c=b[a];c.clear();this.remove(c)}};THREE.Scene.prototype.clearMesh=function(){var b=this.children;for(var a=b.length-1;a>=0;a--){var c=b[a];if((c instanceof THREE.Mesh)||(c instanceof THREE.Line)||(c.__objGroup__)){c.clear();this.remove(c)}}}}Kekule.Render.ThreeObjectCache=Class.create({CLASS_NAME:"Kekule.Render.ThreeObjectCache",initialize:function(){this.cache=new Kekule.MapEx(true)},finalize:function(){this.cache.finalize();this.cache=null},createInstance:function(a,b){return null},isSameParams:function(d,c){if(d.length!==c.length){return false}for(var b=0,a=d.length;b<a;++b){if(!this.isParamEqual(d[b],c[b])){return false}}return true},isParamEqual:function(c,b){var a=(c===b);if(!a){if(DataType.isObjectValue(c)&&DataType.isObjectValue(b)){a=Kekule.ObjUtils.equal(c,b)}}return a},add:function(){var c=Array.prototype.slice.call(arguments);var b=c.shift();var d=this.cache.get(b);if(!d){d=[];this.cache.set(b,d)}var e={params:c};e.instance=this.createInstance(b,c);d.push(e);return e.instance},get:function(){var d=Array.prototype.slice.call(arguments);var b=d[0];var e=this.cache.get(b);if(e){d.shift();for(var f=0,c=e.length;f<c;++f){var g=e[f].params;if(this.isSameParams(g,d)){return e[f].instance}}d.unshift(b)}return this.add.apply(this,d)}});Kekule.Render.ThreeGeometryCache=Class.create(Kekule.Render.ThreeObjectCache,{CLASS_NAME:"Kekule.Render.ThreeGeometryCache",createInstance:function(d,f){var b=null;var c=f;var e=c[0];switch(d){case THREE.SphereGeometry:b=new THREE.SphereGeometry(c[1],c[2],c[3]);break;case THREE.CylinderGeometry:b=new THREE.CylinderGeometry(c[1],c[2],c[3],c[4],c[5],c[6]);break}return b}});Kekule.ClassUtils.makeSingleton(Kekule.Render.ThreeGeometryCache);Kekule.Render.ThreeMaterialCache=Class.create(Kekule.Render.ThreeObjectCache,{CLASS_NAME:"Kekule.Render.ThreeMaterialCache",createInstance:function(a,b){return new a(b[1])}});Kekule.ClassUtils.makeSingleton(Kekule.Render.ThreeMaterialCache);Kekule.Render.ThreeContext=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.ThreeContext",initialize:function($super,d,b,a,c){$super();this.setScene(d);this.setCamera(b);this.setLights(a);this.setRenderer(c)},initProperties:function(){this.defineProp("scene",{dataType:DataType.OBJECT,serializable:false});this.defineProp("camera",{dataType:DataType.OBJECT,serializable:false});this.defineProp("lights",{dataType:DataType.ARRAY,serializable:false});this.defineProp("renderer",{dataType:DataType.OBJECT,serializable:false});this.defineProp("width",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("height",{dataType:DataType.INT,serializable:false,setter:null})},getDimension:function(){return{width:this.getWidth(),height:this.getHeight()}},setDimension:function(b,a){this.setPropStoreFieldValue("width",b);this.setPropStoreFieldValue("height",a);this.getRenderer().setSize(b,a);var d=this.getCamera();if(d instanceof THREE.OrthographicCamera){d.left=b/-2;d.right=b/2;d.top=a/2;d.bottom=a/-2}else{d.aspect=b/a}d.updateProjectionMatrix()}});Kekule.Render.ThreeRendererBridge=Class.create({CLASS_NAME:"Kekule.Render.ThreeRendererBridge",_qualitySettings:[null,{sphereSegments:6,sphereRings:6,cylinderSegmentsRadius:6},{sphereSegments:8,sphereRings:8,cylinderSegmentsRadius:8},{sphereSegments:16,sphereRings:16,cylinderSegmentsRadius:16},{sphereSegments:32,sphereRings:32,cylinderSegmentsRadius:32},{sphereSegments:64,sphereRings:64,cylinderSegmentsRadius:64}],initialize:function(){this.geometryCache=Kekule.Render.ThreeGeometryCache.getInstance();this.materialCache=Kekule.Render.ThreeMaterialCache.getInstance();this._quality=null;this._modelParams={};this._webglEnabled=true},finalize:function(){this.geometryCache=null;this.materialCache=null},getGraphicQualityLevel:function(){return this._quality},setGraphicQualityLevel:function(a){if(this._webglEnabled){this._quality=a}else{this._quality=Kekule.Render.Render3DGraphicQuality.EXTREME_LOW}this._modelParams=this.calcModelParams(this._quality)},_updateGraphicQualityLevel:function(){if(!this._webglEnabled){this.setGraphicQualityLevel(Kekule.Render.Render3DGraphicQuality.EXTREME_LOW)}},calcModelParams:function(b){var a=this._qualitySettings[b];if(!a){a=this._qualitySettings[Kekule.Render.Render3DGraphicQuality.MEDIUM]}return a},getInitialLightPositions:function(a){return[{x:5,y:5,z:10}]},createContext:function(g,a,n){var p=Kekule.BrowserFeature;var k=p.webgl?new THREE.WebGLRenderer({preserveDrawingBuffer:true,alpha:true}):p.canvas?new THREE.CanvasRenderer():new THREE.SVGRenderer();var j=new THREE.PerspectiveCamera();j.fov=5;this._webglEnabled=(k instanceof THREE.WebGLRenderer);this._updateGraphicQualityLevel();var f=new THREE.Scene();f.add(j);k.setSize(a,n);var m=this.getInitialLightPositions();var d=[];for(var e=0,c=m.length;e<c;++e){var b=new THREE.DirectionalLight(13421772,1,10,true);var h=m[e];b.position.set(h.x,h.y,h.z);f.add(b);d.push(b)}var b=new THREE.AmbientLight(2105376);f.add(b);g.appendChild(k.domElement);var o=new Kekule.Render.ThreeContext(f,j,d,k);o.setDimension(a,n);return o},releaseContext:function(a){var b=this.getContextElem(a);a.finalize();if(b){b.parentNode.removeChild(b)}},getContextElem:function(a){return a?a.getRenderer().domElement:null},getContextDimension:function(a){return{width:a.getWidth(),height:a.getHeight()}},setContextDimension:function(b,c,a){b.setDimension(c,a)},transformContextCoordToScreen:function(a,c){var b=a.getDimension();return{x:c.x+b.width/2,y:c.y+b.height/2}},transformScreenCoordToContext:function(a,c){var b=a.getDimension();return{x:c.x-b.width/2,y:c.y-b.height/2,z:0}},clearContext:function(a){a.clear()},canModifyGraphic:function(a){return true},transformContextCoordToScreen:function(a,b){return{x:b.x,y:b.y}},colorStrToHex:function(a){return Kekule.StyleUtils.colorStrToValue(a)},createGroup:function(a){var b=new THREE.Object3D();b.__objGroup__=true;a.getScene().add(b);return b},addToGroup:function(a,b){b.add(a);return b},removeFromGroup:function(a,b){b.remove(a)},setClearColor:function(b,a){var c=b.getRenderer();if(c){if(c.setClearColorHex){if(a){b.getRenderer().setClearColorHex(this.colorStrToHex(a),1)}else{b.getRenderer().setClearColorHex(null,0)}}else{if(c.setClearColor){if(a){b.getRenderer().setClearColor(this.colorStrToHex(a),1)}else{b.getRenderer().setClearColor(null,0)}}}}},clearContext:function(a){a.getScene().clearMesh();this.renderContext(a)},renderContext:function(a){a.getRenderer().render(a.getScene(),a.getCamera())},drawSphere:function(a,c,d,i){var b=this._modelParams.sphereSegments;var g=this._modelParams.sphereRings;var f=this.geometryCache.get(THREE.SphereGeometry,a.getScene(),1,b,g);var e=this.materialCache.get(THREE.MeshLambertMaterial,a.getScene(),{color:this.colorStrToHex(i.color),opacity:i.opacity||1});var h=new THREE.Mesh(f,e);h.scale.x=d;h.scale.y=d;h.scale.z=d;h.position.x=c.x;h.position.y=c.y;h.position.z=c.z;a.getScene().add(h);return h},drawLine:function(c,e,d,a){var f=this.colorStrToHex(a.color);var g=this.materialCache.get(THREE.LineBasicMaterial,c.getScene(),{color:this.colorStrToHex(a.color),opacity:a.opacity||1,linewidth:a.lineWidth||1});var b=new THREE.Geometry();b.vertices.push(new THREE.Vector3(e.x,e.y,e.z));b.vertices.push(new THREE.Vector3(d.x,d.y,d.z));line=new THREE.Line(b,g);c.getScene().add(line);return line},drawCylinder:function(b,g,f,d,m){var a=Kekule.CoordUtils;var i=this._modelParams.cylinderSegmentsRadius;var j=1;var k=a.getDistance(g,f);var h=this.geometryCache.get(THREE.CylinderGeometry,b.getScene(),1,1,1,i,j,true);var e=this.materialCache.get(THREE.MeshLambertMaterial,b.getScene(),{color:this.colorStrToHex(m.color),opacity:m.opacity||1});var l=new THREE.Mesh(h,e);l.scale.y=k;l.scale.x=d;l.scale.z=d;var c=Kekule.ObjUtils.isUnset(m.quaternion)?this._calcQuaternion(g,f):m.quaternion;if(c){if(l.applyQuaternion){l.applyQuaternion(c)}else{l.useQuaternion=true;l.quaternion=c;l.updateMatrix()}}l.position.x=(g.x+f.x)/2;l.position.y=(g.y+f.y)/2;l.position.z=(g.z+f.z)/2;b.getScene().add(l);return l},drawParallelCylinders:function(c,q,f){var b=Kekule.CoordUtils;var p=q[0];var n=this._calcQuaternion(p.coord1,p.coord2);var r=this.createGroup(c);for(var o=0,e=q.length;o<e;++o){var d=q[o];var m=this.drawCylinder(c,d.coord1,d.coord2,d.radius,{color:d.color,quaternion:n,opacity:d.opacity});this.addToGroup(m,r)}if(f){var a;for(var o=0,e=q.length;o<e;++o){var d=q[o];if(Kekule.ObjUtils.isUnset(d.jointCoordIndex)){a=[d.coord1,d.coord2]}else{a=(d.jointCoordIndex===1)?[d.coord2]:[d.coord1]}for(var h=0,g=a.length;h<g;++h){var m=this.drawSphere(c,a[h],d.radius,{color:d.color,opacity:d.opacity});this.addToGroup(m,r)}}}return r},removeDrawnElem:function(a,b){if(b.parent&&b.parent.remove){b.parent.remove(b)}},_calcQuaternion:function(i,g){var a=Kekule.CoordUtils;var j=a.substract(g,i);if(j.x||j.z){var c={x:j.z,y:0,z:-j.x};c=a.standardize(c);var e=Math.atan2(Math.sqrt(Math.sqr(j.x)+Math.sqr(j.z)),j.y);var h=e/2;var b=Math.cos(h);var d=Math.sin(h);var f=new THREE.Quaternion(d*c.x,d*c.y,d*c.z,b);return f}else{return null}},getLightCount:function(b){var a=b.getLights();return a?(a.length||0):0},getLightProps:function(c,b){var a=c.getLights()[b];return{position:a.position}},setLightProps:function(c,b,d){var a=c.getLights()[b];var e=d.position;if(e){a.position.x=e.x;a.position.y=e.y;a.position.z=e.z}a.updateMatrix()},getCameraProps:function(a){var b=a.getCamera();return{position:b.position,fov:b.fov*Math.PI/180,aspect:b.aspect,left:b.left,right:b.right,top:b.top,bottom:b.bottom,lookAtVector:b.lookAtVector,upVector:b.up}},setCameraProps:function(b,d){var g=b.getCamera();var e=Kekule.ObjUtils.notUnset;var f=d.position;if(f){g.position.x=f.x;g.position.y=f.y;g.position.z=f.z}if(e(d.near)){g.near=d.near}if(e(d.far)){g.near=d.far}if(d.fov){g.fov=d.fov*180/Math.PI}if(d.aspect){g.aspect=d.aspect}if(e(d.left)){g.left=d.left}if(e(d.top)){g.top=d.top}if(e(d.bottom)){g.bottom=d.bottom}if(e(d.right)){g.right=d.right}if(e(d.upVector)){var a=d.upVector;g.up=new THREE.Vector3(a.x,a.y,a.z)}if(e(d.lookAtVector)){var a=d.lookAtVector;g.lookAt(new THREE.Vector3(a.x,a.y,a.z))}g.updateMatrix()},exportToDataUri:function(d,b,c){var f=d.getRenderer();if(f instanceof THREE.SVGRenderer){var e=d.getRenderer().domElement;var a=XmlUtility.serializeNode(e);return"data:image/svg+xml;base64,"+btoa(a)}else{var e=d.getRenderer().domElement;return e?e.toDataURL(b,c):null}}});Kekule.Render.ThreeRendererBridge.isSupported=function(){var a=(typeof(Kekule.$jsRoot.THREE)!=="undefined");if(a){var b=Kekule.BrowserFeature;a=b.webgl||b.canvas||b.svg}return !!a};Kekule.Render.DrawBridge3DMananger.register(Kekule.Render.ThreeRendererBridge,20);(function(){Kekule.Render.ChemObjPainter=Class.create(ObjectEx,{CLASS_NAME:"Kekule.Render.ChemObjPainter",initialize:function($super,b,e,a,d){$super();var c=b||Kekule.Render.RendererType.R2D;this.setPropStoreFieldValue("renderType",c);this.setPropStoreFieldValue("chemObj",e);this.setPropStoreFieldValue("drawBridge",a||((c===Kekule.Render.RendererType.R3D)?Kekule.Render.DrawBridge3DMananger.getPreferredBridgeInstance():Kekule.Render.DrawBridge2DMananger.getPreferredBridgeInstance()));if(d){this.setPropStoreFieldValue("renderConfigs",d)}},finalize:function($super){if(this.getRenderer()){this.getRenderer().finalize()}$super()},initProperties:function(){this.defineProp("renderType",{dataType:DataType.INT,serializable:false,setter:null});this.defineProp("chemObj",{dataType:"Kekule.ChemObject",serializable:false,setter:null});this.defineProp("drawBridge",{dataType:DataType.OBJECT,serializable:false,setter:null});this.defineProp("renderConfigs",{dataType:DataType.OBJECT,serializable:false,getter:function(){var a=this.getPropStoreFieldValue("renderConfigs");if(!a){a=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.Render.Render3DConfigs.getInstance():Kekule.Render.Render2DConfigs.getInstance()}return a}});this.defineProp("renderer",{dateType:"Kekule.Render.AbstractRenderer",serializable:false,setter:null});this.defineProp("canModifyTargetObj",{dataType:DataType.BOOL})},getDrawOptionFromConfigs:function(b){var a=Kekule.Render.RenderOptionUtils;return a.convertConfigsToPlainHash(b)},prepareRenderer:function(){if(this.getRenderer()){return this.getRenderer()}var b=(this.getRenderType()===Kekule.Render.RendererType.R3D)?Kekule.Render.get3DRendererClass:Kekule.Render.get2DRendererClass;var d=b(this.getChemObj());if(d){var a=new d(this.getChemObj(),this.getDrawBridge(),this);this.setPropStoreFieldValue("renderer",a);return a}else{Kekule.error(Kekule.$L("ErrorMsg.CANNOT_FIND_SUITABLE_RENDERER_FOR_OBJ"));return null}},createContext:function(d,e,c){var a=this.getDrawBridge();return a.createContext(d,e,c)},_convertContextBoxToScreen:function(a,c){if(!c){return{}}var e=this.getDrawBridge();var d=e.transformContextCoordToScreen(a,{x:c.x1,y:c.y1});var b=e.transformContextCoordToScreen(a,{x:c.x2,y:c.y2});return Kekule.BoxUtils.createBox(d,b)},estimateObjBox:function(c,b,a){var d=this._generateDrawOptions(b);this.prepareRenderer();return this.getRenderer().estimateObjBox(c,b,a)},estimateRenderBox:function(c,f,b,a){var d=this._generateDrawOptions(b);this.prepareRenderer();var e=this.getRenderer();return e.estimateRenderBox(c,f,d,a)},estimateScreenBox:function(c,e,b,a){var d=this.estimateRenderBox(c,e,b,a);return d?this._convertContextBoxToScreen(c,d):null},_generateDrawOptions:function(b){var c=this.getRenderConfigs();var a=c?this.getDrawOptionFromConfigs(c):{};a=Object.extend(a,b);return a},draw:function(c,f,b){this.prepareRenderer();var d=this._generateDrawOptions(b);var e=this.getRenderer();var a=e.draw(c,f,d);return a},redraw:function(a){return this.getRenderer().redraw(a)},getActualRenderTransformParams:function(a){var b=this.getRenderer();if(b){return b.getRenderFinalTransformParams(a)}else{return null}},getActualInitialRenderTransformOptions:function(a){var b=this.getRenderer();if(b){return b.getRenderInitialTransformOptions(a)}else{return null}},changeGeometryOptions:function(a,d,e){var c=this.getRenderer();if(c&&c.changeGeometryOptions){var b=this._generateDrawOptions(e);return c.changeGeometryOptions(a,d,b)}else{this.clearContext(a);return this.draw(a,d,e)}},supportGeometryOptionChange:function(){var a=this.getRenderer();return a&&a.changeGeometryOptions},beginUpdatePainter:function(){return this.getRenderer().beginUpdateRenderer()},endUpdatePainter:function(){return this.getRenderer().endUpdateRenderer()},update:function(c,a,b){return this.getRenderer().update(c,a,b)},addNew:function(b,a){return this.getRenderer().addNew(b,a)},modify:function(b,a){return this.getRenderer().modify(b,a)},remove:function(a,b){return this.getRenderer().remove(a,b)},clear:function(a){var b=this.getRenderer();if(b){b.clear(a)}return this},clearContext:function(a){return this.getDrawBridge().clearContext(a)}});Kekule.Render.ChemObjPainter2D=Class.create(Kekule.Render.ChemObjPainter,{CLASS_NAME:"Kekule.Render.ChemObjPainter2D",initialize:function($super,c,a,b){$super(Kekule.Render.RendererType.R2D,c,a,b)}});Kekule.Render.ChemObjPainter3D=Class.create(Kekule.Render.ChemObjPainter,{CLASS_NAME:"Kekule.Render.ChemObjPainter3D",initialize:function($super,c,a,b){$super(Kekule.Render.RendererType.R3D,c,a,b)}})})();